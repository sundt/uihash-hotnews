import{a as $}from"./chunk-E3FXOX6T.js";import{a as u,b as U,c as y,e as H}from"./chunk-NTAR7AIA.js";var dt=!1,V="explore",M=window.SYSTEM_SETTINGS?.display?.items_per_card||20,I=6,G=4,Y=6,ut=3*60*1e3,ft=2e3,mt="/api/rss-sources/explore-cards",J="hotnews_explore_tab_seen_sources_v1",Z="hotnews_explore_tab_cursor_v1",v=!1,d=[];var X=!1,m=null,A=null,E=0,R=new Map,D=new Map;var q=!1;function O(e,t={}){let n=T();if(!n)return;let r=e==null?"":String(e),s=t.retry===!0?'<div style="margin-top:8px;"><button type="button" class="platform-select-action-btn" data-action="retry">\u91CD\u8BD5</button></div>':"";n.innerHTML=`<div class="category-empty-state">${y(r)}${s}</div>`}function gt(){let e=new Set;try{let t=A||B();A=t;for(let n of t)n&&e.add(String(n))}catch{}try{let t=j();for(let n of t)n&&e.add(String(n))}catch{}try{for(let t of Array.isArray(d)?d:[]){let n=String(t?.source_id||"").trim();n&&e.add(n)}}catch{}return Array.from(e)}async function F(e){let t=Math.max(0,Number(e||0)||0);if(t<=0)return[];let n=x();if(!n||!n.classList.contains("active"))return[];try{let r=gt(),a=new URLSearchParams;a.set("cards",String(t)),a.set("entries_per_card",String(M)),r.length&&a.set("exclude_source_ids",r.join(","));let s=`${mt}?${a.toString()}`,i=await fetch(s,{method:"GET"}),o=await i.json().catch(()=>({}));return i.ok?(Array.isArray(o?.cards)?o.cards:[]).map(l=>{let f=String(l?.source_id||"").trim(),p=String(l?.url||"").trim(),h=String(l?.platform_name||l?.feed_title||"RSS").trim()||"RSS",w=Array.isArray(l?.entries)?l.entries:[];return{source_id:f,url:p,feed_title:String(l?.feed_title||h).trim()||h,platform_name:h,entries:w.slice(0,M).map(g=>({title:String(g?.title||"").trim(),link:String(g?.link||"").trim(),published:g?.published||g?.ts||""})),entries_count:w.length,already_added:!1}}).filter(l=>l.source_id&&Array.isArray(l.entries)&&l.entries.length>0):[]}catch{return[]}}function pt(e,t){return new Promise(n=>{if(!e){n();return}let r=!1,a=()=>{if(!r){r=!0;try{e.removeEventListener("animationend",s)}catch{}n()}},s=()=>a();try{e.addEventListener("animationend",s,{once:!0})}catch{}setTimeout(a,Math.max(0,Number(t||0)||0))})}function x(){return document.getElementById("tab-explore")}async function ht(){let e=j(),t=A||B();A=t,m==null&&(m=nt());let n=new Set((Array.isArray(d)?d:[]).map(a=>String(a?.source_id||"").trim()).filter(Boolean)),r=0;for(;r<200;){r+=1;let a=m,s=await rt(50,a);if(E=s.total,!s.items.length)return null;let i=[];for(let c of s.items){m+=1;let l=String(c?.id||"").trim();if(!l||t.has(l)||e.has(l)||n.has(l))continue;let f=String(c?.url||"").trim(),p=it(c);i.push({sid:l,url:f,name:p})}let o=await St(i);if(o)return o;if(m>=E)return null;m===a&&(m+=s.items.length)}return null}function yt(e){let t=R.get(e);return t?Date.now()-Number(t.ts||0)>ut?(R.delete(e),null):t:null}async function Q(e){let t=String(e||"").trim();if(!t)return null;let n=yt(t);if(n)return n;let r=D.get(t);if(r)return r;let a=(async()=>{try{let s=typeof AbortController<"u"?new AbortController:null,i=s?window.setTimeout(()=>s.abort(),ft):0,o=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`,s?{signal:s.signal}:void 0);try{i&&window.clearTimeout(i)}catch{}let c=await o.json().catch(()=>({}));if(!o.ok){let p={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:c?.detail||"Preview failed"};return R.set(t,p),p}let l=Et(c),f={ts:Date.now(),ok:!0,feedTitle:l.feedTitle,entries:l.entries,error:""};return R.set(t,f),f}catch(s){let i={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:String(s?.message||s)};return R.set(t,i),i}finally{D.delete(t)}})();return D.set(t,a),a}async function St(e){let t=Array.isArray(e)?[...e]:[];if(t.length===0)return null;let n=null,r=null,a=new Promise(c=>{r=c}),s=async()=>{for(;t.length>0&&!n;){let c=t.shift();if(!c||!c.sid)continue;let l=await Q(c.sid);if(!l||l.ok!==!0)continue;let f=Array.isArray(l.entries)?l.entries:[];if(!(f.length<=0)){n={source_id:c.sid,url:c.url,feed_title:l.feedTitle||c.name,platform_name:l.feedTitle||c.name,entries:f,entries_count:f.length,already_added:!1};try{r&&r(),r=null}catch{}return}}},i=Math.max(1,Math.min(Y,t.length)),o=Array.from({length:i}).map(()=>s().catch(()=>{}));return await Promise.race([Promise.all(o),a]),n}async function tt(e){let t=Math.max(0,Number(e||0)||0);if(t<=0)return[];let n=j(),r=A||B();A=r,m==null&&(m=nt());let a=new Set((Array.isArray(d)?d:[]).map(l=>String(l?.source_id||"").trim()).filter(Boolean)),s=[],i=null,o=new Promise(l=>{i=l}),c=0;for(;c<200&&s.length<t;){c+=1;let l=m,f=await rt(50,l);if(E=f.total,!f.items.length)break;let p=[];for(let S of f.items){m+=1;let _=String(S?.id||"").trim();if(!_||r.has(_)||n.has(_)||a.has(_)||s.some(lt=>String(lt?.source_id||"").trim()===_))continue;let L=String(S?.url||"").trim(),z=it(S);p.push({sid:_,url:L,name:z})}let h=[...p],w=async()=>{for(;h.length>0&&s.length<t;){let S=h.shift();if(!S||!S.sid)continue;let _=await Q(S.sid);if(!_||_.ok!==!0)continue;let L=Array.isArray(_.entries)?_.entries:[];if(!(L.length<=0)){if(s.length>=t)return;if(s.push({source_id:S.sid,url:S.url,feed_title:_.feedTitle||S.name,platform_name:_.feedTitle||S.name,entries:L,entries_count:L.length,already_added:!1}),s.length>=t){try{i&&i(),i=null}catch{}return}}}},g=Math.max(1,Math.min(Y,h.length)),C=Array.from({length:g}).map(()=>w().catch(()=>{}));if(await Promise.race([Promise.all(C),o]),s.length>=t||m>=E)break;m===l&&(m+=f.items.length)}return s.slice(0,t)}async function W(){if(v)return;let e=x(),t=T();if(!(!e||!t)&&e.classList.contains("active")){v=!0,K(!0);try{if(d.length<I){let n=I-d.length,r=await F(n);r.length&&(d=[...d,...r],b(d))}for(;d.length<I;){let n=I-d.length,r=await tt(n);if(!r.length)break;d=[...d,...r],b(d)}m!=null&&P(m),d.length<=0&&m!=null&&E>0&&m>=E&&(m=0,P(m))}catch{d.length<=0&&O("\u52A0\u8F7D\u5931\u8D25",{retry:!0})}finally{v=!1,K(!1),b(d)}}}function T(){return document.getElementById("trExploreGrid")}function _t(){return document.getElementById("trExploreStatus")}function k(e,t={}){let n=_t();if(!n)return;let r=String(t.variant||"").toLowerCase(),a=r==="error"?"#dc2626":r==="success"?"#16a34a":"#6b7280";n.style.color=a,n.textContent=e==null?"":String(e)}function K(e){e&&(d.length>0||O("\u52A0\u8F7D\u4E2D..."))}function wt(){let e=T();if(!e)return!0;try{return e.querySelectorAll(".platform-card").length===0}catch{return!0}}function et(){let e=u.settings?.getMergedCategoryConfig?u.settings.getMergedCategoryConfig():null,t=u.settings?.getDefaultCategories?u.settings.getDefaultCategories():null,n=Array.isArray(e?.categoryOrder)?e.categoryOrder:[],r=Array.isArray(e?.customCategories)?e.customCategories:[],a=[],s=new Set;for(let i of n){let o=String(i||"").trim();if(!o||s.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;s.add(o);let c=r.find(h=>String(h?.id||"")===o);if(c){let h=String(c?.name||o).trim()||o;a.push({id:o,name:h,icon:"\u{1F4F1}",isCustom:!0});continue}let l=t&&t[o]?t[o]:null;if(!l)continue;let f=String(l?.name||o).trim()||o,p=String(l?.icon||"\u{1F4C1}");a.push({id:o,name:f,icon:p,isCustom:!1})}for(let i of r){let o=String(i?.id||"").trim();if(!o||s.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;s.add(o);let c=String(i?.name||o).trim()||o;a.push({id:o,name:c,icon:"\u{1F4F1}",isCustom:!0})}return a}async function vt(e,t){if(!e||!e.source_id)return;let n=String(t?.id||"").trim(),r=String(t?.name||n).trim()||n||"RSS",a=!!t?.isCustom,s=String(e.source_id||"").trim(),i=s?`rss-${s}`:"",o="RSS";n&&n!=="rsscol-rss"&&!a&&(o=n);try{u.subscription?.ensureSnapshot?.()}catch{}try{u.subscription?.stageFromCatalogPreview?.({source_id:e.source_id,url:e.url,feed_title:e.feed_title||e.platform_name,column:o,entries_count:e.entries_count||0})}catch(c){k(String(c?.message||c),{variant:"error"});return}if(a&&n&&i)try{u.settings?.addPlatformToCustomCategory?.(n,i)}catch{}try{k(`\u4FDD\u5B58\u4E2D\uFF1A${r}`,{variant:"info"}),u.subscription?.saveOnly?await u.subscription.saveOnly():u.subscription?.saveAndRefresh?await u.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),k(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success"})}catch(c){k(String(c?.message||c),{variant:"error"});try{u.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(c?.message||c)}`,{variant:"error",durationMs:2500})}catch{}return}try{u.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}try{q=!0}catch{}try{At([e.source_id],"high").catch(()=>{})}catch{}}function B(){try{let e=$.getRaw(J);if(!e)return new Set;let t=JSON.parse(e);if(!Array.isArray(t))return new Set;let n=new Set;for(let r of t){let a=String(r||"").trim();a&&n.add(a)}return n}catch{return new Set}}function bt(e){try{let n=Array.from(e||[]).map(r=>String(r||"").trim()).filter(Boolean).slice(-2e3);$.setRaw(J,JSON.stringify(n))}catch{}}function nt(){try{let e=$.getRaw(Z),t=Number(e||0)||0;return t<0?0:t}catch{return 0}}function P(e){try{let t=Number(e||0)||0;$.setRaw(Z,String(t<0?0:t))}catch{}}function j(){let e=u.subscription?.getSubscriptions?u.subscription.getSubscriptions():[],t=new Set;for(let n of Array.isArray(e)?e:[]){let r=String(n?.source_id||n?.rss_source_id||"").trim();r&&t.add(r)}return t}async function At(e,t="normal"){let n=Array.isArray(e)?e.map(r=>String(r||"").trim()).filter(Boolean):[];if(n.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:n,priority:t})})}catch{}}async function rt(e,t){let n=new URLSearchParams;n.set("limit",String(e)),n.set("offset",String(t));let r=await fetch(`/api/rss-sources/search?${n.toString()}`),a=await r.json().catch(()=>({}));if(!r.ok)throw new Error(a?.detail||"Failed to load RSS sources");let s=Array.isArray(a?.sources)?a.sources:[],i=Number(a?.total||0)||0,o=Number(a?.next_offset??t+s.length)||t+s.length;return{items:s,total:i,nextOffset:o}}function Et(e){let t=e?.data||{},n=String(t?.feed?.title||"").trim(),a=(Array.isArray(t?.entries)?t.entries:[]).map(s=>{let i=String(s?.title||"").trim(),o=String(s?.link||"").trim();return{title:i||o,link:o}}).filter(s=>!!s.link);return{feedTitle:n,entries:a}}function it(e){return String(e?.name||e?.host||e?.id||"").trim()||"RSS"}function st(e){let t=e||{},n=t?.already_added?"disabled":"",r=t?.already_added?"\u2713":"+",s=et().map(i=>{let c=`${i?.isCustom?"custom":"default"}:${String(i?.id||"").trim()}`;return`<option value="${y(c)}" style="font-size:0.8rem;">${y(String(i?.icon||"\u{1F4C1}"))} ${y(String(i?.name||i?.id||""))}</option>`}).join("");return`
        <select class="tr-explore-add-btn" data-action="add-category" ${n} 
            style="width:28px;height:28px;padding:0;font-size:1rem;font-weight:normal;border-radius:50%;
            border:1px solid #e5e7eb;background:#f9fafb;color:#9ca3af;
            cursor:pointer;text-align:center;text-align-last:center;appearance:none;-webkit-appearance:none;" 
            title="${t?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE"}">
            <option value="" selected hidden>${y(r)}</option>
            ${s}
        </select>`}function at(e){try{if(!e||!u.readState||typeof u.readState.getReadNews!="function")return;let t=u.readState.getReadNews()||{};e.querySelectorAll(".news-item[data-news-id]").forEach(r=>{try{let a=String(r?.dataset?.newsId||"").trim();if(!a||!t[a])return;r.classList.add("read")}catch{}})}catch{}}function b(e){let t=T();if(!t)return;let n=(e||[]).map(r=>{let a=String(r?.source_id||"").trim(),s=y(r?.platform_name||"RSS"),i=st(r),c=(Array.isArray(r?.entries)?r.entries:[]).slice(0,M).map((l,f)=>{let p=y(l?.title||""),h=y(l?.link||"#"),w=y(`rssx:${a}:${l?.link||""}`),g=H(l?.published||l?.ts||0),C=g?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${y(g)}</span>`:"";return`
                <li class="news-item" data-news-id="${w}" data-news-title="${p}">
                    <div class="news-item-content">
                        <span class="news-index">${String(f+1)}</span>
                        <a class="news-title" href="${h}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">${p}</a>
                        ${C}
                    </div>
                </li>`}).join("");return`
            <div class="platform-card" data-rss-source-id="${y(a)}">
                <div class="platform-header">
                    <div class="platform-name">${s}</div>
                    <div class="platform-header-actions">
                        ${i}
                    </div>
                </div>
                <ul class="news-list">${c}</ul>
            </div>`}).join("");if(n){t.innerHTML=n,at(t),requestAnimationFrame(()=>ct());return}O("\u6682\u65E0\u53EF\u9884\u89C8\u6E90",{retry:!0})}function xt(e,t={}){let n=String(e?.source_id||"").trim(),r=y(e?.platform_name||"RSS"),a=st(e),i=(Array.isArray(e?.entries)?e.entries:[]).slice(0,M).map((f,p)=>{let h=y(f?.title||""),w=y(f?.link||"#"),g=y(`rssx:${n}:${f?.link||""}`),C=H(f?.published||f?.ts||0),S=C?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${y(C)}</span>`:"";return`
            <li class="news-item" data-news-id="${g}" data-news-title="${h}">
                <div class="news-item-content">
                    <span class="news-index">${String(p+1)}</span>
                    <a class="news-title" href="${w}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">${h}</a>
                    ${S}
                </div>
            </li>`}).join(""),c=`
        <div class="platform-card${t.animateIn?" tr-explore-flip-in":""}" data-rss-source-id="${y(n)}">
            <div class="platform-header">
                <div class="platform-name">${r}</div>
                <div class="platform-header-actions">
                    ${a}
                </div>
            </div>
            <ul class="news-list">${i}</ul>
        </div>`,l=document.createElement("div");return l.innerHTML=c.trim(),l.firstElementChild}async function Ct(e,t){if(v)return;let n=(Array.isArray(d)?d:[]).findIndex(i=>String(i?.source_id||"").trim()===String(e||"").trim());if(n<0)return;let r=A||B();A=r,r.add(String(e||"").trim()),bt(r),v=!0;let a=ht().catch(()=>null),s=F(1).then(i=>i&&i[0]?i[0]:null).catch(()=>null);try{try{let c=t?.querySelector?.('button[data-action="close"]');c&&c.setAttribute("disabled","true")}catch{}try{t?.classList?.add("tr-explore-flip-out")}catch{}await pt(t,260);let i=await s;if(i||(i=await a),!i){d=(Array.isArray(d)?d:[]).filter(c=>String(c?.source_id||"").trim()!==String(e||"").trim()),b(d),await W();return}Array.isArray(d)&&d[n]&&String(d[n]?.source_id||"").trim()===String(e||"").trim()&&(d[n]=i);let o=xt(i,{animateIn:!0});try{t&&t.parentNode?(t.parentNode.replaceChild(o,t),at(o)):b(d)}catch{b(d)}}finally{v=!1;try{m!=null&&P(m)}catch{}}}function ot(){let e=x();if(!(!e||!e.classList.contains("active"))){if(d.length>0){wt()&&b(d);return}W().catch(t=>{k(String(t?.message||t),{variant:"error"})})}}function kt(e){try{if(!e||!(e instanceof Element))return!1;let t=e.closest("a.news-title");if(!t)return!1;let n=t.closest(".news-item");return n&&(u.readState&&typeof u.readState.markItemAsRead=="function"?u.readState.markItemAsRead(n):n.classList.add("read")),!0}catch{try{let n=e?.closest?.(".news-item");n&&n.classList.add("read")}catch{}return!0}}function Tt(){X||(X=!0,document.addEventListener("click",e=>{let t=e?.target;if(!t||!(t instanceof Element))return;let n=x();!n||!n.classList.contains("active")||kt(t)},!0),document.addEventListener("click",e=>{let t=e?.target;if(!t||!(t instanceof Element))return;let n=x();if(!n||!n.classList.contains("active"))return;let r=t.closest('button[data-action="close"]');if(r){let s=r.closest(".platform-card"),i=String(s?.getAttribute("data-rss-source-id")||"").trim();if(!i)return;Ct(i,s).catch(o=>{k(String(o?.message||o),{variant:"error"})});return}if(t.closest('button[data-action="retry"]')){if(v)return;if(m!=null&&E>0&&m>=E){m=0;try{P(m)}catch{}}W().catch(s=>{O(String(s?.message||s||"\u52A0\u8F7D\u5931\u8D25"),{retry:!0})});return}}),document.addEventListener("change",e=>{let t=e?.target;if(!t||!(t instanceof Element))return;let n=x();if(!n||!n.classList.contains("active"))return;let r=t.closest('select[data-action="add-category"]');if(!r||!(r instanceof HTMLSelectElement))return;let a=r.closest(".platform-card"),s=String(a?.getAttribute("data-rss-source-id")||"").trim();if(!s)return;let i=(Array.isArray(d)?d:[]).find(g=>String(g?.source_id||"").trim()===s);if(!i||i.already_added)return;let o=String(r.value||"").trim();if(!o)return;let c=o.split(":"),l=String(c[0]||"").trim(),f=String(c[1]||"").trim();if(!f)return;let h=et().find(g=>String(g?.id||"").trim()===f),w=h||{id:f,name:f,icon:"\u{1F4C1}",isCustom:l==="custom"};try{r.setAttribute("disabled","true")}catch{}vt(i,w).then(()=>{i.already_added=!0;try{let g=r.querySelector('option[value=""]');g&&(g.textContent="\u5DF2\u52A0\u5165"),r.value="",r.setAttribute("disabled","true")}catch{}}).catch(()=>{try{r.value=""}catch{}})}))}function Lt(){try{if(!u.tabs||typeof u.tabs.switchTab!="function"||u.tabs.__trExploreEmbeddedWrapped)return;let e=u.tabs.switchTab;u.tabs.switchTab=function(t){let n=e.call(u.tabs,t);try{String(t)===V&&window.requestAnimationFrame(()=>{ot()})}catch{}try{q&&String(t)!==V&&(q=!1,window.requestAnimationFrame(()=>{u.data?.refreshViewerData?.({preserveScroll:!0})}))}catch{}return n},u.tabs.__trExploreEmbeddedWrapped=!0}catch{}}var N=!1;async function $t(){if(N||v)return;let e=x(),t=T();if(!(!e||!t)&&e.classList.contains("active")){N=!0;try{let n=document.createElement("div");n.className="tr-explore-loading",n.style.cssText="padding:20px;text-align:center;color:#6b7280;font-size:0.9rem;",n.textContent="\u52A0\u8F7D\u4E2D...",t.appendChild(n);let r=await F(G);if(r.length){d=[...d,...r],b(d),n.remove();return}let a=await tt(G);a.length&&(d=[...d,...a],b(d)),n.remove(),m!=null&&P(m)}catch(n){console.error("Load more failed:",n)}finally{N=!1}}}function ct(){let e=T();if(!e||e.dataset.trScrollAttached==="1")return;e.dataset.trScrollAttached="1";let t=null,n=()=>{t&&clearTimeout(t),t=setTimeout(()=>{t=null;let r=e.scrollLeft||0,a=e.scrollWidth||0,s=e.clientWidth||0,i=Math.max(0,a-s),o=i>0?r/i:0;console.log("[Explore] Scroll:",o.toFixed(2),"maxScrollLeft:",i),o>=.7&&!N&&!v&&(console.log("[Explore] Triggering load more..."),$t().catch(()=>{}))},150)};e.addEventListener("scroll",n,{passive:!0}),console.log("[Explore] Scroll listener attached")}U(function(){if(dt){Tt(),Lt(),ct();try{u.tabs?.getActiveTabId&&String(u.tabs.getActiveTabId())===V&&ot()}catch{}}});
