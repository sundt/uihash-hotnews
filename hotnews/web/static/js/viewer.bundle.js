(()=>{var c=window.Hotnews=window.Hotnews||{},En=[],An=!1;function N(t){An?t():En.push(t)}document.addEventListener("DOMContentLoaded",function(){An=!0,En.forEach(t=>{try{t()}catch(e){console.error("Ready handler error:",e)}})});function h(t){return String(t||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function _e(t){let e=t==null?"":String(t).trim();if(!e)return e;let r=e.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(e.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),e)}c.ready=N;c.escapeHtml=h;c.formatUpdatedAt=_e;function dt(t){if(t==null||t==="")return"";try{let e=Number(t);if(Number.isFinite(e)&&e>0){let s=e>1e12?e:e*1e3,i=new Date(s);if(!isNaN(i.getTime())){let a=String(i.getFullYear()),o=String(i.getMonth()+1).padStart(2,"0"),l=String(i.getDate()).padStart(2,"0");return`${a}-${o}-${l}`}}let n=String(t||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})/);if(n)return`${n[1]}-${n[2]}-${n[3]}`}catch{}return""}c.formatNewsDate=dt;var At={container:null,nextId:1,items:new Map};function Bo(){if(At.container)return At.container;let t=document.createElement("div");t.id="tr-toast-container",t.style.position="fixed",t.style.right="16px",t.style.bottom="16px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="10px",t.style.zIndex="99999";try{document.body.appendChild(t)}catch{}return At.container=t,t}function Fo(t){let e=String(t||"info");return e==="loading"?{bg:"#111827",fg:"#fff",border:"#111827"}:e==="success"?{bg:"#16a34a",fg:"#fff",border:"#16a34a"}:e==="error"?{bg:"#dc2626",fg:"#fff",border:"#dc2626"}:{bg:"#111827",fg:"#fff",border:"#111827"}}function xn(t,e,r){let n=Fo(r);t.className="tr-toast",t.style.display="flex",t.style.alignItems="center",t.style.gap="10px",t.style.padding="10px 12px",t.style.borderRadius="10px",t.style.background=n.bg,t.style.color=n.fg,t.style.border=`1px solid ${n.border}`,t.style.boxShadow="0 10px 20px rgba(0,0,0,0.18)",t.style.fontSize="0.9rem",t.style.maxWidth="360px",t.style.wordBreak="break-word";let i=String(r||"info")==="loading"?'<span aria-hidden="true" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.3);"></span>':"";t.innerHTML=`${i}<div class="tr-toast-msg">${h(e||"")}</div>`}c.toast={show(t,e={}){let r=`toast-${At.nextId++}`,n=Bo(),s=document.createElement("div");s.dataset.toastId=r,xn(s,t,e.variant);try{n.appendChild(s)}catch{}let i={id:r,el:s,hideTimer:0};At.items.set(r,i);let a=Number(e.durationMs||0);return a>0&&(i.hideTimer=window.setTimeout(()=>{c.toast.hide(r)},a)),r},update(t,e,r={}){let n=At.items.get(String(t||""));if(!n)return;n.hideTimer&&(window.clearTimeout(n.hideTimer),n.hideTimer=0),xn(n.el,e,r.variant);let s=Number(r.durationMs||0);s>0&&(n.hideTimer=window.setTimeout(()=>{c.toast.hide(t)},s))},hide(t){let e=At.items.get(String(t||""));if(e){e.hideTimer&&(window.clearTimeout(e.hideTimer),e.hideTimer=0);try{e.el.remove()}catch{}At.items.delete(String(t||""))}}};var R={get(t,e=null){try{let r=localStorage.getItem(t);return r===null?e:JSON.parse(r)}catch{return e}},set(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(r){console.error("Storage set error:",r)}},remove(t){try{localStorage.removeItem(t)}catch{}},getRaw(t){return localStorage.getItem(t)},setRaw(t,e){localStorage.setItem(t,e)}};c.storage=R;var qo={updatePlatformCount(t){if(!t)return;let e=t.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=t.querySelector(".platform-visible-count");r&&(r.textContent=e.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let t=document.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length,e=document.getElementById("totalNews");e&&(e.textContent=t)}};c.counts=qo;var It={openLink(t){let e=t.dataset.url;e&&window.open(e,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(t){document.querySelectorAll(".news-item.preview").forEach(e=>{t&&e===t||e.classList.remove("preview")})},handleTitleClickV2(t,e){e.stopPropagation();let r=t.closest(".news-item");if(!r)return;let n=r.querySelector(".news-checkbox");if(n?n.checked||(n.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(n):c.readState&&typeof c.readState.markAsRead=="function"&&c.readState.markAsRead(n)):c.readState&&typeof c.readState.markItemAsRead=="function"&&c.readState.markItemAsRead(r),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}e.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(t,e){e.key==="Enter"?this.handleTitleClickV2(t,e):e.key===" "?(e.preventDefault(),this.handleTitleClickV2(t,e)):e.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(t,e)=>It.handleTitleClickV2(t,e);window.handleTitleKeydownV2=(t,e)=>It.handleTitleKeydownV2(t,e);window.openLink=t=>It.openLink(t);document.addEventListener("click",t=>{t.target.closest(".news-item")||It.closeAllPreviews(null)});document.addEventListener("touchstart",t=>{t.target.closest(".news-item")||It.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",t=>{t.key==="Escape"&&It.closeAllPreviews(null)});c.link=It;var Tn={searchNews(){let e=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let n=r.textContent.toLowerCase();!e||n.includes(e)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),c.counts.updateAllCounts(),c.paging&&typeof c.paging.scheduleAutofillActiveTab=="function"&&c.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>Tn.searchNews();c.search=Tn;var Ln="hotnews_platform_grid_scroll_v1",kn={getPlatformGridScrollState(){return R.get(Ln,{})},setPlatformGridScrollState(t){R.set(Ln,t||{})},recordPlatformGridScrollForTab(t,e){if(!t||!e)return;let r=e.scrollLeft||0,n=null,s=0,i=null,a=e.querySelectorAll(".platform-card");for(let l of a)if((l.offsetLeft||0)<=r+1)i=l;else break;i?.dataset?.platform&&(n=i.dataset.platform,s=Math.max(0,r-(i.offsetLeft||0)));let o=this.getPlatformGridScrollState();o[t]={left:r,anchorPlatformId:n,anchorOffsetX:s,updatedAt:Date.now()},this.setPlatformGridScrollState(o)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(t=>{if(t.dataset.scrollPersistBound==="1")return;t.dataset.scrollPersistBound="1";let e=!1;t.addEventListener("scroll",()=>{t.dataset.trRestoring!=="1"&&(t.dataset.trUserScrolled="1"),!e&&(e=!0,requestAnimationFrame(()=>{e=!1;let r=t.closest(".tab-pane"),n=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(n,t)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(t){let e=t?.activeTab;if(!t?.preserveScroll||!e)return;let r=this.getPlatformGridScrollState()?.[e],n=Number.isFinite(r?.left)?r.left:Number.isFinite(t.activeTabPlatformGridScrollLeft)?t.activeTabPlatformGridScrollLeft:0,s=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:t.activeTabPlatformAnchorPlatformId,i=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(t.activeTabPlatformAnchorOffsetX)?t.activeTabPlatformAnchorOffsetX:0,a=()=>{let o=document.querySelector(`#tab-${e} .platform-grid`);if(o&&o.dataset.trUserScrolled!=="1"){if(s){let l=null;if(o.querySelectorAll(".platform-card").forEach(d=>{!l&&d.dataset.platform===s&&(l=d)}),l&&l.offsetParent!==null){o.dataset.trRestoring="1",o.scrollLeft=(l.offsetLeft||0)+i,requestAnimationFrame(()=>{try{delete o.dataset.trRestoring}catch{}});return}}o.dataset.trRestoring="1",o.scrollLeft=n,requestAnimationFrame(()=>{try{delete o.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{a(),setTimeout(a,50),setTimeout(a,200),setTimeout(a,600)})})},pauseScrollSnap(){document.body.classList.add("tr-snap-paused")},resumeScrollSnap(){setTimeout(()=>{document.body.classList.remove("tr-snap-paused")},100)},setupVisibilityScrollFix(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?(document.body.classList.add("tr-page-hidden"),this.pauseScrollSnap()):document.visibilityState==="visible"&&(document.body.classList.remove("tr-page-hidden"),this.resumeScrollSnap())}),window.addEventListener("beforeunload",()=>{this.pauseScrollSnap()})}};c.scroll=kn;N(function(){kn.setupVisibilityScrollFix()});var Rn="hotnews_feature_badge_v1:",Pn="hotnews_new_badges_dismissed_v1",Ar={getFeatureBadgeState(t){return R.get(Rn+t,null)},setFeatureBadgeState(t,e){R.set(Rn+t,e)},ensureFeatureFirstSeen(t){let e=this.getFeatureBadgeState(t);if(e&&typeof e.firstSeenAt=="number")return e;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(t,r),r},markFeatureSeen(t){let e=this.ensureFeatureFirstSeen(t);e.seenAt||(e.seenAt=Date.now(),this.setFeatureBadgeState(t,e))},shouldShowFeatureBadge(t,e){let r=this.ensureFeatureFirstSeen(t);if(r.seenAt)return!1;let n=(e||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=n},updateNewBadges(){let t=document.getElementById("newBadgeSportsTab");t&&(t.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let t=R.get(Pn,{});return{categories:t?.categories||{},platforms:t?.platforms||{}}},setDismissedNewBadges(t){R.set(Pn,t||{categories:{},platforms:{}})},applyDismissedNewBadges(){let t=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(e=>{let r=e?.dataset?.category;r&&t.categories?.[r]&&(e.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(e=>{let r=e?.dataset?.platform;r&&t.platforms?.[r]&&(e.style.display="none")})},dismissNewCategoryBadge(t){if(!t)return;let e=this.getDismissedNewBadges();e.categories?.[t]||(e.categories[t]=!0,this.setDismissedNewBadges(e)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(t)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(t){if(!t)return;let e=this.getDismissedNewBadges();e.platforms?.[t]||(e.platforms[t]=!0,this.setDismissedNewBadges(e)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(t)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=t=>Ar.dismissNewPlatformBadge(t);c.badges=Ar;N(function(){Ar.applyDismissedNewBadges()});var We=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Ho=50,$c=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Mn=10,Go=8,jo=80,zo=160,Ce={PAGE_SIZE:We,getCardMaxPageSize(t){try{if(t?.classList?.contains("tr-morning-brief-card"))return Ho}catch{}return We},getCardPageSize(t){let e=t?.dataset?.pageSize,r=parseInt(e||"",10),n=Number.isFinite(r)&&r>0?r:We,s=this.getCardMaxPageSize(t);return Math.min(s,Math.max(1,n))},setCardPageSize(t,e){if(!t)return;let r=parseInt(String(e||""),10),n=Number.isFinite(r)&&r>0?r:We,s=this.getCardMaxPageSize(t);t.dataset.pageSize=String(Math.min(s,Math.max(1,n)))},applyPagingToCard(t,e){let r=Array.from(t.querySelectorAll(".news-item")),n=r.length,s=this.getCardPageSize(t);if(n<=s){r.forEach(o=>o.classList.remove("paged-hidden")),t.dataset.pageOffset="0";return}let i=Math.max(0,Math.min(e,n-1)),a=Math.min(i+s,n);r.forEach((o,l)=>{l>=i&&l<a?o.classList.remove("paged-hidden"):o.classList.add("paged-hidden")}),t.dataset.pageOffset=String(i)},initPaging(){document.querySelectorAll(".platform-card").forEach(t=>{let e=this.getCardMaxPageSize(t);this.setCardPageSize(t,e),this.applyPagingToCard(t,0)}),c.counts.updateAllCounts()},refreshPlatform(t){let e=t.closest(".platform-card");if(!e)return;let n=e.querySelectorAll(".news-item").length,s=this.getCardPageSize(e);if(n<=s)return;let i=parseInt(e.dataset.pageOffset||"0",10),a=i+s>=n?0:i+s;this.applyPagingToCard(e,a),c.counts.updateAllCounts()},getVisibleNewsItems(t){return t?Array.from(t.querySelectorAll(".news-item")).filter(e=>!e.classList.contains("filtered")&&!e.classList.contains("search-hidden")&&!e.classList.contains("paged-hidden")&&!e.classList.contains("read")):[]},shouldAutofillCard(t,e){if(!t||t.classList.contains("platform-empty-hidden"))return!1;try{if(t.classList.contains("tr-morning-brief-card"))return!1}catch{}let r=this.getVisibleNewsItems(t),n=Number.isFinite(e)?e:Mn;if(r.length<n)return!0;let s=r[r.length-1];if(!s)return!0;let i=t.getBoundingClientRect(),a=s.getBoundingClientRect();return!Number.isFinite(i.bottom)||!Number.isFinite(a.bottom)?!1:i.bottom-a.bottom>=jo},autofillCard(t,e={}){if(!t)return!1;try{if(t.classList.contains("tr-morning-brief-card"))return!1}catch{}let r=Number.isFinite(e.minVisible)?e.minVisible:Mn,n=Number.isFinite(e.maxSteps)?e.maxSteps:Go,s=e.force===!0,i=t.querySelectorAll(".news-item").length;if(i<=0)return!1;let a=parseInt(t.dataset.pageOffset||"0",10)||0,o=this.getCardPageSize(t),l=!1,d=Math.max(0,a);for(let u=0;u<n&&!(!s&&!this.shouldAutofillCard(t,r)||i<=o);u++){let f=d+o;if(f+o>i&&(f=0),f===d)break;d=f,this.setCardPageSize(t,o),this.applyPagingToCard(t,d),l=!0}return l&&c.counts.updateAllCounts(),l},autofillForCategory(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r)return!1;let n=!1;return r.querySelectorAll(".platform-card").forEach(s=>{this.autofillCard(s,e)&&(n=!0)}),n},autofillActiveTab(t={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,t):!1},scheduleAutofillActiveTab(t={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(t)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=zo&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=t=>Ce.refreshPlatform(t);c.paging=Ce;N(function(){Ce.initPaging(),Ce.attachAutofillScrollListener(),Ce.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var In="hotnews_read_news_v2",Nn="hotnews_read_news",$n="hotnews_show_read_mode",Yo=24,ut={getReadNews(){return R.get(In,{})},saveReadNews(t){R.set(In,t)},getShowReadModePref(){let t=R.getRaw($n);return t===null?!0:t==="1"},applyShowReadMode(t){t?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let e=document.getElementById("showReadBtn");e&&(t?e.classList.add("active"):e.classList.remove("active"))},migrateOldFormat(){R.getRaw(Nn)&&(R.remove(Nn),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let t=Date.now(),e=this.getReadNews(),r=!1,n=0;for(let[s,i]of Object.entries(e))if((t-i.readAt)/36e5>=Yo){let o=document.querySelector(`[data-news-id="${s}"]`);if(o){o.classList.remove("read");let l=o.querySelector(".news-checkbox");l&&(l.checked=!1)}delete e[s],r=!0,n++}return r&&this.saveReadNews(e),n},markAsRead(t){let e=t.closest(".news-item"),r=e.dataset.newsId,n=e.dataset.newsTitle||"",s=this.getReadNews();t.checked?(e.classList.add("read"),s[r]||(s[r]={title:n.substring(0,50),readAt:Date.now()},this.saveReadNews(s))):(e.classList.remove("read"),delete s[r],this.saveReadNews(s)),c.counts.updatePlatformCount(t.closest(".platform-card")),this.updateReadCount()},markItemAsRead(t){try{if(!t)return;let e=t.dataset.newsId,r=t.dataset.newsTitle||"";if(!e)return;t.classList.add("read");let n=this.getReadNews();n[e]||(n[e]={title:String(r||"").substring(0,50),readAt:Date.now()},this.saveReadNews(n)),c.counts.updatePlatformCount(t.closest(".platform-card")),this.updateReadCount()}catch{}},updateReadCount(){let t=this.getReadNews(),e=document.getElementById("readCount");e&&(e.textContent=Object.keys(t).length)},restoreReadState(){let t=this.getReadNews();Object.keys(t).forEach(e=>{let r=document.querySelector(`[data-news-id="${e}"]`);if(r){r.classList.add("read");let n=r.querySelector(".news-checkbox");n&&(n.checked=!0)}}),c.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let t=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(t),R.setRaw($n,t?"1":"0"),c.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(t=>{t.classList.remove("read");let e=t.querySelector(".news-checkbox");e&&(e.checked=!1)}),this.saveReadNews({}),c.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=t=>ut.markAsRead(t);window.toggleShowRead=()=>ut.toggleShowRead();window.clearAllRead=()=>ut.clearAllRead();c.readState=ut;N(function(){ut.applyShowReadMode(ut.getShowReadModePref()),ut.migrateOldFormat();let t=ut.cleanupExpiredReads();t>0&&console.log(`\u5DF2\u6E05\u7406 ${t} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),ut.restoreReadState(),ut.updateReadCount()});var On="hotnews_theme_mode",Dn="eye-protection-mode",Tr={isDarkMode(){try{return localStorage.getItem(On)==="dark"}catch{return!1}},toggle(){let e=!this.isDarkMode();this.apply(e);try{localStorage.setItem(On,e?"dark":"light")}catch{}},apply(t){t?document.body.classList.add(Dn):document.body.classList.remove(Dn),this.updateButtonState(t)},updateButtonState(t){let e=document.getElementById("themeToggleBtn");e&&(e.innerHTML=t?"\u{1F31E}":"\u{1F319}",e.classList.toggle("active",t))},init(){let t=this.isDarkMode();this.apply(t)}};c.theme=Tr;window.toggleTheme=function(){Tr.toggle()};document.addEventListener("DOMContentLoaded",()=>{Tr.init()});var Xe="hotnews_categories_config",Lr=1,O=null,V=null,Nt=null,xe=!1,Zt=!1,Tt=!0,Vo=null,Ee="",ft=!1;function Wo(t,e){let r=Array.isArray(t)?t:[],n=new Set,s=[];r.forEach(a=>{let o=String(a||"").trim();o&&(n.has(o)||(n.add(o),s.push(o)))});let i=Array.isArray(e)?e:[];i.forEach(a=>{let o=s.indexOf(a);o>=0&&s.splice(o,1)});for(let a=i.length-1;a>=0;a-=1){let o=String(i[a]||"").trim();o&&s.unshift(o)}return s}function Ue(t){(!t.categoryFilters||typeof t.categoryFilters!="object")&&(t.categoryFilters={})}function Bn(t){let e=t&&typeof t=="object"?t:{};return Array.isArray(e.customCategories)||(e.customCategories=[]),Array.isArray(e.hiddenDefaultCategories)||(e.hiddenDefaultCategories=[]),Array.isArray(e.hiddenPlatforms)||(e.hiddenPlatforms=[]),Array.isArray(e.categoryOrder)||(e.categoryOrder=[]),(!e.platformOrder||typeof e.platformOrder!="object")&&(e.platformOrder={}),Ue(e),e}var q={CATEGORY_CONFIG_KEY:Xe,ensureCategoryFilters:Ue,normalizeCategoryConfig:Bn,getCategoryConfig(){try{let t=R.getRaw(Xe);if(!t)return null;let e=JSON.parse(t);return e.version!==Lr?null:Bn(e)}catch{return null}},saveCategoryConfig(t){t.version=Lr,R.setRaw(Xe,JSON.stringify(t)),this.syncConfigToCookie(t)},syncConfigToCookie(t){try{t.customCategories?.length>0||t.hiddenDefaultCategories?.length>0||t.hiddenPlatforms?.length>0||t.categoryOrder?.length>0?document.cookie="hotnews_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="hotnews_has_config=; path=/; max-age=0"}catch(e){console.error("Failed to sync config to cookie:",e)}},getDefaultCategoryConfig(){return O||(O={},V={},document.querySelectorAll(".category-tab").forEach(t=>{let e=t.dataset.category,r=t.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",n=t.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||e;O[e]={id:e,name:n,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card:not(.tr-morning-brief-card)").forEach(t=>{let e=t.dataset.platform,r=(t.querySelector(".platform-name")?.textContent||"").replace(/NEW\s*$/i,"").replace(/ðŸ“±\s*/g,"").trim()||e,s=t.closest(".tab-pane")?.id?.replace("tab-","")||"other";V[e]={id:e,name:r,defaultCategory:s},O[s]&&(O[s].platforms||(O[s].platforms=[]),O[s].platforms.push(e))})),{version:Lr,customCategories:[],hiddenDefaultCategories:[],hiddenPlatforms:[],categoryOrder:Object.keys(O),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let t=this.getDefaultCategoryConfig(),e=this.getCategoryConfig();if(!e)return t;let r={...t,customCategories:e.customCategories||[],hiddenDefaultCategories:e.hiddenDefaultCategories||[],hiddenPlatforms:e.hiddenPlatforms||[],categoryOrder:e.categoryOrder||t.categoryOrder,platformOrder:e.platformOrder||{},categoryFilters:e.categoryFilters||{}};Object.keys(O).forEach(n=>{r.categoryOrder.includes(n)||r.categoryOrder.push(n)}),r.customCategories.forEach(n=>{r.categoryOrder.includes(n.id)||r.categoryOrder.push(n.id)});try{let n="__migrated_explore_knowledge_front_v1",s=Array.isArray(e.categoryOrder)?e.categoryOrder.indexOf("explore"):-1,i=Array.isArray(e.categoryOrder)?e.categoryOrder.indexOf("knowledge"):-1,a=s!==0||i!==1;if(!e[n]&&a){let o=Wo(r.categoryOrder,["explore","knowledge"]);r.categoryOrder=o,e.categoryOrder=o,e[n]=Date.now(),this.saveCategoryConfig(e)}}catch{}return r},getDefaultCategories(){return O},getAllPlatforms(){return V},addPlatformToCustomCategory(t,e){let r=String(t||"").trim(),n=String(e||"").trim();if(!r||!n)return!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();Ue(s);let i=Array.isArray(s.customCategories)?s.customCategories.findIndex(l=>String(l?.id||"").trim()===r):-1;if(i<0)return!1;let a=s.customCategories[i]||{},o=Array.isArray(a.platforms)?[...a.platforms]:[];return o.includes(n)||o.push(n),s.customCategories[i]={...a,platforms:o},Array.isArray(s.categoryOrder)&&!s.categoryOrder.includes(r)&&s.categoryOrder.unshift(r),this.saveCategoryConfig(s),ft=!0,!0},setDefaultCategories(t){O=t},setAllPlatforms(t){V=t},async openCategorySettings(){let t=document.getElementById("categorySettingsNewBadge");if(t&&(t.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!O||Object.keys(O).length===0)try{let n=await(await fetch("/api/news")).json();n?.categories&&(O={},V={},Object.entries(n.categories).forEach(([s,i])=>{O[s]={id:s,name:i.name,icon:i.icon,isDefault:!0,platforms:Object.keys(i.platforms||{})},Object.entries(i.platforms||{}).forEach(([a,o])=>{V[a]={id:a,name:o.name,defaultCategory:s,data:o}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),Tt=!0,Vo=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let t=document.getElementById("categoryListWrapper");t&&(Tt?t.classList.add("collapsed"):t.classList.remove("collapsed"));let e=document.getElementById("categoryListToggleBtn");e&&(e.textContent=Tt?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){Tt=!Tt,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),ft&&(ft=!1,this.applyCategoryConfig())},saveCategorySettings(){let t=document.getElementById("categoryEditPanel");t&&t.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){ft=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let t=document.getElementById("categoryList"),e=this.getMergedCategoryConfig(),r="";e.categoryOrder.forEach(s=>{let i=e.customCategories.find(d=>d.id===s),a=e.hiddenDefaultCategories.includes(s),o;if(i)o=i;else if(O[s])o=O[s];else return;let l=i?o.platforms?.length||0:O[s]?.platforms?.length||0;r+=`
                <div class="category-item ${i?"custom":""}" data-category-id="${s}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${o.name}</span>
                    <span class="category-item-platforms">${l} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${a?"":"checked"} onchange="toggleCategoryVisibility('${s}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${s}')">\u7F16\u8F91</button>
                        ${i?`<button class="category-item-btn delete" onclick="deleteCategory('${s}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),t.innerHTML=r;let n=document.getElementById("allCategoriesOffToggle");if(n){let s=e.hiddenDefaultCategories||[],i=e.categoryOrder||[];n.checked=i.length>0&&i.every(a=>s.includes(a))}Zt?t.classList.add("hide-default"):t.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){Zt=!Zt,this.renderCategoryList()},toggleAllCategoriesOffInSettings(t){},setupCategoryDragAndDrop(){let t=document.getElementById("categoryList");t.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",n=>{r.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",n=>{n.preventDefault();let s=t.querySelector(".dragging");if(s&&s!==r){let i=r.getBoundingClientRect(),a=i.top+i.height/2;n.clientY<a?t.insertBefore(s,r):t.insertBefore(s,r.nextSibling)}})})},saveCategoryOrder(){let e=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(e).map(s=>s.dataset.categoryId),n=this.getCategoryConfig()||this.getDefaultCategoryConfig();n.categoryOrder=r,this.saveCategoryConfig(n),ft=!0},toggleCategoryVisibility(t){let e=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=e.hiddenDefaultCategories.indexOf(t);r>=0?e.hiddenDefaultCategories.splice(r,1):e.hiddenDefaultCategories.push(t),this.saveCategoryConfig(e),ft=!0,this.renderCategoryList()},togglePlatformHidden(t){let e=String(t||"").trim();if(!e)return!1;let r=this.getCategoryConfig()||this.getDefaultCategoryConfig();Array.isArray(r.hiddenPlatforms)||(r.hiddenPlatforms=[]);let n=r.hiddenPlatforms.findIndex(s=>String(s||"").trim()===e);return n>=0?r.hiddenPlatforms.splice(n,1):r.hiddenPlatforms.push(e),this.saveCategoryConfig(r),ft=!0,this.applyCategoryConfig(),!0},showAddCategoryPanel(){xe=!0,Nt=null,Tt=!0,this.applyCategoryListCollapseState(),Zt=!0,document.getElementById("editCategoryName").value="";let t=document.getElementById("platformSelectField");t&&(t.style.display="");let e=document.getElementById("platformSearchInput");e&&(e.value=""),Ee="",this.renderPlatformSelectList([],!0),c.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(t){xe=!1,Nt=t;let e=document.getElementById("platformSelectField");e&&(e.style.display="");let r=this.getMergedCategoryConfig(),n=r.customCategories.find(l=>l.id===t),s,i;n?(s=n,i=s.platforms||[]):(s=O[t],i=r.platformOrder[t]||s.platforms||[]),document.getElementById("editCategoryName").value=s.name,this.renderPlatformSelectList(i,n);let a=c.filter.getCategoryFilterConfig(t);c.filter.setCategoryFilterEditorState(a.mode,a.keywords),Zt=!0,Tt=!0,this.applyCategoryListCollapseState();let o=document.getElementById("platformSearchInput");o&&(o.value=""),Ee="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),Nt=null,xe=!1,Zt=!1,this.renderCategoryList();let t=document.getElementById("platformSearchInput");t&&(t.value=""),Ee=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(t,e=!1){let r=document.getElementById("platformSelectList"),s=(this.getMergedCategoryConfig().hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),i=new Set(s),a=[];t.forEach(u=>{V[u]&&a.push(u)}),e&&Object.keys(V).forEach(f=>{a.includes(f)||a.push(f)});let o=(Ee||"").trim().toLowerCase(),l=o?a.filter(u=>(V[u]?.name||"").toLowerCase().includes(o)):a,d=o.length>0;r.innerHTML=l.map(u=>{let f=V[u],m=t.includes(u)&&!i.has(String(u||"").trim());return`
                <label class="platform-select-item ${m?"selected":""} ${d?"no-drag":""}" data-platform-id="${u}" draggable="${d?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${m?"checked":""} onchange="togglePlatformSelect('${u}')">
                    <span>${f.name}</span>
                </label>
            `}).join(""),d||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(t){Ee=String(t||"");let e=this.getSelectedPlatforms();this.renderPlatformSelectList(e,xe===!0)},bulkSelectPlatforms(t){let e=document.getElementById("platformSelectList");if(!e)return;e.querySelectorAll(".platform-select-item").forEach(n=>{let s=n.querySelector('input[type="checkbox"]');t==="all"?(n.classList.add("selected"),s&&(s.checked=!0)):(t==="none"||t==="clear")&&(n.classList.remove("selected"),s&&(s.checked=!1))})},setupPlatformDragAndDrop(){let t=document.getElementById("platformSelectList"),e=t.querySelectorAll(".platform-select-item"),r=60,n=20,s=null,i=0,a=0,o=()=>{s&&cancelAnimationFrame(s),s=null,i=0,a=0},l=()=>{if(!i||!a){o();return}let u=Math.max(0,(t.scrollHeight||0)-(t.clientHeight||0));if(u<=0){o();return}let f=Math.max(0,Math.min(u,(t.scrollTop||0)+i*a));t.scrollTop=f,s=requestAnimationFrame(l)},d=u=>{let f=t.getBoundingClientRect(),m=u.clientY,p=m-f.top,w=f.bottom-m,T=0,y=0;if(p>=0&&p<=r)T=-1,y=p;else if(w>=0&&w<=r)T=1,y=w;else{o();return}let A=Math.max(0,Math.min(1,(r-y)/r));a=Math.max(2,Math.round(A*A*n)),i=T,s||(s=requestAnimationFrame(l))};e.forEach(u=>{u.addEventListener("dragstart",f=>{u.classList.add("dragging"),f.dataTransfer.effectAllowed="move"}),u.addEventListener("dragend",()=>{u.classList.remove("dragging"),o()}),u.addEventListener("dragover",f=>{f.preventDefault(),d(f);let m=t.querySelector(".dragging");if(m&&m!==u){let p=u.getBoundingClientRect(),w=p.top+p.height/2;f.clientY<w?t.insertBefore(m,u):t.insertBefore(m,u.nextSibling)}})}),t.addEventListener("dragover",u=>{u.preventDefault(),t.querySelector(".dragging")&&d(u)})},togglePlatformSelect(t){let e=document.querySelector(`.platform-select-item[data-platform-id="${t}"]`);e&&e.classList.toggle("selected")},getSelectedPlatforms(){let t=document.querySelectorAll(".platform-select-item"),e=[];return t.forEach(r=>{r.classList.contains("selected")&&e.push(r.dataset.platformId)}),e},getOrderedPlatforms(){let t=document.querySelectorAll(".platform-select-item"),e=[];return t.forEach(r=>{let n=String(r?.dataset?.platformId||"").trim();n&&e.push(n)}),e},saveCategory(){let t=document.getElementById("editCategoryName").value.trim(),e="\u{1F4F1}",r=this.getSelectedPlatforms(),n=this.getOrderedPlatforms();if(!t)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();Ue(s);let i=c.filter.getEditingFilterState();if(xe){let a="custom-"+Date.now();s.customCategories.push({id:a,name:t,icon:e,platforms:r,isCustom:!0}),s.categoryOrder.unshift(a),s.categoryFilters[a]={mode:i.mode,keywords:[...i.keywords]}}else if(Nt){let a=s.customCategories.findIndex(o=>o.id===Nt);if(a>=0)s.customCategories[a]={...s.customCategories[a],name:t,icon:e,platforms:r};else{s.platformOrder[Nt]=n,Array.isArray(s.hiddenPlatforms)||(s.hiddenPlatforms=[]);let o=new Set((s.hiddenPlatforms||[]).map(l=>String(l||"").trim()).filter(Boolean));n.forEach(l=>{l&&(r.includes(l)?o.delete(l):o.add(l))}),s.hiddenPlatforms=Array.from(o)}s.categoryFilters[Nt]={mode:i.mode,keywords:[...i.keywords]}}return this.saveCategoryConfig(s),ft=!0,this.hideEditPanel(),this.renderCategoryList(),Tt=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(t){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let e=this.getCategoryConfig()||this.getDefaultCategoryConfig();e.customCategories=e.customCategories.filter(r=>r.id!==t),e.categoryOrder=e.categoryOrder.filter(r=>r!==t),delete e.platformOrder[t],this.saveCategoryConfig(e),ft=!0,this.renderCategoryList()},resetDefaultCategoryConfig(){if(!confirm("\u786E\u5B9A\u8981\u521D\u59CB\u5316\u9ED8\u8BA4\u680F\u76EE\u4E0E\u5361\u7247\u5417\uFF1F\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u4FDD\u7559\u3002"))return;let t=this.getCategoryConfig();if(!t){this.renderCategoryList(),this.applyCategoryConfig();return}let e=this.getDefaultCategoryConfig(),r=Array.isArray(e?.categoryOrder)?e.categoryOrder:[],n=new Set(r.map(o=>String(o||"").trim()).filter(Boolean)),s=t;s.hiddenDefaultCategories=(s.hiddenDefaultCategories||[]).filter(o=>!n.has(String(o||"").trim())),s.hiddenPlatforms=[],s.platformOrder={};let i=Array.isArray(s.customCategories)?s.customCategories.map(o=>String(o?.id||"").trim()).filter(Boolean):[],a=r.slice();for(let o of i)a.includes(o)||a.push(o);s.categoryOrder=a,this.saveCategoryConfig(s),ft=!0,this.renderCategoryList(),this.applyCategoryConfig()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(R.remove(Xe),O=null,V=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){c.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(t){let e=this.getMergedCategoryConfig();O?Object.entries(t).forEach(([u,f])=>{if(!O[u])O[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})};else{O[u].platforms||(O[u].platforms=[]);let m=new Set(O[u].platforms||[]);Object.keys(f.platforms||{}).forEach(p=>{m.has(p)||O[u].platforms.push(p)})}Object.entries(f.platforms||{}).forEach(([m,p])=>{V[m]||(V[m]={id:m,name:p.name,defaultCategory:u,data:p})})}):(O={},V={},Object.entries(t).forEach(([u,f])=>{O[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})},Object.entries(f.platforms||{}).forEach(([m,p])=>{V[m]={id:m,name:p.name,defaultCategory:u,data:p}})}));let r={};Object.values(t).forEach(u=>{Object.entries(u.platforms||{}).forEach(([f,m])=>{r[f]=m})});let n={},s=e.hiddenDefaultCategories||[],i=(e.hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),a=new Set(i),o=e.categoryOrder||Object.keys(t),l=e.customCategories||[],d=e.platformOrder||{};return o.forEach(u=>{if(s.includes(u)||String(u||"").startsWith("rsscol-"))return;let f=l.find(m=>m.id===u);if(f){let m={};(f.platforms||[]).forEach(p=>{a.has(String(p||"").trim())||r[p]&&(m[p]=r[p])}),n[u]={name:f.name,icon:"\u{1F4F1}",platforms:m}}else if(t[u]){let m=t[u],p=d[u];if(p&&p.length>0){let w=[],T=new Set;p.forEach(x=>{a.has(String(x||"").trim())||m.platforms&&m.platforms[x]&&(w.push(x),T.add(x))});let y=[],A=[];Object.keys(m.platforms||{}).forEach(x=>{T.has(x)||a.has(String(x||"").trim())||(String(x||"").startsWith("rss-")?y.push(x):A.push(x))});let b=y.concat(w,A),E={};b.forEach(x=>{a.has(String(x||"").trim())||m.platforms&&m.platforms[x]&&(E[x]=m.platforms[x])}),n[u]={...m,platforms:E}}else{let w={};Object.entries(m.platforms||{}).forEach(([T,y])=>{a.has(String(T||"").trim())||(w[T]=y)}),n[u]={...m,platforms:w}}}}),Object.keys(t).forEach(u=>{String(u||"").startsWith("rsscol-")&&String(u)!=="rsscol-rss"||!n[u]&&!s.includes(u)&&(n[u]=t[u])}),n}};window.openCategorySettings=()=>q.openCategorySettings();window.closeCategorySettings=()=>q.closeCategorySettings();window.saveCategorySettings=()=>q.saveCategorySettings();window.cancelCategorySettings=()=>q.cancelCategorySettings();window.showAddCategoryPanel=()=>q.showAddCategoryPanel();window.editCategory=t=>q.editCategory(t);window.cancelEditCategory=()=>q.cancelEditCategory();window.saveCategory=()=>q.saveCategory();window.deleteCategory=t=>q.deleteCategory(t);window.resetDefaultCategoryConfig=()=>q.resetDefaultCategoryConfig();window.resetCategoryConfig=()=>q.resetCategoryConfig();window.toggleCategoryVisibility=t=>q.toggleCategoryVisibility(t);window.toggleCategoryListCollapseInSettings=()=>q.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=t=>q.toggleAllCategoriesOffInSettings(t);window.togglePlatformSelect=t=>q.togglePlatformSelect(t);window.bulkSelectPlatforms=t=>q.bulkSelectPlatforms(t);window.setPlatformSearchQuery=t=>q.setPlatformSearchQuery(t);c.settings=q;N(function(){let t=q.getCategoryConfig();t&&q.syncConfigToCookie(t)});var Fn="hotnews_filter_keywords",qn="hotnews_filter_mode_v1",$t=[],Ke="exclude";function Je(t){return t==="include"?"include":"exclude"}var Ot={normalizeFilterMode:Je,getCategoryFilterConfig(t){if(!t)return{mode:"exclude",keywords:[]};let e=c.settings.getMergedCategoryConfig(),r=e.categoryFilters&&e.categoryFilters[t],n=Je(r&&r.mode),s=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:n,keywords:s.map(i=>String(i||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(t){let e=document.getElementById(`tab-${t}`);if(!e)return;let r=this.getCategoryFilterConfig(t),n=r.mode,s=r.keywords,i=`${n}|${s.join(",")}`,o=(e.dataset?e.dataset.filterSig:null)!==i;e.dataset&&(e.dataset.filterSig=i);let l=e.dataset&&e.dataset.bulkLoading==="1";if(e.querySelectorAll(".news-item").forEach(d=>{let u=(d.textContent||"").toLowerCase(),f=s.length>0?s.some(p=>u.includes(p)):!1;(s.length===0?!1:n==="include"?!f:f)?d.classList.add("filtered"):d.classList.remove("filtered")}),n!=="include"&&e.querySelectorAll(".platform-card").forEach(d=>{d.classList.remove("platform-empty-hidden")}),n==="include"){if(s.length>0)try{if(o&&!l){if(e.querySelectorAll(".platform-card").forEach(d=>{d?.dataset&&(d.dataset.loadedDone="0")}),c.infiniteScroll&&typeof c.infiniteScroll.scheduleBulkLoadCategory=="function")c.infiniteScroll.scheduleBulkLoadCategory(t,{pageSize:40});else if(c.infiniteScroll&&typeof c.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let d=e.querySelectorAll(".platform-card").length;c.infiniteScroll.scheduleEnsureCategoryLoaded(t,{cap:d,maxPagesPerCard:2})}}}catch{}e.querySelectorAll(".platform-card").forEach(d=>{let u=d?.dataset?.loadedDone==="1",f=!u||d?.dataset?.loading==="1";if(s.length>0&&f){d.classList.add("platform-empty-hidden");return}d.classList.remove("platform-empty-hidden"),d.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&u&&d.classList.add("platform-empty-hidden")})}try{let d=e.querySelector(".category-empty-state");if(d)if(n==="include"&&s.length>0){let u=Array.from(e.querySelectorAll(".platform-card")),f=u.length>0&&u.every(p=>p?.dataset?.loadedDone==="1"&&p?.dataset?.loading!=="1"),m=e.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;d.style.display=f&&m===0?"block":"none"}else d.style.display="none"}catch{}c.counts.updateAllCounts(),c.paging&&typeof c.paging.scheduleAutofillActiveTab=="function"&&c.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let e=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;e&&this.applyCategoryFilter(e)},setCategoryFilterEditorState(t,e){Ke=Je(t),$t=(Array.isArray(e)?e:[]).map(s=>String(s||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=Ke==="include");let n=document.getElementById("categoryFilterInput");n&&(n.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(t){Ke=t&&t.checked?"include":"exclude"},handleCategoryFilterKeypress(t){t.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let t=document.getElementById("categoryFilterInput"),e=(t?.value||"").trim().toLowerCase();e&&($t.includes(e)||($t.push(e),this.renderCategoryFilterTags()),t&&(t.value=""))},removeCategoryFilterKeyword(t){$t=$t.filter(e=>e!==t),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let t=document.getElementById("categoryFilterTags");t&&(t.innerHTML=$t.map(e=>`<span class="filter-tag">${h(e)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${h(e)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:Ke,keywords:[...$t]}},migrateLegacyGlobalFilter(){let t=R.getRaw(Fn),e=R.getRaw(qn);if(!t&&!e)return;let r=[];try{r=t?JSON.parse(t):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(o=>String(o||"").trim().toLowerCase()).filter(Boolean);let n=Je(e),s=c.settings.getCategoryConfig()||c.settings.getDefaultCategoryConfig();c.settings.ensureCategoryFilters(s),(c.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(o=>{s.categoryFilters[o]||(s.categoryFilters[o]={mode:n,keywords:[...r]})}),c.settings.saveCategoryConfig(s),R.remove(Fn),R.remove(qn)}};window.handleCategoryFilterModeToggle=t=>Ot.handleCategoryFilterModeToggle(t);window.handleCategoryFilterKeypress=t=>Ot.handleCategoryFilterKeypress(t);window.addCategoryFilterKeyword=()=>Ot.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=t=>Ot.removeCategoryFilterKeyword(t);c.filter=Ot;N(function(){Ot.migrateLegacyGlobalFilter(),Ot.applyCategoryFilterForActiveTab()});var Qt="hotnews_active_tab",Hn="hotnews_viewer_pos_v1";var Xo="tr_tab_switched",Uo="tr_explore_modal_opened",Ko="tr_explore_modal_closed",Dt=null,kr=0;function Gn(t,e){try{let r=String(t||"").trim();if(!r)return;let n={activeTab:r,scrollY:Number(e||0)||0,updatedAt:Date.now()};R.setRaw(Hn,JSON.stringify(n))}catch{}}function Jo(){try{let t=Lt.getActiveTabId();Dt=t?String(t):null,kr=window.scrollY||0;try{let e=Dt?document.querySelector(`#tab-${Dt} .platform-grid`):null;Dt&&e&&c.scroll.recordPlatformGridScrollForTab(Dt,e)}catch{}}catch{}}function Zo(){try{let t=R.getRaw(Hn);if(!t)return;let e=JSON.parse(t),r=String(e?.activeTab||"").trim();if(!r)return;let n=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(r)):String(r);if(!document.querySelector(`.category-tab[data-category="${n}"]`))return;Lt.switchTab(r);let i=Number(e?.scrollY||0)||0;requestAnimationFrame(()=>{try{window.scrollTo({top:i,behavior:"auto"})}catch{}})}catch{}}function Qo(){let t=Dt,e=kr;if(Dt=null,kr=0,!!t){try{let r=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(t)):String(t),n=document.querySelector(`.category-tab[data-category="${r}"]`),s=document.getElementById(`tab-${t}`);if(!n||!s)return}catch{}try{c.tabs.switchTab(t)}catch{}Gn(t,e),requestAnimationFrame(()=>{try{window.scrollTo({top:e,behavior:"auto"})}catch{}try{c.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t})}catch{}})}}var Lt={TAB_STORAGE_KEY:Qt,switchTab(t){c.badges.dismissNewCategoryBadge(t),document.body.classList.toggle("tr-rss-reading",String(t)==="rsscol-rss");let e=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(t)):String(t),r=document.querySelector(`.category-tab[data-category="${e}"]`),n=document.getElementById(`tab-${t}`);if(!r||!n){let a=document.querySelector(".category-tab");a?.dataset?.category&&a.dataset.category!==String(t)?this.switchTab(a.dataset.category):R.remove(Qt);return}let s=r.querySelector(".update-dot.show"),i=!!s;s&&s.classList.remove("show"),document.querySelectorAll(".category-tab").forEach(a=>a.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(a=>a.classList.remove("active")),n.classList.add("active"),R.setRaw(Qt,t);try{window.dispatchEvent(new CustomEvent(Xo,{detail:{categoryId:t,hasUpdate:i}}))}catch{}Gn(t,window.scrollY||0),c.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t}),t==="sports"&&(c.badges.markFeatureSeen("sports-nba-schedule"),c.badges.updateNewBadges()),c.filter.applyCategoryFilter(t),c.paging&&typeof c.paging.scheduleAutofillActiveTab=="function"&&c.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let a=!!n.querySelector(".news-item"),o=!!n.querySelector(".news-placeholder");!a&&o&&(c.infiniteScroll&&typeof c.infiniteScroll.scheduleBulkLoadCategory=="function"?c.infiniteScroll.scheduleBulkLoadCategory(t):c.infiniteScroll&&typeof c.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&c.infiniteScroll.scheduleEnsureCategoryLoaded(t))}catch{}},restoreActiveTab(){let t=R.getRaw(Qt);if(t){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"&&String(t)==="rsscol-rss"){R.remove(Qt);return}}catch{}document.querySelector(`.category-tab[data-category="${t}"]`)&&this.switchTab(t)}},getActiveTabId(){return R.getRaw(Qt)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(t){c.scroll.restoreActiveTabPlatformGridScroll(t)},attachPlatformGridScrollPersistence(){c.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=t=>Lt.switchTab(t);c.tabs=Lt;N(function(){try{window.addEventListener(Uo,()=>{Jo()}),window.addEventListener(Ko,()=>{Qo()})}catch{}Lt.restoreActiveTab(),Zo(),Lt.attachPlatformGridScrollPersistence();let t=Lt.getActiveTabId();t&&Lt.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t})});var Rr="hotnews_active_tab",ne=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Pr=!1,ti=0,te=null,ei=null,jn=!1,ee=null;function ri(t){let r=t?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function ni(t,e){let n=String(e||"").trim().startsWith("rss-");return`${n?'<button type="button" class="tr-platform-card-delete" data-action="delete-platform">\u2212</button>':""}${n?"":'<button type="button" class="tr-platform-card-hide" data-action="hide-platform">\u{1F648}</button>'}`}function si(t){let e=Math.max(0,Number(t||0)||0),r="";for(let n=0;n<e;n++)r+='<li class="tr-news-skeleton" aria-hidden="true"><div class="tr-news-skeleton-line"></div></li>';return r}function oi(t,e,r){let n=document.createElement("li");n.className="news-item",n.dataset.newsId=String(t?.stable_id||""),n.dataset.newsTitle=String(t?.display_title||t?.title||"");let s=document.createElement("div");s.className="news-item-content";let i=document.createElement("input");i.type="checkbox",i.className="news-checkbox",i.title="\u6807\u8BB0\u5DF2\u8BFB",i.addEventListener("change",()=>{try{window.markAsRead(i)}catch{}});let a=document.createElement("span");a.className="news-index",a.textContent=String(e);let o=document.createElement("a");if(o.className="news-title",t?.is_cross_platform&&o.classList.add("cross-platform"),o.href=String(t?.url||"#"),o.target="_blank",o.rel="noopener noreferrer",o.setAttribute("onclick","handleTitleClickV2(this, event)"),o.setAttribute("onauxclick","handleTitleClickV2(this, event)"),o.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),o.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),o.textContent=String(t?.display_title||t?.title||""),t?.is_cross_platform){let f=Array.isArray(t?.cross_platforms)?t.cross_platforms:[],m=document.createElement("span");m.className="cross-platform-badge",m.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${f.join(", ")}`,m.textContent=`\u{1F525} ${String(t?.cross_platform_count??"")}`,o.appendChild(document.createTextNode(" ")),o.appendChild(m)}s.appendChild(i),s.appendChild(a),s.appendChild(o);let l=dt(t?.timestamp);if(l){let f=document.createElement("span");f.className="tr-news-date",f.style.marginLeft="8px",f.style.color="#9ca3af",f.style.fontSize="12px",f.style.whiteSpace="nowrap",f.textContent=l,s.appendChild(f)}n.appendChild(s);let d=String(t?.meta||"").trim(),u=String(r||"").startsWith("rss-");if(d&&!u){let f=document.createElement("div");f.className="news-subtitle",f.textContent=d,n.appendChild(f)}try{let f=c.readState?.getReadNews?.()||{};n.dataset.newsId&&f[n.dataset.newsId]&&(n.classList.add("read"),i.checked=!0)}catch{}return n}async function ii(t){if(!t||!(t instanceof Element)||String(t?.dataset?.lazy||"")!=="1"||String(t?.dataset?.loading||"")==="1")return;let e=t.closest(".tab-pane");if(!e||!e.classList.contains("active"))return;let r=String(t.dataset.platform||"").trim();if(r){t.dataset.loading="1";try{let n=`/api/news/page?platform_id=${encodeURIComponent(r)}&offset=0&page_size=${encodeURIComponent(String(ne))}`,s=await fetch(n);if(!s.ok)return;let i=await s.json(),a=Array.isArray(i?.items)?i.items:[],o=t.querySelector(".news-list");if(!o)return;o.querySelectorAll(".tr-news-skeleton").forEach(u=>u.remove()),o.querySelectorAll(".news-placeholder").forEach(u=>u.remove()),o.querySelectorAll(".news-item").forEach(u=>u.remove());let l=a.slice(0,ne);for(let u=0;u<l.length;u++)o.appendChild(oi(l[u],u+1,r));let d=o.querySelectorAll(".news-item").length;t.dataset.loadedCount=String(d),t.dataset.hasMore="0",t.dataset.loadedDone="1",t.dataset.lazy="0";try{c.paging&&(c.paging.setCardPageSize(t,Math.min(ne,Math.max(1,d||ne))),c.paging.applyPagingToCard(t,0))}catch{}try{c.counts?.updatePlatformCount&&c.counts.updatePlatformCount(t),c.counts?.updateAllCounts&&c.counts.updateAllCounts()}catch{}try{c.search?.searchNews?.()}catch{}try{let u=c.tabs?.getActiveTabId?.()||null;u&&c.filter?.applyCategoryFilter?.(u)}catch{}}catch{}finally{t.dataset.loading="0"}}}function zn(){try{ee&&(ee.disconnect(),ee=null)}catch{}ee=new IntersectionObserver(t=>{for(let e of t){if(!e.isIntersecting)continue;let r=e.target;if(!(!r||!(r instanceof Element))){if(String(r?.dataset?.lazy||"")!=="1"){try{ee?.unobserve?.(r)}catch{}continue}ii(r).catch(()=>{})}}},{root:null,rootMargin:"0px 200px 0px 200px",threshold:.15}),document.querySelectorAll('.platform-card[data-lazy="1"]').forEach(t=>{try{ee.observe(t)}catch{}})}var re=null,Bt=null;function Yn(t,e,r){return new Promise(n=>{if(Bt)try{Bt(!1)}catch{}if(Bt=n,!re){let s=document.createElement("div");s.className="tr-confirm-overlay",s.innerHTML=`
                <div class="tr-confirm-modal" role="dialog" aria-modal="true">
                    <div class="tr-confirm-message"></div>
                    <div class="tr-confirm-actions">
                        <button type="button" class="tr-confirm-btn tr-confirm-cancel" data-action="cancel"></button>
                        <button type="button" class="tr-confirm-btn tr-confirm-ok" data-action="ok"></button>
                    </div>
                </div>`,s.addEventListener("click",i=>{let a=i?.target;if(!a||!(a instanceof Element))return;let o=a.closest('button[data-action="ok"]'),l=a.closest('button[data-action="cancel"]');if(o){i.preventDefault(),s.classList.remove("show");let d=Bt;Bt=null,d?.(!0);return}if(l||a===s){i.preventDefault(),s.classList.remove("show");let d=Bt;Bt=null,d?.(!1)}}),document.body.appendChild(s),re=s}try{let s=re.querySelector(".tr-confirm-message");s&&(s.textContent=String(t||""));let i=re.querySelector('button[data-action="ok"]');i&&(i.textContent=String(e||"\u786E\u8BA4"));let a=re.querySelector('button[data-action="cancel"]');a&&(a.textContent=String(r||"\u53D6\u6D88"))}catch{}re.classList.add("show")})}async function ai(t){let e=String(t||"").trim();if(!e)return!1;try{let r=await fetch("/api/me/rss-subscriptions",{method:"GET"});if(!r.ok)return!1;let n=await r.json().catch(()=>({}));return!(Array.isArray(n?.subscriptions)?n.subscriptions:[]).some(a=>String(a?.source_id||a?.rss_source_id||"").trim()===e)}catch{return!1}}async function ci(t){let e=String(t||"").trim();if(!e.startsWith("rss-"))return!1;let r=e.slice(4);if(!r||!c.subscription)return!1;try{c.subscription.ensureSnapshot?.()}catch{}let n=[];try{n=c.subscription.getSubscriptions?c.subscription.getSubscriptions():[]}catch{n=[]}let s=(Array.isArray(n)?n:[]).filter(i=>String(i?.source_id||i?.rss_source_id||"").trim()!==r);try{c.subscription.setSubscriptions?.(s)}catch{return!1}try{c.subscription.saveOnly?await c.subscription.saveOnly():c.subscription.saveAndRefresh&&await c.subscription.saveAndRefresh()}catch{return!1}return await ai(r)}async function li(t){if(!t||!(t instanceof Element))return;let e=ri(t),r=String(t.getAttribute("data-platform")||"").trim();if(!e||!r||e==="explore"||!r.startsWith("rss-"))return;try{let o=!0;try{new URLSearchParams(window.location.search).get("e2e")==="1"&&(o=!1)}catch{}try{typeof navigator<"u"&&navigator.webdriver===!0&&(o=!1)}catch{}if(o&&!await Yn("\u786E\u5B9A\u8981\u5220\u9664\u8BE5 RSS \u5361\u7247\u5417\uFF1F\u5220\u9664\u540E\u5C06\u53D6\u6D88\u8BA2\u9605\u3002","\u786E\u8BA4\u5220\u9664","\u53D6\u6D88"))return}catch{}try{let o=t.querySelector('button[data-action="delete-platform"]');o&&o.setAttribute("disabled","true")}catch{}let s=t.parentNode,i=t.nextSibling;try{s&&s.removeChild(t)}catch{}try{c.counts?.updateAllCounts?.()}catch{}if(!await ci(r)){try{s&&(i?s.insertBefore(t,i):s.appendChild(t))}catch{}try{let o=t.querySelector('button[data-action="delete-platform"]');o&&o.removeAttribute("disabled")}catch{}try{c.toast?.show?.("\u5220\u9664\u5931\u8D25\uFF1A\u8BA2\u9605\u672A\u80FD\u4ECE\u670D\u52A1\u7AEF\u79FB\u9664\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"error",durationMs:2500})}catch{}return}try{c.counts?.updateAllCounts?.(),c.readState?.updateReadCount?.()}catch{}}var Ze={formatUpdatedAt:_e,snapshotViewerState(){let t=R.getRaw(Rr)||document.querySelector(".category-tab.active")?.dataset?.category||null,e={};document.querySelectorAll(".platform-card").forEach(a=>{let o=a.dataset.platform;o&&(e[o]=parseInt(a.dataset.pageOffset||"0",10)||0)});let r=t?document.querySelector(`#tab-${t} .platform-grid`):null,n=r&&r.scrollLeft||0,s=null,i=0;if(r){let a=r.scrollLeft||0,o=null,l=r.querySelectorAll(".platform-card");for(let d of l)if((d.offsetLeft||0)<=a+1)o=d;else break;o?.dataset?.platform&&(s=o.dataset.platform,i=Math.max(0,a-(o.offsetLeft||0)))}return t&&r&&c.scroll.recordPlatformGridScrollForTab(t,r),{activeTab:t,pagingOffsets:e,activeTabPlatformGridScrollLeft:n,activeTabPlatformAnchorPlatformId:s,activeTabPlatformAnchorOffsetX:i,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(t,e){let r=document.querySelector(".tab-content-area"),n=document.querySelector(".category-tabs");if(!n||!r)return;let s="";try{let b=document.getElementById("tab-knowledge"),E=b?b.querySelector(".platform-grid"):null,x=!!(E&&E.querySelector(".tr-morning-brief-card")),F=!!(E&&E.querySelector(".news-item"));x&&F&&(s=String(E.innerHTML||""))}catch{s=""}let i=c.settings.applyCategoryConfigToData(t?.categories||{});ei=i;let a=e&&typeof e.activeTab=="string"?e.activeTab:null,o=(()=>{try{return new URLSearchParams(window.location.search).get("e2e")==="1"}catch{return!1}})(),l=Object.keys(i||{}),d=l[0]||null;d==="explore"&&(d=l.find(b=>b!=="explore")||d),o&&d==="rsscol-rss"&&(d=l.find(b=>b!=="rsscol-rss")||d);let u=a||d;u==="explore"&&(u=l.find(b=>b!=="explore")||u),o&&u==="rsscol-rss"&&(u=l.find(b=>b!=="rsscol-rss")||u);let f=Object.entries(i).map(([b,E])=>{let x=h(E?.icon||""),F=h(E?.name||b),j=`${E?.is_new?`<span class="new-badge new-badge-category" data-category="${h(b)}">NEW</span>`:""}${b==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab${String(b)===String(u)?" active":""}" data-category="${h(b)}" draggable="false" onclick="switchTab('${h(b)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${x}</div>
                <div class="category-tab-name">${F}${j}</div>
            </div>`}).join(""),m=Object.entries(i).map(([b,E])=>{let x=!!u&&String(b)===String(u),F=x?" active":"";if(String(b)==="rsscol-rss")return`
                <div class="tab-pane${F}" id="tab-${h(b)}">
                    <div class="platform-grid" style="display:flex;flex-direction:column;gap:10px;min-height:0;">
                        
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <div id="rssCategoryCarouselStatus" style="color:#6b7280;font-size:0.85rem;flex:1;min-width:200px;"></div>
                    </div>
                        <div id="rssCategoryCarouselGrid" style="display:flex;flex-direction:column;gap:10px;min-height:0;"></div>
                    </div>
                    <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
                </div>`;if(String(b)==="explore")return`
                <div class="tab-pane${F}" id="tab-${h(b)}">
                    <div class="platform-grid" id="trExploreGrid"></div>
                </div>`;if(String(b)==="knowledge"){let g=s||`
                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-1" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u{1F552} \u6700\u65B0 1-50</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice1">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>

                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-2" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u2B50 \u6700\u65B0 51-100</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice2">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>

                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-3" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u{1F9FE} \u6700\u65B0 101-150</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice3">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>
                `;return`
                <div class="tab-pane${F}" id="tab-${h(b)}">
                    <div class="platform-grid" data-mb-injected="1">${g}</div>
                </div>`}let X=E?.platforms||{},I=Object.keys(X||{}),j=x&&e?.activeTabPlatformAnchorPlatformId||null,wt=j?I.indexOf(j):-1,_=3,L=I.map((g,S)=>{let v=X?.[g];if(!v)return"";let C=h(v?.name||g),k=v?.is_new?`<span class="new-badge new-badge-platform" data-platform="${h(g)}">NEW</span>`:"",P=Array.isArray(v?.news)?v.news:[],$=P.length,Y=x&&(wt<0?S<3:S>=wt-_&&S<=wt+_),z=!Y,et=Y?Math.min($,ne):0,J=g&&e?.pagingOffsets&&Number.isFinite(e.pagingOffsets[g])?e.pagingOffsets[g]:0,St=P.slice(0,et),xr=z?si(8):St.map((lt,Er)=>{let xo=h(lt?.stable_id||""),bn=h(lt?.display_title||lt?.title||""),Eo=h(lt?.url||""),vn=h(lt?.meta||""),Ao=String(g||"").startsWith("rss-"),_n=!!lt?.is_cross_platform,To=Array.isArray(lt?.cross_platforms)?lt.cross_platforms:[],Lo=h(To.join(", ")),ko=h(lt?.cross_platform_count??""),Ro=_n?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${Lo}">\u{1F525} ${ko}</span>`:"",Po=_n?"cross-platform":"",Mo='<input type="checkbox" class="news-checkbox" title="\u6807\u8BB0\u5DF2\u8BFB" onchange="markAsRead(this)" />',Io=`<span class="news-index">${String(Er+1)}</span>`,No=Er<J||Er>=J+ne?" paged-hidden":"",$o=vn&&!Ao?`<div class="news-subtitle">${vn}</div>`:"",Oo=Eo||"#",Cn=dt(lt?.timestamp),Do=Cn?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${h(Cn)}</span>`:"";return`
                        <li class="news-item${No}" data-news-id="${xo}" data-news-title="${bn}">
                            <div class="news-item-content">
                                ${Mo}
                                ${Io}
                                <a class="news-title ${Po}" href="${Oo}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${bn}
                                    ${Ro}
                                </a>
                                ${Do}
                            </div>
                            ${$o}
                        </li>`}).join(""),Ve=ni(b,g);return`
                <div class="platform-card" data-platform="${h(g)}" data-total-count="${String($)}" data-loaded-count="${String(et)}" data-lazy="${z?"1":"0"}" data-loaded-done="${z?"0":"1"}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${h(g)}')">\u{1F4F1} ${C}${k}</div>
                        <div class="platform-header-actions">${Ve}</div>
                    </div>
                    <ul class="news-list">${xr}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).filter(Boolean).join("");return`
            <div class="tab-pane${F}" id="tab-${h(b)}">
                <div class="platform-grid">${L}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");n.innerHTML=f,r.innerHTML=m;try{let b=!!window.matchMedia&&window.matchMedia("(max-width: 640px)").matches,E=n.querySelectorAll(".category-tab").length;b?n.classList.remove("compact"):n.classList.toggle("compact",E>8)}catch{}let p=document.getElementById("updatedAt");p&&t?.updated_at&&(p.textContent=_e(t.updated_at));let w=e&&typeof e.activeTab=="string"?e.activeTab:null;if(w){let b=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(w):w;if(document.querySelector(`.category-tab[data-category="${b}"]`))c.tabs.switchTab(w);else{let x=document.querySelector(".category-tab");x?.dataset?.category?c.tabs.switchTab(x.dataset.category):R.remove(Rr)}}else{let b=document.querySelector(".category-tab");b?.dataset?.category?c.tabs.switchTab(b.dataset.category):R.remove(Rr)}let T=typeof e?.showReadMode=="boolean"?e.showReadMode:c.readState.getShowReadModePref();c.readState.applyShowReadMode(T);let y=document.getElementById("searchInput");y&&typeof e?.searchText=="string"&&(y.value=e.searchText),c.search.searchNews(),c.filter.applyCategoryFilterForActiveTab(),c.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(b=>{let E=b.dataset.platform,x=E&&e?.pagingOffsets&&Number.isFinite(e.pagingOffsets[E])?e.pagingOffsets[E]:0;c.paging.setCardPageSize(b,c.paging.PAGE_SIZE),c.paging.applyPagingToCard(b,x)}),c.counts.updateAllCounts(),c.readState.updateReadCount(),c.scroll.restoreActiveTabPlatformGridScroll(e),c.scroll.attachPlatformGridScrollPersistence();let A=document.getElementById("early-hide");A&&A.remove(),document.body.classList.add("categories-ready"),c.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1}),zn();try{c.infiniteScroll&&typeof c.infiniteScroll.attach=="function"&&c.infiniteScroll.attach()}catch{}},async refreshViewerData(t={}){let e=t.preserveScroll!==!1;if(Pr){te?te.preserveScroll=te.preserveScroll&&e:te={preserveScroll:e};return}Pr=!0;try{let r=this.snapshotViewerState();r.preserveScroll=e;let s=await(await fetch("/api/news")).json();this.renderViewerFromData(s,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),c.scroll.restoreActiveTabPlatformGridScroll(r)),ti=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{Pr=!1;let r=te;te=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let t=document.getElementById("fetchBtn"),e=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),n=document.getElementById("fetchStatus");t.classList.add("loading"),t.disabled=!0,e.classList.add("show"),r.classList.add("indeterminate"),n.className="fetch-status",n.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let i=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),i.success?(r.style.width="100%",n.className="fetch-status success",n.textContent=`\u2705 ${i.platforms} \u4E2A\u5E73\u53F0\uFF0C${i.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${i.error}`)}catch(s){r.classList.remove("indeterminate"),r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${s.message}`}finally{t.classList.remove("loading"),t.disabled=!1,setTimeout(()=>{e.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){let e=async()=>{if(document.visibilityState==="visible")try{let r=await fetch("/api/news/check-updates");if(!r.ok)return;let n=await r.json();if(n.categories)for(let[s,i]of Object.entries(n.categories))i&&this.showCategoryUpdateDot(s)}catch{}};setInterval(e,3e5),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&setTimeout(e,2e3)})},showCategoryUpdateDot(t){let e=document.querySelector(`.category-tab[data-category="${t}"]`);if(!e)return;let r=e.querySelector(".update-dot");r||(r=document.createElement("span"),r.className="update-dot",e.style.position="relative",e.appendChild(r)),r.classList.add("show")},hideCategoryUpdateDot(t){let e=document.querySelector(`.category-tab[data-category="${t}"]`);if(!e)return;let r=e.querySelector(".update-dot");r&&r.classList.remove("show")}};window.fetchData=()=>Ze.fetchData();window.refreshViewerData=t=>Ze.refreshViewerData(t);c.data=Ze;N(function(){let t=document.getElementById("updatedAt");t&&t.textContent&&(t.textContent=_e(t.textContent)),Ze.setupAjaxAutoRefresh(),jn||(jn=!0,document.addEventListener("click",e=>{let r=e?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="delete-platform"]');if(!n)return;let s=n.closest(".platform-card");s&&li(s).catch(()=>{})}),document.addEventListener("click",async e=>{let r=e?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="hide-platform"]');if(!n)return;let s=n.closest(".platform-card"),i=String(s?.getAttribute?.("data-platform")||"").trim();if(!(!i||i.startsWith("rss-")||!await Yn("\u786E\u5B9A\u8981\u9690\u85CF\u8BE5\u5361\u7247\u5417\uFF1F\u9690\u85CF\u540E\u8BE5\u5361\u7247\u5C06\u4E0D\u518D\u663E\u793A\uFF0C\u4F60\u53EF\u4EE5\u5728\u300C\u680F\u76EE\u8BBE\u7F6E\u300D\u4E2D\u91CD\u65B0\u52FE\u9009\u5E76\u4FDD\u5B58\u6765\u6062\u590D\u663E\u793A\u3002","\u786E\u8BA4\u9690\u85CF","\u53D6\u6D88"))){try{n.setAttribute("disabled","true")}catch{}try{c.settings?.togglePlatformHidden?.(i)}catch{}}})),zn()});var Qe=window.SYSTEM_SETTINGS?.display?.items_per_card||20,di="240px 0px 240px 0px",rt=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Ae=null,Mr=!1,Te=0,ui=1,Vn=0,fi=600,tr=null,Le=null,mi=160,er=null,ke=null,gi=250;function pi(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}function Ir(t,e){try{let r=t?.querySelector?.(".news-list");if(!r)return;let n=r.querySelector(".news-placeholder");n||(n=document.createElement("li"),n.className="news-placeholder",n.setAttribute("aria-hidden","true"),r.appendChild(n)),n.textContent=String(e||"")}catch{}}function Wn(){if(clearTimeout(tr),tr=null,Le){try{Le.abort()}catch{}Le=null}try{document.querySelectorAll(".platform-card").forEach(t=>{let e=t?.querySelector?.(".news-list");if(!e)return;let r=e.querySelector(".news-placeholder");!r||e.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function hi(t,e={}){Wn(),Le=new AbortController;let r=Le.signal;tr=setTimeout(()=>{tr=null,Kn(t,{...e,signal:r}).catch(()=>{})},mi)}function Xn(){if(clearTimeout(er),er=null,ke){try{ke.abort()}catch{}ke=null}}function yi(t,e,r){let n=document.createElement("li");n.className="news-item",n.dataset.newsId=String(t?.stable_id||""),n.dataset.newsTitle=String(t?.display_title||t?.title||"");let s=document.createElement("div");s.className="news-item-content";let i=document.createElement("input");i.type="checkbox",i.className="news-checkbox",i.title="\u6807\u8BB0\u5DF2\u8BFB",i.addEventListener("change",()=>{try{window.markAsRead(i)}catch{}});let a=document.createElement("span");a.className="news-index",a.textContent=String(e);let o=document.createElement("a");if(o.className="news-title",t?.is_cross_platform&&o.classList.add("cross-platform"),o.href=String(t?.url||"#"),o.target="_blank",o.rel="noopener noreferrer",o.setAttribute("onclick","handleTitleClickV2(this, event)"),o.setAttribute("onauxclick","handleTitleClickV2(this, event)"),o.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),o.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),o.textContent=String(t?.display_title||t?.title||""),t?.is_cross_platform){let f=Array.isArray(t?.cross_platforms)?t.cross_platforms:[],m=document.createElement("span");m.className="cross-platform-badge",m.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${f.join(", ")}`,m.textContent=`\u{1F525} ${String(t?.cross_platform_count??"")}`,o.appendChild(document.createTextNode(" ")),o.appendChild(m)}s.appendChild(i),s.appendChild(a),s.appendChild(o);let l=dt(t?.timestamp);if(l){let f=document.createElement("span");f.className="tr-news-date",f.style.marginLeft="8px",f.style.color="#9ca3af",f.style.fontSize="12px",f.style.whiteSpace="nowrap",f.textContent=l,s.appendChild(f)}n.appendChild(s);let d=String(t?.meta||"").trim(),u=String(r||"").startsWith("rss-");if(d&&!u){let f=document.createElement("div");f.className="news-subtitle",f.textContent=d,n.appendChild(f)}return Zn(n),Jn(n),n}async function Un(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let n=e.signal;if(n?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let s=null;try{c.filter&&typeof c.filter.getCategoryFilterConfig=="function"&&(s=c.filter.getCategoryFilterConfig(t))}catch{s=null}let i=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],o=Number.isFinite(e.pageSize)?e.pageSize:rt,l=Math.min(Math.max(1,o),rt),d=Array.from(r.querySelectorAll(".platform-card")),u=d.map(p=>(p?.dataset?.platform||"").trim()).filter(Boolean);if(u.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let p of d)p&&(p.dataset.loading="1",Ir(p,"\u52A0\u8F7D\u4E2D..."));let f;try{let p=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(l))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:u}),signal:n});if(!p.ok)return;f=await p.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let m=f&&f.platforms||{};for(let p of d){if(n?.aborted)return;let w=(p?.dataset?.platform||"").trim();if(!w)continue;let T=p.querySelector(".news-list");if(!T)continue;T.querySelectorAll(".news-placeholder").forEach(E=>E.remove()),T.querySelectorAll(".news-item").forEach(E=>E.remove());let y=m[w]||{},A=Array.isArray(y.items)?y.items:[];for(let E=0;E<A.length;E++)T.appendChild(yi(A[E],E+1,w));let b=T.querySelectorAll(".news-item").length;p.dataset.loadedCount=String(b),p.dataset.hasMore=y.has_more&&b<rt?"1":"0",p.dataset.loading="0",p.dataset.loadedDone="1";try{if(c.paging){let E=Math.min(rt,b);c.paging.setCardPageSize(p,E),c.paging.applyPagingToCard(p,0)}}catch{}c.counts?.updatePlatformCount&&c.counts.updatePlatformCount(p)}c.counts?.updateAllCounts&&c.counts.updateAllCounts();try{c.filter&&typeof c.filter.applyCategoryFilter=="function"&&c.filter.applyCategoryFilter(t)}catch{}}function wi(t,e={}){Xn(),ke=new AbortController;let r=ke.signal;er=setTimeout(()=>{er=null,Un(t,{...e,signal:r}).catch(()=>{})},gi)}async function Kn(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r||!r.classList.contains("active"))return;let n=e.signal;if(n?.aborted)return;let s=null;try{c.filter&&typeof c.filter.getCategoryFilterConfig=="function"&&(s=c.filter.getCategoryFilterConfig(t))}catch{s=null}let i=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],o=i==="include"&&a.length>0,l=Number.isFinite(e.maxPagesPerCard)?e.maxPagesPerCard:o?2:1,d=Number.isFinite(e.cap)?e.cap:o?10:4,u=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,d));for(let f of u){if(n?.aborted)return;if(!f)continue;let m=f.querySelector(".news-list");if(!m)continue;let p=m.querySelectorAll(".news-item").length;if(o&&p>0){f.dataset.loadedDone="1";continue}if(!o&&p>0){f.dataset.loadedDone="1";continue}let w=Qe;for(let T=0;T<l;T++){if(n?.aborted)return;Ir(f,"\u52A0\u8F7D\u4E2D..."),await Qn(f,Math.min(w,rt),{signal:n});try{c.paging&&(c.paging.setCardPageSize(f,Math.min(w,rt)),c.paging.applyPagingToCard(f,0))}catch{}let y=f.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!o||y>0||!(f.dataset.hasMore!=="0"))break;w+=Qe}f.dataset.loadedDone="1"}c.counts?.updateAllCounts&&c.counts.updateAllCounts();try{c.filter&&typeof c.filter.applyCategoryFilter=="function"&&c.filter.applyCategoryFilter(t)}catch{}}function Jn(t){try{let e=pi();if(!e||!c.filter?.getCategoryFilterConfig)return;let r=c.filter.getCategoryFilterConfig(e),n=r?.mode||"exclude",s=Array.isArray(r?.keywords)?r.keywords:[],i=(t?.textContent||"").toLowerCase(),a=s.length>0?s.some(l=>i.includes(l)):!1;(s.length===0?!1:n==="include"?!a:a)?t.classList.add("filtered"):t.classList.remove("filtered")}catch{}}function Zn(t){try{let e=t?.dataset?.newsId;if(!e||!c.readState?.getReadNews||!(c.readState.getReadNews()||{})[e])return;t.classList.add("read")}catch{}}async function Qn(t,e,r={}){let n=(t?.dataset?.platform||"").trim();if(!n)return{ok:!1,hasMore:!1};let s=r.signal;if(s?.aborted)return{ok:!1,hasMore:!0};if(t.dataset.loading==="1")return{ok:!1,hasMore:!0};if(t.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let i=t.querySelector(".news-list");if(!i)return{ok:!1,hasMore:!1};i.querySelectorAll(".news-placeholder").forEach(o=>o.remove()),e=Math.min(Math.max(0,e||0),rt);let a=i.querySelectorAll(".news-item").length;if(a>=rt)return t.dataset.hasMore="0",{ok:!1,hasMore:!1};if(a>=e)return{ok:!0,hasMore:!0};t.dataset.loading="1";try{if(Te>=ui)return{ok:!1,hasMore:!0};Te+=1;let o=Math.min(Qe,Math.max(0,rt-a));if(o<=0)return t.dataset.hasMore="0",{ok:!1,hasMore:!1};let l=`/api/news/page?platform_id=${encodeURIComponent(n)}&offset=${encodeURIComponent(String(a))}&page_size=${encodeURIComponent(String(o))}`,d;try{d=await fetch(l,{signal:s})}catch(p){if(s?.aborted||p&&p.name==="AbortError")return t.querySelectorAll(".news-item").length<=0&&Ir(t,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw p}if(!d.ok)return{ok:!1,hasMore:!0};let u=await d.json(),f=Array.isArray(u?.items)?u.items:[],m=!!u?.has_more;(!m||a+f.length>=rt)&&(t.dataset.hasMore="0");for(let p=0;p<f.length;p++){let w=f[p]||{},T=a+p+1,y=document.createElement("li");y.className="news-item",y.dataset.newsId=String(w.stable_id||""),y.dataset.newsTitle=String(w.display_title||w.title||"");let A=document.createElement("div");A.className="news-item-content";let b=document.createElement("input");b.type="checkbox",b.className="news-checkbox",b.title="\u6807\u8BB0\u5DF2\u8BFB",b.addEventListener("change",()=>{try{window.markAsRead(b)}catch{}});let E=document.createElement("span");E.className="news-index",E.textContent=String(T);let x=document.createElement("a");if(x.className="news-title",w.is_cross_platform&&x.classList.add("cross-platform"),x.href=String(w.url||"#"),x.target="_blank",x.rel="noopener noreferrer",x.setAttribute("onclick","handleTitleClickV2(this, event)"),x.setAttribute("onauxclick","handleTitleClickV2(this, event)"),x.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),x.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),x.textContent=String(w.display_title||w.title||""),w.is_cross_platform){let I=Array.isArray(w.cross_platforms)?w.cross_platforms:[],j=document.createElement("span");j.className="cross-platform-badge",j.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${I.join(", ")}`,j.textContent=`\u{1F525} ${String(w.cross_platform_count??"")}`,x.appendChild(document.createTextNode(" ")),x.appendChild(j)}A.appendChild(b),A.appendChild(E),A.appendChild(x);let F=dt(w.timestamp);if(F){let I=document.createElement("span");I.className="tr-news-date",I.style.marginLeft="8px",I.style.color="#9ca3af",I.style.fontSize="12px",I.style.whiteSpace="nowrap",I.textContent=F,A.appendChild(I)}y.appendChild(A);let X=String(w.meta||"").trim();if(X){let I=document.createElement("div");I.className="news-subtitle",I.textContent=X,y.appendChild(I)}i.appendChild(y),Zn(y),Jn(y)}return t.dataset.loadedCount=String(i.querySelectorAll(".news-item").length),c.counts?.updatePlatformCount&&c.counts.updatePlatformCount(t),{ok:!0,hasMore:m}}finally{Te=Math.max(0,Te-1),t.dataset.loading="0"}}async function Si(t){if(!t||!c.paging)return;let e=t.closest(".tab-pane");if(e&&!e.classList.contains("active"))return;let r=Date.now();if(r<Vn)return;Vn=r+fi;let n=parseInt(t.dataset.pageOffset||"0",10)||0,s=c.paging.getCardPageSize(t),i=Math.max(0,rt-n);if(s>=i){t.dataset.hasMore="0";return}let a=Math.min(s+Qe,i),o=n+a;await Qn(t,o);let l=t.querySelectorAll(".news-item").length,d=Math.min(Math.max(s,a),Math.max(l-n,s)),u=Math.min(d,i);c.paging.setCardPageSize(t,u),c.paging.applyPagingToCard(t,n),c.counts?.updateAllCounts&&c.counts.updateAllCounts()}function ts(){if(Ae){try{Ae.disconnect()}catch{}Ae=null}Ae=new IntersectionObserver(t=>{for(let e of t){if(!e.isIntersecting||!Mr||Te>0)continue;let n=e.target?.closest?.(".platform-card");n&&Si(n).catch(()=>{})}},{root:null,rootMargin:di,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(t=>Ae.observe(t))}c.infiniteScroll={attach:ts,ensureCategoryLoaded:Kn,scheduleEnsureCategoryLoaded:hi,cancelEnsureCategoryLoaded:Wn,bulkLoadCategory:Un,scheduleBulkLoadCategory:wi,cancelBulkLoadCategory:Xn};N(function(){try{window.addEventListener("scroll",()=>{Mr=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{Mr=!0},1200),ts()});function es(t){let r=t?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function bi(t,e,r){let n=Array.from(t.querySelectorAll(".platform-card:not(.dragging):not(.platform-card-placeholder)")),s=null,i=1/0;for(let a of n){let o=a.getBoundingClientRect(),l=o.left+o.width/2,d=o.top+o.height/2,u=e-l,f=r-d,m=u*u+f*f;m<i&&(i=m,s={card:a,rect:o,cx:l,cy:d})}return s}function rs(t,e){if(!t||!Array.isArray(e))return;let r=c.settings.getCategoryConfig()||c.settings.getDefaultCategoryConfig(),n=c.settings.normalizeCategoryConfig(r);if((c.settings.getMergedCategoryConfig().customCategories||[]).find(a=>a.id===t)){let a=(n.customCategories||[]).findIndex(o=>o.id===t);a>=0&&(n.customCategories[a]={...n.customCategories[a],platforms:e})}else(!n.platformOrder||typeof n.platformOrder!="object")&&(n.platformOrder={}),n.platformOrder[t]=e;c.settings.saveCategoryConfig(n)}var ns={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_pointerId:null,_ghostEl:null,_placeholderEl:null,_ghostRaf:null,_ghostClientX:0,_ghostClientY:0,_ghostOffsetX:0,_ghostOffsetY:0,_prevUserSelect:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,_reorderRaf:null,_reorderGrid:null,_reorderX:0,_reorderY:0,_reorderOverCard:null,attach(){if(this._attached)return;this._attached=!0;let t=80,e=35,r=1400,n=5200,s=5200,i=null,a=null,o=null,l=()=>{i||a||(i=document.createElement("div"),i.className="tr-drag-edge-arrow tr-drag-edge-arrow-left",i.innerHTML="\u25C0",i.style.cssText=`
                position: fixed;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 60px;
                height: 120px;
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.9) 0%, rgba(99, 102, 241, 0.3) 100%);
                color: white;
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                border-radius: 0 12px 12px 0;
                pointer-events: all;
                transition: background 0.2s;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            `,i.style.opacity="0.25",a=document.createElement("div"),a.className="tr-drag-edge-arrow tr-drag-edge-arrow-right",a.innerHTML="\u25B6",a.style.cssText=`
                position: fixed;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 60px;
                height: 120px;
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.9) 100%);
                color: white;
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                border-radius: 12px 0 0 12px;
                pointer-events: all;
                transition: background 0.2s;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            `,a.style.opacity="0.25",document.body.appendChild(i),document.body.appendChild(a))},d=()=>{i&&(i.remove(),i=null),a&&(a.remove(),a=null),o&&(cancelAnimationFrame(o),o=null)},u=(_,L)=>{o&&cancelAnimationFrame(o);let g=0,S=0,v=C=>{if(!L)return;g||(g=C),S||(S=C);let k=Math.max(0,C-S);S=C;let P=Math.max(0,C-g),$=Math.min(n,r+P/1e3*s),Y=Math.max(0,(L.scrollWidth||0)-(L.clientWidth||0)),z=_*$*(k/1e3),et=Math.max(0,Math.min(Y,(L.scrollLeft||0)+z));L.scrollLeft=et,o=requestAnimationFrame(v)};o=requestAnimationFrame(v)},f=()=>{o&&(cancelAnimationFrame(o),o=null)},m=(_,L)=>{i&&(i.style.opacity=_?"1":"0.25"),a&&(a.style.opacity=L?"1":"0.25")},p=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},w=()=>{this._ghostRaf&&cancelAnimationFrame(this._ghostRaf),this._ghostRaf=null},T=(_,L)=>{this._ghostClientX=_,this._ghostClientY=L,!this._ghostRaf&&(this._ghostRaf=requestAnimationFrame(()=>{if(this._ghostRaf=null,!this._ghostEl)return;let g=this._ghostClientX-this._ghostOffsetX,S=this._ghostClientY-this._ghostOffsetY;this._ghostEl.style.transform=`translate3d(${g}px, ${S}px, 0)`}))},y=()=>{if(this._autoScrollRaf)return;let _=0,L=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){p();return}let g=this._autoScrollGrid,S=Math.max(0,(g.scrollWidth||0)-(g.clientWidth||0));if(S<=0){p();return}let v=performance.now();_||(_=v);let C=Math.max(0,v-_);_=v;let k=this._autoScrollSpeed*(C/16.6667),P=Math.max(0,Math.min(S,(g.scrollLeft||0)+this._autoScrollDir*k));g.scrollLeft=P,this._autoScrollRaf=requestAnimationFrame(L)};this._autoScrollRaf=requestAnimationFrame(L)},A=(_,L)=>{if(!this._draggingCard||!L)return p(),m(!1,!1),f(),"none";let g=_.clientX;if(i&&a){let et=i.getBoundingClientRect(),J=a.getBoundingClientRect();if(g>=et.left&&g<=et.right)return m(!0,!1),p(),u(-1,L),"arrow";if(g>=J.left&&g<=J.right)return m(!1,!0),p(),u(1,L),"arrow";f()}if(Math.max(0,(L.scrollWidth||0)-(L.clientWidth||0))<=0)return p(),m(!1,!1),"none";let v=L.getBoundingClientRect(),C=g-v.left,k=v.right-g,P=0,$=0;if(C>=0&&C<=t)P=-1,$=C;else if(k>=0&&k<=t)P=1,$=k;else return m(!1,!1),p(),"none";m(P===-1,P===1);let Y=Math.max(0,Math.min(1,(t-$)/t)),z=Math.max(1,Math.round(Y*Y*e));return this._autoScrollGrid=L,this._autoScrollDir=P,this._autoScrollSpeed=z,y(),"edge"},b=()=>{this._reorderRaf&&cancelAnimationFrame(this._reorderRaf),this._reorderRaf=null,this._reorderGrid=null,this._reorderOverCard=null},E=()=>{if(this._reorderRaf)return;let _=()=>{this._reorderRaf=null;let L=this._reorderGrid,g=this._placeholderEl||this._draggingCard;if(!L||!g)return;let S=this._reorderOverCard;if((!S||S===g||!L.contains(S)||S.classList?.contains?.("platform-card-placeholder"))&&(S=bi(L,this._reorderX,this._reorderY)?.card||null),!S||S===g)return;let v=S.getBoundingClientRect(),k=this._reorderX<v.left+v.width/2?S:S.nextSibling;k===g||k===g.nextSibling||L.insertBefore(g,k)};this._reorderRaf=requestAnimationFrame(_)},x=(_,L,g)=>{!this._draggingCard||!L||(this._reorderGrid=L,this._reorderX=_.clientX,this._reorderY=_.clientY,this._reorderOverCard=g,E())},F=()=>{this._ghostEl&&(this._ghostEl.remove(),this._ghostEl=null),w(),this._prevUserSelect!=null&&(document.body.style.userSelect=this._prevUserSelect,this._prevUserSelect=null),this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,this._pointerId=null,this._placeholderEl=null,p(),f(),b(),m(!1,!1),d()},X=()=>{let _=this._originGrid,L=this._originCategoryId,g=this._draggingCard,S=this._placeholderEl;if(g&&S&&S.parentNode&&S.replaceWith(g),_&&L){let v=Array.from(_.querySelectorAll(".platform-card")).map(C=>C.dataset.platform).filter(Boolean);rs(L,v)}F()};document.addEventListener("pointerdown",_=>{if(_.button!==0)return;let L=_.target?.closest?.(".platform-drag-handle");if(!L)return;let g=L.closest(".platform-card"),S=L.closest(".platform-grid"),v=es(S),C=g?.dataset?.platform||null;if(!g||!S||!v||!C)return;_.preventDefault(),this._prevUserSelect=document.body.style.userSelect,document.body.style.userSelect="none",L.style.touchAction="none";try{L.setPointerCapture(_.pointerId)}catch{}this._pointerId=_.pointerId,this._draggingCard=g,this._draggingPlatformId=C,this._originGrid=S,this._originCategoryId=v;let k=g.getBoundingClientRect();this._ghostOffsetX=_.clientX-k.left,this._ghostOffsetY=_.clientY-k.top;let P=document.createElement("div");P.className="platform-card platform-card-placeholder",P.style.width=k.width+"px",P.style.height=k.height+"px",P.style.boxSizing="border-box",P.style.border="2px dashed rgba(99, 102, 241, 0.6)",P.style.borderRadius="12px",P.style.background="rgba(99, 102, 241, 0.06)",this._placeholderEl=P,g.parentNode&&g.parentNode.replaceChild(P,g);let $=g.cloneNode(!0);$.classList.add("dragging"),$.style.position="fixed",$.style.left="0",$.style.top="0",$.style.width=k.width+"px",$.style.height=k.height+"px",$.style.margin="0",$.style.zIndex="10001",$.style.pointerEvents="none",$.style.opacity="0.92",$.style.willChange="transform",$.style.transform=`translate3d(${k.left}px, ${k.top}px, 0)`,this._ghostEl=$,document.body.appendChild($),l(),m(!1,!1),g.classList.add("dragging"),T(_.clientX,_.clientY)},!0),document.addEventListener("pointermove",_=>{if(!this._draggingCard||this._pointerId==null||_.pointerId!==this._pointerId)return;_.preventDefault(),T(_.clientX,_.clientY);let L=this._originGrid;if(!L)return;if(A(_,L)!=="none"){b();return}let S=L.getBoundingClientRect();if(!(_.clientX>=S.left&&_.clientX<=S.right&&_.clientY>=S.top&&_.clientY<=S.bottom)){b();return}let k=document.elementFromPoint(_.clientX,_.clientY)?.closest?.(".platform-card");if(k&&k.classList?.contains?.("platform-card-placeholder")){x(_,L,null);return}x(_,L,k)},!0),document.addEventListener("pointerup",_=>{this._pointerId!=null&&_.pointerId===this._pointerId&&(_.preventDefault(),X())},!0),document.addEventListener("pointercancel",_=>{this._pointerId!=null&&_.pointerId===this._pointerId&&(_.preventDefault(),X())},!0),document.addEventListener("dragstart",_=>{_.target?.closest?.(".platform-drag-handle")&&_.preventDefault()},!0);let I=null,j=()=>{I&&I.parentNode&&I.parentNode.removeChild(I),I=null},wt=(_,L,g,S)=>{j(),I=document.createElement("div"),I.className="tr-platform-context-menu",I.innerHTML=`
                <div class="tr-ctx-item" data-action="top">\u2B06\uFE0F \u7F6E\u9876</div>
                <div class="tr-ctx-item" data-action="bottom">\u2B07\uFE0F \u7F6E\u5E95</div>
                <div class="tr-ctx-item" data-action="edit" style="border-top:1px solid #e5e7eb;">\u2699\uFE0F \u7F16\u8F91\u987A\u5E8F</div>
            `,I.style.cssText=`
                position: fixed;
                left: ${_.clientX}px;
                top: ${_.clientY}px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 120px;
                overflow: hidden;
            `;let v=`
                padding: 10px 16px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.15s;
            `;I.querySelectorAll(".tr-ctx-item").forEach(k=>{k.style.cssText=v,k.addEventListener("mouseenter",()=>k.style.background="#f3f4f6"),k.addEventListener("mouseleave",()=>k.style.background="white")}),I.addEventListener("click",k=>{let P=k.target?.dataset?.action;if(!P)return;if(P==="edit"){j(),window.openCategorySettings&&(window.openCategorySettings(),setTimeout(()=>{try{c.settings&&typeof c.settings.editCategory=="function"&&c.settings.editCategory(S)}catch(z){console.error("Failed to edit category:",z)}},100));return}let $=Array.from(g.querySelectorAll(".platform-card"));P==="top"?g.insertBefore(L,$[0]):P==="bottom"&&g.appendChild(L);let Y=Array.from(g.querySelectorAll(".platform-card")).map(z=>z.dataset.platform).filter(Boolean);rs(S,Y),j()}),document.body.appendChild(I);let C=I.getBoundingClientRect();C.right>window.innerWidth&&(I.style.left=window.innerWidth-C.width-8+"px"),C.bottom>window.innerHeight&&(I.style.top=window.innerHeight-C.height-8+"px")};document.addEventListener("click",_=>{I&&!I.contains(_.target)&&j()},!0),document.addEventListener("contextmenu",_=>{let L=_.target?.closest?.(".platform-drag-handle"),g=_.target?.closest?.(".platform-header");if(!L&&!g)return;let S=_.target?.closest?.(".platform-card"),v=_.target?.closest?.(".platform-grid"),C=es(v);!S||!v||!C||C==="explore"||C==="knowledge"||(_.preventDefault(),wt(_,S,v,C))},!0)}};c.platformReorder=ns;N(()=>{ns.attach()});function vi(t){return t?Array.from(t.querySelectorAll(".category-tab")).map(e=>String(e?.dataset?.category||"").trim()).filter(Boolean):[]}function _i(t){if(!Array.isArray(t)||t.length===0)return;let e=c.settings.getCategoryConfig()||c.settings.getDefaultCategoryConfig(),r=c.settings.normalizeCategoryConfig(e),n=c.settings.getMergedCategoryConfig(),s=Array.isArray(n?.categoryOrder)&&n.categoryOrder.length>0?n.categoryOrder.slice():t.slice(),i=new Set(t),a=0,o=s.map(l=>{let d=String(l||"").trim();if(!d||!i.has(d))return d;let u=t[a];return a+=1,u});r.categoryOrder=o,r.__migrated_explore_ai_front_v1=Date.now(),r.__migrated_explore_knowledge_front_v1=Date.now(),c.settings.saveCategoryConfig(r)}function Ci(t){let e=document.querySelector(".tab-content-area");if(!e)return;let r=new Map;e.querySelectorAll(".tab-pane").forEach(s=>{let i=String(s?.id||"");i.startsWith("tab-")&&r.set(i.slice(4),s)});let n=document.createDocumentFragment();for(let s of t){let i=r.get(s);i&&n.appendChild(i)}for(let[s,i]of r.entries())t.includes(s)||n.appendChild(i);e.appendChild(n)}function ss(){let t=document.querySelector(".category-tabs");t&&t.querySelectorAll(".category-tab").forEach(e=>{try{e.setAttribute("draggable","false");let r=e.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",e.insertBefore(r,e.firstChild))}catch{}})}function xi(){let t=document.querySelector(".category-tabs");if(t)try{new MutationObserver(()=>{ss()}).observe(t,{childList:!0,subtree:!0})}catch{}}function Ei(){let t=document.body;if(!t)return;let e=0,r=0,n=!1,s=()=>{e&&(window.clearTimeout(e),e=0),r&&(window.clearTimeout(r),r=0)},i=()=>{n=!1,t.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",o=>{!o.target?.closest?.(".category-tabs")||!o.target?.closest?.(".category-tab")||o.target?.closest?.(".category-drag-handle")||(s(),e=window.setTimeout(()=>{n=!0,t.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{i()},2500)},380))},!0);let a=()=>{s(),n&&i()};document.addEventListener("pointerup",a,!0),document.addEventListener("pointercancel",a,!0),document.addEventListener("scroll",a,!0)}var os={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,ss(),xi(),Ei(),document.addEventListener("click",t=>{t.target?.closest?.(".category-drag-handle")&&(t.preventDefault(),t.stopPropagation())},!0),document.addEventListener("dragstart",t=>{let e=t.target?.closest?.(".category-drag-handle");if(!e)return;let r=e.closest(".category-tab"),n=e.closest(".category-tabs"),s=r?.dataset?.category;if(!(!r||!n||!s)){this._draggingTab=r,this._originTabsEl=n,r.classList.add("dragging"),t.dataTransfer.effectAllowed="move";try{t.dataTransfer.setData("text/plain",String(s))}catch{}}},!0),document.addEventListener("dragover",t=>{let e=t.target?.closest?.(".category-tabs");if(!e||!this._draggingTab||this._originTabsEl&&e!==this._originTabsEl)return;let r=t.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;t.preventDefault();let n=Array.from(e.querySelectorAll(".category-tab")),s=n.indexOf(this._draggingTab),i=n.indexOf(r);s<0||i<0||s===i||(s<i?e.insertBefore(this._draggingTab,r.nextSibling):e.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",t=>{let e=t.target?.closest?.(".category-tabs");!e||!this._draggingTab||this._originTabsEl&&e!==this._originTabsEl||t.preventDefault()},!0),document.addEventListener("dragend",t=>{let e=t.target?.closest?.(".category-drag-handle");if(!e)return;let r=e.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let n=vi(r);_i(n),Ci(n),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};c.categoryTabReorder=os;N(()=>{os.attach()});var Nr="rss_subscriptions",Z=null,W=null,bt=!1,qt=!1,$r=!1,ir=!1,Ne=!1,gt=new Map,kt=new Set,ds=!1,rr="",nr="",Ai=80,Re=0,Me=0,Or=!1,mt=[],Dr=0,Pe=0,se=44,is=10,Ft=0,as=0,cs=new Map;function ls(t){return new Promise(e=>window.setTimeout(e,Math.max(0,t||0)))}function Ti(t){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(t||""))}catch{}return String(t||"").replace(/"/g,'\\"')}function Li(t){let e=Array.isArray(t)?t:[];for(let r of e){let n=String(r||"").trim();if(!n)continue;let s=`rss-${n}`,i=`.platform-card[data-platform="${Ti(s)}"]`,a=document.querySelector(i);if(!a)continue;let o=a.querySelectorAll(".news-item");if(o&&o.length>0)return!0}return!1}function Br(t,e){let r=Array.isArray(t)?t:[];for(let n of r){let s=String(n||"").trim();s&&(e?kt.add(s):kt.delete(s))}}function Fr(){return document.getElementById("rssSubscriptionModal")}function Hr(){return document.getElementById("rssSourcePickerModal")}function Ie(t){return(Array.isArray(t)?t:[]).filter(r=>r&&typeof r=="object").map(r=>({source_id:String(r.source_id||r.rss_source_id||"").trim(),url:String(r.url||"").trim(),feed_title:String(r.feed_title||r.display_name||"").trim(),column:String(r.column||"RSS").trim()||"RSS",platform_id:String(r.platform_id||"").trim()})).filter(r=>!!r.source_id)}async function us({showHintOn403:t}={}){if(!$r){$r=!0;try{let e=await fetch("/api/me/rss-subscriptions");if(e.status===403){bt=!1,qt=!0;try{Ht()}catch{}t&&H("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5F53\u524D\u4F7F\u7528\u672C\u5730\u8BA2\u9605",{variant:"info"});return}let r=await e.json().catch(()=>({}));if(!e.ok){qt=!0,bt=!1;return}let n=Ie(r?.subscriptions);qt=!0,bt=!0;try{Ht()}catch{}try{K.setSubscriptions(n)}catch{}try{W=K.getSubscriptions()}catch{W=null}nt(),Q()}finally{$r=!1}}}function ki(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function Ri(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function oe(t){let r=(Array.isArray(t)?t:[]).filter(n=>n&&typeof n=="object").map(n=>({source_id:String(n.source_id||n.rss_source_id||"").trim(),url:String(n.url||"").trim(),feed_title:String(n.feed_title||"").trim(),column:String(n.column||"RSS").trim()||"RSS"})).filter(n=>!!n.source_id||!!n.url).sort((n,s)=>(n.source_id||"").localeCompare(s.source_id||""));return JSON.stringify(r)}function qr(t,e){let r=Array.isArray(t)?t:[],n=Array.isArray(e)?e:[],s=new Set(r.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(Boolean)),i=[];for(let a of n){let o=String(a?.source_id||a?.rss_source_id||"").trim();o&&(s.has(o)||i.push(o))}return i}function Pi(t,e){if(t)try{e?t.removeAttribute("disabled"):t.setAttribute("disabled","true")}catch{}}function Mi(t,e){if(!t)return;let r=!!e;try{r?t.setAttribute("aria-disabled","true"):t.removeAttribute("aria-disabled")}catch{}try{r?(t.style.opacity="0.5",t.style.cursor="not-allowed"):(t.style.opacity="",t.style.cursor="")}catch{}}function Q(){let t=Ri(),e=ki(),r=ps();try{t&&t.removeAttribute("disabled")}catch{}Mi(t,!r);try{t&&(r?t.removeAttribute("title"):t.setAttribute("title","\u8BF7\u5148\u9009\u62E9 RSS \u6E90\u518D\u9884\u89C8"))}catch{}if(r){let d=gt.get(String(r||"").trim());d&&d.ok===!0&&Number(d.entries_count||0)===0&&H("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let n=Array.isArray(W)?W:[],s=K.getSubscriptions(),i=oe(n)!==oe(s),o=qr(n,s).every(d=>{let u=gt.get(d);return!!u&&u.ok===!0&&Number(u.entries_count||0)>0});if(Pi(e,i&&o),!i){r&&(()=>{let d=gt.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||H("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!o){r&&(()=>{let d=gt.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||H("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}H("",{variant:"info"})}async function Ii(t){let e=sr();e&&(e.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`),n=await r.json();if(!r.ok)throw new Error(n?.detail||"Preview failed");let s=n?.data||{},i=s?.feed?.title||"",a=Array.isArray(s?.entries)?s.entries:[],o=a.length,l=a.slice(0,5).map(d=>{let u=h(d?.title||""),f=h(d?.link||"");return f?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${f}" target="_blank" rel="noopener noreferrer">${u||f}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u}</div>`}).join("");if(!ir&&i&&(ae("rssFeedTitle",i),Ne=!0),gt.set(String(t||"").trim(),{ok:!0,entries_count:o,ts:Date.now()}),o>0)try{let u=(Z?String(Z.url||"").trim():"")||String(n?.final_url||n?.url||"").trim(),f=ie("rssColumn")||"";if(!f||String(f).trim().toUpperCase()==="RSS")try{let y=c.tabs&&typeof c.tabs.getActiveTabId=="function"?c.tabs.getActiveTabId():"";y&&(f=String(y))}catch{}f||(f="general");let m=ie("rssFeedTitle")||String(Z?.name||Z?.host||"").trim(),p=K.getSubscriptions(),w=p.findIndex(y=>y.source_id&&y.source_id===String(t||"").trim()),T={source_id:String(t||"").trim(),url:u,feed_title:m,column:f,platform_id:""};w>=0?p[w]=T:p.unshift(T),K.setSubscriptions(p),nt()}catch{}else H("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});Q(),e&&(e.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${h(i||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${a.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${l}</div>
            </div>`)}function Ni(){return document.getElementById("rssSubscriptionList")}function sr(){return document.getElementById("rssSubscriptionPreview")}function $i(){return document.getElementById("rssSubscriptionSaveStatus")}function H(t,e={}){let r=$i();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function fs(){return document.getElementById("rssSelectedSourceId")}function Oi(){return document.getElementById("rssSelectedSourceLabel")}function Di(){return document.getElementById("rssRequestSection")}function Bi(){return document.getElementById("rssSourceCategoryList")}function ms(){return document.getElementById("rssSourceSearchInput")}function gs(){return document.getElementById("rssSourceResults")}function Fi(){return document.getElementById("rssSourcePickerStatus")}function ie(t){let e=document.getElementById(t);return e&&typeof e.value=="string"?e.value.trim():""}function ae(t,e){let r=document.getElementById(t);r&&(r.value=e==null?"":String(e))}function ps(){let t=fs();return t&&typeof t.value=="string"?t.value.trim():""}function qi(t){Z=t&&typeof t=="object"?t:null;let e=fs(),r=Oi(),n=Z?String(Z.id||"").trim():"",s=Z?String(Z.name||Z.host||n):"",i=Z?String(Z.url||"").trim():"";e&&(e.value=n),r&&(r.textContent=n?`${s}${i?` (${i})`:""}`:"\u672A\u9009\u62E9"),n&&!ir&&(!ie("rssFeedTitle")||Ne)&&(ae("rssFeedTitle",s),Ne=!0),n&&hs(n),Q()}function hs(t){let e=String(t||"").trim();if(!e)return;let r=Date.now(),n=15e3,s=cs.get(e)||0;r-s<n||(cs.set(e,r),Ft&&(window.clearTimeout(Ft),Ft=0),Ft=window.setTimeout(async()=>{Ft=0;let i=Date.now()-(as||0);if(i<400){Ft=window.setTimeout(()=>{Ft=0,hs(e)},400-i);return}as=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[e],priority:"high"})})}catch{}},300))}function or(t){let e=Fi();e&&(e.textContent=t==null?"":String(t))}async function ys(){let t=await fetch("/api/rss-source-categories"),e=await t.json();if(!t.ok)throw new Error(e?.detail||"Failed to load categories");let r=Array.isArray(e?.categories)?e.categories:[],n=Bi();if(!n)return r;let s=r.map(i=>{let a=String(i?.id||""),o=String(i?.name||a||""),l=Number(i?.count||0),d=a===rr;return`
          <button type="button" class="platform-select-action-btn" data-cat="${h(a)}" style="justify-content:flex-start;${d?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${h(o)} <span style="opacity:0.7;">(${l})</span>
          </button>`}).join("");return n.innerHTML=s,n.querySelectorAll("button[data-cat]").forEach(i=>{i.addEventListener("click",()=>{rr=String(i.getAttribute("data-cat")||""),ys().catch(()=>{}),Gr({reset:!0})})}),r}async function ws(t={}){let e=t.reset===!0;if(!Or){Or=!0;try{e&&(mt=[],Re=0,Me=0),or("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;nr&&r.set("q",nr),rr&&r.set("category",rr),r.set("limit",String(Ai)),r.set("offset",String(Re));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json();if(!n.ok)throw new Error(s?.detail||"Search failed");let i=Array.isArray(s?.sources)?s.sources:[];Me=Number(s?.total||0),e?mt=i:mt=mt.concat(i),Re=Number(s?.next_offset??Re+i.length)||Re+i.length,Ss();let o=mt.length<Me;or(`\u5DF2\u52A0\u8F7D ${mt.length}/${Me}${o?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{Or=!1}}}function Ss(){Dr||(Dr=window.requestAnimationFrame(()=>{Dr=0,Hi()}))}function Hi(){let t=gs();if(!t)return;let e=t.scrollTop||0,r=t.clientHeight||360,n=mt.length,s=n*se,i=Math.max(0,Math.floor(e/se)-is),a=Math.min(n,Math.ceil((e+r)/se)+is),o=t.querySelector(":scope > .rss-src-inner");o||(t.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',o=t.querySelector(":scope > .rss-src-inner")),o.style.height=`${s}px`;let l=[];for(let u=i;u<a;u++){let f=mt[u]||{},m=String(f.id||"").trim(),p=String(f.name||f.host||m),w=String(f.url||"");l.push(`<div class="rss-source-item" data-source-id="${h(m)}" style="position:absolute;left:0;right:0;top:${u*se}px;height:${se}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <span style="font-weight:700;font-size:0.9rem;color:#111827;">${h(p)}</span>
                <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${h(w)}</span>
              </div>
            </div>`)}o.innerHTML=l.join(""),o.querySelectorAll(".rss-source-item[data-source-id]").forEach(u=>{u.addEventListener("click",()=>{let f=String(u.getAttribute("data-source-id")||"").trim(),m=mt.find(p=>p&&String(p.id||"").trim()===f)||null;qi(m),jr()})}),e+r>=s-se*6&&mt.length<Me&&ws({reset:!1}).catch(u=>{or(u?.message||String(u))})}function Gr(t={}){let e=t.reset!==!1;ws({reset:e}).catch(r=>{or(r?.message||String(r))})}function Gi(){let t=Hr();if(!t)return;ds=!0,t.classList.add("show");let e=ms();e&&(e.value=nr,e.focus()),ys().catch(()=>{}),Gr({reset:!0})}function jr(){let t=Hr();t&&(ds=!1,t.classList.remove("show"))}function nt(){let t=Ni();if(!t)return;let e=K.getSubscriptions();if(!e.length){t.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=e.map((n,s)=>{let i=String(n?.source_id||n?.rss_source_id||"").trim(),a=h(n.url||""),o=h(n.feed_title||""),l=h(n.column||"RSS"),d=o?`${o}`:a,u=i&&kt.has(i);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${d}</span>
                            ${u?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${a}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${l}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${s})">\u5220\u9664</button>
                </div>
            </div>`}).join("");t.innerHTML=r,Q()}var K={getSubscriptionsRaw(){let t=R.get(Nr,[]);return Array.isArray(t)?t:[]},setSubscriptionsRaw(t){if(!Array.isArray(t)){R.set(Nr,[]);return}R.set(Nr,t)},getSubscriptions(){return this.getSubscriptionsRaw().filter(e=>e&&typeof e=="object").map(e=>({source_id:String(e.source_id||e.rss_source_id||"").trim(),url:String(e.url||"").trim(),feed_title:String(e.feed_title||"").trim(),column:String(e.column||"RSS").trim()||"RSS",platform_id:String(e.platform_id||"").trim()})).filter(e=>!!e.source_id||!!e.url)},setSubscriptions(t){this.setSubscriptionsRaw(t)},ensureSnapshot(){if(!Array.isArray(W))try{W=this.getSubscriptions()}catch{W=null}},stageFromCatalogPreview(t={}){let e=String(t?.source_id||t?.rss_source_id||"").trim();if(!e)return;let r=String(t?.url||"").trim(),n=String(t?.feed_title||t?.name||"").trim(),s=String(t?.column||"RSS").trim()||"RSS";this.ensureSnapshot();let i=this.getSubscriptions(),a=i.findIndex(d=>d?.source_id&&d.source_id===e),o={source_id:e,url:r,feed_title:n,column:s,platform_id:""};a>=0?i[a]=o:i.unshift(o),this.setSubscriptions(i);let l=Number(t?.entries_count??0)||0;gt.set(e,{ok:!0,entries_count:l,ts:Date.now()});try{nt()}catch{}Q()},open(){let t=Fr();if(!t)return;try{W=this.getSubscriptions()}catch{W=null}ae("rssFeedTitle",""),Ne=!1,ir=!1,gt.clear(),kt.clear(),nt();let e=sr();e&&(e.innerHTML=""),H(""),t.classList.add("show"),Q(),us({showHintOn403:!1}).catch(()=>{})},close(){let t=Fr();t&&t.classList.remove("show")},async previewCurrent(){let t=ps();if(!t){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await Ii(t)}catch(e){gt.set(String(t||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(e?.message||e)}),Q();let r=sr();r&&(r.innerHTML=`<div style="color:#dc2626;">${h(e?.message||String(e))}</div>`)}},removeAt(t){let e=this.getSubscriptions();if(!(t<0||t>=e.length)){try{let r=String(e[t]?.source_id||e[t]?.rss_source_id||"").trim();r&&kt.delete(r)}catch{}e.splice(t,1),this.setSubscriptions(e),nt()}},async saveOnly(){try{let t=Array.isArray(W)?W:[],e=this.getSubscriptions(),r=oe(t)!==oe(e),s=qr(t,e).every(l=>{let d=gt.get(l);return!!d&&d.ok===!0&&Number(d.entries_count||0)>0});if(!r){H("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58",{variant:"info"}),Q();return}if(!s){H("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),Q();return}let i=e;try{let l=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:Ie(e)})});if(l.status===403){qt=!0,bt=!1;try{Ht()}catch{}H("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let d=await l.json().catch(()=>({}));if(!l.ok)throw new Error(d?.detail||"Save failed");i=Ie(d?.subscriptions),qt=!0,bt=!0;try{Ht()}catch{}this.setSubscriptions(i)}}catch(l){H(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(l?.message||l)}`,{variant:"info"})}let a=new Set(t.map(l=>String(l?.source_id||l?.rss_source_id||"").trim()).filter(Boolean)),o=i.map(l=>String(l?.source_id||l?.rss_source_id||"").trim()).filter(l=>!!l&&!a.has(l));if(o.length>0&&(Br(o,!0),nt()),o.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:o,priority:"high"})})}catch{}try{W=this.getSubscriptions()}catch{W=null}nt(),Q()}catch(t){console.error("rss save error:",t);try{H(String(t?.message||t),{variant:"error"})}catch{}}},async saveAndRefresh(){try{let t=Array.isArray(W)?W:[],e=this.getSubscriptions(),r=oe(t)!==oe(e),s=qr(t,e).every(m=>{let p=gt.get(m);return!!p&&p.ok===!0&&Number(p.entries_count||0)>0});if(!r){H("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),Q();return}if(!s){H("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),Q();return}let i=e;try{let m=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:Ie(e)})});if(m.status===403){qt=!0,bt=!1;try{Ht()}catch{}H("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let p=await m.json().catch(()=>({}));if(!m.ok)throw new Error(p?.detail||"Save failed");i=Ie(p?.subscriptions),qt=!0,bt=!0;try{Ht()}catch{}this.setSubscriptions(i)}}catch(m){H(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(m?.message||m)}`,{variant:"info"})}let a=new Set(t.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(Boolean)),o=i.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(m=>!!m&&!a.has(m));if(o.length>0&&(Br(o,!0),nt()),o.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:o,priority:"high"})})}catch{}H("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.setAttribute("disabled","true")}catch{}let l=Date.now(),d=5e3,u=[0,300,700,1500,2500],f=!1;for(let m of u){let p=Date.now()-l,w=d-p;if(w<=0)break;if(m>0&&await ls(Math.min(m,w)),await c.data.refreshViewerData({preserveScroll:!0}),o.length>0){let T=[];for(let y of o)kt.has(y)&&Li([y])&&kt.delete(y),kt.has(y)&&T.push(y);if(T.length===0){f=!0,nt();break}nt()}if(o.length===0){f=!0;break}}f?H("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(o.length>0&&(Br(o,!1),nt()),H("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.removeAttribute("disabled")}catch{}await ls(f?200:800),this.close()}catch(t){console.error("rss refresh error:",t);try{H(String(t?.message||t),{variant:"error"})}catch{}try{let e=document.querySelector("#rssSubscriptionModal .settings-btn-primary");e&&e.removeAttribute("disabled")}catch{}}}};async function ji(){let t=ie("rssRequestUrl"),e=ie("rssRequestTitle"),r=ie("rssRequestNote");if(!t){alert("\u8BF7\u8F93\u5165 URL");return}if(!e){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let n=sr();n&&(n.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let s=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,title:e,note:r})}),i=await s.json();if(!s.ok)throw new Error(i?.detail||"Submit failed");n&&(n.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${h(i?.status||"pending")}</div>`),ae("rssRequestUrl",""),ae("rssRequestTitle",""),ae("rssRequestNote","")}catch(s){n&&(n.innerHTML=`<div style="color:#dc2626;">${h(s?.message||String(s))}</div>`)}}function zi(){let t=Di();if(!t)return;let e=t.style.display!=="none";t.style.display=e?"none":"block"}window.openRssSubscriptionModal=()=>{try{let t=document.getElementById("rssSubscriptionNewBadge");t&&(t.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}K.open()};window.closeRssSubscriptionModal=()=>K.close();window.previewRssSubscription=()=>K.previewCurrent();window.saveRssSubscriptions=()=>K.saveAndRefresh();window.removeRssSubscription=t=>K.removeAt(parseInt(t,10));window.submitRssSourceRequest=()=>ji();window.toggleRssRequestSection=()=>zi();window.openRssSourcePicker=()=>Gi();window.closeRssSourcePicker=()=>jr();c.subscription=K;c.subscription._serverEnabled=bt;function Ht(){try{c.subscription._serverEnabled=!!bt}catch{}}N(function(){let t=Fr();if(t){let s=document.getElementById("rssFeedTitle");s&&s.addEventListener("input",()=>{ir=String(s.value||"").trim()!=="",Ne=!1}),t.addEventListener("keydown",i=>{i.key==="Escape"&&K.close()})}let e=Hr();e&&e.addEventListener("keydown",s=>{s.key==="Escape"&&jr()});let r=gs();r&&r.addEventListener("scroll",()=>{Ss()});let n=ms();n&&n.addEventListener("input",()=>{nr=String(n.value||"").trim(),Pe&&(window.clearTimeout(Pe),Pe=0),Pe=window.setTimeout(()=>{Pe=0,Gr({reset:!0})},250)}),Ht(),us({showHintOn403:!1}).catch(()=>{})});var $e=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Yi=3,Cs="hotnews_explore_seen_sources_v1",xs="hotnews_explore_last_source_v1",U=!1,jt=!1,st=[],zr=0,ar=0,vt=!1,Rt=-1,G=null,ce=new Map,ot=null,zt=null,pt=0,de=new Set,Vr=new Set;function Vi(){try{let t=R.getRaw(Cs);if(!t)return new Set;let e=JSON.parse(t);if(!Array.isArray(e))return new Set;let r=new Set;for(let n of e){let s=String(n||"").trim();s&&r.add(s)}return r}catch{return new Set}}function Wi(t){try{let r=Array.from(t||[]).map(n=>String(n||"").trim()).filter(Boolean).slice(-2e3);R.setRaw(Cs,JSON.stringify(r))}catch{}}function Xi(){try{let t=new Set(Array.from(de||[]));for(let e of Array.from(Vr||[]))t.add(e);de=t,Wi(de)}catch{}}function Ui(){try{let t=R.getRaw(xs);return String(t||"").trim()||null}catch{return null}}function Ki(t){try{let e=String(t||"").trim();if(!e)return;R.setRaw(xs,e)}catch{}}var cr=!1,Wr=0,Xr=0,Gt=null;function Es(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function Ji(t){if(!U||!Es()||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select")||!e.closest(".rss-carousel-frame"))return;let r=t?.touches;!r||r.length!==1||(cr=!0,Gt=null,Wr=Number(r[0]?.clientX||0),Xr=Number(r[0]?.clientY||0))}function Zi(t){if(!cr||!U)return;let e=t?.touches;if(!e||e.length!==1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Wr,i=n-Xr,a=Math.abs(s),o=Math.abs(i);if(!Gt){if(a<10&&o<10)return;Gt=a>=o?"x":"y"}try{t.preventDefault()}catch{}}function bs(t){if(!cr||(cr=!1,!U)||!Es())return;let e=t?.changedTouches;if(!e||e.length<1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Wr,i=n-Xr,a=Math.abs(s),o=Math.abs(i),l=44;if((Gt==="x"||Gt==null)&&a>=l&&a>o){s<0?ht():Oe();return}(Gt==="y"||Gt==null)&&o>=l&&o>a&&(i<0?le(-1):le(1))}function lr(){return document.getElementById("rssCatalogPreviewModal")}function Yr(){return document.getElementById("rssCatalogPreviewGrid")}function Qi(){return document.getElementById("rssCatalogPreviewStatus")}function tt(t,e={}){let r=Qi();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function ta(t){let e=Number(t||0)||0;if(!e)return"";let r=new Date(e);if(Number.isNaN(r.getTime()))return"";let n=o=>String(o).padStart(2,"0"),s=String(r.getFullYear()),i=n(r.getMonth()+1),a=n(r.getDate());return`${s}-${i}-${a}`}function ea(t){let e=[t?.published,t?.published_at,t?.pubDate,t?.updated,t?.updated_at,t?.date,t?.datetime,t?.date_published,t?.date_modified],n=Date.now()+365*24*60*60*1e3,s=i=>{let a=Number(i);return!Number.isFinite(a)||a<=0?0:a<1e11?Math.floor(a*1e3):Math.floor(a)};for(let i of e){if(i==null)continue;if(typeof i=="number"){let l=s(i);if(l>0&&l<=n)return l;continue}let a=String(i).trim();if(!a)continue;if(/^\d{10,13}$/.test(a)){let l=s(a);if(l>0&&l<=n)return l;continue}let o=Date.parse(a);if(!Number.isNaN(o)&&o>0&&o<=n)return o}return 0}async function As(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function ra(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let i=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,o=Number(s?.next_offset??e+i.length)||e+i.length;return{items:i,total:a,nextOffset:o}}async function ue(t){let e=Number(t);if(!Number.isFinite(e)||e<0||vt)return;let r=0;for(;st.length<=e&&!vt&&r<50;){r+=1;let n=await ra(50,ar);zr=n.total,ar=n.nextOffset;for(let s of n.items)String(s?.id||"").trim()&&st.push(s);(!n.items.length||ar>=zr)&&(vt=!0)}}async function na(){if(vt)return;let t=0;for(;!vt&&t<200&&(t+=1,await ue(st.length),!vt););}function sa(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function oa(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(i=>{let a=String(i?.title||"").trim(),o=String(i?.link||"").trim(),l=ea(i);return{title:a||o,link:o,ts:l}}).filter(i=>!!i.link);return{feedTitle:r,entries:s}}function Ts(){let t=c.subscription?.getSubscriptions?c.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}function vs(t){let e=String(t||"").trim();if(!e)return!0;try{if(Ts().has(e))return!0}catch{}try{if(de&&de.has(e))return!0}catch{}return!1}async function Ls(t){let e=String(t?.id||"").trim();if(!e)return null;if(ce.has(e))return ce.get(e);let r=String(t?.url||"").trim(),n=sa(t),s=Ts(),i=[],a="",o=null;try{let u=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`);if(o=await u.json().catch(()=>({})),!u.ok)throw new Error(o?.detail||"Preview failed");let f=oa(o);a=f.feedTitle,i=f.entries}catch(u){let f={source_id:e,error:String(u?.message||u)};return ce.set(e,f),f}if(!Array.isArray(i)||i.length<=0){let u={source_id:e,error:"No entries"};return ce.set(e,u),u}let d={source_id:e,url:r,feed_title:a||n,platform_name:a||n,entries:i,entries_count:i.length,error:"",already_added:s.has(e)};return ce.set(e,d),d}async function ia(t){let e=String(t||"").trim();if(!e)return-1;let r=0;for(;r<400;){r+=1;let n=st.findIndex(s=>String(s?.id||"").trim()===e);if(n>=0)return n;if(vt||(await ue(st.length),vt))return-1}return-1}function aa(t){if(!U)return;let e=async()=>{if(jt||ot!=null)return;let r=[];for(let s=1;s<=Yi;s+=1)r.push(t+s);let n=Math.max(...r);Number.isFinite(n)&&n>=0&&await ue(n);for(let s of r)try{if(s<0)continue;await ue(s);let i=st[s];if(!i)continue;await Ls(i)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>e().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>e().catch(()=>{}),0)}function _s(){let t=c.settings?.getMergedCategoryConfig?c.settings.getMergedCategoryConfig():null,e=c.settings?.getDefaultCategories?c.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],i=new Set;for(let a of r){let o=String(a||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=n.find(m=>String(m?.id||"")===o);if(l){let m=String(l?.name||o).trim()||o;s.push({id:o,name:m,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[o]?e[o]:null;if(!d)continue;let u=String(d?.name||o).trim()||o,f=String(d?.icon||"\u{1F4C1}");s.push({id:o,name:u,icon:f,isCustom:!1})}for(let a of n){let o=String(a?.id||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=String(a?.name||o).trim()||o;s.push({id:o,name:l,icon:"\u{1F4F1}",isCustom:!0})}return s}async function ca(t){if(!G||!G.source_id)return;let e=String(t?.id||"").trim(),r=String(t?.name||e).trim()||e||"RSS",n=!!t?.isCustom,s=String(G.source_id||"").trim(),i=s?`rss-${s}`:"",a="RSS";e&&e!=="rsscol-rss"&&!n&&(a=e);try{c.subscription?.ensureSnapshot?.()}catch{}try{c.subscription?.stageFromCatalogPreview?.({source_id:G.source_id,url:G.url,feed_title:G.feed_title||G.platform_name,column:a,entries_count:G.entries_count||0})}catch(o){tt(String(o?.message||o),{variant:"error"});return}if(n&&e&&i)try{c.settings?.addPlatformToCustomCategory?.(e,i)}catch{}G.already_added=!0;try{Ur(G)}catch{}try{tt(`\u4FDD\u5B58\u4E2D\uFF1A${r}`,{variant:"info"}),c.subscription?.saveOnly?await c.subscription.saveOnly():c.subscription?.saveAndRefresh?await c.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),tt(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success"})}catch(o){tt(String(o?.message||o),{variant:"error"});try{c.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(o?.message||o)}`,{variant:"error",durationMs:2500})}catch{}return}try{c.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}try{setTimeout(()=>{U&&ht()},60)}catch{}try{As([G.source_id],"high").catch(()=>{})}catch{}}function Ur(t){let e=Yr();if(!e)return;let r=t,n=String(r?.source_id||"").trim(),s=h(r?.platform_name||"RSS"),i=r?.already_added?"disabled":"",o=_s().map(y=>{let b=`${y?.isCustom?"custom":"default"}:${String(y?.id||"").trim()}`;return`<option value="${h(b)}">${h(String(y?.icon||"\u{1F4C1}"))} ${h(String(y?.name||y?.id||""))}</option>`}).join(""),l=Array.isArray(r?.entries)?r.entries:[],d=Math.max(0,Math.ceil(l.length/$e)-1);pt>d&&(pt=d),pt<0&&(pt=0);let u=pt*$e,f=l.slice(u,u+$e),m=f.map((y,A)=>{let b=h(y?.title||""),E=h(y?.link||"#"),x=h(ta(y?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${b}">
                <div class="news-item-content">
                    <span class="news-index">${String(u+A+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${E}" target="_blank" rel="noopener noreferrer">${b}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${x?"":"display:none;"}">${x}</span>
                </div>
            </li>`}).join(""),p=Math.max(0,$e-f.length),w=p?Array.from({length:p}).map((y,A)=>{let b=u+f.length+A+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(b)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";e.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${h(n)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${s}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <select class="platform-select-action-btn" data-action="add-category" ${i} style="padding:6px 10px;">
                            <option value="" selected>\u52A0\u5165\u680F\u76EE</option>
                            ${o}
                        </select>
                    </div>
                </div>
                <ul class="news-list">${m}${w}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{e.querySelectorAll(".news-title").forEach(A=>{A instanceof HTMLElement&&(A.closest(".rss-entry-placeholder")||(A.classList.remove("tr-title-overflow-shrink"),A.scrollWidth>A.clientWidth+1&&A.classList.add("tr-title-overflow-shrink")))})})}catch{}let T=e.querySelector('select[data-action="add-category"]');T&&T.addEventListener("change",async()=>{if(!G||G.already_added||!(T instanceof HTMLSelectElement))return;let y=String(T.value||"").trim();if(!y)return;let A=y.split(":"),b=String(A[1]||"").trim(),x=_s().find(X=>String(X?.id||"").trim()===b),F=x||{id:b,name:b,icon:"\u{1F4C1}",isCustom:y.startsWith("custom:")};try{T.setAttribute("disabled","true")}catch{}await ca(F)})}async function dr(t,e=1){if(!jt){jt=!0,zt=Number(t);try{if(await ue(t),st.length<=0){let a=Yr();a&&(a.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),tt("",{variant:"info"});return}let r=t,n=e>=0?1:-1,s=0;for(;s<200;){s+=1,r<0&&(await na(),r=st.length-1),await ue(r),r>=st.length&&(r=0);let a=st[r];if(!a){r+=n;continue}let o=String(a?.id||"").trim();if(vs(o)){r+=n;continue}let l=await Ls(a);if(!l||l.error){r+=n;continue}if(l.already_added){r+=n;continue}if(vs(l.source_id)){r+=n;continue}Rt=r,G=l,pt=0,Ur(l),tt("",{variant:"info"});try{let d=String(l?.source_id||"").trim();d&&(Ki(d),Vr.add(d))}catch{}try{As([l.source_id],"normal").catch(()=>{})}catch{}try{aa(r)}catch{}return}let i=Yr();i&&(i.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),tt("",{variant:"info"})}catch(r){tt(String(r?.message||r),{variant:"error"})}finally{if(jt=!1,zt=null,U&&ot!=null){let r=Number(ot);ot=null;let n=Number.isFinite(Rt)?Rt:0,s=r>=n?1:-1;dr(r,s).catch(i=>tt(String(i?.message||i),{variant:"error"}))}}}}function ht(){if(!U)return;if(jt){ot=(ot!=null?Number(ot):zt!=null?Number(zt):Rt)+1;return}let t=Rt+1;dr(t,1).catch(e=>tt(String(e?.message||e),{variant:"error"}))}function Oe(){if(!U)return;if(jt){ot=(ot!=null?Number(ot):zt!=null?Number(zt):Rt)-1;return}let t=Rt-1;dr(t,-1).catch(e=>tt(String(e?.message||e),{variant:"error"}))}function le(t){if(!U||!G)return;let e=Array.isArray(G?.entries)?G.entries:[],r=Math.max(0,Math.ceil(e.length/$e)-1),n=Math.max(0,Math.min(r,pt+t));n!==pt&&(pt=n,Ur(G))}function ks(){let t=lr();if(!t)return;U=!0,t.classList.add("show");try{window.dispatchEvent(new CustomEvent("tr_explore_modal_opened"))}catch{}try{let r=t.querySelector(".settings-modal");r&&(r.setAttribute("tabindex","0"),r.focus())}catch{}try{c.subscription?.ensureSnapshot?.()}catch{}jt=!1,ot=null,zt=null,st=[],zr=0,ar=0,vt=!1,Rt=-1,G=null,ce=new Map,pt=0,de=Vi(),Vr=new Set;let e=Ui();if(e){(async()=>{let r=await ia(e);r>=0?await dr(r,1):ht()})().catch(()=>ht());return}ht()}function fe(){let t=lr();if(t){U=!1,t.classList.remove("show"),Xi();try{window.dispatchEvent(new CustomEvent("tr_explore_modal_closed"))}catch{}}}function la(t){let e=lr();e&&t&&t.target===e&&fe()}async function Rs(){try{await(c.subscription?.saveAndRefresh?c.subscription.saveAndRefresh():window.saveRssSubscriptions?.())}catch(t){tt(String(t?.message||t),{variant:"error"});return}fe()}window.openRssCatalogPreviewModal=()=>ks();window.closeRssCatalogPreviewModal=()=>fe();window.closeRssCatalogPreviewModalOnOverlay=t=>la(t);window.rssCatalogPreviewNext=()=>ht();window.rssCatalogPreviewPrev=()=>Oe();window.rssCatalogPreviewSaveAndRefresh=()=>Rs();c.rssCatalogPreview={open:ks,close:fe,next:ht,prev:Oe,saveAndRefresh:Rs};N(function(){let t=lr();if(!t)return;let e=t.querySelector(".settings-modal");e&&e.addEventListener("keydown",n=>{if(n.key==="Escape"){fe();return}}),document.addEventListener("keydown",n=>{if(n.key==="Escape"){U&&fe();return}if(!U||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let s=n?.target;if(!(s&&s instanceof Element&&s.closest("input,textarea,select"))){if(n.key===" "||n.key==="Spacebar"||n.code==="Space"){n.preventDefault(),ht();return}if(n.key==="ArrowUp"){n.preventDefault(),le(-1);return}if(n.key==="ArrowDown"){n.preventDefault(),le(1);return}if(n.key==="ArrowRight"){n.preventDefault(),ht();return}if(n.key==="ArrowLeft"){n.preventDefault(),Oe();return}}});let r=t.querySelector(".settings-modal-body");r&&(r.addEventListener("click",n=>{if(!U||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let s=n?.target;if(!s||!(s instanceof Element)||s.closest("a,button,input,textarea,select"))return;let i=Number(n?.clientX||0),a=Number(n?.clientY||0),o=t.querySelector("#rssCatalogPreviewGrid .platform-card");if(!o)return;let l=o.getBoundingClientRect(),d=140,u=l.left-d,f=l.right+d,m=l.top-d,p=l.bottom+d;if(!(i<u||i>f||a<m||a>p)&&!(i>=l.left&&i<=l.right&&a>=l.top&&a<=l.bottom)){if(a<l.top){le(-1);return}if(a>l.bottom){le(1);return}if(i<l.left){Oe();return}if(i>l.right){ht();return}}}),r.addEventListener("touchstart",Ji,{passive:!0}),r.addEventListener("touchmove",Zi,{passive:!1}),r.addEventListener("touchend",bs,{passive:!0}),r.addEventListener("touchcancel",bs,{passive:!0}))});var da=!1,Jr="explore",mr=window.SYSTEM_SETTINGS?.display?.items_per_card||20,ur=6,Ps=4,Ns=6,ua=180*1e3,fa=2e3,ma="/api/rss-sources/explore-cards",$s="hotnews_explore_tab_seen_sources_v1",Os="hotnews_explore_tab_cursor_v1",_t=!1,M=[];var Ms=!1,D=null,Pt=null,Mt=0,De=new Map,Kr=new Map;var Zr=!1;function gr(t,e={}){let r=ge();if(!r)return;let n=t==null?"":String(t),i=e.retry===!0?'<div style="margin-top:8px;"><button type="button" class="platform-select-action-btn" data-action="retry">\u91CD\u8BD5</button></div>':"";r.innerHTML=`<div class="category-empty-state">${h(n)}${i}</div>`}function ga(){let t=new Set;try{let e=Pt||pr();Pt=e;for(let r of e)r&&t.add(String(r))}catch{}try{let e=en();for(let r of e)r&&t.add(String(r))}catch{}try{for(let e of Array.isArray(M)?M:[]){let r=String(e?.source_id||"").trim();r&&t.add(r)}}catch{}return Array.from(t)}async function Qr(t){let e=Math.max(0,Number(t||0)||0);if(e<=0)return[];let r=Yt();if(!r||!r.classList.contains("active"))return[];try{let n=ga(),s=new URLSearchParams;s.set("cards",String(e)),s.set("entries_per_card",String(mr)),n.length&&s.set("exclude_source_ids",n.join(","));let i=`${ma}?${s.toString()}`,a=await fetch(i,{method:"GET"}),o=await a.json().catch(()=>({}));return a.ok?(Array.isArray(o?.cards)?o.cards:[]).map(d=>{let u=String(d?.source_id||"").trim(),f=String(d?.url||"").trim(),m=String(d?.platform_name||d?.feed_title||"RSS").trim()||"RSS",p=Array.isArray(d?.entries)?d.entries:[];return{source_id:u,url:f,feed_title:String(d?.feed_title||m).trim()||m,platform_name:m,entries:p.slice(0,mr).map(w=>({title:String(w?.title||"").trim(),link:String(w?.link||"").trim(),published:w?.published||w?.ts||""})),entries_count:p.length,already_added:!1}}).filter(d=>d.source_id&&Array.isArray(d.entries)&&d.entries.length>0):[]}catch{return[]}}function pa(t,e){return new Promise(r=>{if(!t){r();return}let n=!1,s=()=>{if(!n){n=!0;try{t.removeEventListener("animationend",i)}catch{}r()}},i=()=>s();try{t.addEventListener("animationend",i,{once:!0})}catch{}setTimeout(s,Math.max(0,Number(e||0)||0))})}function Yt(){return document.getElementById("tab-explore")}async function ha(){let t=en(),e=Pt||pr();Pt=e,D==null&&(D=qs());let r=new Set((Array.isArray(M)?M:[]).map(s=>String(s?.source_id||"").trim()).filter(Boolean)),n=0;for(;n<200;){n+=1;let s=D,i=await Hs(50,s);if(Mt=i.total,!i.items.length)return null;let a=[];for(let l of i.items){D+=1;let d=String(l?.id||"").trim();if(!d||e.has(d)||t.has(d)||r.has(d))continue;let u=String(l?.url||"").trim(),f=Gs(l);a.push({sid:d,url:u,name:f})}let o=await wa(a);if(o)return o;if(D>=Mt)return null;D===s&&(D+=i.items.length)}return null}function ya(t){let e=De.get(t);return e?Date.now()-Number(e.ts||0)>ua?(De.delete(t),null):e:null}async function Ds(t){let e=String(t||"").trim();if(!e)return null;let r=ya(e);if(r)return r;let n=Kr.get(e);if(n)return n;let s=(async()=>{try{let i=typeof AbortController<"u"?new AbortController:null,a=i?window.setTimeout(()=>i.abort(),fa):0,o=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`,i?{signal:i.signal}:void 0);try{a&&window.clearTimeout(a)}catch{}let l=await o.json().catch(()=>({}));if(!o.ok){let f={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:l?.detail||"Preview failed"};return De.set(e,f),f}let d=xa(l),u={ts:Date.now(),ok:!0,feedTitle:d.feedTitle,entries:d.entries,error:""};return De.set(e,u),u}catch(i){let a={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:String(i?.message||i)};return De.set(e,a),a}finally{Kr.delete(e)}})();return Kr.set(e,s),s}async function wa(t){let e=Array.isArray(t)?[...t]:[];if(e.length===0)return null;let r=null,n=null,s=new Promise(l=>{n=l}),i=async()=>{for(;e.length>0&&!r;){let l=e.shift();if(!l||!l.sid)continue;let d=await Ds(l.sid);if(!d||d.ok!==!0)continue;let u=Array.isArray(d.entries)?d.entries:[];if(!(u.length<=0)){r={source_id:l.sid,url:l.url,feed_title:d.feedTitle||l.name,platform_name:d.feedTitle||l.name,entries:u,entries_count:u.length,already_added:!1};try{n&&n(),n=null}catch{}return}}},a=Math.max(1,Math.min(Ns,e.length)),o=Array.from({length:a}).map(()=>i().catch(()=>{}));return await Promise.race([Promise.all(o),s]),r}async function Bs(t){let e=Math.max(0,Number(t||0)||0);if(e<=0)return[];let r=en(),n=Pt||pr();Pt=n,D==null&&(D=qs());let s=new Set((Array.isArray(M)?M:[]).map(d=>String(d?.source_id||"").trim()).filter(Boolean)),i=[],a=null,o=new Promise(d=>{a=d}),l=0;for(;l<200&&i.length<e;){l+=1;let d=D,u=await Hs(50,d);if(Mt=u.total,!u.items.length)break;let f=[];for(let y of u.items){D+=1;let A=String(y?.id||"").trim();if(!A||n.has(A)||r.has(A)||s.has(A)||i.some(x=>String(x?.source_id||"").trim()===A))continue;let b=String(y?.url||"").trim(),E=Gs(y);f.push({sid:A,url:b,name:E})}let m=[...f],p=async()=>{for(;m.length>0&&i.length<e;){let y=m.shift();if(!y||!y.sid)continue;let A=await Ds(y.sid);if(!A||A.ok!==!0)continue;let b=Array.isArray(A.entries)?A.entries:[];if(!(b.length<=0)){if(i.length>=e)return;if(i.push({source_id:y.sid,url:y.url,feed_title:A.feedTitle||y.name,platform_name:A.feedTitle||y.name,entries:b,entries_count:b.length,already_added:!1}),i.length>=e){try{a&&a(),a=null}catch{}return}}}},w=Math.max(1,Math.min(Ns,m.length)),T=Array.from({length:w}).map(()=>p().catch(()=>{}));if(await Promise.race([Promise.all(T),o]),i.length>=e||D>=Mt)break;D===d&&(D+=u.items.length)}return i.slice(0,e)}async function tn(){if(_t)return;let t=Yt(),e=ge();if(!(!t||!e)&&t.classList.contains("active")){_t=!0,Is(!0);try{if(M.length<ur){let r=ur-M.length,n=await Qr(r);n.length&&(M=[...M,...n],Ct(M))}for(;M.length<ur;){let r=ur-M.length,n=await Bs(r);if(!n.length)break;M=[...M,...n],Ct(M)}D!=null&&Be(D),M.length<=0&&D!=null&&Mt>0&&D>=Mt&&(D=0,Be(D))}catch{M.length<=0&&gr("\u52A0\u8F7D\u5931\u8D25",{retry:!0})}finally{_t=!1,Is(!1),Ct(M)}}}function ge(){return document.getElementById("trExploreGrid")}function Sa(){return document.getElementById("trExploreStatus")}function me(t,e={}){let r=Sa();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function Is(t){t&&(M.length>0||gr("\u52A0\u8F7D\u4E2D..."))}function ba(){let t=ge();if(!t)return!0;try{return t.querySelectorAll(".platform-card").length===0}catch{return!0}}function Fs(){let t=c.settings?.getMergedCategoryConfig?c.settings.getMergedCategoryConfig():null,e=c.settings?.getDefaultCategories?c.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],i=new Set;for(let a of r){let o=String(a||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=n.find(m=>String(m?.id||"")===o);if(l){let m=String(l?.name||o).trim()||o;s.push({id:o,name:m,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[o]?e[o]:null;if(!d)continue;let u=String(d?.name||o).trim()||o,f=String(d?.icon||"\u{1F4C1}");s.push({id:o,name:u,icon:f,isCustom:!1})}for(let a of n){let o=String(a?.id||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=String(a?.name||o).trim()||o;s.push({id:o,name:l,icon:"\u{1F4F1}",isCustom:!0})}return s}async function va(t,e){if(!t||!t.source_id)return;let r=String(e?.id||"").trim(),n=String(e?.name||r).trim()||r||"RSS",s=!!e?.isCustom,i=String(t.source_id||"").trim(),a=i?`rss-${i}`:"",o="RSS";r&&r!=="rsscol-rss"&&!s&&(o=r);try{c.subscription?.ensureSnapshot?.()}catch{}try{c.subscription?.stageFromCatalogPreview?.({source_id:t.source_id,url:t.url,feed_title:t.feed_title||t.platform_name,column:o,entries_count:t.entries_count||0})}catch(l){me(String(l?.message||l),{variant:"error"});return}if(s&&r&&a)try{c.settings?.addPlatformToCustomCategory?.(r,a)}catch{}try{me(`\u4FDD\u5B58\u4E2D\uFF1A${n}`,{variant:"info"}),c.subscription?.saveOnly?await c.subscription.saveOnly():c.subscription?.saveAndRefresh?await c.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),me(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success"})}catch(l){me(String(l?.message||l),{variant:"error"});try{c.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(l?.message||l)}`,{variant:"error",durationMs:2500})}catch{}return}try{c.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success",durationMs:1500})}catch{}try{Zr=!0}catch{}try{Ca([t.source_id],"high").catch(()=>{})}catch{}}function pr(){try{let t=R.getRaw($s);if(!t)return new Set;let e=JSON.parse(t);if(!Array.isArray(e))return new Set;let r=new Set;for(let n of e){let s=String(n||"").trim();s&&r.add(s)}return r}catch{return new Set}}function _a(t){try{let r=Array.from(t||[]).map(n=>String(n||"").trim()).filter(Boolean).slice(-2e3);R.setRaw($s,JSON.stringify(r))}catch{}}function qs(){try{let t=R.getRaw(Os),e=Number(t||0)||0;return e<0?0:e}catch{return 0}}function Be(t){try{let e=Number(t||0)||0;R.setRaw(Os,String(e<0?0:e))}catch{}}function en(){let t=c.subscription?.getSubscriptions?c.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}async function Ca(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function Hs(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let i=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,o=Number(s?.next_offset??e+i.length)||e+i.length;return{items:i,total:a,nextOffset:o}}function xa(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(i=>{let a=String(i?.title||"").trim(),o=String(i?.link||"").trim();return{title:a||o,link:o}}).filter(i=>!!i.link);return{feedTitle:r,entries:s}}function Gs(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function js(t){let e=t||{},r=e?.already_added?"disabled":"",n=e?.already_added?"\u2713":"+",i=Fs().map(a=>{let l=`${a?.isCustom?"custom":"default"}:${String(a?.id||"").trim()}`;return`<option value="${h(l)}" style="font-size:0.8rem;">${h(String(a?.icon||"\u{1F4C1}"))} ${h(String(a?.name||a?.id||""))}</option>`}).join("");return`
        <select class="tr-explore-add-btn" data-action="add-category" ${r} 
            style="width:28px;height:28px;padding:0;font-size:1rem;font-weight:normal;border-radius:50%;
            border:1px solid #e5e7eb;background:#f9fafb;color:#9ca3af;
            cursor:pointer;text-align:center;text-align-last:center;appearance:none;-webkit-appearance:none;" 
            title="${e?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE"}">
            <option value="" selected hidden>${h(n)}</option>
            ${i}
        </select>`}function zs(t){try{if(!t||!c.readState||typeof c.readState.getReadNews!="function")return;let e=c.readState.getReadNews()||{};t.querySelectorAll(".news-item[data-news-id]").forEach(n=>{try{let s=String(n?.dataset?.newsId||"").trim();if(!s||!e[s])return;n.classList.add("read")}catch{}})}catch{}}function Ct(t){let e=ge();if(!e)return;let r=(t||[]).map(n=>{let s=String(n?.source_id||"").trim(),i=h(n?.platform_name||"RSS"),a=js(n),l=(Array.isArray(n?.entries)?n.entries:[]).slice(0,mr).map((d,u)=>{let f=h(d?.title||""),m=h(d?.link||"#"),p=h(`rssx:${s}:${d?.link||""}`),w=dt(d?.published||d?.ts||0),T=w?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${h(w)}</span>`:"";return`
                <li class="news-item" data-news-id="${p}" data-news-title="${f}">
                    <div class="news-item-content">
                        <span class="news-index">${String(u+1)}</span>
                        <a class="news-title" href="${m}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">${f}</a>
                        ${T}
                    </div>
                </li>`}).join("");return`
            <div class="platform-card" data-rss-source-id="${h(s)}">
                <div class="platform-header">
                    <div class="platform-name">${i}</div>
                    <div class="platform-header-actions">
                        ${a}
                    </div>
                </div>
                <ul class="news-list">${l}</ul>
            </div>`}).join("");if(r){e.innerHTML=r,zs(e),requestAnimationFrame(()=>Vs());return}gr("\u6682\u65E0\u53EF\u9884\u89C8\u6E90",{retry:!0})}function Ea(t,e={}){let r=String(t?.source_id||"").trim(),n=h(t?.platform_name||"RSS"),s=js(t),a=(Array.isArray(t?.entries)?t.entries:[]).slice(0,mr).map((u,f)=>{let m=h(u?.title||""),p=h(u?.link||"#"),w=h(`rssx:${r}:${u?.link||""}`),T=dt(u?.published||u?.ts||0),y=T?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${h(T)}</span>`:"";return`
            <li class="news-item" data-news-id="${w}" data-news-title="${m}">
                <div class="news-item-content">
                    <span class="news-index">${String(f+1)}</span>
                    <a class="news-title" href="${p}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">${m}</a>
                    ${y}
                </div>
            </li>`}).join(""),l=`
        <div class="platform-card${e.animateIn?" tr-explore-flip-in":""}" data-rss-source-id="${h(r)}">
            <div class="platform-header">
                <div class="platform-name">${n}</div>
                <div class="platform-header-actions">
                    ${s}
                </div>
            </div>
            <ul class="news-list">${a}</ul>
        </div>`,d=document.createElement("div");return d.innerHTML=l.trim(),d.firstElementChild}async function Aa(t,e){if(_t)return;let r=(Array.isArray(M)?M:[]).findIndex(a=>String(a?.source_id||"").trim()===String(t||"").trim());if(r<0)return;let n=Pt||pr();Pt=n,n.add(String(t||"").trim()),_a(n),_t=!0;let s=ha().catch(()=>null),i=Qr(1).then(a=>a&&a[0]?a[0]:null).catch(()=>null);try{try{let l=e?.querySelector?.('button[data-action="close"]');l&&l.setAttribute("disabled","true")}catch{}try{e?.classList?.add("tr-explore-flip-out")}catch{}await pa(e,260);let a=await i;if(a||(a=await s),!a){M=(Array.isArray(M)?M:[]).filter(l=>String(l?.source_id||"").trim()!==String(t||"").trim()),Ct(M),await tn();return}Array.isArray(M)&&M[r]&&String(M[r]?.source_id||"").trim()===String(t||"").trim()&&(M[r]=a);let o=Ea(a,{animateIn:!0});try{e&&e.parentNode?(e.parentNode.replaceChild(o,e),zs(o)):Ct(M)}catch{Ct(M)}}finally{_t=!1;try{D!=null&&Be(D)}catch{}}}function Ys(){let t=Yt();if(!(!t||!t.classList.contains("active"))){if(M.length>0){ba()&&Ct(M);return}tn().catch(e=>{me(String(e?.message||e),{variant:"error"})})}}function Ta(t){try{if(!t||!(t instanceof Element))return!1;let e=t.closest("a.news-title");if(!e)return!1;let r=e.closest(".news-item");return r&&(c.readState&&typeof c.readState.markItemAsRead=="function"?c.readState.markItemAsRead(r):r.classList.add("read")),!0}catch{try{let r=t?.closest?.(".news-item");r&&r.classList.add("read")}catch{}return!0}}function La(){Ms||(Ms=!0,document.addEventListener("click",t=>{let e=t?.target;if(!e||!(e instanceof Element))return;let r=Yt();!r||!r.classList.contains("active")||Ta(e)},!0),document.addEventListener("click",t=>{let e=t?.target;if(!e||!(e instanceof Element))return;let r=Yt();if(!r||!r.classList.contains("active"))return;let n=e.closest('button[data-action="close"]');if(n){let i=n.closest(".platform-card"),a=String(i?.getAttribute("data-rss-source-id")||"").trim();if(!a)return;Aa(a,i).catch(o=>{me(String(o?.message||o),{variant:"error"})});return}if(e.closest('button[data-action="retry"]')){if(_t)return;if(D!=null&&Mt>0&&D>=Mt){D=0;try{Be(D)}catch{}}tn().catch(i=>{gr(String(i?.message||i||"\u52A0\u8F7D\u5931\u8D25"),{retry:!0})});return}}),document.addEventListener("change",t=>{let e=t?.target;if(!e||!(e instanceof Element))return;let r=Yt();if(!r||!r.classList.contains("active"))return;let n=e.closest('select[data-action="add-category"]');if(!n||!(n instanceof HTMLSelectElement))return;let s=n.closest(".platform-card"),i=String(s?.getAttribute("data-rss-source-id")||"").trim();if(!i)return;let a=(Array.isArray(M)?M:[]).find(w=>String(w?.source_id||"").trim()===i);if(!a||a.already_added)return;let o=String(n.value||"").trim();if(!o)return;let l=o.split(":"),d=String(l[0]||"").trim(),u=String(l[1]||"").trim();if(!u)return;let m=Fs().find(w=>String(w?.id||"").trim()===u),p=m||{id:u,name:u,icon:"\u{1F4C1}",isCustom:d==="custom"};try{n.setAttribute("disabled","true")}catch{}va(a,p).then(()=>{a.already_added=!0;try{let w=n.querySelector('option[value=""]');w&&(w.textContent="\u5DF2\u52A0\u5165"),n.value="",n.setAttribute("disabled","true")}catch{}}).catch(()=>{try{n.value=""}catch{}})}))}function ka(){try{if(!c.tabs||typeof c.tabs.switchTab!="function"||c.tabs.__trExploreEmbeddedWrapped)return;let t=c.tabs.switchTab;c.tabs.switchTab=function(e){let r=t.call(c.tabs,e);try{String(e)===Jr&&window.requestAnimationFrame(()=>{Ys()})}catch{}try{Zr&&String(e)!==Jr&&(Zr=!1,window.requestAnimationFrame(()=>{c.data?.refreshViewerData?.({preserveScroll:!0})}))}catch{}return r},c.tabs.__trExploreEmbeddedWrapped=!0}catch{}}var fr=!1;async function Ra(){if(fr||_t)return;let t=Yt(),e=ge();if(!(!t||!e)&&t.classList.contains("active")){fr=!0;try{let r=document.createElement("div");r.className="tr-explore-loading",r.style.cssText="padding:20px;text-align:center;color:#6b7280;font-size:0.9rem;",r.textContent="\u52A0\u8F7D\u4E2D...",e.appendChild(r);let n=await Qr(Ps);if(n.length){M=[...M,...n],Ct(M),r.remove();return}let s=await Bs(Ps);s.length&&(M=[...M,...s],Ct(M)),r.remove(),D!=null&&Be(D)}catch(r){console.error("Load more failed:",r)}finally{fr=!1}}}function Vs(){let t=ge();if(!t||t.dataset.trScrollAttached==="1")return;t.dataset.trScrollAttached="1";let e=null,r=()=>{e&&clearTimeout(e),e=setTimeout(()=>{e=null;let n=t.scrollLeft||0,s=t.scrollWidth||0,i=t.clientWidth||0,a=Math.max(0,s-i),o=a>0?n/a:0;console.log("[Explore] Scroll:",o.toFixed(2),"maxScrollLeft:",a),o>=.7&&!fr&&!_t&&(console.log("[Explore] Triggering load more..."),Ra().catch(()=>{}))},150)};t.addEventListener("scroll",r,{passive:!0}),console.log("[Explore] Scroll listener attached")}N(function(){if(da){La(),ka(),Vs();try{c.tabs?.getActiveTabId&&String(c.tabs.getActiveTabId())===Jr&&Ys()}catch{}}});var rn="explore",Pa="tr_tab_switched",Ma=3,Ia=20;function hr(){return window.SYSTEM_SETTINGS&&window.SYSTEM_SETTINGS.display&&window.SYSTEM_SETTINGS.display.items_per_card||50}var he=!1,pe=0,Fe=null,Vt=!1;function Na(){try{return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}catch{return null}}function $a(t){let e=Number(t||0)||0;if(!e)return"";try{let r=new Date(e*1e3),n=String(r.getFullYear()),s=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0");return`${n}-${s}-${i}`}catch{return""}}function Oa(t,e={}){let r=Array.isArray(t)?t:[];return r.length?r.map((n,s)=>{let i=h(n?.stable_id||""),a=h(n?.display_title||n?.title||""),o=h(n?.url||"#"),l=$a(n?.published_at||n?.created_at),d=l?`<span class="tr-explore-time" style="margin-left:8px;color:#9ca3af;font-size:12px;">${h(l)}</span>`:"";return`
            <li class="news-item" data-news-id="${i}" data-news-title="${a}">
                <div class="news-item-content">
                    <span class="news-index">${String(s+1)}</span>
                    <a class="news-title" href="${o}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                        ${a}
                    </a>
                    ${d}
                </div>
            </li>`}).join(""):`<li class="tr-explore-empty" aria-hidden="true">${h(e.emptyText||"\u6682\u65E0\u5185\u5BB9")}</li>`}function nn(){return document.getElementById(`tab-${rn}`)}function sn(){let t=nn();return t?t.querySelector(".platform-grid"):null}function Us(){let t=nn();if(!t)return!1;let e=t.querySelector(".platform-grid");e?e.style.overscrollBehavior="contain":(e=document.createElement("div"),e.className="platform-grid",e.style.display="flex",e.style.flexDirection="row",e.style.overflowX="auto",e.style.overflowY="hidden",e.style.alignItems="flex-start",e.style.overscrollBehavior="contain",t.appendChild(e));try{e.dataset&&(e.dataset.exploreInjected="1")}catch{}return!0}async function Da(t){let e=await fetch(t,{method:"GET"});if(!e.ok)throw new Error(`HTTP ${e.status}`);return await e.json()}async function Ks(t,e){let r=`/api/rss/explore/timeline?limit=${encodeURIComponent(String(t))}&offset=${encodeURIComponent(String(e))}`,n=await Da(r);return Array.isArray(n?.items)?n.items:[]}function Js(t,e,r){if(!t||!t.length)return;let n=document.createElement("div");n.className="platform-card tr-explore-card",n.style.minWidth="360px",n.dataset.platform=`explore-slice-${e}`,n.draggable=!1;let s=hr(),i=e*s+1,a=e*s+t.length;n.innerHTML=`
        <div class="platform-header">
            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">
                \u{1F4F0} \u6700\u65B0 ${i}-${a}
            </div>
            <div class="platform-header-actions"></div>
        </div>
        <ul class="news-list" data-explore-list="slice-${e}">
            ${Oa(t,{emptyText:"\u6682\u65E0\u5185\u5BB9"})}
        </ul>
    `,n.querySelectorAll(".news-index").forEach((d,u)=>{d.textContent=String(i+u)});let l=r.querySelector("#explore-load-sentinel");l?r.insertBefore(n,l):r.appendChild(n)}function Ba(t){let e=t.querySelector("#explore-load-sentinel");e&&e.remove();let r=document.createElement("div");return r.id="explore-load-sentinel",r.style.minWidth="20px",r.style.height="100%",r.style.flexShrink="0",r.innerHTML='<div style="width:20px;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;">\u23F3</div>',t.appendChild(r),r}function Zs(){Fe&&(Fe.disconnect(),Fe=null);let t=nn();if(!t)return;Fe=new IntersectionObserver(r=>{for(let n of r)n.isIntersecting&&Ws().catch(()=>{})},{root:t.querySelector(".platform-grid"),rootMargin:"200px",threshold:.01});let e=t.querySelector("#explore-load-sentinel");e&&(Fe.observe(e),setTimeout(()=>{let r=e.getBoundingClientRect(),n=t.querySelector(".platform-grid");n&&r.left<n.getBoundingClientRect().right&&Ws().catch(()=>{})},100))}async function Ws(){if(!(he||Vt)){he=!0;try{let t=hr();if(Math.floor(pe/t)>=Ia){Vt=!0;let s=document.getElementById("explore-load-sentinel");s&&(s.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u8FBE\u5230\u6700\u5927\u663E\u793A\u6570\u91CF</div>',s.style.width="40px");return}let r=await Ks(t,pe);if(!r.length){Vt=!0;let s=document.getElementById("explore-load-sentinel");s&&(s.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u663E\u793A\u5168\u90E8\u5185\u5BB9</div>',s.style.width="40px");return}let n=sn();if(n){let s=Math.floor(pe/hr());Js(r,s,n)}if(pe+=r.length,r.length<t){Vt=!0;let s=document.getElementById("explore-load-sentinel");s&&s.remove()}}catch(t){console.error("Explore load error:",t)}finally{he=!1}}}async function Fa(){let t=sn();if(!t)return;pe=0,Vt=!1,t.innerHTML="",Ba(t);let e=hr(),r=e*Ma,n=await Ks(r,0);if(!n.length){t.innerHTML='<div style="padding:40px;text-align:center;color:#9ca3af;width:100%;">\u6682\u65E0\u5185\u5BB9</div>';return}for(let s=0;s<n.length;s+=e){let i=n.slice(s,s+e),a=Math.floor(s/e);Js(i,a,t)}if(pe=n.length,n.length<r){Vt=!0;let s=document.getElementById("explore-load-sentinel");s&&s.remove()}else Zs()}async function Qs(t=!1){if(Na()!==rn||!Us())return!1;let e=sn();if(!t&&e&&e.querySelectorAll(".platform-card").length>0)return he=!1,!0;he=!0;try{return await Fa(),!0}catch(r){return console.error("Explore refresh error:",r),!1}finally{he=!1}}var Xs=!1;async function to(){Xs||Us()&&(Xs=!0,await Qs())}function qa(){try{window.addEventListener(Pa,t=>{let e=String(t?.detail?.categoryId||"").trim(),r=!!t?.detail?.hasUpdate;e===rn&&(Vt||Zs(),Qs(r).catch(()=>{}))})}catch{}}function Ha(){if(c.exploreTimeline&&c.exploreTimeline._patched===!0)return;let t=c.data?.renderViewerFromData;typeof t=="function"&&(c.data.renderViewerFromData=function(r,n){t.call(c.data,r,n);try{to().catch(()=>{})}catch{}},c.exploreTimeline={...c.exploreTimeline||{},_patched:!0})}N(function(){Ha(),to().catch(()=>{}),qa()});var qe=15,yr="rsscol-rss",Ga=3,on="hotnews_rss_carousel_cursor_v1",un=!1,Xt=!1,xt=[],an=0,wr=0,Ut=!1,Et=-1,B=null,ye=new Map,at=null,Kt=null,yt=0,br=!1,Sr=!1,fn=0,mn=0,Wt=null;function no(){try{return window.sessionStorage}catch{return null}}function ja(){try{let t=no();if(!t)return null;let e=t.getItem(on),r=Number(e);return!Number.isFinite(r)||r<0?null:Math.floor(r)}catch{return null}}function za(t){try{let e=no();if(!e)return;let r=Number(t);if(!Number.isFinite(r)||r<0){e.removeItem(on);return}e.setItem(on,String(Math.floor(r)))}catch{}}function so(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function Ya(t){if(!ct()||!so()||document.querySelector(".settings-modal-overlay.show")||br)return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select")||!e.closest(".rss-carousel-frame"))return;let r=t?.touches;!r||r.length!==1||(Sr=!0,Wt=null,fn=Number(r[0]?.clientX||0),mn=Number(r[0]?.clientY||0))}function Va(t){if(!Sr||!ct())return;let e=t?.touches;if(!e||e.length!==1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-fn,i=n-mn,a=Math.abs(s),o=Math.abs(i);if(!Wt){if(a<10&&o<10)return;Wt=a>=o?"x":"y"}try{t.preventDefault()}catch{}}function eo(t){if(!Sr||(Sr=!1,!ct())||!so())return;let e=t?.changedTouches;if(!e||e.length<1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-fn,i=n-mn,a=Math.abs(s),o=Math.abs(i),l=44;if((Wt==="x"||Wt==null)&&a>=l&&a>o){s<0?Se():Ge();return}(Wt==="y"||Wt==null)&&o>=l&&o>a&&(i<0?we(-1):we(1))}function oo(){try{return c.tabs?.getActiveTabId?c.tabs.getActiveTabId():null}catch{return null}}function Wa(t){if(!ct())return;let e=async()=>{if(Xt||at!=null)return;let r=[];for(let s=1;s<=Ga;s+=1)r.push(t+s);let n=Math.max(...r);Number.isFinite(n)&&n>=0&&await He(n);for(let s of r)try{if(s<0)continue;await He(s);let i=xt[s];if(!i)continue;await uo(i)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>e().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>e().catch(()=>{}),0)}function gn(){return document.getElementById("rssCategoryPickerModal")}function Xa(){if(gn())return;let t=document.createElement("div");t.id="rssCategoryPickerModal",t.className="settings-modal-overlay",t.style.zIndex="9999",t.addEventListener("click",r=>{r&&r.target===t&&cn()}),t.innerHTML=`
        <div class="settings-modal" onclick="event.stopPropagation()" style="max-width:520px;">
            <div class="settings-modal-header">
                <span class="settings-modal-title">\u52A0\u5165\u680F\u76EE</span>
                <button class="settings-modal-close" type="button" data-action="close">&times;</button>
            </div>
            <div class="settings-modal-body" style="display:flex;flex-direction:column;gap:10px;">
                <div style="color:#6b7280;font-size:0.9rem;">\u9009\u62E9\u8981\u52A0\u5165\u7684\u680F\u76EE</div>
                <div id="rssCategoryPickerList" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
        </div>`;let e=t.querySelector('button[data-action="close"]');e&&e.addEventListener("click",()=>cn());try{document.body.appendChild(t)}catch{}}function cn(){let t=gn();t&&(br=!1,t.classList.remove("show"))}function ro(){let t=c.settings?.getMergedCategoryConfig?c.settings.getMergedCategoryConfig():null,e=c.settings?.getDefaultCategories?c.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],i=new Set;for(let a of r){let o=String(a||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=n.find(m=>String(m?.id||"")===o);if(l){let m=String(l?.name||o).trim()||o;s.push({id:o,name:m,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[o]?e[o]:null;if(!d)continue;let u=String(d?.name||o).trim()||o,f=String(d?.icon||"\u{1F4C1}");s.push({id:o,name:u,icon:f,isCustom:!1})}for(let a of n){let o=String(a?.id||"").trim();if(!o||i.has(o)||o==="explore"||o.startsWith("rsscol-"))continue;i.add(o);let l=String(a?.name||o).trim()||o;s.push({id:o,name:l,icon:"\u{1F4F1}",isCustom:!0})}return s}function io(){Xa();let t=gn();if(!t)return;let e=t.querySelector("#rssCategoryPickerList");if(e){let r=ro();e.innerHTML=r.map(n=>`
                <button type="button" class="platform-select-action-btn" data-cat-id="${h(n.id)}" style="text-align:left;">
                    ${h(n.icon)} ${h(n.name)}
                </button>`).join(""),e.querySelectorAll("button[data-cat-id]").forEach(n=>{n.addEventListener("click",async()=>{let s=String(n.getAttribute("data-cat-id")||"").trim(),a=ro().find(l=>l.id===s),o=a||{id:s,name:s,icon:"\u{1F4C1}",isCustom:!1};cn(),await Ua(o)})})}br=!0,t.classList.add("show");try{let r=t.querySelector(".settings-modal");r&&(r.setAttribute("tabindex","0"),r.focus())}catch{}}async function Ua(t){if(!B||!B.source_id)return;let e=String(t?.id||"").trim(),r=String(t?.name||e).trim()||e||"RSS",n=!!t?.isCustom,s=String(B.source_id||"").trim(),i=s?`rss-${s}`:"",a="RSS";e&&e!=="rsscol-rss"&&!n&&(a=e);try{c.subscription?.ensureSnapshot?.()}catch{}try{c.subscription?.stageFromCatalogPreview?.({source_id:B.source_id,url:B.url,feed_title:B.feed_title||B.platform_name,column:a,entries_count:B.entries_count||0})}catch(o){it(String(o?.message||o),{variant:"error"});return}if(n&&e&&i)try{c.settings?.addPlatformToCustomCategory?.(e,i)}catch{}B.already_added=!0;try{pn(B)}catch{}try{c.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"loading",durationMs:1200})}catch{}try{c.subscription?.saveOnly?await c.subscription.saveOnly():c.subscription?.saveAndRefresh?await c.subscription.saveAndRefresh():await window.saveRssSubscriptions?.()}catch(o){it(String(o?.message||o),{variant:"error"});try{c.toast?.show?.(`\u52A0\u5165\u5931\u8D25\uFF1A${String(o?.message||o)}`,{variant:"error",durationMs:2500})}catch{}return}try{lo([B.source_id],"high").catch(()=>{})}catch{}try{c.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}}function ct(){return un&&oo()===yr}function ln(){return document.getElementById("rssCategoryCarouselGrid")}function Ka(){return document.getElementById("rssCategoryCarouselStatus")}function it(t,e={}){let r=Ka();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function ao(t){let e=Number(t||0)||0;if(!e)return"";let r=new Date(e);if(Number.isNaN(r.getTime()))return"";let n=o=>String(o).padStart(2,"0"),s=String(r.getFullYear()),i=n(r.getMonth()+1),a=n(r.getDate());return`${s}-${i}-${a}`}function co(t){let e=[t?.published,t?.published_at,t?.pubDate,t?.updated,t?.updated_at,t?.date,t?.datetime,t?.date_published,t?.date_modified],n=Date.now()+365*24*60*60*1e3,s=i=>{let a=Number(i);return!Number.isFinite(a)||a<=0?0:a<1e11?Math.floor(a*1e3):Math.floor(a)};for(let i of e){if(i==null)continue;if(typeof i=="number"){let l=s(i);if(l>0&&l<=n)return l;continue}let a=String(i).trim();if(!a)continue;if(/^\d{10,13}$/.test(a)){let l=s(a);if(l>0&&l<=n)return l;continue}let o=Date.parse(a);if(!Number.isNaN(o)&&o>0)return o}return 0}async function lo(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function Ja(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let i=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,o=Number(s?.next_offset??e+i.length)||e+i.length;return{items:i,total:a,nextOffset:o}}async function He(t){let e=Number(t);if(!Number.isFinite(e)||e<0||Ut)return;let r=0;for(;xt.length<=e&&!Ut&&r<50;){r+=1;let n=await Ja(50,wr);an=n.total,wr=n.nextOffset;for(let s of n.items)String(s?.id||"").trim()&&xt.push(s);(!n.items.length||wr>=an)&&(Ut=!0)}}async function Za(){if(Ut)return;let t=0;for(;!Ut&&t<200&&(t+=1,await He(xt.length),!Ut););}function Qa(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function tc(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(i=>{let a=String(i?.title||"").trim(),o=String(i?.link||"").trim(),l=co(i);return{title:a||o,link:o,ts:l}}).filter(i=>!!i.link);return{feedTitle:r,entries:s}}function ec(){let t=c.subscription?.getSubscriptions?c.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}async function uo(t){let e=String(t?.id||"").trim();if(!e)return null;if(ye.has(e))return ye.get(e);let r=String(t?.url||"").trim(),n=Qa(t),s=ec(),i=[],a="",o=null;try{let m=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`);if(o=await m.json().catch(()=>({})),!m.ok)throw new Error(o?.detail||"Preview failed");let p=tc(o);a=p.feedTitle,i=p.entries}catch(m){let p={source_id:e,error:String(m?.message||m)};return ye.set(e,p),p}if(!Array.isArray(i)||i.length<=0){let m={source_id:e,error:"No entries"};return ye.set(e,m),m}let l=0;for(let m of i){let p=Number(m?.ts||0)||0;p>l&&(l=p)}if(!l&&o){let m=co({published:o?.last_modified||o?.data?.feed?.updated||o?.data?.feed?.published||o?.data?.feed?.lastBuildDate});m>l&&(l=m)}let d=ao(l),f={source_id:e,url:r,feed_title:a||n,platform_name:a||n,entries:i,entries_count:i.length,date_str:d,error:"",already_added:s.has(e)};return ye.set(e,f),f}function pn(t){let e=ln();if(!e)return;let r=t,n=String(r?.source_id||"").trim(),s=h(r?.platform_name||"RSS"),i=r?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE",a=r?.already_added?"disabled":"",o=Array.isArray(r?.entries)?r.entries:[],l=Math.max(0,Math.ceil(o.length/qe)-1);yt>l&&(yt=l),yt<0&&(yt=0);let d=yt*qe,u=o.slice(d,d+qe),f=u.map((T,y)=>{let A=h(T?.title||""),b=h(T?.link||"#"),E=h(ao(T?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${A}">
                <div class="news-item-content">
                    <span class="news-index">${String(d+y+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${b}" target="_blank" rel="noopener noreferrer">${A}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${E?"":"display:none;"}">${E}</span>
                </div>
            </li>`}).join(""),m=Math.max(0,qe-u.length),p=m?Array.from({length:m}).map((T,y)=>{let A=d+u.length+y+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(A)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";e.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${h(n)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${s}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <button type="button" class="platform-select-action-btn" data-action="add" ${a}>${i}</button>
                    </div>
                </div>
                <ul class="news-list">${f}${p}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{e.querySelectorAll(".news-title").forEach(y=>{y instanceof HTMLElement&&(y.closest(".rss-entry-placeholder")||(y.classList.remove("tr-title-overflow-shrink"),y.scrollWidth>y.clientWidth+1&&y.classList.add("tr-title-overflow-shrink")))})})}catch{}let w=e.querySelector('button[data-action="add"]');w&&w.addEventListener("click",()=>{B&&(br||B.already_added||(it("",{variant:"info"}),io()))})}async function vr(t,e=1){if(!Xt){Xt=!0,Kt=Number(t);try{if(await He(t),xt.length<=0){let a=ln();a&&(a.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),it("",{variant:"info"});return}let r=t,n=e>=0?1:-1,s=0;for(;s<200;){s+=1,r<0&&(await Za(),r=xt.length-1),await He(r),r>=xt.length&&(r=0);let a=xt[r];if(!a){r+=n;continue}let o=await uo(a);if(!o||o.error){r+=n;continue}Et=r,za(Et),B=o,yt=0,pn(o),it("",{variant:"info"});try{lo([o.source_id],"normal").catch(()=>{})}catch{}try{Wa(r)}catch{}return}let i=ln();i&&(i.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),it("",{variant:"info"})}catch(r){it(String(r?.message||r),{variant:"error"})}finally{if(Xt=!1,Kt=null,ct()&&at!=null){let r=Number(at);at=null;let n=Number.isFinite(Et)?Et:0,s=r>=n?1:-1;vr(r,s).catch(i=>it(String(i?.message||i),{variant:"error"}))}}}}function Se(){if(!ct())return;if(Xt){at=(at!=null?Number(at):Kt!=null?Number(Kt):Et)+1;return}let t=Et+1;vr(t,1).catch(e=>it(String(e?.message||e),{variant:"error"}))}function Ge(){if(!ct())return;if(Xt){at=(at!=null?Number(at):Kt!=null?Number(Kt):Et)-1;return}let t=Et-1;vr(t,-1).catch(e=>it(String(e?.message||e),{variant:"error"}))}function rc(){Xt=!1,at=null,Kt=null,xt=[],an=0,wr=0,Ut=!1,Et=-1,B=null,ye=new Map,yt=0}function we(t){if(!ct()||!B)return;let e=Array.isArray(B?.entries)?B.entries:[],r=Math.max(0,Math.ceil(e.length/qe)-1),n=Math.max(0,Math.min(r,yt+t));n!==yt&&(yt=n,pn(B))}function dn(){un=!0;try{c.subscription?.ensureSnapshot?.()}catch{}rc();let t=ja();vr(t??0,1).catch(r=>it(String(r?.message||r),{variant:"error"}))}function fo(){un=!1}window.rssCategoryCarouselNext=()=>Se();window.rssCategoryCarouselPrev=()=>Ge();window.rssCategoryCarouselAddToCategory=()=>{ct()&&B&&(B.already_added||io())};c.rssCategoryCarousel={open:dn,close:fo,next:Se,prev:Ge};N(function(){try{let t=c.tabs?.switchTab;typeof t=="function"&&(c.tabs.switchTab=function(e){t.call(c.tabs,e);try{String(e)===yr?dn():fo()}catch{}})}catch{}document.addEventListener("keydown",t=>{if(!ct()||document.querySelector(".settings-modal-overlay.show"))return;let e=t?.target;if(!(e&&e instanceof Element&&e.closest("input,textarea,select"))){if(t.key===" "||t.key==="Spacebar"||t.code==="Space"){t.preventDefault(),Se();return}if(t.key==="ArrowUp"){t.preventDefault(),we(-1);return}if(t.key==="ArrowDown"){t.preventDefault(),we(1);return}if(t.key==="ArrowRight"){t.preventDefault(),Se();return}if(t.key==="ArrowLeft"){t.preventDefault(),Ge();return}}}),document.addEventListener("click",t=>{if(!ct()||document.querySelector(".settings-modal-overlay.show"))return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select"))return;let r=document.getElementById(`tab-${yr}`);if(!r)return;let n=Number(t?.clientX||0),s=Number(t?.clientY||0),i=r.querySelector("#rssCategoryCarouselGrid .platform-card");if(!i)return;let a=i.getBoundingClientRect(),o=140,l=a.left-o,d=a.right+o,u=a.top-o,f=a.bottom+o;if(!(n<l||n>d||s<u||s>f)&&!(n>=a.left&&n<=a.right&&s>=a.top&&s<=a.bottom)){if(s<a.top){we(-1);return}if(s>a.bottom){we(1);return}if(n<a.left){Ge();return}if(n>a.right){Se();return}}}),document.addEventListener("touchstart",Ya,{passive:!0}),document.addEventListener("touchmove",Va,{passive:!1}),document.addEventListener("touchend",eo,{passive:!0}),document.addEventListener("touchcancel",eo,{passive:!0});try{oo()===yr&&dn()}catch{}});function Jt(t){let e=t;return e?e.nodeType===3?e.parentElement||null:e:null}function be(t){if(!t)return!1;let e=t.scrollWidth||0,r=t.clientWidth||0;return e>r+1}function mo(t){return Jt(t)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function hn(t){let e=Jt(t);return!e?.closest||e.closest(".platform-drag-handle")?!1:!!e.closest(".platform-header")||!!e.closest(".platform-name")}N(()=>{let e=null,r=!1,n=null,s=0,i=0,a=!1,o=0,l=null,d=0,u=0,f=0,m=.92,p=.5;function w(){l&&(cancelAnimationFrame(l),l=null),d=0}function T(g){if(!g)return null;let S=Array.from(g.querySelectorAll(".platform-card"));if(S.length===0)return null;let C=g.getBoundingClientRect().left,k=g.scrollLeft||0,P=null,$=1/0;for(let z of S){let J=z.getBoundingClientRect().left,St=Math.abs(J-C);St<$&&($=St,P=z)}return P?P.offsetLeft||0:null}function y(g){if(!g)return;let S=T(g);if(S===null)return;let v=Math.max(0,(g.scrollWidth||0)-(g.clientWidth||0)),C=Math.max(0,Math.min(v,S));g.scrollTo({left:C,behavior:"smooth"})}function A(g,S){if(!g||!be(g))return;w(),d=S;function v(){if(Math.abs(d)<p){w(),setTimeout(()=>y(g),100);return}d*=m;let C=Math.max(0,(g.scrollWidth||0)-(g.clientWidth||0)),k=g.scrollLeft||0,P=Math.max(0,Math.min(C,k+d));if(g.scrollLeft=P,P<=0||P>=C){w(),setTimeout(()=>y(g),100);return}l=requestAnimationFrame(v)}l=requestAnimationFrame(v)}let b=!1,E=null,x=0,F=null;function X(){if(b=!1,!E||!be(E)){x=0;return}let g=x;if(x=0,!g)return;let S=Math.max(0,(E.scrollWidth||0)-(E.clientWidth||0)),v=E.scrollLeft||0,C=Math.max(0,Math.min(S,v+g));E.scrollLeft=C,F&&clearTimeout(F),F=setTimeout(()=>{F=null,y(E)},150)}let I=()=>{let S=performance.now()-u,v=0;a&&n&&S>0&&S<100&&(v=-(f-s)/(S/16),v=Math.max(-50,Math.min(50,v)));let C=n;e=null,r=!1,n=null,s=0,i=0,a=!1,u=0,f=0;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}C&&Math.abs(v)>2&&A(C,v)},j=(g,S,v=!1)=>{if(v){let k=Jt(g)?.closest?.(".platform-card");if(!k)return!1;let P=k.closest(".platform-grid");if(!P||!be(P))return!1;w(),n=P,s=S,i=P.scrollLeft||0,a=!1,u=performance.now(),f=S;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0}if(!hn(g)||document.querySelector(".platform-card.dragging"))return!1;let C=mo(g);if(!C||!be(C))return!1;w(),n=C,s=S,i=C.scrollLeft||0,a=!1,u=performance.now(),f=S;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",g=>{if(g.button!==0&&g.button!==1)return;let S=Jt(g.target),v=g.button===1;if(j(S,g.clientX,v)&&(e=g.pointerId,v))try{g.preventDefault()}catch{}},{passive:!1}),document.addEventListener("mousedown",g=>{if(g.button!==0&&g.button!==1||e!==null)return;let S=Jt(g.target),v=g.button===1;if(j(S,g.clientX,v)&&(r=!0,v))try{g.preventDefault()}catch{}},{passive:!1}),document.addEventListener("pointermove",g=>{if(e===null||g.pointerId!==e||!n)return;if(document.querySelector(".platform-card.dragging")){I();return}let S=g.clientX-s;if(!a&&Math.abs(S)<4)return;a=!0;try{g.preventDefault()}catch{}u=performance.now(),f=g.clientX;let v=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),C=Math.max(0,Math.min(v,i-S));n.scrollLeft=C},{passive:!1}),document.addEventListener("mousemove",g=>{if(!r||!n)return;if(document.querySelector(".platform-card.dragging")){I();return}let S=g.clientX-s;if(!a&&Math.abs(S)<4)return;a=!0;try{g.preventDefault()}catch{}u=performance.now(),f=g.clientX;let v=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),C=Math.max(0,Math.min(v,i-S));n.scrollLeft=C},{passive:!1});let wt=()=>{e!==null&&(a&&(o=Date.now()+600),I())};document.addEventListener("pointerup",wt,{passive:!0}),document.addEventListener("pointercancel",wt,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(a&&(o=Date.now()+600),I())},{passive:!0}),document.addEventListener("click",g=>{if(Date.now()>o)return;let v=Jt(g.target);if(hn(v)){try{g.preventDefault()}catch{}try{g.stopPropagation()}catch{}try{g.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",g=>{let S=typeof document.elementFromPoint=="function"?document.elementFromPoint(g.clientX,g.clientY):null,v=Jt(S||g.target);if(!g.shiftKey||!hn(v)||document.querySelector(".platform-card.dragging"))return;let C=mo(v);if(!C||!be(C))return;w();let k=typeof g.deltaX=="number"&&g.deltaX!==0?g.deltaX:g.deltaY;if(g.deltaMode===1?k*=20:g.deltaMode===2&&(k*=C.clientWidth||100),!!k){try{g.preventDefault()}catch{}E=C,x+=k,b||(b=!0,requestAnimationFrame(X))}},{passive:!1});function _(g,S){if(!g)return;let v=Array.from(g.querySelectorAll(".platform-card"));if(v.length===0)return;let k=g.getBoundingClientRect().left,P=g.scrollLeft||0,$=0,Y=1/0;v.forEach((J,St)=>{let xr=J.getBoundingClientRect(),Ve=Math.abs(xr.left-k);Ve<Y&&(Y=Ve,$=St)});let z=Math.max(0,Math.min(v.length-1,$+S));if(z===$&&Y<10){let J=Math.max(0,Math.min(v.length-1,$+S));if(J!==$){let St=v[J];St&&(w(),g.scrollTo({left:St.offsetLeft||0,behavior:"smooth"}))}return}let et=v[z];et&&(w(),g.scrollTo({left:et.offsetLeft||0,behavior:"smooth"}))}function L(){let g=document.querySelector(".tab-pane.active");if(!g||(g.id||"")==="tab-rsscol-rss")return null;let v=g.querySelector(".platform-grid");return!v||!be(v)?null:v}document.addEventListener("keydown",g=>{let S=g.target;if(S&&S instanceof Element&&S.closest("input,textarea,select")||document.querySelector(".settings-modal-overlay.show")||document.getElementById("rssCatalogPreviewModal")?.classList.contains("show")||g.key!=="ArrowLeft"&&g.key!=="ArrowRight")return;let v=L();v&&(g.preventDefault(),_(v,g.key==="ArrowRight"?1:-1))})});var wn="knowledge";var wl=2*3600,nc="tr_tab_switched",sc=3e5,oc=3;function _r(){return window.SYSTEM_SETTINGS&&window.SYSTEM_SETTINGS.display&&window.SYSTEM_SETTINGS.display.morning_brief_items||50}var ze=!1,yn=0,go=null,Ye=0,je=null,ve=!1;function ic(){try{return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}catch{return null}}function ac(t){try{c.paging?.setCardPageSize?.(t,50),c.paging?.applyPagingToCard?.(t,0)}catch{}}function cc(t){let e=Number(t||0)||0;if(!e)return"";try{let r=new Date(e*1e3),n=String(r.getFullYear()),s=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0");return`${n}-${s}-${i}`}catch{return""}}function lc(t,e={}){let r=Array.isArray(t)?t:[];return r.length?r.map((n,s)=>{let i=h(n?.stable_id||""),a=h(n?.display_title||n?.title||""),o=h(n?.url||"#"),l=cc(n?.published_at||n?.created_at),d=l?`<span class="tr-mb-time" style="margin-left:8px;color:#9ca3af;font-size:12px;">${h(l)}</span>`:"";return`
            <li class="news-item" data-news-id="${i}" data-news-title="${a}">
                <div class="news-item-content">
                    <span class="news-index">${String(s+1)}</span>
                    <a class="news-title" href="${o}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                        ${a}
                    </a>
                    ${d}
                </div>
            </li>`}).join(""):`<li class="tr-mb-empty" aria-hidden="true">${h(e.emptyText||"\u6682\u65E0\u5185\u5BB9")}</li>`}function Cr(){return document.getElementById(`tab-${wn}`)}function po(){let t=Cr();return t?t.querySelector(".platform-grid"):null}function ho(){let t=Cr();if(!t)return!1;let e=t.querySelector(".platform-grid");e?e.style.overscrollBehavior="contain":(e=document.createElement("div"),e.className="platform-grid",e.style.display="flex",e.style.flexDirection="row",e.style.overflowX="auto",e.style.overflowY="hidden",e.style.alignItems="flex-start",e.style.overscrollBehavior="contain",t.appendChild(e));try{e.dataset&&(e.dataset.mbInjected="1")}catch{}return!0}async function dc(t){let e=await fetch(t,{method:"GET"});if(!e.ok)throw new Error(`HTTP ${e.status}`);return await e.json()}async function yo(t,e){let r=`/api/rss/brief/timeline?limit=${encodeURIComponent(String(t))}&offset=${encodeURIComponent(String(e))}&drop_published_at_zero=0`,n=await dc(r);return Array.isArray(n?.items)?n.items:[]}function wo(t,e,r){if(!t||!t.length)return;let n=document.createElement("div");n.className="platform-card tr-morning-brief-card",n.style.minWidth="360px",n.dataset.platform=`mb-slice-${e}`,n.draggable=!1;let s=_r(),i=e*s+1,a=e*s+t.length;n.innerHTML=`
        <div class="platform-header">
            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">
                \u{1F552} \u6700\u65B0 ${i}-${a}
            </div>
            <div class="platform-header-actions"></div>
        </div>
        <ul class="news-list" data-mb-list="slice-${e}">
            ${lc(t,{emptyText:"\u6682\u65E0\u5185\u5BB9"})}
        </ul>
    `,n.querySelectorAll(".news-index").forEach((d,u)=>{d.textContent=String(i+u)});let l=r.querySelector("#mb-load-sentinel");l?r.insertBefore(n,l):r.appendChild(n),ac(n)}function uc(t){let e=t.querySelector("#mb-load-sentinel");e&&e.remove();let r=document.createElement("div");return r.id="mb-load-sentinel",r.style.minWidth="20px",r.style.height="100%",r.style.flexShrink="0",r.innerHTML='<div style="width:20px;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;">\u23F3</div>',t.appendChild(r),r}function So(){je&&(je.disconnect(),je=null);let t=Cr();if(!t)return;je=new IntersectionObserver(r=>{for(let n of r)n.isIntersecting&&fc().catch(()=>{})},{root:t.querySelector(".platform-grid"),rootMargin:"200px",threshold:.01});let e=t.querySelector("#mb-load-sentinel");e&&je.observe(e)}async function fc(){if(!(ze||ve)){ze=!0;try{let t=_r(),e=await yo(t,Ye);if(!e.length){ve=!0;let n=document.getElementById("mb-load-sentinel");n&&(n.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u663E\u793A\u5168\u90E8\u5185\u5BB9</div>',n.style.width="40px");return}let r=po();if(r){let n=Math.floor(Ye/_r());wo(e,n,r)}if(Ye+=e.length,e.length<t){ve=!0;let n=document.getElementById("mb-load-sentinel");n&&n.remove()}}catch{}finally{ze=!1}}}async function mc(){let t=po();if(!t)return;Ye=0,ve=!1,t.innerHTML="",uc(t);let e=_r(),r=e*oc,n=await yo(r,0);if(!n.length){t.innerHTML='<div style="padding:40px;text-align:center;color:#9ca3af;width:100%;">\u6682\u65E0\u5185\u5BB9</div>';return}for(let s=0;s<n.length;s+=e){let i=n.slice(s,s+e),a=Math.floor(s/e);wo(i,a,t)}if(Ye=n.length,n.length<r){ve=!0;let s=document.getElementById("mb-load-sentinel");s&&s.remove()}else So()}async function Sn(t={}){let e=t.force===!0;if(ic()!==wn)return!1;let r=Date.now();if(!e&&yn>0&&r-yn<sc-5e3||!ho())return!1;ze=!0;try{return await mc(),yn=Date.now(),!0}catch{return!1}finally{ze=!1}}function gc(){let t=Cr();if(t&&!(t.dataset&&t.dataset.mbBound==="1")){t.addEventListener("click",e=>{let r=e.target;if(!r||!(r instanceof Element))return;r.closest('[data-action="mb-refresh"]')&&(e.preventDefault(),Sn({force:!0}).catch(()=>{try{c.toast?.show("\u5237\u65B0\u5931\u8D25",{variant:"error",durationMs:2e3})}catch{}}))});try{t.dataset&&(t.dataset.mbBound="1")}catch{}}}async function bo(){ho()&&(gc(),await Sn({force:!1}))}function pc(){try{window.addEventListener(nc,t=>{String(t?.detail?.categoryId||"").trim()===wn&&(ve||So(),clearTimeout(go),go=setTimeout(()=>{Sn({force:!1}).catch(()=>{})},120))})}catch{}}function hc(){if(c.morningBrief&&c.morningBrief._patched===!0)return;let t=c.data?.renderViewerFromData;typeof t=="function"&&(c.data.renderViewerFromData=function(r,n){t.call(c.data,r,n);try{bo().catch(()=>{})}catch{}},c.morningBrief={...c.morningBrief||{},_patched:!0})}N(function(){hc(),bo().catch(()=>{}),pc()});var _o="hotnews_mobile_top_collapsed_v1",Co="tr-mobile-top-collapsed";function vo(t){let e=!!t;try{document.body.classList.toggle(Co,e)}catch{}try{localStorage.setItem(_o,e?"1":"0")}catch{}try{let r=document.getElementById("trFooterTopToggle");r&&(r.textContent=e?"\u663E\u793A\u9876\u90E8":"\u9690\u85CF\u9876\u90E8")}catch{}}function yc(){let t=!0;try{let e=localStorage.getItem(_o);e==="0"&&(t=!1),e==="1"&&(t=!0)}catch{}try{new URLSearchParams(window.location.search).get("e2e")==="1"&&(t=!1)}catch{}vo(t);try{let e=document.getElementById("trFooterTopToggle");if(!e||e.dataset.bound==="1")return;e.dataset.bound="1",e.setAttribute("role","button"),e.setAttribute("aria-label","\u663E\u793A\u6216\u9690\u85CF\u9876\u90E8\u680F"),e.addEventListener("click",()=>{let r=!document.body.classList.contains(Co);if(vo(r),!r)try{window.scrollTo({top:0,behavior:"smooth"})}catch{}})}catch{}}N(function(){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"){try{let n=document.getElementById("early-hide");n&&n.remove()}catch{}try{let n=document.querySelector(".category-tabs");n&&n instanceof HTMLElement&&(n.style.display="flex")}catch{}try{let n=document.querySelector(".tab-content-area");n&&n instanceof HTMLElement&&(n.style.display="block")}catch{}}}catch{}if(yc(),localStorage.getItem("category_settings_badge_dismissed")==="true"){let r=document.getElementById("categorySettingsNewBadge");r&&(r.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let r=document.getElementById("rssSubscriptionNewBadge");r&&(r.style.display="none")}let t=c.settings.getCategoryConfig();if(t&&(t.customCategories&&t.customCategories.length>0||t.hiddenDefaultCategories&&t.hiddenDefaultCategories.length>0||t.categoryOrder&&t.categoryOrder.length>0||t.platformOrder&&typeof t.platformOrder=="object"&&Object.keys(t.platformOrder).length>0)){c.data.refreshViewerData({preserveScroll:!1});try{window.setTimeout(()=>{try{if(document.body.classList.contains("categories-ready"))return}catch{}try{let r=document.getElementById("early-hide");r&&r.remove()}catch{}try{let r=document.querySelector(".category-tabs");r&&r instanceof HTMLElement&&(r.style.display="flex")}catch{}try{let r=document.querySelector(".tab-content-area");r&&r instanceof HTMLElement&&(r.style.display="block")}catch{}try{document.body.classList.add("categories-ready")}catch{}},2500)}catch{}}else document.body.classList.add("categories-ready")});})();
