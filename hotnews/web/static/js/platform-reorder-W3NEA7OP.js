import{a as m,b as Y}from"./chunk-EMYW6RDC.js";function G(g){let x=g?.closest?.(".tab-pane")?.id||"";return x.startsWith("tab-")?x.slice(4):null}function z(g,_,x){let u=Array.from(g.querySelectorAll(".platform-card:not(.dragging):not(.platform-card-placeholder)")),v=null,c=1/0;for(let a of u){let f=a.getBoundingClientRect(),w=f.left+f.width/2,E=f.top+f.height/2,R=_-w,b=x-E,p=R*R+b*b;p<c&&(c=p,v={card:a,rect:f,cx:w,cy:E})}return v}function F(g,_){if(!g||!Array.isArray(_))return;let x=m.settings.getCategoryConfig()||m.settings.getDefaultCategoryConfig(),u=m.settings.normalizeCategoryConfig(x);if((m.settings.getMergedCategoryConfig().customCategories||[]).find(a=>a.id===g)){let a=(u.customCategories||[]).findIndex(f=>f.id===g);a>=0&&(u.customCategories[a]={...u.customCategories[a],platforms:_})}else(!u.platformOrder||typeof u.platformOrder!="object")&&(u.platformOrder={}),u.platformOrder[g]=_;m.settings.saveCategoryConfig(u)}var P={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_pointerId:null,_ghostEl:null,_placeholderEl:null,_ghostRaf:null,_ghostClientX:0,_ghostClientY:0,_ghostOffsetX:0,_ghostOffsetY:0,_prevUserSelect:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,_reorderRaf:null,_reorderGrid:null,_reorderX:0,_reorderY:0,_reorderOverCard:null,attach(){if(this._attached)return;this._attached=!0;let g=80,_=35,x=1400,u=5200,v=5200,c=null,a=null,f=null,w=()=>{c||a||(c=document.createElement("div"),c.className="tr-drag-edge-arrow tr-drag-edge-arrow-left",c.innerHTML="\u25C0",c.style.cssText=`
                position: fixed;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 60px;
                height: 120px;
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.9) 0%, rgba(99, 102, 241, 0.3) 100%);
                color: white;
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                border-radius: 0 12px 12px 0;
                pointer-events: all;
                transition: background 0.2s;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            `,c.style.opacity="0.25",a=document.createElement("div"),a.className="tr-drag-edge-arrow tr-drag-edge-arrow-right",a.innerHTML="\u25B6",a.style.cssText=`
                position: fixed;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 60px;
                height: 120px;
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.9) 100%);
                color: white;
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                border-radius: 12px 0 0 12px;
                pointer-events: all;
                transition: background 0.2s;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            `,a.style.opacity="0.25",document.body.appendChild(c),document.body.appendChild(a))},E=()=>{c&&(c.remove(),c=null),a&&(a.remove(),a=null),f&&(cancelAnimationFrame(f),f=null)},R=(t,e)=>{f&&cancelAnimationFrame(f);let r=0,o=0,l=i=>{if(!e)return;r||(r=i),o||(o=i);let n=Math.max(0,i-o);o=i;let s=Math.max(0,i-r),d=Math.min(u,x+s/1e3*v),C=Math.max(0,(e.scrollWidth||0)-(e.clientWidth||0)),S=t*d*(n/1e3),L=Math.max(0,Math.min(C,(e.scrollLeft||0)+S));e.scrollLeft=L,f=requestAnimationFrame(l)};f=requestAnimationFrame(l)},b=()=>{f&&(cancelAnimationFrame(f),f=null)},p=(t,e)=>{c&&(c.style.opacity=t?"1":"0.25"),a&&(a.style.opacity=e?"1":"0.25")},y=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},k=()=>{this._ghostRaf&&cancelAnimationFrame(this._ghostRaf),this._ghostRaf=null},I=(t,e)=>{this._ghostClientX=t,this._ghostClientY=e,!this._ghostRaf&&(this._ghostRaf=requestAnimationFrame(()=>{if(this._ghostRaf=null,!this._ghostEl)return;let r=this._ghostClientX-this._ghostOffsetX,o=this._ghostClientY-this._ghostOffsetY;this._ghostEl.style.transform=`translate3d(${r}px, ${o}px, 0)`}))},T=()=>{if(this._autoScrollRaf)return;let t=0,e=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){y();return}let r=this._autoScrollGrid,o=Math.max(0,(r.scrollWidth||0)-(r.clientWidth||0));if(o<=0){y();return}let l=performance.now();t||(t=l);let i=Math.max(0,l-t);t=l;let n=this._autoScrollSpeed*(i/16.6667),s=Math.max(0,Math.min(o,(r.scrollLeft||0)+this._autoScrollDir*n));r.scrollLeft=s,this._autoScrollRaf=requestAnimationFrame(e)};this._autoScrollRaf=requestAnimationFrame(e)},B=(t,e)=>{if(!this._draggingCard||!e)return y(),p(!1,!1),b(),"none";let r=t.clientX;if(c&&a){let L=c.getBoundingClientRect(),D=a.getBoundingClientRect();if(r>=L.left&&r<=L.right)return p(!0,!1),y(),R(-1,e),"arrow";if(r>=D.left&&r<=D.right)return p(!1,!0),y(),R(1,e),"arrow";b()}if(Math.max(0,(e.scrollWidth||0)-(e.clientWidth||0))<=0)return y(),p(!1,!1),"none";let l=e.getBoundingClientRect(),i=r-l.left,n=l.right-r,s=0,d=0;if(i>=0&&i<=g)s=-1,d=i;else if(n>=0&&n<=g)s=1,d=n;else return p(!1,!1),y(),"none";p(s===-1,s===1);let C=Math.max(0,Math.min(1,(g-d)/g)),S=Math.max(1,Math.round(C*C*_));return this._autoScrollGrid=e,this._autoScrollDir=s,this._autoScrollSpeed=S,T(),"edge"},M=()=>{this._reorderRaf&&cancelAnimationFrame(this._reorderRaf),this._reorderRaf=null,this._reorderGrid=null,this._reorderOverCard=null},q=()=>{if(this._reorderRaf)return;let t=()=>{this._reorderRaf=null;let e=this._reorderGrid,r=this._placeholderEl||this._draggingCard;if(!e||!r)return;let o=this._reorderOverCard;if((!o||o===r||!e.contains(o)||o.classList?.contains?.("platform-card-placeholder"))&&(o=z(e,this._reorderX,this._reorderY)?.card||null),!o||o===r)return;let l=o.getBoundingClientRect(),n=this._reorderX<l.left+l.width/2?o:o.nextSibling;n===r||n===r.nextSibling||e.insertBefore(r,n)};this._reorderRaf=requestAnimationFrame(t)},X=(t,e,r)=>{!this._draggingCard||!e||(this._reorderGrid=e,this._reorderX=t.clientX,this._reorderY=t.clientY,this._reorderOverCard=r,q())},N=()=>{this._ghostEl&&(this._ghostEl.remove(),this._ghostEl=null),k(),this._prevUserSelect!=null&&(document.body.style.userSelect=this._prevUserSelect,this._prevUserSelect=null),this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,this._pointerId=null,this._placeholderEl=null,y(),b(),M(),p(!1,!1),E()},O=()=>{let t=this._originGrid,e=this._originCategoryId,r=this._draggingCard,o=this._placeholderEl;if(r&&o&&o.parentNode&&o.replaceWith(r),t&&e){let l=Array.from(t.querySelectorAll(".platform-card")).map(i=>i.dataset.platform).filter(Boolean);F(e,l)}N()};document.addEventListener("pointerdown",t=>{if(t.button!==0)return;let e=t.target?.closest?.(".platform-drag-handle");if(!e)return;let r=e.closest(".platform-card"),o=e.closest(".platform-grid"),l=G(o),i=r?.dataset?.platform||null;if(!r||!o||!l||!i)return;t.preventDefault(),this._prevUserSelect=document.body.style.userSelect,document.body.style.userSelect="none",e.style.touchAction="none";try{e.setPointerCapture(t.pointerId)}catch{}this._pointerId=t.pointerId,this._draggingCard=r,this._draggingPlatformId=i,this._originGrid=o,this._originCategoryId=l;let n=r.getBoundingClientRect();this._ghostOffsetX=t.clientX-n.left,this._ghostOffsetY=t.clientY-n.top;let s=document.createElement("div");s.className="platform-card platform-card-placeholder",s.style.width=n.width+"px",s.style.height=n.height+"px",s.style.boxSizing="border-box",s.style.border="2px dashed rgba(99, 102, 241, 0.6)",s.style.borderRadius="12px",s.style.background="rgba(99, 102, 241, 0.06)",this._placeholderEl=s,r.parentNode&&r.parentNode.replaceChild(s,r);let d=r.cloneNode(!0);d.classList.add("dragging"),d.style.position="fixed",d.style.left="0",d.style.top="0",d.style.width=n.width+"px",d.style.height=n.height+"px",d.style.margin="0",d.style.zIndex="10001",d.style.pointerEvents="none",d.style.opacity="0.92",d.style.willChange="transform",d.style.transform=`translate3d(${n.left}px, ${n.top}px, 0)`,this._ghostEl=d,document.body.appendChild(d),w(),p(!1,!1),r.classList.add("dragging"),I(t.clientX,t.clientY)},!0),document.addEventListener("pointermove",t=>{if(!this._draggingCard||this._pointerId==null||t.pointerId!==this._pointerId)return;t.preventDefault(),I(t.clientX,t.clientY);let e=this._originGrid;if(!e)return;if(B(t,e)!=="none"){M();return}let o=e.getBoundingClientRect();if(!(t.clientX>=o.left&&t.clientX<=o.right&&t.clientY>=o.top&&t.clientY<=o.bottom)){M();return}let n=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".platform-card");if(n&&n.classList?.contains?.("platform-card-placeholder")){X(t,e,null);return}X(t,e,n)},!0),document.addEventListener("pointerup",t=>{this._pointerId!=null&&t.pointerId===this._pointerId&&(t.preventDefault(),O())},!0),document.addEventListener("pointercancel",t=>{this._pointerId!=null&&t.pointerId===this._pointerId&&(t.preventDefault(),O())},!0),document.addEventListener("dragstart",t=>{t.target?.closest?.(".platform-drag-handle")&&t.preventDefault()},!0);let h=null,A=()=>{h&&h.parentNode&&h.parentNode.removeChild(h),h=null},W=(t,e,r,o)=>{A(),h=document.createElement("div"),h.className="tr-platform-context-menu",h.innerHTML=`
                <div class="tr-ctx-item" data-action="top">\u2B06\uFE0F \u7F6E\u9876</div>
                <div class="tr-ctx-item" data-action="bottom">\u2B07\uFE0F \u7F6E\u5E95</div>
                <div class="tr-ctx-item" data-action="edit" style="border-top:1px solid #e5e7eb;">\u2699\uFE0F \u7F16\u8F91\u987A\u5E8F</div>
            `,h.style.cssText=`
                position: fixed;
                left: ${t.clientX}px;
                top: ${t.clientY}px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 120px;
                overflow: hidden;
            `;let l=`
                padding: 10px 16px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.15s;
            `;h.querySelectorAll(".tr-ctx-item").forEach(n=>{n.style.cssText=l,n.addEventListener("mouseenter",()=>n.style.background="#f3f4f6"),n.addEventListener("mouseleave",()=>n.style.background="white")}),h.addEventListener("click",n=>{let s=n.target?.dataset?.action;if(!s)return;if(s==="edit"){A(),window.openCategorySettings&&(window.openCategorySettings(),setTimeout(()=>{try{m.settings&&typeof m.settings.editCategory=="function"&&m.settings.editCategory(o)}catch(S){console.error("Failed to edit category:",S)}},100));return}let d=Array.from(r.querySelectorAll(".platform-card"));s==="top"?r.insertBefore(e,d[0]):s==="bottom"&&r.appendChild(e);let C=Array.from(r.querySelectorAll(".platform-card")).map(S=>S.dataset.platform).filter(Boolean);F(o,C),A()}),document.body.appendChild(h);let i=h.getBoundingClientRect();i.right>window.innerWidth&&(h.style.left=window.innerWidth-i.width-8+"px"),i.bottom>window.innerHeight&&(h.style.top=window.innerHeight-i.height-8+"px")};document.addEventListener("click",t=>{h&&!h.contains(t.target)&&A()},!0),document.addEventListener("contextmenu",t=>{let e=t.target?.closest?.(".platform-drag-handle"),r=t.target?.closest?.(".platform-header");if(!e&&!r)return;let o=t.target?.closest?.(".platform-card"),l=t.target?.closest?.(".platform-grid"),i=G(l);!o||!l||!i||i==="explore"||i==="knowledge"||(t.preventDefault(),W(t,o,l,i))},!0)}};m.platformReorder=P;Y(()=>{P.attach()});export{P as platformReorder};
