import{a as D}from"./chunk-E3FXOX6T.js";import{a as d,b as Z,c as _}from"./chunk-NTAR7AIA.js";var H=window.SYSTEM_SETTINGS?.display?.items_per_card||20,mt=3,rt="hotnews_explore_seen_sources_v1",st="hotnews_explore_last_source_v1",p=!1,M=!1,w=[],z=0,F=0,E=!1,C=-1,u=null,P=new Map,b=null,N=null,S=0,T=new Set,W=new Set;function pt(){try{let e=D.getRaw(rt);if(!e)return new Set;let t=JSON.parse(e);if(!Array.isArray(t))return new Set;let n=new Set;for(let r of t){let i=String(r||"").trim();i&&n.add(i)}return n}catch{return new Set}}function gt(e){try{let n=Array.from(e||[]).map(r=>String(r||"").trim()).filter(Boolean).slice(-2e3);D.setRaw(rt,JSON.stringify(n))}catch{}}function ht(){try{let e=new Set(Array.from(T||[]));for(let t of Array.from(W||[]))e.add(t);T=e,gt(T)}catch{}}function yt(){try{let e=D.getRaw(st);return String(e||"").trim()||null}catch{return null}}function wt(e){try{let t=String(e||"").trim();if(!t)return;D.setRaw(st,t)}catch{}}var j=!1,U=0,J=0,k=null;function it(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function bt(e){if(!p||!it()||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let t=e?.target;if(!t||!(t instanceof Element)||t.closest("a,button,input,textarea,select")||!t.closest(".rss-carousel-frame"))return;let n=e?.touches;!n||n.length!==1||(j=!0,k=null,U=Number(n[0]?.clientX||0),J=Number(n[0]?.clientY||0))}function vt(e){if(!j||!p)return;let t=e?.touches;if(!t||t.length!==1)return;let n=Number(t[0]?.clientX||0),r=Number(t[0]?.clientY||0),i=n-U,o=r-J,a=Math.abs(i),s=Math.abs(o);if(!k){if(a<10&&s<10)return;k=a>=s?"x":"y"}try{e.preventDefault()}catch{}}function tt(e){if(!j||(j=!1,!p)||!it())return;let t=e?.changedTouches;if(!t||t.length<1)return;let n=Number(t[0]?.clientX||0),r=Number(t[0]?.clientY||0),i=n-U,o=r-J,a=Math.abs(i),s=Math.abs(o),c=44;if((k==="x"||k==null)&&a>=c&&a>s){i<0?x():q();return}(k==="y"||k==null)&&s>=c&&s>a&&(o<0?L(-1):L(1))}function Y(){return document.getElementById("rssCatalogPreviewModal")}function G(){return document.getElementById("rssCatalogPreviewGrid")}function St(){return document.getElementById("rssCatalogPreviewStatus")}function y(e,t={}){let n=St();if(!n)return;let r=String(t.variant||"").toLowerCase(),i=r==="error"?"#dc2626":r==="success"?"#16a34a":"#6b7280";n.style.color=i,n.textContent=e==null?"":String(e)}function xt(e){let t=Number(e||0)||0;if(!t)return"";let n=new Date(t);if(Number.isNaN(n.getTime()))return"";let r=s=>String(s).padStart(2,"0"),i=String(n.getFullYear()),o=r(n.getMonth()+1),a=r(n.getDate());return`${i}-${o}-${a}`}function _t(e){let t=[e?.published,e?.published_at,e?.pubDate,e?.updated,e?.updated_at,e?.date,e?.datetime,e?.date_published,e?.date_modified],r=Date.now()+365*24*60*60*1e3,i=o=>{let a=Number(o);return!Number.isFinite(a)||a<=0?0:a<1e11?Math.floor(a*1e3):Math.floor(a)};for(let o of t){if(o==null)continue;if(typeof o=="number"){let c=i(o);if(c>0&&c<=r)return c;continue}let a=String(o).trim();if(!a)continue;if(/^\d{10,13}$/.test(a)){let c=i(a);if(c>0&&c<=r)return c;continue}let s=Date.parse(a);if(!Number.isNaN(s)&&s>0&&s<=r)return s}return 0}async function ot(e,t="normal"){let n=Array.isArray(e)?e.map(r=>String(r||"").trim()).filter(Boolean):[];if(n.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:n,priority:t})})}catch{}}async function Et(e,t){let n=new URLSearchParams;n.set("limit",String(e)),n.set("offset",String(t));let r=await fetch(`/api/rss-sources/search?${n.toString()}`),i=await r.json().catch(()=>({}));if(!r.ok)throw new Error(i?.detail||"Failed to load RSS sources");let o=Array.isArray(i?.sources)?i.sources:[],a=Number(i?.total||0)||0,s=Number(i?.next_offset??t+o.length)||t+o.length;return{items:o,total:a,nextOffset:s}}async function R(e){let t=Number(e);if(!Number.isFinite(t)||t<0||E)return;let n=0;for(;w.length<=t&&!E&&n<50;){n+=1;let r=await Et(50,F);z=r.total,F=r.nextOffset;for(let i of r.items)String(i?.id||"").trim()&&w.push(i);(!r.items.length||F>=z)&&(E=!0)}}async function Ct(){if(E)return;let e=0;for(;!E&&e<200&&(e+=1,await R(w.length),!E););}function At(e){return String(e?.name||e?.host||e?.id||"").trim()||"RSS"}function kt(e){let t=e?.data||{},n=String(t?.feed?.title||"").trim(),i=(Array.isArray(t?.entries)?t.entries:[]).map(o=>{let a=String(o?.title||"").trim(),s=String(o?.link||"").trim(),c=_t(o);return{title:a||s,link:s,ts:c}}).filter(o=>!!o.link);return{feedTitle:n,entries:i}}function at(){let e=d.subscription?.getSubscriptions?d.subscription.getSubscriptions():[],t=new Set;for(let n of Array.isArray(e)?e:[]){let r=String(n?.source_id||n?.rss_source_id||"").trim();r&&t.add(r)}return t}function et(e){let t=String(e||"").trim();if(!t)return!0;try{if(at().has(t))return!0}catch{}try{if(T&&T.has(t))return!0}catch{}return!1}async function ct(e){let t=String(e?.id||"").trim();if(!t)return null;if(P.has(t))return P.get(t);let n=String(e?.url||"").trim(),r=At(e),i=at(),o=[],a="",s=null;try{let f=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`);if(s=await f.json().catch(()=>({})),!f.ok)throw new Error(s?.detail||"Preview failed");let g=kt(s);a=g.feedTitle,o=g.entries}catch(f){let g={source_id:t,error:String(f?.message||f)};return P.set(t,g),g}if(!Array.isArray(o)||o.length<=0){let f={source_id:t,error:"No entries"};return P.set(t,f),f}let l={source_id:t,url:n,feed_title:a||r,platform_name:a||r,entries:o,entries_count:o.length,error:"",already_added:i.has(t)};return P.set(t,l),l}async function Mt(e){let t=String(e||"").trim();if(!t)return-1;let n=0;for(;n<400;){n+=1;let r=w.findIndex(i=>String(i?.id||"").trim()===t);if(r>=0)return r;if(E||(await R(w.length),E))return-1}return-1}function Nt(e){if(!p)return;let t=async()=>{if(M||b!=null)return;let n=[];for(let i=1;i<=mt;i+=1)n.push(e+i);let r=Math.max(...n);Number.isFinite(r)&&r>=0&&await R(r);for(let i of n)try{if(i<0)continue;await R(i);let o=w[i];if(!o)continue;await ct(o)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>t().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>t().catch(()=>{}),0)}function nt(){let e=d.settings?.getMergedCategoryConfig?d.settings.getMergedCategoryConfig():null,t=d.settings?.getDefaultCategories?d.settings.getDefaultCategories():null,n=Array.isArray(e?.categoryOrder)?e.categoryOrder:[],r=Array.isArray(e?.customCategories)?e.customCategories:[],i=[],o=new Set;for(let a of n){let s=String(a||"").trim();if(!s||o.has(s)||s==="explore"||s.startsWith("rsscol-"))continue;o.add(s);let c=r.find(A=>String(A?.id||"")===s);if(c){let A=String(c?.name||s).trim()||s;i.push({id:s,name:A,icon:"\u{1F4F1}",isCustom:!0});continue}let l=t&&t[s]?t[s]:null;if(!l)continue;let f=String(l?.name||s).trim()||s,g=String(l?.icon||"\u{1F4C1}");i.push({id:s,name:f,icon:g,isCustom:!1})}for(let a of r){let s=String(a?.id||"").trim();if(!s||o.has(s)||s==="explore"||s.startsWith("rsscol-"))continue;o.add(s);let c=String(a?.name||s).trim()||s;i.push({id:s,name:c,icon:"\u{1F4F1}",isCustom:!0})}return i}async function Pt(e){if(!u||!u.source_id)return;let t=String(e?.id||"").trim(),n=String(e?.name||t).trim()||t||"RSS",r=!!e?.isCustom,i=String(u.source_id||"").trim(),o=i?`rss-${i}`:"",a="RSS";t&&t!=="rsscol-rss"&&!r&&(a=t);try{d.subscription?.ensureSnapshot?.()}catch{}try{d.subscription?.stageFromCatalogPreview?.({source_id:u.source_id,url:u.url,feed_title:u.feed_title||u.platform_name,column:a,entries_count:u.entries_count||0})}catch(s){y(String(s?.message||s),{variant:"error"});return}if(r&&t&&o)try{d.settings?.addPlatformToCustomCategory?.(t,o)}catch{}u.already_added=!0;try{K(u)}catch{}try{y(`\u4FDD\u5B58\u4E2D\uFF1A${n}`,{variant:"info"}),d.subscription?.saveOnly?await d.subscription.saveOnly():d.subscription?.saveAndRefresh?await d.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),y(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success"})}catch(s){y(String(s?.message||s),{variant:"error"});try{d.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(s?.message||s)}`,{variant:"error",durationMs:2500})}catch{}return}try{d.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success",durationMs:1500})}catch{}try{setTimeout(()=>{p&&x()},60)}catch{}try{ot([u.source_id],"high").catch(()=>{})}catch{}}function K(e){let t=G();if(!t)return;let n=e,r=String(n?.source_id||"").trim(),i=_(n?.platform_name||"RSS"),o=n?.already_added?"disabled":"",s=nt().map(m=>{let v=`${m?.isCustom?"custom":"default"}:${String(m?.id||"").trim()}`;return`<option value="${_(v)}">${_(String(m?.icon||"\u{1F4C1}"))} ${_(String(m?.name||m?.id||""))}</option>`}).join(""),c=Array.isArray(n?.entries)?n.entries:[],l=Math.max(0,Math.ceil(c.length/H)-1);S>l&&(S=l),S<0&&(S=0);let f=S*H,g=c.slice(f,f+H),A=g.map((m,h)=>{let v=_(m?.title||""),Q=_(m?.link||"#"),O=_(xt(m?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${v}">
                <div class="news-item-content">
                    <span class="news-index">${String(f+h+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${Q}" target="_blank" rel="noopener noreferrer">${v}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${O?"":"display:none;"}">${O}</span>
                </div>
            </li>`}).join(""),B=Math.max(0,H-g.length),ut=B?Array.from({length:B}).map((m,h)=>{let v=f+g.length+h+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(v)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";t.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${_(r)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${i}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <select class="platform-select-action-btn" data-action="add-category" ${o} style="padding:6px 10px;">
                            <option value="" selected>\u52A0\u5165\u680F\u76EE</option>
                            ${s}
                        </select>
                    </div>
                </div>
                <ul class="news-list">${A}${ut}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{t.querySelectorAll(".news-title").forEach(h=>{h instanceof HTMLElement&&(h.closest(".rss-entry-placeholder")||(h.classList.remove("tr-title-overflow-shrink"),h.scrollWidth>h.clientWidth+1&&h.classList.add("tr-title-overflow-shrink")))})})}catch{}let $=t.querySelector('select[data-action="add-category"]');$&&$.addEventListener("change",async()=>{if(!u||u.already_added||!($ instanceof HTMLSelectElement))return;let m=String($.value||"").trim();if(!m)return;let h=m.split(":"),v=String(h[1]||"").trim(),O=nt().find(V=>String(V?.id||"").trim()===v),ft=O||{id:v,name:v,icon:"\u{1F4C1}",isCustom:m.startsWith("custom:")};try{$.setAttribute("disabled","true")}catch{}await Pt(ft)})}async function X(e,t=1){if(!M){M=!0,N=Number(e);try{if(await R(e),w.length<=0){let a=G();a&&(a.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),y("",{variant:"info"});return}let n=e,r=t>=0?1:-1,i=0;for(;i<200;){i+=1,n<0&&(await Ct(),n=w.length-1),await R(n),n>=w.length&&(n=0);let a=w[n];if(!a){n+=r;continue}let s=String(a?.id||"").trim();if(et(s)){n+=r;continue}let c=await ct(a);if(!c||c.error){n+=r;continue}if(c.already_added){n+=r;continue}if(et(c.source_id)){n+=r;continue}C=n,u=c,S=0,K(c),y("",{variant:"info"});try{let l=String(c?.source_id||"").trim();l&&(wt(l),W.add(l))}catch{}try{ot([c.source_id],"normal").catch(()=>{})}catch{}try{Nt(n)}catch{}return}let o=G();o&&(o.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),y("",{variant:"info"})}catch(n){y(String(n?.message||n),{variant:"error"})}finally{if(M=!1,N=null,p&&b!=null){let n=Number(b);b=null;let r=Number.isFinite(C)?C:0,i=n>=r?1:-1;X(n,i).catch(o=>y(String(o?.message||o),{variant:"error"}))}}}}function x(){if(!p)return;if(M){b=(b!=null?Number(b):N!=null?Number(N):C)+1;return}let e=C+1;X(e,1).catch(t=>y(String(t?.message||t),{variant:"error"}))}function q(){if(!p)return;if(M){b=(b!=null?Number(b):N!=null?Number(N):C)-1;return}let e=C-1;X(e,-1).catch(t=>y(String(t?.message||t),{variant:"error"}))}function L(e){if(!p||!u)return;let t=Array.isArray(u?.entries)?u.entries:[],n=Math.max(0,Math.ceil(t.length/H)-1),r=Math.max(0,Math.min(n,S+e));r!==S&&(S=r,K(u))}function lt(){let e=Y();if(!e)return;p=!0,e.classList.add("show");try{window.dispatchEvent(new CustomEvent("tr_explore_modal_opened"))}catch{}try{let n=e.querySelector(".settings-modal");n&&(n.setAttribute("tabindex","0"),n.focus())}catch{}try{d.subscription?.ensureSnapshot?.()}catch{}M=!1,b=null,N=null,w=[],z=0,F=0,E=!1,C=-1,u=null,P=new Map,S=0,T=pt(),W=new Set;let t=yt();if(t){(async()=>{let n=await Mt(t);n>=0?await X(n,1):x()})().catch(()=>x());return}x()}function I(){let e=Y();if(e){p=!1,e.classList.remove("show"),ht();try{window.dispatchEvent(new CustomEvent("tr_explore_modal_closed"))}catch{}}}function Lt(e){let t=Y();t&&e&&e.target===t&&I()}async function dt(){try{await(d.subscription?.saveAndRefresh?d.subscription.saveAndRefresh():window.saveRssSubscriptions?.())}catch(e){y(String(e?.message||e),{variant:"error"});return}I()}window.openRssCatalogPreviewModal=()=>lt();window.closeRssCatalogPreviewModal=()=>I();window.closeRssCatalogPreviewModalOnOverlay=e=>Lt(e);window.rssCatalogPreviewNext=()=>x();window.rssCatalogPreviewPrev=()=>q();window.rssCatalogPreviewSaveAndRefresh=()=>dt();d.rssCatalogPreview={open:lt,close:I,next:x,prev:q,saveAndRefresh:dt};Z(function(){let e=Y();if(!e)return;let t=e.querySelector(".settings-modal");t&&t.addEventListener("keydown",r=>{if(r.key==="Escape"){I();return}}),document.addEventListener("keydown",r=>{if(r.key==="Escape"){p&&I();return}if(!p||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let i=r?.target;if(!(i&&i instanceof Element&&i.closest("input,textarea,select"))){if(r.key===" "||r.key==="Spacebar"||r.code==="Space"){r.preventDefault(),x();return}if(r.key==="ArrowUp"){r.preventDefault(),L(-1);return}if(r.key==="ArrowDown"){r.preventDefault(),L(1);return}if(r.key==="ArrowRight"){r.preventDefault(),x();return}if(r.key==="ArrowLeft"){r.preventDefault(),q();return}}});let n=e.querySelector(".settings-modal-body");n&&(n.addEventListener("click",r=>{if(!p||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let i=r?.target;if(!i||!(i instanceof Element)||i.closest("a,button,input,textarea,select"))return;let o=Number(r?.clientX||0),a=Number(r?.clientY||0),s=e.querySelector("#rssCatalogPreviewGrid .platform-card");if(!s)return;let c=s.getBoundingClientRect(),l=140,f=c.left-l,g=c.right+l,A=c.top-l,B=c.bottom+l;if(!(o<f||o>g||a<A||a>B)&&!(o>=c.left&&o<=c.right&&a>=c.top&&a<=c.bottom)){if(a<c.top){L(-1);return}if(a>c.bottom){L(1);return}if(o<c.left){q();return}if(o>c.right){x();return}}}),n.addEventListener("touchstart",bt,{passive:!0}),n.addEventListener("touchmove",vt,{passive:!1}),n.addEventListener("touchend",tt,{passive:!0}),n.addEventListener("touchcancel",tt,{passive:!0}))});
