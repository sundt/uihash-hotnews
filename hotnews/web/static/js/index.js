import{a as T}from"./chunk-R33N4FES.js";import{a as l,b as k,c as S,d as dt,e as ge}from"./chunk-EMYW6RDC.js";var Po={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};l.counts=Po;var ie={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;let n=r.querySelector(".news-checkbox");if(n?n.checked||(n.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(n):l.readState&&typeof l.readState.markAsRead=="function"&&l.readState.markAsRead(n)):l.readState&&typeof l.readState.markItemAsRead=="function"&&l.readState.markItemAsRead(r),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}t.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"?this.handleTitleClickV2(e,t):t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>ie.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>ie.handleTitleKeydownV2(e,t);window.openLink=e=>ie.openLink(e);document.addEventListener("click",e=>{let t=e.target.closest(".news-title");if(t){t.hasAttribute("onclick")||ie.handleTitleClickV2(t,e);return}e.target.closest(".news-item")||ie.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||ie.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&ie.closeAllPreviews(null)});l.link=ie;var Ar={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let n=r.textContent.toLowerCase();!t||n.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>Ar.searchNews();l.search=Ar;var Lr="hotnews_platform_grid_scroll_v1",kr={getPlatformGridScrollState(){return T.get(Lr,{})},setPlatformGridScrollState(e){T.set(Lr,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,n=null,o=0,s=null,i=t.querySelectorAll(".platform-card");for(let c of i)if((c.offsetLeft||0)<=r+1)s=c;else break;s?.dataset?.platform&&(n=s.dataset.platform,o=Math.max(0,r-(s.offsetLeft||0)));let a=this.getPlatformGridScrollState();a[e]={left:r,anchorPlatformId:n,anchorOffsetX:o,updatedAt:Date.now()},this.setPlatformGridScrollState(a)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{e.dataset.trRestoring!=="1"&&(e.dataset.trUserScrolled="1"),!t&&(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),n=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(n,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],n=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,o=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,s=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,i=()=>{let a=document.querySelector(`#tab-${t} .platform-grid`);if(a&&a.dataset.trUserScrolled!=="1"){if(o){let c=null;if(a.querySelectorAll(".platform-card").forEach(d=>{!c&&d.dataset.platform===o&&(c=d)}),c&&c.offsetParent!==null){a.dataset.trRestoring="1",a.scrollLeft=(c.offsetLeft||0)+s,requestAnimationFrame(()=>{try{delete a.dataset.trRestoring}catch{}});return}}a.dataset.trRestoring="1",a.scrollLeft=n,requestAnimationFrame(()=>{try{delete a.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{i(),setTimeout(i,50),setTimeout(i,200),setTimeout(i,600)})})},pauseScrollSnap(){document.body.classList.add("tr-snap-paused")},resumeScrollSnap(){setTimeout(()=>{document.body.classList.remove("tr-snap-paused")},100)},setupVisibilityScrollFix(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?(document.body.classList.add("tr-page-hidden"),this.pauseScrollSnap()):document.visibilityState==="visible"&&(document.body.classList.remove("tr-page-hidden"),this.resumeScrollSnap())}),window.addEventListener("beforeunload",()=>{this.pauseScrollSnap()})}};l.scroll=kr;k(function(){kr.setupVisibilityScrollFix()});var Mr="hotnews_feature_badge_v1:",$r="hotnews_new_badges_dismissed_v1",Bt={getFeatureBadgeState(e){return T.get(Mr+e,null)},setFeatureBadgeState(e,t){T.set(Mr+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let n=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=n},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=T.get($r,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){T.set($r,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>Bt.dismissNewPlatformBadge(e);l.badges=Bt;k(function(){Bt.applyDismissedNewBadges()});var ut=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Io=50,ii=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Pr=10,Oo=8,No=80,Bo=160,Ge={PAGE_SIZE:ut,getCardMaxPageSize(e){try{if(e?.classList?.contains("tr-morning-brief-card"))return Io}catch{}return ut},getCardPageSize(e){let t=e?.dataset?.pageSize,r=parseInt(t||"",10),n=Number.isFinite(r)&&r>0?r:ut,o=this.getCardMaxPageSize(e);return Math.min(o,Math.max(1,n))},setCardPageSize(e,t){if(!e)return;let r=parseInt(String(t||""),10),n=Number.isFinite(r)&&r>0?r:ut,o=this.getCardMaxPageSize(e);e.dataset.pageSize=String(Math.min(o,Math.max(1,n)))},applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),n=r.length,o=this.getCardPageSize(e);if(n<=o){r.forEach(a=>a.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let s=Math.max(0,Math.min(t,n-1)),i=Math.min(s+o,n);r.forEach((a,c)=>{c>=s&&c<i?a.classList.remove("paged-hidden"):a.classList.add("paged-hidden")}),e.dataset.pageOffset=String(s)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{let t=this.getCardMaxPageSize(e);this.setCardPageSize(e,t),this.applyPagingToCard(e,0)}),l.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let n=t.querySelectorAll(".news-item").length,o=this.getCardPageSize(t);if(n<=o)return;let s=parseInt(t.dataset.pageOffset||"0",10),i=s+o>=n?0:s+o;this.applyPagingToCard(t,i),l.counts.updateAllCounts()},getVisibleNewsItems(e){return e?Array.from(e.querySelectorAll(".news-item")).filter(t=>!t.classList.contains("filtered")&&!t.classList.contains("search-hidden")&&!t.classList.contains("paged-hidden")&&!t.classList.contains("read")):[]},shouldAutofillCard(e,t){if(!e||e.classList.contains("platform-empty-hidden"))return!1;try{if(e.classList.contains("tr-morning-brief-card"))return!1}catch{}let r=this.getVisibleNewsItems(e),n=Number.isFinite(t)?t:Pr;if(r.length<n)return!0;let o=r[r.length-1];if(!o)return!0;let s=e.getBoundingClientRect(),i=o.getBoundingClientRect();return!Number.isFinite(s.bottom)||!Number.isFinite(i.bottom)?!1:s.bottom-i.bottom>=No},autofillCard(e,t={}){if(!e)return!1;try{if(e.classList.contains("tr-morning-brief-card"))return!1}catch{}let r=Number.isFinite(t.minVisible)?t.minVisible:Pr,n=Number.isFinite(t.maxSteps)?t.maxSteps:Oo,o=t.force===!0,s=e.querySelectorAll(".news-item").length;if(s<=0)return!1;let i=parseInt(e.dataset.pageOffset||"0",10)||0,a=this.getCardPageSize(e),c=!1,d=Math.max(0,i);for(let u=0;u<n&&!(!o&&!this.shouldAutofillCard(e,r)||s<=a);u++){let f=d+a;if(f+a>s&&(f=0),f===d)break;d=f,this.setCardPageSize(e,a),this.applyPagingToCard(e,d),c=!0}return c&&l.counts.updateAllCounts(),c},autofillForCategory(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r)return!1;let n=!1;return r.querySelectorAll(".platform-card").forEach(o=>{this.autofillCard(o,t)&&(n=!0)}),n},autofillActiveTab(e={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,e):!1},scheduleAutofillActiveTab(e={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(e)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=Bo&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=e=>Ge.refreshPlatform(e);l.paging=Ge;k(function(){Ge.initPaging(),Ge.attachAutofillScrollListener(),Ge.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var Ir="hotnews_read_news_v2",Or="hotnews_read_news",Nr="hotnews_show_read_mode",Ro=24,K={getReadNews(){return T.get(Ir,{})},saveReadNews(e){T.set(Ir,e)},getShowReadModePref(){let e=T.getRaw(Nr);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){T.getRaw(Or)&&(T.remove(Or),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,n=0;for(let[o,s]of Object.entries(t))if((e-s.readAt)/36e5>=Ro){let a=document.querySelector(`[data-news-id="${o}"]`);if(a){a.classList.remove("read");let c=a.querySelector(".news-checkbox");c&&(c.checked=!1)}delete t[o],r=!0,n++}return r&&this.saveReadNews(t),n},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,n=t.dataset.newsTitle||"",o=this.getReadNews();e.checked?(t.classList.add("read"),o[r]||(o[r]={title:n.substring(0,50),readAt:Date.now()},this.saveReadNews(o))):(t.classList.remove("read"),delete o[r],this.saveReadNews(o)),l.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},markItemAsRead(e){try{if(!e)return;let t=e.dataset.newsId,r=e.dataset.newsTitle||"";if(!t)return;e.classList.add("read");let n=this.getReadNews();n[t]||(n[t]={title:String(r||"").substring(0,50),readAt:Date.now()},this.saveReadNews(n)),l.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()}catch{}},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let n=r.querySelector(".news-checkbox");n&&(n.checked=!0)}}),l.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),T.setRaw(Nr,e?"1":"0"),l.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),l.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>K.markAsRead(e);window.toggleShowRead=()=>K.toggleShowRead();window.clearAllRead=()=>K.clearAllRead();l.readState=K;k(function(){K.applyShowReadMode(K.getShowReadModePref()),K.migrateOldFormat();let e=K.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),K.restoreReadState(),K.updateReadCount()});var Br="hotnews_theme_mode",Rr="eye-protection-mode",Rt={isDarkMode(){try{return localStorage.getItem(Br)==="dark"}catch{return!1}},toggle(){let t=!this.isDarkMode();this.apply(t);try{localStorage.setItem(Br,t?"dark":"light")}catch{}},apply(e){e?document.body.classList.add(Rr):document.body.classList.remove(Rr),this.updateButtonState(e)},updateButtonState(e){let t=document.getElementById("themeToggleBtn");t&&(t.innerHTML=e?"\u{1F31E}":"\u{1F319}",t.classList.toggle("active",e))},init(){let e=this.isDarkMode();this.apply(e)}};l.theme=Rt;window.toggleTheme=function(){Rt.toggle()};document.addEventListener("DOMContentLoaded",()=>{Rt.init()});var ft="hotnews_categories_config",Dt=1,P=null,R=null,pe=null,We=!1,ke=!1,le=!0,Do=null,Ve="",J=!1;function Fo(e,t){let r=Array.isArray(e)?e:[],n=new Set,o=[];r.forEach(i=>{let a=String(i||"").trim();a&&(n.has(a)||(n.add(a),o.push(a)))});let s=Array.isArray(t)?t:[];s.forEach(i=>{let a=o.indexOf(i);a>=0&&o.splice(a,1)});for(let i=s.length-1;i>=0;i-=1){let a=String(s[i]||"").trim();a&&o.unshift(a)}return o}function mt(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function Dr(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.hiddenPlatforms)||(t.hiddenPlatforms=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),mt(t),t}var O={CATEGORY_CONFIG_KEY:ft,ensureCategoryFilters:mt,normalizeCategoryConfig:Dr,getCategoryConfig(){try{let e=T.getRaw(ft);if(!e)return null;let t=JSON.parse(e);return t.version!==Dt?null:Dr(t)}catch{return null}},saveCategoryConfig(e){e.version=Dt,T.setRaw(ft,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.hiddenPlatforms?.length>0||e.categoryOrder?.length>0?document.cookie="hotnews_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="hotnews_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return P||(P={},R={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",n=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;P[t]={id:t,name:n,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card:not(.tr-morning-brief-card)").forEach(e=>{let t=e.dataset.platform,r=(e.querySelector(".platform-name")?.textContent||"").replace(/NEW\s*$/i,"").replace(/ðŸ“±\s*/g,"").trim()||t,o=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";R[t]={id:t,name:r,defaultCategory:o},P[o]&&(P[o].platforms||(P[o].platforms=[]),P[o].platforms.push(t))})),{version:Dt,customCategories:[],hiddenDefaultCategories:[],hiddenPlatforms:[],categoryOrder:Object.keys(P),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],hiddenPlatforms:t.hiddenPlatforms||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}},n=Object.keys(P);n.forEach((o,s)=>{if(!r.categoryOrder.includes(o)){let i=r.categoryOrder.length;for(let a=s-1;a>=0;a--){let c=n[a],d=r.categoryOrder.indexOf(c);if(d!==-1){i=d+1;break}}r.categoryOrder.splice(i,0,o)}}),r.customCategories.forEach(o=>{r.categoryOrder.includes(o.id)||r.categoryOrder.push(o.id)});try{let o="__migrated_explore_knowledge_front_v1",s=Array.isArray(t.categoryOrder)?t.categoryOrder.indexOf("explore"):-1,i=Array.isArray(t.categoryOrder)?t.categoryOrder.indexOf("knowledge"):-1,a=s!==0||i!==1;if(!t[o]&&a){let c=Fo(r.categoryOrder,["explore","knowledge"]);r.categoryOrder=c,t.categoryOrder=c,t[o]=Date.now(),this.saveCategoryConfig(t)}}catch{}try{let o=r.categoryOrder.indexOf("my-tags");o>0?(r.categoryOrder.splice(o,1),r.categoryOrder.unshift("my-tags")):o===-1&&r.categoryOrder.unshift("my-tags")}catch{}return r},getDefaultCategories(){return P},getAllPlatforms(){return R},addPlatformToCustomCategory(e,t){let r=String(e||"").trim(),n=String(t||"").trim();if(!r||!n)return!1;let o=this.getCategoryConfig()||this.getDefaultCategoryConfig();mt(o);let s=Array.isArray(o.customCategories)?o.customCategories.findIndex(c=>String(c?.id||"").trim()===r):-1;if(s<0)return!1;let i=o.customCategories[s]||{},a=Array.isArray(i.platforms)?[...i.platforms]:[];return a.includes(n)||a.push(n),o.customCategories[s]={...i,platforms:a},Array.isArray(o.categoryOrder)&&!o.categoryOrder.includes(r)&&o.categoryOrder.unshift(r),this.saveCategoryConfig(o),J=!0,!0},setDefaultCategories(e){P=e},setAllPlatforms(e){R=e},async openCategorySettings(){let e=document.getElementById("categorySettingsNewBadge");e&&(e.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true"));try{let n=await(await fetch("/api/news")).json();n?.categories&&(P={},R={},Object.entries(n.categories).forEach(([o,s])=>{P[o]={id:o,name:s.name,icon:s.icon,isDefault:!0,platforms:Object.keys(s.platforms||{})},Object.entries(s.platforms||{}).forEach(([i,a])=>{R[i]={id:i,name:a.name,defaultCategory:o,data:a}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),le=!0,Do=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(le?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=le?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){le=!le,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),J&&(J=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){J=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(o=>{let s=t.customCategories.find(d=>d.id===o),i=t.hiddenDefaultCategories.includes(o),a;if(s)a=s;else if(P[o])a=P[o];else return;let c=s?a.platforms?.length||0:P[o]?.platforms?.length||0;r+=`
                <div class="category-item ${s?"custom":""}" data-category-id="${o}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${a.name}</span>
                    <span class="category-item-platforms">${c} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${i?"":"checked"} onchange="toggleCategoryVisibility('${o}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${o}')">\u7F16\u8F91</button>
                        ${s?`<button class="category-item-btn delete" onclick="deleteCategory('${o}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let n=document.getElementById("allCategoriesOffToggle");if(n){let o=t.hiddenDefaultCategories||[],s=t.categoryOrder||[];n.checked=s.length>0&&s.every(i=>o.includes(i))}ke?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){ke=!ke,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",n=>{r.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",n=>{n.preventDefault();let o=e.querySelector(".dragging");if(o&&o!==r){let s=r.getBoundingClientRect(),i=s.top+s.height/2;n.clientY<i?e.insertBefore(o,r):e.insertBefore(o,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(o=>o.dataset.categoryId),n=this.getCategoryConfig()||this.getDefaultCategoryConfig();n.categoryOrder=r,this.saveCategoryConfig(n),J=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),J=!0,this.renderCategoryList()},togglePlatformHidden(e){let t=String(e||"").trim();if(!t)return!1;let r=this.getCategoryConfig()||this.getDefaultCategoryConfig();Array.isArray(r.hiddenPlatforms)||(r.hiddenPlatforms=[]);let n=r.hiddenPlatforms.findIndex(o=>String(o||"").trim()===t);return n>=0?r.hiddenPlatforms.splice(n,1):r.hiddenPlatforms.push(t),this.saveCategoryConfig(r),J=!0,this.applyCategoryConfig(),!0},showAddCategoryPanel(){We=!0,pe=null,le=!0,this.applyCategoryListCollapseState(),ke=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSelectField");e&&(e.style.display="");let t=document.getElementById("platformSearchInput");t&&(t.value=""),Ve="",this.renderPlatformSelectList([],!0),l.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){We=!1,pe=e;let t=document.getElementById("platformSelectField");t&&(t.style.display="");let r=this.getMergedCategoryConfig(),n=r.customCategories.find(c=>c.id===e),o,s;n?(o=n,s=o.platforms||[]):(o=P[e],s=r.platformOrder[e]||o.platforms||[]),document.getElementById("editCategoryName").value=o.name,this.renderPlatformSelectList(s,n);let i=l.filter.getCategoryFilterConfig(e);l.filter.setCategoryFilterEditorState(i.mode,i.keywords),ke=!0,le=!0,this.applyCategoryListCollapseState();let a=document.getElementById("platformSearchInput");a&&(a.value=""),Ve="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),pe=null,We=!1,ke=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),Ve=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),o=(this.getMergedCategoryConfig().hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),s=new Set(o),i=[];e.forEach(u=>{R[u]&&i.push(u)}),t&&Object.keys(R).forEach(f=>{i.includes(f)||i.push(f)});let a=(Ve||"").trim().toLowerCase(),c=a?i.filter(u=>(R[u]?.name||"").toLowerCase().includes(a)):i,d=a.length>0;r.innerHTML=c.map(u=>{let f=R[u],m=e.includes(u)&&!s.has(String(u||"").trim());return`
                <label class="platform-select-item ${m?"selected":""} ${d?"no-drag":""}" data-platform-id="${u}" draggable="${d?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${m?"checked":""} onchange="togglePlatformSelect('${u}')">
                    <span>${f.name}</span>
                </label>
            `}).join(""),d||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){Ve=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t,We===!0)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(n=>{let o=n.querySelector('input[type="checkbox"]');e==="all"?(n.classList.add("selected"),o&&(o.checked=!0)):(e==="none"||e==="clear")&&(n.classList.remove("selected"),o&&(o.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList"),t=e.querySelectorAll(".platform-select-item"),r=60,n=20,o=null,s=0,i=0,a=()=>{o&&cancelAnimationFrame(o),o=null,s=0,i=0},c=()=>{if(!s||!i){a();return}let u=Math.max(0,(e.scrollHeight||0)-(e.clientHeight||0));if(u<=0){a();return}let f=Math.max(0,Math.min(u,(e.scrollTop||0)+s*i));e.scrollTop=f,o=requestAnimationFrame(c)},d=u=>{let f=e.getBoundingClientRect(),m=u.clientY,g=m-f.top,h=f.bottom-m,v=0,y=0;if(g>=0&&g<=r)v=-1,y=g;else if(h>=0&&h<=r)v=1,y=h;else{a();return}let M=Math.max(0,Math.min(1,(r-y)/r));i=Math.max(2,Math.round(M*M*n)),s=v,o||(o=requestAnimationFrame(c))};t.forEach(u=>{u.addEventListener("dragstart",f=>{u.classList.add("dragging"),f.dataTransfer.effectAllowed="move"}),u.addEventListener("dragend",()=>{u.classList.remove("dragging"),a()}),u.addEventListener("dragover",f=>{f.preventDefault(),d(f);let m=e.querySelector(".dragging");if(m&&m!==u){let g=u.getBoundingClientRect(),h=g.top+g.height/2;f.clientY<h?e.insertBefore(m,u):e.insertBefore(m,u.nextSibling)}})}),e.addEventListener("dragover",u=>{u.preventDefault(),e.querySelector(".dragging")&&d(u)})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},getOrderedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{let n=String(r?.dataset?.platformId||"").trim();n&&t.push(n)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms(),n=this.getOrderedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let o=this.getCategoryConfig()||this.getDefaultCategoryConfig();mt(o);let s=l.filter.getEditingFilterState();if(We){let i="custom-"+Date.now();o.customCategories.push({id:i,name:e,icon:t,platforms:r,isCustom:!0}),o.categoryOrder.unshift(i),o.categoryFilters[i]={mode:s.mode,keywords:[...s.keywords]}}else if(pe){let i=o.customCategories.findIndex(a=>a.id===pe);if(i>=0)o.customCategories[i]={...o.customCategories[i],name:e,icon:t,platforms:r};else{o.platformOrder[pe]=n,Array.isArray(o.hiddenPlatforms)||(o.hiddenPlatforms=[]);let a=new Set((o.hiddenPlatforms||[]).map(c=>String(c||"").trim()).filter(Boolean));n.forEach(c=>{c&&(r.includes(c)?a.delete(c):a.add(c))}),o.hiddenPlatforms=Array.from(a)}o.categoryFilters[pe]={mode:s.mode,keywords:[...s.keywords]}}return this.saveCategoryConfig(o),J=!0,this.hideEditPanel(),this.renderCategoryList(),le=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),J=!0,this.renderCategoryList()},resetDefaultCategoryConfig(){if(!confirm("\u786E\u5B9A\u8981\u521D\u59CB\u5316\u9ED8\u8BA4\u680F\u76EE\u4E0E\u5361\u7247\u5417\uFF1F\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u4FDD\u7559\u3002"))return;let e=this.getCategoryConfig();if(!e){this.renderCategoryList(),this.applyCategoryConfig();return}let t=this.getDefaultCategoryConfig(),r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=new Set(r.map(a=>String(a||"").trim()).filter(Boolean)),o=e;o.hiddenDefaultCategories=(o.hiddenDefaultCategories||[]).filter(a=>!n.has(String(a||"").trim())),o.hiddenPlatforms=[],o.platformOrder={};let s=Array.isArray(o.customCategories)?o.customCategories.map(a=>String(a?.id||"").trim()).filter(Boolean):[],i=r.slice();for(let a of s)i.includes(a)||i.push(a);o.categoryOrder=i,this.saveCategoryConfig(o),J=!0,this.renderCategoryList(),this.applyCategoryConfig()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(T.remove(ft),P=null,R=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){l.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();P?Object.entries(e).forEach(([u,f])=>{if(!P[u])P[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})};else{P[u].platforms||(P[u].platforms=[]);let m=new Set(P[u].platforms||[]);Object.keys(f.platforms||{}).forEach(g=>{m.has(g)||P[u].platforms.push(g)})}Object.entries(f.platforms||{}).forEach(([m,g])=>{R[m]||(R[m]={id:m,name:g.name,defaultCategory:u,data:g})})}):(P={},R={},Object.entries(e).forEach(([u,f])=>{P[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})},Object.entries(f.platforms||{}).forEach(([m,g])=>{R[m]={id:m,name:g.name,defaultCategory:u,data:g}})}));let r={};Object.values(e).forEach(u=>{Object.entries(u.platforms||{}).forEach(([f,m])=>{r[f]=m})});let n={},o=t.hiddenDefaultCategories||[],s=(t.hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),i=new Set(s),a=t.categoryOrder||Object.keys(e),c=t.customCategories||[],d=t.platformOrder||{};return a.forEach(u=>{if(o.includes(u)||String(u||"").startsWith("rsscol-"))return;let f=c.find(m=>m.id===u);if(f){let m={};(f.platforms||[]).forEach(g=>{i.has(String(g||"").trim())||r[g]&&(m[g]=r[g])}),n[u]={name:f.name,icon:"\u{1F4F1}",platforms:m}}else if(e[u]){let m=e[u],g=d[u];if(g&&g.length>0){let h=[],v=new Set;g.forEach(_=>{i.has(String(_||"").trim())||m.platforms&&m.platforms[_]&&(h.push(_),v.add(_))});let y=[],M=[];Object.keys(m.platforms||{}).forEach(_=>{v.has(_)||i.has(String(_||"").trim())||(String(_||"").startsWith("rss-")?y.push(_):M.push(_))});let w=y.concat(h,M),x={};w.forEach(_=>{i.has(String(_||"").trim())||m.platforms&&m.platforms[_]&&(x[_]=m.platforms[_])}),n[u]={...m,platforms:x}}else{let h={};Object.entries(m.platforms||{}).forEach(([v,y])=>{i.has(String(v||"").trim())||(h[v]=y)}),n[u]={...m,platforms:h}}}}),Object.keys(e).forEach(u=>{String(u||"").startsWith("rsscol-")&&String(u)!=="rsscol-rss"||!n[u]&&!o.includes(u)&&(n[u]=e[u])}),n},syncCacheWithServer(e){try{let t=this.getCategoryConfig();if(!t)return!1;let r=new Set;if(Object.values(e||{}).forEach(o=>{let s=o?.platforms||{};Object.keys(s).forEach(i=>r.add(i))}),r.size===0)return!1;let n=!1;if(t.platformOrder&&typeof t.platformOrder=="object"&&Object.keys(t.platformOrder).forEach(o=>{if(Array.isArray(t.platformOrder[o])){let s=t.platformOrder[o].length;t.platformOrder[o]=t.platformOrder[o].filter(i=>{let a=r.has(i);return a||console.log(`[HotNews] \u6E05\u7406\u65E0\u6548\u5E73\u53F0: ${i} (from platformOrder.${o})`),a}),t.platformOrder[o].length<s&&(n=!0)}}),Array.isArray(t.customCategories)&&t.customCategories.forEach(o=>{if(Array.isArray(o.platforms)){let s=o.platforms.length;o.platforms=o.platforms.filter(i=>{let a=r.has(i);return a||console.log(`[HotNews] \u6E05\u7406\u65E0\u6548\u5E73\u53F0: ${i} (from customCategory ${o.id})`),a}),o.platforms.length<s&&(n=!0)}}),Array.isArray(t.hiddenPlatforms)){let o=t.hiddenPlatforms.length;t.hiddenPlatforms=t.hiddenPlatforms.filter(s=>{let i=r.has(s);return i||console.log(`[HotNews] \u6E05\u7406\u65E0\u6548\u5E73\u53F0: ${s} (from hiddenPlatforms)`),i}),t.hiddenPlatforms.length<o&&(n=!0)}return n&&(this.saveCategoryConfig(t),console.log("[HotNews] \u5DF2\u81EA\u52A8\u6E05\u7406\u672C\u5730\u7F13\u5B58\u4E2D\u7684\u65E0\u6548\u5E73\u53F0")),n}catch(t){return console.error("[HotNews] syncCacheWithServer error:",t),!1}}};window.openCategorySettings=()=>O.openCategorySettings();window.closeCategorySettings=()=>O.closeCategorySettings();window.saveCategorySettings=()=>O.saveCategorySettings();window.cancelCategorySettings=()=>O.cancelCategorySettings();window.showAddCategoryPanel=()=>O.showAddCategoryPanel();window.editCategory=e=>O.editCategory(e);window.cancelEditCategory=()=>O.cancelEditCategory();window.saveCategory=()=>O.saveCategory();window.deleteCategory=e=>O.deleteCategory(e);window.resetDefaultCategoryConfig=()=>O.resetDefaultCategoryConfig();window.resetCategoryConfig=()=>O.resetCategoryConfig();window.toggleCategoryVisibility=e=>O.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>O.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>O.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>O.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>O.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>O.setPlatformSearchQuery(e);l.settings=O;k(function(){let e=O.getCategoryConfig();e&&O.syncConfigToCookie(e)});var Fr="hotnews_filter_keywords",qr="hotnews_filter_mode_v1",he=[],gt="exclude";function pt(e){return e==="include"?"include":"exclude"}var ye={normalizeFilterMode:pt,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=l.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],n=pt(r&&r.mode),o=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:n,keywords:o.map(s=>String(s||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),n=r.mode,o=r.keywords,s=`${n}|${o.join(",")}`,a=(t.dataset?t.dataset.filterSig:null)!==s;t.dataset&&(t.dataset.filterSig=s);let c=t.dataset&&t.dataset.bulkLoading==="1";if(t.querySelectorAll(".news-item").forEach(d=>{let u=(d.textContent||"").toLowerCase(),f=o.length>0?o.some(g=>u.includes(g)):!1;(o.length===0?!1:n==="include"?!f:f)?d.classList.add("filtered"):d.classList.remove("filtered")}),n!=="include"&&t.querySelectorAll(".platform-card").forEach(d=>{d.classList.remove("platform-empty-hidden")}),n==="include"){if(o.length>0)try{if(a&&!c){if(t.querySelectorAll(".platform-card").forEach(d=>{d?.dataset&&(d.dataset.loadedDone="0")}),l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function")l.infiniteScroll.scheduleBulkLoadCategory(e,{pageSize:40});else if(l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let d=t.querySelectorAll(".platform-card").length;l.infiniteScroll.scheduleEnsureCategoryLoaded(e,{cap:d,maxPagesPerCard:2})}}}catch{}t.querySelectorAll(".platform-card").forEach(d=>{let u=d?.dataset?.loadedDone==="1",f=!u||d?.dataset?.loading==="1";if(o.length>0&&f){d.classList.add("platform-empty-hidden");return}d.classList.remove("platform-empty-hidden"),d.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&u&&d.classList.add("platform-empty-hidden")})}try{let d=t.querySelector(".category-empty-state");if(d)if(n==="include"&&o.length>0){let u=Array.from(t.querySelectorAll(".platform-card")),f=u.length>0&&u.every(g=>g?.dataset?.loadedDone==="1"&&g?.dataset?.loading!=="1"),m=t.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;d.style.display=f&&m===0?"block":"none"}else d.style.display="none"}catch{}l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){gt=pt(e),he=(Array.isArray(t)?t:[]).map(o=>String(o||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=gt==="include");let n=document.getElementById("categoryFilterInput");n&&(n.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){gt=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(he.includes(t)||(he.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){he=he.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=he.map(t=>`<span class="filter-tag">${S(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${S(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:gt,keywords:[...he]}},migrateLegacyGlobalFilter(){let e=T.getRaw(Fr),t=T.getRaw(qr);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(a=>String(a||"").trim().toLowerCase()).filter(Boolean);let n=pt(t),o=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig();l.settings.ensureCategoryFilters(o),(l.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(a=>{o.categoryFilters[a]||(o.categoryFilters[a]={mode:n,keywords:[...r]})}),l.settings.saveCategoryConfig(o),T.remove(Fr),T.remove(qr)}};window.handleCategoryFilterModeToggle=e=>ye.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>ye.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>ye.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>ye.removeCategoryFilterKeyword(e);l.filter=ye;k(function(){ye.migrateLegacyGlobalFilter(),ye.applyCategoryFilterForActiveTab()});var Me="hotnews_active_tab",Hr="hotnews_viewer_pos_v1";var qo="tr_tab_switched",Ho="tr_explore_modal_opened",zo="tr_explore_modal_closed",we=null,Ft=0;function zr(e,t){try{let r=String(e||"").trim();if(!r)return;let n={activeTab:r,scrollY:Number(t||0)||0,updatedAt:Date.now()};T.setRaw(Hr,JSON.stringify(n))}catch{}}function Uo(){try{let e=ce.getActiveTabId();we=e?String(e):null,Ft=window.scrollY||0;try{let t=we?document.querySelector(`#tab-${we} .platform-grid`):null;we&&t&&l.scroll.recordPlatformGridScrollForTab(we,t)}catch{}}catch{}}function jo(){try{let e=T.getRaw(Hr);if(!e)return;let t=JSON.parse(e),r=String(t?.activeTab||"").trim();if(!r)return;let n=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(r)):String(r);if(!document.querySelector(`.category-tab[data-category="${n}"]`))return;ce.switchTab(r);let s=Number(t?.scrollY||0)||0;requestAnimationFrame(()=>{try{window.scrollTo({top:s,behavior:"auto"})}catch{}})}catch{}}function Go(){let e=we,t=Ft;if(we=null,Ft=0,!!e){try{let r=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),n=document.querySelector(`.category-tab[data-category="${r}"]`),o=document.getElementById(`tab-${e}`);if(!n||!o)return}catch{}try{l.tabs.switchTab(e)}catch{}zr(e,t),requestAnimationFrame(()=>{try{window.scrollTo({top:t,behavior:"auto"})}catch{}try{l.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})}catch{}})}}var ce={TAB_STORAGE_KEY:Me,switchTab(e){l.badges.dismissNewCategoryBadge(e),document.body.classList.toggle("tr-rss-reading",String(e)==="rsscol-rss");let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),n=document.getElementById(`tab-${e}`);if(!r||!n){let i=document.querySelector(".category-tab");i?.dataset?.category&&i.dataset.category!==String(e)?this.switchTab(i.dataset.category):T.remove(Me);return}let o=r.querySelector(".update-dot.show"),s=!!o;o&&o.classList.remove("show"),document.querySelectorAll(".category-tab").forEach(i=>i.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(i=>i.classList.remove("active")),n.classList.add("active"),T.setRaw(Me,e);try{window.dispatchEvent(new CustomEvent(qo,{detail:{categoryId:e,hasUpdate:s}}))}catch{}zr(e,window.scrollY||0),l.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(l.badges.markFeatureSeen("sports-nba-schedule"),l.badges.updateNewBadges()),l.filter.applyCategoryFilter(e),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let i=!!n.querySelector(".news-item"),a=!!n.querySelector(".news-placeholder");!i&&a&&(l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function"?l.infiniteScroll.scheduleBulkLoadCategory(e):l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&l.infiniteScroll.scheduleEnsureCategoryLoaded(e))}catch{}},restoreActiveTab(){let e=T.getRaw(Me);if(e){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"&&String(e)==="rsscol-rss"){T.remove(Me);return}}catch{}document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)}},getActiveTabId(){return T.getRaw(Me)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){l.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){l.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>ce.switchTab(e);l.tabs=ce;k(function(){try{window.addEventListener(Ho,()=>{Uo()}),window.addEventListener(zo,()=>{Go()})}catch{}ce.restoreActiveTab(),jo(),ce.attachPlatformGridScrollPersistence();let e=ce.getActiveTabId();e&&ce.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var qt="hotnews_active_tab",Oe=window.SYSTEM_SETTINGS?.display?.items_per_card||20,Ht=!1,Wo=0,$e=null,Vo=null,Ur=!1,Pe=null;function Yo(e){let r=e?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function Xo(e,t){let n=String(t||"").trim().startsWith("rss-");return`${n?'<button type="button" class="tr-platform-card-delete" data-action="delete-platform">\u2212</button>':""}${n?"":'<button type="button" class="tr-platform-card-hide" data-action="hide-platform">\u{1F648}</button>'}`}function Ko(e){let t=Math.max(0,Number(e||0)||0),r="";for(let n=0;n<t;n++)r+='<li class="tr-news-skeleton" aria-hidden="true"><div class="tr-news-skeleton-line"></div></li>';return r}function Jo(e,t,r,n){let o=document.createElement("li");o.className="news-item";let s=String(e?.stable_id||"");o.dataset.newsId=s,o.dataset.newsTitle=String(e?.display_title||e?.title||"");let i=document.createElement("div");i.className="news-item-content";let a=document.createElement("input");a.type="checkbox",a.className="news-checkbox",a.title="\u6807\u8BB0\u5DF2\u8BFB",a.addEventListener("change",()=>{try{window.markAsRead(a)}catch{}});let c=document.createElement("span");c.className="news-index",c.textContent=String(t);let d=document.createElement("a");if(d.className="news-title",e?.is_cross_platform&&d.classList.add("cross-platform"),d.href=String(e?.url||"#"),d.target="_blank",d.rel="noopener noreferrer",d.setAttribute("onclick","handleTitleClickV2(this, event)"),d.setAttribute("onauxclick","handleTitleClickV2(this, event)"),d.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),d.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),d.textContent=String(e?.display_title||e?.title||""),e?.is_cross_platform){let h=Array.isArray(e?.cross_platforms)?e.cross_platforms:[],v=document.createElement("span");v.className="cross-platform-badge",v.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${h.join(", ")}`,v.textContent=`\u{1F525} ${String(e?.cross_platform_count??"")}`,d.appendChild(document.createTextNode(" ")),d.appendChild(v)}i.appendChild(a),i.appendChild(c),i.appendChild(d);let u=ge(e?.timestamp);if(u){let h=document.createElement("span");h.className="tr-news-date",h.style.marginLeft="8px",h.style.color="#9ca3af",h.style.fontSize="12px",h.style.whiteSpace="nowrap",h.textContent=u,i.appendChild(h)}let f=document.createElement("button");f.className="news-favorite-btn",f.dataset.newsId=s,f.title="\u6536\u85CF",f.textContent="\u2606",f.onclick=h=>{typeof window.handleFavoriteClick=="function"&&window.handleFavoriteClick(h,s,String(e?.display_title||e?.title||""),String(e?.url||""),r,n)},i.appendChild(f),o.appendChild(i);let m=String(e?.meta||"").trim(),g=String(r||"").startsWith("rss-");if(m&&!g){let h=document.createElement("div");h.className="news-subtitle",h.textContent=m,o.appendChild(h)}try{let h=l.readState?.getReadNews?.()||{};o.dataset.newsId&&h[o.dataset.newsId]&&(o.classList.add("read"),a.checked=!0)}catch{}return o}async function Qo(e){if(!e||!(e instanceof Element)||String(e?.dataset?.lazy||"")!=="1"||String(e?.dataset?.loading||"")==="1")return;let t=e.closest(".tab-pane");if(!t||!t.classList.contains("active"))return;let r=String(e.dataset.platform||"").trim();if(r){e.dataset.loading="1";try{let n=`/api/news/page?platform_id=${encodeURIComponent(r)}&offset=0&page_size=${encodeURIComponent(String(Oe))}`,o=await fetch(n);if(!o.ok)return;let s=await o.json(),i=Array.isArray(s?.items)?s.items:[],a=e.querySelector(".news-list");if(!a)return;a.querySelectorAll(".tr-news-skeleton").forEach(m=>m.remove()),a.querySelectorAll(".news-placeholder").forEach(m=>m.remove()),a.querySelectorAll(".news-item").forEach(m=>m.remove());let c=e.querySelector(".platform-name"),d=c?c.textContent.trim():r,u=i.slice(0,Oe);for(let m=0;m<u.length;m++)a.appendChild(Jo(u[m],m+1,r,d));let f=a.querySelectorAll(".news-item").length;e.dataset.loadedCount=String(f),e.dataset.hasMore="0",e.dataset.loadedDone="1",e.dataset.lazy="0";try{l.paging&&(l.paging.setCardPageSize(e,Math.min(Oe,Math.max(1,f||Oe))),l.paging.applyPagingToCard(e,0))}catch{}try{l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(e),l.counts?.updateAllCounts&&l.counts.updateAllCounts()}catch{}try{l.search?.searchNews?.()}catch{}try{let m=l.tabs?.getActiveTabId?.()||null;m&&l.filter?.applyCategoryFilter?.(m)}catch{}}catch{}finally{e.dataset.loading="0"}}}function jr(){try{Pe&&(Pe.disconnect(),Pe=null)}catch{}Pe=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting)continue;let r=t.target;if(!(!r||!(r instanceof Element))){if(String(r?.dataset?.lazy||"")!=="1"){try{Pe?.unobserve?.(r)}catch{}continue}Qo(r).catch(()=>{})}}},{root:null,rootMargin:"0px 200px 0px 200px",threshold:.15}),document.querySelectorAll('.platform-card[data-lazy="1"]').forEach(e=>{try{Pe.observe(e)}catch{}})}var Ie=null,be=null;function Gr(e,t,r){return new Promise(n=>{if(be)try{be(!1)}catch{}if(be=n,!Ie){let o=document.createElement("div");o.className="tr-confirm-overlay",o.innerHTML=`
                <div class="tr-confirm-modal" role="dialog" aria-modal="true">
                    <div class="tr-confirm-message"></div>
                    <div class="tr-confirm-actions">
                        <button type="button" class="tr-confirm-btn tr-confirm-cancel" data-action="cancel"></button>
                        <button type="button" class="tr-confirm-btn tr-confirm-ok" data-action="ok"></button>
                    </div>
                </div>`,o.addEventListener("click",s=>{let i=s?.target;if(!i||!(i instanceof Element))return;let a=i.closest('button[data-action="ok"]'),c=i.closest('button[data-action="cancel"]');if(a){s.preventDefault(),o.classList.remove("show");let d=be;be=null,d?.(!0);return}if(c||i===o){s.preventDefault(),o.classList.remove("show");let d=be;be=null,d?.(!1)}}),document.body.appendChild(o),Ie=o}try{let o=Ie.querySelector(".tr-confirm-message");o&&(o.textContent=String(e||""));let s=Ie.querySelector('button[data-action="ok"]');s&&(s.textContent=String(t||"\u786E\u8BA4"));let i=Ie.querySelector('button[data-action="cancel"]');i&&(i.textContent=String(r||"\u53D6\u6D88"))}catch{}Ie.classList.add("show")})}async function Zo(e){let t=String(e||"").trim();if(!t)return!1;try{let r=await fetch("/api/me/rss-subscriptions",{method:"GET"});if(!r.ok)return!1;let n=await r.json().catch(()=>({}));return!(Array.isArray(n?.subscriptions)?n.subscriptions:[]).some(i=>String(i?.source_id||i?.rss_source_id||"").trim()===t)}catch{return!1}}async function es(e){let t=String(e||"").trim();if(!t.startsWith("rss-"))return!1;let r=t.slice(4);if(!r||!l.subscription)return!1;try{l.subscription.ensureSnapshot?.()}catch{}let n=[];try{n=l.subscription.getSubscriptions?l.subscription.getSubscriptions():[]}catch{n=[]}let o=(Array.isArray(n)?n:[]).filter(s=>String(s?.source_id||s?.rss_source_id||"").trim()!==r);try{l.subscription.setSubscriptions?.(o)}catch{return!1}try{l.subscription.saveOnly?await l.subscription.saveOnly():l.subscription.saveAndRefresh&&await l.subscription.saveAndRefresh()}catch{return!1}return await Zo(r)}async function ts(e){if(!e||!(e instanceof Element))return;let t=Yo(e),r=String(e.getAttribute("data-platform")||"").trim();if(!t||!r||t==="explore"||!r.startsWith("rss-"))return;try{let a=!0;try{new URLSearchParams(window.location.search).get("e2e")==="1"&&(a=!1)}catch{}try{typeof navigator<"u"&&navigator.webdriver===!0&&(a=!1)}catch{}if(a&&!await Gr("\u786E\u5B9A\u8981\u5220\u9664\u8BE5 RSS \u5361\u7247\u5417\uFF1F\u5220\u9664\u540E\u5C06\u53D6\u6D88\u8BA2\u9605\u3002","\u786E\u8BA4\u5220\u9664","\u53D6\u6D88"))return}catch{}try{let a=e.querySelector('button[data-action="delete-platform"]');a&&a.setAttribute("disabled","true")}catch{}let o=e.parentNode,s=e.nextSibling;try{o&&o.removeChild(e)}catch{}try{l.counts?.updateAllCounts?.()}catch{}if(!await es(r)){try{o&&(s?o.insertBefore(e,s):o.appendChild(e))}catch{}try{let a=e.querySelector('button[data-action="delete-platform"]');a&&a.removeAttribute("disabled")}catch{}try{l.toast?.show?.("\u5220\u9664\u5931\u8D25\uFF1A\u8BA2\u9605\u672A\u80FD\u4ECE\u670D\u52A1\u7AEF\u79FB\u9664\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"error",durationMs:2500})}catch{}return}try{l.counts?.updateAllCounts?.(),l.readState?.updateReadCount?.()}catch{}}var ht={formatUpdatedAt:dt,snapshotViewerState(){let e=T.getRaw(qt)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(i=>{let a=i.dataset.platform;a&&(t[a]=parseInt(i.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,n=r&&r.scrollLeft||0,o=null,s=0;if(r){let i=r.scrollLeft||0,a=null,c=r.querySelectorAll(".platform-card");for(let d of c)if((d.offsetLeft||0)<=i+1)a=d;else break;a?.dataset?.platform&&(o=a.dataset.platform,s=Math.max(0,i-(a.offsetLeft||0)))}return e&&r&&l.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:n,activeTabPlatformAnchorPlatformId:o,activeTabPlatformAnchorOffsetX:s,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),n=document.querySelector(".category-tabs");if(!n||!r)return;let o="";try{let w=document.getElementById("tab-knowledge"),x=w?w.querySelector(".platform-grid"):null,_=!!(x&&x.querySelector(".tr-morning-brief-card")),E=!!(x&&x.querySelector(".news-item"));_&&E&&(o=String(x.innerHTML||""))}catch{o=""}let s=l.settings.applyCategoryConfigToData(e?.categories||{});Vo=s;let i=t&&typeof t.activeTab=="string"?t.activeTab:null,a=(()=>{try{return new URLSearchParams(window.location.search).get("e2e")==="1"}catch{return!1}})(),c=Object.keys(s||{}),d=c[0]||null;d==="explore"&&(d=c.find(w=>w!=="explore")||d),a&&d==="rsscol-rss"&&(d=c.find(w=>w!=="rsscol-rss")||d);let u=i||d;u==="explore"&&(u=c.find(w=>w!=="explore")||u),a&&u==="rsscol-rss"&&(u=c.find(w=>w!=="rsscol-rss")||u);let f=Object.entries(s).map(([w,x])=>{let _=S(x?.icon||""),E=S(x?.name||w),H=`${x?.is_new?`<span class="new-badge new-badge-category" data-category="${S(w)}">NEW</span>`:""}${w==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab${String(w)===String(u)?" active":""}" data-category="${S(w)}" draggable="false" onclick="switchTab('${S(w)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${_}</div>
                <div class="category-tab-name">${E}${H}</div>
            </div>`}).join(""),m=Object.entries(s).map(([w,x])=>{let _=!!u&&String(w)===String(u),E=_?" active":"";if(String(w)==="rsscol-rss")return`
                <div class="tab-pane${E}" id="tab-${S(w)}">
                    <div class="platform-grid" style="display:flex;flex-direction:column;gap:10px;min-height:0;">
                        
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <div id="rssCategoryCarouselStatus" style="color:#6b7280;font-size:0.85rem;flex:1;min-width:200px;"></div>
                    </div>
                        <div id="rssCategoryCarouselGrid" style="display:flex;flex-direction:column;gap:10px;min-height:0;"></div>
                    </div>
                    <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
                </div>`;if(String(w)==="explore")return`
                <div class="tab-pane${E}" id="tab-${S(w)}">
                    <div class="platform-grid" id="trExploreGrid"></div>
                </div>`;if(String(w)==="knowledge"){let p=o||`
                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-1" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u{1F552} \u6700\u65B0 1-50</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice1">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>

                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-2" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u2B50 \u6700\u65B0 51-100</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice2">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>

                    <div class="platform-card tr-morning-brief-card" data-platform="mb-slice-3" data-page-size="50" draggable="false">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">\u{1F9FE} \u6700\u65B0 101-150</div>
                            <div class="platform-header-actions"></div>
                        </div>
                        <ul class="news-list" data-mb-list="slice3">
                            <li class="news-placeholder" aria-hidden="true">\u52A0\u8F7D\u4E2D...</li>
                        </ul>
                    </div>
                `;return`
                <div class="tab-pane${E}" id="tab-${S(w)}">
                    <div class="platform-grid" data-mb-injected="1">${p}</div>
                </div>`}let ae=x?.platforms||{},D=Object.keys(ae||{}),H=_&&t?.activeTabPlatformAnchorPlatformId||null,fe=H?D.indexOf(H):-1,it=3,$t=D.map((p,C)=>{let b=ae?.[p];if(!b)return"";let A=S(b?.name||p),N=b?.is_new?`<span class="new-badge new-badge-platform" data-platform="${S(p)}">NEW</span>`:"",B=Array.isArray(b?.news)?b.news:[],q=B.length,me=_&&(fe<0?C<3:C>=fe-it&&C<=fe+it),ee=!me,Le=me?Math.min(q,Oe):0,te=p&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[p])?t.pagingOffsets[p]:0,re=B.slice(0,Le),Pt=ee?Ko(8):re.map((X,It)=>{let Ot=S(X?.stable_id||""),ct=S(X?.display_title||X?.title||""),Nt=S(X?.url||""),Er=S(X?.meta||""),bo=String(p||"").startsWith("rss-"),xr=!!X?.is_cross_platform,vo=Array.isArray(X?.cross_platforms)?X.cross_platforms:[],So=S(vo.join(", ")),Co=S(X?.cross_platform_count??""),_o=xr?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${So}">\u{1F525} ${Co}</span>`:"",Eo=xr?"cross-platform":"",xo='<input type="checkbox" class="news-checkbox" title="\u6807\u8BB0\u5DF2\u8BFB" onchange="markAsRead(this)" />',To=`<span class="news-index">${String(It+1)}</span>`,Ao=It<te||It>=te+Oe?" paged-hidden":"",Lo=Er&&!bo?`<div class="news-subtitle">${Er}</div>`:"",ko=Nt||"#",Tr=ge(X?.timestamp),Mo=Tr?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${S(Tr)}</span>`:"",$o=`<button class="news-summary-btn" data-news-id="${Ot}" data-title="${ct.replace(/"/g,"&quot;")}" data-url="${Nt.replace(/"/g,"&quot;")}" data-source-id="${S(p)}" data-source-name="${A.replace(/"/g,"&quot;")}" onclick="handleSummaryClick(event, '${Ot}', '${ct.replace(/'/g,"\\'")}', '${Nt.replace(/'/g,"\\'")}', '${S(p)}', '${A.replace(/'/g,"\\'")}')" title="AI \u603B\u7ED3">\u{1F4DD}</button>`;return`
                        <li class="news-item${Ao}" data-news-id="${Ot}" data-news-title="${ct}">
                            <div class="news-item-content">
                                ${xo}
                                ${To}
                                <a class="news-title ${Eo}" href="${ko}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${ct}
                                    ${_o}
                                </a>
                                ${Mo}
                                ${$o}
                            </div>
                            ${Lo}
                        </li>`}).join(""),lt=Xo(w,p);return`
                <div class="platform-card" data-platform="${S(p)}" data-total-count="${String(q)}" data-loaded-count="${String(Le)}" data-lazy="${ee?"1":"0"}" data-loaded-done="${ee?"0":"1"}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${S(p)}')">\u{1F4F1} ${A}${N}</div>
                        <div class="platform-header-actions">${lt}</div>
                    </div>
                    <ul class="news-list">${Pt}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).filter(Boolean).join("");return`
            <div class="tab-pane${E}" id="tab-${S(w)}">
                <div class="platform-grid">${$t}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");n.innerHTML=f,r.innerHTML=m;try{let w=!!window.matchMedia&&window.matchMedia("(max-width: 640px)").matches,x=n.querySelectorAll(".category-tab").length;w?n.classList.remove("compact"):n.classList.toggle("compact",x>8)}catch{}let g=document.getElementById("updatedAt");g&&e?.updated_at&&(g.textContent=dt(e.updated_at));let h=t&&typeof t.activeTab=="string"?t.activeTab:null;if(h){let w=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(h):h;if(document.querySelector(`.category-tab[data-category="${w}"]`))l.tabs.switchTab(h);else{let _=document.querySelector(".category-tab");_?.dataset?.category?l.tabs.switchTab(_.dataset.category):T.remove(qt)}}else{let w=document.querySelector(".category-tab");w?.dataset?.category?l.tabs.switchTab(w.dataset.category):T.remove(qt)}let v=typeof t?.showReadMode=="boolean"?t.showReadMode:l.readState.getShowReadModePref();l.readState.applyShowReadMode(v);let y=document.getElementById("searchInput");y&&typeof t?.searchText=="string"&&(y.value=t.searchText),l.search.searchNews(),l.filter.applyCategoryFilterForActiveTab(),l.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(w=>{let x=w.dataset.platform,_=x&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[x])?t.pagingOffsets[x]:0;l.paging.setCardPageSize(w,l.paging.PAGE_SIZE),l.paging.applyPagingToCard(w,_)}),l.counts.updateAllCounts(),l.readState.updateReadCount(),l.scroll.restoreActiveTabPlatformGridScroll(t),l.scroll.attachPlatformGridScrollPersistence();let M=document.getElementById("early-hide");M&&M.remove(),document.body.classList.add("categories-ready"),l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1}),jr();try{l.infiniteScroll&&typeof l.infiniteScroll.attach=="function"&&l.infiniteScroll.attach()}catch{}},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(Ht){$e?$e.preserveScroll=$e.preserveScroll&&t:$e={preserveScroll:t};return}Ht=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let o=await(await fetch("/api/news")).json();try{l.settings?.syncCacheWithServer&&o?.categories&&l.settings.syncCacheWithServer(o.categories)}catch(s){console.error("[HotNews] Cache sync failed:",s)}this.renderViewerFromData(o,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),l.scroll.restoreActiveTabPlatformGridScroll(r)),Wo=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{Ht=!1;let r=$e;$e=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),n=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),n.className="fetch-status",n.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let s=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),s.success?(r.style.width="100%",n.className="fetch-status success",n.textContent=`\u2705 ${s.platforms} \u4E2A\u5E73\u53F0\uFF0C${s.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${s.error}`)}catch(o){r.classList.remove("indeterminate"),r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${o.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){let t=async()=>{if(document.visibilityState==="visible")try{let r=await fetch("/api/news/check-updates");if(!r.ok)return;let n=await r.json();if(n.categories)for(let[o,s]of Object.entries(n.categories))s&&this.showCategoryUpdateDot(o)}catch{}};setInterval(t,3e5),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&setTimeout(t,2e3)})},showCategoryUpdateDot(e){if(["explore","knowledge"].includes(e))return;let r=document.querySelector(`.category-tab[data-category="${e}"]`);if(!r)return;let n=r.querySelector(".update-dot");n||(n=document.createElement("span"),n.className="update-dot",r.style.position="relative",r.appendChild(n)),n.classList.add("show")},hideCategoryUpdateDot(e){let t=document.querySelector(`.category-tab[data-category="${e}"]`);if(!t)return;let r=t.querySelector(".update-dot");r&&r.classList.remove("show")}};window.fetchData=()=>ht.fetchData();window.refreshViewerData=e=>ht.refreshViewerData(e);l.data=ht;k(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=dt(e.textContent)),ht.setupAjaxAutoRefresh(),Ur||(Ur=!0,document.addEventListener("click",t=>{let r=t?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="delete-platform"]');if(!n)return;let o=n.closest(".platform-card");o&&ts(o).catch(()=>{})}),document.addEventListener("click",async t=>{let r=t?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="hide-platform"]');if(!n)return;let o=n.closest(".platform-card"),s=String(o?.getAttribute?.("data-platform")||"").trim();if(!(!s||s.startsWith("rss-")||!await Gr("\u786E\u5B9A\u8981\u9690\u85CF\u8BE5\u5361\u7247\u5417\uFF1F\u9690\u85CF\u540E\u8BE5\u5361\u7247\u5C06\u4E0D\u518D\u663E\u793A\uFF0C\u4F60\u53EF\u4EE5\u5728\u300C\u680F\u76EE\u8BBE\u7F6E\u300D\u4E2D\u91CD\u65B0\u52FE\u9009\u5E76\u4FDD\u5B58\u6765\u6062\u590D\u663E\u793A\u3002","\u786E\u8BA4\u9690\u85CF","\u53D6\u6D88"))){try{n.setAttribute("disabled","true")}catch{}try{l.settings?.togglePlatformHidden?.(s)}catch{}}})),jr()});var yt=window.SYSTEM_SETTINGS?.display?.items_per_card||20,rs="240px 0px 240px 0px",z=window.SYSTEM_SETTINGS?.display?.items_per_card||20;var $i=24*3600,Ye=null,zt=!1,Xe=0,ns=1,Wr=0,os=600,wt=null,Ke=null,ss=160,bt=null,Je=null,as=250;function jt(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}var is=Math.floor(Date.now()/1e3),Vr=new Set;function Ut(e){e&&Vr.add(e)}var ls=["explore","knowledge"];function cs(e,t){let r=Number(e)||0;return!r||ls.includes(t)||!Vr.has(t)?!1:r>is}function Gt(e,t){try{let r=e?.querySelector?.(".news-list");if(!r)return;let n=r.querySelector(".news-placeholder");n||(n=document.createElement("li"),n.className="news-placeholder",n.setAttribute("aria-hidden","true"),r.appendChild(n)),n.textContent=String(t||"")}catch{}}function Yr(){if(clearTimeout(wt),wt=null,Ke){try{Ke.abort()}catch{}Ke=null}try{document.querySelectorAll(".platform-card").forEach(e=>{let t=e?.querySelector?.(".news-list");if(!t)return;let r=t.querySelector(".news-placeholder");!r||t.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function ds(e,t={}){Yr(),Ke=new AbortController;let r=Ke.signal;wt=setTimeout(()=>{wt=null,Qr(e,{...t,signal:r}).catch(()=>{})},ss)}function Xr(){if(clearTimeout(bt),bt=null,Je){try{Je.abort()}catch{}Je=null}}function Kr(e,t,r,n,o){let s=document.createElement("li");s.className="news-item";let i=String(e?.stable_id||"");s.dataset.newsId=i,s.dataset.newsTitle=String(e?.display_title||e?.title||"");let a=document.createElement("div");a.className="news-item-content";let c=e?.published_at||e?.created_at||e?.timestamp||0;if(cs(c,n||jt())){let y=document.createElement("span");y.className="tr-new-dot",a.appendChild(y)}let d=document.createElement("input");d.type="checkbox",d.className="news-checkbox",d.title="\u6807\u8BB0\u5DF2\u8BFB",d.addEventListener("change",()=>{try{window.markAsRead(d)}catch{}});let u=document.createElement("span");u.className="news-index",u.textContent=String(t);let f=document.createElement("a");if(f.className="news-title",e?.is_cross_platform&&f.classList.add("cross-platform"),f.href=String(e?.url||"#"),f.target="_blank",f.rel="noopener noreferrer",f.setAttribute("onclick","handleTitleClickV2(this, event)"),f.setAttribute("onauxclick","handleTitleClickV2(this, event)"),f.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),f.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),f.textContent=String(e?.display_title||e?.title||""),e?.is_cross_platform){let y=Array.isArray(e?.cross_platforms)?e.cross_platforms:[],M=document.createElement("span");M.className="cross-platform-badge",M.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${y.join(", ")}`,M.textContent=`\u{1F525} ${String(e?.cross_platform_count??"")}`,f.appendChild(document.createTextNode(" ")),f.appendChild(M)}a.appendChild(d),a.appendChild(u),a.appendChild(f);let m=ge(e?.timestamp);if(m){let y=document.createElement("span");y.className="tr-news-date",y.style.marginLeft="8px",y.style.color="#9ca3af",y.style.fontSize="12px",y.style.whiteSpace="nowrap",y.textContent=m,a.appendChild(y)}let g=document.createElement("button");g.className="news-summary-btn",g.dataset.newsId=i,g.dataset.title=String(e?.display_title||e?.title||""),g.dataset.url=String(e?.url||""),g.dataset.sourceId=r,g.dataset.sourceName=o||"",g.title="AI \u603B\u7ED3",g.textContent="\u{1F4DD}",g.onclick=y=>{typeof window.handleSummaryClick=="function"&&window.handleSummaryClick(y,i,String(e?.display_title||e?.title||""),String(e?.url||""),r,o||"")},a.appendChild(g),s.appendChild(a);let h=String(e?.meta||"").trim(),v=String(r||"").startsWith("rss-");if(h&&!v){let y=document.createElement("div");y.className="news-subtitle",y.textContent=h,s.appendChild(y)}return ms(s),fs(s),s}async function Jr(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let n=t.signal;if(n?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let o=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(o=l.filter.getCategoryFilterConfig(e))}catch{o=null}let s=o?.mode||"exclude",i=Array.isArray(o?.keywords)?o.keywords:[],a=Number.isFinite(t.pageSize)?t.pageSize:z,c=Math.min(Math.max(1,a),z),d=Array.from(r.querySelectorAll(".platform-card")),u=d.map(g=>(g?.dataset?.platform||"").trim()).filter(Boolean);if(u.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let g of d)g&&(g.dataset.loading="1",Gt(g,"\u52A0\u8F7D\u4E2D..."));let f;try{let g=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(c))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:u}),signal:n});if(!g.ok)return;f=await g.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let m=f&&f.platforms||{};for(let g of d){if(n?.aborted)return;let h=(g?.dataset?.platform||"").trim();if(!h)continue;let v=g.querySelector(".news-list");if(!v)continue;v.querySelectorAll(".news-placeholder").forEach(E=>E.remove()),v.querySelectorAll(".news-item").forEach(E=>E.remove());let y=m[h]||{},M=Array.isArray(y.items)?y.items:[],w=g.querySelector(".platform-name"),x=w?w.textContent.trim():h;for(let E=0;E<M.length;E++)v.appendChild(Kr(M[E],E+1,h,e,x));let _=v.querySelectorAll(".news-item").length;g.dataset.loadedCount=String(_),g.dataset.hasMore=y.has_more&&_<z?"1":"0",g.dataset.loading="0",g.dataset.loadedDone="1";try{if(l.paging){let E=Math.min(z,_);l.paging.setCardPageSize(g,E),l.paging.applyPagingToCard(g,0)}}catch{}l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(g)}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(e)}catch{}}function us(e,t={}){Xr(),Je=new AbortController;let r=Je.signal;bt=setTimeout(()=>{bt=null,Jr(e,{...t,signal:r}).catch(()=>{})},as)}async function Qr(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;let n=t.signal;if(n?.aborted)return;let o=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(o=l.filter.getCategoryFilterConfig(e))}catch{o=null}let s=o?.mode||"exclude",i=Array.isArray(o?.keywords)?o.keywords:[],a=s==="include"&&i.length>0,c=Number.isFinite(t.maxPagesPerCard)?t.maxPagesPerCard:a?2:1,d=Number.isFinite(t.cap)?t.cap:a?10:4,u=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,d));for(let f of u){if(n?.aborted)return;if(!f)continue;let m=f.querySelector(".news-list");if(!m)continue;let g=m.querySelectorAll(".news-item").length;if(a&&g>0){f.dataset.loadedDone="1";continue}if(!a&&g>0){f.dataset.loadedDone="1";continue}let h=yt;for(let v=0;v<c;v++){if(n?.aborted)return;Gt(f,"\u52A0\u8F7D\u4E2D..."),await Zr(f,Math.min(h,z),{signal:n});try{l.paging&&(l.paging.setCardPageSize(f,Math.min(h,z)),l.paging.applyPagingToCard(f,0))}catch{}let y=f.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!a||y>0||!(f.dataset.hasMore!=="0"))break;h+=yt}f.dataset.loadedDone="1"}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(e)}catch{}}function fs(e){try{let t=jt();if(!t||!l.filter?.getCategoryFilterConfig)return;let r=l.filter.getCategoryFilterConfig(t),n=r?.mode||"exclude",o=Array.isArray(r?.keywords)?r.keywords:[],s=(e?.textContent||"").toLowerCase(),i=o.length>0?o.some(c=>s.includes(c)):!1;(o.length===0?!1:n==="include"?!i:i)?e.classList.add("filtered"):e.classList.remove("filtered")}catch{}}function ms(e){try{let t=e?.dataset?.newsId;if(!t||!l.readState?.getReadNews||!(l.readState.getReadNews()||{})[t])return;e.classList.add("read")}catch{}}async function Zr(e,t,r={}){let n=(e?.dataset?.platform||"").trim();if(!n)return{ok:!1,hasMore:!1};let o=r.signal;if(o?.aborted)return{ok:!1,hasMore:!0};if(e.dataset.loading==="1")return{ok:!1,hasMore:!0};if(e.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let s=e.querySelector(".news-list");if(!s)return{ok:!1,hasMore:!1};s.querySelectorAll(".news-placeholder").forEach(a=>a.remove()),t=Math.min(Math.max(0,t||0),z);let i=s.querySelectorAll(".news-item").length;if(i>=z)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};if(i>=t)return{ok:!0,hasMore:!0};e.dataset.loading="1";try{if(Xe>=ns)return{ok:!1,hasMore:!0};Xe+=1;let a=Math.min(yt,Math.max(0,z-i));if(a<=0)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};let c=`/api/news/page?platform_id=${encodeURIComponent(n)}&offset=${encodeURIComponent(String(i))}&page_size=${encodeURIComponent(String(a))}`,d;try{d=await fetch(c,{signal:o})}catch(v){if(o?.aborted||v&&v.name==="AbortError")return e.querySelectorAll(".news-item").length<=0&&Gt(e,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw v}if(!d.ok)return{ok:!1,hasMore:!0};let u=await d.json(),f=Array.isArray(u?.items)?u.items:[],m=!!u?.has_more;(!m||i+f.length>=z)&&(e.dataset.hasMore="0");let g=e.querySelector(".platform-name"),h=g?g.textContent.trim():n;for(let v=0;v<f.length;v++){let y=f[v]||{},M=i+v+1,w=Kr(y,M,n,jt(),h);s.appendChild(w)}return e.dataset.loadedCount=String(s.querySelectorAll(".news-item").length),l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(e),{ok:!0,hasMore:m}}finally{Xe=Math.max(0,Xe-1),e.dataset.loading="0"}}async function gs(e){if(!e||!l.paging)return;let t=e.closest(".tab-pane");if(t&&!t.classList.contains("active"))return;let r=Date.now();if(r<Wr)return;Wr=r+os;let n=parseInt(e.dataset.pageOffset||"0",10)||0,o=l.paging.getCardPageSize(e),s=Math.max(0,z-n);if(o>=s){e.dataset.hasMore="0";return}let i=Math.min(o+yt,s),a=n+i;await Zr(e,a);let c=e.querySelectorAll(".news-item").length,d=Math.min(Math.max(o,i),Math.max(c-n,o)),u=Math.min(d,s);l.paging.setCardPageSize(e,u),l.paging.applyPagingToCard(e,n),l.counts?.updateAllCounts&&l.counts.updateAllCounts()}function en(){if(Ye){try{Ye.disconnect()}catch{}Ye=null}Ye=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting||!zt||Xe>0)continue;let n=t.target?.closest?.(".platform-card");n&&gs(n).catch(()=>{})}},{root:null,rootMargin:rs,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(e=>Ye.observe(e))}l.infiniteScroll={attach:en,ensureCategoryLoaded:Qr,scheduleEnsureCategoryLoaded:ds,cancelEnsureCategoryLoaded:Yr,bulkLoadCategory:Jr,scheduleBulkLoadCategory:us,cancelBulkLoadCategory:Xr,markCategoryViewed:Ut};k(function(){try{window.addEventListener("scroll",()=>{zt=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{zt=!0},1200),en(),setTimeout(()=>{let e=document.querySelector(".category-tabs .category-tab.active");e&&e.dataset.category&&Ut(e.dataset.category)},3e3),window.addEventListener("tr_tab_switched",e=>{let t=String(e?.detail?.categoryId||"").trim();t&&setTimeout(()=>Ut(t),2e3)})});function ps(e){return e?Array.from(e.querySelectorAll(".category-tab")).map(t=>String(t?.dataset?.category||"").trim()).filter(Boolean):[]}function hs(e){if(!Array.isArray(e)||e.length===0)return;let t=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig(),r=l.settings.normalizeCategoryConfig(t),n=l.settings.getMergedCategoryConfig(),o=Array.isArray(n?.categoryOrder)&&n.categoryOrder.length>0?n.categoryOrder.slice():e.slice(),s=new Set(e),i=0,a=o.map(c=>{let d=String(c||"").trim();if(!d||!s.has(d))return d;let u=e[i];return i+=1,u});r.categoryOrder=a,r.__migrated_explore_ai_front_v1=Date.now(),r.__migrated_explore_knowledge_front_v1=Date.now(),l.settings.saveCategoryConfig(r)}function ys(e){let t=document.querySelector(".tab-content-area");if(!t)return;let r=new Map;t.querySelectorAll(".tab-pane").forEach(o=>{let s=String(o?.id||"");s.startsWith("tab-")&&r.set(s.slice(4),o)});let n=document.createDocumentFragment();for(let o of e){let s=r.get(o);s&&n.appendChild(s)}for(let[o,s]of r.entries())e.includes(o)||n.appendChild(s);t.appendChild(n)}function tn(){let e=document.querySelector(".category-tabs");e&&e.querySelectorAll(".category-tab").forEach(t=>{try{t.setAttribute("draggable","false");let r=t.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",t.insertBefore(r,t.firstChild))}catch{}})}function ws(){let e=document.querySelector(".category-tabs");if(e)try{new MutationObserver(()=>{tn()}).observe(e,{childList:!0,subtree:!0})}catch{}}function bs(){let e=document.body;if(!e)return;let t=0,r=0,n=!1,o=()=>{t&&(window.clearTimeout(t),t=0),r&&(window.clearTimeout(r),r=0)},s=()=>{n=!1,e.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",a=>{!a.target?.closest?.(".category-tabs")||!a.target?.closest?.(".category-tab")||a.target?.closest?.(".category-drag-handle")||(o(),t=window.setTimeout(()=>{n=!0,e.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{s()},2500)},380))},!0);let i=()=>{o(),n&&s()};document.addEventListener("pointerup",i,!0),document.addEventListener("pointercancel",i,!0),document.addEventListener("scroll",i,!0)}var rn={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,tn(),ws(),bs(),document.addEventListener("click",e=>{e.target?.closest?.(".category-drag-handle")&&(e.preventDefault(),e.stopPropagation())},!0),document.addEventListener("dragstart",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tab"),n=t.closest(".category-tabs"),o=r?.dataset?.category;if(!(!r||!n||!o)){this._draggingTab=r,this._originTabsEl=n,r.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",String(o))}catch{}}},!0),document.addEventListener("dragover",e=>{let t=e.target?.closest?.(".category-tabs");if(!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl)return;let r=e.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;e.preventDefault();let n=Array.from(t.querySelectorAll(".category-tab")),o=n.indexOf(this._draggingTab),s=n.indexOf(r);o<0||s<0||o===s||(o<s?t.insertBefore(this._draggingTab,r.nextSibling):t.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",e=>{let t=e.target?.closest?.(".category-tabs");!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl||e.preventDefault()},!0),document.addEventListener("dragend",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let n=ps(r);hs(n),ys(n),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};l.categoryTabReorder=rn;k(()=>{rn.attach()});var Wt="explore",vs="tr_tab_switched",Ss=3,Cs=20;function vt(){return window.SYSTEM_SETTINGS&&window.SYSTEM_SETTINGS.display&&window.SYSTEM_SETTINGS.display.items_per_card||50}var Be=!1,Ne=0,Qe=null,ve=!1;function _s(){try{return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}catch{return null}}function Es(e){let t=Number(e||0)||0;if(!t)return"";try{let r=new Date(t*1e3),n=String(r.getFullYear()),o=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${n}-${o}-${s}`}catch{return""}}function xs(e,t={}){let r=Array.isArray(e)?e:[];return r.length?r.map((n,o)=>{let s=S(n?.stable_id||""),i=S(n?.display_title||n?.title||""),a=S(n?.url||"#"),c=Es(n?.published_at||n?.created_at),d=c?`<span class="tr-explore-time" style="margin-left:8px;color:#9ca3af;font-size:12px;">${S(c)}</span>`:"";return`
            <li class="news-item" data-news-id="${s}" data-news-title="${i}">
                <div class="news-item-content">
                    <span class="news-index">${String(o+1)}</span>
                    <a class="news-title" href="${a}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                        ${i}
                    </a>
                    ${d}
                </div>
            </li>`}).join(""):`<li class="tr-explore-empty" aria-hidden="true">${S(t.emptyText||"\u6682\u65E0\u5185\u5BB9")}</li>`}function Vt(){return document.getElementById(`tab-${Wt}`)}function Yt(){let e=Vt();return e?e.querySelector(".platform-grid"):null}function sn(){let e=Vt();if(!e)return!1;let t=e.querySelector(".platform-grid");t?t.style.overscrollBehavior="contain":(t=document.createElement("div"),t.className="platform-grid",t.style.display="flex",t.style.flexDirection="row",t.style.overflowX="auto",t.style.overflowY="hidden",t.style.alignItems="flex-start",t.style.overscrollBehavior="contain",e.appendChild(t));try{t.dataset&&(t.dataset.exploreInjected="1")}catch{}return!0}async function Ts(e){let t=await fetch(e,{method:"GET"});if(!t.ok)throw new Error(`HTTP ${t.status}`);return await t.json()}async function an(e,t){let r=`/api/rss/explore/timeline?limit=${encodeURIComponent(String(e))}&offset=${encodeURIComponent(String(t))}`,n=await Ts(r);return Array.isArray(n?.items)?n.items:[]}function ln(e,t,r){if(!e||!e.length)return;let n=document.createElement("div");n.className="platform-card tr-explore-card",n.style.minWidth="360px",n.dataset.platform=`explore-slice-${t}`,n.draggable=!1;let o=vt(),s=t*o+1,i=t*o+e.length;n.innerHTML=`
        <div class="platform-header">
            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">
                \u{1F4F0} \u6700\u65B0 ${s}-${i}
            </div>
            <div class="platform-header-actions"></div>
        </div>
        <ul class="news-list" data-explore-list="slice-${t}">
            ${xs(e,{emptyText:"\u6682\u65E0\u5185\u5BB9"})}
        </ul>
    `,n.querySelectorAll(".news-index").forEach((d,u)=>{d.textContent=String(s+u)});let c=r.querySelector("#explore-load-sentinel");c?r.insertBefore(n,c):r.appendChild(n)}function As(e){let t=e.querySelector("#explore-load-sentinel");t&&t.remove();let r=document.createElement("div");return r.id="explore-load-sentinel",r.style.minWidth="20px",r.style.height="100%",r.style.flexShrink="0",r.innerHTML='<div style="width:20px;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;">\u23F3</div>',e.appendChild(r),r}function cn(){Qe&&(Qe.disconnect(),Qe=null);let e=Vt();if(!e)return;Qe=new IntersectionObserver(r=>{for(let n of r)n.isIntersecting&&nn().catch(()=>{})},{root:e.querySelector(".platform-grid"),rootMargin:"200px",threshold:.01});let t=e.querySelector("#explore-load-sentinel");t&&(Qe.observe(t),setTimeout(()=>{let r=t.getBoundingClientRect(),n=e.querySelector(".platform-grid");n&&r.left<n.getBoundingClientRect().right&&nn().catch(()=>{})},100))}async function nn(){if(!(Be||ve)){Be=!0;try{let e=vt();if(Math.floor(Ne/e)>=Cs){ve=!0;let o=document.getElementById("explore-load-sentinel");o&&(o.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u8FBE\u5230\u6700\u5927\u663E\u793A\u6570\u91CF</div>',o.style.width="40px");return}let r=await an(e,Ne);if(!r.length){ve=!0;let o=document.getElementById("explore-load-sentinel");o&&(o.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u663E\u793A\u5168\u90E8\u5185\u5BB9</div>',o.style.width="40px");return}let n=Yt();if(n){let o=Math.floor(Ne/vt());ln(r,o,n)}if(Ne+=r.length,r.length<e){ve=!0;let o=document.getElementById("explore-load-sentinel");o&&o.remove()}}catch(e){console.error("Explore load error:",e)}finally{Be=!1}}}async function Ls(){let e=Yt();if(!e)return;Ne=0,ve=!1,e.innerHTML="",As(e);let t=vt(),r=t*Ss,n=await an(r,0);if(!n.length){e.innerHTML='<div style="padding:40px;text-align:center;color:#9ca3af;width:100%;">\u6682\u65E0\u5185\u5BB9</div>';return}for(let o=0;o<n.length;o+=t){let s=n.slice(o,o+t),i=Math.floor(o/t);ln(s,i,e)}if(Ne=n.length,n.length<r){ve=!0;let o=document.getElementById("explore-load-sentinel");o&&o.remove()}else cn()}async function dn(e=!1){if(_s()!==Wt||!sn())return!1;let t=Yt();if(!e&&t&&t.querySelectorAll(".platform-card").length>0)return Be=!1,!0;Be=!0;try{return await Ls(),!0}catch(r){return console.error("Explore refresh error:",r),!1}finally{Be=!1}}var on=!1;async function un(){on||sn()&&(on=!0,await dn())}function ks(){try{window.addEventListener(vs,e=>{let t=String(e?.detail?.categoryId||"").trim(),r=!!e?.detail?.hasUpdate;t===Wt&&(ve||cn(),dn(r).catch(()=>{}))})}catch{}}function Ms(){if(l.exploreTimeline&&l.exploreTimeline._patched===!0)return;let e=l.data?.renderViewerFromData;typeof e=="function"&&(l.data.renderViewerFromData=function(r,n){e.call(l.data,r,n);try{un().catch(()=>{})}catch{}},l.exploreTimeline={...l.exploreTimeline||{},_patched:!0})}k(function(){Ms(),un().catch(()=>{}),ks()});var Ze=15,St="rsscol-rss",$s=3,Xt="hotnews_rss_carousel_cursor_v1",er=!1,Ce=!1,ne=[],Kt=0,Ct=0,_e=!1,oe=-1,I=null,Re=new Map,j=null,Ee=null,Q=0,Et=!1,_t=!1,tr=0,rr=0,Se=null;function gn(){try{return window.sessionStorage}catch{return null}}function Ps(){try{let e=gn();if(!e)return null;let t=e.getItem(Xt),r=Number(t);return!Number.isFinite(r)||r<0?null:Math.floor(r)}catch{return null}}function Is(e){try{let t=gn();if(!t)return;let r=Number(e);if(!Number.isFinite(r)||r<0){t.removeItem(Xt);return}t.setItem(Xt,String(Math.floor(r)))}catch{}}function pn(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function Os(e){if(!G()||!pn()||document.querySelector(".settings-modal-overlay.show")||Et)return;let t=e?.target;if(!t||!(t instanceof Element)||t.closest("a,button,input,textarea,select")||!t.closest(".rss-carousel-frame"))return;let r=e?.touches;!r||r.length!==1||(_t=!0,Se=null,tr=Number(r[0]?.clientX||0),rr=Number(r[0]?.clientY||0))}function Ns(e){if(!_t||!G())return;let t=e?.touches;if(!t||t.length!==1)return;let r=Number(t[0]?.clientX||0),n=Number(t[0]?.clientY||0),o=r-tr,s=n-rr,i=Math.abs(o),a=Math.abs(s);if(!Se){if(i<10&&a<10)return;Se=i>=a?"x":"y"}try{e.preventDefault()}catch{}}function fn(e){if(!_t||(_t=!1,!G())||!pn())return;let t=e?.changedTouches;if(!t||t.length<1)return;let r=Number(t[0]?.clientX||0),n=Number(t[0]?.clientY||0),o=r-tr,s=n-rr,i=Math.abs(o),a=Math.abs(s),c=44;if((Se==="x"||Se==null)&&i>=c&&i>a){o<0?Fe():tt();return}(Se==="y"||Se==null)&&a>=c&&a>i&&(s<0?De(-1):De(1))}function hn(){try{return l.tabs?.getActiveTabId?l.tabs.getActiveTabId():null}catch{return null}}function Bs(e){if(!G())return;let t=async()=>{if(Ce||j!=null)return;let r=[];for(let o=1;o<=$s;o+=1)r.push(e+o);let n=Math.max(...r);Number.isFinite(n)&&n>=0&&await et(n);for(let o of r)try{if(o<0)continue;await et(o);let s=ne[o];if(!s)continue;await Sn(s)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>t().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>t().catch(()=>{}),0)}function nr(){return document.getElementById("rssCategoryPickerModal")}function Rs(){if(nr())return;let e=document.createElement("div");e.id="rssCategoryPickerModal",e.className="settings-modal-overlay",e.style.zIndex="9999",e.addEventListener("click",r=>{r&&r.target===e&&Jt()}),e.innerHTML=`
        <div class="settings-modal" onclick="event.stopPropagation()" style="max-width:520px;">
            <div class="settings-modal-header">
                <span class="settings-modal-title">\u52A0\u5165\u680F\u76EE</span>
                <button class="settings-modal-close" type="button" data-action="close">&times;</button>
            </div>
            <div class="settings-modal-body" style="display:flex;flex-direction:column;gap:10px;">
                <div style="color:#6b7280;font-size:0.9rem;">\u9009\u62E9\u8981\u52A0\u5165\u7684\u680F\u76EE</div>
                <div id="rssCategoryPickerList" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
        </div>`;let t=e.querySelector('button[data-action="close"]');t&&t.addEventListener("click",()=>Jt());try{document.body.appendChild(e)}catch{}}function Jt(){let e=nr();e&&(Et=!1,e.classList.remove("show"))}function mn(){let e=l.settings?.getMergedCategoryConfig?l.settings.getMergedCategoryConfig():null,t=l.settings?.getDefaultCategories?l.settings.getDefaultCategories():null,r=Array.isArray(e?.categoryOrder)?e.categoryOrder:[],n=Array.isArray(e?.customCategories)?e.customCategories:[],o=[],s=new Set;for(let i of r){let a=String(i||"").trim();if(!a||s.has(a)||a==="explore"||a.startsWith("rsscol-"))continue;s.add(a);let c=n.find(m=>String(m?.id||"")===a);if(c){let m=String(c?.name||a).trim()||a;o.push({id:a,name:m,icon:"\u{1F4F1}",isCustom:!0});continue}let d=t&&t[a]?t[a]:null;if(!d)continue;let u=String(d?.name||a).trim()||a,f=String(d?.icon||"\u{1F4C1}");o.push({id:a,name:u,icon:f,isCustom:!1})}for(let i of n){let a=String(i?.id||"").trim();if(!a||s.has(a)||a==="explore"||a.startsWith("rsscol-"))continue;s.add(a);let c=String(i?.name||a).trim()||a;o.push({id:a,name:c,icon:"\u{1F4F1}",isCustom:!0})}return o}function yn(){Rs();let e=nr();if(!e)return;let t=e.querySelector("#rssCategoryPickerList");if(t){let r=mn();t.innerHTML=r.map(n=>`
                <button type="button" class="platform-select-action-btn" data-cat-id="${S(n.id)}" style="text-align:left;">
                    ${S(n.icon)} ${S(n.name)}
                </button>`).join(""),t.querySelectorAll("button[data-cat-id]").forEach(n=>{n.addEventListener("click",async()=>{let o=String(n.getAttribute("data-cat-id")||"").trim(),i=mn().find(c=>c.id===o),a=i||{id:o,name:o,icon:"\u{1F4C1}",isCustom:!1};Jt(),await Ds(a)})})}Et=!0,e.classList.add("show");try{let r=e.querySelector(".settings-modal");r&&(r.setAttribute("tabindex","0"),r.focus())}catch{}}async function Ds(e){if(!I||!I.source_id)return;let t=String(e?.id||"").trim(),r=String(e?.name||t).trim()||t||"RSS",n=!!e?.isCustom,o=String(I.source_id||"").trim(),s=o?`rss-${o}`:"",i="RSS";t&&t!=="rsscol-rss"&&!n&&(i=t);try{l.subscription?.ensureSnapshot?.()}catch{}try{l.subscription?.stageFromCatalogPreview?.({source_id:I.source_id,url:I.url,feed_title:I.feed_title||I.platform_name,column:i,entries_count:I.entries_count||0})}catch(a){U(String(a?.message||a),{variant:"error"});return}if(n&&t&&s)try{l.settings?.addPlatformToCustomCategory?.(t,s)}catch{}I.already_added=!0;try{or(I)}catch{}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"loading",durationMs:1200})}catch{}try{l.subscription?.saveOnly?await l.subscription.saveOnly():l.subscription?.saveAndRefresh?await l.subscription.saveAndRefresh():await window.saveRssSubscriptions?.()}catch(a){U(String(a?.message||a),{variant:"error"});try{l.toast?.show?.(`\u52A0\u5165\u5931\u8D25\uFF1A${String(a?.message||a)}`,{variant:"error",durationMs:2500})}catch{}return}try{vn([I.source_id],"high").catch(()=>{})}catch{}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}}function G(){return er&&hn()===St}function Qt(){return document.getElementById("rssCategoryCarouselGrid")}function Fs(){return document.getElementById("rssCategoryCarouselStatus")}function U(e,t={}){let r=Fs();if(!r)return;let n=String(t.variant||"").toLowerCase(),o=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=o,r.textContent=e==null?"":String(e)}function wn(e){let t=Number(e||0)||0;if(!t)return"";let r=new Date(t);if(Number.isNaN(r.getTime()))return"";let n=a=>String(a).padStart(2,"0"),o=String(r.getFullYear()),s=n(r.getMonth()+1),i=n(r.getDate());return`${o}-${s}-${i}`}function bn(e){let t=[e?.published,e?.published_at,e?.pubDate,e?.updated,e?.updated_at,e?.date,e?.datetime,e?.date_published,e?.date_modified],n=Date.now()+365*24*60*60*1e3,o=s=>{let i=Number(s);return!Number.isFinite(i)||i<=0?0:i<1e11?Math.floor(i*1e3):Math.floor(i)};for(let s of t){if(s==null)continue;if(typeof s=="number"){let c=o(s);if(c>0&&c<=n)return c;continue}let i=String(s).trim();if(!i)continue;if(/^\d{10,13}$/.test(i)){let c=o(i);if(c>0&&c<=n)return c;continue}let a=Date.parse(i);if(!Number.isNaN(a)&&a>0)return a}return 0}async function vn(e,t="normal"){let r=Array.isArray(e)?e.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:t})})}catch{}}async function qs(e,t){let r=new URLSearchParams;r.set("limit",String(e)),r.set("offset",String(t));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),o=await n.json().catch(()=>({}));if(!n.ok)throw new Error(o?.detail||"Failed to load RSS sources");let s=Array.isArray(o?.sources)?o.sources:[],i=Number(o?.total||0)||0,a=Number(o?.next_offset??t+s.length)||t+s.length;return{items:s,total:i,nextOffset:a}}async function et(e){let t=Number(e);if(!Number.isFinite(t)||t<0||_e)return;let r=0;for(;ne.length<=t&&!_e&&r<50;){r+=1;let n=await qs(50,Ct);Kt=n.total,Ct=n.nextOffset;for(let o of n.items)String(o?.id||"").trim()&&ne.push(o);(!n.items.length||Ct>=Kt)&&(_e=!0)}}async function Hs(){if(_e)return;let e=0;for(;!_e&&e<200&&(e+=1,await et(ne.length),!_e););}function zs(e){return String(e?.name||e?.host||e?.id||"").trim()||"RSS"}function Us(e){let t=e?.data||{},r=String(t?.feed?.title||"").trim(),o=(Array.isArray(t?.entries)?t.entries:[]).map(s=>{let i=String(s?.title||"").trim(),a=String(s?.link||"").trim(),c=bn(s);return{title:i||a,link:a,ts:c}}).filter(s=>!!s.link);return{feedTitle:r,entries:o}}function js(){let e=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[],t=new Set;for(let r of Array.isArray(e)?e:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&t.add(n)}return t}async function Sn(e){let t=String(e?.id||"").trim();if(!t)return null;if(Re.has(t))return Re.get(t);let r=String(e?.url||"").trim(),n=zs(e),o=js(),s=[],i="",a=null;try{let m=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`);if(a=await m.json().catch(()=>({})),!m.ok)throw new Error(a?.detail||"Preview failed");let g=Us(a);i=g.feedTitle,s=g.entries}catch(m){let g={source_id:t,error:String(m?.message||m)};return Re.set(t,g),g}if(!Array.isArray(s)||s.length<=0){let m={source_id:t,error:"No entries"};return Re.set(t,m),m}let c=0;for(let m of s){let g=Number(m?.ts||0)||0;g>c&&(c=g)}if(!c&&a){let m=bn({published:a?.last_modified||a?.data?.feed?.updated||a?.data?.feed?.published||a?.data?.feed?.lastBuildDate});m>c&&(c=m)}let d=wn(c),f={source_id:t,url:r,feed_title:i||n,platform_name:i||n,entries:s,entries_count:s.length,date_str:d,error:"",already_added:o.has(t)};return Re.set(t,f),f}function or(e){let t=Qt();if(!t)return;let r=e,n=String(r?.source_id||"").trim(),o=S(r?.platform_name||"RSS"),s=r?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE",i=r?.already_added?"disabled":"",a=Array.isArray(r?.entries)?r.entries:[],c=Math.max(0,Math.ceil(a.length/Ze)-1);Q>c&&(Q=c),Q<0&&(Q=0);let d=Q*Ze,u=a.slice(d,d+Ze),f=u.map((v,y)=>{let M=S(v?.title||""),w=S(v?.link||"#"),x=S(wn(v?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${M}">
                <div class="news-item-content">
                    <span class="news-index">${String(d+y+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${w}" target="_blank" rel="noopener noreferrer">${M}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${x?"":"display:none;"}">${x}</span>
                </div>
            </li>`}).join(""),m=Math.max(0,Ze-u.length),g=m?Array.from({length:m}).map((v,y)=>{let M=d+u.length+y+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(M)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";t.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${S(n)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${o}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <button type="button" class="platform-select-action-btn" data-action="add" ${i}>${s}</button>
                    </div>
                </div>
                <ul class="news-list">${f}${g}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{t.querySelectorAll(".news-title").forEach(y=>{y instanceof HTMLElement&&(y.closest(".rss-entry-placeholder")||(y.classList.remove("tr-title-overflow-shrink"),y.scrollWidth>y.clientWidth+1&&y.classList.add("tr-title-overflow-shrink")))})})}catch{}let h=t.querySelector('button[data-action="add"]');h&&h.addEventListener("click",()=>{I&&(Et||I.already_added||(U("",{variant:"info"}),yn()))})}async function xt(e,t=1){if(!Ce){Ce=!0,Ee=Number(e);try{if(await et(e),ne.length<=0){let i=Qt();i&&(i.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),U("",{variant:"info"});return}let r=e,n=t>=0?1:-1,o=0;for(;o<200;){o+=1,r<0&&(await Hs(),r=ne.length-1),await et(r),r>=ne.length&&(r=0);let i=ne[r];if(!i){r+=n;continue}let a=await Sn(i);if(!a||a.error){r+=n;continue}oe=r,Is(oe),I=a,Q=0,or(a),U("",{variant:"info"});try{vn([a.source_id],"normal").catch(()=>{})}catch{}try{Bs(r)}catch{}return}let s=Qt();s&&(s.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),U("",{variant:"info"})}catch(r){U(String(r?.message||r),{variant:"error"})}finally{if(Ce=!1,Ee=null,G()&&j!=null){let r=Number(j);j=null;let n=Number.isFinite(oe)?oe:0,o=r>=n?1:-1;xt(r,o).catch(s=>U(String(s?.message||s),{variant:"error"}))}}}}function Fe(){if(!G())return;if(Ce){j=(j!=null?Number(j):Ee!=null?Number(Ee):oe)+1;return}let e=oe+1;xt(e,1).catch(t=>U(String(t?.message||t),{variant:"error"}))}function tt(){if(!G())return;if(Ce){j=(j!=null?Number(j):Ee!=null?Number(Ee):oe)-1;return}let e=oe-1;xt(e,-1).catch(t=>U(String(t?.message||t),{variant:"error"}))}function Gs(){Ce=!1,j=null,Ee=null,ne=[],Kt=0,Ct=0,_e=!1,oe=-1,I=null,Re=new Map,Q=0}function De(e){if(!G()||!I)return;let t=Array.isArray(I?.entries)?I.entries:[],r=Math.max(0,Math.ceil(t.length/Ze)-1),n=Math.max(0,Math.min(r,Q+e));n!==Q&&(Q=n,or(I))}function Zt(){er=!0;try{l.subscription?.ensureSnapshot?.()}catch{}Gs();let e=Ps();xt(e??0,1).catch(r=>U(String(r?.message||r),{variant:"error"}))}function Cn(){er=!1}window.rssCategoryCarouselNext=()=>Fe();window.rssCategoryCarouselPrev=()=>tt();window.rssCategoryCarouselAddToCategory=()=>{G()&&I&&(I.already_added||yn())};l.rssCategoryCarousel={open:Zt,close:Cn,next:Fe,prev:tt};k(function(){try{let e=l.tabs?.switchTab;typeof e=="function"&&(l.tabs.switchTab=function(t){e.call(l.tabs,t);try{String(t)===St?Zt():Cn()}catch{}})}catch{}document.addEventListener("keydown",e=>{if(!G()||document.querySelector(".settings-modal-overlay.show"))return;let t=e?.target;if(!(t&&t instanceof Element&&t.closest("input,textarea,select"))){if(e.key===" "||e.key==="Spacebar"||e.code==="Space"){e.preventDefault(),Fe();return}if(e.key==="ArrowUp"){e.preventDefault(),De(-1);return}if(e.key==="ArrowDown"){e.preventDefault(),De(1);return}if(e.key==="ArrowRight"){e.preventDefault(),Fe();return}if(e.key==="ArrowLeft"){e.preventDefault(),tt();return}}}),document.addEventListener("click",e=>{if(!G()||document.querySelector(".settings-modal-overlay.show"))return;let t=e?.target;if(!t||!(t instanceof Element)||t.closest("a,button,input,textarea,select"))return;let r=document.getElementById(`tab-${St}`);if(!r)return;let n=Number(e?.clientX||0),o=Number(e?.clientY||0),s=r.querySelector("#rssCategoryCarouselGrid .platform-card");if(!s)return;let i=s.getBoundingClientRect(),a=140,c=i.left-a,d=i.right+a,u=i.top-a,f=i.bottom+a;if(!(n<c||n>d||o<u||o>f)&&!(n>=i.left&&n<=i.right&&o>=i.top&&o<=i.bottom)){if(o<i.top){De(-1);return}if(o>i.bottom){De(1);return}if(n<i.left){tt();return}if(n>i.right){Fe();return}}}),document.addEventListener("touchstart",Os,{passive:!0}),document.addEventListener("touchmove",Ns,{passive:!1}),document.addEventListener("touchend",fn,{passive:!0}),document.addEventListener("touchcancel",fn,{passive:!0});try{hn()===St&&Zt()}catch{}});function xe(e){let t=e;return t?t.nodeType===3?t.parentElement||null:t:null}function qe(e){if(!e)return!1;let t=e.scrollWidth||0,r=e.clientWidth||0;return t>r+1}function _n(e){return xe(e)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function sr(e){let t=xe(e);return!t?.closest||t.closest(".platform-drag-handle")?!1:!!t.closest(".platform-header")||!!t.closest(".platform-name")}k(()=>{let t=null,r=!1,n=null,o=0,s=0,i=!1,a=0,c=null,d=0,u=0,f=0,m=.92,g=.5;function h(){c&&(cancelAnimationFrame(c),c=null),d=0}function v(p){if(!p)return null;let C=Array.from(p.querySelectorAll(".platform-card"));if(C.length===0)return null;let A=p.getBoundingClientRect().left,N=p.scrollLeft||0,B=null,q=1/0;for(let ee of C){let te=ee.getBoundingClientRect().left,re=Math.abs(te-A);re<q&&(q=re,B=ee)}return B?B.offsetLeft||0:null}function y(p){if(!p)return;let C=v(p);if(C===null)return;let b=Math.max(0,(p.scrollWidth||0)-(p.clientWidth||0)),A=Math.max(0,Math.min(b,C));p.scrollTo({left:A,behavior:"smooth"})}function M(p,C){if(!p||!qe(p))return;h(),d=C;function b(){if(Math.abs(d)<g){h(),setTimeout(()=>y(p),100);return}d*=m;let A=Math.max(0,(p.scrollWidth||0)-(p.clientWidth||0)),N=p.scrollLeft||0,B=Math.max(0,Math.min(A,N+d));if(p.scrollLeft=B,B<=0||B>=A){h(),setTimeout(()=>y(p),100);return}c=requestAnimationFrame(b)}c=requestAnimationFrame(b)}let w=!1,x=null,_=0,E=null;function ae(){if(w=!1,!x||!qe(x)){_=0;return}let p=_;if(_=0,!p)return;let C=Math.max(0,(x.scrollWidth||0)-(x.clientWidth||0)),b=x.scrollLeft||0,A=Math.max(0,Math.min(C,b+p));x.scrollLeft=A,E&&clearTimeout(E),E=setTimeout(()=>{E=null,y(x)},150)}let D=()=>{let C=performance.now()-u,b=0;i&&n&&C>0&&C<100&&(b=-(f-o)/(C/16),b=Math.max(-50,Math.min(50,b)));let A=n;t=null,r=!1,n=null,o=0,s=0,i=!1,u=0,f=0;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}A&&Math.abs(b)>2&&M(A,b)},H=(p,C,b=!1)=>{if(b){let N=xe(p)?.closest?.(".platform-card");if(!N)return!1;let B=N.closest(".platform-grid");if(!B||!qe(B))return!1;h(),n=B,o=C,s=B.scrollLeft||0,i=!1,u=performance.now(),f=C;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0}if(!sr(p)||document.querySelector(".platform-card.dragging"))return!1;let A=_n(p);if(!A||!qe(A))return!1;h(),n=A,o=C,s=A.scrollLeft||0,i=!1,u=performance.now(),f=C;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",p=>{if(p.button!==0&&p.button!==1)return;let C=xe(p.target),b=p.button===1;if(H(C,p.clientX,b)&&(t=p.pointerId,b))try{p.preventDefault()}catch{}},{passive:!1}),document.addEventListener("mousedown",p=>{if(p.button!==0&&p.button!==1||t!==null)return;let C=xe(p.target),b=p.button===1;if(H(C,p.clientX,b)&&(r=!0,b))try{p.preventDefault()}catch{}},{passive:!1}),document.addEventListener("pointermove",p=>{if(t===null||p.pointerId!==t||!n)return;if(document.querySelector(".platform-card.dragging")){D();return}let C=p.clientX-o;if(!i&&Math.abs(C)<4)return;i=!0;try{p.preventDefault()}catch{}u=performance.now(),f=p.clientX;let b=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),A=Math.max(0,Math.min(b,s-C));n.scrollLeft=A},{passive:!1}),document.addEventListener("mousemove",p=>{if(!r||!n)return;if(document.querySelector(".platform-card.dragging")){D();return}let C=p.clientX-o;if(!i&&Math.abs(C)<4)return;i=!0;try{p.preventDefault()}catch{}u=performance.now(),f=p.clientX;let b=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),A=Math.max(0,Math.min(b,s-C));n.scrollLeft=A},{passive:!1});let fe=()=>{t!==null&&(i&&(a=Date.now()+600),D())};document.addEventListener("pointerup",fe,{passive:!0}),document.addEventListener("pointercancel",fe,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(i&&(a=Date.now()+600),D())},{passive:!0}),document.addEventListener("click",p=>{if(Date.now()>a)return;let b=xe(p.target);if(sr(b)){try{p.preventDefault()}catch{}try{p.stopPropagation()}catch{}try{p.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",p=>{let C=typeof document.elementFromPoint=="function"?document.elementFromPoint(p.clientX,p.clientY):null,b=xe(C||p.target);if(!p.shiftKey||!sr(b)||document.querySelector(".platform-card.dragging"))return;let A=_n(b);if(!A||!qe(A))return;h();let N=typeof p.deltaX=="number"&&p.deltaX!==0?p.deltaX:p.deltaY;if(p.deltaMode===1?N*=20:p.deltaMode===2&&(N*=A.clientWidth||100),!!N){try{p.preventDefault()}catch{}x=A,_+=N,w||(w=!0,requestAnimationFrame(ae))}},{passive:!1});function it(p,C){if(!p)return;let b=Array.from(p.querySelectorAll(".platform-card"));if(b.length===0)return;let N=p.getBoundingClientRect().left,B=p.scrollLeft||0,q=0,me=1/0;b.forEach((te,re)=>{let Pt=te.getBoundingClientRect(),lt=Math.abs(Pt.left-N);lt<me&&(me=lt,q=re)});let ee=Math.max(0,Math.min(b.length-1,q+C));if(ee===q&&me<10){let te=Math.max(0,Math.min(b.length-1,q+C));if(te!==q){let re=b[te];re&&(h(),p.scrollTo({left:re.offsetLeft||0,behavior:"smooth"}))}return}let Le=b[ee];Le&&(h(),p.scrollTo({left:Le.offsetLeft||0,behavior:"smooth"}))}function $t(){let p=document.querySelector(".tab-pane.active");if(!p||(p.id||"")==="tab-rsscol-rss")return null;let b=p.querySelector(".platform-grid");return!b||!qe(b)?null:b}document.addEventListener("keydown",p=>{let C=p.target;if(C&&C instanceof Element&&C.closest("input,textarea,select")||document.querySelector(".settings-modal-overlay.show")||document.getElementById("rssCatalogPreviewModal")?.classList.contains("show")||p.key!=="ArrowLeft"&&p.key!=="ArrowRight")return;let b=$t();b&&(p.preventDefault(),it(b,p.key==="ArrowRight"?1:-1))})});var ir="knowledge";var qi=2*3600,Ws="tr_tab_switched",Vs=3e5,Ys=10,Xs=20;var Hi=24*3600;function nt(){return window.SYSTEM_SETTINGS&&window.SYSTEM_SETTINGS.display&&window.SYSTEM_SETTINGS.display.morning_brief_items||50}var ot=!1,ar=0,En=null,He=0,rt=null,Te=!1;function Ks(){try{return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}catch{return null}}var zi=Math.floor(Date.now()/1e3);function Js(e){return!1}function Qs(e){try{l.paging?.setCardPageSize?.(e,50),l.paging?.applyPagingToCard?.(e,0)}catch{}}function Zs(e){let t=Number(e||0)||0;if(!t)return"";try{let r=new Date(t*1e3),n=String(r.getFullYear()),o=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${n}-${o}-${s}`}catch{return""}}function ea(e,t={}){let r=Array.isArray(e)?e:[];return r.length?r.map((n,o)=>{let s=S(n?.stable_id||""),i=S(n?.display_title||n?.title||""),a=S(n?.url||"#"),c=Zs(n?.published_at||n?.created_at),d=c?`<span class="tr-mb-time" style="margin-left:8px;color:#9ca3af;font-size:12px;">${S(c)}</span>`:"",u=n?.published_at||n?.created_at||0,f=Js(u)?'<span class="tr-new-dot"></span>':"";return`
            <li class="news-item" data-news-id="${s}" data-news-title="${i}">
                <div class="news-item-content">
                    ${f}
                    <span class="news-index">${String(o+1)}</span>
                    <a class="news-title" href="${a}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                        ${i}
                    </a>
                    ${d}
                </div>
            </li>`}).join(""):`<li class="tr-mb-empty" aria-hidden="true">${S(t.emptyText||"\u6682\u65E0\u5185\u5BB9")}</li>`}function Tt(){return document.getElementById(`tab-${ir}`)}function xn(){let e=Tt();return e?e.querySelector(".platform-grid"):null}function Tn(){let e=Tt();if(!e)return!1;let t=e.querySelector(".platform-grid");t?t.style.overscrollBehavior="contain":(t=document.createElement("div"),t.className="platform-grid",t.style.display="flex",t.style.flexDirection="row",t.style.overflowX="auto",t.style.overflowY="hidden",t.style.alignItems="flex-start",t.style.overscrollBehavior="contain",e.appendChild(t));try{t.dataset&&(t.dataset.mbInjected="1")}catch{}return!0}async function ta(e){let t=await fetch(e,{method:"GET"});if(!t.ok)throw new Error(`HTTP ${t.status}`);return await t.json()}async function An(e,t){let r=`/api/rss/brief/timeline?limit=${encodeURIComponent(String(e))}&offset=${encodeURIComponent(String(t))}&drop_published_at_zero=0`,n=await ta(r);return Array.isArray(n?.items)?n.items:[]}function Ln(e,t,r){if(!e||!e.length)return;let n=document.createElement("div");n.className="platform-card tr-morning-brief-card",n.style.minWidth="360px",n.dataset.platform=`mb-slice-${t}`,n.draggable=!1;let o=nt(),s=t*o+1,i=t*o+e.length;n.innerHTML=`
        <div class="platform-header">
            <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">
                \u{1F552} \u6700\u65B0 ${s}-${i}
            </div>
            <div class="platform-header-actions"></div>
        </div>
        <ul class="news-list" data-mb-list="slice-${t}">
            ${ea(e,{emptyText:"\u6682\u65E0\u5185\u5BB9"})}
        </ul>
    `,n.querySelectorAll(".news-index").forEach((d,u)=>{d.textContent=String(s+u)});let c=r.querySelector("#mb-load-sentinel");c?r.insertBefore(n,c):r.appendChild(n),Qs(n)}function ra(e){let t=e.querySelector("#mb-load-sentinel");t&&t.remove();let r=document.createElement("div");return r.id="mb-load-sentinel",r.style.minWidth="20px",r.style.height="100%",r.style.flexShrink="0",r.innerHTML='<div style="width:20px;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;">\u23F3</div>',e.appendChild(r),r}function kn(){rt&&(rt.disconnect(),rt=null);let e=Tt();if(!e)return;rt=new IntersectionObserver(r=>{for(let n of r)n.isIntersecting&&na().catch(()=>{})},{root:e.querySelector(".platform-grid"),rootMargin:"200px",threshold:.01});let t=e.querySelector("#mb-load-sentinel");t&&rt.observe(t)}async function na(){if(ot||Te)return;if(Math.floor(He/nt())>=Xs){Te=!0;let t=document.getElementById("mb-load-sentinel");t&&(t.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u8FBE\u5230\u6700\u5927\u663E\u793A\u6570\u91CF</div>',t.style.width="40px");return}ot=!0;try{let t=nt(),r=await An(t,He);if(!r.length){Te=!0;let o=document.getElementById("mb-load-sentinel");o&&(o.innerHTML='<div style="writing-mode:vertical-rl;padding:20px;color:#9ca3af;font-size:12px;">\u5DF2\u663E\u793A\u5168\u90E8\u5185\u5BB9</div>',o.style.width="40px");return}let n=xn();if(n){let o=Math.floor(He/nt());Ln(r,o,n)}if(He+=r.length,r.length<t){Te=!0;let o=document.getElementById("mb-load-sentinel");o&&o.remove()}}catch{}finally{ot=!1}}async function oa(){let e=xn();if(!e)return;He=0,Te=!1,e.innerHTML="",ra(e);let t=nt(),r=t*Ys,n=await An(r,0);if(!n.length){e.innerHTML='<div style="padding:40px;text-align:center;color:#9ca3af;width:100%;">\u6682\u65E0\u5185\u5BB9</div>';return}for(let o=0;o<n.length;o+=t){let s=n.slice(o,o+t),i=Math.floor(o/t);Ln(s,i,e)}if(He=n.length,n.length<r){Te=!0;let o=document.getElementById("mb-load-sentinel");o&&o.remove()}else kn()}async function lr(e={}){let t=e.force===!0;if(Ks()!==ir)return!1;let r=Date.now();if(!t&&ar>0&&r-ar<Vs-5e3||!Tn())return!1;ot=!0;try{return await oa(),ar=Date.now(),!0}catch{return!1}finally{ot=!1}}function sa(){let e=Tt();if(e&&!(e.dataset&&e.dataset.mbBound==="1")){e.addEventListener("click",t=>{let r=t.target;if(!r||!(r instanceof Element))return;r.closest('[data-action="mb-refresh"]')&&(t.preventDefault(),lr({force:!0}).catch(()=>{try{l.toast?.show("\u5237\u65B0\u5931\u8D25",{variant:"error",durationMs:2e3})}catch{}}))});try{e.dataset&&(e.dataset.mbBound="1")}catch{}}}async function Mn(){Tn()&&(sa(),await lr({force:!1}))}function aa(){try{window.addEventListener(Ws,e=>{String(e?.detail?.categoryId||"").trim()===ir&&(Te||kn(),clearTimeout(En),En=setTimeout(()=>{lr({force:!1}).catch(()=>{})},120))})}catch{}}function ia(){if(l.morningBrief&&l.morningBrief._patched===!0)return;let e=l.data?.renderViewerFromData;typeof e=="function"&&(l.data.renderViewerFromData=function(r,n){e.call(l.data,r,n);try{Mn().catch(()=>{})}catch{}},l.morningBrief={...l.morningBrief||{},_patched:!0})}k(function(){ia(),Mn().catch(()=>{}),aa()});var $n=Math.floor(Date.now()/1e3),Pn=new Set;function la(e,t){let r=Number(e)||0;return!r||!Pn.has(t)?!1:r>$n}function cr(e){e&&Pn.add(e)}function ca(){return $n}async function In(e,t,r,n,o){try{await fetch("/api/news/click",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({news_id:e,url:t,title:r,source_name:n||"",category:o||""})})}catch{}}function On(e,t){if(!e)return;let r=e.querySelector(".tr-new-dot");r&&r.remove();let n=e.dataset.newsId||"",o=e.dataset.newsTitle||"",s=e.querySelector(".news-title"),i=s?s.href:"",a=e.closest(".platform-card")?.querySelector(".platform-name")?.textContent?.trim()||"";n&&In(n,i,o,a,t)}function da(){document.addEventListener("click",e=>{let t=e.target.closest(".news-title");if(!t)return;let r=t.closest(".news-item");if(!r)return;let n=r.closest(".tab-pane"),o=n?.id?.startsWith("tab-")?n.id.slice(4):"";On(r,o)})}function ua(){window.addEventListener("tr_tab_switched",e=>{let t=String(e?.detail?.categoryId||"").trim();t&&setTimeout(()=>{cr(t)},2e3)})}l.clickTracker={getSessionStartTime:ca,markCategoryViewed:cr,isNewContent:la,reportClick:In,handleNewsClick:On};k(function(){da(),ua(),setTimeout(()=>{let e=document.querySelector(".tab-pane.active");e&&e.id?.startsWith("tab-")&&cr(e.id.slice(4))},3e3)});async function Nn(){console.log("[Auth] renderUserMenu called");let e=document.querySelector(".header-right");if(!e){console.error("[Auth] .header-right not found");return}if(console.log("[Auth] .header-right found:",e),document.getElementById("userMenu")){console.log("[Auth] userMenu already exists, skipping");return}try{console.log("[Auth] Fetching /api/auth/me...");let t=await fetch("/api/auth/me");if(t.status===404){console.log("[Auth] Auth API not available (404), skipping user menu");return}if(t.status===500){console.error("[Auth] Server error (500), skipping user menu");return}let r;try{r=await t.json()}catch(o){console.error("[Auth] Failed to parse JSON response:",o);return}console.log("[Auth] API response:",r);let n=document.createElement("div");if(n.id="userMenu",n.className="user-menu",r.ok&&r.user){let o=r.user.nickname||r.user.email||"Me",s=o[0].toUpperCase();if(n.innerHTML=`
                <div class="user-avatar" onclick="toggleUserDropdown()" title="${o}">
                    ${s}
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item user-info-item">${o}</div>
                    <div class="dropdown-divider"></div>
                    <a href="/api/user/preferences/page" class="dropdown-item">\u2699\uFE0F \u6211\u7684\u8BBE\u7F6E</a>
                    <div class="dropdown-item" onclick="logoutUser()">\u{1F6AA} \u9000\u51FA\u767B\u5F55</div>
                </div>
            `,!document.getElementById("user-menu-styles")){let i=document.createElement("style");i.id="user-menu-styles",i.textContent=`
                    .user-menu { position: relative; margin-left: 10px; }
                    .user-avatar {
                        width: 32px; height: 32px; border-radius: 50%;
                        background: #3B82F6; color: white;
                        display: flex; align-items: center; justify-content: center;
                        font-weight: bold; cursor: pointer; user-select: none;
                        font-size: 14px;
                    }
                    .user-dropdown {
                        display: none; position: absolute; right: 0; top: 40px;
                        background: #1E293B; border: 1px solid #334155;
                        border-radius: 8px; width: 160px; z-index: 1000;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
                    }
                    .user-dropdown.show { display: block; }
                    .dropdown-item {
                        padding: 10px 16px; cursor: pointer; color: #F1F5F9;
                        text-decoration: none; display: block; font-size: 14px;
                    }
                    .dropdown-item:hover { background: #334155; }
                    .user-info-item { color: #94A3B8; font-size: 12px; cursor: default; }
                    .user-info-item:hover { background: transparent; }
                    .dropdown-divider { height: 1px; background: #334155; margin: 4px 0; }
                `,document.head.appendChild(i)}document.addEventListener("click",i=>{i.target.closest(".user-menu")||document.getElementById("userDropdown")?.classList.remove("show")})}else if(n.innerHTML=`
                <a href="/api/auth/page" class="login-btn">\u767B\u5F55 / \u6CE8\u518C</a>
            `,!document.getElementById("user-login-styles")){let o=document.createElement("style");o.id="user-login-styles",o.textContent=`
                    .login-btn {
                        background: #3B82F6; color: white; padding: 6px 12px;
                        border-radius: 6px; text-decoration: none; font-size: 14px;
                        margin-left: 10px; transition: background 0.2s;
                    }
                    .login-btn:hover { background: #2563EB; }
                `,document.head.appendChild(o)}e.appendChild(n),console.log("[Auth] User menu rendered successfully, logged in:",r.ok&&r.user)}catch(t){console.error("Failed to render user menu:",t)}}function Bn(){let e=document.getElementById("userDropdown");e&&e.classList.toggle("show")}async function Rn(){console.log("[Auth] Logging out...");let e=document.getElementById("userDropdown");e&&e.classList.remove("show");let t=document.querySelector(".user-avatar");t&&(t.style.opacity="0.5",t.style.cursor="wait",t.textContent="...");try{console.log("[Auth] Calling /api/auth/logout...");let r=await fetch("/api/auth/logout",{method:"POST",credentials:"same-origin"});if(!r.ok)throw new Error(`Logout failed: ${r.status}`);console.log("[Auth] Logout successful, clearing caches...");try{localStorage.removeItem("hotnews_my_tags_cache"),localStorage.removeItem("hotnews_my_tags_cache_timestamp");let n=[];for(let o=0;o<localStorage.length;o++){let s=localStorage.key(o);s&&(s.includes("user")||s.includes("auth")||s.includes("session"))&&n.push(s)}n.forEach(o=>localStorage.removeItem(o)),console.log("[Auth] Caches cleared")}catch(n){console.warn("[Auth] Failed to clear some caches:",n)}console.log("[Auth] Reloading page..."),window.location.href=window.location.pathname}catch(r){if(console.error("[Auth] Logout failed:",r),alert("\u9000\u51FA\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5"),t){t.style.opacity="1",t.style.cursor="pointer";try{let o=await(await fetch("/api/auth/me")).json();if(o.ok&&o.user){let s=o.user.nickname||o.user.email||"Me";t.textContent=s[0].toUpperCase()}}catch{t.textContent="?"}}}}window.toggleUserDropdown=Bn;window.logoutUser=Rn;window.renderUserMenu=Nn;l.auth={renderUserMenu:Nn,toggleUserDropdown:Bn,logoutUser:Rn};var dr=class{constructor(){this.currentUser=null,this.listeners=[],this.initialized=!1,this.loading=!1,this._setupBroadcastChannel()}async init(){if(this.initialized)return this.currentUser;try{await this.fetchUser(),this.initialized=!0}catch(t){console.error("[AuthState] Init failed:",t),this.currentUser=null,this.initialized=!0}return this.currentUser}async fetchUser(){if(this.loading)return this.currentUser;this.loading=!0;try{console.log("[AuthState] Fetching user...");let t=await fetch("/api/auth/me");if(t.status===404||t.status===500)this.currentUser=null;else{let r=await t.json();this.currentUser=r.ok&&r.user?r.user:null}return console.log("[AuthState] User fetched:",this.currentUser?"logged in":"not logged in"),this._notifyListeners(),this.currentUser}catch(t){return console.error("[AuthState] Fetch user failed:",t),this.currentUser=null,null}finally{this.loading=!1}}isLoggedIn(){return!!this.currentUser}getUser(){return this.currentUser}subscribe(t){return this.listeners.push(t),t(this.currentUser),()=>{this.listeners=this.listeners.filter(r=>r!==t)}}async logout(){console.log("[AuthState] Logging out...");try{let t=await fetch("/api/auth/logout",{method:"POST",credentials:"same-origin"});if(!t.ok)throw new Error(`Logout failed: ${t.status}`);return console.log("[AuthState] Logout successful"),this.currentUser=null,this._notifyListeners(),this._clearUserCaches(),this._broadcast({type:"logout"}),!0}catch(t){throw console.error("[AuthState] Logout failed:",t),t}}async onLogin(){console.log("[AuthState] Login detected, refreshing user..."),await this.fetchUser(),this._broadcast({type:"login"})}_clearUserCaches(){console.log("[AuthState] Clearing user caches...");let t=[];for(let r=0;r<localStorage.length;r++){let n=localStorage.key(r);n&&n.startsWith("hotnews_")&&t.push(n)}t.forEach(r=>localStorage.removeItem(r)),console.log("[AuthState] Cleared",t.length,"cache entries")}_notifyListeners(){this.listeners.forEach(t=>{try{t(this.currentUser)}catch(r){console.error("[AuthState] Listener error:",r)}})}_setupBroadcastChannel(){if(typeof BroadcastChannel>"u"){console.warn("[AuthState] BroadcastChannel not supported");return}try{this.channel=new BroadcastChannel("hotnews_auth"),this.channel.onmessage=t=>{console.log("[AuthState] Received broadcast:",t.data),t.data.type==="logout"?(this.currentUser=null,this._notifyListeners()):t.data.type==="login"&&this.fetchUser()}}catch(t){console.warn("[AuthState] BroadcastChannel setup failed:",t)}}_broadcast(t){if(this.channel)try{this.channel.postMessage(t)}catch(r){console.warn("[AuthState] Broadcast failed:",r)}}async verifyLogout(){try{let r=await(await fetch("/api/auth/me")).json();return!(r.ok&&r.user)}catch{return!0}}},L=new dr;(async()=>{try{let e=new URLSearchParams(window.location.search);if(e.has("login")){console.log("[AuthState] OAuth login callback detected, refreshing user..."),await L.onLogin(),e.delete("login");let t=e.toString()?`${window.location.pathname}?${e}`:window.location.pathname;window.history.replaceState({},"",t)}else if(e.has("logout")){console.log("[AuthState] Logout callback detected, clearing state..."),L.currentUser=null,L.initialized=!0,L._notifyListeners(),e.delete("logout");let t=e.toString()?`${window.location.pathname}?${e}`:window.location.pathname;window.history.replaceState({},"",t)}else await L.init();console.log("[AuthState] Auto-initialization complete, user:",L.currentUser?"logged in":"not logged in")}catch(e){console.error("[AuthState] Auto-initialization failed:",e),L.initialized=!0}})();window.authState=L;var fa="my-tags",st="hotnews_my_tags_cache",ma=5*60*1e3,ze=!1,W=!1;function ga(){return L.getUser()}function pa(){try{let e=localStorage.getItem(st);if(!e)return null;let t=JSON.parse(e),r=Date.now();return!t.timestamp||r-t.timestamp>ma?(localStorage.removeItem(st),null):t.tags}catch(e){return console.error("[MyTags] Cache read error:",e),localStorage.removeItem(st),null}}function Hn(e){try{let t={tags:e,timestamp:Date.now()};localStorage.setItem(st,JSON.stringify(t))}catch(t){console.error("[MyTags] Cache write error:",t)}}function zn(){try{localStorage.removeItem(st),console.log("[MyTags] Cache cleared")}catch(e){console.error("[MyTags] Cache clear error:",e)}}async function Un(){try{let e=await fetch("/api/user/preferences/followed-news?limit=50");if(!e.ok){if(e.status===401)return{needsAuth:!0};throw new Error("Failed to fetch")}return await e.json()}catch(e){return console.error("[MyTags] Fetch failed:",e),{error:e.message}}}async function ha(){try{let e=await fetch("/api/wechat/auth/expiration-warning");if(!e.ok)return null;let t=await e.json();return t.ok&&t.show_warning?(Dn(!0),t):(Dn(!1),null)}catch(e){return console.error("[MyTags] WeChat auth check failed:",e),null}}function Dn(e){let t=document.getElementById("categorySettingsNewBadge");t&&(e?(t.style.display="inline-block",t.style.background="#ef4444",t.classList.add("wechat-warning-dot")):t.classList.contains("wechat-warning-dot")&&(t.style.display="none",t.classList.remove("wechat-warning-dot")))}function ya(e){e.innerHTML=`
        <div style="text-align:center;padding:60px 20px;width:100%;">
            <div style="font-size:64px;margin-bottom:20px;">\u{1F3F7}\uFE0F</div>
            <div style="font-size:18px;color:#374151;margin-bottom:12px;font-weight:600;">\u60A8\u8FD8\u672A\u5173\u6CE8\u4EFB\u4F55\u6807\u7B7E</div>
            <div style="font-size:14px;color:#6b7280;margin-bottom:24px;line-height:1.6;">
                \u524D\u5F80\u300C\u6211\u7684\u8BBE\u7F6E\u300D\u6DFB\u52A0\u611F\u5174\u8DA3\u7684\u6807\u7B7E\uFF0C<br>
                \u8FD9\u91CC\u5C06\u4E3A\u60A8\u805A\u5408\u76F8\u5173\u65B0\u95FB
            </div>
            <a href="/api/user/preferences/page" 
               style="display:inline-block;padding:12px 24px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;text-decoration:none;border-radius:8px;font-weight:500;transition:transform 0.2s;"
               onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
                \u53BB\u8BBE\u7F6E\u6807\u7B7E
            </a>
        </div>
    `}function Fn(e){e.innerHTML=`
        <div style="text-align:center;padding:60px 20px;width:100%;">
            <div style="font-size:64px;margin-bottom:20px;">\u{1F512}</div>
            <div style="font-size:18px;color:#374151;margin-bottom:12px;font-weight:600;">\u8BF7\u5148\u767B\u5F55</div>
            <div style="font-size:14px;color:#6b7280;margin-bottom:24px;line-height:1.6;">
                \u767B\u5F55\u540E\u5373\u53EF\u67E5\u770B\u60A8\u5173\u6CE8\u7684\u6807\u7B7E\u65B0\u95FB
            </div>
            <a href="/api/auth/page" 
               style="display:inline-block;padding:12px 24px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;text-decoration:none;border-radius:8px;font-weight:500;transition:transform 0.2s;"
               onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
                \u7ACB\u5373\u767B\u5F55
            </a>
        </div>
    `}function ur(e,t){e.innerHTML=`
        <div style="text-align:center;padding:60px 20px;width:100%;color:#6b7280;">
            <div style="font-size:48px;margin-bottom:16px;">\u{1F615}</div>
            <div style="font-size:16px;">\u52A0\u8F7D\u5931\u8D25: ${t||"\u672A\u77E5\u9519\u8BEF"}</div>
            <button onclick="window.HotNews?.myTags?.load(true)" 
                    style="margin-top:16px;padding:8px 16px;background:#4f46e5;color:white;border:none;border-radius:6px;cursor:pointer;">
                \u91CD\u8BD5
            </button>
        </div>
    `}function wa(e){let{tag:t,news:r,count:n}=e,o=t.icon||"\u{1F3F7}\uFE0F",s=t.name||t.id,i=r.length>0?r.map((a,c)=>{let d=ge(a.published_at),u=(a.title||"").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),f=u.replace(/'/g,"\\'"),m=(a.url||"").replace(/'/g,"\\'"),g=(s||"").replace(/'/g,"\\'");return`
            <li class="news-item" data-news-id="${a.id}" data-news-title="${u}">
                <div class="news-item-content">
                    <span class="news-index">${c+1}</span>
                    <a class="news-title" href="${a.url||"#"}" target="_blank" rel="noopener noreferrer">
                        ${a.title}
                    </a>
                    ${d?`<span class="tr-news-date" style="margin-left:8px;color:#9ca3af;font-size:12px;white-space:nowrap;">${d}</span>`:""}
                    <button class="news-summary-btn" data-news-id="${a.id}" data-title="${u}" data-url="${a.url||""}" data-source-id="${t.id}" data-source-name="${s||""}" onclick="handleSummaryClick(event, '${a.id}', '${f}', '${m}', '${t.id}', '${g}')" title="AI \u603B\u7ED3">\u{1F4DD}</button>
                </div>
            </li>
            `}).join(""):'<li class="news-placeholder" style="color:#9ca3af;padding:20px;text-align:center;">\u6682\u65E0\u76F8\u5173\u65B0\u95FB</li>';return`
        <div class="platform-card" data-tag-id="${t.id}" draggable="false">
            <div class="platform-header">
                <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">
                    ${o} ${s}
                    <span style="font-size:12px;color:#9ca3af;margin-left:8px;">(${n}\u6761)</span>
                </div>
                <div class="platform-header-actions"></div>
            </div>
            <ul class="news-list">
                ${i}
            </ul>
        </div>
    `}function qn(e,t){if(console.log("[MyTags] renderTagsNews called, container:",e,"tagsData:",t),!e){console.error("[MyTags] renderTagsNews: container is null!");return}if(!t||t.length===0){console.log("[MyTags] No tags data, showing empty state"),ya(e);return}console.log("[MyTags] Rendering",t.length,"tags");let r=t.map(n=>wa(n)).join("");console.log("[MyTags] Generated HTML length:",r.length),e.innerHTML=r,console.log("[MyTags] HTML inserted into container"),window.TR&&window.TR.readState&&window.TR.readState.restoreReadState()}async function Ae(e=!1){if(console.log("[MyTags] loadMyTags called, force:",e,"loading:",W,"loaded:",ze),W){console.log("[MyTags] Already loading, skipping");return}if(ze&&!e){console.log("[MyTags] Already loaded, skipping");return}let t=document.getElementById("myTagsGrid");if(!t){console.error("[MyTags] Container #myTagsGrid not found!");return}console.log("[MyTags] Container found, starting load..."),W=!0;try{console.log("[MyTags] Checking auth...");let r=ga();if(!r){console.log("[MyTags] User not authenticated"),Fn(t),W=!1;return}if(console.log("[MyTags] User authenticated:",r),!e){let i=pa();if(i&&i.length>0){console.log("[MyTags] Loading from frontend cache, tags:",i.length),qn(t,i),ze=!0,W=!1,ba().catch(a=>{console.error("[MyTags] Background update failed:",a)});return}else console.log("[MyTags] No valid cache found")}console.log("[MyTags] Showing loading state..."),t.innerHTML=`
            <div class="my-tags-loading" style="text-align:center;padding:60px 20px;color:#6b7280;width:100%;">
                <div style="font-size:48px;margin-bottom:16px;">\u{1F3F7}\uFE0F</div>
                <div style="font-size:16px;">\u52A0\u8F7D\u4E2D...</div>
            </div>
        `,console.log("[MyTags] Fetching followed news from API...");let n=await Un();if(console.log("[MyTags] API response:",n),n.needsAuth){console.log("[MyTags] API returned needsAuth"),Fn(t),W=!1;return}if(n.error){console.error("[MyTags] API returned error:",n.error),ur(t,n.error),W=!1;return}if(!n.ok){console.error("[MyTags] API returned not ok"),ur(t,"\u8BF7\u6C42\u5931\u8D25"),W=!1;return}let o=n.tags||[];console.log("[MyTags] Got tags from API:",o.length,"tags"),n.cached?console.log(`[MyTags] Loaded from backend cache (age: ${n.cache_age}s)`):console.log("[MyTags] Loaded fresh data from database"),Hn(o),console.log("[MyTags] Rendering tags..."),qn(t,o),ze=!0,console.log("[MyTags] Load complete!");let s=await ha();s&&(console.log("[MyTags] WeChat auth warning:",s),void 0)}catch(r){console.error("[MyTags] Load error:",r),ur(t,r.message)}finally{W=!1}}async function ba(){try{let e=await Un();e.ok&&e.tags&&(Hn(e.tags),console.log("[MyTags] Background cache update completed"))}catch(e){console.error("[MyTags] Background cache update error:",e)}}function va(e){e===fa&&Ae()}function fr(){console.log("[MyTags] Initializing module...");let e=L.getUser();L.subscribe(o=>{let s=!!e,i=!!o;s!==i&&(console.log("[MyTags] Auth state changed, wasLoggedIn:",s,"isLoggedIn:",i),ze=!1,W=!1,i||zn(),document.querySelector("#tab-my-tags.active")&&(console.log("[MyTags] Tab is active, reloading..."),Ae(!0))),e=o}),window.addEventListener("tr_tab_switched",o=>{let s=o?.detail?.categoryId;console.log("[MyTags] tr_tab_switched event received, categoryId:",s),s&&va(s)}),document.querySelector("#tab-my-tags.active")&&(console.log("[MyTags] Tab is already active on page load"),Ae());let r=()=>{let o=document.querySelector('.category-tab[data-category="my-tags"]');o?(console.log("[MyTags] Attaching click listener to tab button"),o.addEventListener("click",()=>{console.log("[MyTags] Tab button clicked"),setTimeout(()=>{document.querySelector("#tab-my-tags.active")&&(console.log("[MyTags] Tab pane is now active, loading..."),Ae())},100)}),o.addEventListener("touchstart",()=>{console.log("[MyTags] Tab button touched (touchstart)"),setTimeout(()=>{document.querySelector("#tab-my-tags.active")&&(console.log("[MyTags] Tab pane is now active after touch, loading..."),Ae())},100)},{passive:!0})):(console.warn("[MyTags] Tab button not found, will retry..."),setTimeout(r,500))};r(),setTimeout(()=>{let o=document.getElementById("tab-my-tags");if(!o){console.warn("[MyTags] Tab pane not found for MutationObserver");return}new MutationObserver(i=>{for(let a of i)a.type==="attributes"&&a.attributeName==="class"&&a.target.classList.contains("active")&&(console.log("[MyTags] Tab pane became active (MutationObserver)"),!ze&&!W&&Ae())}).observe(o,{attributes:!0,attributeFilter:["class"]}),console.log("[MyTags] MutationObserver attached to tab pane")},100),console.log("[MyTags] Module initialized")}typeof window<"u"&&(window.HotNews=window.HotNews||{},window.HotNews.myTags={load:Ae,init:fr,clearCache:zn});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",fr):fr();var V=class{static container=null;static _ensureContainer(){return this.container||(this.container=document.createElement("div"),this.container.id="toast-container",this.container.style.cssText=`
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                display: flex;
                flex-direction: column;
                gap: 10px;
            `,document.body.appendChild(this.container)),this.container}static show(t,r="info"){let n=this._ensureContainer(),o=document.createElement("div"),s={success:{bg:"#059669",border:"#10b981"},error:{bg:"#dc2626",border:"#ef4444"},info:{bg:"#2563eb",border:"#3b82f6"}},i=s[r]||s.info;o.style.cssText=`
            background: ${i.bg};
            border: 1px solid ${i.border};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: 300px;
        `,o.textContent=t,n.appendChild(o),setTimeout(()=>{o.style.animation="slideOut 0.3s ease",setTimeout(()=>o.remove(),300)},3e3)}};if(!document.getElementById("toast-animations")){let e=document.createElement("style");e.id="toast-animations",e.textContent=`
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `,document.head.appendChild(e)}var Ue=class{static overlay=null;static show(t="\u52A0\u8F7D\u4E2D..."){this.overlay&&this.hide(),this.overlay=document.createElement("div"),this.overlay.id="loading-overlay",this.overlay.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        `;let r=document.createElement("div");r.style.cssText=`
            background: #1e293b;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            min-width: 150px;
        `;let n=document.createElement("div");n.style.cssText=`
            width: 24px;
            height: 24px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        `;let o=document.createElement("div");o.textContent=t,o.style.fontSize="14px",r.appendChild(n),r.appendChild(o),this.overlay.appendChild(r),document.body.appendChild(this.overlay)}static hide(){this.overlay&&(this.overlay.remove(),this.overlay=null)}};if(!document.getElementById("spinner-animation")){let e=document.createElement("style");e.id="spinner-animation",e.textContent=`
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `,document.head.appendChild(e)}var at=class{constructor(t){this.container=t,this.unsubscribe=null,this.init()}init(){this.unsubscribe=L.subscribe(t=>this.render(t))}render(t){this.container&&(t?this._renderLoggedIn(t):this._renderLoggedOut())}_renderLoggedIn(t){let r=t.nickname||t.email||"Me",n=r[0].toUpperCase();this.container.innerHTML=`
            <div class="auth-user-menu">
                <div class="auth-avatar" title="${r}">
                    ${n}
                </div>
                <div class="auth-dropdown" id="authDropdown">
                    <div class="auth-dropdown-item auth-user-info">${r}</div>
                    <div class="auth-dropdown-divider"></div>
                    <div class="auth-dropdown-item auth-logout-btn">\u{1F6AA} \u9000\u51FA\u767B\u5F55</div>
                </div>
            </div>
        `;let o=this.container.querySelector(".auth-avatar"),s=this.container.querySelector(".auth-dropdown"),i=this.container.querySelector(".auth-logout-btn");o&&s&&o.addEventListener("click",a=>{a.stopPropagation(),s.classList.toggle("show")}),i&&i.addEventListener("click",()=>this._handleLogout()),document.addEventListener("click",a=>{a.target.closest(".auth-user-menu")||s?.classList.remove("show")}),this._ensureStyles()}_renderLoggedOut(){this.container.innerHTML=`
            <button type="button" class="icon-btn auth-icon-btn" title="\u767B\u5F55 / \u6CE8\u518C" onclick="openLoginModal()">
                \u{1F464}
            </button>
        `,this._ensureStyles()}async _handleLogout(){Ue.show("\u6B63\u5728\u9000\u51FA...");try{await L.logout(),await new Promise(r=>setTimeout(r,100));let t=await L.verifyLogout();Ue.hide(),t?(V.show("\u5DF2\u9000\u51FA\u767B\u5F55","success"),window.location.pathname.includes("/preferences")&&(window.location.href="/?logout="+Date.now())):(console.warn("[AuthButton] Logout verification failed, forcing reload"),window.location.href="/?logout="+Date.now())}catch(t){Ue.hide(),V.show("\u9000\u51FA\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5","error"),console.error("[AuthButton] Logout error:",t)}}_ensureStyles(){if(document.getElementById("auth-button-styles"))return;let t=document.createElement("style");t.id="auth-button-styles",t.textContent=`
            .auth-user-menu {
                position: relative;
            }
            .auth-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 14px;
                cursor: pointer;
                user-select: none;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .auth-avatar:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            }
            .auth-dropdown {
                display: none;
                position: absolute;
                right: 0;
                top: 40px;
                background: #1e293b;
                border: 1px solid #334155;
                border-radius: 8px;
                min-width: 160px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
            .auth-dropdown.show {
                display: block;
            }
            .auth-dropdown-item {
                padding: 10px 16px;
                cursor: pointer;
                color: #f1f5f9;
                text-decoration: none;
                display: block;
                font-size: 14px;
                transition: background 0.2s;
            }
            .auth-dropdown-item:hover {
                background: #334155;
            }
            .auth-user-info {
                color: #94a3b8;
                font-size: 12px;
                cursor: default;
            }
            .auth-user-info:hover {
                background: transparent;
            }
            .auth-dropdown-divider {
                height: 1px;
                background: #334155;
                margin: 4px 0;
            }
            .auth-login-btn {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
                padding: 8px 16px;
                border-radius: 8px;
                text-decoration: none;
                font-size: 14px;
                font-weight: 500;
                transition: transform 0.2s, box-shadow 0.2s;
                display: inline-block;
            }
            .auth-login-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
        `,document.head.appendChild(t)}destroy(){this.unsubscribe&&this.unsubscribe()}};window.AuthButton=at;window.Toast=V;window.LoadingOverlay=Ue;var Sa="source-subscription",gr=!1,mr=!1,$={view:"my-subscriptions",searchQuery:"",searchResults:[],subscriptions:[],loading:!1};function Ca(e,t){let r=null;return function(...n){clearTimeout(r),r=setTimeout(()=>e.apply(this,n),t)}}async function _a(e){if(!e||e.length<2){$.searchResults=[],Z();return}$.loading=!0,Vn();try{let t=await fetch(`/api/sources/search?q=${encodeURIComponent(e)}&limit=20`);if(!t.ok)throw new Error("Search failed");let r=await t.json();$.searchResults=r.sources||[],$.loading=!1,Z()}catch(t){console.error("[SourceSub] Search error:",t),$.loading=!1,$.searchResults=[],Z()}}async function yr(){if(!L.isLoggedIn()){$.subscriptions=[],Z();return}$.loading=!0,Vn();try{let e=await fetch("/api/sources/subscriptions");if(!e.ok)throw new Error("Failed to load subscriptions");let t=await e.json();$.subscriptions=t.subscriptions||[],$.loading=!1,Z()}catch(e){console.error("[SourceSub] Load subscriptions error:",e),$.loading=!1,$.subscriptions=[],Z()}}async function Gn(e,t){if(!L.isLoggedIn()){V.show("\u8BF7\u5148\u767B\u5F55","info"),window.location.href="/api/auth/page";return}try{if(!(await fetch("/api/sources/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_type:e,source_id:t})})).ok)throw new Error("Subscribe failed");if(V.show("\u8BA2\u9605\u6210\u529F","success"),$.view==="discover"){let n=$.searchResults.find(o=>o.id===t);n&&(n.is_subscribed=!0),Z()}await yr()}catch(r){console.error("[SourceSub] Subscribe error:",r),V.show("\u8BA2\u9605\u5931\u8D25","error")}}async function Wn(e,t){try{if(!(await fetch("/api/sources/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_type:e,source_id:t})})).ok)throw new Error("Unsubscribe failed");if(V.show("\u5DF2\u53D6\u6D88\u8BA2\u9605","success"),$.subscriptions=$.subscriptions.filter(n=>n.id!==t),$.view==="discover"){let n=$.searchResults.find(o=>o.id===t);n&&(n.is_subscribed=!1)}Z()}catch(r){console.error("[SourceSub] Unsubscribe error:",r),V.show("\u53D6\u6D88\u8BA2\u9605\u5931\u8D25","error")}}function Vn(){let e=document.getElementById("sourceSubGrid");e&&(e.innerHTML=`
        <div class="source-sub-loading">
            <div class="loading-spinner"></div>
            <div>\u52A0\u8F7D\u4E2D...</div>
        </div>
    `)}function Z(){let e=document.getElementById("sourceSubGrid");if(!e)return;let t=$.view==="my-subscriptions"?$.subscriptions:$.searchResults;if(t.length===0){$.view==="my-subscriptions"?e.innerHTML=`
                <div class="source-sub-empty">
                    <div class="empty-icon">\u{1F4E1}</div>
                    <div class="empty-title">\u8FD8\u6CA1\u6709\u8BA2\u9605\u4EFB\u4F55\u6E90</div>
                    <div class="empty-desc">\u641C\u7D22\u5E76\u8BA2\u9605\u60A8\u611F\u5174\u8DA3\u7684 RSS \u6E90</div>
                </div>
            `:$.searchQuery.length<2?e.innerHTML=`
                <div class="source-sub-empty">
                    <div class="empty-icon">\u{1F50D}</div>
                    <div class="empty-title">\u8F93\u5165\u5173\u952E\u8BCD\u641C\u7D22</div>
                    <div class="empty-desc">\u641C\u7D22 RSS \u6E90\u540D\u79F0\u6216\u7F51\u5740</div>
                </div>
            `:e.innerHTML=`
                <div class="source-sub-empty">
                    <div class="empty-icon">\u{1F615}</div>
                    <div class="empty-title">\u672A\u627E\u5230\u76F8\u5173\u6E90</div>
                    <div class="empty-desc">\u5C1D\u8BD5\u5176\u4ED6\u5173\u952E\u8BCD</div>
                </div>
            `;return}let r=t.map(n=>{let o=n.is_subscribed||$.subscriptions.some(a=>a.id===n.id),s=n.type==="custom"?"\u{1F6E0}\uFE0F":"\u{1F4F0}",i=n.type||"rss";return`
            <div class="source-card" data-source-id="${n.id}" data-source-type="${i}">
                <div class="source-card-header">
                    <div class="source-icon">${s}</div>
                    <div class="source-info">
                        <div class="source-name">${n.name||n.id}</div>
                        <div class="source-domain">${n.url?new URL(n.url).hostname:n.category||""}</div>
                    </div>
                    <button class="source-sub-btn ${o?"subscribed":""}" 
                            data-action="${o?"unsubscribe":"subscribe"}"
                            data-source-id="${n.id}"
                            data-source-type="${i}">
                        ${o?"\u5DF2\u8BA2\u9605 \u2713":"+ \u8BA2\u9605"}
                    </button>
                </div>
            </div>
        `}).join("");e.innerHTML=r,e.querySelectorAll(".source-sub-btn").forEach(n=>{n.addEventListener("click",o=>{o.stopPropagation();let s=n.dataset.action,i=n.dataset.sourceId,a=n.dataset.sourceType;s==="subscribe"?Gn(a,i):Wn(a,i)})})}function jn(e){$.view=e,document.querySelectorAll(".source-view-btn").forEach(t=>{t.classList.toggle("active",t.dataset.view===e)}),e==="my-subscriptions"?yr():Z()}async function pr(e=!1){if(console.log("[SourceSub] loadSourceSubscription called, force:",e),mr||gr&&!e)return;if(!document.getElementById("sourceSubGrid")){console.error("[SourceSub] Container #sourceSubGrid not found!");return}mr=!0,L.isLoggedIn()?await yr():Z(),gr=!0,mr=!1}function hr(){console.log("[SourceSub] Initializing...");let e=L.getUser();L.subscribe(r=>{!!e!==!!r&&(console.log("[SourceSub] Auth state changed, reloading..."),gr=!1,$.subscriptions=[],document.querySelector("#tab-source-subscription.active")&&pr(!0)),e=r}),window.addEventListener("tr_tab_switched",r=>{r?.detail?.categoryId===Sa&&pr()});let t=()=>{let r=document.getElementById("sourceSubSearch");if(r){let n=Ca(o=>{$.searchQuery=o,o.length>=2?($.view="discover",document.querySelectorAll(".source-view-btn").forEach(s=>{s.classList.toggle("active",s.dataset.view==="discover")}),_a(o)):o.length===0&&jn("my-subscriptions")},300);r.addEventListener("input",o=>{n(o.target.value.trim())})}document.querySelectorAll(".source-view-btn").forEach(n=>{n.addEventListener("click",()=>{jn(n.dataset.view)})})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):setTimeout(t,100),console.log("[SourceSub] Module initialized")}typeof window<"u"&&(window.HotNews=window.HotNews||{},window.HotNews.sourceSub={load:pr,init:hr,subscribe:Gn,unsubscribe:Wn});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",hr):hr();var wr="",At=0,se=null;function de(){let e=document.getElementById("loginModal");e&&(e.style.display="flex",Lt(1),setTimeout(()=>{let t=document.getElementById("login-email");t&&t.focus()},100))}function br(){let e=document.getElementById("loginModal");e&&(e.style.display="none"),se&&(clearInterval(se),se=null),Xn();let t=document.getElementById("login-email"),r=document.getElementById("login-code");t&&(t.value=""),r&&(r.value="")}function Ea(e){e.target.id==="loginModal"&&br()}function Y(e,t){let r=document.getElementById("login-message");r&&(r.textContent=e,r.className="login-message "+t)}function Xn(){let e=document.getElementById("login-message");e&&(e.className="login-message")}function Lt(e){document.querySelectorAll(".login-step").forEach(r=>r.classList.remove("active"));let t=document.getElementById("login-step-"+e);t&&t.classList.add("active"),document.querySelectorAll(".login-step-dot").forEach((r,n)=>{r.classList.toggle("active",n<e)}),Xn()}function xa(){Lt(1),se&&(clearInterval(se),se=null)}function Kn(){At=60;let e=document.getElementById("login-resend-btn"),t=document.getElementById("login-resend-text");e&&(e.disabled=!0),se=setInterval(()=>{At--,At<=0?(clearInterval(se),se=null,e&&(e.disabled=!1),t&&(t.textContent="\u91CD\u65B0\u53D1\u9001")):t&&(t.textContent=At+"\u79D2\u540E\u91CD\u53D1")},1e3)}async function Ta(e){e.preventDefault();let t=document.getElementById("login-send-btn"),r=document.getElementById("login-email").value.trim();if(!r){Y("\u8BF7\u8F93\u5165\u90AE\u7BB1","error");return}t&&(t.disabled=!0,t.textContent="\u53D1\u9001\u4E2D...");try{let n=await fetch("/api/auth/send-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r})}),o=await n.json();if(n.ok){wr=r;let s=document.getElementById("login-display-email");s&&(s.textContent=r),Lt(2);let i=document.getElementById("login-code");i&&i.focus(),Kn()}else{let s=typeof o.detail=="string"?o.detail:o.detail?.[0]?.msg||o.message||"\u53D1\u9001\u5931\u8D25";Y(s,"error")}}catch{Y("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u8BF7\u91CD\u8BD5","error")}t&&(t.disabled=!1,t.textContent="\u83B7\u53D6\u9A8C\u8BC1\u7801")}async function Aa(){let e=document.getElementById("login-resend-btn");e&&(e.disabled=!0);try{let t=await fetch("/api/auth/send-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:wr})}),r=await t.json();if(t.ok)Y("\u9A8C\u8BC1\u7801\u5DF2\u91CD\u65B0\u53D1\u9001","success"),Kn();else{let n=typeof r.detail=="string"?r.detail:r.detail?.[0]?.msg||r.message||"\u53D1\u9001\u5931\u8D25";Y(n,"error"),e&&(e.disabled=!1)}}catch{Y("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u8BF7\u91CD\u8BD5","error"),e&&(e.disabled=!1)}}async function La(e){e.preventDefault();let t=document.getElementById("login-verify-btn"),r=document.getElementById("login-code").value.trim();if(!r||r.length!==6){Y("\u8BF7\u8F93\u51656\u4F4D\u9A8C\u8BC1\u7801","error");return}t&&(t.disabled=!0,t.textContent="\u767B\u5F55\u4E2D...");try{let n=await fetch("/api/auth/verify-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:wr,code:r})}),o=await n.json();if(n.ok)Y("\u767B\u5F55\u6210\u529F","success"),setTimeout(()=>{br(),window.location.reload()},500);else{let s=typeof o.detail=="string"?o.detail:o.detail?.[0]?.msg||o.message||"\u9A8C\u8BC1\u5931\u8D25";Y(s,"error")}}catch{Y("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u8BF7\u91CD\u8BD5","error")}t&&(t.disabled=!1,t.textContent="\u767B\u5F55")}function Yn(){let e=document.getElementById("login-code");e&&e.addEventListener("input",function(t){this.value=this.value.replace(/[^0-9]/g,"").slice(0,6)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Yn):Yn();window.openLoginModal=de;window.closeLoginModal=br;window.closeLoginModalOnOverlay=Ea;window.loginSendCode=Ta;window.loginVerifyCode=La;window.loginResendCode=Aa;window.loginGoBack=xa;window.loginGoToStep=Lt;window.loginShowMessage=Y;var eo="hotnews_favorites_v1",to="hotnews_favorites_width",ka=500,vr=320,Sr=800,F=null,kt=!1,ue=!1;function Mt(){try{let e=localStorage.getItem(eo);return e?JSON.parse(e):[]}catch{return[]}}function ro(e){try{localStorage.setItem(eo,JSON.stringify(e))}catch(t){console.error("[Favorites] Failed to save to localStorage:",t)}}async function Ma(){try{let e=await fetch("/api/user/favorites");if(e.status===401)return{needsAuth:!0};if(!e.ok)throw new Error("Failed to fetch favorites");let t=await e.json();return t.ok?(F=t.favorites||[],{favorites:F}):{error:t.message||"Unknown error"}}catch(e){return console.error("[Favorites] Fetch error:",e),{error:e.message}}}async function $a(e){if(!L.getUser()){let r=Mt();return r.some(o=>o.news_id===e.news_id)||(r.unshift({...e,created_at:Math.floor(Date.now()/1e3)}),ro(r)),{ok:!0,local:!0}}try{let n=await(await fetch("/api/user/favorites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return n.ok&&F&&F.unshift(n.favorite),n}catch(r){return console.error("[Favorites] Add error:",r),{ok:!1,error:r.message}}}async function no(e){if(!L.getUser()){let n=Mt().filter(o=>o.news_id!==e);return ro(n),{ok:!0,local:!0}}try{let n=await(await fetch(`/api/user/favorites/${encodeURIComponent(e)}`,{method:"DELETE"})).json();return n.ok&&F&&(F=F.filter(o=>o.news_id!==e)),n}catch(r){return console.error("[Favorites] Remove error:",r),{ok:!1,error:r.message}}}function oo(e){return L.getUser()?F?F.some(r=>r.news_id===e):!1:Mt().some(n=>n.news_id===e)}async function Pa(e,t){let r=e.news_id,n=oo(r);t&&(t.classList.toggle("favorited",!n),t.textContent=n?"\u2606":"\u2605");let o;return n?o=await no(r):o=await $a(e),o.ok||t&&(t.classList.toggle("favorited",n),t.textContent=n?"\u2605":"\u2606"),o}function so(e){if(!e)return"";let t=new Date(e*1e3),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${r}-${n}`}function Ia(e){let t=document.getElementById("favoritesPanelBody");if(!t)return;if(!e||e.length===0){t.innerHTML=`
            <div class="favorites-empty">
                <div class="favorites-empty-icon">\u2B50</div>
                <div>\u6682\u65E0\u6536\u85CF</div>
                <div style="font-size:12px;margin-top:8px;color:#64748b;">
                    \u70B9\u51FB\u65B0\u95FB\u6807\u9898\u65C1\u7684 \u2606 \u6DFB\u52A0\u6536\u85CF
                </div>
            </div>
        `;return}let r=`
        <div class="favorites-list">
            ${e.map(n=>`
                <div class="favorite-item" data-news-id="${n.news_id}">
                    <a class="favorite-item-title" href="${n.url||"#"}" target="_blank" rel="noopener noreferrer">
                        ${n.title||"\u65E0\u6807\u9898"}
                    </a>
                    <div class="favorite-item-meta">
                        <span class="favorite-item-source">
                            ${n.source_name?`<span>${n.source_name}</span>`:""}
                            ${n.created_at?`<span>\u6536\u85CF\u4E8E ${so(n.created_at)}</span>`:""}
                        </span>
                        <div class="favorite-item-actions">
                            <button class="favorite-summary-btn${n.summary?" has-summary":""}" 
                                    onclick="handleSummaryClick('${n.news_id}')" 
                                    title="${n.summary?"\u67E5\u770B\u603B\u7ED3":"AI \u603B\u7ED3"}">
                                ${n.summary?"\u{1F4C4}":"\u{1F4DD}"}
                            </button>
                            <button class="favorite-remove-btn" onclick="removeFavoriteFromPanel('${n.news_id}')" title="\u53D6\u6D88\u6536\u85CF">
                                \u5220\u9664
                            </button>
                        </div>
                    </div>
                    <div class="favorite-item-summary" id="summary-${n.news_id}" style="display:${n.summary?"block":"none"};">
                        <div class="summary-content">${n.summary?lo(n.summary):""}</div>
                        ${n.summary?`
                            <div class="summary-actions">
                                <button class="summary-regenerate-btn" onclick="regenerateSummary('${n.news_id}')" title="\u91CD\u65B0\u751F\u6210">
                                    \u{1F504} \u91CD\u65B0\u751F\u6210
                                </button>
                                <button class="summary-toggle-btn" onclick="toggleSummaryDisplay('${n.news_id}')">
                                    \u6536\u8D77
                                </button>
                            </div>
                        `:""}
                    </div>
                </div>
            `).join("")}
        </div>
    `;t.innerHTML=r}function Jn(){let e=document.getElementById("favoritesPanelBody");if(!e)return;let t=Mt();t.length>0?e.innerHTML=`
            <div style="padding:12px;background:#334155;border-radius:8px;margin-bottom:16px;font-size:13px;color:#94a3b8;">
                <span style="color:#fbbf24;">\u{1F4A1}</span> \u767B\u5F55\u540E\u53EF\u540C\u6B65\u6536\u85CF\u5230\u4E91\u7AEF
                <button class="favorites-login-btn" onclick="openLoginModal();closeFavoritesPanel();" style="margin-left:8px;padding:4px 12px;font-size:12px;">
                    \u767B\u5F55
                </button>
            </div>
            <div class="favorites-list">
                ${t.map(r=>`
                    <div class="favorite-item" data-news-id="${r.news_id}">
                        <a class="favorite-item-title" href="${r.url||"#"}" target="_blank" rel="noopener noreferrer">
                            ${r.title||"\u65E0\u6807\u9898"}
                        </a>
                        <div class="favorite-item-meta">
                            <span class="favorite-item-source">
                                ${r.source_name?`<span>${r.source_name}</span>`:""}
                                ${r.created_at?`<span>\u6536\u85CF\u4E8E ${so(r.created_at)}</span>`:""}
                            </span>
                            <div class="favorite-item-actions">
                                <button class="favorite-remove-btn" onclick="removeFavoriteFromPanel('${r.news_id}')" title="\u53D6\u6D88\u6536\u85CF">
                                    \u5220\u9664
                                </button>
                            </div>
                        </div>
                    </div>
                `).join("")}
            </div>
        `:e.innerHTML=`
            <div class="favorites-login-required">
                <div class="favorites-login-icon">\u{1F512}</div>
                <div>\u767B\u5F55\u540E\u53EF\u4F7F\u7528\u6536\u85CF\u529F\u80FD</div>
                <button class="favorites-login-btn" onclick="openLoginModal();closeFavoritesPanel();">
                    \u7ACB\u5373\u767B\u5F55
                </button>
            </div>
        `}async function ao(){let e=document.getElementById("favoritesPanelBody");if(!e)return;if(e.innerHTML='<div class="favorites-loading">\u52A0\u8F7D\u4E2D...</div>',!L.getUser()){Jn();return}let r=await Ma();if(r.needsAuth){Jn();return}if(r.error){e.innerHTML=`
            <div class="favorites-empty">
                <div>\u52A0\u8F7D\u5931\u8D25: ${r.error}</div>
                <button onclick="loadFavoritesPanel()" style="margin-top:12px;padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;">
                    \u91CD\u8BD5
                </button>
            </div>
        `;return}Ia(r.favorites)}function Oa(){if(!L.getUser()){de();return}let t=document.getElementById("favoritesPanel"),r=document.getElementById("favoritesOverlay");t&&(r||(r=document.createElement("div"),r.id="favoritesOverlay",r.className="favorites-overlay",r.onclick=io,document.body.appendChild(r)),kt=!kt,kt?(t.classList.add("open"),r.classList.add("open"),ao()):(t.classList.remove("open"),r.classList.remove("open")))}function io(){let e=document.getElementById("favoritesPanel"),t=document.getElementById("favoritesOverlay");kt=!1,e&&e.classList.remove("open"),t&&t.classList.remove("open")}async function Na(e){if((await no(e)).ok){let r=document.querySelector(`.favorite-item[data-news-id="${e}"]`);r&&r.remove();let n=document.querySelector(`.news-favorite-btn[data-news-id="${e}"]`);n&&(n.classList.remove("favorited"),n.textContent="\u2606");let o=document.querySelector(".favorites-list");o&&o.children.length===0&&ao()}}function Ba(e,t,r,n,o,s){if(e.preventDefault(),e.stopPropagation(),!L.getUser()){de();return}let a=e.currentTarget;Pa({news_id:t,title:r,url:n,source_id:o||"",source_name:s||""},a)}function Ra(){try{let e=localStorage.getItem(to);if(e){let t=parseInt(e,10);if(t>=vr&&t<=Sr)return t}}catch{}return ka}function Qn(e){try{localStorage.setItem(to,String(e))}catch{}}function Da(e){let t=document.getElementById("favoritesPanel");t&&(t.style.width=e+"px")}function Zn(){let e=document.getElementById("favoritesPanel"),t=document.getElementById("favoritesResizeHandle");if(!e||!t)return;let r=Ra();Da(r);let n=0,o=0;function s(f){f.preventDefault(),ue=!0,n=f.clientX,o=e.offsetWidth,e.classList.add("resizing"),t.classList.add("active"),document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)}function i(f){if(!ue)return;let m=n-f.clientX,g=o+m;g=Math.max(vr,Math.min(Sr,g)),e.style.width=g+"px"}function a(){ue&&(ue=!1,e.classList.remove("resizing"),t.classList.remove("active"),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a),Qn(e.offsetWidth))}function c(f){f.touches.length===1&&(f.preventDefault(),ue=!0,n=f.touches[0].clientX,o=e.offsetWidth,e.classList.add("resizing"),t.classList.add("active"),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("touchend",u))}function d(f){if(!ue||f.touches.length!==1)return;f.preventDefault();let m=n-f.touches[0].clientX,g=o+m;g=Math.max(vr,Math.min(Sr,g)),e.style.width=g+"px"}function u(){ue&&(ue=!1,e.classList.remove("resizing"),t.classList.remove("active"),document.removeEventListener("touchmove",d),document.removeEventListener("touchend",u),Qn(e.offsetWidth))}t.addEventListener("mousedown",s),t.addEventListener("touchstart",c,{passive:!1})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Zn):Zn();function lo(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=t.replace(/^### (.+)$/gm,"<h4>$1</h4>"),t=t.replace(/^## (.+)$/gm,"<h3>$1</h3>"),t=t.replace(/^# (.+)$/gm,"<h2>$1</h2>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/^- (.+)$/gm,"<li>$1</li>"),t=t.replace(/^(\d+)\. (.+)$/gm,"<li>$2</li>"),t=t.replace(/(<li>.*<\/li>\n?)+/g,"<ul>$&</ul>"),t=t.replace(/\n\n/g,"</p><p>"),t="<p>"+t+"</p>",t=t.replace(/<p>\s*<\/p>/g,""),t=t.replace(/<p>(<h[234]>)/g,"$1"),t=t.replace(/(<\/h[234]>)<\/p>/g,"$1"),t=t.replace(/<p>(<ul>)/g,"$1"),t=t.replace(/(<\/ul>)<\/p>/g,"$1"),t}async function co(e){let t=document.getElementById(`summary-${e}`),r=document.querySelector(`.favorite-item[data-news-id="${e}"] .favorite-summary-btn`);if(!(!t||!r)){if(r.classList.contains("has-summary")){uo(e);return}r.disabled=!0,r.textContent="\u23F3",r.title="\u751F\u6210\u4E2D...",t.style.display="block",t.innerHTML=`
        <div class="summary-loading">
            <div class="summary-loading-spinner"></div>
            <span>\u6B63\u5728\u751F\u6210 AI \u603B\u7ED3...</span>
        </div>
    `;try{let n=await fetch(`/api/user/favorites/${encodeURIComponent(e)}/summary`,{method:"POST"}),o=await n.json();if(!n.ok)throw new Error(o.detail||"\u751F\u6210\u5931\u8D25");if(o.ok&&o.summary){if(r.classList.add("has-summary"),r.textContent="\u{1F4C4}",r.title="\u67E5\u770B\u603B\u7ED3",t.innerHTML=`
                <div class="summary-content">${lo(o.summary)}</div>
                <div class="summary-actions">
                    <button class="summary-regenerate-btn" onclick="regenerateSummary('${e}')" title="\u91CD\u65B0\u751F\u6210">
                        \u{1F504} \u91CD\u65B0\u751F\u6210
                    </button>
                    <button class="summary-toggle-btn" onclick="toggleSummaryDisplay('${e}')">
                        \u6536\u8D77
                    </button>
                </div>
            `,F){let s=F.find(i=>i.news_id===e);s&&(s.summary=o.summary,s.summary_at=o.summary_at)}}else throw new Error(o.error||"\u751F\u6210\u5931\u8D25")}catch(n){console.error("[Favorites] Summary error:",n),t.innerHTML=`
            <div class="summary-error">
                <span>\u274C ${n.message}</span>
                <button onclick="handleSummaryClick('${e}')" style="margin-left:8px;">\u91CD\u8BD5</button>
            </div>
        `,r.textContent="\u{1F4DD}",r.title="AI \u603B\u7ED3"}finally{r.disabled=!1}}}function uo(e){let t=document.getElementById(`summary-${e}`);if(!t)return;let r=t.style.display!=="none";t.style.display=r?"none":"block";let n=t.querySelector(".summary-toggle-btn");n&&(n.textContent=r?"\u5C55\u5F00":"\u6536\u8D77")}async function Fa(e){let t=document.getElementById(`summary-${e}`),r=document.querySelector(`.favorite-item[data-news-id="${e}"] .favorite-summary-btn`);if(t){try{await fetch(`/api/user/favorites/${encodeURIComponent(e)}/summary`,{method:"DELETE"})}catch(n){console.error("[Favorites] Delete summary error:",n)}if(r&&(r.classList.remove("has-summary"),r.textContent="\u{1F4DD}"),F){let n=F.find(o=>o.news_id===e);n&&(n.summary=null,n.summary_at=null)}await co(e)}}window.toggleFavoritesPanel=Oa;window.closeFavoritesPanel=io;window.removeFavoriteFromPanel=Na;window.handleFavoriteClick=Ba;window.isFavorited=oo;window.handleSummaryClick=co;window.toggleSummaryDisplay=uo;window.regenerateSummary=Fa;var go=!1,je=null,qa={news:"\u{1F4F0}","tech-tutorial":"\u{1F468}\u200D\u{1F4BB}",product:"\u{1F680}",opinion:"\u2696\uFE0F",research:"\u{1F4DA}",business:"\u{1F4BC}",trend:"\u{1F4C8}",lifestyle:"\u{1F31F}",other:"\u{1F4DD}"};function Cr(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=t.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code class="language-$1">$2</code></pre>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/^#### (.+)$/gm,"<h4>$1</h4>"),t=t.replace(/^### (.+)$/gm,"<h3>$1</h3>"),t=t.replace(/^## (.+)$/gm,"<h2>$1</h2>"),t=t.replace(/^# (.+)$/gm,"<h1>$1</h1>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/^\|(.+)\|$/gm,(r,n)=>{let o=n.split("|").map(i=>i.trim());return o.every(i=>/^[-:]+$/.test(i))?'<tr class="table-separator"></tr>':`<tr>${o.map(i=>`<td>${i}</td>`).join("")}</tr>`}),t=t.replace(/(<tr>[\s\S]*?<\/tr>\s*)+/g,"<table>$&</table>"),t=t.replace(/<tr class="table-separator"><\/tr>/g,""),t=t.replace(/^- (.+)$/gm,"<li>$1</li>"),t=t.replace(/^(\d+)\. (.+)$/gm,"<li>$2</li>"),t=t.replace(/(<li>[\s\S]*?<\/li>\s*)+/g,"<ul>$&</ul>"),t=t.replace(/\n\n/g,"</p><p>"),t="<p>"+t+"</p>",t=t.replace(/<p>\s*<\/p>/g,""),t=t.replace(/<p>(<h[1-4]>)/g,"$1"),t=t.replace(/(<\/h[1-4]>)<\/p>/g,"$1"),t=t.replace(/<p>(<ul>)/g,"$1"),t=t.replace(/(<\/ul>)<\/p>/g,"$1"),t=t.replace(/<p>(<table>)/g,"$1"),t=t.replace(/(<\/table>)<\/p>/g,"$1"),t=t.replace(/<p>(<pre>)/g,"$1"),t=t.replace(/(<\/pre>)<\/p>/g,"$1"),t}function Ha(){if(document.getElementById("summaryModal"))return;document.body.insertAdjacentHTML("beforeend",`
        <div id="summaryModal" class="summary-modal">
            <div class="summary-modal-backdrop" onclick="closeSummaryModal()"></div>
            <div class="summary-modal-content">
                <button class="summary-modal-close" onclick="closeSummaryModal()" title="\u5173\u95ED">\u2715</button>
                <div class="summary-modal-header">
                    <h2>\u{1F4DD} AI \u667A\u80FD\u603B\u7ED3</h2>
                </div>
                <div class="summary-modal-body" id="summaryModalBody">
                    <!-- Content will be inserted here -->
                </div>
                <div class="summary-modal-footer" id="summaryModalFooter" style="display:none;">
                    <!-- Footer with type tag and actions -->
                </div>
            </div>
        </div>
    `)}async function _r(e,t,r,n,o){if(!L.getUser()){de();return}Ha();let i=document.getElementById("summaryModal"),a=document.getElementById("summaryModalBody"),c=document.getElementById("summaryModalFooter");je=e,go=!0,i.classList.add("open"),document.body.style.overflow="hidden",a.innerHTML=`
        <div class="summary-loading">
            <div class="summary-loading-spinner"></div>
            <div class="summary-loading-text">
                <div id="summaryStatusText">\u6B63\u5728\u83B7\u53D6\u6587\u7AE0\u5185\u5BB9...</div>
                <div class="summary-loading-hint">\u9996\u6B21\u603B\u7ED3\u9700\u8981 10-30 \u79D2</div>
            </div>
        </div>
    `,c.style.display="none";try{let d=await fetch("/api/summary/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:r,title:t,news_id:e,source_id:n,source_name:o})});if(!d.ok){let y=await d.json();throw new Error(y.detail||"\u751F\u6210\u5931\u8D25")}let u=d.body.getReader(),f=new TextDecoder,m="",g="other",h="\u5176\u4ED6",v=!1;for(;;){let{done:y,value:M}=await u.read();if(y)break;let x=f.decode(M,{stream:!0}).split(`
`);for(let _ of x)if(_.startsWith("data: "))try{let E=JSON.parse(_.slice(6));switch(E.type){case"status":let ae=document.getElementById("summaryStatusText");ae&&(ae.textContent=E.message);break;case"type":g=E.article_type,h=E.article_type_name;break;case"chunk":v||(v=!0,a.innerHTML=`
                                    <div class="summary-content summary-streaming" id="summaryStreamContent">
                                        <div class="summary-cursor"></div>
                                    </div>
                                `),m+=E.content;let D=document.getElementById("summaryStreamContent");D&&(D.innerHTML=Cr(m)+'<span class="summary-cursor">\u258C</span>',D.scrollTop=D.scrollHeight);break;case"cached":m=E.summary,g=E.article_type,h=E.article_type_name,a.innerHTML=`
                                <div class="summary-content">
                                    ${Cr(m)}
                                </div>
                            `,fo(r,g,h,!0),mo(e,!0);return;case"done":let H=document.getElementById("summaryStreamContent");H&&(H.classList.remove("summary-streaming"),H.innerHTML=Cr(m)),fo(r,g,h,!1),mo(e,!0);break;case"error":throw new Error(E.message)}}catch(E){if(E.message&&!E.message.includes("JSON"))throw E}}}catch(d){console.error("[Summary] Error:",d),a.innerHTML=`
            <div class="summary-error">
                <div class="summary-error-icon">\u274C</div>
                <div class="summary-error-text">${d.message}</div>
                <button class="summary-retry-btn" onclick="retrySummaryModal()">\u91CD\u8BD5</button>
            </div>
        `}}function fo(e,t,r,n){let o=document.getElementById("summaryModalFooter"),s=qa[t]||"\u{1F4DD}";o.innerHTML=`
        <div class="summary-footer-left">
            <span class="summary-type-tag">${s} ${r}</span>
            <span class="summary-favorited">\u2B50 \u5DF2\u6536\u85CF</span>
            ${n?'<span class="summary-cached-tag">\u{1F4E6} \u7F13\u5B58</span>':""}
        </div>
        <div class="summary-footer-right">
            <a href="${e}" target="_blank" rel="noopener noreferrer" class="summary-link-btn">
                \u{1F517} \u67E5\u770B\u539F\u6587
            </a>
            <button class="summary-regenerate-btn" onclick="regenerateSummaryModal()">
                \u{1F504} \u91CD\u65B0\u751F\u6210
            </button>
        </div>
    `,o.style.display="flex"}function za(){let e=document.getElementById("summaryModal");e&&(e.classList.remove("open"),document.body.style.overflow=""),go=!1,je=null}function po(){let e=document.querySelector(`.news-summary-btn[data-news-id="${je}"]`);if(e){let t=e.dataset.title,r=e.dataset.url,n=e.dataset.sourceId,o=e.dataset.sourceName;_r(je,t,r,n,o)}}async function Ua(){if(je){try{await fetch(`/api/summary/${encodeURIComponent(je)}`,{method:"DELETE"})}catch(e){console.error("[Summary] Delete error:",e)}po()}}function mo(e,t){let r=document.querySelector(`.news-summary-btn[data-news-id="${e}"]`);r&&(r.classList.toggle("has-summary",t),r.title=t?"\u67E5\u770B\u603B\u7ED3":"AI \u603B\u7ED3")}function ja(e,t,r,n,o,s){e.preventDefault(),e.stopPropagation(),_r(t,r,n,o,s)}window.openSummaryModal=_r;window.closeSummaryModal=za;window.retrySummaryModal=po;window.regenerateSummaryModal=Ua;window.handleSummaryClick=ja;var yo="hotnews_mobile_top_collapsed_v1",wo="tr-mobile-top-collapsed";function Ga(){L.isLoggedIn()?window.location.href="/api/user/preferences/page":de()}window.goToSettings=Ga;function ho(e){let t=!!e;try{document.body.classList.toggle(wo,t)}catch{}try{localStorage.setItem(yo,t?"1":"0")}catch{}try{let r=document.getElementById("trFooterTopToggle");r&&(r.textContent=t?"\u663E\u793A\u9876\u90E8":"\u9690\u85CF\u9876\u90E8")}catch{}}function Wa(){let e=!0;try{let t=localStorage.getItem(yo);t==="0"&&(e=!1),t==="1"&&(e=!0)}catch{}try{new URLSearchParams(window.location.search).get("e2e")==="1"&&(e=!1)}catch{}ho(e);try{let t=document.getElementById("trFooterTopToggle");if(!t||t.dataset.bound==="1")return;t.dataset.bound="1",t.setAttribute("role","button"),t.setAttribute("aria-label","\u663E\u793A\u6216\u9690\u85CF\u9876\u90E8\u680F"),t.addEventListener("click",()=>{let r=!document.body.classList.contains(wo);if(ho(r),!r)try{window.scrollTo({top:0,behavior:"smooth"})}catch{}})}catch{}}k(function(){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"){try{let o=document.getElementById("early-hide");o&&o.remove()}catch{}try{let o=document.querySelector(".category-tabs");o&&o instanceof HTMLElement&&(o.style.display="flex")}catch{}try{let o=document.querySelector(".tab-content-area");o&&o instanceof HTMLElement&&(o.style.display="block")}catch{}}}catch{}if(Wa(),setTimeout(()=>{let n=document.getElementById("authButtonContainer");n&&(new at(n),console.log("[Init] AuthButton initialized"))},100),localStorage.getItem("category_settings_badge_dismissed")==="true"){let n=document.getElementById("categorySettingsNewBadge");n&&(n.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let n=document.getElementById("rssSubscriptionNewBadge");n&&(n.style.display="none")}let t=l.settings.getCategoryConfig();if(t&&(t.customCategories&&t.customCategories.length>0||t.hiddenDefaultCategories&&t.hiddenDefaultCategories.length>0||t.categoryOrder&&t.categoryOrder.length>0||t.platformOrder&&typeof t.platformOrder=="object"&&Object.keys(t.platformOrder).length>0)){l.data.refreshViewerData({preserveScroll:!1});try{window.setTimeout(()=>{try{if(document.body.classList.contains("categories-ready"))return}catch{}try{let n=document.getElementById("early-hide");n&&n.remove()}catch{}try{let n=document.querySelector(".category-tabs");n&&n instanceof HTMLElement&&(n.style.display="flex")}catch{}try{let n=document.querySelector(".tab-content-area");n&&n instanceof HTMLElement&&(n.style.display="block")}catch{}try{document.body.classList.add("categories-ready")}catch{}},2500)}catch{}}else document.body.classList.add("categories-ready")});import("./platform-reorder-W3NEA7OP.js");import("./subscription-QHK6MNRE.js");import("./rss-catalog-preview-parity-IXFNNNZU.js");import("./explore-embedded-rss-BKKDBEJ4.js");export{l as TR};
