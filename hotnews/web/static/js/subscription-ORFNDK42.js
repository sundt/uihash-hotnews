import{a as H}from"./chunk-E3FXOX6T.js";import{a as R,b as it,c as y}from"./chunk-NTAR7AIA.js";var G="rss_subscriptions",w=null,g=null,A=!1,I=!1,V=!1,W=!1,O=!1,E=new Map,T=new Set,at=!1,z="",D="",ht=80,P=0,F=0,K=!1,b=[],Q=0,q=0,L=44,nt=10,x=0,st=0,ot=new Map;function ct(t){return new Promise(e=>window.setTimeout(e,Math.max(0,t||0)))}function wt(t){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(t||""))}catch{}return String(t||"").replace(/"/g,'\\"')}function vt(t){let e=Array.isArray(t)?t:[];for(let r of e){let i=String(r||"").trim();if(!i)continue;let n=`rss-${i}`,s=`.platform-card[data-platform="${wt(n)}"]`,u=document.querySelector(s);if(!u)continue;let o=u.querySelectorAll(".news-item");if(o&&o.length>0)return!0}return!1}function Y(t,e){let r=Array.isArray(t)?t:[];for(let i of r){let n=String(i||"").trim();n&&(e?T.add(n):T.delete(n))}}function X(){return document.getElementById("rssSubscriptionModal")}function tt(){return document.getElementById("rssSourcePickerModal")}function j(t){return(Array.isArray(t)?t:[]).filter(r=>r&&typeof r=="object").map(r=>({source_id:String(r.source_id||r.rss_source_id||"").trim(),url:String(r.url||"").trim(),feed_title:String(r.feed_title||r.display_name||"").trim(),column:String(r.column||"RSS").trim()||"RSS",platform_id:String(r.platform_id||"").trim()})).filter(r=>!!r.source_id)}async function lt({showHintOn403:t}={}){if(!V){V=!0;try{let e=await fetch("/api/me/rss-subscriptions");if(e.status===403){A=!1,I=!0;try{$()}catch{}t&&p("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5F53\u524D\u4F7F\u7528\u672C\u5730\u8BA2\u9605",{variant:"info"});return}let r=await e.json().catch(()=>({}));if(!e.ok){I=!0,A=!1;return}let i=j(r?.subscriptions);I=!0,A=!0;try{$()}catch{}try{S.setSubscriptions(i)}catch{}try{g=S.getSubscriptions()}catch{g=null}_(),v()}finally{V=!1}}}function _t(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function bt(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function M(t){let r=(Array.isArray(t)?t:[]).filter(i=>i&&typeof i=="object").map(i=>({source_id:String(i.source_id||i.rss_source_id||"").trim(),url:String(i.url||"").trim(),feed_title:String(i.feed_title||"").trim(),column:String(i.column||"RSS").trim()||"RSS"})).filter(i=>!!i.source_id||!!i.url).sort((i,n)=>(i.source_id||"").localeCompare(n.source_id||""));return JSON.stringify(r)}function Z(t,e){let r=Array.isArray(t)?t:[],i=Array.isArray(e)?e:[],n=new Set(r.map(u=>String(u?.source_id||u?.rss_source_id||"").trim()).filter(Boolean)),s=[];for(let u of i){let o=String(u?.source_id||u?.rss_source_id||"").trim();o&&(n.has(o)||s.push(o))}return s}function Et(t,e){if(t)try{e?t.removeAttribute("disabled"):t.setAttribute("disabled","true")}catch{}}function At(t,e){if(!t)return;let r=!!e;try{r?t.setAttribute("aria-disabled","true"):t.removeAttribute("aria-disabled")}catch{}try{r?(t.style.opacity="0.5",t.style.cursor="not-allowed"):(t.style.opacity="",t.style.cursor="")}catch{}}function v(){let t=bt(),e=_t(),r=pt();try{t&&t.removeAttribute("disabled")}catch{}At(t,!r);try{t&&(r?t.removeAttribute("title"):t.setAttribute("title","\u8BF7\u5148\u9009\u62E9 RSS \u6E90\u518D\u9884\u89C8"))}catch{}if(r){let c=E.get(String(r||"").trim());c&&c.ok===!0&&Number(c.entries_count||0)===0&&p("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let i=Array.isArray(g)?g:[],n=S.getSubscriptions(),s=M(i)!==M(n),o=Z(i,n).every(c=>{let d=E.get(c);return!!d&&d.ok===!0&&Number(d.entries_count||0)>0});if(Et(e,s&&o),!s){r&&(()=>{let c=E.get(String(r||"").trim());return c&&c.ok===!0&&Number(c.entries_count||0)===0})()||p("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!o){r&&(()=>{let c=E.get(String(r||"").trim());return c&&c.ok===!0&&Number(c.entries_count||0)===0})()||p("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}p("",{variant:"info"})}async function kt(t){let e=U();e&&(e.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`),i=await r.json();if(!r.ok)throw new Error(i?.detail||"Preview failed");let n=i?.data||{},s=n?.feed?.title||"",u=Array.isArray(n?.entries)?n.entries:[],o=u.length,l=u.slice(0,5).map(c=>{let d=y(c?.title||""),f=y(c?.link||"");return f?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${f}" target="_blank" rel="noopener noreferrer">${d||f}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${d}</div>`}).join("");if(!W&&s&&(B("rssFeedTitle",s),O=!0),E.set(String(t||"").trim(),{ok:!0,entries_count:o,ts:Date.now()}),o>0)try{let d=(w?String(w.url||"").trim():"")||String(i?.final_url||i?.url||"").trim(),f=N("rssColumn")||"";if(!f||String(f).trim().toUpperCase()==="RSS")try{let h=R.tabs&&typeof R.tabs.getActiveTabId=="function"?R.tabs.getActiveTabId():"";h&&(f=String(h))}catch{}f||(f="general");let a=N("rssFeedTitle")||String(w?.name||w?.host||"").trim(),m=S.getSubscriptions(),k=m.findIndex(h=>h.source_id&&h.source_id===String(t||"").trim()),C={source_id:String(t||"").trim(),url:d,feed_title:a,column:f,platform_id:""};k>=0?m[k]=C:m.unshift(C),S.setSubscriptions(m),_()}catch{}else p("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});v(),e&&(e.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${y(s||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${u.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${l}</div>
            </div>`)}function Rt(){return document.getElementById("rssSubscriptionList")}function U(){return document.getElementById("rssSubscriptionPreview")}function Tt(){return document.getElementById("rssSubscriptionSaveStatus")}function p(t,e={}){let r=Tt();if(!r)return;let i=String(e.variant||"").toLowerCase(),n=i==="error"?"#dc2626":i==="success"?"#16a34a":"#6b7280";r.style.color=n,r.textContent=t==null?"":String(t)}function ut(){return document.getElementById("rssSelectedSourceId")}function xt(){return document.getElementById("rssSelectedSourceLabel")}function It(){return document.getElementById("rssRequestSection")}function $t(){return document.getElementById("rssSourceCategoryList")}function dt(){return document.getElementById("rssSourceSearchInput")}function ft(){return document.getElementById("rssSourceResults")}function Lt(){return document.getElementById("rssSourcePickerStatus")}function N(t){let e=document.getElementById(t);return e&&typeof e.value=="string"?e.value.trim():""}function B(t,e){let r=document.getElementById(t);r&&(r.value=e==null?"":String(e))}function pt(){let t=ut();return t&&typeof t.value=="string"?t.value.trim():""}function Mt(t){w=t&&typeof t=="object"?t:null;let e=ut(),r=xt(),i=w?String(w.id||"").trim():"",n=w?String(w.name||w.host||i):"",s=w?String(w.url||"").trim():"";e&&(e.value=i),r&&(r.textContent=i?`${n}${s?` (${s})`:""}`:"\u672A\u9009\u62E9"),i&&!W&&(!N("rssFeedTitle")||O)&&(B("rssFeedTitle",n),O=!0),i&&mt(i),v()}function mt(t){let e=String(t||"").trim();if(!e)return;let r=Date.now(),i=15e3,n=ot.get(e)||0;r-n<i||(ot.set(e,r),x&&(window.clearTimeout(x),x=0),x=window.setTimeout(async()=>{x=0;let s=Date.now()-(st||0);if(s<400){x=window.setTimeout(()=>{x=0,mt(e)},400-s);return}st=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[e],priority:"high"})})}catch{}},300))}function J(t){let e=Lt();e&&(e.textContent=t==null?"":String(t))}async function yt(){let t=await fetch("/api/rss-source-categories"),e=await t.json();if(!t.ok)throw new Error(e?.detail||"Failed to load categories");let r=Array.isArray(e?.categories)?e.categories:[],i=$t();if(!i)return r;let n=r.map(s=>{let u=String(s?.id||""),o=String(s?.name||u||""),l=Number(s?.count||0),c=u===z;return`
          <button type="button" class="platform-select-action-btn" data-cat="${y(u)}" style="justify-content:flex-start;${c?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${y(o)} <span style="opacity:0.7;">(${l})</span>
          </button>`}).join("");return i.innerHTML=n,i.querySelectorAll("button[data-cat]").forEach(s=>{s.addEventListener("click",()=>{z=String(s.getAttribute("data-cat")||""),yt().catch(()=>{}),et({reset:!0})})}),r}async function gt(t={}){let e=t.reset===!0;if(!K){K=!0;try{e&&(b=[],P=0,F=0),J("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;D&&r.set("q",D),z&&r.set("category",z),r.set("limit",String(ht)),r.set("offset",String(P));let i=await fetch(`/api/rss-sources/search?${r.toString()}`),n=await i.json();if(!i.ok)throw new Error(n?.detail||"Search failed");let s=Array.isArray(n?.sources)?n.sources:[];F=Number(n?.total||0),e?b=s:b=b.concat(s),P=Number(n?.next_offset??P+s.length)||P+s.length,St();let o=b.length<F;J(`\u5DF2\u52A0\u8F7D ${b.length}/${F}${o?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{K=!1}}}function St(){Q||(Q=window.requestAnimationFrame(()=>{Q=0,Nt()}))}function Nt(){let t=ft();if(!t)return;let e=t.scrollTop||0,r=t.clientHeight||360,i=b.length,n=i*L,s=Math.max(0,Math.floor(e/L)-nt),u=Math.min(i,Math.ceil((e+r)/L)+nt),o=t.querySelector(":scope > .rss-src-inner");o||(t.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',o=t.querySelector(":scope > .rss-src-inner")),o.style.height=`${n}px`;let l=[];for(let d=s;d<u;d++){let f=b[d]||{},a=String(f.id||"").trim(),m=String(f.name||f.host||a),k=String(f.url||"");l.push(`<div class="rss-source-item" data-source-id="${y(a)}" style="position:absolute;left:0;right:0;top:${d*L}px;height:${L}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <span style="font-weight:700;font-size:0.9rem;color:#111827;">${y(m)}</span>
                <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${y(k)}</span>
              </div>
            </div>`)}o.innerHTML=l.join(""),o.querySelectorAll(".rss-source-item[data-source-id]").forEach(d=>{d.addEventListener("click",()=>{let f=String(d.getAttribute("data-source-id")||"").trim(),a=b.find(m=>m&&String(m.id||"").trim()===f)||null;Mt(a),rt()})}),e+r>=n-L*6&&b.length<F&&gt({reset:!1}).catch(d=>{J(d?.message||String(d))})}function et(t={}){let e=t.reset!==!1;gt({reset:e}).catch(r=>{J(r?.message||String(r))})}function Bt(){let t=tt();if(!t)return;at=!0,t.classList.add("show");let e=dt();e&&(e.value=D,e.focus()),yt().catch(()=>{}),et({reset:!0})}function rt(){let t=tt();t&&(at=!1,t.classList.remove("show"))}function _(){let t=Rt();if(!t)return;let e=S.getSubscriptions();if(!e.length){t.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=e.map((i,n)=>{let s=String(i?.source_id||i?.rss_source_id||"").trim(),u=y(i.url||""),o=y(i.feed_title||""),l=y(i.column||"RSS"),c=o?`${o}`:u,d=s&&T.has(s);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${c}</span>
                            ${d?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${u}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${l}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${n})">\u5220\u9664</button>
                </div>
            </div>`}).join("");t.innerHTML=r,v()}var S={getSubscriptionsRaw(){let t=H.get(G,[]);return Array.isArray(t)?t:[]},setSubscriptionsRaw(t){if(!Array.isArray(t)){H.set(G,[]);return}H.set(G,t)},getSubscriptions(){return this.getSubscriptionsRaw().filter(e=>e&&typeof e=="object").map(e=>({source_id:String(e.source_id||e.rss_source_id||"").trim(),url:String(e.url||"").trim(),feed_title:String(e.feed_title||"").trim(),column:String(e.column||"RSS").trim()||"RSS",platform_id:String(e.platform_id||"").trim()})).filter(e=>!!e.source_id||!!e.url)},setSubscriptions(t){this.setSubscriptionsRaw(t)},ensureSnapshot(){if(!Array.isArray(g))try{g=this.getSubscriptions()}catch{g=null}},stageFromCatalogPreview(t={}){let e=String(t?.source_id||t?.rss_source_id||"").trim();if(!e)return;let r=String(t?.url||"").trim(),i=String(t?.feed_title||t?.name||"").trim(),n=String(t?.column||"RSS").trim()||"RSS";this.ensureSnapshot();let s=this.getSubscriptions(),u=s.findIndex(c=>c?.source_id&&c.source_id===e),o={source_id:e,url:r,feed_title:i,column:n,platform_id:""};u>=0?s[u]=o:s.unshift(o),this.setSubscriptions(s);let l=Number(t?.entries_count??0)||0;E.set(e,{ok:!0,entries_count:l,ts:Date.now()});try{_()}catch{}v()},open(){let t=X();if(!t)return;try{g=this.getSubscriptions()}catch{g=null}B("rssFeedTitle",""),O=!1,W=!1,E.clear(),T.clear(),_();let e=U();e&&(e.innerHTML=""),p(""),t.classList.add("show"),v(),lt({showHintOn403:!1}).catch(()=>{})},close(){let t=X();t&&t.classList.remove("show")},async previewCurrent(){let t=pt();if(!t){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await kt(t)}catch(e){E.set(String(t||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(e?.message||e)}),v();let r=U();r&&(r.innerHTML=`<div style="color:#dc2626;">${y(e?.message||String(e))}</div>`)}},removeAt(t){let e=this.getSubscriptions();if(!(t<0||t>=e.length)){try{let r=String(e[t]?.source_id||e[t]?.rss_source_id||"").trim();r&&T.delete(r)}catch{}e.splice(t,1),this.setSubscriptions(e),_()}},async saveOnly(){try{let t=Array.isArray(g)?g:[],e=this.getSubscriptions(),r=M(t)!==M(e),n=Z(t,e).every(l=>{let c=E.get(l);return!!c&&c.ok===!0&&Number(c.entries_count||0)>0});if(!r){p("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58",{variant:"info"}),v();return}if(!n){p("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),v();return}let s=e;try{let l=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:j(e)})});if(l.status===403){I=!0,A=!1;try{$()}catch{}p("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let c=await l.json().catch(()=>({}));if(!l.ok)throw new Error(c?.detail||"Save failed");s=j(c?.subscriptions),I=!0,A=!0;try{$()}catch{}this.setSubscriptions(s)}}catch(l){p(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(l?.message||l)}`,{variant:"info"})}let u=new Set(t.map(l=>String(l?.source_id||l?.rss_source_id||"").trim()).filter(Boolean)),o=s.map(l=>String(l?.source_id||l?.rss_source_id||"").trim()).filter(l=>!!l&&!u.has(l));if(o.length>0&&(Y(o,!0),_()),o.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:o,priority:"high"})})}catch{}try{g=this.getSubscriptions()}catch{g=null}_(),v()}catch(t){console.error("rss save error:",t);try{p(String(t?.message||t),{variant:"error"})}catch{}}},async saveAndRefresh(){try{let t=Array.isArray(g)?g:[],e=this.getSubscriptions(),r=M(t)!==M(e),n=Z(t,e).every(a=>{let m=E.get(a);return!!m&&m.ok===!0&&Number(m.entries_count||0)>0});if(!r){p("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),v();return}if(!n){p("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),v();return}let s=e;try{let a=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:j(e)})});if(a.status===403){I=!0,A=!1;try{$()}catch{}p("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let m=await a.json().catch(()=>({}));if(!a.ok)throw new Error(m?.detail||"Save failed");s=j(m?.subscriptions),I=!0,A=!0;try{$()}catch{}this.setSubscriptions(s)}}catch(a){p(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(a?.message||a)}`,{variant:"info"})}let u=new Set(t.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(Boolean)),o=s.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(a=>!!a&&!u.has(a));if(o.length>0&&(Y(o,!0),_()),o.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:o,priority:"high"})})}catch{}p("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let a=document.querySelector("#rssSubscriptionModal .settings-btn-primary");a&&a.setAttribute("disabled","true")}catch{}let l=Date.now(),c=5e3,d=[0,300,700,1500,2500],f=!1;for(let a of d){let m=Date.now()-l,k=c-m;if(k<=0)break;if(a>0&&await ct(Math.min(a,k)),await R.data.refreshViewerData({preserveScroll:!0}),o.length>0){let C=[];for(let h of o)T.has(h)&&vt([h])&&T.delete(h),T.has(h)&&C.push(h);if(C.length===0){f=!0,_();break}_()}if(o.length===0){f=!0;break}}f?p("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(o.length>0&&(Y(o,!1),_()),p("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let a=document.querySelector("#rssSubscriptionModal .settings-btn-primary");a&&a.removeAttribute("disabled")}catch{}await ct(f?200:800),this.close()}catch(t){console.error("rss refresh error:",t);try{p(String(t?.message||t),{variant:"error"})}catch{}try{let e=document.querySelector("#rssSubscriptionModal .settings-btn-primary");e&&e.removeAttribute("disabled")}catch{}}}};async function Ct(){let t=N("rssRequestUrl"),e=N("rssRequestTitle"),r=N("rssRequestNote");if(!t){alert("\u8BF7\u8F93\u5165 URL");return}if(!e){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let i=U();i&&(i.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let n=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,title:e,note:r})}),s=await n.json();if(!n.ok)throw new Error(s?.detail||"Submit failed");i&&(i.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${y(s?.status||"pending")}</div>`),B("rssRequestUrl",""),B("rssRequestTitle",""),B("rssRequestNote","")}catch(n){i&&(i.innerHTML=`<div style="color:#dc2626;">${y(n?.message||String(n))}</div>`)}}function Pt(){let t=It();if(!t)return;let e=t.style.display!=="none";t.style.display=e?"none":"block"}window.openRssSubscriptionModal=()=>{try{let t=document.getElementById("rssSubscriptionNewBadge");t&&(t.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}S.open()};window.closeRssSubscriptionModal=()=>S.close();window.previewRssSubscription=()=>S.previewCurrent();window.saveRssSubscriptions=()=>S.saveAndRefresh();window.removeRssSubscription=t=>S.removeAt(parseInt(t,10));window.submitRssSourceRequest=()=>Ct();window.toggleRssRequestSection=()=>Pt();window.openRssSourcePicker=()=>Bt();window.closeRssSourcePicker=()=>rt();R.subscription=S;R.subscription._serverEnabled=A;function $(){try{R.subscription._serverEnabled=!!A}catch{}}it(function(){let t=X();if(t){let n=document.getElementById("rssFeedTitle");n&&n.addEventListener("input",()=>{W=String(n.value||"").trim()!=="",O=!1}),t.addEventListener("keydown",s=>{s.key==="Escape"&&S.close()})}let e=tt();e&&e.addEventListener("keydown",n=>{n.key==="Escape"&&rt()});let r=ft();r&&r.addEventListener("scroll",()=>{St()});let i=dt();i&&i.addEventListener("input",()=>{D=String(i.value||"").trim(),q&&(window.clearTimeout(q),q=0),q=window.setTimeout(()=>{q=0,et({reset:!0})},250)}),$(),lt({showHintOn403:!1}).catch(()=>{})});export{S as subscription};
