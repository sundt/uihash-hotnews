<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth ç™»å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #357ae8;
        }
        .logout-btn {
            background: #ea4335;
        }
        .logout-btn:hover {
            background: #d33828;
        }
        .clear-btn {
            background: #fbbc04;
            color: #000;
        }
        .clear-btn:hover {
            background: #f9ab00;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” OAuth ç™»å½•æµ‹è¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>æ­¥éª¤ 1: æ£€æŸ¥å½“å‰çŠ¶æ€</h2>
        <button onclick="checkAuthStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
        <div id="auth-status"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 2: æ¸…é™¤æ—§æ•°æ®</h2>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        <button class="clear-btn" onclick="clearCookies()">æ¸…é™¤æ‰€æœ‰ Cookie</button>
        <div id="clear-status"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 3: é‡æ–°ç™»å½•</h2>
        <button onclick="loginWithGoogle()">ğŸ”µ Google ç™»å½•</button>
        <button onclick="loginWithGitHub()">âš« GitHub ç™»å½•</button>
    </div>

    <div class="section">
        <h2>è°ƒè¯•ä¿¡æ¯</h2>
        <button onclick="showCookies()">æ˜¾ç¤º Cookies</button>
        <button onclick="testEndpoints()">æµ‹è¯• API ç«¯ç‚¹</button>
        <div id="debug-info"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status info">æ£€æŸ¥ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.ok && data.user) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            âœ… å·²ç™»å½•<br>
                            <pre>${JSON.stringify(data.user, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div class="status info">âŒ æœªç™»å½•ï¼ˆåŒ¿åçŠ¶æ€ï¼‰</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function logout() {
            const statusDiv = document.getElementById('clear-status');
            statusDiv.innerHTML = '<div class="status info">é€€å‡ºä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.ok) {
                    statusDiv.innerHTML = '<div class="status success">âœ… å·²é€€å‡ºç™»å½•</div>';
                    setTimeout(() => checkAuthStatus(), 500);
                } else {
                    statusDiv.innerHTML = '<div class="status error">é€€å‡ºå¤±è´¥</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        function clearCookies() {
            const statusDiv = document.getElementById('clear-status');
            
            // æ¸…é™¤æ‰€æœ‰ cookie
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            statusDiv.innerHTML = '<div class="status success">âœ… å·²æ¸…é™¤æ‰€æœ‰ Cookie</div>';
            setTimeout(() => checkAuthStatus(), 500);
        }

        function loginWithGoogle() {
            window.location.href = `${API_BASE}/api/auth/oauth/google`;
        }

        function loginWithGitHub() {
            window.location.href = `${API_BASE}/api/auth/oauth/github`;
        }

        function showCookies() {
            const debugDiv = document.getElementById('debug-info');
            const cookies = document.cookie || '(æ—  Cookie)';
            debugDiv.innerHTML = `
                <div class="status info">
                    <strong>å½“å‰ Cookies:</strong>
                    <pre>${cookies}</pre>
                </div>
            `;
        }

        async function testEndpoints() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = '<div class="status info">æµ‹è¯•ä¸­...</div>';
            
            const tests = [
                { name: '/api/auth/me', url: '/api/auth/me' },
                { name: '/api/auth/oauth/google', url: '/api/auth/oauth/google' },
            ];
            
            let results = '<div class="status info"><strong>API ç«¯ç‚¹æµ‹è¯•:</strong><br>';
            
            for (const test of tests) {
                try {
                    const response = await fetch(`${API_BASE}${test.url}`, {
                        method: 'HEAD',
                        credentials: 'include'
                    });
                    results += `âœ… ${test.name}: ${response.status}<br>`;
                } catch (error) {
                    results += `âŒ ${test.name}: ${error.message}<br>`;
                }
            }
            
            results += '</div>';
            debugDiv.innerHTML = results;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = () => {
            checkAuthStatus();
        };
    </script>
</body>
</html>
