(()=>{var a=window.TrendRadar=window.TrendRadar||{},se=[],ae=!1;function p(e){ae?e():se.push(e)}document.addEventListener("DOMContentLoaded",function(){ae=!0,se.forEach(e=>{try{e()}catch(t){console.error("Ready handler error:",t)}})});function y(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function I(e){let t=e==null?"":String(e).trim();if(!t)return t;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(t.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),t)}a.ready=p;a.escapeHtml=y;a.formatUpdatedAt=I;var d={get(e,t=null){try{let r=localStorage.getItem(e);return r===null?t:JSON.parse(r)}catch{return t}},set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("Storage set error:",r)}},remove(e){try{localStorage.removeItem(e)}catch{}},getRaw(e){return localStorage.getItem(e)},setRaw(e,t){localStorage.setItem(e,t)}};a.storage=d;var ke={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};a.counts=ke;var _={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;let o=r.querySelector(".news-checkbox");if(o&&!o.checked&&(o.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(o):a.readState&&typeof a.readState.markAsRead=="function"&&a.readState.markAsRead(o)),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}t.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"?this.handleTitleClickV2(e,t):t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>_.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>_.handleTitleKeydownV2(e,t);window.openLink=e=>_.openLink(e);document.addEventListener("click",e=>{e.target.closest(".news-item")||_.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||_.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&_.closeAllPreviews(null)});a.link=_;var ne={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let o=r.textContent.toLowerCase();!t||o.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),a.counts.updateAllCounts(),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>ne.searchNews();a.search=ne;var ie="trendradar_platform_grid_scroll_v1",Be={getPlatformGridScrollState(){return d.get(ie,{})},setPlatformGridScrollState(e){d.set(ie,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,o=null,s=0,n=null,c=t.querySelectorAll(".platform-card");for(let i of c)if((i.offsetLeft||0)<=r+1)n=i;else break;n?.dataset?.platform&&(o=n.dataset.platform,s=Math.max(0,r-(n.offsetLeft||0)));let l=this.getPlatformGridScrollState();l[e]={left:r,anchorPlatformId:o,anchorOffsetX:s,updatedAt:Date.now()},this.setPlatformGridScrollState(l)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{t||(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),o=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(o,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],o=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,s=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,n=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,c=()=>{let l=document.querySelector(`#tab-${t} .platform-grid`);if(l){if(s){let i=null;if(l.querySelectorAll(".platform-card").forEach(g=>{!i&&g.dataset.platform===s&&(i=g)}),i&&i.offsetParent!==null){l.scrollLeft=(i.offsetLeft||0)+n;return}}l.scrollLeft=o}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{c(),setTimeout(c,50),setTimeout(c,200),setTimeout(c,600)})})}};a.scroll=Be;var le="trendradar_feature_badge_v1:",ce="trendradar_new_badges_dismissed_v1",X={getFeatureBadgeState(e){return d.get(le+e,null)},setFeatureBadgeState(e,t){d.set(le+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let o=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=o},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=d.get(ce,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){d.set(ce,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>X.dismissNewPlatformBadge(e);a.badges=X;p(function(){X.applyDismissedNewBadges()});var L=20,De=20,de=10,xe=8,Ie=80,Ne=160,N={PAGE_SIZE:L,getCardPageSize(e){let t=e?.dataset?.pageSize,r=parseInt(t||"",10);return Number.isFinite(r)&&r>0?r:L},setCardPageSize(e,t){if(!e)return;let r=Math.max(L,parseInt(String(t||""),10)||L);e.dataset.pageSize=String(r)},applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),o=r.length,s=this.getCardPageSize(e);if(o<=s){r.forEach(l=>l.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let n=Math.max(0,Math.min(t,o-1)),c=Math.min(n+s,o);r.forEach((l,i)=>{i>=n&&i<c?l.classList.remove("paged-hidden"):l.classList.add("paged-hidden")}),e.dataset.pageOffset=String(n)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{this.setCardPageSize(e,L),this.applyPagingToCard(e,0)}),a.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let o=t.querySelectorAll(".news-item").length;if(o<=L)return;let s=parseInt(t.dataset.pageOffset||"0",10),n=s+L>=o?0:s+L;this.applyPagingToCard(t,n),a.counts.updateAllCounts()},getVisibleNewsItems(e){return e?Array.from(e.querySelectorAll(".news-item")).filter(t=>!t.classList.contains("filtered")&&!t.classList.contains("search-hidden")&&!t.classList.contains("paged-hidden")&&!t.classList.contains("read")):[]},shouldAutofillCard(e,t){if(!e||e.classList.contains("platform-empty-hidden"))return!1;let r=this.getVisibleNewsItems(e),o=Number.isFinite(t)?t:de;if(r.length<o)return!0;let s=r[r.length-1];if(!s)return!0;let n=e.getBoundingClientRect(),c=s.getBoundingClientRect();return!Number.isFinite(n.bottom)||!Number.isFinite(c.bottom)?!1:n.bottom-c.bottom>=Ie},autofillCard(e,t={}){if(!e)return!1;let r=Number.isFinite(t.minVisible)?t.minVisible:de,o=Number.isFinite(t.maxSteps)?t.maxSteps:xe,s=t.force===!0,n=e.querySelectorAll(".news-item").length;if(n<=0)return!1;let c=parseInt(e.dataset.pageOffset||"0",10)||0,l=this.getCardPageSize(e),i=!1;for(let g=0;g<o&&!(!s&&!this.shouldAutofillCard(e,r)||c+l>=n);g++)l=Math.min(n-c,l+De),this.setCardPageSize(e,l),this.applyPagingToCard(e,c),i=!0;return i&&a.counts.updateAllCounts(),i},autofillForCategory(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r)return!1;let o=!1;return r.querySelectorAll(".platform-card").forEach(s=>{this.autofillCard(s,t)&&(o=!0)}),o},autofillActiveTab(e={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,e):!1},scheduleAutofillActiveTab(e={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(e)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=Ne&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=e=>N.refreshPlatform(e);a.paging=N;p(function(){N.initPaging(),N.attachAutofillScrollListener(),N.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var ge="trendradar_online_session_id",$={getSessionId(){let e=d.getRaw(ge);return e||(window.crypto&&crypto.randomUUID?e=crypto.randomUUID():e="sess_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,10),d.setRaw(ge,e),e)},async ping(){try{await fetch("/api/online/ping",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:this.getSessionId()})})}catch{}},async refreshStats(){try{let t=await(await fetch("/api/online")).json(),r=document.getElementById("online5m");r&&(r.textContent=t.online_5m??"-")}catch{}}};a.online=$;p(function(){$.ping(),$.refreshStats(),setInterval(()=>$.ping(),15e3),setInterval(()=>$.refreshStats(),1e4)});var fe="trendradar_read_news_v2",me="trendradar_read_news",ue="trendradar_show_read_mode",$e=24,b={getReadNews(){return d.get(fe,{})},saveReadNews(e){d.set(fe,e)},getShowReadModePref(){let e=d.getRaw(ue);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){d.getRaw(me)&&(d.remove(me),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,o=0;for(let[s,n]of Object.entries(t))if((e-n.readAt)/36e5>=$e){let l=document.querySelector(`[data-news-id="${s}"]`);if(l){l.classList.remove("read");let i=l.querySelector(".news-checkbox");i&&(i.checked=!1)}delete t[s],r=!0,o++}return r&&this.saveReadNews(t),o},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,o=t.dataset.newsTitle||"",s=this.getReadNews();e.checked?(t.classList.add("read"),s[r]||(s[r]={title:o.substring(0,50),readAt:Date.now()},this.saveReadNews(s))):(t.classList.remove("read"),delete s[r],this.saveReadNews(s)),a.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let o=r.querySelector(".news-checkbox");o&&(o.checked=!0)}}),a.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),d.setRaw(ue,e?"1":"0"),a.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),a.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>b.markAsRead(e);window.toggleShowRead=()=>b.toggleShowRead();window.clearAllRead=()=>b.clearAllRead();a.readState=b;p(function(){b.applyShowReadMode(b.getShowReadModePref()),b.migrateOldFormat();let e=b.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),b.restoreReadState(),b.updateReadCount()});var G="trendradar_categories_config",W=1,u=null,S=null,P=null,j=!1,k=!1,T=!0,qe=null,q="",O=!1;function J(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function ye(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),J(t),t}var h={CATEGORY_CONFIG_KEY:G,ensureCategoryFilters:J,normalizeCategoryConfig:ye,getCategoryConfig(){try{let e=d.getRaw(G);if(!e)return null;let t=JSON.parse(e);return t.version!==W?null:ye(t)}catch{return null}},saveCategoryConfig(e){e.version=W,d.setRaw(G,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return u||(u={},S={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",o=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;u[t]={id:t,name:o,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(e=>{let t=e.dataset.platform,r=e.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||t,s=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";S[t]={id:t,name:r,defaultCategory:s},u[s]&&(u[s].platforms||(u[s].platforms=[]),u[s].platforms.push(t))})),{version:W,customCategories:[],hiddenDefaultCategories:[],categoryOrder:Object.keys(u),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}};return Object.keys(u).forEach(o=>{r.categoryOrder.includes(o)||r.categoryOrder.push(o)}),r.customCategories.forEach(o=>{r.categoryOrder.includes(o.id)||r.categoryOrder.push(o.id)}),r},getDefaultCategories(){return u},getAllPlatforms(){return S},setDefaultCategories(e){u=e},setAllPlatforms(e){S=e},async openCategorySettings(){let e=document.getElementById("categorySettingsNewBadge");if(e&&(e.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!u||Object.keys(u).length===0)try{let o=await(await fetch("/api/news")).json();o?.categories&&(u={},S={},Object.entries(o.categories).forEach(([s,n])=>{u[s]={id:s,name:n.name,icon:n.icon,isDefault:!0,platforms:Object.keys(n.platforms||{})},Object.entries(n.platforms||{}).forEach(([c,l])=>{S[c]={id:c,name:l.name,defaultCategory:s,data:l}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),T=!0,qe=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(T?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=T?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){T=!T,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),O&&(O=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){O=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(s=>{let n=t.customCategories.find(g=>g.id===s),c=t.hiddenDefaultCategories.includes(s),l;if(n)l=n;else if(u[s])l=u[s];else return;let i=n?l.platforms?.length||0:u[s]?.platforms?.length||0;r+=`
                <div class="category-item ${n?"custom":""}" data-category-id="${s}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${l.name}</span>
                    <span class="category-item-platforms">${i} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${c?"":"checked"} onchange="toggleCategoryVisibility('${s}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${s}')">\u7F16\u8F91</button>
                        ${n?`<button class="category-item-btn delete" onclick="deleteCategory('${s}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let o=document.getElementById("allCategoriesOffToggle");if(o){let s=t.hiddenDefaultCategories||[],n=t.categoryOrder||[];o.checked=n.length>0&&n.every(c=>s.includes(c))}k?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){k=!k,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",o=>{o.preventDefault();let s=e.querySelector(".dragging");if(s&&s!==r){let n=r.getBoundingClientRect(),c=n.top+n.height/2;o.clientY<c?e.insertBefore(s,r):e.insertBefore(s,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(s=>s.dataset.categoryId),o=this.getCategoryConfig()||this.getDefaultCategoryConfig();o.categoryOrder=r,this.saveCategoryConfig(o),O=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),O=!0,this.renderCategoryList()},showAddCategoryPanel(){j=!0,P=null,T=!0,this.applyCategoryListCollapseState(),k=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSearchInput");e&&(e.value=""),q="",this.renderPlatformSelectList([]),a.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){j=!1,P=e;let t=this.getMergedCategoryConfig(),r=t.customCategories.find(l=>l.id===e),o,s;r?(o=r,s=o.platforms||[]):(o=u[e],s=t.platformOrder[e]||o.platforms||[]),document.getElementById("editCategoryName").value=o.name,this.renderPlatformSelectList(s,r);let n=a.filter.getCategoryFilterConfig(e);a.filter.setCategoryFilterEditorState(n.mode,n.keywords),k=!0,T=!0,this.applyCategoryListCollapseState();let c=document.getElementById("platformSearchInput");c&&(c.value=""),q="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),P=null,j=!1,k=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),q=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),o=Object.keys(S),s=[];e.forEach(i=>{S[i]&&s.push(i)}),o.forEach(i=>{s.includes(i)||s.push(i)});let n=(q||"").trim().toLowerCase(),c=n?s.filter(i=>(S[i]?.name||"").toLowerCase().includes(n)):s,l=n.length>0;r.innerHTML=c.map(i=>{let g=S[i],m=e.includes(i);return`
                <label class="platform-select-item ${m?"selected":""} ${l?"no-drag":""}" data-platform-id="${i}" draggable="${l?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${m?"checked":""} onchange="togglePlatformSelect('${i}')">
                    <span>${g.name}</span>
                </label>
            `}).join(""),l||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){q=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(o=>{let s=o.querySelector('input[type="checkbox"]');e==="all"?(o.classList.add("selected"),s&&(s.checked=!0)):(e==="none"||e==="clear")&&(o.classList.remove("selected"),s&&(s.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList");e.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",o=>{o.preventDefault();let s=e.querySelector(".dragging");if(s&&s!==r){let n=r.getBoundingClientRect(),c=n.top+n.height/2;o.clientY<c?e.insertBefore(s,r):e.insertBefore(s,r.nextSibling)}})})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let o=this.getCategoryConfig()||this.getDefaultCategoryConfig();J(o);let s=a.filter.getEditingFilterState();if(j){let n="custom-"+Date.now();o.customCategories.push({id:n,name:e,icon:t,platforms:r,isCustom:!0}),o.categoryOrder.unshift(n),o.categoryFilters[n]={mode:s.mode,keywords:[...s.keywords]}}else if(P){let n=o.customCategories.findIndex(c=>c.id===P);n>=0?o.customCategories[n]={...o.customCategories[n],name:e,icon:t,platforms:r}:o.platformOrder[P]=r,o.categoryFilters[P]={mode:s.mode,keywords:[...s.keywords]}}return this.saveCategoryConfig(o),O=!0,this.hideEditPanel(),this.renderCategoryList(),T=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),O=!0,this.renderCategoryList()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(d.remove(G),u=null,S=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){a.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();u||(u={},S={},Object.entries(e).forEach(([i,g])=>{u[i]={id:i,name:g.name,icon:g.icon,isDefault:!0,platforms:Object.keys(g.platforms||{})},Object.entries(g.platforms||{}).forEach(([m,C])=>{S[m]={id:m,name:C.name,defaultCategory:i,data:C}})}));let r={};Object.values(e).forEach(i=>{Object.entries(i.platforms||{}).forEach(([g,m])=>{r[g]=m})});let o={},s=t.hiddenDefaultCategories||[],n=t.categoryOrder||Object.keys(e),c=t.customCategories||[],l=t.platformOrder||{};return n.forEach(i=>{if(s.includes(i))return;let g=c.find(m=>m.id===i);if(g){let m={};(g.platforms||[]).forEach(C=>{r[C]&&(m[C]=r[C])}),o[i]={name:g.name,icon:"\u{1F4F1}",platforms:m}}else if(e[i]){let m=e[i],C=l[i];if(C&&C.length>0){let f={};C.forEach(w=>{m.platforms&&m.platforms[w]&&(f[w]=m.platforms[w])}),Object.keys(m.platforms||{}).forEach(w=>{f[w]||(f[w]=m.platforms[w])}),o[i]={...m,platforms:f}}else o[i]=m}}),Object.keys(e).forEach(i=>{!o[i]&&!s.includes(i)&&(o[i]=e[i])}),o}};window.openCategorySettings=()=>h.openCategorySettings();window.closeCategorySettings=()=>h.closeCategorySettings();window.saveCategorySettings=()=>h.saveCategorySettings();window.cancelCategorySettings=()=>h.cancelCategorySettings();window.showAddCategoryPanel=()=>h.showAddCategoryPanel();window.editCategory=e=>h.editCategory(e);window.cancelEditCategory=()=>h.cancelEditCategory();window.saveCategory=()=>h.saveCategory();window.deleteCategory=e=>h.deleteCategory(e);window.resetCategoryConfig=()=>h.resetCategoryConfig();window.toggleCategoryVisibility=e=>h.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>h.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>h.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>h.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>h.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>h.setPlatformSearchQuery(e);a.settings=h;p(function(){let e=h.getCategoryConfig();e&&h.syncConfigToCookie(e)});var pe="trendradar_filter_keywords",he="trendradar_filter_mode_v1",R=[],V="exclude";function H(e){return e==="include"?"include":"exclude"}var F={normalizeFilterMode:H,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=a.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],o=H(r&&r.mode),s=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:o,keywords:s.map(n=>String(n||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),o=r.mode,s=r.keywords;t.querySelectorAll(".news-item").forEach(n=>{let c=(n.textContent||"").toLowerCase(),l=s.length>0?s.some(g=>c.includes(g)):!1;(s.length===0?!1:o==="include"?!l:l)?n.classList.add("filtered"):n.classList.remove("filtered")}),t.querySelectorAll(".platform-card").forEach(n=>{n.classList.remove("platform-empty-hidden")}),o==="include"&&t.querySelectorAll(".platform-card").forEach(n=>{n.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&n.classList.add("platform-empty-hidden")}),a.counts.updateAllCounts(),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){V=H(e),R=(Array.isArray(t)?t:[]).map(s=>String(s||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=V==="include");let o=document.getElementById("categoryFilterInput");o&&(o.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){V=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(R.includes(t)||(R.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){R=R.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=R.map(t=>`<span class="filter-tag">${y(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${y(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:V,keywords:[...R]}},migrateLegacyGlobalFilter(){let e=d.getRaw(pe),t=d.getRaw(he);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(l=>String(l||"").trim().toLowerCase()).filter(Boolean);let o=H(t),s=a.settings.getCategoryConfig()||a.settings.getDefaultCategoryConfig();a.settings.ensureCategoryFilters(s),(a.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(l=>{s.categoryFilters[l]||(s.categoryFilters[l]={mode:o,keywords:[...r]})}),a.settings.saveCategoryConfig(s),d.remove(pe),d.remove(he)}};window.handleCategoryFilterModeToggle=e=>F.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>F.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>F.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>F.removeCategoryFilterKeyword(e);a.filter=F;p(function(){F.migrateLegacyGlobalFilter(),F.applyCategoryFilterForActiveTab()});var M="trendradar_active_tab",B={TAB_STORAGE_KEY:M,switchTab(e){a.badges.dismissNewCategoryBadge(e);let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),o=document.getElementById(`tab-${e}`);if(!r||!o){let s=document.querySelector(".category-tab");s?.dataset?.category&&s.dataset.category!==String(e)?this.switchTab(s.dataset.category):d.remove(M);return}document.querySelectorAll(".category-tab").forEach(s=>s.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),o.classList.add("active"),d.setRaw(M,e),a.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(a.badges.markFeatureSeen("sports-nba-schedule"),a.badges.updateNewBadges()),a.filter.applyCategoryFilter(e),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1})},restoreActiveTab(){let e=d.getRaw(M);e&&document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)},getActiveTabId(){return d.getRaw(M)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){a.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){a.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>B.switchTab(e);a.tabs=B;p(function(){B.restoreActiveTab(),B.attachPlatformGridScrollPersistence();let e=B.getActiveTabId();e&&B.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var Q="trendradar_active_tab",Me=20,Z=!1,we=0,D=null,K={formatUpdatedAt:I,snapshotViewerState(){let e=d.getRaw(Q)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(c=>{let l=c.dataset.platform;l&&(t[l]=parseInt(c.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,o=r&&r.scrollLeft||0,s=null,n=0;if(r){let c=r.scrollLeft||0,l=null,i=r.querySelectorAll(".platform-card");for(let g of i)if((g.offsetLeft||0)<=c+1)l=g;else break;l?.dataset?.platform&&(s=l.dataset.platform,n=Math.max(0,c-(l.offsetLeft||0)))}return e&&r&&a.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:o,activeTabPlatformAnchorPlatformId:s,activeTabPlatformAnchorOffsetX:n,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),o=document.querySelector(".category-tabs");if(!o||!r)return;let s=a.settings.applyCategoryConfigToData(e?.categories||{}),n=Object.entries(s).map(([f,w])=>{let E=y(w?.icon||""),Y=y(w?.name||f),U=`${w?.is_new?`<span class="new-badge new-badge-category" data-category="${y(f)}">NEW</span>`:""}${f==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab" data-category="${y(f)}" onclick="switchTab('${y(f)}')">
                <div class="category-tab-icon">${E}</div>
                <div class="category-tab-name">${Y}${U}</div>
            </div>`}).join(""),c=Object.entries(s).map(([f,w])=>{let E=w?.platforms||{},Y=Object.entries(E).map(([A,x])=>{let U=y(x?.name||A),Ce=x?.is_new?`<span class="new-badge new-badge-platform" data-platform="${y(A)}">NEW</span>`:"",Se=Array.isArray(x?.news)?x.news:[],ee=A&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[A])?t.pagingOffsets[A]:0,be=Se.map((v,z)=>{let ve=y(v?.stable_id||""),te=y(v?.display_title||v?.title||""),Ee=y(v?.url||""),re=y(v?.meta||""),oe=!!v?.is_cross_platform,Ae=Array.isArray(v?.cross_platforms)?v.cross_platforms:[],Le=y(Ae.join(", ")),Te=y(v?.cross_platform_count??""),_e=oe?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${Le}">\u{1F525} ${Te}</span>`:"",Pe=oe?"cross-platform":"",Oe=`<span class="news-index">${String(z+1)}</span>`,Re=z<ee||z>=ee+Me?" paged-hidden":"",Fe=re?`<div class="news-subtitle">${re}</div>`:"";return`
                        <li class="news-item${Re}" data-news-id="${ve}" data-news-title="${te}">
                            <div class="news-item-content">
                                <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="\u6807\u8BB0\u5DF2\u8BFB">
                                ${Oe}
                                <a class="news-title ${Pe}" href="${Ee||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${te}
                                    ${_e}
                                </a>
                            </div>
                            ${Fe}
                        </li>`}).join("");return`
                <div class="platform-card" data-platform="${y(A)}">
                    <div class="platform-header">
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${y(A)}')">\u{1F4F1} ${U}${Ce}</div>
                        
                    </div>
                    <ul class="news-list">${be}
                    </ul>
                </div>`}).join("");return`
            <div class="tab-pane" id="tab-${y(f)}">
                <div class="platform-grid">${Y}
                </div>
            </div>`}).join("");o.innerHTML=n,r.innerHTML=c;try{let f=o.querySelectorAll(".category-tab").length;o.classList.toggle("compact",f>8)}catch{}let l=document.getElementById("updatedAt");l&&e?.updated_at&&(l.textContent=I(e.updated_at));let i=t&&typeof t.activeTab=="string"?t.activeTab:null;if(i){let f=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(i):i;if(document.querySelector(`.category-tab[data-category="${f}"]`))a.tabs.switchTab(i);else{let E=document.querySelector(".category-tab");E?.dataset?.category?a.tabs.switchTab(E.dataset.category):d.remove(Q)}}else{let f=document.querySelector(".category-tab");f?.dataset?.category?a.tabs.switchTab(f.dataset.category):d.remove(Q)}let g=typeof t?.showReadMode=="boolean"?t.showReadMode:a.readState.getShowReadModePref();a.readState.applyShowReadMode(g);let m=document.getElementById("searchInput");m&&typeof t?.searchText=="string"&&(m.value=t.searchText),a.search.searchNews(),a.filter.applyCategoryFilterForActiveTab(),a.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(f=>{let w=f.dataset.platform,E=w&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[w])?t.pagingOffsets[w]:0;a.paging.setCardPageSize(f,a.paging.PAGE_SIZE),a.paging.applyPagingToCard(f,E)}),a.counts.updateAllCounts(),a.readState.updateReadCount(),a.scroll.restoreActiveTabPlatformGridScroll(t),a.scroll.attachPlatformGridScrollPersistence();let C=document.getElementById("early-hide");C&&C.remove(),document.body.classList.add("categories-ready"),a.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1})},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(Z){D?D.preserveScroll=D.preserveScroll&&t:D={preserveScroll:t};return}Z=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let s=await(await fetch("/api/news")).json();this.renderViewerFromData(s,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),a.scroll.restoreActiveTabPlatformGridScroll(r)),we=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{Z=!1;let r=D;D=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),o=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),o.className="fetch-status",o.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let n=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),n.success?(r.style.width="100%",o.className="fetch-status success",o.textContent=`\u2705 ${n.platforms} \u4E2A\u5E73\u53F0\uFF0C${n.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${n.error}`)}catch(s){r.classList.remove("indeterminate"),r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${s.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-we<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};window.fetchData=()=>K.fetchData();window.refreshViewerData=e=>K.refreshViewerData(e);a.data=K;p(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=I(e.textContent)),K.setupAjaxAutoRefresh()});p(function(){if(localStorage.getItem("category_settings_badge_dismissed")==="true"){let o=document.getElementById("categorySettingsNewBadge");o&&(o.style.display="none")}let e=document.querySelector(".category-settings-btn");e&&e.addEventListener("click",()=>{let o=document.getElementById("categorySettingsNewBadge");o&&(o.style.display="none"),localStorage.setItem("category_settings_badge_dismissed","true")});let t=a.settings.getCategoryConfig();t&&(t.customCategories&&t.customCategories.length>0||t.hiddenDefaultCategories&&t.hiddenDefaultCategories.length>0||t.categoryOrder&&t.categoryOrder.length>0)?a.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
