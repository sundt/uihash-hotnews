(()=>{var l=window.TrendRadar=window.TrendRadar||{},ht=[],yt=!1;function v(e){yt?e():ht.push(e)}document.addEventListener("DOMContentLoaded",function(){yt=!0,ht.forEach(e=>{try{e()}catch(t){console.error("Ready handler error:",t)}})});function S(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function ie(e){let t=e==null?"":String(e).trim();if(!t)return t;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(t.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),t)}l.ready=v;l.escapeHtml=S;l.formatUpdatedAt=ie;var G={container:null,nextId:1,items:new Map};function Lr(){if(G.container)return G.container;let e=document.createElement("div");e.id="tr-toast-container",e.style.position="fixed",e.style.right="16px",e.style.bottom="16px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex="99999";try{document.body.appendChild(e)}catch{}return G.container=e,e}function xr(e){let t=String(e||"info");return t==="loading"?{bg:"#111827",fg:"#fff",border:"#111827"}:t==="success"?{bg:"#16a34a",fg:"#fff",border:"#16a34a"}:t==="error"?{bg:"#dc2626",fg:"#fff",border:"#dc2626"}:{bg:"#111827",fg:"#fff",border:"#111827"}}function pt(e,t,r){let s=xr(r);e.className="tr-toast",e.style.display="flex",e.style.alignItems="center",e.style.gap="10px",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.background=s.bg,e.style.color=s.fg,e.style.border=`1px solid ${s.border}`,e.style.boxShadow="0 10px 20px rgba(0,0,0,0.18)",e.style.fontSize="0.9rem",e.style.maxWidth="360px",e.style.wordBreak="break-word";let n=String(r||"info")==="loading"?'<span aria-hidden="true" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.3);"></span>':"";e.innerHTML=`${n}<div class="tr-toast-msg">${S(t||"")}</div>`}l.toast={show(e,t={}){let r=`toast-${G.nextId++}`,s=Lr(),o=document.createElement("div");o.dataset.toastId=r,pt(o,e,t.variant);try{s.appendChild(o)}catch{}let n={id:r,el:o,hideTimer:0};G.items.set(r,n);let a=Number(t.durationMs||0);return a>0&&(n.hideTimer=window.setTimeout(()=>{l.toast.hide(r)},a)),r},update(e,t,r={}){let s=G.items.get(String(e||""));if(!s)return;s.hideTimer&&(window.clearTimeout(s.hideTimer),s.hideTimer=0),pt(s.el,t,r.variant);let o=Number(r.durationMs||0);o>0&&(s.hideTimer=window.setTimeout(()=>{l.toast.hide(e)},o))},hide(e){let t=G.items.get(String(e||""));if(t){t.hideTimer&&(window.clearTimeout(t.hideTimer),t.hideTimer=0);try{t.el.remove()}catch{}G.items.delete(String(e||""))}}};var w={get(e,t=null){try{let r=localStorage.getItem(e);return r===null?t:JSON.parse(r)}catch{return t}},set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("Storage set error:",r)}},remove(e){try{localStorage.removeItem(e)}catch{}},getRaw(e){return localStorage.getItem(e)},setRaw(e,t){localStorage.setItem(e,t)}};l.storage=w;var kr={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};l.counts=kr;var U={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;let s=r.querySelector(".news-checkbox");if(s&&!s.checked&&(s.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(s):l.readState&&typeof l.readState.markAsRead=="function"&&l.readState.markAsRead(s)),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}t.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"?this.handleTitleClickV2(e,t):t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>U.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>U.handleTitleKeydownV2(e,t);window.openLink=e=>U.openLink(e);document.addEventListener("click",e=>{e.target.closest(".news-item")||U.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||U.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&U.closeAllPreviews(null)});l.link=U;var St={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let s=r.textContent.toLowerCase();!t||s.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>St.searchNews();l.search=St;var wt="trendradar_platform_grid_scroll_v1",Rr={getPlatformGridScrollState(){return w.get(wt,{})},setPlatformGridScrollState(e){w.set(wt,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,s=null,o=0,n=null,a=t.querySelectorAll(".platform-card");for(let c of a)if((c.offsetLeft||0)<=r+1)n=c;else break;n?.dataset?.platform&&(s=n.dataset.platform,o=Math.max(0,r-(n.offsetLeft||0)));let i=this.getPlatformGridScrollState();i[e]={left:r,anchorPlatformId:s,anchorOffsetX:o,updatedAt:Date.now()},this.setPlatformGridScrollState(i)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{e.dataset.trRestoring!=="1"&&(e.dataset.trUserScrolled="1"),!t&&(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),s=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(s,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],s=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,o=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,n=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,a=()=>{let i=document.querySelector(`#tab-${t} .platform-grid`);if(i&&i.dataset.trUserScrolled!=="1"){if(o){let c=null;if(i.querySelectorAll(".platform-card").forEach(d=>{!c&&d.dataset.platform===o&&(c=d)}),c&&c.offsetParent!==null){i.dataset.trRestoring="1",i.scrollLeft=(c.offsetLeft||0)+n,requestAnimationFrame(()=>{try{delete i.dataset.trRestoring}catch{}});return}}i.dataset.trRestoring="1",i.scrollLeft=s,requestAnimationFrame(()=>{try{delete i.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{a(),setTimeout(a,50),setTimeout(a,200),setTimeout(a,600)})})}};l.scroll=Rr;var bt="trendradar_feature_badge_v1:",vt="trendradar_new_badges_dismissed_v1",Ne={getFeatureBadgeState(e){return w.get(bt+e,null)},setFeatureBadgeState(e,t){w.set(bt+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let s=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=s},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=w.get(vt,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){w.set(vt,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>Ne.dismissNewPlatformBadge(e);l.badges=Ne;v(function(){Ne.applyDismissedNewBadges()});var H=20,Pr=20,Ct=10,Or=8,Mr=80,Fr=160,le={PAGE_SIZE:H,getCardPageSize(e){let t=e?.dataset?.pageSize,r=parseInt(t||"",10);return Number.isFinite(r)&&r>0?r:H},setCardPageSize(e,t){if(!e)return;let r=Math.max(H,parseInt(String(t||""),10)||H);e.dataset.pageSize=String(r)},applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),s=r.length,o=this.getCardPageSize(e);if(s<=o){r.forEach(i=>i.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let n=Math.max(0,Math.min(t,s-1)),a=Math.min(n+o,s);r.forEach((i,c)=>{c>=n&&c<a?i.classList.remove("paged-hidden"):i.classList.add("paged-hidden")}),e.dataset.pageOffset=String(n)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{this.setCardPageSize(e,H),this.applyPagingToCard(e,0)}),l.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let s=t.querySelectorAll(".news-item").length;if(s<=H)return;let o=parseInt(t.dataset.pageOffset||"0",10),n=o+H>=s?0:o+H;this.applyPagingToCard(t,n),l.counts.updateAllCounts()},getVisibleNewsItems(e){return e?Array.from(e.querySelectorAll(".news-item")).filter(t=>!t.classList.contains("filtered")&&!t.classList.contains("search-hidden")&&!t.classList.contains("paged-hidden")&&!t.classList.contains("read")):[]},shouldAutofillCard(e,t){if(!e||e.classList.contains("platform-empty-hidden"))return!1;let r=this.getVisibleNewsItems(e),s=Number.isFinite(t)?t:Ct;if(r.length<s)return!0;let o=r[r.length-1];if(!o)return!0;let n=e.getBoundingClientRect(),a=o.getBoundingClientRect();return!Number.isFinite(n.bottom)||!Number.isFinite(a.bottom)?!1:n.bottom-a.bottom>=Mr},autofillCard(e,t={}){if(!e)return!1;let r=Number.isFinite(t.minVisible)?t.minVisible:Ct,s=Number.isFinite(t.maxSteps)?t.maxSteps:Or,o=t.force===!0,n=e.querySelectorAll(".news-item").length;if(n<=0)return!1;let a=parseInt(e.dataset.pageOffset||"0",10)||0,i=this.getCardPageSize(e),c=!1;for(let d=0;d<s&&!(!o&&!this.shouldAutofillCard(e,r)||a+i>=n);d++)i=Math.min(n-a,i+Pr),this.setCardPageSize(e,i),this.applyPagingToCard(e,a),c=!0;return c&&l.counts.updateAllCounts(),c},autofillForCategory(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r)return!1;let s=!1;return r.querySelectorAll(".platform-card").forEach(o=>{this.autofillCard(o,t)&&(s=!0)}),s},autofillActiveTab(e={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,e):!1},scheduleAutofillActiveTab(e={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(e)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=Fr&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=e=>le.refreshPlatform(e);l.paging=le;v(function(){le.initPaging(),le.attachAutofillScrollListener(),le.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var _t="trendradar_read_news_v2",At="trendradar_read_news",Et="trendradar_show_read_mode",Br=24,M={getReadNews(){return w.get(_t,{})},saveReadNews(e){w.set(_t,e)},getShowReadModePref(){let e=w.getRaw(Et);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){w.getRaw(At)&&(w.remove(At),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,s=0;for(let[o,n]of Object.entries(t))if((e-n.readAt)/36e5>=Br){let i=document.querySelector(`[data-news-id="${o}"]`);if(i){i.classList.remove("read");let c=i.querySelector(".news-checkbox");c&&(c.checked=!1)}delete t[o],r=!0,s++}return r&&this.saveReadNews(t),s},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,s=t.dataset.newsTitle||"",o=this.getReadNews();e.checked?(t.classList.add("read"),o[r]||(o[r]={title:s.substring(0,50),readAt:Date.now()},this.saveReadNews(o))):(t.classList.remove("read"),delete o[r],this.saveReadNews(o)),l.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let s=r.querySelector(".news-checkbox");s&&(s.checked=!0)}}),l.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),w.setRaw(Et,e?"1":"0"),l.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),l.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>M.markAsRead(e);window.toggleShowRead=()=>M.toggleShowRead();window.clearAllRead=()=>M.clearAllRead();l.readState=M;v(function(){M.applyShowReadMode(M.getShowReadModePref()),M.migrateOldFormat();let e=M.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),M.restoreReadState(),M.updateReadCount()});var _e="trendradar_categories_config",qe=1,C=null,L=null,K=null,Ae=!1,ee=!1,z=!0,$r=null,ce="",W=!1;function je(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function Tt(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),je(t),t}var E={CATEGORY_CONFIG_KEY:_e,ensureCategoryFilters:je,normalizeCategoryConfig:Tt,getCategoryConfig(){try{let e=w.getRaw(_e);if(!e)return null;let t=JSON.parse(e);return t.version!==qe?null:Tt(t)}catch{return null}},saveCategoryConfig(e){e.version=qe,w.setRaw(_e,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return C||(C={},L={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",s=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;C[t]={id:t,name:s,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(e=>{let t=e.dataset.platform,r=e.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||t,o=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";L[t]={id:t,name:r,defaultCategory:o},C[o]&&(C[o].platforms||(C[o].platforms=[]),C[o].platforms.push(t))})),{version:qe,customCategories:[],hiddenDefaultCategories:[],categoryOrder:Object.keys(C),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}};return Object.keys(C).forEach(s=>{r.categoryOrder.includes(s)||r.categoryOrder.push(s)}),r.customCategories.forEach(s=>{r.categoryOrder.includes(s.id)||r.categoryOrder.push(s.id)}),r},getDefaultCategories(){return C},getAllPlatforms(){return L},setDefaultCategories(e){C=e},setAllPlatforms(e){L=e},async openCategorySettings(){let e=document.getElementById("categorySettingsNewBadge");if(e&&(e.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!C||Object.keys(C).length===0)try{let s=await(await fetch("/api/news")).json();s?.categories&&(C={},L={},Object.entries(s.categories).forEach(([o,n])=>{C[o]={id:o,name:n.name,icon:n.icon,isDefault:!0,platforms:Object.keys(n.platforms||{})},Object.entries(n.platforms||{}).forEach(([a,i])=>{L[a]={id:a,name:i.name,defaultCategory:o,data:i}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),z=!0,$r=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(z?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=z?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){z=!z,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),W&&(W=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){W=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(o=>{let n=t.customCategories.find(d=>d.id===o),a=t.hiddenDefaultCategories.includes(o),i;if(n)i=n;else if(C[o])i=C[o];else return;let c=n?i.platforms?.length||0:C[o]?.platforms?.length||0;r+=`
                <div class="category-item ${n?"custom":""}" data-category-id="${o}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${i.name}</span>
                    <span class="category-item-platforms">${c} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${a?"":"checked"} onchange="toggleCategoryVisibility('${o}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${o}')">\u7F16\u8F91</button>
                        ${n?`<button class="category-item-btn delete" onclick="deleteCategory('${o}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let s=document.getElementById("allCategoriesOffToggle");if(s){let o=t.hiddenDefaultCategories||[],n=t.categoryOrder||[];s.checked=n.length>0&&n.every(a=>o.includes(a))}ee?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){ee=!ee,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",s=>{r.classList.add("dragging"),s.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",s=>{s.preventDefault();let o=e.querySelector(".dragging");if(o&&o!==r){let n=r.getBoundingClientRect(),a=n.top+n.height/2;s.clientY<a?e.insertBefore(o,r):e.insertBefore(o,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(o=>o.dataset.categoryId),s=this.getCategoryConfig()||this.getDefaultCategoryConfig();s.categoryOrder=r,this.saveCategoryConfig(s),W=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),W=!0,this.renderCategoryList()},showAddCategoryPanel(){Ae=!0,K=null,z=!0,this.applyCategoryListCollapseState(),ee=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSearchInput");e&&(e.value=""),ce="",this.renderPlatformSelectList([]),l.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){Ae=!1,K=e;let t=this.getMergedCategoryConfig(),r=t.customCategories.find(i=>i.id===e),s,o;r?(s=r,o=s.platforms||[]):(s=C[e],o=t.platformOrder[e]||s.platforms||[]),document.getElementById("editCategoryName").value=s.name,this.renderPlatformSelectList(o,r);let n=l.filter.getCategoryFilterConfig(e);l.filter.setCategoryFilterEditorState(n.mode,n.keywords),ee=!0,z=!0,this.applyCategoryListCollapseState();let a=document.getElementById("platformSearchInput");a&&(a.value=""),ce="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),K=null,Ae=!1,ee=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),ce=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),s=Object.keys(L),o=[];e.forEach(c=>{L[c]&&o.push(c)}),s.forEach(c=>{o.includes(c)||o.push(c)});let n=(ce||"").trim().toLowerCase(),a=n?o.filter(c=>(L[c]?.name||"").toLowerCase().includes(n)):o,i=n.length>0;r.innerHTML=a.map(c=>{let d=L[c],f=e.includes(c);return`
                <label class="platform-select-item ${f?"selected":""} ${i?"no-drag":""}" data-platform-id="${c}" draggable="${i?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${f?"checked":""} onchange="togglePlatformSelect('${c}')">
                    <span>${d.name}</span>
                </label>
            `}).join(""),i||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){ce=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(s=>{let o=s.querySelector('input[type="checkbox"]');e==="all"?(s.classList.add("selected"),o&&(o.checked=!0)):(e==="none"||e==="clear")&&(s.classList.remove("selected"),o&&(o.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList");e.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",s=>{r.classList.add("dragging"),s.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",s=>{s.preventDefault();let o=e.querySelector(".dragging");if(o&&o!==r){let n=r.getBoundingClientRect(),a=n.top+n.height/2;s.clientY<a?e.insertBefore(o,r):e.insertBefore(o,r.nextSibling)}})})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();je(s);let o=l.filter.getEditingFilterState();if(Ae){let n="custom-"+Date.now();s.customCategories.push({id:n,name:e,icon:t,platforms:r,isCustom:!0}),s.categoryOrder.unshift(n),s.categoryFilters[n]={mode:o.mode,keywords:[...o.keywords]}}else if(K){let n=s.customCategories.findIndex(a=>a.id===K);n>=0?s.customCategories[n]={...s.customCategories[n],name:e,icon:t,platforms:r}:s.platformOrder[K]=r,s.categoryFilters[K]={mode:o.mode,keywords:[...o.keywords]}}return this.saveCategoryConfig(s),W=!0,this.hideEditPanel(),this.renderCategoryList(),z=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),W=!0,this.renderCategoryList()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(w.remove(_e),C=null,L=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){l.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();C?Object.entries(e).forEach(([c,d])=>{if(!C[c])C[c]={id:c,name:d.name,icon:d.icon,isDefault:!0,platforms:Object.keys(d.platforms||{})};else{C[c].platforms||(C[c].platforms=[]);let f=new Set(C[c].platforms||[]);Object.keys(d.platforms||{}).forEach(u=>{f.has(u)||C[c].platforms.push(u)})}Object.entries(d.platforms||{}).forEach(([f,u])=>{L[f]||(L[f]={id:f,name:u.name,defaultCategory:c,data:u})})}):(C={},L={},Object.entries(e).forEach(([c,d])=>{C[c]={id:c,name:d.name,icon:d.icon,isDefault:!0,platforms:Object.keys(d.platforms||{})},Object.entries(d.platforms||{}).forEach(([f,u])=>{L[f]={id:f,name:u.name,defaultCategory:c,data:u}})}));let r={};Object.values(e).forEach(c=>{Object.entries(c.platforms||{}).forEach(([d,f])=>{r[d]=f})});let s={},o=t.hiddenDefaultCategories||[],n=t.categoryOrder||Object.keys(e),a=t.customCategories||[],i=t.platformOrder||{};return n.forEach(c=>{if(o.includes(c))return;let d=a.find(f=>f.id===c);if(d){let f={};(d.platforms||[]).forEach(u=>{r[u]&&(f[u]=r[u])}),s[c]={name:d.name,icon:"\u{1F4F1}",platforms:f}}else if(e[c]){let f=e[c],u=i[c];if(u&&u.length>0){let m=[],g=new Set;u.forEach(b=>{f.platforms&&f.platforms[b]&&(m.push(b),g.add(b))});let p=[],h=[];Object.keys(f.platforms||{}).forEach(b=>{g.has(b)||(String(b||"").startsWith("rss-")?p.push(b):h.push(b))});let y=p.concat(m,h),_={};y.forEach(b=>{f.platforms&&f.platforms[b]&&(_[b]=f.platforms[b])}),s[c]={...f,platforms:_}}else s[c]=f}}),Object.keys(e).forEach(c=>{!s[c]&&!o.includes(c)&&(s[c]=e[c])}),s}};window.openCategorySettings=()=>E.openCategorySettings();window.closeCategorySettings=()=>E.closeCategorySettings();window.saveCategorySettings=()=>E.saveCategorySettings();window.cancelCategorySettings=()=>E.cancelCategorySettings();window.showAddCategoryPanel=()=>E.showAddCategoryPanel();window.editCategory=e=>E.editCategory(e);window.cancelEditCategory=()=>E.cancelEditCategory();window.saveCategory=()=>E.saveCategory();window.deleteCategory=e=>E.deleteCategory(e);window.resetCategoryConfig=()=>E.resetCategoryConfig();window.toggleCategoryVisibility=e=>E.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>E.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>E.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>E.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>E.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>E.setPlatformSearchQuery(e);l.settings=E;v(function(){let e=E.getCategoryConfig();e&&E.syncConfigToCookie(e)});var Lt="trendradar_filter_keywords",xt="trendradar_filter_mode_v1",X=[],Ee="exclude";function Te(e){return e==="include"?"include":"exclude"}var Y={normalizeFilterMode:Te,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=l.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],s=Te(r&&r.mode),o=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:s,keywords:o.map(n=>String(n||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),s=r.mode,o=r.keywords,n=`${s}|${o.join(",")}`,i=(t.dataset?t.dataset.filterSig:null)!==n;t.dataset&&(t.dataset.filterSig=n);let c=t.dataset&&t.dataset.bulkLoading==="1";if(t.querySelectorAll(".news-item").forEach(d=>{let f=(d.textContent||"").toLowerCase(),u=o.length>0?o.some(g=>f.includes(g)):!1;(o.length===0?!1:s==="include"?!u:u)?d.classList.add("filtered"):d.classList.remove("filtered")}),s!=="include"&&t.querySelectorAll(".platform-card").forEach(d=>{d.classList.remove("platform-empty-hidden")}),s==="include"){if(o.length>0)try{if(i&&!c){if(t.querySelectorAll(".platform-card").forEach(d=>{d?.dataset&&(d.dataset.loadedDone="0")}),l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function")l.infiniteScroll.scheduleBulkLoadCategory(e,{pageSize:40});else if(l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let d=t.querySelectorAll(".platform-card").length;l.infiniteScroll.scheduleEnsureCategoryLoaded(e,{cap:d,maxPagesPerCard:2})}}}catch{}t.querySelectorAll(".platform-card").forEach(d=>{let f=d?.dataset?.loadedDone==="1",u=!f||d?.dataset?.loading==="1";if(o.length>0&&u){d.classList.add("platform-empty-hidden");return}d.classList.remove("platform-empty-hidden"),d.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&f&&d.classList.add("platform-empty-hidden")})}try{let d=t.querySelector(".category-empty-state");if(d)if(s==="include"&&o.length>0){let f=Array.from(t.querySelectorAll(".platform-card")),u=f.length>0&&f.every(g=>g?.dataset?.loadedDone==="1"&&g?.dataset?.loading!=="1"),m=t.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;d.style.display=u&&m===0?"block":"none"}else d.style.display="none"}catch{}l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){Ee=Te(e),X=(Array.isArray(t)?t:[]).map(o=>String(o||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=Ee==="include");let s=document.getElementById("categoryFilterInput");s&&(s.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){Ee=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(X.includes(t)||(X.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){X=X.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=X.map(t=>`<span class="filter-tag">${S(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${S(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:Ee,keywords:[...X]}},migrateLegacyGlobalFilter(){let e=w.getRaw(Lt),t=w.getRaw(xt);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(i=>String(i||"").trim().toLowerCase()).filter(Boolean);let s=Te(t),o=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig();l.settings.ensureCategoryFilters(o),(l.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(i=>{o.categoryFilters[i]||(o.categoryFilters[i]={mode:s,keywords:[...r]})}),l.settings.saveCategoryConfig(o),w.remove(Lt),w.remove(xt)}};window.handleCategoryFilterModeToggle=e=>Y.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>Y.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>Y.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>Y.removeCategoryFilterKeyword(e);l.filter=Y;v(function(){Y.migrateLegacyGlobalFilter(),Y.applyCategoryFilterForActiveTab()});var de="trendradar_active_tab",te={TAB_STORAGE_KEY:de,switchTab(e){l.badges.dismissNewCategoryBadge(e);let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),s=document.getElementById(`tab-${e}`);if(!r||!s){let o=document.querySelector(".category-tab");o?.dataset?.category&&o.dataset.category!==String(e)?this.switchTab(o.dataset.category):w.remove(de);return}document.querySelectorAll(".category-tab").forEach(o=>o.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(o=>o.classList.remove("active")),s.classList.add("active"),w.setRaw(de,e),l.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(l.badges.markFeatureSeen("sports-nba-schedule"),l.badges.updateNewBadges()),l.filter.applyCategoryFilter(e),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let o=!!s.querySelector(".news-item"),n=!!s.querySelector(".news-placeholder");!o&&n&&(l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function"?l.infiniteScroll.scheduleBulkLoadCategory(e):l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&l.infiniteScroll.scheduleEnsureCategoryLoaded(e))}catch{}},restoreActiveTab(){let e=w.getRaw(de);e&&document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)},getActiveTabId(){return w.getRaw(de)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){l.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){l.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>te.switchTab(e);l.tabs=te;v(function(){te.restoreActiveTab(),te.attachPlatformGridScrollPersistence();let e=te.getActiveTabId();e&&te.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var Ge="trendradar_active_tab",kt=20,He=!1,Rt=0,re=null,Le={formatUpdatedAt:ie,snapshotViewerState(){let e=w.getRaw(Ge)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(a=>{let i=a.dataset.platform;i&&(t[i]=parseInt(a.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,s=r&&r.scrollLeft||0,o=null,n=0;if(r){let a=r.scrollLeft||0,i=null,c=r.querySelectorAll(".platform-card");for(let d of c)if((d.offsetLeft||0)<=a+1)i=d;else break;i?.dataset?.platform&&(o=i.dataset.platform,n=Math.max(0,a-(i.offsetLeft||0)))}return e&&r&&l.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:s,activeTabPlatformAnchorPlatformId:o,activeTabPlatformAnchorOffsetX:n,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),s=document.querySelector(".category-tabs");if(!s||!r)return;let o=l.settings.applyCategoryConfigToData(e?.categories||{}),n=t&&typeof t.activeTab=="string"?t.activeTab:null,a=Object.keys(o||{})[0]||null,i=n||a,c=Object.entries(o).map(([h,y])=>{let _=S(y?.icon||""),b=S(y?.name||h),$=`${y?.is_new?`<span class="new-badge new-badge-category" data-category="${S(h)}">NEW</span>`:""}${h==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab" data-category="${S(h)}" draggable="false" onclick="switchTab('${S(h)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${_}</div>
                <div class="category-tab-name">${b}${$}</div>
            </div>`}).join(""),d=Object.entries(o).map(([h,y])=>{let _=!!i&&String(h)===String(i),b=y?.platforms||{},T=Object.entries(b).map(([A,$])=>{let j=S($?.name||A),Z=$?.is_new?`<span class="new-badge new-badge-platform" data-platform="${S(A)}">NEW</span>`:"",lt=Array.isArray($?.news)?$.news:[],ct=lt.length,dt=_?Math.min(ct,kt):0,ut=A&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[A])?t.pagingOffsets[A]:0,pr=lt.slice(0,dt).map((D,Ie)=>{let hr=S(D?.stable_id||""),ft=S(D?.display_title||D?.title||""),yr=S(D?.url||""),gt=S(D?.meta||""),Sr=String(A||"").startsWith("rss-"),mt=!!D?.is_cross_platform,wr=Array.isArray(D?.cross_platforms)?D.cross_platforms:[],br=S(wr.join(", ")),vr=S(D?.cross_platform_count??""),Cr=mt?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${br}">\u{1F525} ${vr}</span>`:"",_r=mt?"cross-platform":"",Ar=`<span class="news-index">${String(Ie+1)}</span>`,Er=Ie<ut||Ie>=ut+kt?" paged-hidden":"",Tr=gt&&!Sr?`<div class="news-subtitle">${gt}</div>`:"";return`
                        <li class="news-item${Er}" data-news-id="${hr}" data-news-title="${ft}">
                            <div class="news-item-content">
                                <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="\u6807\u8BB0\u5DF2\u8BFB">
                                ${Ar}
                                <a class="news-title ${_r}" href="${yr||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${ft}
                                    ${Cr}
                                </a>
                            </div>
                            ${Tr}
                        </li>`}).join("")||(_?"":'<li class="news-placeholder" aria-hidden="true">\u5F85\u52A0\u8F7D...</li>');return`
                <div class="platform-card" data-platform="${S(A)}" data-total-count="${String(ct)}" data-loaded-count="${String(dt)}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${S(A)}')">\u{1F4F1} ${j}${Z}</div>
                        <div class="platform-header-actions"></div>
                    </div>
                    <ul class="news-list">${pr}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).join("");return`
            <div class="tab-pane" id="tab-${S(h)}">
                <div class="platform-grid">${T}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");s.innerHTML=c,r.innerHTML=d;try{let h=s.querySelectorAll(".category-tab").length;s.classList.toggle("compact",h>8)}catch{}let f=document.getElementById("updatedAt");f&&e?.updated_at&&(f.textContent=ie(e.updated_at));let u=t&&typeof t.activeTab=="string"?t.activeTab:null;if(u){let h=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(u):u;if(document.querySelector(`.category-tab[data-category="${h}"]`))l.tabs.switchTab(u);else{let _=document.querySelector(".category-tab");_?.dataset?.category?l.tabs.switchTab(_.dataset.category):w.remove(Ge)}}else{let h=document.querySelector(".category-tab");h?.dataset?.category?l.tabs.switchTab(h.dataset.category):w.remove(Ge)}let m=typeof t?.showReadMode=="boolean"?t.showReadMode:l.readState.getShowReadModePref();l.readState.applyShowReadMode(m);let g=document.getElementById("searchInput");g&&typeof t?.searchText=="string"&&(g.value=t.searchText),l.search.searchNews(),l.filter.applyCategoryFilterForActiveTab(),l.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(h=>{let y=h.dataset.platform,_=y&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[y])?t.pagingOffsets[y]:0;l.paging.setCardPageSize(h,l.paging.PAGE_SIZE),l.paging.applyPagingToCard(h,_)}),l.counts.updateAllCounts(),l.readState.updateReadCount(),l.scroll.restoreActiveTabPlatformGridScroll(t),l.scroll.attachPlatformGridScrollPersistence();let p=document.getElementById("early-hide");p&&p.remove(),document.body.classList.add("categories-ready"),l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{l.infiniteScroll&&typeof l.infiniteScroll.attach=="function"&&l.infiniteScroll.attach()}catch{}},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(He){re?re.preserveScroll=re.preserveScroll&&t:re={preserveScroll:t};return}He=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let n=await(await fetch("/api/news")).json();try{let a=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[];if(Array.isArray(a)&&a.length>0){let c=a.slice(0,25),d=c.map(h=>String(h?.source_id||h?.rss_source_id||"").trim()).filter(Boolean);if(d.length>0)try{fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:d,priority:"normal"})}).catch(()=>{})}catch{}let f=!!(l.subscription&&l.subscription._serverEnabled===!0),g=await fetch(f?"/api/subscriptions/rss-news?mode=server":"/api/subscriptions/rss-news?mode=auto",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f?{}:{subscriptions:c})}),p=await g.json();if(g.ok&&p&&typeof p=="object"){let h=n&&typeof n=="object"&&n.categories?n.categories:{},y=p&&typeof p=="object"&&p.categories?p.categories:{};n={...n,categories:{...h,...y}}}}}catch(a){console.error("rss merge error:",a)}this.renderViewerFromData(n,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),l.scroll.restoreActiveTabPlatformGridScroll(r)),Rt=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{He=!1;let r=re;re=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),s=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),s.className="fetch-status",s.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let n=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),n.success?(r.style.width="100%",s.className="fetch-status success",s.textContent=`\u2705 ${n.platforms} \u4E2A\u5E73\u53F0\uFF0C${n.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",s.className="fetch-status error",s.textContent=`\u274C ${n.error}`)}catch(o){r.classList.remove("indeterminate"),r.style.width="0%",s.className="fetch-status error",s.textContent=`\u274C ${o.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-Rt<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};window.fetchData=()=>Le.fetchData();window.refreshViewerData=e=>Le.refreshViewerData(e);l.data=Le;v(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=ie(e.textContent)),Le.setupAjaxAutoRefresh()});var xe=20,Dr="240px 0px 240px 0px",P=40,ue=null,ze=!1,fe=0,Ir=1,Pt=0,Nr=600,ke=null,ge=null,qr=160,Re=null,me=null,jr=250;function Gr(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}function Ve(e,t){try{let r=e?.querySelector?.(".news-list");if(!r)return;let s=r.querySelector(".news-placeholder");s||(s=document.createElement("li"),s.className="news-placeholder",s.setAttribute("aria-hidden","true"),r.appendChild(s)),s.textContent=String(t||"")}catch{}}function Ot(){if(clearTimeout(ke),ke=null,ge){try{ge.abort()}catch{}ge=null}try{document.querySelectorAll(".platform-card").forEach(e=>{let t=e?.querySelector?.(".news-list");if(!t)return;let r=t.querySelector(".news-placeholder");!r||t.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function Hr(e,t={}){Ot(),ge=new AbortController;let r=ge.signal;ke=setTimeout(()=>{ke=null,Bt(e,{...t,signal:r}).catch(()=>{})},qr)}function Mt(){if(clearTimeout(Re),Re=null,me){try{me.abort()}catch{}me=null}}function zr(e,t,r){let s=document.createElement("li");s.className="news-item",s.dataset.newsId=String(e?.stable_id||""),s.dataset.newsTitle=String(e?.display_title||e?.title||"");let o=document.createElement("div");o.className="news-item-content";let n=document.createElement("input");n.type="checkbox",n.className="news-checkbox",n.title="\u6807\u8BB0\u5DF2\u8BFB",n.addEventListener("change",()=>{try{window.markAsRead(n)}catch{}});let a=document.createElement("span");a.className="news-index",a.textContent=String(t);let i=document.createElement("a");if(i.className="news-title",e?.is_cross_platform&&i.classList.add("cross-platform"),i.href=String(e?.url||"#"),i.target="_blank",i.rel="noopener noreferrer",i.setAttribute("onclick","handleTitleClickV2(this, event)"),i.setAttribute("onauxclick","handleTitleClickV2(this, event)"),i.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),i.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),i.textContent=String(e?.display_title||e?.title||""),e?.is_cross_platform){let f=Array.isArray(e?.cross_platforms)?e.cross_platforms:[],u=document.createElement("span");u.className="cross-platform-badge",u.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${f.join(", ")}`,u.textContent=`\u{1F525} ${String(e?.cross_platform_count??"")}`,i.appendChild(document.createTextNode(" ")),i.appendChild(u)}o.appendChild(n),o.appendChild(a),o.appendChild(i),s.appendChild(o);let c=String(e?.meta||"").trim(),d=String(r||"").startsWith("rss-");if(c&&!d){let f=document.createElement("div");f.className="news-subtitle",f.textContent=c,s.appendChild(f)}return Dt(s),$t(s),s}async function Ft(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let s=t.signal;if(s?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let o=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(o=l.filter.getCategoryFilterConfig(e))}catch{o=null}let n=o?.mode||"exclude",a=Array.isArray(o?.keywords)?o.keywords:[],i=Number.isFinite(t.pageSize)?t.pageSize:P,c=Math.min(Math.max(1,i),P),d=Array.from(r.querySelectorAll(".platform-card")),f=d.map(g=>(g?.dataset?.platform||"").trim()).filter(Boolean);if(f.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let g of d)g&&(g.dataset.loading="1",Ve(g,"\u52A0\u8F7D\u4E2D..."));let u;try{let g=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(c))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:f}),signal:s});if(!g.ok)return;u=await g.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let m=u&&u.platforms||{};for(let g of d){if(s?.aborted)return;let p=(g?.dataset?.platform||"").trim();if(!p)continue;let h=g.querySelector(".news-list");if(!h)continue;h.querySelectorAll(".news-placeholder").forEach(T=>T.remove()),h.querySelectorAll(".news-item").forEach(T=>T.remove());let y=m[p]||{},_=Array.isArray(y.items)?y.items:[];for(let T=0;T<_.length;T++)h.appendChild(zr(_[T],T+1,p));let b=h.querySelectorAll(".news-item").length;g.dataset.loadedCount=String(b),g.dataset.hasMore=y.has_more&&b<P?"1":"0",g.dataset.loading="0",g.dataset.loadedDone="1";try{if(l.paging){let T=Math.min(P,b);l.paging.setCardPageSize(g,T),l.paging.applyPagingToCard(g,0)}}catch{}l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(g)}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(e)}catch{}}function Vr(e,t={}){Mt(),me=new AbortController;let r=me.signal;Re=setTimeout(()=>{Re=null,Ft(e,{...t,signal:r}).catch(()=>{})},jr)}async function Bt(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;let s=t.signal;if(s?.aborted)return;let o=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(o=l.filter.getCategoryFilterConfig(e))}catch{o=null}let n=o?.mode||"exclude",a=Array.isArray(o?.keywords)?o.keywords:[],i=n==="include"&&a.length>0,c=Number.isFinite(t.maxPagesPerCard)?t.maxPagesPerCard:i?2:1,d=Number.isFinite(t.cap)?t.cap:i?10:4,f=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,d));for(let u of f){if(s?.aborted)return;if(!u)continue;let m=u.querySelector(".news-list");if(!m)continue;let g=m.querySelectorAll(".news-item").length;if(i&&g>0){u.dataset.loadedDone="1";continue}if(!i&&g>0){u.dataset.loadedDone="1";continue}let p=xe;for(let h=0;h<c;h++){if(s?.aborted)return;Ve(u,"\u52A0\u8F7D\u4E2D..."),await It(u,Math.min(p,P),{signal:s});try{l.paging&&(l.paging.setCardPageSize(u,Math.min(p,P)),l.paging.applyPagingToCard(u,0))}catch{}let y=u.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!i||y>0||!(u.dataset.hasMore!=="0"))break;p+=xe}u.dataset.loadedDone="1"}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(e)}catch{}}function $t(e){try{let t=Gr();if(!t||!l.filter?.getCategoryFilterConfig)return;let r=l.filter.getCategoryFilterConfig(t),s=r?.mode||"exclude",o=Array.isArray(r?.keywords)?r.keywords:[],n=(e?.textContent||"").toLowerCase(),a=o.length>0?o.some(c=>n.includes(c)):!1;(o.length===0?!1:s==="include"?!a:a)?e.classList.add("filtered"):e.classList.remove("filtered")}catch{}}function Dt(e){try{let t=e?.dataset?.newsId;if(!t||!l.readState?.getReadNews||!(l.readState.getReadNews()||{})[t])return;e.classList.add("read");let s=e.querySelector(".news-checkbox");s&&(s.checked=!0)}catch{}}async function It(e,t,r={}){let s=(e?.dataset?.platform||"").trim();if(!s)return{ok:!1,hasMore:!1};let o=r.signal;if(o?.aborted)return{ok:!1,hasMore:!0};if(e.dataset.loading==="1")return{ok:!1,hasMore:!0};if(e.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let n=e.querySelector(".news-list");if(!n)return{ok:!1,hasMore:!1};n.querySelectorAll(".news-placeholder").forEach(i=>i.remove()),t=Math.min(Math.max(0,t||0),P);let a=n.querySelectorAll(".news-item").length;if(a>=P)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};if(a>=t)return{ok:!0,hasMore:!0};e.dataset.loading="1";try{if(fe>=Ir)return{ok:!1,hasMore:!0};fe+=1;let i=Math.min(xe,Math.max(0,P-a));if(i<=0)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};let c=`/api/news/page?platform_id=${encodeURIComponent(s)}&offset=${encodeURIComponent(String(a))}&page_size=${encodeURIComponent(String(i))}`,d;try{d=await fetch(c,{signal:o})}catch(g){if(o?.aborted||g&&g.name==="AbortError")return e.querySelectorAll(".news-item").length<=0&&Ve(e,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw g}if(!d.ok)return{ok:!1,hasMore:!0};let f=await d.json(),u=Array.isArray(f?.items)?f.items:[],m=!!f?.has_more;(!m||a+u.length>=P)&&(e.dataset.hasMore="0");for(let g=0;g<u.length;g++){let p=u[g]||{},h=a+g+1,y=document.createElement("li");y.className="news-item",y.dataset.newsId=String(p.stable_id||""),y.dataset.newsTitle=String(p.display_title||p.title||"");let _=document.createElement("div");_.className="news-item-content";let b=document.createElement("input");b.type="checkbox",b.className="news-checkbox",b.title="\u6807\u8BB0\u5DF2\u8BFB",b.addEventListener("change",()=>{try{window.markAsRead(b)}catch{}});let T=document.createElement("span");T.className="news-index",T.textContent=String(h);let A=document.createElement("a");if(A.className="news-title",p.is_cross_platform&&A.classList.add("cross-platform"),A.href=String(p.url||"#"),A.target="_blank",A.rel="noopener noreferrer",A.setAttribute("onclick","handleTitleClickV2(this, event)"),A.setAttribute("onauxclick","handleTitleClickV2(this, event)"),A.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),A.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),A.textContent=String(p.display_title||p.title||""),p.is_cross_platform){let j=Array.isArray(p.cross_platforms)?p.cross_platforms:[],Z=document.createElement("span");Z.className="cross-platform-badge",Z.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${j.join(", ")}`,Z.textContent=`\u{1F525} ${String(p.cross_platform_count??"")}`,A.appendChild(document.createTextNode(" ")),A.appendChild(Z)}_.appendChild(b),_.appendChild(T),_.appendChild(A),y.appendChild(_);let $=String(p.meta||"").trim();if($){let j=document.createElement("div");j.className="news-subtitle",j.textContent=$,y.appendChild(j)}n.appendChild(y),Dt(y),$t(y)}return e.dataset.loadedCount=String(n.querySelectorAll(".news-item").length),l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(e),{ok:!0,hasMore:m}}finally{fe=Math.max(0,fe-1),e.dataset.loading="0"}}async function Ur(e){if(!e||!l.paging)return;let t=e.closest(".tab-pane");if(t&&!t.classList.contains("active"))return;let r=Date.now();if(r<Pt)return;Pt=r+Nr;let s=parseInt(e.dataset.pageOffset||"0",10)||0,o=l.paging.getCardPageSize(e),n=Math.max(0,P-s);if(o>=n){e.dataset.hasMore="0";return}let a=Math.min(o+xe,n),i=s+a;await It(e,i);let c=e.querySelectorAll(".news-item").length,d=Math.min(Math.max(o,a),Math.max(c-s,o)),f=Math.min(d,n);l.paging.setCardPageSize(e,f),l.paging.applyPagingToCard(e,s),l.counts?.updateAllCounts&&l.counts.updateAllCounts()}function Nt(){if(ue){try{ue.disconnect()}catch{}ue=null}ue=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting||!ze||fe>0)continue;let s=t.target?.closest?.(".platform-card");s&&Ur(s).catch(()=>{})}},{root:null,rootMargin:Dr,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(e=>ue.observe(e))}l.infiniteScroll={attach:Nt,ensureCategoryLoaded:Bt,scheduleEnsureCategoryLoaded:Hr,cancelEnsureCategoryLoaded:Ot,bulkLoadCategory:Ft,scheduleBulkLoadCategory:Vr,cancelBulkLoadCategory:Mt};v(function(){try{window.addEventListener("scroll",()=>{ze=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{ze=!0},1200),Nt()});function Ue(e){let r=e?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function Kr(e,t){if(!e||!Array.isArray(t))return;let r=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig(),s=l.settings.normalizeCategoryConfig(r);if((l.settings.getMergedCategoryConfig().customCategories||[]).find(a=>a.id===e)){let a=(s.customCategories||[]).findIndex(i=>i.id===e);a>=0&&(s.customCategories[a]={...s.customCategories[a],platforms:t})}else(!s.platformOrder||typeof s.platformOrder!="object")&&(s.platformOrder={}),s.platformOrder[e]=t;l.settings.saveCategoryConfig(s)}var qt={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,attach(){if(this._attached)return;this._attached=!0;let e=40,t=18,r=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},s=()=>{if(this._autoScrollRaf)return;let n=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){r();return}let a=this._autoScrollGrid,i=Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0));if(i<=0){r();return}let c=Math.max(0,Math.min(i,(a.scrollLeft||0)+this._autoScrollDir*this._autoScrollSpeed));a.scrollLeft=c,this._autoScrollRaf=requestAnimationFrame(n)};this._autoScrollRaf=requestAnimationFrame(n)},o=(n,a)=>{if(!this._draggingCard||!a){r();return}if(Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0))<=0){r();return}let c=a.getBoundingClientRect(),d=n.clientX,f=d-c.left,u=c.right-d,m=0,g=0;if(f>=0&&f<=e)m=-1,g=f;else if(u>=0&&u<=e)m=1,g=u;else{r();return}let p=Math.max(0,Math.min(1,(e-g)/e)),h=Math.max(1,Math.round(p*p*t));this._autoScrollGrid=a,this._autoScrollDir=m,this._autoScrollSpeed=h,s()};document.addEventListener("dragstart",n=>{let a=n.target?.closest?.(".platform-drag-handle");if(!a)return;let i=a.closest(".platform-card"),c=a.closest(".platform-grid"),d=Ue(c),f=i?.dataset?.platform||null;if(!(!i||!c||!d||!f)){this._draggingCard=i,this._draggingPlatformId=f,this._originGrid=c,this._originCategoryId=d,i.classList.add("dragging"),n.dataTransfer.effectAllowed="move";try{n.dataTransfer.setData("text/plain",f)}catch{}}},!0),document.addEventListener("dragend",n=>{let a=n.target?.closest?.(".platform-drag-handle");if(!a)return;let i=a.closest(".platform-card"),c=a.closest(".platform-grid"),d=Ue(c);if(!i||!c||!d){this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r();return}let f=Array.from(c.querySelectorAll(".platform-card")).map(u=>u.dataset.platform).filter(Boolean);Kr(d,f),i.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r()},!0),document.addEventListener("dragover",n=>{let a=n.target?.closest?.(".platform-grid");if(!a||!this._draggingCard||this._originGrid&&a!==this._originGrid)return;let i=Ue(a);if(!i||this._originCategoryId&&i!==this._originCategoryId)return;n.preventDefault(),o(n,a);let c=n.target?.closest?.(".platform-card");if(!c||c===this._draggingCard)return;let d=Array.from(a.querySelectorAll(".platform-card")),f=d.indexOf(this._draggingCard),u=d.indexOf(c);f<0||u<0||f===u||(f<u?a.insertBefore(this._draggingCard,c.nextSibling):a.insertBefore(this._draggingCard,c))},!0),document.addEventListener("drop",n=>{let a=n.target?.closest?.(".platform-grid");!a||!this._draggingCard||this._originGrid&&a!==this._originGrid||(n.preventDefault(),r())},!0)}};l.platformReorder=qt;v(()=>{qt.attach()});function Wr(e){return e?Array.from(e.querySelectorAll(".category-tab")).map(t=>String(t?.dataset?.category||"").trim()).filter(Boolean):[]}function Xr(e){if(!Array.isArray(e)||e.length===0)return;let t=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig(),r=l.settings.normalizeCategoryConfig(t),s=l.settings.getMergedCategoryConfig(),o=Array.isArray(s?.categoryOrder)&&s.categoryOrder.length>0?s.categoryOrder.slice():e.slice(),n=new Set(e),a=0,i=o.map(c=>{let d=String(c||"").trim();if(!d||!n.has(d))return d;let f=e[a];return a+=1,f});r.categoryOrder=i,l.settings.saveCategoryConfig(r)}function Yr(e){let t=document.querySelector(".tab-content-area");if(!t)return;let r=new Map;t.querySelectorAll(".tab-pane").forEach(o=>{let n=String(o?.id||"");n.startsWith("tab-")&&r.set(n.slice(4),o)});let s=document.createDocumentFragment();for(let o of e){let n=r.get(o);n&&s.appendChild(n)}for(let[o,n]of r.entries())e.includes(o)||s.appendChild(n);t.appendChild(s)}function jt(){let e=document.querySelector(".category-tabs");e&&e.querySelectorAll(".category-tab").forEach(t=>{try{t.setAttribute("draggable","false");let r=t.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",t.insertBefore(r,t.firstChild))}catch{}})}function Jr(){let e=document.querySelector(".category-tabs");if(e)try{new MutationObserver(()=>{jt()}).observe(e,{childList:!0,subtree:!0})}catch{}}function Qr(){let e=document.body;if(!e)return;let t=0,r=0,s=!1,o=()=>{t&&(window.clearTimeout(t),t=0),r&&(window.clearTimeout(r),r=0)},n=()=>{s=!1,e.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",i=>{!i.target?.closest?.(".category-tabs")||!i.target?.closest?.(".category-tab")||i.target?.closest?.(".category-drag-handle")||(o(),t=window.setTimeout(()=>{s=!0,e.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{n()},2500)},380))},!0);let a=()=>{o(),s&&n()};document.addEventListener("pointerup",a,!0),document.addEventListener("pointercancel",a,!0),document.addEventListener("scroll",a,!0)}var Gt={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,jt(),Jr(),Qr(),document.addEventListener("click",e=>{e.target?.closest?.(".category-drag-handle")&&(e.preventDefault(),e.stopPropagation())},!0),document.addEventListener("dragstart",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tab"),s=t.closest(".category-tabs"),o=r?.dataset?.category;if(!(!r||!s||!o)){this._draggingTab=r,this._originTabsEl=s,r.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",String(o))}catch{}}},!0),document.addEventListener("dragover",e=>{let t=e.target?.closest?.(".category-tabs");if(!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl)return;let r=e.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;e.preventDefault();let s=Array.from(t.querySelectorAll(".category-tab")),o=s.indexOf(this._draggingTab),n=s.indexOf(r);o<0||n<0||o===n||(o<n?t.insertBefore(this._draggingTab,r.nextSibling):t.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",e=>{let t=e.target?.closest?.(".category-tabs");!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl||e.preventDefault()},!0),document.addEventListener("dragend",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let s=Wr(r);Xr(s),Yr(s),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};l.categoryTabReorder=Gt;v(()=>{Gt.attach()});var Ke="rss_subscriptions",R=null,O=null,Q=!1,Se=!1,We=!1,$e=!1,we=!1,q=new Map,V=new Set,Wt=!1,Pe="",Oe="",Zr=80,pe=0,ye=0,Xe=!1,F=[],Ye=0,he=0,se=44,Ht=10,J=0,zt=0,Vt=new Map;function Ut(e){return new Promise(t=>window.setTimeout(t,Math.max(0,e||0)))}function es(e){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(e||""))}catch{}return String(e||"").replace(/"/g,'\\"')}function ts(e){let t=Array.isArray(e)?e:[];for(let r of t){let s=String(r||"").trim();if(!s)continue;let o=`rss-${s}`,n=`.platform-card[data-platform="${es(o)}"]`,a=document.querySelector(n);if(!a)continue;let i=a.querySelectorAll(".news-item");if(i&&i.length>0)return!0}return!1}function Kt(e,t){let r=Array.isArray(e)?e:[];for(let s of r){let o=String(s||"").trim();o&&(t?V.add(o):V.delete(o))}}function Je(){return document.getElementById("rssSubscriptionModal")}function Ze(){return document.getElementById("rssSourcePickerModal")}function Qe(e){return(Array.isArray(e)?e:[]).filter(r=>r&&typeof r=="object").map(r=>({source_id:String(r.source_id||r.rss_source_id||"").trim(),url:String(r.url||"").trim(),feed_title:String(r.feed_title||r.display_name||"").trim(),column:String(r.column||"RSS").trim()||"RSS",platform_id:String(r.platform_id||"").trim()})).filter(r=>!!r.source_id)}async function Xt({showHintOn403:e}={}){if(!We){We=!0;try{let t=await fetch("/api/me/rss-subscriptions");if(t.status===403){Q=!1,Se=!0;try{be()}catch{}e&&x("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5F53\u524D\u4F7F\u7528\u672C\u5730\u8BA2\u9605",{variant:"info"});return}let r=await t.json().catch(()=>({}));if(!t.ok){Se=!0,Q=!1;return}let s=Qe(r?.subscriptions);Se=!0,Q=!0;try{be()}catch{}try{k.setSubscriptions(s)}catch{}try{O=k.getSubscriptions()}catch{O=null}I(),N()}finally{We=!1}}}function rs(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function ss(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function Me(e){let r=(Array.isArray(e)?e:[]).filter(s=>s&&typeof s=="object").map(s=>({source_id:String(s.source_id||s.rss_source_id||"").trim(),url:String(s.url||"").trim(),feed_title:String(s.feed_title||"").trim(),column:String(s.column||"RSS").trim()||"RSS"})).filter(s=>!!s.source_id||!!s.url).sort((s,o)=>(s.source_id||"").localeCompare(o.source_id||""));return JSON.stringify(r)}function Yt(e,t){let r=Array.isArray(e)?e:[],s=Array.isArray(t)?t:[],o=new Set(r.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(Boolean)),n=[];for(let a of s){let i=String(a?.source_id||a?.rss_source_id||"").trim();i&&(o.has(i)||n.push(i))}return n}function os(e,t){if(e)try{t?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}catch{}}function ns(e,t){if(!e)return;let r=!!t;try{r?e.setAttribute("aria-disabled","true"):e.removeAttribute("aria-disabled")}catch{}try{r?(e.style.opacity="0.5",e.style.cursor="not-allowed"):(e.style.opacity="",e.style.cursor="")}catch{}}function N(){let e=ss(),t=rs(),r=er();try{e&&e.removeAttribute("disabled")}catch{}ns(e,!r);try{e&&(r?e.removeAttribute("title"):e.setAttribute("title","\u8BF7\u5148\u9009\u62E9 RSS \u6E90\u518D\u9884\u89C8"))}catch{}if(r){let d=q.get(String(r||"").trim());d&&d.ok===!0&&Number(d.entries_count||0)===0&&x("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let s=Array.isArray(O)?O:[],o=k.getSubscriptions(),n=Me(s)!==Me(o),i=Yt(s,o).every(d=>{let f=q.get(d);return!!f&&f.ok===!0&&Number(f.entries_count||0)>0});if(os(t,n&&i),!n){r&&(()=>{let d=q.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||x("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!i){r&&(()=>{let d=q.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||x("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}x("",{variant:"info"})}async function as(e){let t=Fe();t&&(t.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`),s=await r.json();if(!r.ok)throw new Error(s?.detail||"Preview failed");let o=s?.data||{},n=o?.feed?.title||"",a=Array.isArray(o?.entries)?o.entries:[],i=a.length,c=a.slice(0,5).map(d=>{let f=S(d?.title||""),u=S(d?.link||"");return u?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${u}" target="_blank" rel="noopener noreferrer">${f||u}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f}</div>`}).join("");if(!$e&&n&&(ne("rssFeedTitle",n),we=!0),q.set(String(e||"").trim(),{ok:!0,entries_count:i,ts:Date.now()}),i>0)try{let f=(R?String(R.url||"").trim():"")||String(s?.final_url||s?.url||"").trim(),u=oe("rssColumn")||"RSS",m=oe("rssFeedTitle")||String(R?.name||R?.host||"").trim(),g=k.getSubscriptions(),p=g.findIndex(y=>y.source_id&&y.source_id===String(e||"").trim()),h={source_id:String(e||"").trim(),url:f,feed_title:m,column:u,platform_id:""};p>=0?g[p]=h:g.unshift(h),k.setSubscriptions(g),I()}catch{}else x("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});N(),t&&(t.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${S(n||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${a.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${c}</div>
            </div>`)}function is(){return document.getElementById("rssSubscriptionList")}function Fe(){return document.getElementById("rssSubscriptionPreview")}function ls(){return document.getElementById("rssSubscriptionSaveStatus")}function x(e,t={}){let r=ls();if(!r)return;let s=String(t.variant||"").toLowerCase(),o=s==="error"?"#dc2626":s==="success"?"#16a34a":"#6b7280";r.style.color=o,r.textContent=e==null?"":String(e)}function Jt(){return document.getElementById("rssSelectedSourceId")}function cs(){return document.getElementById("rssSelectedSourceLabel")}function ds(){return document.getElementById("rssRequestSection")}function us(){return document.getElementById("rssSourceCategoryList")}function Qt(){return document.getElementById("rssSourceSearchInput")}function Zt(){return document.getElementById("rssSourceResults")}function fs(){return document.getElementById("rssSourcePickerStatus")}function oe(e){let t=document.getElementById(e);return t&&typeof t.value=="string"?t.value.trim():""}function ne(e,t){let r=document.getElementById(e);r&&(r.value=t==null?"":String(t))}function er(){let e=Jt();return e&&typeof e.value=="string"?e.value.trim():""}function gs(e){R=e&&typeof e=="object"?e:null;let t=Jt(),r=cs(),s=R?String(R.id||"").trim():"",o=R?String(R.name||R.host||s):"",n=R?String(R.url||"").trim():"";t&&(t.value=s),r&&(r.textContent=s?`${o}${n?` (${n})`:""}`:"\u672A\u9009\u62E9"),s&&!$e&&(!oe("rssFeedTitle")||we)&&(ne("rssFeedTitle",o),we=!0),s&&tr(s),N()}function tr(e){let t=String(e||"").trim();if(!t)return;let r=Date.now(),s=15e3,o=Vt.get(t)||0;r-o<s||(Vt.set(t,r),J&&(window.clearTimeout(J),J=0),J=window.setTimeout(async()=>{J=0;let n=Date.now()-(zt||0);if(n<400){J=window.setTimeout(()=>{J=0,tr(t)},400-n);return}zt=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[t],priority:"high"})})}catch{}},300))}function Be(e){let t=fs();t&&(t.textContent=e==null?"":String(e))}async function rr(){let e=await fetch("/api/rss-source-categories"),t=await e.json();if(!e.ok)throw new Error(t?.detail||"Failed to load categories");let r=Array.isArray(t?.categories)?t.categories:[],s=us();if(!s)return r;let o=r.map(n=>{let a=String(n?.id||""),i=String(n?.name||a||""),c=Number(n?.count||0),d=a===Pe;return`
          <button type="button" class="platform-select-action-btn" data-cat="${S(a)}" style="justify-content:flex-start;${d?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${S(i)} <span style="opacity:0.7;">(${c})</span>
          </button>`}).join("");return s.innerHTML=o,s.querySelectorAll("button[data-cat]").forEach(n=>{n.addEventListener("click",()=>{Pe=String(n.getAttribute("data-cat")||""),rr().catch(()=>{}),et({reset:!0})})}),r}async function sr(e={}){let t=e.reset===!0;if(!Xe){Xe=!0;try{t&&(F=[],pe=0,ye=0),Be("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;Oe&&r.set("q",Oe),Pe&&r.set("category",Pe),r.set("limit",String(Zr)),r.set("offset",String(pe));let s=await fetch(`/api/rss-sources/search?${r.toString()}`),o=await s.json();if(!s.ok)throw new Error(o?.detail||"Search failed");let n=Array.isArray(o?.sources)?o.sources:[];ye=Number(o?.total||0),t?F=n:F=F.concat(n),pe=Number(o?.next_offset??pe+n.length)||pe+n.length,or();let i=F.length<ye;Be(`\u5DF2\u52A0\u8F7D ${F.length}/${ye}${i?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{Xe=!1}}}function or(){Ye||(Ye=window.requestAnimationFrame(()=>{Ye=0,ms()}))}function ms(){let e=Zt();if(!e)return;let t=e.scrollTop||0,r=e.clientHeight||360,s=F.length,o=s*se,n=Math.max(0,Math.floor(t/se)-Ht),a=Math.min(s,Math.ceil((t+r)/se)+Ht),i=e.querySelector(":scope > .rss-src-inner");i||(e.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',i=e.querySelector(":scope > .rss-src-inner")),i.style.height=`${o}px`;let c=[];for(let f=n;f<a;f++){let u=F[f]||{},m=String(u.id||"").trim(),g=String(u.name||u.host||m),p=String(u.url||"");c.push(`<div class="rss-source-item" data-source-id="${S(m)}" style="position:absolute;left:0;right:0;top:${f*se}px;height:${se}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <span style="font-weight:700;font-size:0.9rem;color:#111827;">${S(g)}</span>
                <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${S(p)}</span>
              </div>
            </div>`)}i.innerHTML=c.join(""),i.querySelectorAll(".rss-source-item[data-source-id]").forEach(f=>{f.addEventListener("click",()=>{let u=String(f.getAttribute("data-source-id")||"").trim(),m=F.find(g=>g&&String(g.id||"").trim()===u)||null;gs(m),tt()})}),t+r>=o-se*6&&F.length<ye&&sr({reset:!1}).catch(f=>{Be(f?.message||String(f))})}function et(e={}){let t=e.reset!==!1;sr({reset:t}).catch(r=>{Be(r?.message||String(r))})}function ps(){let e=Ze();if(!e)return;Wt=!0,e.classList.add("show");let t=Qt();t&&(t.value=Oe,t.focus()),rr().catch(()=>{}),et({reset:!0})}function tt(){let e=Ze();e&&(Wt=!1,e.classList.remove("show"))}function I(){let e=is();if(!e)return;let t=k.getSubscriptions();if(!t.length){e.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=t.map((s,o)=>{let n=String(s?.source_id||s?.rss_source_id||"").trim(),a=S(s.url||""),i=S(s.feed_title||""),c=S(s.column||"RSS"),d=i?`${i}`:a,f=n&&V.has(n);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${d}</span>
                            ${f?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${a}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${c}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${o})">\u5220\u9664</button>
                </div>
            </div>`}).join("");e.innerHTML=r,N()}var k={getSubscriptionsRaw(){let e=w.get(Ke,[]);return Array.isArray(e)?e:[]},setSubscriptionsRaw(e){if(!Array.isArray(e)){w.set(Ke,[]);return}w.set(Ke,e)},getSubscriptions(){return this.getSubscriptionsRaw().filter(t=>t&&typeof t=="object").map(t=>({source_id:String(t.source_id||t.rss_source_id||"").trim(),url:String(t.url||"").trim(),feed_title:String(t.feed_title||"").trim(),column:String(t.column||"RSS").trim()||"RSS",platform_id:String(t.platform_id||"").trim()})).filter(t=>!!t.source_id||!!t.url)},setSubscriptions(e){this.setSubscriptionsRaw(e)},ensureSnapshot(){if(!Array.isArray(O))try{O=this.getSubscriptions()}catch{O=null}},stageFromCatalogPreview(e={}){let t=String(e?.source_id||e?.rss_source_id||"").trim();if(!t)return;let r=String(e?.url||"").trim(),s=String(e?.feed_title||e?.name||"").trim(),o=String(e?.column||"RSS").trim()||"RSS";this.ensureSnapshot();let n=this.getSubscriptions(),a=n.findIndex(d=>d?.source_id&&d.source_id===t),i={source_id:t,url:r,feed_title:s,column:o,platform_id:""};a>=0?n[a]=i:n.unshift(i),this.setSubscriptions(n);let c=Number(e?.entries_count??0)||0;q.set(t,{ok:!0,entries_count:c,ts:Date.now()});try{I()}catch{}N()},open(){let e=Je();if(!e)return;try{O=this.getSubscriptions()}catch{O=null}ne("rssFeedTitle",""),we=!1,$e=!1,q.clear(),V.clear(),I();let t=Fe();t&&(t.innerHTML=""),x(""),e.classList.add("show"),N(),Xt({showHintOn403:!1}).catch(()=>{})},close(){let e=Je();e&&e.classList.remove("show")},async previewCurrent(){let e=er();if(!e){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await as(e)}catch(t){q.set(String(e||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(t?.message||t)}),N();let r=Fe();r&&(r.innerHTML=`<div style="color:#dc2626;">${S(t?.message||String(t))}</div>`)}},removeAt(e){let t=this.getSubscriptions();if(!(e<0||e>=t.length)){try{let r=String(t[e]?.source_id||t[e]?.rss_source_id||"").trim();r&&V.delete(r)}catch{}t.splice(e,1),this.setSubscriptions(t),I()}},async saveAndRefresh(){try{let e=Array.isArray(O)?O:[],t=this.getSubscriptions(),r=Me(e)!==Me(t),o=Yt(e,t).every(m=>{let g=q.get(m);return!!g&&g.ok===!0&&Number(g.entries_count||0)>0});if(!r){x("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),N();return}if(!o){x("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),N();return}let n=t;try{let m=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:Qe(t)})});if(m.status===403){Se=!0,Q=!1;try{be()}catch{}x("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let g=await m.json().catch(()=>({}));if(!m.ok)throw new Error(g?.detail||"Save failed");n=Qe(g?.subscriptions),Se=!0,Q=!0;try{be()}catch{}this.setSubscriptions(n)}}catch(m){x(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(m?.message||m)}`,{variant:"info"})}let a=new Set(e.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(Boolean)),i=n.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(m=>!!m&&!a.has(m));if(i.length>0&&(Kt(i,!0),I()),i.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:i,priority:"high"})})}catch{}x("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.setAttribute("disabled","true")}catch{}let c=Date.now(),d=5e3,f=[0,300,700,1500,2500],u=!1;for(let m of f){let g=Date.now()-c,p=d-g;if(p<=0)break;if(m>0&&await Ut(Math.min(m,p)),await l.data.refreshViewerData({preserveScroll:!0}),i.length>0){let h=[];for(let y of i)V.has(y)&&ts([y])&&V.delete(y),V.has(y)&&h.push(y);if(h.length===0){u=!0,I();break}I()}if(i.length===0){u=!0;break}}u?x("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(i.length>0&&(Kt(i,!1),I()),x("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.removeAttribute("disabled")}catch{}await Ut(u?200:800),this.close()}catch(e){console.error("rss refresh error:",e);try{x(String(e?.message||e),{variant:"error"})}catch{}try{let t=document.querySelector("#rssSubscriptionModal .settings-btn-primary");t&&t.removeAttribute("disabled")}catch{}}}};async function hs(){let e=oe("rssRequestUrl"),t=oe("rssRequestTitle"),r=oe("rssRequestNote");if(!e){alert("\u8BF7\u8F93\u5165 URL");return}if(!t){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let s=Fe();s&&(s.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let o=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,title:t,note:r})}),n=await o.json();if(!o.ok)throw new Error(n?.detail||"Submit failed");s&&(s.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${S(n?.status||"pending")}</div>`),ne("rssRequestUrl",""),ne("rssRequestTitle",""),ne("rssRequestNote","")}catch(o){s&&(s.innerHTML=`<div style="color:#dc2626;">${S(o?.message||String(o))}</div>`)}}function ys(){let e=ds();if(!e)return;let t=e.style.display!=="none";e.style.display=t?"none":"block"}window.openRssSubscriptionModal=()=>{try{let e=document.getElementById("rssSubscriptionNewBadge");e&&(e.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}k.open()};window.closeRssSubscriptionModal=()=>k.close();window.previewRssSubscription=()=>k.previewCurrent();window.saveRssSubscriptions=()=>k.saveAndRefresh();window.removeRssSubscription=e=>k.removeAt(parseInt(e,10));window.submitRssSourceRequest=()=>hs();window.toggleRssRequestSection=()=>ys();window.openRssSourcePicker=()=>ps();window.closeRssSourcePicker=()=>tt();l.subscription=k;l.subscription._serverEnabled=Q;function be(){try{l.subscription._serverEnabled=!!Q}catch{}}v(function(){let e=Je();if(e){let o=document.getElementById("rssFeedTitle");o&&o.addEventListener("input",()=>{$e=String(o.value||"").trim()!=="",we=!1}),e.addEventListener("keydown",n=>{n.key==="Escape"&&k.close()})}let t=Ze();t&&t.addEventListener("keydown",o=>{o.key==="Escape"&&tt()});let r=Zt();r&&r.addEventListener("scroll",()=>{or()});let s=Qt();s&&s.addEventListener("input",()=>{Oe=String(s.value||"").trim(),he&&(window.clearTimeout(he),he=0),he=window.setTimeout(()=>{he=0,et({reset:!0})},250)}),be(),Xt({showHintOn403:!1}).catch(()=>{})});var nt="rss_catalog_preview_seen_v1",Ss=24*60*60*1e3,rt=4,ws=20,ar=!1,ot=0,ve=0,st=!1,ir=[];function bs(e){return new Promise(t=>window.setTimeout(t,Math.max(0,e||0)))}function De(){return document.getElementById("rssCatalogPreviewModal")}function vs(){return document.getElementById("rssCatalogPreviewGrid")}function Cs(){return document.getElementById("rssCatalogPreviewStatus")}function B(e,t={}){let r=Cs();if(!r)return;let s=String(t.variant||"").toLowerCase(),o=s==="error"?"#dc2626":s==="success"?"#16a34a":"#6b7280";r.style.color=o,r.textContent=e==null?"":String(e)}function _s(){let e=w.get(nt,null);if(!e||typeof e!="object")return{ts:0,ids:[]};let t=Number(e.ts||0)||0,r=Array.isArray(e.ids)?e.ids.map(s=>String(s||"").trim()).filter(Boolean):[];return!t||Date.now()-t>Ss?{ts:0,ids:[]}:{ts:t,ids:r}}function As(e){let t=Array.isArray(e)?e.map(r=>String(r||"").trim()).filter(Boolean):[];w.set(nt,{ts:Date.now(),ids:Array.from(new Set(t))})}function Es(){let e=_s();return new Set(e.ids)}function Ts(){w.remove(nt)}async function lr(e,t="normal"){let r=Array.isArray(e)?e.map(s=>String(s||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:t})})}catch{}}async function Ls(e,t){let r=new URLSearchParams;r.set("limit",String(e)),r.set("offset",String(t));let s=await fetch(`/api/rss-sources/search?${r.toString()}`),o=await s.json().catch(()=>({}));if(!s.ok)throw new Error(o?.detail||"Failed to load RSS sources");let n=Array.isArray(o?.sources)?o.sources:[],a=Number(o?.total||0)||0,i=Number(o?.next_offset??t+n.length)||t+n.length;return{items:n,total:a,nextOffset:i}}function xs(e){return String(e?.name||e?.host||e?.id||"").trim()||"RSS"}function ks(e){let t=e?.data||{},r=String(t?.feed?.title||"").trim(),o=(Array.isArray(t?.entries)?t.entries:[]).map(n=>{let a=String(n?.title||"").trim(),i=String(n?.link||"").trim();return{title:a||i,link:i}}).filter(n=>!!n.link);return{feedTitle:r,entries:o}}function nr(e){let t=vs();if(!t)return;let r=(e||[]).map(s=>{let o=String(s?.source_id||"").trim(),n=S(s?.platform_name||"RSS"),a=s?.error?`<div style="color:#dc2626;font-size:0.78rem;">${S(s.error)}</div>`:`<div style="color:#6b7280;font-size:0.78rem;">\u6761\u76EE\u6570\uFF1A${String(s.entries_count||0)}</div>`,i=s?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u5F85\u4FDD\u5B58",c=s?.already_added?"disabled":"",f=(Array.isArray(s?.entries)?s.entries:[]).slice(0,ws).map((u,m)=>{let g=S(u?.title||""),p=S(u?.link||"#");return`
                <li class="news-item" data-news-id="" data-news-title="${g}">
                    <div class="news-item-content">
                        <span class="news-index">${String(m+1)}</span>
                        <a class="news-title" href="${p}" target="_blank" rel="noopener noreferrer">${g}</a>
                    </div>
                </li>`}).join("");return`
            <div class="platform-card" data-rss-source-id="${S(o)}" style="margin:0;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; flex: 1; min-width: 0; white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">\u{1F4F1} ${n}</div>
                    <div class="platform-header-actions">
                        <button type="button" class="platform-select-action-btn" data-action="add" ${c}>${i}</button>
                    </div>
                </div>
                ${a}
                <ul class="news-list">${f}</ul>
            </div>`}).join("");t.innerHTML=r||'<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>',t.querySelectorAll('button[data-action="add"]').forEach(s=>{s.addEventListener("click",async()=>{let o=s.closest(".platform-card"),n=String(o?.getAttribute("data-rss-source-id")||"").trim();if(!n)return;let a=ir.find(i=>String(i.source_id||"").trim()===n);if(a&&!a.already_added){a.already_added=!0;try{s.setAttribute("disabled","true"),s.textContent="\u5DF2\u52A0\u5165"}catch{}try{l.subscription?.ensureSnapshot?.()}catch{}try{l.subscription?.stageFromCatalogPreview?.({source_id:a.source_id,url:a.url,feed_title:a.feed_title||a.platform_name,column:"RSS",entries_count:a.entries_count||0})}catch{}lr([a.source_id],"high").catch(()=>{}),B(`\u5DF2\u52A0\u5165\u5F85\u4FDD\u5B58\uFF1A${a.platform_name}`,{variant:"success"})}})})}function Rs(){let e=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[],t=new Set;for(let r of Array.isArray(e)?e:[]){let s=String(r?.source_id||r?.rss_source_id||"").trim();s&&t.add(s)}return t}async function at(){if(!st){st=!0;try{B("\u52A0\u8F7D\u4E2D...",{variant:"info"});let e=Es(),t=Rs(),r=[],s=ot,o=0;for(;r.length<rt&&o<80;){o+=1;let n=await Ls(50,s);ve=n.total,s=n.nextOffset;let a=[];for(let i of n.items){let c=String(i?.id||"").trim();c&&(e.has(c)||(e.add(c),a.push(i)))}if(a.length>0)try{lr(a.map(i=>i.id),"normal").catch(()=>{})}catch{}for(let i of a){if(r.length>=rt)break;let c=String(i?.id||"").trim(),d=String(i?.url||"").trim(),f=xs(i);B(`\u52A0\u8F7D\u9884\u89C8 ${r.length+1}/${rt}\uFF1A${f}`,{variant:"info"});let u=[],m="",g="";try{let h=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(c)}`),y=await h.json().catch(()=>({}));if(!h.ok)throw new Error(y?.detail||"Preview failed");let _=ks(y);m=_.feedTitle,u=_.entries}catch(h){g=String(h?.message||h)}if(g||!Array.isArray(u)||u.length<=0)continue;let p=m||f;r.push({source_id:c,url:d,feed_title:m||f,platform_name:p,entries:u,entries_count:u.length,error:"",already_added:t.has(c)}),nr(r),await bs(0)}if(n.items.length===0||s>=ve)break}if(ot=s,As(Array.from(e)),ir=r,nr(r),!r.length){B("\u5F53\u524D\u6CA1\u6709\u53EF\u9884\u89C8\u6E90\uFF08\u53EF\u70B9\u51FB\u201C\u91CD\u7F6E\u5DF2\u6D4F\u89C8\u201D\u4ECE\u5934\u5F00\u59CB\uFF09",{variant:"info"});return}B(`\u5DF2\u52A0\u8F7D ${r.length} \u4E2A\u6E90\uFF08\u5DF2\u6D4F\u89C8\uFF1A${e.size}${ve?` / ${ve}`:""}\uFF09`,{variant:"info"})}finally{st=!1}}}function cr(){let e=De();if(e){ar=!0,e.classList.add("show");try{l.subscription?.ensureSnapshot?.()}catch{}at().catch(t=>{B(String(t?.message||t),{variant:"error"})})}}function Ce(){let e=De();e&&(ar=!1,e.classList.remove("show"))}function Ps(e){let t=De();t&&e&&e.target===t&&Ce()}function dr(){at().catch(e=>{B(String(e?.message||e),{variant:"error"})})}function ur(){Ts(),ot=0,ve=0,B("\u5DF2\u91CD\u7F6E\u5DF2\u6D4F\u89C8\u5217\u8868\uFF0C\u5C06\u4ECE\u5934\u5F00\u59CB",{variant:"success"}),at().catch(e=>{B(String(e?.message||e),{variant:"error"})})}async function fr(){try{await(l.subscription?.saveAndRefresh?l.subscription.saveAndRefresh():window.saveRssSubscriptions?.())}catch(e){B(String(e?.message||e),{variant:"error"});return}Ce()}window.openRssCatalogPreviewModal=()=>cr();window.closeRssCatalogPreviewModal=()=>Ce();window.closeRssCatalogPreviewModalOnOverlay=e=>Ps(e);window.rssCatalogPreviewNextBatch=()=>dr();window.rssCatalogPreviewResetSeen=()=>ur();window.rssCatalogPreviewSaveAndRefresh=()=>fr();l.rssCatalogPreview={open:cr,close:Ce,nextBatch:dr,resetSeen:ur,saveAndRefresh:fr};v(function(){let e=De();e&&e.addEventListener("keydown",t=>{t.key==="Escape"&&Ce()})});function ae(e){let t=e;return t?t.nodeType===3?t.parentElement||null:t:null}function gr(e){if(!e)return!1;let t=e.scrollWidth||0,r=e.clientWidth||0;return t>r+1}function mr(e){return ae(e)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function it(e){let t=ae(e);return!t?.closest||t.closest(".platform-drag-handle")?!1:!!t.closest(".platform-header")||!!t.closest(".platform-name")}v(()=>{let t=null,r=!1,s=null,o=0,n=0,a=!1,i=0,c=()=>{t=null,r=!1,s=null,o=0,n=0,a=!1;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}},d=(u,m)=>{if(!it(u)||document.querySelector(".platform-card.dragging"))return!1;let g=mr(u);if(!g||!gr(g))return!1;s=g,o=m,n=g.scrollLeft||0,a=!1;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",u=>{if(u.button!==0)return;let m=ae(u.target);d(m,u.clientX)&&(t=u.pointerId)},{passive:!0}),document.addEventListener("mousedown",u=>{if(u.button!==0||t!==null)return;let m=ae(u.target);d(m,u.clientX)&&(r=!0)},{passive:!0}),document.addEventListener("pointermove",u=>{if(t===null||u.pointerId!==t||!s)return;if(document.querySelector(".platform-card.dragging")){c();return}let m=u.clientX-o;if(!a&&Math.abs(m)<6)return;a=!0;try{u.preventDefault()}catch{}let g=Math.max(0,(s.scrollWidth||0)-(s.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));s.scrollLeft=p},{passive:!1}),document.addEventListener("mousemove",u=>{if(!r||!s)return;if(document.querySelector(".platform-card.dragging")){c();return}let m=u.clientX-o;if(!a&&Math.abs(m)<6)return;a=!0;try{u.preventDefault()}catch{}let g=Math.max(0,(s.scrollWidth||0)-(s.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));s.scrollLeft=p},{passive:!1});let f=()=>{t!==null&&(a&&(i=Date.now()+600),c())};document.addEventListener("pointerup",f,{passive:!0}),document.addEventListener("pointercancel",f,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(a&&(i=Date.now()+600),c())},{passive:!0}),document.addEventListener("click",u=>{if(Date.now()>i)return;let g=ae(u.target);if(it(g)){try{u.preventDefault()}catch{}try{u.stopPropagation()}catch{}try{u.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",u=>{let m=typeof document.elementFromPoint=="function"?document.elementFromPoint(u.clientX,u.clientY):null,g=ae(m||u.target);if(!u.shiftKey||!it(g)||document.querySelector(".platform-card.dragging"))return;let p=mr(g);if(!p||!gr(p))return;let h=typeof u.deltaX=="number"&&u.deltaX!==0?u.deltaX:u.deltaY;if(!h)return;try{u.preventDefault()}catch{}let y=Math.max(0,(p.scrollWidth||0)-(p.clientWidth||0)),_=Math.max(0,Math.min(y,(p.scrollLeft||0)+h));p.scrollLeft=_},{passive:!1})});v(function(){if(localStorage.getItem("category_settings_badge_dismissed")==="true"){let r=document.getElementById("categorySettingsNewBadge");r&&(r.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let r=document.getElementById("rssSubscriptionNewBadge");r&&(r.style.display="none")}let e=l.settings.getCategoryConfig();e&&(e.customCategories&&e.customCategories.length>0||e.hiddenDefaultCategories&&e.hiddenDefaultCategories.length>0||e.categoryOrder&&e.categoryOrder.length>0||e.platformOrder&&typeof e.platformOrder=="object"&&Object.keys(e.platformOrder).length>0)?l.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
