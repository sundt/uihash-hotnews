<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotnews-ÁÉ≠ÁÇπÊñ∞Èóª</title>
    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?66fb2effb4714e3c3f0b0c0053b8dc83";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --cross-platform-color: #f97316;
        }

        html {
            scrollbar-gutter: stable;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 24px 0 56px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            overflow-y: scroll;
        }

        .main-container { max-width: 1400px; margin: 0 auto; padding: 0 15px; min-height: calc(100vh - 80px); display: flex; flex-direction: column; gap: 10px; }

        .header-card {
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: 0.2px;
            color: #111827;
            margin-bottom: 0;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-subtitle {
            display: inline-flex;
            align-items: center;
            height: 24px;
            line-height: 1;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .stats-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .online-chips {
            display: inline-flex;
            gap: 6px;
            margin-left: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
            line-height: 1;
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.24);
            color: rgba(255, 255, 255, 0.95);
        }

        .online-chip b {
            font-weight: 800;
            color: #ffffff;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }

        .stat-label { opacity: 0.9; }
        .stat-value { font-weight: 600; }

        /* Tab ÂØºËà™ */
        .category-tabs {
            background: white;
            border-radius: 10px;
            padding: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }

        .category-tab {
            flex: 1;
            min-width: 80px;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .category-tab:hover { background: #e5e7eb; }

        .category-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .category-tab-icon { font-size: 1rem; }
        .category-tab-name { font-size: 0.8rem; font-weight: 600; }
        .category-tab-count { font-size: 0.65rem; opacity: 0.8; }

        .tab-content-area {
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 520px;
            flex: 1;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .platform-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
            overflow-anchor: none;
            padding-bottom: 8px;
        }

        .platform-grid::-webkit-scrollbar { height: 6px; }
        .platform-grid::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .platform-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .platform-grid::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

        .platform-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            flex: 0 0 calc((100% - 30px) / 4);
            width: calc((100% - 30px) / 4);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        @media (max-width: 1024px) {
            .platform-card {
                flex: 0 0 calc((100% - 10px) / 2);
                width: calc((100% - 10px) / 2);
            }
        }

        @media (max-width: 640px) {
            .platform-card {
                flex: 0 0 100%;
                width: 100%;
            }
        }

        .platform-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        .platform-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .news-list { list-style: none; padding: 0; margin: 0; }

        .news-item {
            padding: 4px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.8rem;
            box-sizing: border-box;
            min-height: calc(1.4em + 8px);
        }

        .news-item:last-child { border-bottom: none; }

        .news-title {
            font-size: 0.85rem;
            color: #1f2937;
            line-height: 1.4;
            margin-bottom: 0;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            flex: 1;
            min-width: 0;
        }

        .news-title.nba-title {
            font-size: 0.78rem;
        }

        .news-subtitle {
            font-size: 0.72rem;
            line-height: 1.2;
            color: #6b7280;
            margin-top: 2px;
            margin-left: 24px;
            text-align: right;
        }

        .news-item.preview .news-meta,
        .news-item:hover .news-meta,
        .news-item:focus-within .news-meta {
            display: none;
        }

        .news-item.preview .news-title,
        .news-item:hover .news-title,
        .news-item:focus-within .news-title {
            white-space: normal;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .news-item.filtered { display: none !important; }
        .news-item.search-hidden { display: none !important; }
        .news-item.read { display: none !important; }
        .news-item.paged-hidden { display: none !important; }

        /* ÊòæÁ§∫Â∑≤ËØªÊ®°Âºè‰∏ãÁöÑÂ∑≤ËØªÊñ∞Èóª */
        body.show-read-mode .news-item.read {
            display: block !important;
            opacity: 0.5;
            background: #fef3c7;
        }
        body.show-read-mode .news-item.read:hover {
            opacity: 0.8;
        }

        /* Â∑≤ËØªÊåâÈíÆÊ†∑Âºè */
        .show-read-btn {
            padding: 4px 10px;
            background: #fef3c7;
            color: #92400e;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .show-read-btn.active {
            background: #fbbf24;
            color: white;
        }
        .clear-read-btn {
            padding: 4px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 6px;
        }
        .clear-read-btn:hover {
            background: #fca5a5;
        }

        .platform-refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 0;
            padding: 6px 10px;
            background: #eef2ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
        }

        .platform-refresh-btn:hover {
            background: #e0e7ff;
            border-color: #a5b4fc;
        }

        .platform-refresh-btn:active {
            transform: translateY(1px);
        }

        .news-checkbox {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            align-self: flex-start;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .news-index {
            width: 18px;
            flex-shrink: 0;
            text-align: right;
            color: #9ca3af;
            font-size: 0.75rem;
            line-height: 1.4;
            margin-top: 1px;
            margin-right: 6px;
        }

        .news-item-content {
            display: flex;
            align-items: flex-start;
        }

        .platform-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .news-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
            pointer-events: none;
            cursor: text;
        }

        .news-title {
            cursor: pointer;
        }

        /* Ë∑®Âπ≥Âè∞È´ò‰∫Æ */
        .news-title.cross-platform {
            color: var(--cross-platform-color);
            font-weight: 600;
            border-left: 3px solid var(--cross-platform-color);
            padding-left: 8px;
        }

        .news-title.cross-platform a {
            color: var(--cross-platform-color);
        }

        .news-title.cross-platform a:hover {
            color: #ea580c;
        }

        .cross-platform-badge {
            display: inline-flex;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 8px;
            cursor: help;
        }

        .news-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            line-height: 1.2;
            color: #6b7280;
            white-space: nowrap;
        }

        .rank-text {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #9ca3af;
            letter-spacing: 0.2px;
        }

        /* ËøáÊª§Èù¢Êùø */
        .filter-panel {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .filter-panel.show { display: block; }
        .filter-input-row { display: flex; gap: 6px; margin-bottom: 6px; }
        .filter-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .filter-add-btn {
            padding: 4px 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .filter-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 12px;
            font-size: 0.7rem;
        }
        .filter-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }
        .filter-tag-remove:hover { opacity: 1; }
        .filter-toggle-btn {
            padding: 4px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .new-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 1px 6px;
            border-radius: 9999px;
            font-size: 0.65rem;
            line-height: 1.2;
            font-weight: 800;
            letter-spacing: 0.3px;
            background: #f97316;
            color: #fff;
            vertical-align: middle;
        }
        .filter-count {
            font-size: 0.7rem;
            color: #dc2626;
            margin-left: 4px;
        }

        .filter-mode-toggle {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }
        .filter-mode-toggle input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 1px;
            height: 1px;
        }
        .filter-mode-pill {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            border-radius: 9999px;
            border: 1px solid #fecaca;
            background: #fee2e2;
            color: #b91c1c;
            font-size: 0.75rem;
            line-height: 1;
        }
        .filter-mode-toggle input:checked + .filter-mode-pill {
            border-color: #c7d2fe;
            background: #eef2ff;
            color: #3730a3;
        }
        .filter-mode-thumb {
            position: absolute;
            top: 2px;
            bottom: 2px;
            width: 30px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.8);
            transition: transform 0.15s ease;
            transform: translateX(0);
        }
        .filter-mode-toggle input:checked + .filter-mode-pill .filter-mode-thumb {
            transform: translateX(36px);
        }
        .filter-mode-off,
        .filter-mode-on {
            position: relative;
            z-index: 1;
            width: 30px;
            text-align: center;
            font-weight: 700;
        }

        /* Âπ≥Âè∞Á≠õÈÄâÊåâÈíÆÂíåÈù¢Êùø */
        .platform-filter-btn {
            padding: 4px 10px;
            background: #e0e7ff;
            color: #4338ca;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .platform-filter-panel {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        .platform-filter-panel.show { display: block; }
        .platform-filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .platform-filter-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .platform-filter-item:hover {
            border-color: #4338ca;
        }
        .platform-filter-item.hidden {
            background: #f3f4f6;
            color: #9ca3af;
            text-decoration: line-through;
        }
        .platform-filter-item input {
            margin: 0;
            cursor: pointer;
        }
        .platform-filter-actions {
            display: flex;
            gap: 6px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        .platform-filter-actions button {
            padding: 4px 10px;
            font-size: 0.7rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .platform-filter-actions button:hover {
            background: #f3f4f6;
        }

        /* ÈöêËóèÁöÑÂπ≥Âè∞Âç°Áâá */
        .platform-card.platform-hidden {
            display: none !important;
        }

        /* Ëé∑ÂèñÊï∞ÊçÆÊåâÈíÆ */
        .fetch-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .fetch-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .fetch-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .fetch-btn .spinner { display: none; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .fetch-btn.loading .spinner { display: inline-block; }
        .fetch-btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            display: none;
            margin-top: 10px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            height: 6px;
        }
        .progress-container.show { display: block; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        .progress-bar.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .fetch-status { font-size: 0.75rem; color: #6b7280; margin-top: 5px; }
        .fetch-status.success { color: #10b981; }
        .fetch-status.error { color: #ef4444; }

        @media (max-width: 768px) {
            .platform-card { width: 240px; }
            .stats-row { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-card">
            <div class="header-top">
                <a href="https://github.com/sundt/TrendRadar-Plus" target="_blank" class="header-title" style="text-decoration: none; color: inherit;"><svg height="24" width="24" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a>
                <span class="header-subtitle">Êô∫ËÉΩÂàÜÁ±ª ¬∑ Á≤æÂáÜËøáÊª§ ¬∑ È´òÊïàÈòÖËØª</span>
            </div>

            <div class="stats-row">
                <button class="fetch-btn" id="fetchBtn" onclick="fetchData()">
                    <span class="spinner"></span>
                    <span class="btn-text">üîÑ Âà∑Êñ∞</span>
                </button>
                <button class="platform-filter-btn" onclick="togglePlatformFilterPanel()">
                    &#128241; Âπ≥Âè∞Á≠õÈÄâ <span id="hiddenPlatformCount"></span>
                </button>
                <button class="filter-toggle-btn" onclick="toggleFilterPanel()">
                    &#128683; ËøáÊª§ËÆæÁΩÆ<span class="filter-count" id="filterCount"></span><span class="new-badge" id="newBadgeFilterSettings" style="display:none;">NEW</span>
                </button>
                <button class="show-read-btn" id="showReadBtn" onclick="toggleShowRead()">
                    üëÅ Â∑≤ËØª: <span id="readCount">0</span>
                </button>
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <span class="stat-label">Êõ¥Êñ∞</span>
                    <span class="stat-value" id="updatedAt">{{ data.updated_at }}</span>
                    <span class="online-chips" id="onlineChips" title="ÂÆûÊó∂Âú®Á∫øÔºöÊåâÊúÄËøëÊ¥ªË∑ÉÊó∂Èó¥ÁªüËÆ°">
                        <span class="online-chip">Âú®Á∫ø <b id="online5m">-</b></span>
                    </span>
                </div>
                <button class="filter-toggle-btn" type="button" onclick="window.open('https://p2fjebt29i.feishu.cn/share/base/form/shrcnL6g8L6M6yFJU9gTnE4pBqe', '_blank')">
                    üí° Âª∫ËÆÆ
                </button>
            </div>

            <!-- ËøáÊª§Èù¢Êùø -->
            <div class="filter-panel" id="filterPanel">
                <div class="filter-input-row">
                    <label class="filter-mode-toggle" title="ÂÖ≥ÈîÆËØçÊ®°ÂºèÔºöËøáÊª§=ÈöêËóèÂëΩ‰∏≠ÂÖ≥ÈîÆËØçÔºõÊòæÁ§∫=Âè™ÊòæÁ§∫ÂëΩ‰∏≠ÂÖ≥ÈîÆËØç">
                        <input type="checkbox" id="filterModeToggle" onchange="handleFilterModeToggle(this)">
                        <span class="filter-mode-pill">
                            <span class="filter-mode-thumb"></span>
                            <span class="filter-mode-off">ËøáÊª§</span>
                            <span class="filter-mode-on">ÊòæÁ§∫</span>
                        </span>
                    </label>
                    <input type="text" class="filter-input" id="filterInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÔºåÂõûËΩ¶Ê∑ªÂä†..." onkeypress="handleFilterKeypress(event)">
                    <button class="filter-add-btn" onclick="addFilterKeyword()">+ Ê∑ªÂä†</button>
                </div>
                <div class="filter-tags" id="filterTags"></div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                    <button class="clear-read-btn" onclick="clearAllRead()">üóë Ê∏ÖÈô§ÊâÄÊúâÂ∑≤ËØªËÆ∞ÂΩï</button>
                </div>
            </div>

            <!-- Âπ≥Âè∞Á≠õÈÄâÈù¢Êùø -->
            <div class="platform-filter-panel" id="platformFilterPanel">
                <div style="font-size: 0.8rem; color: #4338ca; margin-bottom: 8px; font-weight: 600;">üì± ÈÄâÊã©Ë¶ÅÊòæÁ§∫ÁöÑÂπ≥Âè∞</div>
                <div class="platform-filter-grid" id="platformFilterGrid"></div>
                <div class="platform-filter-actions">
                    <button onclick="selectAllPlatforms()">ÂÖ®ÈÄâ</button>
                    <button onclick="deselectAllPlatforms()">ÂÖ®‰∏çÈÄâ</button>
                    <button onclick="resetPlatformFilter()">ÈáçÁΩÆ</button>
                </div>
            </div>

            <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="üîç ÊêúÁ¥¢Êñ∞Èóª..." onkeyup="searchNews()" style="flex: 1; font-size: 0.8rem; padding: 4px 8px;">
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="fetch-status" id="fetchStatus"></div>
        </div>

        <!-- Tabs -->
        <div class="category-tabs">
            {% for cat_id, category in data.categories.items() %}
            <div class="category-tab {% if loop.first %}active{% endif %}" 
                 data-category="{{ cat_id }}"
                 onclick="switchTab('{{ cat_id }}')">
                <div class="category-tab-icon">{{ category.icon }}</div>
                <div class="category-tab-name">{{ category.name }}{% if category.is_new %}<span class="new-badge new-badge-category" data-category="{{ cat_id }}">NEW</span>{% endif %}{% if cat_id == 'sports' %}<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>{% endif %}</div>
            </div>
            {% endfor %}
        </div>

        <!-- Content -->
        <div class="tab-content-area">
            {% for cat_id, category in data.categories.items() %}
            <div class="tab-pane {% if loop.first %}active{% endif %}" id="tab-{{ cat_id }}">
                <div class="platform-grid">
                    {% for platform_id, platform in category.platforms.items() %}
                    <div class="platform-card" data-platform="{{ platform_id }}">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('{{ platform_id }}')">
                                üì± {{ platform.name }}
                                {% if platform.is_new %}<span class="new-badge new-badge-platform" data-platform="{{ platform_id }}">NEW</span>{% endif %}
                            </div>
                            <button class="platform-refresh-btn" type="button" onclick="refreshPlatform(this)" title="‰ªÖÂà∑Êñ∞Êú¨Âπ≥Âè∞ÔºåÊç¢Êñ∞Ôºà20Êù°Ôºâ">
                                <span>Êç¢Êñ∞</span>
                            </button>
                        </div>
                        <ul class="news-list">
                            {% for news in platform.news %}
                            <li class="news-item{% if loop.index > 20 %} paged-hidden{% endif %}" data-news-id="{{ news.stable_id }}" data-news-title="{{ news.display_title or news.title }}">
                                <div class="news-item-content">
                                    <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="Ê†áËÆ∞Â∑≤ËØª">
                                    <span class="news-index">{{ loop.index }}</span>
                                    <div class="news-title {% if platform_id == 'nba-schedule' %}nba-title {% endif %}{% if news.is_cross_platform %}cross-platform{% endif %}" onclick="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)" tabindex="0" role="button" data-url="{{ news.url or '' }}">
                                        {{ news.display_title or news.title }}
                                        {% if news.is_cross_platform %}
                                        <span class="cross-platform-badge" title="ÂêåÊó∂Âá∫Áé∞Âú®: {{ news.cross_platforms|join(', ') }}">
                                            üî• {{ news.cross_platform_count }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if news.meta %}<div class="news-subtitle">{{ news.meta }}</div>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // === Â∑≤ËØªÁä∂ÊÄÅÁÆ°ÁêÜÔºàÂü∫‰∫éÂÜÖÂÆπÂìàÂ∏å + Ëá™Âä®ËøáÊúüÔºâ ===
        const READ_STORAGE_KEY = 'trendradar_read_news_v2';  // Êñ∞ÁâàÊú¨ key
        const OLD_STORAGE_KEY = 'trendradar_read_news';      // ÊóßÁâàÊú¨ key
        const SHOW_READ_MODE_KEY = 'trendradar_show_read_mode';
        const EXPIRE_HOURS = 24;  // Â∑≤ËØªËÆ∞ÂΩïËøáÊúüÊó∂Èó¥ÔºàÂ∞èÊó∂Ôºâ
        
        function getReadNews() {
            const stored = localStorage.getItem(READ_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getShowReadModePref() {
            const raw = localStorage.getItem(SHOW_READ_MODE_KEY);
            if (raw === null) return true;
            return raw === '1';
        }

        function applyShowReadMode(enabled) {
            if (enabled) document.body.classList.add('show-read-mode');
            else document.body.classList.remove('show-read-mode');
            const btn = document.getElementById('showReadBtn');
            if (btn) {
                if (enabled) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        }
        
        function saveReadNews(reads) {
            localStorage.setItem(READ_STORAGE_KEY, JSON.stringify(reads));
        }
        
        // ËøÅÁßªÊóßÊ†ºÂºèÊï∞ÊçÆÔºàÊ∏ÖÁ©∫Ôºâ
        function migrateOldFormat() {
            if (localStorage.getItem(OLD_STORAGE_KEY)) {
                localStorage.removeItem(OLD_STORAGE_KEY);
                console.log('Â∑≤Ê∏ÖÈô§ÊóßÁâàÊú¨Â∑≤ËØªËÆ∞ÂΩï');
            }
        }
        
        // Ê∏ÖÁêÜËøáÊúüÁöÑÂ∑≤ËØªËÆ∞ÂΩï
        function cleanupExpiredReads() {
            const now = Date.now();
            const reads = getReadNews();
            let changed = false;
            let removedCount = 0;
            
            for (const [id, info] of Object.entries(reads)) {
                const ageHours = (now - info.readAt) / (1000 * 60 * 60);
                if (ageHours < EXPIRE_HOURS) {
                    // do nothing
                } else {
                    // ÂèñÊ∂àÂãæÈÄâÔºå‰ªéÂ∑≤ËØªÂàóË°®ÁßªÈô§
                    const item = document.querySelector(`[data-news-id="${id}"]`);
                    if (item) {
                        item.classList.remove('read');
                        const checkbox = item.querySelector('.news-checkbox');
                        if (checkbox) checkbox.checked = false;
                    }
                    delete reads[id];
                    changed = true;
                    removedCount++;
                }
            }
            
            if (changed) {
                saveReadNews(reads);
            }
            return removedCount;
        }
        
        function markAsRead(checkbox) {
            const item = checkbox.closest('.news-item');
            const newsId = item.dataset.newsId;
            const newsTitle = item.dataset.newsTitle || '';
            let reads = getReadNews();
            
            if (checkbox.checked) {
                item.classList.add('read');
                if (!reads[newsId]) {
                    reads[newsId] = {
                        title: newsTitle.substring(0, 50),
                        readAt: Date.now()
                    };
                    saveReadNews(reads);
                }
            } else {
                // ÂèñÊ∂àÂãæÈÄâÔºå‰ªéÂ∑≤ËØªÂàóË°®ÁßªÈô§
                item.classList.remove('read');
                delete reads[newsId];
                saveReadNews(reads);
            }
            // Êõ¥Êñ∞ËÆ°Êï∞
            updatePlatformCount(checkbox.closest('.platform-card'));
            updateReadCount();
        }
        
        function updateReadCount() {
            const reads = getReadNews();
            const countEl = document.getElementById('readCount');
            if (countEl) countEl.textContent = Object.keys(reads).length;
        }
        
        function updatePlatformCount(card) {
            const visibleItems = card.querySelectorAll('.news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)');
            const visibleEl = card.querySelector('.platform-visible-count');
            if (visibleEl) visibleEl.textContent = visibleItems.length;
        }
        
        function updateAllCounts() {
            document.querySelectorAll('.platform-card').forEach(card => {
                updatePlatformCount(card);
            });
            // Êõ¥Êñ∞ÊÄªÊï∞
            const totalVisible = document.querySelectorAll('.news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)').length;
            const totalEl = document.getElementById('totalNews');
            if (totalEl) totalEl.textContent = totalVisible;
        }
        
        function openLink(el) {
            const url = el.dataset.url;
            if (url) {
                window.open(url, '_blank');
            }
        }

        function isHoverDevice() {
            return (window.matchMedia && window.matchMedia('(hover: hover)').matches);
        }

        function closeAllPreviews(exceptItem) {
            document.querySelectorAll('.news-item.preview').forEach((it) => {
                if (exceptItem && it === exceptItem) return;
                it.classList.remove('preview');
            });
        }

        function handleTitleClickV2(el, evt) {
            evt.stopPropagation();
            const item = el.closest('.news-item');
            if (!item) return;

            if (isHoverDevice()) {
                openLink(el);
                return;
            }

            const isSame = item.classList.contains('preview');
            if (isSame) {
                openLink(el);
                item.classList.remove('preview');
                return;
            }

            closeAllPreviews(item);
            item.classList.add('preview');
        }

        function handleTitleKeydownV2(el, evt) {
            if (evt.key === 'Enter' || evt.key === ' ') {
                evt.preventDefault();
                handleTitleClickV2(el, evt);
            } else if (evt.key === 'Escape') {
                closeAllPreviews(null);
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.news-item')) return;
            closeAllPreviews(null);
        });
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.news-item')) return;
            closeAllPreviews(null);
        }, { passive: true });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAllPreviews(null);
        });
        
        function restoreReadState() {
            const reads = getReadNews();
            Object.keys(reads).forEach(id => {
                const item = document.querySelector(`[data-news-id="${id}"]`);
                if (item) {
                    item.classList.add('read');
                    const checkbox = item.querySelector('.news-checkbox');
                    if (checkbox) checkbox.checked = true;
                }
            });
            // ÊÅ¢Â§çÂêéÊõ¥Êñ∞ÊâÄÊúâËÆ°Êï∞
            updateAllCounts();
            updateReadCount();
        }

        function formatUpdatedAt(value) {
            const raw = (value == null) ? '' : String(value).trim();
            if (!raw) return raw;

            const m1 = raw.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);
            if (m1) return `${m1[2]}-${m1[3]} ${m1[4]}:${m1[5]}`;

            const m2 = raw.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
            if (m2) return raw;

            return raw;
        }
        
        function toggleShowRead() {
            const next = !document.body.classList.contains('show-read-mode');
            applyShowReadMode(next);
            localStorage.setItem(SHOW_READ_MODE_KEY, next ? '1' : '0');
            updateAllCounts();
        }
        
        function clearAllRead() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂ∑≤ËØªËÆ∞ÂΩïÂêóÔºüÊâÄÊúâÊñ∞ÈóªÂ∞ÜÊÅ¢Â§çÊòæÁ§∫„ÄÇ')) return;
            
            // Ê∏ÖÈô§ÊâÄÊúâÂ∑≤ËØªÁä∂ÊÄÅ
            document.querySelectorAll('.news-item.read').forEach(item => {
                item.classList.remove('read');
                const checkbox = item.querySelector('.news-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            
            // Ê∏ÖÁ©∫ localStorage
            saveReadNews({});
            
            // Êõ¥Êñ∞ËÆ°Êï∞
            updateAllCounts();
            updateReadCount();
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            applyShowReadMode(getShowReadModePref());
            // 1. ËøÅÁßªÊóßÊ†ºÂºèÊï∞ÊçÆ
            migrateOldFormat();
            // 2. Ê∏ÖÁêÜËøáÊúüËÆ∞ÂΩï
            const removed = cleanupExpiredReads();
            if (removed > 0) {
                console.log(`Â∑≤Ê∏ÖÁêÜ ${removed} Êù°ËøáÊúüÂ∑≤ËØªËÆ∞ÂΩï`);
            }
            // 3. ÊÅ¢Â§çÂ∑≤ËØªÁä∂ÊÄÅ
            restoreReadState();
            // 4. ÂàùÂßãÂåñÂ∑≤ËØªËÆ°Êï∞
            updateReadCount();

            // 5. ÂàùÂßãÂåñÂàÜÈ°µ
            initPaging();
        });

        const CATEGORY_PAGE_SIZE = 20;

        function applyPagingToCard(card, offset) {
            const items = Array.from(card.querySelectorAll('.news-item'));
            const total = items.length;
            if (total <= CATEGORY_PAGE_SIZE) {
                items.forEach((it) => it.classList.remove('paged-hidden'));
                card.dataset.pageOffset = '0';
                return;
            }

            const safeOffset = Math.max(0, Math.min(offset, total - 1));
            const end = Math.min(safeOffset + CATEGORY_PAGE_SIZE, total);

            items.forEach((it, idx) => {
                if (idx >= safeOffset && idx < end) it.classList.remove('paged-hidden');
                else it.classList.add('paged-hidden');
            });

            card.dataset.pageOffset = String(safeOffset);
        }

        function initPaging() {
            document.querySelectorAll('.platform-card').forEach((card) => {
                applyPagingToCard(card, 0);
            });
            updateAllCounts();
        }

        function refreshPlatform(btn) {
            const card = btn.closest('.platform-card');
            if (!card) return;
            const items = card.querySelectorAll('.news-item');
            const total = items.length;
            if (total <= CATEGORY_PAGE_SIZE) return;
            const current = parseInt(card.dataset.pageOffset || '0', 10);
            const next = (current + CATEGORY_PAGE_SIZE >= total) ? 0 : (current + CATEGORY_PAGE_SIZE);
            applyPagingToCard(card, next);
            updateAllCounts();
        }

        // === ËøáÊª§ÂäüËÉΩ ===
        const FILTER_STORAGE_KEY = 'trendradar_filter_keywords';
        
        function getFilterKeywords() {
            const stored = localStorage.getItem(FILTER_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveFilterKeywords(keywords) {
            localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(keywords));
        }
        
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            if (!panel) return;
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                markFeatureSeen('filter-mode-toggle');
                updateNewBadges();
            }
        }

        const FEATURE_BADGE_PREFIX = 'trendradar_feature_badge_v1:';

        function getFeatureBadgeState(featureId) {
            try {
                const raw = localStorage.getItem(FEATURE_BADGE_PREFIX + featureId);
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function setFeatureBadgeState(featureId, state) {
            try {
                localStorage.setItem(FEATURE_BADGE_PREFIX + featureId, JSON.stringify(state));
            } catch (e) {
                // ignore
            }
        }

        function ensureFeatureFirstSeen(featureId) {
            const st = getFeatureBadgeState(featureId);
            if (st && typeof st.firstSeenAt === 'number') return st;
            const next = { firstSeenAt: Date.now(), seenAt: null };
            setFeatureBadgeState(featureId, next);
            return next;
        }

        function markFeatureSeen(featureId) {
            const st = ensureFeatureFirstSeen(featureId);
            if (!st.seenAt) {
                st.seenAt = Date.now();
                setFeatureBadgeState(featureId, st);
            }
        }

        function shouldShowFeatureBadge(featureId, ttlDays) {
            const st = ensureFeatureFirstSeen(featureId);
            if (st.seenAt) return false;
            const ttlMs = (ttlDays || 7) * 24 * 60 * 60 * 1000;
            return (Date.now() - (st.firstSeenAt || 0)) <= ttlMs;
        }

        function updateNewBadges() {
            const el = document.getElementById('newBadgeFilterSettings');
            if (el) {
                el.style.display = shouldShowFeatureBadge('filter-mode-toggle', 7) ? '' : 'none';
            }

            const elSports = document.getElementById('newBadgeSportsTab');
            if (elSports) {
                elSports.style.display = shouldShowFeatureBadge('sports-nba-schedule', 7) ? '' : 'none';
            }
        }
        
        function handleFilterKeypress(event) {
            if (event.key === 'Enter') {
                addFilterKeyword();
            }
        }
        
        function addFilterKeyword() {
            const input = document.getElementById('filterInput');
            const keyword = input.value.trim().toLowerCase();
            if (!keyword) return;
            
            const keywords = getFilterKeywords();
            if (!keywords.includes(keyword)) {
                keywords.push(keyword);
                saveFilterKeywords(keywords);
                renderFilterTags();
                applyFilter();
            }
            input.value = '';
        }
        
        function removeFilterKeyword(keyword) {
            let keywords = getFilterKeywords();
            keywords = keywords.filter(k => k !== keyword);
            saveFilterKeywords(keywords);
            renderFilterTags();
            applyFilter();
            updateNewBadges();
        }

        const FILTER_MODE_KEY = 'trendradar_filter_mode_v1';

        function getFilterMode() {
            const v = localStorage.getItem(FILTER_MODE_KEY);
            return v === 'include' ? 'include' : 'exclude';
        }

        function setFilterMode(mode) {
            localStorage.setItem(FILTER_MODE_KEY, mode === 'include' ? 'include' : 'exclude');
        }

        function initFilterModeToggle() {
            const el = document.getElementById('filterModeToggle');
            if (!el) return;
            el.checked = getFilterMode() === 'include';
        }

        function handleFilterModeToggle(input) {
            setFilterMode(input && input.checked ? 'include' : 'exclude');
            applyFilter();
            updateAllCounts();
        }
        
        function renderFilterTags() {
            const keywords = getFilterKeywords();
            const tagsEl = document.getElementById('filterTags');
            tagsEl.innerHTML = keywords.map(k => 
                `<span class="filter-tag">${k}<span class="filter-remove" onclick="removeFilterKeyword('${k}')">√ó</span></span>`
            ).join('');
        }
        
        function applyFilter() {
            const keywords = getFilterKeywords();
            let filteredCount = 0;
            const mode = getFilterMode();
            
            document.querySelectorAll('.news-item').forEach(item => {
                const title = item.textContent.toLowerCase();
                const matched = keywords.length > 0 ? keywords.some(k => title.includes(k)) : false;
                const shouldFilter = keywords.length === 0 ? false : (mode === 'include' ? !matched : matched);
                
                if (shouldFilter) {
                    item.classList.add('filtered');
                    filteredCount++;
                } else {
                    item.classList.remove('filtered');
                }
            });
            
            const countEl = document.getElementById('filterCount');
            if (countEl) countEl.textContent = filteredCount > 0 ? `+${filteredCount}` : '';
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñËøáÊª§
        document.addEventListener('DOMContentLoaded', function() {
            initFilterModeToggle();
            updateNewBadges();
            renderFilterTags();
            applyFilter();
        });

        // === Âπ≥Âè∞Á≠õÈÄâÂäüËÉΩ ===
        const PLATFORM_FILTER_KEY = 'trendradar_hidden_platforms';
        
        function getHiddenPlatforms() {
            const stored = localStorage.getItem(PLATFORM_FILTER_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveHiddenPlatforms(platforms) {
            localStorage.setItem(PLATFORM_FILTER_KEY, JSON.stringify(platforms));
        }
        
        function togglePlatformFilterPanel() {
            const panel = document.getElementById('platformFilterPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                renderPlatformFilterGrid();
            }
        }
        
        function renderPlatformFilterGrid() {
            const container = document.getElementById('platformFilterGrid');
            const hiddenPlatforms = getHiddenPlatforms();
            const platforms = [];
            
            // Êî∂ÈõÜÊâÄÊúâÂπ≥Âè∞
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                const platformName = card.querySelector('.platform-name').textContent.trim().replace(/üì±\s*/, '').split(' ')[0];
                if (platformId && !platforms.find(p => p.id === platformId)) {
                    platforms.push({ id: platformId, name: platformName });
                }
            });
            
            container.innerHTML = platforms.map(p => {
                const isHidden = hiddenPlatforms.includes(p.id);
                return `
                    <label class="platform-filter-item ${isHidden ? 'hidden' : ''}">
                        <input type="checkbox" ${!isHidden ? 'checked' : ''} onchange="togglePlatformVisibility('${p.id}')">
                        ${p.name}
                    </label>
                `;
            }).join('');
            
            updateHiddenPlatformCount();
        }
        
        function togglePlatformVisibility(platformId) {
            let hidden = getHiddenPlatforms();
            if (hidden.includes(platformId)) {
                hidden = hidden.filter(p => p !== platformId);
            } else {
                hidden.push(platformId);
            }
            saveHiddenPlatforms(hidden);
            applyPlatformFilter();

            applyDismissedNewBadges();
            renderPlatformFilterGrid();
        }
        
        function selectAllPlatforms() {
            saveHiddenPlatforms([]);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function deselectAllPlatforms() {
            const allPlatforms = [];
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                if (platformId && !allPlatforms.includes(platformId)) {
                    allPlatforms.push(platformId);
                }
            });
            saveHiddenPlatforms(allPlatforms);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function resetPlatformFilter() {
            localStorage.removeItem(PLATFORM_FILTER_KEY);
            applyPlatformFilter();
            renderPlatformFilterGrid();
        }
        
        function applyPlatformFilter() {
            const hidden = getHiddenPlatforms();
            document.querySelectorAll('.platform-card').forEach(card => {
                const platformId = card.dataset.platform;
                if (hidden.includes(platformId)) {
                    card.classList.add('platform-hidden');
                } else {
                    card.classList.remove('platform-hidden');
                }
            });
            updateHiddenPlatformCount();
        }
        
        function updateHiddenPlatformCount() {
            const hidden = getHiddenPlatforms();
            const countEl = document.getElementById('hiddenPlatformCount');
            if (countEl) {
                countEl.textContent = hidden.length > 0 ? `(ÈöêËóè${hidden.length})` : '';
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÂπ≥Âè∞Á≠õÈÄâ
        document.addEventListener('DOMContentLoaded', function() {
            applyPlatformFilter();
            restoreActiveTab();
            attachPlatformGridScrollPersistence();
            const tabId = localStorage.getItem(TAB_STORAGE_KEY) || (document.querySelector('.category-tab.active')?.dataset?.category) || null;
            if (tabId) {
                restoreActiveTabPlatformGridScroll({ preserveScroll: true, activeTab: tabId });
            }
        });

        // === Âú®Á∫ø‰∫∫Êï∞ÔºàÂøÉË∑≥ + ÁªüËÆ°Ôºâ ===
        const ONLINE_SESSION_KEY = 'trendradar_online_session_id';

        function getOnlineSessionId() {
            let id = localStorage.getItem(ONLINE_SESSION_KEY);
            if (id) return id;
            if (window.crypto && crypto.randomUUID) {
                id = crypto.randomUUID();
            } else {
                id = 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
            }
            localStorage.setItem(ONLINE_SESSION_KEY, id);
            return id;
        }

        async function onlinePing() {
            try {
                await fetch('/api/online/ping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: getOnlineSessionId() })
                });
            } catch (e) {
                // ignore
            }
        }

        async function refreshOnlineStats() {
            try {
                const res = await fetch('/api/online');
                const data = await res.json();
                const el5 = document.getElementById('online5m');
                if (el5) el5.textContent = data.online_5m ?? '-';
            } catch (e) {
                // ignore
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            onlinePing();
            refreshOnlineStats();
            setInterval(onlinePing, 15000);
            setInterval(refreshOnlineStats, 10000);
        });

        // === Tab ÂàáÊç¢ ===
        const TAB_STORAGE_KEY = 'trendradar_active_tab';

        const NEW_BADGE_STORAGE_KEY = 'trendradar_new_badges_dismissed_v1';

        function getDismissedNewBadges() {
            try {
                const raw = localStorage.getItem(NEW_BADGE_STORAGE_KEY);
                const obj = raw ? JSON.parse(raw) : {};
                return {
                    categories: obj?.categories || {},
                    platforms: obj?.platforms || {},
                };
            } catch (e) {
                return { categories: {}, platforms: {} };
            }
        }

        function setDismissedNewBadges(next) {
            try {
                localStorage.setItem(NEW_BADGE_STORAGE_KEY, JSON.stringify(next || { categories: {}, platforms: {} }));
            } catch (e) {
                // ignore
            }
        }

        function applyDismissedNewBadges() {
            const dismissed = getDismissedNewBadges();
            document.querySelectorAll('.new-badge-category').forEach((el) => {
                const cid = el?.dataset?.category;
                if (cid && dismissed.categories?.[cid]) {
                    el.style.display = 'none';
                }
            });
            document.querySelectorAll('.new-badge-platform').forEach((el) => {
                const pid = el?.dataset?.platform;
                if (pid && dismissed.platforms?.[pid]) {
                    el.style.display = 'none';
                }
            });
        }

        function dismissNewCategoryBadge(categoryId) {
            if (!categoryId) return;
            const dismissed = getDismissedNewBadges();
            if (!dismissed.categories?.[categoryId]) {
                dismissed.categories[categoryId] = true;
                setDismissedNewBadges(dismissed);
            }
            document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(categoryId)}"]`).forEach((el) => {
                el.style.display = 'none';
            });
        }

        function dismissNewPlatformBadge(platformId) {
            if (!platformId) return;
            const dismissed = getDismissedNewBadges();
            if (!dismissed.platforms?.[platformId]) {
                dismissed.platforms[platformId] = true;
                setDismissedNewBadges(dismissed);
            }
            document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(platformId)}"]`).forEach((el) => {
                el.style.display = 'none';
            });
        }
        
        function switchTab(categoryId) {
            dismissNewCategoryBadge(categoryId);
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.category-tab[data-category="${categoryId}"]`).classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelector(`#tab-${categoryId}`).classList.add('active');
            // ‰øùÂ≠òÂΩìÂâçTabÁä∂ÊÄÅ
            localStorage.setItem(TAB_STORAGE_KEY, categoryId);

            restoreActiveTabPlatformGridScroll({ preserveScroll: true, activeTab: categoryId });

            if (categoryId === 'sports') {
                markFeatureSeen('sports-nba-schedule');
                updateNewBadges();
            }
        }
        
        function restoreActiveTab() {
            const savedTab = localStorage.getItem(TAB_STORAGE_KEY);
            if (savedTab) {
                const tabEl = document.querySelector(`.category-tab[data-category="${savedTab}"]`);
                if (tabEl) {
                    switchTab(savedTab);
                }
            }
        }

        // === ÊêúÁ¥¢ ===
        function searchNews() {
            const q = document.getElementById('searchInput').value.toLowerCase();

            document.querySelectorAll('.news-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                const matchSearch = !q || text.includes(q);
                if (matchSearch) {
                    item.classList.remove('search-hidden');
                } else {
                    item.classList.add('search-hidden');
                }
            });

            updateAllCounts();
        }

        // === Êï∞ÊçÆËé∑Âèñ ===
        async function fetchData() {
            const btn = document.getElementById('fetchBtn');
            const progress = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const status = document.getElementById('fetchStatus');

            btn.classList.add('loading');
            btn.disabled = true;
            progress.classList.add('show');
            bar.classList.add('indeterminate');
            status.className = 'fetch-status';
            status.textContent = 'Ê≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...';

            try {
                const response = await fetch('/api/fetch', { method: 'POST' });
                const result = await response.json();

                bar.classList.remove('indeterminate');
                
                if (result.success) {
                    bar.style.width = '100%';
                    status.className = 'fetch-status success';
                    status.textContent = `‚úÖ ${result.platforms} ‰∏™Âπ≥Âè∞Ôºå${result.news_count} Êù°Êñ∞Èóª`;
                    setTimeout(() => refreshViewerData({ preserveScroll: true }), 300);
                } else {
                    bar.style.width = '0%';
                    status.className = 'fetch-status error';
                    status.textContent = `‚ùå ${result.error}`;
                }
            } catch (error) {
                bar.classList.remove('indeterminate');
                bar.style.width = '0%';
                status.className = 'fetch-status error';
                status.textContent = `‚ùå ${error.message}`;
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                setTimeout(() => {
                    progress.classList.remove('show');
                    bar.style.width = '0%';
                }, 5000);
            }
        }

        let _ajaxRefreshInFlight = false;
        let _ajaxLastRefreshAt = 0;

        function escapeHtml(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        const PLATFORM_GRID_SCROLL_STORAGE_KEY = 'trendradar_platform_grid_scroll_v1';

        function getPlatformGridScrollState() {
            const raw = localStorage.getItem(PLATFORM_GRID_SCROLL_STORAGE_KEY);
            if (!raw) return {};
            try {
                const obj = JSON.parse(raw);
                return obj && typeof obj === 'object' ? obj : {};
            } catch (e) {
                return {};
            }
        }

        function setPlatformGridScrollState(state) {
            try {
                localStorage.setItem(PLATFORM_GRID_SCROLL_STORAGE_KEY, JSON.stringify(state || {}));
            } catch (e) {
                // ignore
            }
        }

        function recordPlatformGridScrollForTab(tabId, grid) {
            if (!tabId || !grid) return;

            const left = grid.scrollLeft || 0;
            let anchorPlatformId = null;
            let anchorOffsetX = 0;

            let anchor = null;
            const cards = grid.querySelectorAll('.platform-card');
            for (const card of cards) {
                if ((card.offsetLeft || 0) <= left + 1) {
                    anchor = card;
                } else {
                    break;
                }
            }
            if (anchor?.dataset?.platform) {
                anchorPlatformId = anchor.dataset.platform;
                anchorOffsetX = Math.max(0, left - (anchor.offsetLeft || 0));
            }

            const state = getPlatformGridScrollState();
            state[tabId] = {
                left,
                anchorPlatformId,
                anchorOffsetX,
                updatedAt: Date.now(),
            };
            setPlatformGridScrollState(state);
        }

        function attachPlatformGridScrollPersistence() {
            document.querySelectorAll('.tab-pane .platform-grid').forEach((grid) => {
                if (grid.dataset.scrollPersistBound === '1') return;
                grid.dataset.scrollPersistBound = '1';

                let ticking = false;
                grid.addEventListener('scroll', () => {
                    if (ticking) return;
                    ticking = true;
                    requestAnimationFrame(() => {
                        ticking = false;
                        const pane = grid.closest('.tab-pane');
                        const tabId = pane?.id?.startsWith('tab-') ? pane.id.slice(4) : null;
                        recordPlatformGridScrollForTab(tabId, grid);
                    });
                }, { passive: true });
            });
        }

        function snapshotViewerState() {
            const activeTab = localStorage.getItem(TAB_STORAGE_KEY) || (document.querySelector('.category-tab.active')?.dataset?.category) || null;
            const pagingOffsets = {};
            document.querySelectorAll('.platform-card').forEach((card) => {
                const pid = card.dataset.platform;
                if (!pid) return;
                pagingOffsets[pid] = parseInt(card.dataset.pageOffset || '0', 10) || 0;
            });
            const grid = activeTab ? document.querySelector(`#tab-${activeTab} .platform-grid`) : null;
            const activeTabPlatformGridScrollLeft = grid ? (grid.scrollLeft || 0) : 0;
            let activeTabPlatformAnchorPlatformId = null;
            let activeTabPlatformAnchorOffsetX = 0;
            if (grid) {
                const left = grid.scrollLeft || 0;
                let anchor = null;
                const cards = grid.querySelectorAll('.platform-card');
                for (const card of cards) {
                    if ((card.offsetLeft || 0) <= left + 1) {
                        anchor = card;
                    } else {
                        break;
                    }
                }
                if (anchor?.dataset?.platform) {
                    activeTabPlatformAnchorPlatformId = anchor.dataset.platform;
                    activeTabPlatformAnchorOffsetX = Math.max(0, left - (anchor.offsetLeft || 0));
                }
            }
            if (activeTab && grid) {
                recordPlatformGridScrollForTab(activeTab, grid);
            }
            return {
                activeTab,
                pagingOffsets,
                activeTabPlatformGridScrollLeft,
                activeTabPlatformAnchorPlatformId,
                activeTabPlatformAnchorOffsetX,
                showReadMode: document.body.classList.contains('show-read-mode'),
                scrollY: window.scrollY || 0,
                searchText: (document.getElementById('searchInput')?.value || ''),
            };
        }

        function restoreActiveTabPlatformGridScroll(state) {
            const tabId = state?.activeTab;
            if (!state?.preserveScroll || !tabId) return;

            const saved = getPlatformGridScrollState()?.[tabId];
            const left = Number.isFinite(saved?.left) ? saved.left : (Number.isFinite(state.activeTabPlatformGridScrollLeft) ? state.activeTabPlatformGridScrollLeft : 0);
            const anchorId = (typeof saved?.anchorPlatformId === 'string' && saved.anchorPlatformId) ? saved.anchorPlatformId : state.activeTabPlatformAnchorPlatformId;
            const offsetX = Number.isFinite(saved?.anchorOffsetX) ? saved.anchorOffsetX : (Number.isFinite(state.activeTabPlatformAnchorOffsetX) ? state.activeTabPlatformAnchorOffsetX : 0);

            const applyOnce = () => {
                const grid = document.querySelector(`#tab-${tabId} .platform-grid`);
                if (!grid) return;

                if (anchorId) {
                    let anchorCard = null;
                    grid.querySelectorAll('.platform-card').forEach((card) => {
                        if (!anchorCard && card.dataset.platform === anchorId) {
                            anchorCard = card;
                        }
                    });
                    if (anchorCard && anchorCard.offsetParent !== null) {
                        grid.scrollLeft = (anchorCard.offsetLeft || 0) + offsetX;
                        return;
                    }
                }

                grid.scrollLeft = left;
            };

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    applyOnce();
                    setTimeout(applyOnce, 50);
                    setTimeout(applyOnce, 200);
                    setTimeout(applyOnce, 600);
                });
            });
        }

        function renderViewerFromData(data, state) {
            const tabsEl = document.querySelector('.category-tabs');
            const contentEl = document.querySelector('.tab-content-area');
            if (!tabsEl || !contentEl) return;

            const categories = data?.categories || {};

            const tabsHtml = Object.entries(categories).map(([catId, cat]) => {
                const icon = escapeHtml(cat?.icon || '');
                const name = escapeHtml(cat?.name || catId);
                const badgeCategory = cat?.is_new ? `<span class="new-badge new-badge-category" data-category="${escapeHtml(catId)}">NEW</span>` : '';
                const badgeSports = catId === 'sports' ? '<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>' : '';
                const badge = `${badgeCategory}${badgeSports}`;
                return `
            <div class="category-tab" data-category="${escapeHtml(catId)}" onclick="switchTab('${escapeHtml(catId)}')">
                <div class="category-tab-icon">${icon}</div>
                <div class="category-tab-name">${name}${badge}</div>
            </div>`;
            }).join('');

            const contentHtml = Object.entries(categories).map(([catId, cat]) => {
                const platforms = cat?.platforms || {};
                const platformCards = Object.entries(platforms).map(([platformId, platform]) => {
                    const platformName = escapeHtml(platform?.name || platformId);
                    const platformBadge = platform?.is_new ? `<span class="new-badge new-badge-platform" data-platform="${escapeHtml(platformId)}">NEW</span>` : '';
                    const news = Array.isArray(platform?.news) ? platform.news : [];
                    const pagingOffset = (platformId && state?.pagingOffsets && Number.isFinite(state.pagingOffsets[platformId])) ? state.pagingOffsets[platformId] : 0;
                    const newsItemsHtml = news.map((n, idx) => {
                        const stableId = escapeHtml(n?.stable_id || '');
                        const title = escapeHtml(n?.display_title || n?.title || '');
                        const url = escapeHtml(n?.url || '');
                        const meta = escapeHtml(n?.meta || '');
                        const rank = escapeHtml(n?.rank ?? '');
                        const isCross = !!n?.is_cross_platform;
                        const crossPlatforms = Array.isArray(n?.cross_platforms) ? n.cross_platforms : [];
                        const crossTitle = escapeHtml(crossPlatforms.join(', '));
                        const crossCount = escapeHtml(n?.cross_platform_count ?? '');
                        const crossBadge = isCross ? `<span class="cross-platform-badge" title="ÂêåÊó∂Âá∫Áé∞Âú®: ${crossTitle}">üî• ${crossCount}</span>` : '';
                        const crossClass = isCross ? 'cross-platform' : '';
                        const indexHtml = `<span class="news-index">${String(idx + 1)}</span>`;
                        const pagedHidden = (idx < pagingOffset || idx >= (pagingOffset + CATEGORY_PAGE_SIZE)) ? ' paged-hidden' : '';
                        const metaHtml = meta ? `<div class="news-subtitle">${meta}</div>` : '';
                        return `
                            <li class="news-item${pagedHidden}" data-news-id="${stableId}" data-news-title="${title}">
                                <div class="news-item-content">
                                    <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="Ê†áËÆ∞Â∑≤ËØª">
                                    ${indexHtml}
                                    <div class="news-title ${platformId === 'nba-schedule' ? 'nba-title ' : ''}${crossClass}" onclick="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)" tabindex="0" role="button" data-url="${url}">
                                        ${title}
                                        ${crossBadge}
                                    </div>
                                </div>
                                ${metaHtml}
                            </li>`;
                    }).join('');

                    return `
                    <div class="platform-card" data-platform="${escapeHtml(platformId)}">
                        <div class="platform-header">
                            <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${escapeHtml(platformId)}')">üì± ${platformName}${platformBadge}</div>
                            <button class="platform-refresh-btn" type="button" onclick="refreshPlatform(this)" title="‰ªÖÂà∑Êñ∞Êú¨Âπ≥Âè∞ÔºåÊç¢Êñ∞Ôºà20Êù°)"><span>Êç¢Êñ∞</span></button>
                        </div>
                        <ul class="news-list">${newsItemsHtml}
                        </ul>
                    </div>`;
                }).join('');

                return `
            <div class="tab-pane" id="tab-${escapeHtml(catId)}">
                <div class="platform-grid">${platformCards}
                </div>
            </div>`;
            }).join('');

            tabsEl.innerHTML = tabsHtml;
            contentEl.innerHTML = contentHtml;

            const updatedAtEl = document.getElementById('updatedAt');
            if (updatedAtEl && data?.updated_at) updatedAtEl.textContent = formatUpdatedAt(data.updated_at);

            if (state?.activeTab) {
                switchTab(state.activeTab);
            } else {
                const firstTab = document.querySelector('.category-tab');
                if (firstTab?.dataset?.category) {
                    switchTab(firstTab.dataset.category);
                }
            }

            applyPlatformFilter();

            const nextShowReadMode = (typeof state?.showReadMode === 'boolean') ? state.showReadMode : getShowReadModePref();
            applyShowReadMode(nextShowReadMode);

            renderFilterTags();
            applyFilter();

            const searchEl = document.getElementById('searchInput');
            if (searchEl && typeof state?.searchText === 'string') {
                searchEl.value = state.searchText;
            }
            searchNews();

            restoreReadState();

            document.querySelectorAll('.platform-card').forEach((card) => {
                const pid = card.dataset.platform;
                const off = (pid && state?.pagingOffsets && Number.isFinite(state.pagingOffsets[pid])) ? state.pagingOffsets[pid] : 0;
                applyPagingToCard(card, off);
            });

            updateAllCounts();
            updateReadCount();
            restoreActiveTabPlatformGridScroll(state);
            attachPlatformGridScrollPersistence();
        }

        async function refreshViewerData(opts = {}) {
            if (_ajaxRefreshInFlight) return;
            _ajaxRefreshInFlight = true;
            try {
                const state = snapshotViewerState();
                state.preserveScroll = opts.preserveScroll !== false;
                const response = await fetch('/api/news');
                const data = await response.json();
                renderViewerFromData(data, state);
                if (state.preserveScroll) {
                    window.scrollTo({ top: state.scrollY, behavior: 'auto' });
                    restoreActiveTabPlatformGridScroll(state);
                }
                _ajaxLastRefreshAt = Date.now();
            } catch (e) {
                // ignore
            } finally {
                _ajaxRefreshInFlight = false;
            }
        }

        function setupAjaxAutoRefresh() {
            const intervalMs = 300000;
            setInterval(() => {
                if (document.visibilityState !== 'visible') return;
                const now = Date.now();
                if (now - _ajaxLastRefreshAt < intervalMs - 5000) return;
                refreshViewerData({ preserveScroll: true });
            }, 5000);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    refreshViewerData({ preserveScroll: true });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const updatedAtEl = document.getElementById('updatedAt');
            if (updatedAtEl && updatedAtEl.textContent) {
                updatedAtEl.textContent = formatUpdatedAt(updatedAtEl.textContent);
            }
            setupAjaxAutoRefresh();
            applyDismissedNewBadges();
        });
    </script>
</body>
</html>
