<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="admin-token" content="{{ token }}" />
  <title>RSS Source Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background: #f9fafb; color: #111827; }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 20px; margin: 0 0 16px; }
    h2 { font-size: 16px; margin: 18px 0 10px; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
    th { font-size: 12px; color: #6b7280; font-weight: 700; }
    .muted { color: #6b7280; font-size: 12px; }
    .btn { border: 1px solid #d1d5db; background: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn-primary { border-color: #2563eb; background: #2563eb; color: white; }
    .btn-danger { border-color: #dc2626; background: #dc2626; color: white; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    input[type=text] { border: 1px solid #d1d5db; border-radius: 8px; padding: 6px 10px; min-width: 220px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .pill { border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; font-size:12px; color:#374151; background:#f9fafb; }
    .bar { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; min-width: 120px; }
    .bar > div { height: 100%; background: #2563eb; border-radius: 999px; }
    .badge { display:inline-flex; align-items:center; border:1px solid #e5e7eb; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:700; }
    .badge-ok { color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }
    .badge-warn { color:#92400e; background:#fffbeb; border-color:#fcd34d; }
    .badge-bad { color:#991b1b; background:#fef2f2; border-color:#fecaca; }
    .badge-off { color:#374151; background:#f3f4f6; border-color:#e5e7eb; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RSS Source Admin</h1>
    <div class="muted">This page requires <code>?token=...</code> or <code>X-Admin-Token</code>.</div>

    <h2>Morning Brief Rules</h2>
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">
        Edit <code>morning_brief_rules_v1</code> (JSON). Changes take effect immediately.
      </div>
      <textarea id="mb-rules-text" style="width:100%;min-height:160px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;" placeholder='{"enabled":true,"drop_published_at_zero":true,"topic_keywords":["ai"],"depth_keywords":[],"negative_hard":[],"negative_soft":[],"source_scores":{},"source_decay":{"second":0.6,"third_plus":0.3},"overrides":{"force_top":[],"force_blacklist":[]}}'></textarea>
      <div style="height:10px;"></div>
      <div class="row" style="align-items:center;">
        <button class="btn btn-primary" onclick="loadMorningBriefRules()">Load</button>
        <button class="btn btn-primary" onclick="validateMorningBriefRules()">Validate</button>
        <button class="btn btn-primary" onclick="saveMorningBriefRules()">Save</button>
        <span class="muted" id="mb-rules-status"></span>
      </div>
    </div>

    <h2>CSV Paste Import</h2>
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">
        Paste CSV rows and import into <code>rss_sources</code>.
      </div>
      <div class="muted" style="margin-bottom:8px;">
        Supported formats:
        <div style="margin-top:4px;">
          <div><b>Headerless fixed-order (8 columns)</b>: name,url,seed_last_updated,category,feed_type,country,language,source</div>
          <div><b>Chinese headers</b>: 标题,订阅地址,最后更新,分类,类型,国家,语言,来源</div>
        </div>
      </div>
      <textarea id="csv-import-text" style="width:100%;min-height:120px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;" placeholder="Example:\nGoogle Blog AI,https://blog.google/technology/ai/rss/,,人工智能,分类订阅,美国,英文,手动添加"></textarea>
      <div style="height:10px;"></div>
      <div class="row" style="align-items:center;">
        <button class="btn btn-primary" onclick="previewCsvImport()">Preview</button>
        <button class="btn btn-primary" onclick="commitCsvImport()">Commit</button>
        <button class="btn btn-danger" onclick="bulkDisableByUrls()">Bulk Disable (From URLs)</button>
        <button class="btn btn-primary" onclick="bulkEnableCatalogAll()">Bulk Enable Catalog (All)</button>
        <button class="btn btn-danger" onclick="bulkDisableCatalogAll()">Bulk Disable Catalog (All)</button>
        <button class="btn btn-primary" onclick="exportCatalogAll()">Export Catalog (All)</button>
        <span class="muted" id="csv-import-status"></span>
      </div>
      <div style="height:10px;"></div>
      <div id="csv-import-result"></div>
    </div>

    <h2>Pending Requests</h2>
    <div class="card">
      {% if pending and pending|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>URL</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in pending %}
          <tr>
            <td>{{ r.id }}</td>
            <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
            <td style="max-width:520px; word-break:break-all;">
              <div><b>{{ r.host }}</b></div>
              <div class="muted">{{ r.url }}</div>
            </td>
            <td style="max-width:280px; word-break:break-word;">{{ r.note }}</td>
            <td>
              <div class="row">
                <input type="text" id="name-{{ r.id }}" placeholder="Source name (optional)" />
                <button class="btn btn-primary" data-id="{{ r.id }}" onclick="approveReq(this.dataset.id)">Approve</button>
                <input type="text" id="reason-{{ r.id }}" placeholder="Reject reason" />
                <button class="btn btn-danger" data-id="{{ r.id }}" onclick="rejectReq(this.dataset.id)">Reject</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="muted">No pending requests.</div>
      {% endif %}
    </div>

    <h2>Rejected Requests</h2>
    <div class="card">
      {% if rejected and rejected|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>URL</th>
            <th>Reason</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rejected %}
          <tr>
            <td>{{ r.id }}</td>
            <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
            <td style="max-width:520px; word-break:break-all;">
              <div><b>{{ r.host }}</b></div>
              <div class="muted">{{ r.url }}</div>
            </td>
            <td style="max-width:280px; word-break:break-word;">{{ r.reason }}</td>
            <td>
              <div class="row">
                <button class="btn" data-id="{{ r.id }}" onclick="reopenReq(this.dataset.id)">Reopen</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="muted">No rejected requests.</div>
      {% endif %}
    </div>

    <h2>Catalog (All)</h2>
    <div class="card" id="rss-catalog-all">
      <div class="kpi" id="catalog-kpi" style="margin-bottom:10px;">
        <span class="pill" title="异常总数：包含 FAIL / BACKOFF / NEVER_TRIED / OK_EMPTY / STALE">abnormal(异常)={{ health_abnormal_count or 0 }}</span>
        <span class="pill" title="正常：已抓取成功且有内容，且 30 天内有更新">OK(正常)={{ (health_kpi or {}).get('OK', 0) }}</span>
        <span class="pill" title="失败：抓取/解析失败过（fail_count > 0）">FAIL(失败)={{ (health_kpi or {}).get('FAIL', 0) }}</span>
        <span class="pill" title="退避：当前处于 backoff，暂时不会频繁重试（backoff_until > now）">BACKOFF(退避)={{ (health_kpi or {}).get('BACKOFF', 0) }}</span>
        <span class="pill" title="从未尝试：还没有抓取过（last_attempt_at=0）">NEVER_TRIED(未尝试)={{ (health_kpi or {}).get('NEVER_TRIED', 0) }}</span>
        <span class="pill" title="抓取成功但为空：尝试过抓取但 entries=0（视为异常）">OK_EMPTY(空)={{ (health_kpi or {}).get('OK_EMPTY', 0) }}</span>
        <span class="pill" title="长期不更新：最新条目时间超过 30 天（视为异常）">STALE(长期不更新)={{ (health_kpi or {}).get('STALE', 0) }}</span>
        <span class="pill" title="已禁用：enabled=0">DISABLED(已禁用)={{ (health_kpi or {}).get('DISABLED', 0) }}</span>
      </div>

      <div class="row" style="align-items:center; margin-bottom:10px;">
        <input type="text" id="catalog-search" placeholder="Search: name/url/host/category/source" />
        <button class="btn" data-filter="ALL" onclick="setCatalogFilter('ALL')" title="显示全部来源">All(全部)</button>
        <button class="btn btn-primary" data-filter="ABNORMAL" onclick="setCatalogFilter('ABNORMAL')" title="异常：FAIL / BACKOFF / NEVER_TRIED / OK_EMPTY / STALE">Abnormal(异常)</button>
        <button class="btn" data-filter="OK" onclick="setCatalogFilter('OK')" title="正常：已抓取成功且有内容，且 30 天内有更新">OK(正常)</button>
        <button class="btn" data-filter="FAIL" onclick="setCatalogFilter('FAIL')" title="失败：抓取/解析失败过（fail_count > 0）">FAIL(失败)</button>
        <button class="btn" data-filter="BACKOFF" onclick="setCatalogFilter('BACKOFF')" title="退避：backoff_until > now">BACKOFF(退避)</button>
        <button class="btn" data-filter="NEVER_TRIED" onclick="setCatalogFilter('NEVER_TRIED')" title="从未尝试：last_attempt_at=0">NEVER_TRIED(未尝试)</button>
        <button class="btn" data-filter="OK_EMPTY" onclick="setCatalogFilter('OK_EMPTY')" title="抓取成功但为空：entries=0（异常）">OK_EMPTY(空)</button>
        <button class="btn" data-filter="STALE" onclick="setCatalogFilter('STALE')" title="长期不更新：最新条目时间超过 30 天（异常）">STALE(长期不更新)</button>
        <button class="btn" data-filter="DISABLED" onclick="setCatalogFilter('DISABLED')" title="已禁用：enabled=0">DISABLED(已禁用)</button>
      </div>

      <div class="row" style="align-items:center; margin-bottom:10px;">
        <span class="muted" id="bulk-selection-info">Selected: 0</span>
        <button class="btn" onclick="bulkWarmupSelected()">批量抓取</button>
        <button class="btn" onclick="bulkClearBackoffAndRetry()">批量清退避并重试</button>
        <button class="btn" onclick="bulkSetEnabledSelected(1)">批量启用</button>
        <button class="btn" onclick="bulkSetEnabledSelected(0)">批量禁用</button>
        <button class="btn btn-danger" onclick="bulkDeleteSelected()">批量删除</button>
      </div>

      {% if sources and sources|length > 0 %}
      <table>
        <thead>
          <tr>
            <th style="width:44px;"><input type="checkbox" id="select-all-visible" onclick="toggleSelectAllVisible(this)" /></th>
            <th>Health</th>
            <th>ID</th>
            <th>标题</th>
            <th>订阅地址</th>
            <th>最后更新</th>
            <th>分类</th>
            <th>类型</th>
            <th>国家</th>
            <th>语言</th>
            <th>来源</th>
            <th>Subscribed</th>
            <th>Added</th>
            <th>Entries</th>
            <th>Latest</th>
            <th>Last Attempt</th>
            <th>Fail</th>
            <th>Backoff Until</th>
            <th>Last Error</th>
            <th>Enabled</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in sources %}
          <tr data-health="{{ s.health_state or '' }}" data-abnormal="{{ 1 if s.is_abnormal else 0 }}" data-search="{{ (s.name ~ ' ' ~ s.url ~ ' ' ~ s.host ~ ' ' ~ (s.category or '') ~ ' ' ~ (s.source or '') )|lower }}">
            <td>
              <input type="checkbox" class="rss-src-select" data-id="{{ s.id }}" onchange="updateBulkSelectionInfo()" />
            </td>
            <td>
              {% set hs = s.health_state or '' %}
              {% if hs == 'OK' %}
                <span class="badge badge-ok">OK</span>
              {% elif hs in ['FAIL'] %}
                <span class="badge badge-bad">FAIL</span>
              {% elif hs in ['BACKOFF','NEVER_TRIED','OK_EMPTY','STALE'] %}
                <span class="badge badge-warn">{{ hs }}</span>
              {% elif hs == 'DISABLED' %}
                <span class="badge badge-off">DISABLED</span>
              {% else %}
                <span class="badge badge-off">{{ hs }}</span>
              {% endif %}
            </td>
            <td class="muted">{{ s.id }}</td>
            <td style="max-width:240px; word-break:break-word;"><b>{{ s.name }}</b></td>
            <td style="max-width:520px; word-break:break-all;" class="muted">
              <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer">{{ s.url }}</a>
            </td>
            <td class="muted">{{ s.last_updated_time or '' }}</td>
            <td class="muted">{{ s.category or '' }}</td>
            <td class="muted">{{ s.feed_type or '' }}</td>
            <td class="muted">{{ s.country or '' }}</td>
            <td class="muted">{{ s.language or '' }}</td>
            <td class="muted">{{ s.source or '' }}</td>
            <td class="muted">{{ s.subscribed_count or 0 }}</td>
            <td class="muted">{{ s.added_count or 0 }}</td>
            <td class="muted">{{ s.entries_count or 0 }}</td>
            <td class="muted">{{ s.latest_entry_time or '' }}</td>
            <td class="muted">{{ s.last_attempt_time or '' }}</td>
            <td class="muted">{{ s.fail_count or 0 }}</td>
            <td class="muted">{{ s.backoff_until_time or '' }}</td>
            <td class="muted" style="max-width:360px; word-break:break-word;">
              {{ (s.last_error_reason or '')[:120] }}
              {% if s.url %}
                <span style="margin-left:6px;"><a href="{{ s.url }}" target="_blank" rel="noopener noreferrer">open</a></span>
              {% endif %}
            </td>
            <td id="src-enabled-{{ s.id }}">{{ 1 if s.enabled else 0 }}</td>
            <td>
              <div class="row">
                <button class="btn" data-id="{{ s.id }}" onclick="warmupSource(this)">手动抓取</button>
                <button class="btn" data-id="{{ s.id }}" onclick="clearBackoffAndRetry(this)" title="清除 backoff/fail 计数并立即重试"
                  {% if (s.health_state or '') not in ['BACKOFF','FAIL'] %}style="display:none;"{% endif %}>
                  清退避并重试
                </button>
                <button class="btn btn-danger" data-id="{{ s.id }}" data-name="{{ s.name }}" onclick="deleteSource(this)" title="删除 RSS 源（同时清理该源的 entries/订阅引用）">
                  Delete
                </button>
                <button class="btn" data-id="{{ s.id }}" data-enabled="{{ 1 if s.enabled else 0 }}" onclick="toggleSourceEnabled(this)">
                  {% if s.enabled %}Disable{% else %}Enable{% endif %}
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="muted">Catalog is empty.</div>
      {% endif %}
    </div>

    <h2>RSS Usage</h2>
    <div class="card">
      <div class="row" style="align-items:center;">
        <input type="text" id="usage-days" value="7" />
        <button class="btn btn-primary" onclick="loadUsage()">Load</button>
        <span class="muted" id="usage-status"></span>
      </div>
      <div style="height:10px;"></div>
      <div class="kpi" id="usage-kpi" style="display:none;"></div>
      <div style="height:10px;"></div>
      <div id="usage-table"></div>
    </div>
  </div>

  <script>
    const token = document.querySelector('meta[name="admin-token"]')?.getAttribute('content') || '';

    let _catalogFilter = 'ABNORMAL';

    function _getCatalogContainer() {
      return document.getElementById('rss-catalog-all');
    }

    function _getCatalogRows() {
      const c = _getCatalogContainer();
      if (!c) return [];
      return Array.from(c.querySelectorAll('table tbody tr[data-health]'));
    }

    function _rowIsVisible(tr) {
      if (!tr) return false;
      const v = String(tr.style?.display || '');
      return v !== 'none';
    }

    function getSelectedSourceIds() {
      const ids = [];
      const rows = _getCatalogRows();
      for (const tr of rows) {
        const cb = tr.querySelector('input.rss-src-select');
        if (!cb) continue;
        if (cb.checked) {
          const sid = String(cb.dataset?.id || '').trim();
          if (sid) ids.push(sid);
        }
      }
      return ids;
    }

    function updateBulkSelectionInfo() {
      const el = document.getElementById('bulk-selection-info');
      if (!el) return;
      const ids = getSelectedSourceIds();
      el.textContent = `Selected: ${ids.length}`;

      const head = document.getElementById('select-all-visible');
      if (head) {
        const rows = _getCatalogRows().filter(r => _rowIsVisible(r));
        let visibleCount = 0;
        let checkedCount = 0;
        for (const tr of rows) {
          const cb = tr.querySelector('input.rss-src-select');
          if (!cb) continue;
          visibleCount += 1;
          if (cb.checked) checkedCount += 1;
        }
        head.checked = visibleCount > 0 && checkedCount === visibleCount;
      }
    }

    function toggleSelectAllVisible(head) {
      const checked = !!head?.checked;
      const rows = _getCatalogRows();
      for (const tr of rows) {
        if (!_rowIsVisible(tr)) continue;
        const cb = tr.querySelector('input.rss-src-select');
        if (!cb) continue;
        cb.checked = checked;
      }
      updateBulkSelectionInfo();
    }

    async function _bulkPostJson(url, payload) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Token': token
        },
        body: JSON.stringify(payload || {})
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.detail || `Failed (${resp.status})`);
      return data;
    }

    async function _warmupIds(ids, askConfirm) {
      const list = Array.isArray(ids) ? ids : [];
      if (!list.length) { alert('No rows selected.'); return; }
      if (!token) { alert('Missing admin token. Use ?token=...'); return; }
      if (askConfirm) {
        const ok = confirm(`批量抓取选中源？\ncount=${list.length}`);
        if (!ok) return;
      }
      _setCsvImportStatus(`批量抓取中... count=${list.length}`);

      const chunk = 25;
      let queued = 0;
      for (let i = 0; i < list.length; i += chunk) {
        const part = list.slice(i, i + chunk);
        const resp = await fetch('/api/rss-sources/warmup?wait_ms=1200', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ source_ids: part, priority: 'high' })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);
        queued += Number(payload?.queued || 0);
      }
      _setCsvImportStatus(`批量抓取已触发: queued=${queued}`);
    }

    async function bulkWarmupSelected() {
      const ids = getSelectedSourceIds();
      await _warmupIds(ids, true);
    }

    async function bulkClearBackoffAndRetry() {
      const ids = getSelectedSourceIds();
      if (!ids.length) { alert('No rows selected.'); return; }
      if (!token) { alert('Missing admin token. Use ?token=...'); return; }
      const ok = confirm(`批量清除退避并重试抓取？\ncount=${ids.length}`);
      if (!ok) return;
      _setCsvImportStatus(`批量清退避中... count=${ids.length}`);

      await _bulkPostJson('/api/admin/rss-sources/clear-backoff-bulk', { source_ids: ids });
      await _warmupIds(ids, false);
    }

    async function bulkSetEnabledSelected(enabled) {
      const ids = getSelectedSourceIds();
      if (!ids.length) { alert('No rows selected.'); return; }
      if (!token) { alert('Missing admin token. Use ?token=...'); return; }
      const label = enabled ? '启用' : '禁用';
      const ok = confirm(`批量${label}选中源？\ncount=${ids.length}`);
      if (!ok) return;
      _setCsvImportStatus(`批量${label}中... count=${ids.length}`);
      await _bulkPostJson('/api/admin/rss-sources/set-enabled-bulk', { source_ids: ids, enabled: enabled ? 1 : 0 });
      _setCsvImportStatus(`批量${label}完成: count=${ids.length}`);
      try { window.location.reload(); } catch (e) {}
    }

    async function bulkDeleteSelected() {
      const ids = getSelectedSourceIds();
      if (!ids.length) { alert('No rows selected.'); return; }
      if (!token) { alert('Missing admin token. Use ?token=...'); return; }
      const ok = confirm(`确认批量删除选中源？\ncount=${ids.length}\n\n将同时删除 entries，并清理订阅引用。`);
      if (!ok) return;
      _setCsvImportStatus(`批量删除中... count=${ids.length}`);
      await _bulkPostJson('/api/admin/rss-sources/delete-bulk', { source_ids: ids });
      _setCsvImportStatus(`批量删除完成: count=${ids.length}`);
      try { window.location.reload(); } catch (e) {}
    }

    function _catalogFilterMatch(row, filter) {
      const f = String(filter || '').trim().toUpperCase() || 'ALL';
      const health = String(row?.dataset?.health || '').trim().toUpperCase();
      const abnormal = String(row?.dataset?.abnormal || '').trim() === '1';

      if (f === 'ALL') return true;
      if (f === 'ABNORMAL') return abnormal;
      return health === f;
    }

    function _catalogSearchMatch(row, q) {
      const query = String(q || '').trim().toLowerCase();
      if (!query) return true;
      const hay = String(row?.dataset?.search || '').toLowerCase();
      return hay.includes(query);
    }

    function applyCatalogFilter() {
      const q = document.getElementById('catalog-search')?.value || '';
      const rows = _getCatalogRows();
      for (const tr of rows) {
        const ok = _catalogFilterMatch(tr, _catalogFilter) && _catalogSearchMatch(tr, q);
        tr.style.display = ok ? '' : 'none';
      }

      const c = _getCatalogContainer();
      const btns = c ? c.querySelectorAll('button[data-filter]') : document.querySelectorAll('button[data-filter]');
      for (const b of btns) {
        const f = String(b?.dataset?.filter || '').trim().toUpperCase();
        if (!f) continue;
        if (f === String(_catalogFilter || '').trim().toUpperCase()) {
          b.classList.add('btn-primary');
        } else {
          b.classList.remove('btn-primary');
        }
      }

      updateBulkSelectionInfo();
    }

    async function deleteSource(btn) {
      const sid = String(btn?.dataset?.id || '').trim();
      const name = String(btn?.dataset?.name || '').trim();
      if (!sid) return;
      const ok = confirm(`确认删除 RSS 源？\n\nname=${name || '(unknown)'}\nsource_id=${sid}\n\n将同时删除该源 entries，并清理订阅引用。`);
      if (!ok) return;

      const originalBtnText = String(btn.textContent || '');
      try {
        if (!token) {
          _setCsvImportStatus('删除失败: 缺少 admin token');
          alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Deleting...';
        _setCsvImportStatus(`Deleting: ${sid} ...`);

        const resp = await fetch('/api/admin/rss-sources/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ source_id: sid })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

        _setCsvImportStatus(`Deleted: ${sid}`);
        try { window.location.reload(); } catch (e) {}
      } catch (e) {
        _setCsvImportStatus(`删除失败: ${sid}`);
        alert(e?.message || String(e));
        btn.textContent = originalBtnText || 'Delete';
      } finally {
        try { btn.disabled = false; } catch (e) {}
      }
    }

    async function clearBackoffAndRetry(btn) {
      const sid = String(btn?.dataset?.id || '').trim();
      if (!sid) return;
      const ok = confirm(`清除退避并重试抓取？\nsource_id=${sid}`);
      if (!ok) return;

      const originalBtnText = String(btn.textContent || '');
      try {
        if (!token) {
          _setCsvImportStatus('操作失败: 缺少 admin token');
          alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
          return;
        }

        btn.disabled = true;
        btn.textContent = '清理中...';
        _setCsvImportStatus(`清理退避: ${sid} ...`);

        const resp = await fetch('/api/admin/rss-sources/clear-backoff', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ source_id: sid, warmup: 0 })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

        _setCsvImportStatus(`已清除退避: ${sid}，开始重试抓取...`);
        btn.textContent = '重试中...';

        await warmupSource(sid);
        btn.textContent = '已重试';
      } catch (e) {
        _setCsvImportStatus(`操作失败: ${sid}`);
        alert(e?.message || String(e));
        btn.textContent = originalBtnText || '清退避并重试';
      } finally {
        try { btn.disabled = false; } catch (e) {}
      }
    }

    function setCatalogFilter(v) {
      _catalogFilter = String(v || 'ALL');
      applyCatalogFilter();
    }

    let _csvPreviewHash = '';
    let _csvPreviewText = '';

    try {
      const search = document.getElementById('catalog-search');
      if (search) {
        search.addEventListener('input', () => applyCatalogFilter());
      }
      updateBulkSelectionInfo();
      applyCatalogFilter();
    } catch (e) {
      // ignore
    }

    function _setCsvImportStatus(msg) {
      const el = document.getElementById('csv-import-status');
      if (!el) return;
      el.textContent = msg || '';
    }

    function _escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function _setMorningBriefRulesStatus(msg) {
      const el = document.getElementById('mb-rules-status');
      if (!el) return;
      el.textContent = msg || '';
    }

    async function loadMorningBriefRules() {
      try {
        _setMorningBriefRulesStatus('Loading...');
        const resp = await fetch(`/api/admin/morning-brief/rules?token=${encodeURIComponent(token)}`);
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || 'Load failed');
        const rules = payload?.rules || {};
        const text = JSON.stringify(rules, null, 2);
        const ta = document.getElementById('mb-rules-text');
        if (ta) ta.value = text;
        _setMorningBriefRulesStatus(`Loaded (updated_at=${Number(payload?.updated_at || 0)})`);
      } catch (e) {
        _setMorningBriefRulesStatus('');
        alert(e?.message || String(e));
      }
    }

    function validateMorningBriefRules() {
      try {
        const ta = document.getElementById('mb-rules-text');
        const text = ta ? String(ta.value || '').trim() : '';
        if (!text) throw new Error('Empty rules JSON');
        const parsed = JSON.parse(text);
        if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
          throw new Error('Rules must be a JSON object');
        }
        _setMorningBriefRulesStatus('Valid JSON');
      } catch (e) {
        _setMorningBriefRulesStatus('Invalid JSON');
        alert(e?.message || String(e));
      }
    }

    async function saveMorningBriefRules() {
      try {
        const ta = document.getElementById('mb-rules-text');
        const text = ta ? String(ta.value || '').trim() : '';
        if (!text) throw new Error('Empty rules JSON');
        const rules = JSON.parse(text);
        _setMorningBriefRulesStatus('Saving...');
        const resp = await fetch(`/api/admin/morning-brief/rules?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ rules })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || 'Save failed');
        _setMorningBriefRulesStatus(`Saved (updated_at=${Number(payload?.updated_at || 0)})`);
      } catch (e) {
        _setMorningBriefRulesStatus('');
        alert(e?.message || String(e));
      }
    }

    async function toggleSourceEnabled(btn) {
      const sourceId = btn?.dataset?.id || '';
      const curEnabled = String(btn?.dataset?.enabled || '').trim() === '1';
      const nextEnabled = !curEnabled;
      if (!sourceId) return;

      try {
        btn.disabled = true;
        const resp = await fetch('/api/admin/rss-sources/set-enabled', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ source_id: sourceId, enabled: nextEnabled ? 1 : 0 })
        });
        const payload = await resp.json();
        if (!resp.ok) throw new Error(payload?.detail || 'Failed');

        btn.dataset.enabled = nextEnabled ? '1' : '0';
        btn.textContent = nextEnabled ? 'Disable' : 'Enable';
        const cell = document.getElementById(`src-enabled-${sourceId}`);
        if (cell) cell.textContent = nextEnabled ? '1' : '0';
      } catch (e) {
        alert(e?.message || String(e));
      } finally {
        try { btn.disabled = false; } catch (e) { /* ignore */ }
      }
    }

    async function warmupSource(btnOrSourceId) {
      const btn = (btnOrSourceId && typeof btnOrSourceId === 'object' && 'dataset' in btnOrSourceId) ? btnOrSourceId : null;
      const sid = btn ? String(btn?.dataset?.id || '').trim() : String(btnOrSourceId || '').trim();
      if (!sid) return;

      const originalBtnText = btn ? String(btn.textContent || '') : '';
      try {
        if (!token) {
          _setCsvImportStatus('抓取失败: 缺少 admin token');
          alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
          return;
        }

        if (btn) {
          btn.disabled = true;
          btn.textContent = '抓取中...';
        }
        _setCsvImportStatus(`抓取中: ${sid} ...`);

        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 15000);
        const resp = await fetch('/api/rss-sources/warmup?wait_ms=1200', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ source_ids: [sid], priority: 'high' }),
          signal: ctrl.signal,
        }).finally(() => clearTimeout(t));

        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

        const detail = String(payload?.detail || '').toLowerCase();
        if (detail.includes('warmup not available')) {
          throw new Error(String(payload?.detail || 'warmup not available'));
        }
        if (Number(payload?.queued || 0) <= 0) {
          throw new Error(String(payload?.detail || 'No task queued'));
        }

        const res0 = Array.isArray(payload?.results) ? payload.results[0] : null;
        if (res0 && res0.ok === false && res0.error) {
          throw new Error(String(res0.error));
        }

        _setCsvImportStatus(`抓取完成: ${sid}`);
        if (btn) btn.textContent = '已触发';
      } catch (e) {
        _setCsvImportStatus(`抓取失败: ${sid}`);
        const name = String(e?.name || '');
        if (name === 'AbortError') {
          alert('Request timeout (15s).');
        } else {
          alert(e?.message || String(e));
        }
        if (btn) btn.textContent = originalBtnText || '手动抓取';
      } finally {
        if (btn) {
          try { btn.disabled = false; } catch (e) { /* ignore */ }
        }
      }
    }

    async function exportCatalogAll() {
      try {
        _setCsvImportStatus('Exporting...');
        const resp = await fetch('/api/admin/rss-sources/export', {
          method: 'GET',
          headers: {
            'X-Admin-Token': token
          }
        });
        if (!resp.ok) {
          const payload = await resp.json().catch(() => ({}));
          throw new Error(payload?.detail || 'Export failed');
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'admin_rss_catalog_all.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        _setCsvImportStatus('Exported');
      } catch (e) {
        alert(e?.message || String(e));
        _setCsvImportStatus('');
      }
    }

    async function bulkEnableCatalogAll() {
      const ok = confirm('Enable ALL disabled rss_sources in Catalog (All)?');
      if (!ok) return;
      try {
        _setCsvImportStatus('Enabling...');
        const resp = await fetch('/api/admin/rss-sources/bulk-enable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({})
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || 'Bulk enable failed');
        alert(`Enabled ${Number(payload?.enabled || 0)} source(s).`);
        location.reload();
      } catch (e) {
        alert(e?.message || String(e));
        _setCsvImportStatus('');
      }
    }

    function _parseUrlsFromTextareaText(text) {
      const out = [];
      const seen = new Set();
      const lines = String(text || '').split(/\r?\n/);
      for (const lineRaw of lines) {
        const line = String(lineRaw || '').trim();
        if (!line) continue;

        // Support:
        // 1) plain URL per line
        // 2) CSV row where 2nd column is URL
        let candidate = line;
        if (line.includes(',')) {
          const parts = line.split(',').map((x) => String(x || '').trim());
          if (parts.length >= 2 && (parts[1] || '').startsWith('http')) {
            candidate = parts[1];
          }
        }
        if (!candidate.startsWith('http://') && !candidate.startsWith('https://')) {
          continue;
        }
        if (seen.has(candidate)) continue;
        seen.add(candidate);
        out.push(candidate);
      }
      return out;
    }

    async function bulkDisableByUrls() {
      const text = document.getElementById('csv-import-text')?.value || '';
      const urls = _parseUrlsFromTextareaText(text);
      if (!urls.length) {
        alert('No URL found in textarea. Paste one URL per line, or CSV rows with URL in the 2nd column.');
        return;
      }
      const ok = confirm(`Disable sources matching ${urls.length} URL(s)? (Only matched enabled sources will be disabled)`);
      if (!ok) return;
      try {
        _setCsvImportStatus('Disabling by URLs...');
        const resp = await fetch('/api/admin/rss-sources/bulk-disable-by-urls', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({ urls })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || 'Bulk disable by URLs failed');

        const disabled = Number(payload?.disabled || 0);
        const matched = Number(payload?.matched || 0);
        const notFound = Array.isArray(payload?.not_found) ? payload.not_found : [];
        const invalid = Array.isArray(payload?.invalid) ? payload.invalid : [];
        let msg = `Matched ${matched} URL(s), disabled ${disabled} source(s).`;
        if (invalid.length) msg += `\nInvalid: ${invalid.length}`;
        if (notFound.length) msg += `\nNot found: ${notFound.length}`;
        alert(msg);
        location.reload();
      } catch (e) {
        alert(e?.message || String(e));
        _setCsvImportStatus('');
      }
    }

    function _renderCsvImportResult(payload) {
      const el = document.getElementById('csv-import-result');
      if (!el) return;
      const fmt = payload?.detected_format || '';
      const hash = payload?.preview_hash || '';
      const summary = payload?.summary || {};
      const expected = payload?.expected || {};
      const invalid = Array.isArray(payload?.invalid_rows) ? payload.invalid_rows : [];
      const dups = Array.isArray(payload?.duplicate_rows) ? payload.duplicate_rows : [];
      const sample = Array.isArray(payload?.sample) ? payload.sample : [];

      const expHeaderless = Array.isArray(expected?.headerless_fixed_order) ? expected.headerless_fixed_order.join(', ') : '';
      const expZh = Array.isArray(expected?.headered_zh) ? expected.headered_zh.join(', ') : '';

      const kpiHtml = [
        `<span class="pill">format=${_escapeHtml(fmt)}</span>`,
        hash ? `<span class="pill">preview_hash=${_escapeHtml(hash)}</span>` : '',
        `<span class="pill">total_rows=${Number(summary.total_rows || 0)}</span>`,
        `<span class="pill">unique_urls=${Number(summary.unique_urls || 0)}</span>`,
        `<span class="pill">inserted=${Number(summary.inserted || 0)}</span>`,
        `<span class="pill">updated=${Number(summary.updated || 0)}</span>`,
        `<span class="pill">duplicates=${Number(summary.duplicates || 0)}</span>`,
        `<span class="pill">invalid=${Number(summary.invalid || 0)}</span>`
      ].filter(Boolean).join('');

      const invalidHtml = invalid.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Invalid Rows (showing up to 50)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>line_no</th><th>error</th></tr></thead>
            <tbody>
              ${invalid.map((x) => `<tr><td class="muted">${_escapeHtml(x.line_no)}</td><td>${_escapeHtml(x.error)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

      const dupHtml = dups.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Duplicate Rows (showing up to 50)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>line_no</th><th>url</th><th>first_line_no</th></tr></thead>
            <tbody>
              ${dups.map((x) => `<tr><td class="muted">${_escapeHtml(x.line_no)}</td><td class="muted" style="max-width:520px;word-break:break-all;">${_escapeHtml(x.url)}</td><td class="muted">${_escapeHtml(x.first_line_no)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

      const sampleHtml = sample.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Sample (first 10 unique rows)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>action</th><th>name</th><th>url</th><th>category</th><th>feed_type</th><th>country</th><th>language</th><th>source</th></tr></thead>
            <tbody>
              ${sample.map((x) => `
                <tr>
                  <td class="muted">${_escapeHtml(x.action)}</td>
                  <td><b>${_escapeHtml(x.name)}</b></td>
                  <td class="muted" style="max-width:420px;word-break:break-all;">${_escapeHtml(x.url)}</td>
                  <td class="muted">${_escapeHtml(x.category)}</td>
                  <td class="muted">${_escapeHtml(x.feed_type)}</td>
                  <td class="muted">${_escapeHtml(x.country)}</td>
                  <td class="muted">${_escapeHtml(x.language)}</td>
                  <td class="muted">${_escapeHtml(x.source)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

      el.innerHTML = `
        <div class="kpi" style="display:flex;">${kpiHtml}</div>
        <div style="margin-top:8px;" class="muted">
          <div><b>Expected (headerless)</b>: ${_escapeHtml(expHeaderless)}</div>
          <div><b>Expected (headered zh)</b>: ${_escapeHtml(expZh)}</div>
        </div>
        ${invalidHtml}
        ${dupHtml}
        ${sampleHtml}
      `;
    }

    async function previewCsvImport() {
      const text = document.getElementById('csv-import-text')?.value || '';
      _setCsvImportStatus('Previewing...');
      const el = document.getElementById('csv-import-result');
      if (el) el.innerHTML = '';
      _csvPreviewHash = '';
      _csvPreviewText = '';
      const resp = await fetch(`/api/admin/rss-sources/import-csv/preview?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csv_text: text })
      });
      const payload = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        _setCsvImportStatus(payload?.detail || 'Preview failed');
        if (el) el.innerHTML = `<div style="color:#dc2626;">${_escapeHtml(payload?.detail || 'Preview failed')}</div>`;
        return;
      }
      _csvPreviewHash = String(payload?.preview_hash || '');
      _csvPreviewText = String(text || '');
      _setCsvImportStatus('Preview ready');
      _renderCsvImportResult(payload);
    }

    async function commitCsvImport() {
      const text = document.getElementById('csv-import-text')?.value || '';
      if (!_csvPreviewHash) {
        alert('Please Preview first.');
        return;
      }
      if (String(text || '') !== String(_csvPreviewText || '')) {
        alert('CSV text changed since preview. Please Preview again.');
        return;
      }
      const ok = confirm('Commit import into rss_sources?');
      if (!ok) return;
      _setCsvImportStatus('Committing...');
      const resp = await fetch(`/api/admin/rss-sources/import-csv/commit?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csv_text: text, preview_hash: _csvPreviewHash })
      });
      const payload = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        _setCsvImportStatus(payload?.detail || 'Commit failed');
        alert(payload?.detail || 'Commit failed');
        return;
      }
      _setCsvImportStatus('Committed');
      location.reload();
    }

    async function bulkDisableCatalogAll() {
      const ok = confirm('Disable ALL enabled rss_sources in Catalog (All)?');
      if (!ok) return;
      try {
        _setCsvImportStatus('Disabling...');
        const resp = await fetch('/api/admin/rss-sources/bulk-disable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify({})
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(payload?.detail || 'Bulk disable failed');
        alert(`Disabled ${Number(payload?.disabled || 0)} source(s).`);
        location.reload();
      } catch (e) {
        alert(e?.message || String(e));
        _setCsvImportStatus('');
      }
    }

    async function approveReq(id) {
      id = String(id || '').trim();
      const name = document.getElementById(`name-${id}`)?.value || '';
      const resp = await fetch(`/api/admin/rss-source-requests/${id}/approve?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if (!resp.ok) {
        const t = await resp.text();
        alert(t || 'Approve failed');
        return;
      }
      location.reload();
    }

    async function rejectReq(id) {
      id = String(id || '').trim();
      const reason = document.getElementById(`reason-${id}`)?.value || '';
      const resp = await fetch(`/api/admin/rss-source-requests/${id}/reject?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });
      if (!resp.ok) {
        const t = await resp.text();
        alert(t || 'Reject failed');
        return;
      }
      location.reload();
    }

    async function reopenReq(id) {
      id = String(id || '').trim();
      const resp = await fetch(`/api/admin/rss-source-requests/${id}/reopen?token=${encodeURIComponent(token)}`, {
        method: 'POST'
      });
      if (!resp.ok) {
        const t = await resp.text();
        alert(t || 'Reopen failed');
        return;
      }
      location.reload();
    }

    function _setUsageStatus(msg) {
      const el = document.getElementById('usage-status');
      if (!el) return;
      el.textContent = msg || '';
    }

    function _n(v) {
      const x = Number(v);
      if (!Number.isFinite(x)) return 0;
      return x;
    }

    async function loadUsage() {
      const daysRaw = document.getElementById('usage-days')?.value || '7';
      const days = Math.max(1, Math.min(180, parseInt(daysRaw, 10) || 7));
      _setUsageStatus('Loading...');
      const tableEl = document.getElementById('usage-table');
      const kpiEl = document.getElementById('usage-kpi');
      if (tableEl) tableEl.innerHTML = '';
      if (kpiEl) { kpiEl.style.display = 'none'; kpiEl.innerHTML = ''; }

      const resp = await fetch(`/api/admin/rss-usage?days=${encodeURIComponent(String(days))}&token=${encodeURIComponent(token)}`);
      const payload = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        _setUsageStatus(payload?.detail || 'Load failed');
        return;
      }

      const items = Array.isArray(payload?.items) ? payload.items : [];
      const maxReq = items.reduce((m, x) => Math.max(m, _n(x?.requests)), 0) || 1;
      const totalReq = items.reduce((s, x) => s + _n(x?.requests), 0);
      const totalUsers = items.reduce((s, x) => s + _n(x?.unique_clients), 0);
      const maxUsers = items.reduce((m, x) => Math.max(m, _n(x?.unique_clients)), 0);
      _setUsageStatus(`Loaded ${items.length} day(s)`);

      if (kpiEl) {
        kpiEl.style.display = 'flex';
        kpiEl.innerHTML = [
          `<span class="pill">days=${days}</span>`,
          `<span class="pill">total_requests=${totalReq}</span>`,
          `<span class="pill">sum_unique_clients=${totalUsers}</span>`,
          `<span class="pill">max_daily_unique_clients=${maxUsers}</span>`
        ].join('');
      }

      if (!tableEl) return;
      if (items.length === 0) {
        tableEl.innerHTML = '<div class="muted">No data.</div>';
        return;
      }

      const rows = items.map((x) => {
        const day = String(x?.day || '');
        const req = _n(x?.requests);
        const users = _n(x?.unique_clients);
        const avgSubs = _n(x?.avg_subs).toFixed(2);
        const maxSubs = _n(x?.max_subs);
        const pct = Math.max(0, Math.min(100, Math.round(req / maxReq * 100)));
        return `
          <tr>
            <td><b>${day}</b></td>
            <td>
              <div style="display:flex;align-items:center;gap:10px;">
                <div class="bar"><div style="width:${pct}%;"></div></div>
                <span>${req}</span>
              </div>
            </td>
            <td>${users}</td>
            <td>${avgSubs}</td>
            <td>${maxSubs}</td>
          </tr>
        `;
      }).join('');

      tableEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Day</th>
              <th>Requests</th>
              <th>Unique Clients (Approx)</th>
              <th>Avg Subs</th>
              <th>Max Subs</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
  </script>
</body>
</html>
