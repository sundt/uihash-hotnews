<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="admin-token" content="{{ token }}" />
  <title>RSS Source Admin</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9fafb;
      color: #111827;
    }

    .wrap {
      max-width: none;
      margin: 0 auto;
      padding: 18px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 16px;
    }

    h2 {
      font-size: 16px;
      margin: 18px 0 10px;
    }

    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      font-size: 12px;
      color: #6b7280;
      font-weight: 700;
    }

    .muted {
      color: #6b7280;
      font-size: 12px;
    }

    .btn {
      border: 1px solid #d1d5db;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-primary {
      border-color: #2563eb;
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      border-color: #dc2626;
      background: #dc2626;
      color: white;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    input[type=text] {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 6px 10px;
      min-width: 220px;
    }

    .kpi {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .kpi .pill {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #374151;
      background: #f9fafb;
    }

    .bar {
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      min-width: 120px;
    }

    .bar>div {
      height: 100%;
      background: #2563eb;
      border-radius: 999px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge-ok {
      color: #065f46;
      background: #ecfdf5;
      border-color: #a7f3d0;
    }

    .badge-warn {
      color: #92400e;
      background: #fffbeb;
      border-color: #fcd34d;
    }

    .badge-bad {
      color: #991b1b;
      background: #fef2f2;
      border-color: #fecaca;
    }

    .badge-off {
      color: #374151;
      background: #f3f4f6;
      border-color: #e5e7eb;
    }

    .table-scroll {
      /* overflow-x: auto;  Removed to prevent scroll */
      width: 100%;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }

    .table-scroll table {
      /* min-width: 1680px; Removed to fit screen */
      width: 100%;
      table-layout: fixed;
      /* Fix column widths */
    }

    .table-scroll th,
    .table-scroll td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 10px 14px;
      border-bottom: 1px solid #f3f4f6;
    }

    .table-scroll td.col-title {
      white-space: nowrap;
      /* Change from normal to nowrap to enforce truncation */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table-scroll td.col-error {
      white-space: normal;
      word-break: break-all;
      /* Allow errors to wrap if needed, or keep truncated same as others */
    }

    /* Toast Notification System */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      min-width: 280px;
    }

    .toast-success {
      background: #059669;
      color: white;
    }

    .toast-error {
      background: #dc2626;
      color: white;
    }

    .toast-warning {
      background: #f59e0b;
      color: white;
    }

    .toast-info {
      background: #2563eb;
      color: white;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Tab Navigation System */
    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .tabs button {
      padding: 10px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .tabs button:hover {
      color: #2563eb;
      background: #eff6ff;
    }

    .tabs button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Quick Add Section */
    .quick-add {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
    }

    .quick-add input {
      flex: 1;
      min-width: 300px;
    }

    /* Improved Table - Simplified Columns */
    .simplified-table {
      min-width: 1200px;
    }

    .expand-btn {
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
      padding: 4px;
      color: #2563eb;
    }

    .expand-btn:hover {
      background: #eff6ff;
      border-radius: 4px;
    }

    .detail-row {
      display: none;
      background: #f9fafb;
    }

    .detail-row.show {
      display: table-row;
    }

    .detail-content {
      padding: 12px;
      border-left: 3px solid #2563eb;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-label {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
    }

    .detail-value {
      font-size: 13px;
      color: #111827;
    }

    /* Icon buttons */
    .icon-btn {
      background: none;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s;
    }

    .icon-btn:hover {
      transform: scale(1.2);
    }

    /* Pagination */
    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-top: 16px;
      padding: 12px;
    }

    .page-btn {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .page-btn:hover:not(:disabled) {
      background: #f3f4f6;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: #2563eb;
      transition: width 0.3s ease;
    }

    /* Dropdown Menu */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dropdown-toggle::after {
      content: 'â–¼';
      font-size: 10px;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 160px;
      z-index: 1000;
      margin-top: 4px;
    }

    .btn-icon {
      padding: 4px 6px;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 26px;
    }

    .row-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }

    .dropdown-item:hover {
      background: #f3f4f6;
    }

    .dropdown-item.danger {
      color: #dc2626;
    }

    .dropdown-item.danger:hover {
      background: #fef2f2;
    }

    /* Compact Action Buttons */
    .action-menu {
      position: relative;
    }

    .action-menu-toggle {
      padding: 4px 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      border-radius: 6px;
    }

    .action-menu-toggle:hover {
      background: #f3f4f6;
    }
  </style>
</head>

<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <div class="wrap">
    <h1>RSS Source Admin</h1>
    <div class="muted">This page requires <code>?token=...</code> or <code>X-Admin-Token</code>.</div>

    <!-- Tab Navigation -->
    <div class="tabs" style="margin-top: 20px;">
      <button data-tab="catalog" class="active">ğŸ“‹ RSS æºåˆ—è¡¨</button>
      <button data-tab="custom-api">ğŸ”Œ API æº</button>
      <button data-tab="custom-html">ğŸŒ HTML æº</button>
      <button data-tab="newsnow">ğŸ“Š çƒ­æ¦œæº</button>
      <button data-tab="import">ğŸ“¥ å¯¼å…¥ç®¡ç†</button>
      <button data-tab="requests">ğŸ“¨ è¯·æ±‚å®¡æ ¸</button>
      <button data-tab="rules">âš™ï¸ è§„åˆ™é…ç½®</button>
      <button data-tab="usage">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</button>
    </div>

    <!-- Tab Panel: Rules Configuration -->
    <div class="tab-panel" data-panel="rules">
      <h2>Morning Brief Rules</h2>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">
          Edit <code>morning_brief_rules_v1</code> (JSON). Changes take effect immediately.
        </div>
        <textarea id="mb-rules-text"
          style="width:100%;min-height:160px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;"
          placeholder='{"enabled":true,"drop_published_at_zero":true,"topic_keywords":["ai"],"depth_keywords":[],"negative_hard":[],"negative_soft":[],"source_scores":{},"source_decay":{"second":0.6,"third_plus":0.3},"overrides":{"force_top":[],"force_blacklist":[]}}'></textarea>
        <div style="height:10px;"></div>
        <div class="row" style="align-items:center;">
          <button class="btn btn-primary" onclick="loadMorningBriefRules()">Load</button>
          <button class="btn btn-primary" onclick="validateMorningBriefRules()">Validate</button>
          <button class="btn btn-primary" onclick="saveMorningBriefRules()">Save</button>
          <span class="muted" id="mb-rules-status"></span>
        </div>
      </div>
    </div>

    <!-- Tab Panel: Import Management -->
    <div class="tab-panel" data-panel="import">
      <h2>CSV Paste Import</h2>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">
          Paste CSV rows and import into <code>rss_sources</code>.
        </div>
        <div class="muted" style="margin-bottom:8px;">
          Supported formats:
          <div style="margin-top:4px;">
            <div><b>URL-only</b>: one RSS URL per line (Preview will autofill fields)</div>
            <div><b>Headerless fixed-order (8/9 columns)</b>:
              name,url,seed_last_updated,category,feed_type,country,language,source[,added_at]</div>
            <div><b>Chinese headers</b>: æ ‡é¢˜,è®¢é˜…åœ°å€,æœ€åæ›´æ–°,åˆ†ç±»,ç±»å‹,å›½å®¶,è¯­è¨€,æ¥æº,æ·»åŠ æ—¶é—´</div>
          </div>
        </div>
        <textarea id="csv-import-text"
          style="width:100%;min-height:120px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;"
          placeholder="Example (URL-only):\nhttps://blog.samaltman.com/posts.atom\nhttps://blog.google/technology/ai/rss/\n\nExample (CSV):\nGoogle Blog AI,https://blog.google/technology/ai/rss/,,äººå·¥æ™ºèƒ½,åˆ†ç±»è®¢é˜…,ç¾å›½,è‹±æ–‡,æ‰‹åŠ¨æ·»åŠ ,2026-01-09 10:00"></textarea>
        <div style="height:10px;"></div>
        <div class="row" style="align-items:center;">
          <button class="btn btn-primary" onclick="previewCsvImport()">Preview</button>
          <button class="btn btn-primary" onclick="commitCsvImport()">Commit</button>
          <button class="btn btn-danger" onclick="bulkDisableByUrls()">Bulk Disable (From URLs)</button>
          <button class="btn btn-primary" onclick="bulkEnableCatalogAll()">Bulk Enable Catalog (All)</button>
          <button class="btn btn-danger" onclick="bulkDisableCatalogAll()">Bulk Disable Catalog (All)</button>
          <button class="btn btn-primary" onclick="exportCatalogAll()">Export Catalog (All)</button>
          <span class="muted" id="csv-import-status"></span>
        </div>
        <div style="height:10px;"></div>
        <div id="csv-import-result"></div>
      </div>
    </div>

    <!-- Tab Panel: Request Review -->
    <div class="tab-panel" data-panel="requests">
      <h2>Pending Requests</h2>
      <div class="card">
        {% if pending and pending|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Note</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in pending %}
              <tr>
                <td>{{ r.id }}</td>
                <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
                <td style="max-width:520px; word-break:break-all;">
                  <div><b>{{ r.host }}</b></div>
                  <div class="muted">{{ r.url }}</div>
                </td>
                <td style="max-width:280px; word-break:break-word;">{{ r.note }}</td>
                <td>
                  <div class="row">
                    <input type="text" id="name-{{ r.id }}" placeholder="Source name (optional)" />
                    <button class="btn btn-primary" data-id="{{ r.id }}"
                      onclick="approveReq(this.dataset.id)">Approve</button>
                    <input type="text" id="reason-{{ r.id }}" placeholder="Reject reason" />
                    <button class="btn btn-danger" data-id="{{ r.id }}"
                      onclick="rejectReq(this.dataset.id)">Reject</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="muted">No pending requests.</div>
        {% endif %}
      </div>

      <h2>Rejected Requests</h2>
      <div class="card">
        {% if rejected and rejected|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Reason</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rejected %}
              <tr>
                <td>{{ r.id }}</td>
                <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
                <td style="max-width:520px; word-break:break-all;">
                  <div><b>{{ r.host }}</b></div>
                  <div class="muted">{{ r.url }}</div>
                </td>
                <td style="max-width:280px; word-break:break-word;">{{ r.reason }}</td>
                <td>
                  <div class="row">
                    <button class="btn" data-id="{{ r.id }}" onclick="reopenReq(this.dataset.id)">Reopen</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="muted">No rejected requests.</div>
        {% endif %}
      </div>
    </div>

    <!-- Tab Panel: Custom Sources API -->
    <div class="tab-panel" data-panel="custom-api">
      <h2>API æºåˆ—è¡¨ (Unified Ingestion)</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <input type="text" id="custom-api-search" placeholder="Search ID or Name" style="flex: 1; max-width: 300px;"
            oninput="filterCustomSources('api')" />
          <button class="btn btn-sm" onclick="bulkEnableCustom('api')">Bulk Enable</button>
          <button class="btn btn-sm btn-danger" onclick="bulkDisableCustom('api')">Bulk Disable</button>
          <button class="btn btn-primary" onclick="openEditCustomSourceModal('api')">â• æ·»åŠ  API æº</button>
        </div>

        <div class="table-scroll">
          <table id="custom-api-table">
            <thead>
              <tr>
                <th style="width:30px;"><input type="checkbox" id="custom-api-select-all"
                    onclick="toggleSelectAllCustom('api')"></th>
                <th style="width:40px;"></th>
                <th style="width:60px;">Status</th>
                <th style="width:280px;">Name / URL</th>
                <th style="width:100px;">Category</th>
                <th style="width:140px;">Time</th>
                <th style="width:120px;">Stats</th>
                <th style="width:100px;">Latest</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody id="custom-api-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab Panel: Custom Sources HTML -->
    <div class="tab-panel" data-panel="custom-html">
      <h2>HTML æºåˆ—è¡¨ (Unified Ingestion)</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <input type="text" id="custom-html-search" placeholder="Search ID or Name" style="flex: 1; max-width: 300px;"
            oninput="filterCustomSources('html')" />
          <button class="btn btn-sm" onclick="bulkEnableCustom('html')">Bulk Enable</button>
          <button class="btn btn-sm btn-danger" onclick="bulkDisableCustom('html')">Bulk Disable</button>
          <button class="btn btn-primary" onclick="openEditCustomSourceModal('html')">â• æ·»åŠ  HTML æº</button>
        </div>

        <div class="table-scroll">
          <table id="custom-html-table">
            <thead>
              <tr>
                <th style="width:30px;"><input type="checkbox" id="custom-html-select-all"
                    onclick="toggleSelectAllCustom('html')"></th>
                <th style="width:40px;"></th>
                <th style="width:60px;">Status</th>
                <th style="width:280px;">Name / URL</th>
                <th style="width:100px;">Category</th>
                <th style="width:140px;">Time</th>
                <th style="width:120px;">Stats</th>
                <th style="width:100px;">Latest</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody id="custom-html-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab Panel: NewsNow Platforms -->
    <div class="tab-panel" data-panel="newsnow">
      <h2>çƒ­æ¦œæºç®¡ç† (NewsNow API)</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px; gap:10px;">
          <input type="text" id="newsnow-search" placeholder="æœç´¢å¹³å°..." style="flex: 1; max-width: 300px;"
            oninput="filterNewsNow()" />
          <button class="btn" onclick="migrateNewsNowFromConfig()">ğŸ“¥ ä»é…ç½®æ–‡ä»¶å¯¼å…¥</button>
          <button class="btn btn-primary" onclick="showReloadInstructions()">ğŸ”„ é‡æ–°åŠ è½½é…ç½®</button>
          <button class="btn btn-primary" onclick="openNewsNowModal()">â• æ·»åŠ å¹³å°</button>
        </div>

        <div class="table-scroll">
          <table id="newsnow-table">
            <thead>
              <tr>
                <th style="width:120px;">ID</th>
                <th style="width:160px;">åç§°</th>
                <th style="width:100px;">åˆ†ç±»</th>
                <th style="width:80px;">çŠ¶æ€</th>
                <th style="width:140px;">æœ€åè·å–</th>
                <th style="width:180px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="newsnow-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit NewsNow Platform Modal -->
    <div id="newsnow-modal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
      <div class="card"
        style="width:400px; max-width:90%; padding:20px; display:flex; flex-direction:column; gap:12px;">
        <h3>ç¼–è¾‘çƒ­æ¦œå¹³å°</h3>
        <input type="hidden" id="newsnow-edit-original-id" />

        <div class="row">
          <label style="width:80px;">ID:</label>
          <input type="text" id="newsnow-edit-id" placeholder="weibo" style="flex:1;" />
        </div>
        <div class="row">
          <label style="width:80px;">åç§°:</label>
          <input type="text" id="newsnow-edit-name" placeholder="å¾®åš" style="flex:1;" />
        </div>
        <div class="row">
          <label style="width:80px;">åˆ†ç±»:</label>
          <select id="newsnow-edit-category" style="flex:1;">
            <option value="">æœªåˆ†ç±»</option>
            <option value="ç»¼åˆæ–°é—»">ç»¼åˆæ–°é—»</option>
            <option value="è´¢ç»æŠ•èµ„">è´¢ç»æŠ•èµ„</option>
            <option value="ç¤¾äº¤å¨±ä¹">ç¤¾äº¤å¨±ä¹</option>
            <option value="ç§‘æŠ€">ç§‘æŠ€</option>
          </select>
        </div>
        <div class="row">
          <label style="width:80px;">æ’åº:</label>
          <input type="number" id="newsnow-edit-order" value="0" style="width:80px;" />
        </div>
        <div class="row">
          <label style="width:80px;">å¯ç”¨:</label>
          <input type="checkbox" id="newsnow-edit-enabled" checked />
        </div>

        <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
          <button class="btn" onclick="closeNewsNowModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveNewsNowPlatform()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- Fully cleaned up duplicate modal -->

    <!-- Tab Panel: RSS Source Catalog (Active by default) -->
    <div class="tab-panel active" data-panel="catalog">
      <!-- Quick Add RSS -->
      <div class="quick-add">
        <input type="text" id="quick-add-url" placeholder="è¾“å…¥ RSS URL å¿«é€Ÿæ·»åŠ  (ä¸€é”® Preview â†’ Commit â†’ Warmup)" />
        <button class="btn btn-primary" onclick="quickAddRss()">â• å¿«é€Ÿæ·»åŠ </button>
      </div>

      <h2>Catalog (All)</h2>
      <div class="card" id="rss-catalog-all">
        <div class="row" style="align-items:center; margin-bottom:10px;">
          <input type="text" id="catalog-search" placeholder="Search" style="flex: 1; max-width: 300px;" />

          <!-- Quick Filter Buttons -->
          <button class="btn" data-filter="ALL" onclick="setCatalogFilter('ALL')" title="æ˜¾ç¤ºå…¨éƒ¨">
            å…¨éƒ¨ ({{ sources|length }})
          </button>
          <button class="btn btn-primary" data-filter="ABNORMAL" onclick="setCatalogFilter('ABNORMAL')" title="å¼‚å¸¸çŠ¶æ€">
            ğŸ”´ å¼‚å¸¸ ({{ health_abnormal_count or 0 }})
          </button>

          <!-- Filter Dropdown -->
          <div class="dropdown">
            <button class="btn dropdown-toggle" onclick="toggleDropdown('filter-dropdown')">æ›´å¤šç­›é€‰</button>
            <div class="dropdown-menu" id="filter-dropdown">
              <button class="dropdown-item" onclick="setCatalogFilter('OK'); closeDropdown('filter-dropdown')">
                âœ… æ­£å¸¸ (OK) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('OK', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('FAIL'); closeDropdown('filter-dropdown')">
                âŒ å¤±è´¥ (FAIL) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('FAIL', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('BACKOFF'); closeDropdown('filter-dropdown')">
                â¸ï¸ é€€é¿ (BACKOFF) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('BACKOFF', 0)
                  }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('NEVER_TRIED'); closeDropdown('filter-dropdown')">
                ğŸ†• æœªå°è¯• <span class="muted" style="float:right;">{{ (health_kpi or {}).get('NEVER_TRIED', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('OK_EMPTY'); closeDropdown('filter-dropdown')">
                ğŸ“­ ç©º (OK_EMPTY) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('OK_EMPTY', 0)
                  }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('STALE'); closeDropdown('filter-dropdown')">
                ğŸ•’ é•¿æœŸä¸æ›´æ–° <span class="muted" style="float:right;">{{ (health_kpi or {}).get('STALE', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('DISABLED'); closeDropdown('filter-dropdown')">
                â›” å·²ç¦ç”¨ <span class="muted" style="float:right;">{{ (health_kpi or {}).get('DISABLED', 0) }}</span>
              </button>
            </div>
          </div>

          <div style="flex:1"></div>

          <!-- Bulk Actions Dropdown -->
          <div class="row" style="align-items:center;" id="bulk-actions-toolbar">
            <span class="muted" id="bulk-selection-info" style="margin-right:8px;">Selected: 0</span>
            <div class="dropdown">
              <button class="btn dropdown-toggle" onclick="toggleDropdown('bulk-dropdown')">æ‰¹é‡æ“ä½œ</button>
              <div class="dropdown-menu" id="bulk-dropdown">
                <button class="dropdown-item" onclick="bulkWarmupSelected(); closeDropdown('bulk-dropdown')">âš¡ï¸ æ‰¹é‡æŠ“å–
                  (Warmup)</button>
                <button class="dropdown-item" onclick="bulkClearBackoffAndRetry(); closeDropdown('bulk-dropdown')">ğŸ”„
                  æ¸…é™¤é€€é¿å¹¶é‡è¯•</button>
                <button class="dropdown-item" onclick="bulkSetEnabledSelected(1); closeDropdown('bulk-dropdown')">âœ…
                  æ‰¹é‡å¯ç”¨</button>
                <button class="dropdown-item" onclick="bulkSetEnabledSelected(0); closeDropdown('bulk-dropdown')">â›”
                  æ‰¹é‡ç¦ç”¨</button>
                <div style="border-top:1px solid #e5e7eb; margin:4px 0;"></div>
                <button class="dropdown-item danger" onclick="bulkDeleteSelected(); closeDropdown('bulk-dropdown')">ğŸ—‘ï¸
                  æ‰¹é‡åˆ é™¤</button>
              </div>
            </div>
          </div>
        </div>



        {% if sources and sources|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" id="select-all-visible"
                    onclick="toggleSelectAllVisible(this)" /></th>
                <th style="width:40px;"></th> <!-- Expand button column -->
                <th style="width:90px;">Status</th>
                <th style="width:240px;">Name / URL</th>
                <th style="width:110px;">Category</th>
                <th style="width:110px;">Time</th> <!-- Added / Updated -->
                <th style="width:90px;">Stats</th> <!-- Entries / Fail -->
                <th style="width:100px;">Latest</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in sources %}
              <!-- Main Row -->
              <tr data-health="{{ s.health_state or '' }}" data-abnormal="{{ 1 if s.is_abnormal else 0 }}"
                data-search="{{ (s.name ~ ' ' ~ s.url ~ ' ' ~ s.host ~ ' ' ~ (s.category or '') ~ ' ' ~ (s.source or '') )|lower }}">
                <td>
                  <input type="checkbox" class="rss-src-select" data-id="{{ s.id }}" onclick="handleRowSelect(this)" />
                </td>
                <td>
                  <button class="expand-btn" onclick="toggleDetail(this)" data-id="{{ s.id }}">â–¶</button>
                </td>
                <td>
                  <!-- Compact Status -->
                  {% set hs = s.health_state or '' %}
                  {% if hs == 'OK' %}
                  <span class="badge badge-ok">OK</span>
                  {% elif hs in ['FAIL'] %}
                  <span class="badge badge-bad">FAIL</span>
                  {% elif hs in ['BACKOFF','NEVER_TRIED','OK_EMPTY','STALE'] %}
                  <span class="badge badge-warn">{{ hs }}</span>
                  {% elif hs == 'DISABLED' %}
                  <span class="badge badge-off">DISABLED</span>
                  {% else %}
                  <span class="badge badge-off">{{ hs }}</span>
                  {% endif %}
                </td>
                <td style="max-width:240px;" class="col-title">
                  <div style="font-weight:600; color:#111827; font-size:13px;">{{ s.name or s.host }}</div>
                  <div class="muted"
                    style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:12px;"
                    title="{{ s.url }}">
                    <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer"
                      style="text-decoration:none; color:inherit;">{{ s.url }}</a>
                  </div>
                  <div
                    style="margin-top:2px; font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#4b5563;">
                    <span
                      style="font-weight:500; font-family:monospace; background:#f3f4f6; padding:1px 3px; border-radius:3px;">{{
                      s.feed_type }}</span>
                    <span style="margin:0 2px;">Â·</span> {{ s.country }} / {{ s.language }}
                  </div>
                  <div
                    style="margin-top:1px; font-size:10px; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                    title="ID: {{ s.id }} | Source: {{ s.source }}">
                    #{{ s.id }} <span style="margin:0 2px;">Â·</span> {{ s.source }}
                  </div>
                </td>
                <td>{{ s.category }}</td>
                <td>
                  <div class="muted" style="font-size:11px;" title="Added: {{ s.added_time }}">Add: {{
                    s.added_time|truncate(10, True, '') }}</div>
                  <div class="muted" style="font-size:11px;" title="Last Updated: {{ s.last_updated_time }}">Upd: {{
                    s.last_updated_time|truncate(10, True, '') }}</div>
                </td>
                <td>
                  <div style="font-size:12px;">Entries: {{ s.entries_count }}</div>
                  {% if s.fail_count and s.fail_count > 0 %}
                  <div style="font-size:12px; color:#dc2626;">Fail: {{ s.fail_count }}</div>
                  {% else %}
                  <div style="font-size:12px;" class="muted">Fail: 0</div>
                  {% endif %}

                  {% if s.backoff_until_time %}
                  <div style="font-size:11px; color:#d97706; margin-top:2px; white-space:normal; word-break:break-all;"
                    title="Backoff Until: {{ s.backoff_until_time }}">
                    Wait: {{ s.backoff_until_time }}
                  </div>
                  {% endif %}

                  {% if s.last_error_reason %}
                  <div style="font-size:11px; color:#dc2626; margin-top:2px; white-space:normal; word-break:break-all;"
                    title="{{ s.last_error_reason }}">
                    Err: {{ s.last_error_reason }}
                  </div>
                  {% endif %}
                </td>
                <td>
                  <div title="{{ s.latest_entry }}">
                    {{ s.latest_entry_time|truncate(10, True, '') if s.latest_entry_time else '-' }}
                  </div>
                </td>
                <td>
                  <div class="row-actions">
                    <button class="btn btn-icon" title="Edit" onclick="openEditModal(this)" data-id="{{ s.id }}"
                      data-name="{{ s.name }}" data-url="{{ s.url }}" data-category="{{ s.category }}"
                      data-feed-type="{{ s.feed_type }}" data-country="{{ s.country }}" data-language="{{ s.language }}"
                      data-source="{{ s.source }}" data-scrape-rules="{{ s.scrape_rules }}"
                      data-enabled="{{ 1 if s.enabled else 0 }}">âœï¸</button>
                    <button class="btn btn-primary btn-icon" title="Warmup" onclick="warmupSource(this)"
                      data-id="{{ s.id }}">âš¡</button>
                    <button class="btn btn-icon" title="Clear Backoff" onclick="clearBackoffAndRetry(this)"
                      data-id="{{ s.id }}">ğŸ”„</button>
                    <button class="btn btn-icon {{ 'btn-danger' if s.enabled else '' }}"
                      title="{{ 'Disable' if s.enabled else 'Enable' }}" onclick="toggleSourceEnabled(this)"
                      data-id="{{ s.id }}" data-enabled="{{ 1 if s.enabled else 0 }}">
                      {{ 'â›”' if s.enabled else 'âœ…' }}
                    </button>
                    <button class="btn btn-danger btn-icon" title="Delete" onclick="deleteSource(this)"
                      data-id="{{ s.id }}" data-name="{{ s.name }}">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>

              <!-- Detail Row -->
              <tr class="detail-row" style="display:none;">
                <td colspan="9" style="padding:0;">
                  <div class="detail-content"
                    style="padding:10px 14px; background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                    <div id="detail-entries-{{ s.id }}" class="detail-entries-container">
                      <div class="muted">Loading entries...</div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="muted">Catalog is empty.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tab Panel: Usage Statistics -->
    <div class="tab-panel" data-panel="usage">
      <h2>RSS Usage</h2>
      <div class="card">
        <div class="row" style="align-items:center;">
          <input type="text" id="usage-days" value="7" />
          <button class="btn btn-primary" onclick="loadUsage()">Load</button>
          <span class="muted" id="usage-status"></span>
        </div>
        <div style="height:10px;"></div>
        <div class="kpi" id="usage-kpi" style="display:none;"></div>
        <div style="height:10px;"></div>
        <div id="usage-table"></div>
      </div>
    </div>

    <script>
      const token = document.querySelector('meta[name="admin-token"]').content;
      console.log("Admin Token:", token);

      async function fetchWithAuth(url, options = {}) {
        const headers = options.headers || {};
        headers['X-Admin-Token'] = token;
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401) {
          // simple handling
          console.error("401 Unauthorized");
        }
        return res;
      }

      // ============================================================================
      // Toast Notification System
      // ============================================================================
      function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = 'fadeOut 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      function showProgress(current, total, message) {
        const msg = `${message} (${current}/${total})`;
        showToast(msg, 'info', 1500);
      }

      // ============================================================================
      // Tab System
      // ============================================================================
      function initTabs() {
        const tabButtons = document.querySelectorAll('.tabs button[data-tab]');
        const tabPanels = document.querySelectorAll('.tab-panel[data-panel]');

        // Tab switching
        tabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetPanel = btn.dataset.tab;

            // Update button states
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update panel states
            tabPanels.forEach(panel => {
              if (panel.dataset.panel === targetPanel) {
                panel.classList.add('active');
              } else {
                panel.classList.remove('active');
              }
            });

            // Load data if switching to specific tabs
            if (targetPanel === 'custom-api') loadCustomSources('api');
            if (targetPanel === 'custom-html') loadCustomSources('html');
            if (targetPanel === 'newsnow') loadNewsNowPlatforms();

            // Update URL hash
            window.location.hash = targetPanel;
          });
        });

        // Restore tab from URL hash on load
        const hash = window.location.hash.substring(1);
        if (hash) {
          const targetBtn = document.querySelector(`button[data-tab="${hash}"]`);
          if (targetBtn) {
            targetBtn.click();
          }
        }
      }

      // ============================================================================
      // Quick Add RSS Function
      // ============================================================================
      async function quickAddRss() {
        const input = document.getElementById('quick-add-url');
        const url = (input?.value || '').trim();

        if (!url) {
          showToast('è¯·è¾“å…¥ RSS URL', 'warning');
          return;
        }

        if (!token) {
          showToast('ç¼ºå°‘ admin token', 'error');
          return;
        }

        try {
          // Step 1: Preview
          showToast('æ­£åœ¨é¢„è§ˆ...', 'info');
          const previewResp = await fetch(`/api/admin/rss-sources/import-csv/preview?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ csv_text: url })
          });
          const previewData = await previewResp.json().catch(() => ({}));

          if (!previewResp.ok) {
            throw new Error(previewData?.detail || 'Preview å¤±è´¥');
          }

          const previewHash = previewData?.preview_hash || '';
          let csvText = url;

          // Use autofill result if available
          const autofillText = previewData?.autofill_csv_text || '';
          const autofillHash = previewData?.autofill_preview_hash || '';
          if (autofillText && autofillHash) {
            csvText = autofillText;
            showToast('å·²è‡ªåŠ¨å¡«å……å…ƒæ•°æ®', 'success', 1500);
          }

          const finalHash = autofillHash || previewHash;

          // Step 2: Commit
          showToast('æ­£åœ¨æ·»åŠ åˆ°æ•°æ®åº“...', 'info');
          const commitResp = await fetch(`/api/admin/rss-sources/import-csv/commit?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ csv_text: csvText, preview_hash: finalHash })
          });
          const commitData = await commitResp.json().catch(() => ({}));

          if (!commitResp.ok) {
            throw new Error(commitData?.detail || 'Commit å¤±è´¥');
          }

          showToast('âœ… æ·»åŠ æˆåŠŸï¼æ­£åœ¨æŠ“å–å†…å®¹...', 'success');

          // Clear input
          if (input) input.value = '';

          // Step 3: Warmup (optional, best effort)
          try {
            // Extract source_ids from preview sample (if available)
            const sample = previewData?.sample || [];
            if (sample.length > 0) {
              // Trigger warmup for newly added sources
              // We'll reload the page to see the new source
              setTimeout(() => location.reload(), 1500);
            } else {
              setTimeout(() => location.reload(), 1000);
            }
          } catch (e) {
            setTimeout(() => location.reload(), 1000);
          }

        } catch (error) {
          showToast(`æ·»åŠ å¤±è´¥: ${error.message}`, 'error', 5000);
        }
      }

      // Initialize tabs on load
      document.addEventListener('DOMContentLoaded', initTabs);

      // ============================================================================
      // Dropdown & Expand System
      // ============================================================================
      function toggleDropdown(id) {
        const menu = document.getElementById(id);
        const allMenus = document.querySelectorAll('.dropdown-menu');
        allMenus.forEach(m => {
          if (m.id !== id) m.classList.remove('show');
        });
        if (menu) menu.classList.toggle('show');
      }

      function closeDropdown(id) {
        const menu = document.getElementById(id);
        if (menu) menu.classList.remove('show');
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }
      });

      async function toggleDetail(btn) {
        const row = btn.closest('tr');
        const detailRow = row.nextElementSibling;
        const sourceId = btn.dataset.id;

        if (detailRow && detailRow.classList.contains('detail-row')) {
          // Check visibility by style or class. We use inline style now.
          const isHidden = detailRow.style.display === 'none' || detailRow.style.display === '';

          if (isHidden) {
            // SHOW
            detailRow.style.display = 'table-row';
            btn.textContent = 'â–¼';

            // Load content if needed
            const container = document.getElementById(`detail-entries-${sourceId}`);
            if (container && !container.dataset.loaded) {
              try {
                const resp = await fetch(`/api/admin/rss-sources/${sourceId}/entries?token=${encodeURIComponent(token)}`);
                const payload = await resp.json();

                // Handle potential error
                if (!resp.ok) throw new Error(payload.detail || 'Fetch failed');

                const entries = payload.entries || [];
                if (entries.length > 0) {
                  const items = entries.map(e => `
                      <div style="padding:4px 0; border-bottom:1px solid #e5e7eb; font-size:12px; display:flex; justify-content:space-between; align-items:center;">
                          <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:75%;">
                              <a href="${_escapeHtml(e.url)}" target="_blank" rel="noopener noreferrer" style="color:#2563eb; text-decoration:none; font-weight:500;">
                                  ${_escapeHtml(e.title || 'No Title')}
                              </a>
                          </div>
                          <div class="muted" style="font-size:11px; white-space:nowrap; margin-left:8px;">
                              ${_escapeHtml(e.time)}
                          </div>
                      </div>
                   `).join('');
                  container.innerHTML = `<div style="padding:4px 0;">
                      <div style="font-size:11px; font-weight:700; color:#4b5563; margin-bottom:6px; letter-spacing:0.5px;">LATEST 10 ENTRIES</div>
                      ${items}
                   </div>`;
                } else {
                  container.innerHTML = '<div class="muted" style="font-size:12px; padding:4px;">No entries found.</div>';
                }
                container.dataset.loaded = "true";
              } catch (e) {
                container.innerHTML = `<div style="color:#dc2626; font-size:12px; padding:4px;">Error loading entries: ${_escapeHtml(String(e))}</div>`;
              }
            }
          } else {
            // HIDE
            detailRow.style.display = 'none';
            btn.textContent = 'â–¶';
          }
        }
      }

      function handleRowSelect(checkbox) {
        updateBulkSelectionInfo();
      }

      let _catalogFilter = 'ABNORMAL';

      function _getCatalogContainer() {
        return document.getElementById('rss-catalog-all');
      }

      function _getCatalogRows() {
        const c = _getCatalogContainer();
        if (!c) return [];
        return Array.from(c.querySelectorAll('table tbody tr[data-health]'));
      }

      function _rowIsVisible(tr) {
        if (!tr) return false;
        const v = String(tr.style?.display || '');
        return v !== 'none';
      }

      function getSelectedSourceIds() {
        const ids = [];
        const rows = _getCatalogRows();
        for (const tr of rows) {
          const cb = tr.querySelector('input.rss-src-select');
          if (!cb) continue;
          if (cb.checked) {
            const sid = String(cb.dataset?.id || '').trim();
            if (sid) ids.push(sid);
          }
        }
        return ids;
      }

      function updateBulkSelectionInfo() {
        const el = document.getElementById('bulk-selection-info');
        if (!el) return;
        const ids = getSelectedSourceIds();
        el.textContent = `Selected: ${ids.length}`;

        const head = document.getElementById('select-all-visible');
        if (head) {
          const rows = _getCatalogRows().filter(r => _rowIsVisible(r));
          let visibleCount = 0;
          let checkedCount = 0;
          for (const tr of rows) {
            const cb = tr.querySelector('input.rss-src-select');
            if (!cb) continue;
            visibleCount += 1;
            if (cb.checked) checkedCount += 1;
          }
          head.checked = visibleCount > 0 && checkedCount === visibleCount;
        }
      }

      function toggleSelectAllVisible(head) {
        const checked = !!head?.checked;
        const rows = _getCatalogRows();
        for (const tr of rows) {
          if (!_rowIsVisible(tr)) continue;
          const cb = tr.querySelector('input.rss-src-select');
          if (!cb) continue;
          cb.checked = checked;
        }
        updateBulkSelectionInfo();
      }

      async function _bulkPostJson(url, payload) {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify(payload || {})
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.detail || `Failed (${resp.status})`);
        return data;
      }

      async function _warmupIds(ids, askConfirm) {
        const list = Array.isArray(ids) ? ids : [];
        if (!list.length) { alert('No rows selected.'); return; }
        if (!token) { alert('Missing admin token. Use ?token=...'); return; }
        if (askConfirm) {
          const ok = confirm(`æ‰¹é‡æŠ“å–é€‰ä¸­æºï¼Ÿ\ncount=${list.length}`);
          if (!ok) return;
        }
        _setCsvImportStatus(`æ‰¹é‡æŠ“å–ä¸­... count=${list.length}`);

        const chunk = 25;
        let queued = 0;
        for (let i = 0; i < list.length; i += chunk) {
          const part = list.slice(i, i + chunk);
          const resp = await fetch('/api/rss-sources/warmup?wait_ms=1200', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ source_ids: part, priority: 'high' })
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);
          queued += Number(payload?.queued || 0);
        }
        _setCsvImportStatus(`æ‰¹é‡æŠ“å–å·²è§¦å‘: queued=${queued}`);
      }

      async function bulkWarmupSelected() {
        const ids = getSelectedSourceIds();
        await _warmupIds(ids, true);
      }

      async function bulkClearBackoffAndRetry() {
        const ids = getSelectedSourceIds();
        if (!ids.length) { alert('No rows selected.'); return; }
        if (!token) { alert('Missing admin token. Use ?token=...'); return; }
        const ok = confirm(`æ‰¹é‡æ¸…é™¤é€€é¿å¹¶é‡è¯•æŠ“å–ï¼Ÿ\ncount=${ids.length}`);
        if (!ok) return;
        _setCsvImportStatus(`æ‰¹é‡æ¸…é€€é¿ä¸­... count=${ids.length}`);

        await _bulkPostJson('/api/admin/rss-sources/clear-backoff-bulk', { source_ids: ids });
        await _warmupIds(ids, false);
      }

      async function bulkSetEnabledSelected(enabled) {
        const ids = getSelectedSourceIds();
        if (!ids.length) { alert('No rows selected.'); return; }
        if (!token) { alert('Missing admin token. Use ?token=...'); return; }
        const label = enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
        const ok = confirm(`æ‰¹é‡${label}é€‰ä¸­æºï¼Ÿ\ncount=${ids.length}`);
        if (!ok) return;
        _setCsvImportStatus(`æ‰¹é‡${label}ä¸­... count=${ids.length}`);
        await _bulkPostJson('/api/admin/rss-sources/set-enabled-bulk', { source_ids: ids, enabled: enabled ? 1 : 0 });
        _setCsvImportStatus(`æ‰¹é‡${label}å®Œæˆ: count=${ids.length}`);
        try { window.location.reload(); } catch (e) { }
      }

      async function bulkDeleteSelected() {
        const ids = getSelectedSourceIds();
        if (!ids.length) { alert('No rows selected.'); return; }
        if (!token) { alert('Missing admin token. Use ?token=...'); return; }
        const ok = confirm(`ç¡®è®¤æ‰¹é‡åˆ é™¤é€‰ä¸­æºï¼Ÿ\ncount=${ids.length}\n\nå°†åŒæ—¶åˆ é™¤ entriesï¼Œå¹¶æ¸…ç†è®¢é˜…å¼•ç”¨ã€‚`);
        if (!ok) return;
        _setCsvImportStatus(`æ‰¹é‡åˆ é™¤ä¸­... count=${ids.length}`);
        await _bulkPostJson('/api/admin/rss-sources/delete-bulk', { source_ids: ids });
        _setCsvImportStatus(`æ‰¹é‡åˆ é™¤å®Œæˆ: count=${ids.length}`);
        try { window.location.reload(); } catch (e) { }
      }

      function _catalogFilterMatch(row, filter) {
        const f = String(filter || '').trim().toUpperCase() || 'ALL';
        const health = String(row?.dataset?.health || '').trim().toUpperCase();
        const abnormal = String(row?.dataset?.abnormal || '').trim() === '1';

        if (f === 'ALL') return true;
        if (f === 'ABNORMAL') return abnormal;
        return health === f;
      }

      function _catalogSearchMatch(row, q) {
        const query = String(q || '').trim().toLowerCase();
        if (!query) return true;
        const hay = String(row?.dataset?.search || '').toLowerCase();
        return hay.includes(query);
      }

      function applyCatalogFilter() {
        const q = document.getElementById('catalog-search')?.value || '';
        const rows = _getCatalogRows();
        for (const tr of rows) {
          const ok = _catalogFilterMatch(tr, _catalogFilter) && _catalogSearchMatch(tr, q);
          tr.style.display = ok ? '' : 'none';
        }

        const c = _getCatalogContainer();
        const btns = c ? c.querySelectorAll('button[data-filter]') : document.querySelectorAll('button[data-filter]');
        for (const b of btns) {
          const f = String(b?.dataset?.filter || '').trim().toUpperCase();
          if (!f) continue;
          if (f === String(_catalogFilter || '').trim().toUpperCase()) {
            b.classList.add('btn-primary');
          } else {
            b.classList.remove('btn-primary');
          }
        }

        updateBulkSelectionInfo();
      }

      async function deleteSource(btn) {
        const sid = String(btn?.dataset?.id || '').trim();
        const name = String(btn?.dataset?.name || '').trim();
        if (!sid) return;
        const ok = confirm(`ç¡®è®¤åˆ é™¤ RSS æºï¼Ÿ\n\nname=${name || '(unknown)'}\nsource_id=${sid}\n\nå°†åŒæ—¶åˆ é™¤è¯¥æº entriesï¼Œå¹¶æ¸…ç†è®¢é˜…å¼•ç”¨ã€‚`);
        if (!ok) return;

        const originalBtnText = String(btn.textContent || '');
        try {
          if (!token) {
            _setCsvImportStatus('åˆ é™¤å¤±è´¥: ç¼ºå°‘ admin token');
            alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
            return;
          }

          btn.disabled = true;
          btn.textContent = 'Deleting...';
          _setCsvImportStatus(`Deleting: ${sid} ...`);

          const resp = await fetch('/api/admin/rss-sources/delete', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ source_id: sid })
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

          _setCsvImportStatus(`Deleted: ${sid}`);
          try { window.location.reload(); } catch (e) { }
        } catch (e) {
          _setCsvImportStatus(`åˆ é™¤å¤±è´¥: ${sid}`);
          alert(e?.message || String(e));
          btn.textContent = originalBtnText || 'Delete';
        } finally {
          try { btn.disabled = false; } catch (e) { }
        }
      }

      async function clearBackoffAndRetry(btn) {
        const sid = String(btn?.dataset?.id || '').trim();
        if (!sid) return;
        const ok = confirm(`æ¸…é™¤é€€é¿å¹¶é‡è¯•æŠ“å–ï¼Ÿ\nsource_id=${sid}`);
        if (!ok) return;

        const originalBtnText = String(btn.textContent || '');
        try {
          if (!token) {
            _setCsvImportStatus('æ“ä½œå¤±è´¥: ç¼ºå°‘ admin token');
            alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
            return;
          }

          btn.disabled = true;
          btn.textContent = 'æ¸…ç†ä¸­...';
          _setCsvImportStatus(`æ¸…ç†é€€é¿: ${sid} ...`);

          const resp = await fetch('/api/admin/rss-sources/clear-backoff', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ source_id: sid, warmup: 0 })
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

          _setCsvImportStatus(`å·²æ¸…é™¤é€€é¿: ${sid}ï¼Œå¼€å§‹é‡è¯•æŠ“å–...`);
          btn.textContent = 'é‡è¯•ä¸­...';

          await warmupSource(sid);
          btn.textContent = 'å·²é‡è¯•';
        } catch (e) {
          _setCsvImportStatus(`æ“ä½œå¤±è´¥: ${sid}`);
          alert(e?.message || String(e));
          btn.textContent = originalBtnText || 'æ¸…é€€é¿å¹¶é‡è¯•';
        } finally {
          try { btn.disabled = false; } catch (e) { }
        }
      }

      function setCatalogFilter(v) {
        _catalogFilter = String(v || 'ALL');
        applyCatalogFilter();
      }

      let _csvPreviewHash = '';
      let _csvPreviewText = '';
      let _csvPreviewDetectedFormat = '';

      try {
        const search = document.getElementById('catalog-search');
        if (search) {
          search.addEventListener('input', () => applyCatalogFilter());
        }
        updateBulkSelectionInfo();
        applyCatalogFilter();
      } catch (e) {
        // ignore
      }

      function _setCsvImportStatus(msg) {
        const el = document.getElementById('csv-import-status');
        if (!el) return;
        el.textContent = msg || '';
      }

      function _escapeHtml(s) {
        return String(s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function _setMorningBriefRulesStatus(msg) {
        const el = document.getElementById('mb-rules-status');
        if (!el) return;
        el.textContent = msg || '';
      }

      async function loadMorningBriefRules() {
        try {
          _setMorningBriefRulesStatus('Loading...');
          const resp = await fetch(`/api/admin/morning-brief/rules?token=${encodeURIComponent(token)}`);
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || 'Load failed');
          const rules = payload?.rules || {};
          const text = JSON.stringify(rules, null, 2);
          const ta = document.getElementById('mb-rules-text');
          if (ta) ta.value = text;
          _setMorningBriefRulesStatus(`Loaded (updated_at=${Number(payload?.updated_at || 0)})`);
        } catch (e) {
          _setMorningBriefRulesStatus('');
          alert(e?.message || String(e));
        }
      }

      function validateMorningBriefRules() {
        try {
          const ta = document.getElementById('mb-rules-text');
          const text = ta ? String(ta.value || '').trim() : '';
          if (!text) throw new Error('Empty rules JSON');
          const parsed = JSON.parse(text);
          if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
            throw new Error('Rules must be a JSON object');
          }
          _setMorningBriefRulesStatus('Valid JSON');
        } catch (e) {
          _setMorningBriefRulesStatus('Invalid JSON');
          alert(e?.message || String(e));
        }
      }

      async function saveMorningBriefRules() {
        try {
          const ta = document.getElementById('mb-rules-text');
          const text = ta ? String(ta.value || '').trim() : '';
          if (!text) throw new Error('Empty rules JSON');
          const rules = JSON.parse(text);
          _setMorningBriefRulesStatus('Saving...');
          const resp = await fetch(`/api/admin/morning-brief/rules?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ rules })
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || 'Save failed');
          _setMorningBriefRulesStatus(`Saved (updated_at=${Number(payload?.updated_at || 0)})`);
        } catch (e) {
          _setMorningBriefRulesStatus('');
          alert(e?.message || String(e));
        }
      }

      async function toggleSourceEnabled(btn) {
        const sourceId = btn?.dataset?.id || '';
        const curEnabled = String(btn?.dataset?.enabled || '').trim() === '1';
        const nextEnabled = !curEnabled;
        if (!sourceId) return;

        try {
          btn.disabled = true;
          const resp = await fetch('/api/admin/rss-sources/set-enabled', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ source_id: sourceId, enabled: nextEnabled ? 1 : 0 })
          });
          const payload = await resp.json();
          if (!resp.ok) throw new Error(payload?.detail || 'Failed');

          btn.dataset.enabled = nextEnabled ? '1' : '0';
          btn.textContent = nextEnabled ? 'Disable' : 'Enable';
          const cell = document.getElementById(`src-enabled-${sourceId}`);
          if (cell) cell.textContent = nextEnabled ? '1' : '0';
        } catch (e) {
          alert(e?.message || String(e));
        } finally {
          try { btn.disabled = false; } catch (e) { /* ignore */ }
        }
      }

      async function warmupSource(btnOrSourceId) {
        const btn = (btnOrSourceId && typeof btnOrSourceId === 'object' && 'dataset' in btnOrSourceId) ? btnOrSourceId : null;
        const sid = btn ? String(btn?.dataset?.id || '').trim() : String(btnOrSourceId || '').trim();
        if (!sid) return;

        const originalBtnText = btn ? String(btn.textContent || '') : '';
        try {
          if (!token) {
            _setCsvImportStatus('æŠ“å–å¤±è´¥: ç¼ºå°‘ admin token');
            alert('Missing admin token. Use ?token=... to open this page or configure TREND_RADAR_ADMIN_TOKEN.');
            return;
          }

          if (btn) {
            btn.disabled = true;
            btn.textContent = 'æŠ“å–ä¸­...';
          }
          _setCsvImportStatus(`æŠ“å–ä¸­: ${sid} ...`);

          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort(), 15000);
          const resp = await fetch('/api/rss-sources/warmup?wait_ms=1200', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ source_ids: [sid], priority: 'high' }),
            signal: ctrl.signal,
          }).finally(() => clearTimeout(t));

          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || `Failed (${resp.status})`);

          const detail = String(payload?.detail || '').toLowerCase();
          if (detail.includes('warmup not available')) {
            throw new Error(String(payload?.detail || 'warmup not available'));
          }
          if (Number(payload?.queued || 0) <= 0) {
            throw new Error(String(payload?.detail || 'No task queued'));
          }

          const res0 = Array.isArray(payload?.results) ? payload.results[0] : null;
          if (res0 && res0.ok === false && res0.error) {
            throw new Error(String(res0.error));
          }

          _setCsvImportStatus(`æŠ“å–å®Œæˆ: ${sid}`);
          if (btn) btn.textContent = 'å·²è§¦å‘';
        } catch (e) {
          _setCsvImportStatus(`æŠ“å–å¤±è´¥: ${sid}`);
          const name = String(e?.name || '');
          if (name === 'AbortError') {
            alert('Request timeout (15s).');
          } else {
            alert(e?.message || String(e));
          }
          if (btn) btn.textContent = originalBtnText || 'æ‰‹åŠ¨æŠ“å–';
        } finally {
          if (btn) {
            try { btn.disabled = false; } catch (e) { /* ignore */ }
          }
        }
      }

      async function exportCatalogAll() {
        try {
          _setCsvImportStatus('Exporting...');
          const resp = await fetch('/api/admin/rss-sources/export', {
            method: 'GET',
            headers: {
              'X-Admin-Token': token
            }
          });
          if (!resp.ok) {
            const payload = await resp.json().catch(() => ({}));
            throw new Error(payload?.detail || 'Export failed');
          }
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'admin_rss_catalog_all.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          _setCsvImportStatus('Exported');
        } catch (e) {
          alert(e?.message || String(e));
          _setCsvImportStatus('');
        }
      }

      async function bulkEnableCatalogAll() {
        const ok = confirm('Enable ALL disabled rss_sources in Catalog (All)?');
        if (!ok) return;
        try {
          _setCsvImportStatus('Enabling...');
          const resp = await fetch('/api/admin/rss-sources/bulk-enable', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({})
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || 'Bulk enable failed');
          alert(`Enabled ${Number(payload?.enabled || 0)} source(s).`);
          location.reload();
        } catch (e) {
          alert(e?.message || String(e));
          _setCsvImportStatus('');
        }
      }

      function _parseUrlsFromTextareaText(text) {
        const out = [];
        const seen = new Set();
        const lines = String(text || '').split(/\r?\n/);
        for (const lineRaw of lines) {
          const line = String(lineRaw || '').trim();
          if (!line) continue;

          // Support:
          // 1) plain URL per line
          // 2) CSV row where 2nd column is URL
          let candidate = line;
          if (line.includes(',')) {
            const parts = line.split(',').map((x) => String(x || '').trim());
            if (parts.length >= 2 && (parts[1] || '').startsWith('http')) {
              candidate = parts[1];
            }
          }
          if (!candidate.startsWith('http://') && !candidate.startsWith('https://')) {
            continue;
          }
          if (seen.has(candidate)) continue;
          seen.add(candidate);
          out.push(candidate);
        }
        return out;
      }

      async function bulkDisableByUrls() {
        const text = document.getElementById('csv-import-text')?.value || '';
        const urls = _parseUrlsFromTextareaText(text);
        if (!urls.length) {
          alert('No URL found in textarea. Paste one URL per line, or CSV rows with URL in the 2nd column.');
          return;
        }
        const ok = confirm(`Disable sources matching ${urls.length} URL(s)? (Only matched enabled sources will be disabled)`);
        if (!ok) return;
        try {
          _setCsvImportStatus('Disabling by URLs...');
          const resp = await fetch('/api/admin/rss-sources/bulk-disable-by-urls', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ urls })
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || 'Bulk disable by URLs failed');

          const disabled = Number(payload?.disabled || 0);
          const matched = Number(payload?.matched || 0);
          const notFound = Array.isArray(payload?.not_found) ? payload.not_found : [];
          const invalid = Array.isArray(payload?.invalid) ? payload.invalid : [];
          let msg = `Matched ${matched} URL(s), disabled ${disabled} source(s).`;
          if (invalid.length) msg += `\nInvalid: ${invalid.length}`;
          if (notFound.length) msg += `\nNot found: ${notFound.length}`;
          alert(msg);
          location.reload();
        } catch (e) {
          alert(e?.message || String(e));
          _setCsvImportStatus('');
        }
      }

      function _renderCsvImportResult(payload) {
        const el = document.getElementById('csv-import-result');
        if (!el) return;
        const fmt = payload?.detected_format || '';
        const hash = payload?.preview_hash || '';
        const summary = payload?.summary || {};
        const expected = payload?.expected || {};
        const invalid = Array.isArray(payload?.invalid_rows) ? payload.invalid_rows : [];
        const dups = Array.isArray(payload?.duplicate_rows) ? payload.duplicate_rows : [];
        const sample = Array.isArray(payload?.sample) ? payload.sample : [];
        const fetchErrors = Array.isArray(payload?.fetch_errors) ? payload.fetch_errors : [];
        const ai = payload?.ai || {};

        const expUrlOnly = Array.isArray(expected?.url_only) ? expected.url_only.join(' | ') : '';
        const expHeaderless = Array.isArray(expected?.headerless_fixed_order) ? expected.headerless_fixed_order.join(', ') : '';
        const expZh = Array.isArray(expected?.headered_zh) ? expected.headered_zh.join(', ') : '';

        const kpiHtml = [
          `<span class="pill">format=${_escapeHtml(fmt)}</span>`,
          hash ? `<span class="pill">preview_hash=${_escapeHtml(hash)}</span>` : '',
          `<span class="pill">total_rows=${Number(summary.total_rows || 0)}</span>`,
          `<span class="pill">unique_urls=${Number(summary.unique_urls || 0)}</span>`,
          `<span class="pill">inserted=${Number(summary.inserted || 0)}</span>`,
          `<span class="pill">updated=${Number(summary.updated || 0)}</span>`,
          `<span class="pill">duplicates=${Number(summary.duplicates || 0)}</span>`,
          `<span class="pill">invalid=${Number(summary.invalid || 0)}</span>`
        ].filter(Boolean).join('');



        const invalidHtml = invalid.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Invalid Rows (showing up to 50)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>line_no</th><th>error</th></tr></thead>
            <tbody>
              ${invalid.map((x) => `<tr><td class="muted">${_escapeHtml(x.line_no)}</td><td>${_escapeHtml(x.error)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

        const dupHtml = dups.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Duplicate Rows (showing up to 50)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>line_no</th><th>url</th><th>first_line_no</th></tr></thead>
            <tbody>
              ${dups.map((x) => `<tr><td class="muted">${_escapeHtml(x.line_no)}</td><td class="muted" style="max-width:520px;word-break:break-all;">${_escapeHtml(x.url)}</td><td class="muted">${_escapeHtml(x.first_line_no)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

        const fetchErrorHtml = fetchErrors.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Fetch Errors (showing up to 30)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>url</th><th>error</th></tr></thead>
            <tbody>
              ${fetchErrors.map((x) => `<tr><td class="muted" style="max-width:520px;word-break:break-all;">${_escapeHtml(x.url)}</td><td>${_escapeHtml(x.error)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

        const sampleHtml = sample.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Sample (first 10 unique rows)</div>
          <table style="margin-top:6px;">
            <thead><tr><th>action</th><th>name</th><th>url</th><th>seed_last_updated</th><th>category</th><th>feed_type</th><th>country</th><th>language</th><th>source</th><th>added_at</th></tr></thead>
            <tbody>
              ${sample.map((x) => `
                <tr>
                  <td class="muted">${_escapeHtml(x.action)}</td>
                  <td><b>${_escapeHtml(x.name)}</b></td>
                  <td class="muted" style="max-width:420px;word-break:break-all;">${_escapeHtml(x.url)}</td>
                  <td class="muted">${_escapeHtml(x.seed_last_updated)}</td>
                  <td class="muted">${_escapeHtml(x.category)}</td>
                  <td class="muted">${_escapeHtml(x.feed_type)}</td>
                  <td class="muted">${_escapeHtml(x.country)}</td>
                  <td class="muted">${_escapeHtml(x.language)}</td>
                  <td class="muted">${_escapeHtml(x.source)}</td>
                  <td class="muted">${_escapeHtml(x.added_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : '';

        el.innerHTML = `
        <div class="kpi" style="display:flex;">${kpiHtml}</div>
        <div style="margin-top:8px;" class="muted">
          ${expUrlOnly ? `<div><b>Expected (url-only)</b>: ${_escapeHtml(expUrlOnly)}</div>` : ''}
          <div><b>Expected (headerless)</b>: ${_escapeHtml(expHeaderless)}</div>
          <div><b>Expected (headered zh)</b>: ${_escapeHtml(expZh)}</div>
        </div>
        ${invalidHtml}
        ${dupHtml}
        ${fetchErrorHtml}
        ${sampleHtml}
      `;
      }

      async function previewCsvImport() {
        const text = document.getElementById('csv-import-text')?.value || '';
        _setCsvImportStatus('Previewing...');
        const el = document.getElementById('csv-import-result');
        if (el) el.innerHTML = '';
        _csvPreviewHash = '';
        _csvPreviewText = '';
        _csvPreviewDetectedFormat = '';
        const resp = await fetch(`/api/admin/rss-sources/import-csv/preview?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csv_text: text })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          _setCsvImportStatus(payload?.detail || 'Preview failed');
          if (el) el.innerHTML = `<div style="color:#dc2626;">${_escapeHtml(payload?.detail || 'Preview failed')}</div>`;
          return;
        }
        _csvPreviewDetectedFormat = String(payload?.detected_format || '');
        _csvPreviewHash = String(payload?.preview_hash || '');
        _csvPreviewText = String(text || '');

        // For URL-only format, use the autofill result
        const autoText = String(payload?.autofill_csv_text || '');
        const autoHash = String(payload?.autofill_preview_hash || '');
        if (_csvPreviewDetectedFormat === 'url_only' && autoText && autoHash) {
          const ta = document.getElementById('csv-import-text');
          if (ta) ta.value = autoText;
          _csvPreviewHash = autoHash;
          _csvPreviewText = autoText;
          _csvPreviewDetectedFormat = 'headerless_fixed';
        }

        _setCsvImportStatus('Preview ready');
        _renderCsvImportResult(payload);
      }



      async function commitCsvImport() {
        const text = document.getElementById('csv-import-text')?.value || '';
        if (!_csvPreviewHash) {
          alert('Please Preview first.');
          return;
        }
        const currentText = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const previewText = String(_csvPreviewText || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        if (currentText !== previewText) {
          alert('CSV text changed since preview. Please Preview again.');
          return;
        }
        const ok = confirm('Commit import into rss_sources?');
        if (!ok) return;
        _setCsvImportStatus('Committing...');
        const resp = await fetch(`/api/admin/rss-sources/import-csv/commit?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csv_text: text, preview_hash: _csvPreviewHash })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          _setCsvImportStatus(payload?.detail || 'Commit failed');
          alert(payload?.detail || 'Commit failed');
          return;
        }
        _setCsvImportStatus('Committed');
        location.reload();
      }

      async function bulkDisableCatalogAll() {
        const ok = confirm('Disable ALL enabled rss_sources in Catalog (All)?');
        if (!ok) return;
        try {
          _setCsvImportStatus('Disabling...');
          const resp = await fetch('/api/admin/rss-sources/bulk-disable', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({})
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(payload?.detail || 'Bulk disable failed');
          alert(`Disabled ${Number(payload?.disabled || 0)} source(s).`);
          location.reload();
        } catch (e) {
          alert(e?.message || String(e));
          _setCsvImportStatus('');
        }
      }

      async function approveReq(id) {
        id = String(id || '').trim();
        const name = document.getElementById(`name-${id}`)?.value || '';
        const resp = await fetch(`/api/admin/rss-source-requests/${id}/approve?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (!resp.ok) {
          const t = await resp.text();
          alert(t || 'Approve failed');
          return;
        }
        location.reload();
      }

      async function rejectReq(id) {
        id = String(id || '').trim();
        const reason = document.getElementById(`reason-${id}`)?.value || '';
        const resp = await fetch(`/api/admin/rss-source-requests/${id}/reject?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        if (!resp.ok) {
          const t = await resp.text();
          alert(t || 'Reject failed');
          return;
        }
        location.reload();
      }

      async function reopenReq(id) {
        id = String(id || '').trim();
        const resp = await fetch(`/api/admin/rss-source-requests/${id}/reopen?token=${encodeURIComponent(token)}`, {
          method: 'POST'
        });
        if (!resp.ok) {
          const t = await resp.text();
          alert(t || 'Reopen failed');
          return;
        }
        location.reload();
      }

      function _setUsageStatus(msg) {
        const el = document.getElementById('usage-status');
        if (!el) return;
        el.textContent = msg || '';
      }

      function _n(v) {
        const x = Number(v);
        if (!Number.isFinite(x)) return 0;
        return x;
      }

      async function loadUsage() {
        const daysRaw = document.getElementById('usage-days')?.value || '7';
        const days = Math.max(1, Math.min(180, parseInt(daysRaw, 10) || 7));
        _setUsageStatus('Loading...');
        const tableEl = document.getElementById('usage-table');
        const kpiEl = document.getElementById('usage-kpi');
        if (tableEl) tableEl.innerHTML = '';
        if (kpiEl) { kpiEl.style.display = 'none'; kpiEl.innerHTML = ''; }

        const resp = await fetch(`/api/admin/rss-usage?days=${encodeURIComponent(String(days))}&token=${encodeURIComponent(token)}`);
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          _setUsageStatus(payload?.detail || 'Load failed');
          return;
        }

        const items = Array.isArray(payload?.items) ? payload.items : [];
        const maxReq = items.reduce((m, x) => Math.max(m, _n(x?.requests)), 0) || 1;
        const totalReq = items.reduce((s, x) => s + _n(x?.requests), 0);
        const totalUsers = items.reduce((s, x) => s + _n(x?.unique_clients), 0);
        const maxUsers = items.reduce((m, x) => Math.max(m, _n(x?.unique_clients)), 0);
        _setUsageStatus(`Loaded ${items.length} day(s)`);

        if (kpiEl) {
          kpiEl.style.display = 'flex';
          kpiEl.innerHTML = [
            `<span class="pill">days=${days}</span>`,
            `<span class="pill">total_requests=${totalReq}</span>`,
            `<span class="pill">sum_unique_clients=${totalUsers}</span>`,
            `<span class="pill">max_daily_unique_clients=${maxUsers}</span>`
          ].join('');
        }

        if (!tableEl) return;
        if (items.length === 0) {
          tableEl.innerHTML = '<div class="muted">No data.</div>';
          return;
        }

        const rows = items.map((x) => {
          const day = String(x?.day || '');
          const req = _n(x?.requests);
          const users = _n(x?.unique_clients);
          const avgSubs = _n(x?.avg_subs).toFixed(2);
          const maxSubs = _n(x?.max_subs);
          const pct = Math.max(0, Math.min(100, Math.round(req / maxReq * 100)));
          return `
          <tr>
            <td><b>${day}</b></td>
            <td>
              <div style="display:flex;align-items:center;gap:10px;">
                <div class="bar"><div style="width:${pct}%;"></div></div>
                <span>${req}</span>
              </div>
            </td>
            <td>${users}</td>
            <td>${avgSubs}</td>
            <td>${maxSubs}</td>
          </tr>
        `;
        }).join('');

        tableEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Day</th>
              <th>Requests</th>
              <th>Unique Clients (Approx)</th>
              <th>Avg Subs</th>
              <th>Max Subs</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      }
    </script>

    <!-- Edit Source Modal -->
    <div id="edit-source-modal" class="modal-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
      <div class="modal-content"
        style="background:white; padding:20px; border-radius:8px; width:500px; max-width:90%; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; margin-bottom:16px; font-size:18px; font-weight:600;">Edit RSS Source</h3>
        <input type="hidden" id="edit-source-id">
        <input type="hidden" id="edit-custom-id-original">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">

          <!-- URL Input with AI Button -->
          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">URL</label>
            <div style="display:flex; gap:10px;">
              <input type="text" id="edit-custom-magic-url" class="form-control" placeholder="https://example.com/news"
                style="flex:1; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
              <button type="button" class="btn btn-primary" onclick="detectCustomSourceAI()"
                style="white-space:nowrap;">
                AI ğŸª„ Analyze
              </button>
            </div>
            <div class="muted" style="margin-top:4px;">Enter URL and click AI Analyze to auto-detect configuration.
            </div>
          </div>

          <!-- Hidden Manual Fields -->
          <div style="display:none;">
            <input type="text" id="edit-custom-id">
            <input type="text" id="edit-custom-name">
            <input type="text" id="edit-custom-category">
            <input type="text" id="edit-custom-country">
            <input type="text" id="edit-custom-language">
            <select id="edit-custom-provider"></select>
            <input type="text" id="edit-custom-cron">
            <input type="checkbox" id="edit-custom-enabled">
          </div>

          <!-- Detected Metadata Summary -->
          <div id="ai-detected-summary"
            style="grid-column: span 2; display:none; background:#f0f9ff; padding:10px; border-radius:6px; border:1px solid #bae6fd; margin-bottom:10px;">
            <div style="font-weight:600; font-size:13px; margin-bottom:4px;">ğŸ¤– AI Detected Configuration:</div>
            <div id="ai-summary-content" style="font-size:12px; color:#0369a1;"></div>
          </div>

          <!-- Config JSON Editor -->
          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Config JSON</label>
            <textarea id="edit-custom-config" class="form-control"
              style="width:100%; min-height:200px; font-family:monospace; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px;"></textarea>
          </div>

          <div class="form-group" style="grid-column: span 2;">
            <div id="custom-test-result"
              style="display:none; margin-top:10px; padding:10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:4px; font-size:11px; white-space:pre-wrap; max-height:300px; overflow-y:auto;">
            </div>
          </div>

        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button class="btn" onclick="testCustomSource()">Test Run</button>
          <button class="btn btn-primary" onclick="saveCustomSource()">Save</button>
          <button class="btn"
            onclick="document.getElementById('edit-source-modal').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      function openEditModal(btn) {
        const modal = document.getElementById('edit-source-modal');
        // Populate fields
        document.getElementById('edit-source-id').value = btn.dataset.id || '';
        document.getElementById('edit-name').value = btn.dataset.name || '';
        document.getElementById('edit-url').value = btn.dataset.url || '';
        document.getElementById('edit-category').value = btn.dataset.category || '';
        document.getElementById('edit-feed-type').value = btn.dataset.feedType || '';
        document.getElementById('edit-country').value = btn.dataset.country || '';
        document.getElementById('edit-language').value = btn.dataset.language || '';
        document.getElementById('edit-source').value = btn.dataset.source || '';
        document.getElementById('edit-scrape-rules').value = btn.dataset.scrapeRules || '';
        document.getElementById('edit-enabled').checked = (btn.dataset.enabled === '1');

        modal.style.display = 'flex';
      }

      function closeEditModal() {
        document.getElementById('edit-source-modal').style.display = 'none';
      }

      async function saveEditSource() {
        const sid = document.getElementById('edit-source-id').value;
        if (!sid) return;

        const payload = {
          source_id: sid,
          name: document.getElementById('edit-name').value,
          url: document.getElementById('edit-url').value,
          category: document.getElementById('edit-category').value,
          feed_type: document.getElementById('edit-feed-type').value,
          country: document.getElementById('edit-country').value,
          language: document.getElementById('edit-language').value,
          source: document.getElementById('edit-source').value,
          scrape_rules: document.getElementById('edit-scrape-rules').value,
          enabled: document.getElementById('edit-enabled').checked ? 1 : 0
        };

        try {
          const resp = await fetch('/api/admin/rss-sources/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.detail || 'Update failed');

          showToast('Update successful!', 'success');
          setTimeout(() => window.location.reload(), 1000); // Reload to reflect changes
        } catch (e) {
          showToast(`Update failed: ${e.message}`, 'error');
        }
      }



    </script>
    <!-- Loading Overlay -->
    <div id="ai-loading-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:100000; flex-direction:column; align-items:center; justify-content:center;">
      <div style="font-size:48px; margin-bottom:20px;">ğŸª„</div>
      <h2 style="margin-bottom:10px;">AI Analysis in Progress...</h2>
      <div style="color:#6b7280;">Analyzing page structure and generating rules</div>
    </div>
    <div id="visual-selector-modal" class="modal-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:20px; z-index:99999;">
      <div class="modal-content"
        style="width:95%; height:95%; max-width:1400px; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        <!-- Header -->
        <div
          style="padding:10px 15px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; background:#f9fafb;">
          <div style="display:flex; gap:10px; align-items:center;">
            <h3 style="margin:0; font-size:16px;">Visual Scrape Selector</h3>
            <span id="vs-url"
              style="font-size:12px; color:#6b7280; max-width:400px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"></span>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="closeVisualSelector()"
              style="padding:6px 12px; border:1px solid #d1d5db; background:white; border-radius:4px; cursor:pointer;">Cancel</button>
            <button onclick="applyVisualRules()" class="btn-primary"
              style="padding:6px 12px; border:none; border-radius:4px; cursor:pointer;">Apply Rules</button>
          </div>
        </div>

        <!-- Toolbar & Frame -->
        <div style="flex:1; display:flex; overflow:hidden; position:relative;">
          <!-- Sidebar / Floating Toolbar -->
          <div
            style="width:280px; background:white; border-right:1px solid #e5e7eb; padding:15px; display:flex; flex-direction:column; gap:15px; overflow-y:auto;">

            <div class="vs-step" data-step="item">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">1. Select Container
                (Item)</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Result count: <span
                  id="vs-item-count">-</span></div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-item-sel" placeholder="e.g. .post"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('item')" id="btn-vs-item" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="title">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">2. Select Title</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Must be inside Item</div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-title-sel" placeholder="e.g. h2 > a"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('title')" id="btn-vs-title" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="link">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">3. Select Link</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Usually same as Title</div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-link-sel" placeholder="e.g. h2 > a"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('link')" id="btn-vs-link" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="date">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">4. Select Date
                (Optional)</label>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-date-sel" placeholder="e.g. .time"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('date')" id="btn-vs-date" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div style="margin-top:auto; padding-top:10px; border-top:1px solid #e5e7eb;">
              <button onclick="resetVs()"
                style="width:100%; padding:6px; border:1px solid #d1d5db; background:#f3f4f6; cursor:pointer; font-size:12px;">Reset
                All</button>
            </div>
            <div id="vs-status" style="font-size:11px; color:#ef4444; min-height:16px;"></div>
          </div>

          <!-- Iframe Container -->
          <div style="flex:1; position:relative; background:#e5e7eb;">
            <iframe id="vs-iframe" style="width:100%; height:100%; border:none; background:white;"></iframe>
            <div id="vs-loading"
              style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; color:#6b7280;">
              Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let vsMode = null; // 'item', 'title', 'link', 'date'
      let vsRules = { item: '', title: '', link: '', date: '' };
      let vsUrl = '';

      function openVisualSelector(customUrl) {
        console.log('Magic Select Clicked');
        const url = customUrl || (document.getElementById('edit-url') ? document.getElementById('edit-url').value : '') || (document.getElementById('edit-custom-magic-url') ? document.getElementById('edit-custom-magic-url').value : '');
        if (!url) {
          showToast('Please enter a URL first.', 'warning');
          return;
        }
        vsUrl = url;
        document.getElementById('vs-url').textContent = url;
        document.getElementById('visual-selector-modal').style.display = 'flex';

        // Load content
        loadVsContent(url);

        // Reset
        resetVs();
      }

      function closeVisualSelector() {
        document.getElementById('visual-selector-modal').style.display = 'none';
      }

      function loadVsContent(url) {
        const frame = document.getElementById('vs-iframe');
        const loader = document.getElementById('vs-loading');
        loader.style.display = 'flex';

        // Use our new API
        frame.src = `/api/admin/tool/fetch-html?token=${encodeURIComponent(token)}&url=${encodeURIComponent(url)}`;

        frame.onload = () => {
          loader.style.display = 'none';
        };
      }

      // ... (setVsMode, resetVs, window message listener, handleVsSelection) ...

      function applyVisualRules() {
        // Construct JSON
        const rules = {
          items: document.getElementById('vs-item-sel').value, // Note: backend expects 'items' plural for custom source, but legacy 'item' singular. Let's standadize based on target.
          title: document.getElementById('vs-title-sel').value,
          link: document.getElementById('vs-link-sel').value
        };
        const date = document.getElementById('vs-date-sel').value;
        if (date) rules.date = date;

        if (!rules.items || !rules.title || !rules.link) {
          showToast('Item, Title, and Link are required.', 'error');
          return;
        }

        // Use 'item' singular for legacy input if needed, but internally we use 'items'
        // Actually, the original wrote 'item': ... to JSON.
        // Let's check target.

        if (window.currentEditTab === 'html') {
          // Update config json
          const configArea = document.getElementById('edit-custom-config');
          try {
            let config = JSON.parse(configArea.value || '{}');
            config.scrape_rules = rules; // {items:..., title:..., link:..., date:...}
            configArea.value = JSON.stringify(config, null, 2);
            showToast('Rules applied to Config JSON', 'success');
          } catch (e) {
            showToast('Invalid Config JSON, cannot apply rules', 'error');
          }
        } else {
          // Legacy RSS modal
          // The legacy backend expects 'item' singular? 
          // Let's check what was there.
          // Original: rules = { item: ..., ... }
          // New: rules = { items: ... } -> Wait.

          // Restore legacy keys for RSS modal if needed
          const legacyRules = {
            item: rules.items,
            title: rules.title,
            link: rules.link
          };
          if (rules.date) legacyRules.date = rules.date;

          const json = JSON.stringify(legacyRules, null, 2);
          document.getElementById('edit-scrape-rules').value = json;
        }

        closeVisualSelector();
      }

      function setVsMode(mode) {
        vsMode = mode;
        // Highlight button
        document.querySelectorAll('.btn-vs-mode').forEach(b => {
          b.style.background = '#f3f4f6';
          b.style.color = 'black';
          b.style.borderColor = '#d1d5db';
        });
        const btn = document.getElementById(`btn-vs-${mode}`);
        if (btn) {
          btn.style.background = '#eff6ff';
          btn.style.color = '#1d4ed8';
          btn.style.borderColor = '#2563eb';
        }
      }

      function resetVs() {
        vsRules = { item: '', title: '', link: '', date: '' };
        ['item', 'title', 'link', 'date'].forEach(k => {
          const el = document.getElementById(`vs-${k}-sel`);
          if (el) el.value = '';
        });
        const cnt = document.getElementById('vs-item-count');
        if (cnt) cnt.textContent = '-';
        setVsMode('item'); // Start with item
      }

      // Listen for messages from iframe
      window.addEventListener('message', function (e) {
        if (e.data && e.data.type === 'TRENDRADAR_ELEMENT_SELECTED') {
          handleVsSelection(e.data);
        }
      });

      function handleVsSelection(data) {
        if (!vsMode) return;

        const selector = data.selector;
        if (!selector) return;

        // Update UI & State
        const inp = document.getElementById(`vs-${vsMode}-sel`);
        if (inp) inp.value = selector;

        vsRules[vsMode] = selector;

        // Auto advance
        if (vsMode === 'item') setVsMode('title');
        else if (vsMode === 'title') setVsMode('link');
        // else stay
      }



      // === Custom Sources Management ===

      // Global store for custom sources
      window.customSourcesMap = {};

      async function loadCustomSources(tabName) {
        // tabName: 'api', 'html', or undefined (for legacy)
        // We will default to both if undefined, but practically we call with 'api' or 'html'

        let targetBodyId = 'custom-source-tbody'; // Fallback
        if (tabName === 'api') targetBodyId = 'custom-api-tbody';
        if (tabName === 'html') targetBodyId = 'custom-html-tbody';

        const tbody = document.getElementById(targetBodyId);
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

        try {
          const res = await fetchWithAuth('/api/custom_sources');
          const data = await res.json();

          if (!Array.isArray(data)) {
            tbody.innerHTML = '<tr><td colspan="7">Error loading data</td></tr>';
            return;
          }

          // Update global map
          data.forEach(item => {
            window.customSourcesMap[item.id] = item;
          });

          tbody.innerHTML = '';

          // Filter data based on tabName
          const isApi = (p) => ['http_json', 'tencent_nba'].includes(p);
          const isHtml = (p) => !isApi(p); // heuristic: anything else is HTML (playwright, caixin, etc)

          let filtered = data;
          if (tabName === 'api') filtered = data.filter(i => isApi(i.provider_type));
          if (tabName === 'html') filtered = data.filter(i => isHtml(i.provider_type));

          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="muted">No sources found in this category.</td></tr>';
            return;
          }

          filtered.forEach((item, idx) => {
            const tr = document.createElement('tr');
            const rowId = `custom-row-${tabName}-${idx}`;
            const detailId = `custom-detail-${tabName}-${idx}`;
            tr.id = rowId;

            // Status badge
            let statusBadge = '';
            if (item.backoff_until && new Date(item.backoff_until) > new Date()) {
              statusBadge = '<span class="badge" style="background:#f59e0b;">BACKOFF</span>';
            } else if (item.last_status === 'success') {
              statusBadge = '<span class="badge badge-ok">OK</span>';
            } else if (item.last_status === 'error') {
              statusBadge = '<span class="badge badge-bad">ERROR</span>';
            } else {
              statusBadge = '<span class="badge badge-off">-</span>';
            }

            if (!item.enabled) {
              statusBadge = '<span class="badge badge-off">DISABLED</span>';
            }

            // Extract URL from config
            let configUrl = '';
            try {
              const config = JSON.parse(item.config_json);
              configUrl = config.url || '';
            } catch (e) { }

            // Name / URL column with tags
            const nameColumn = `
              <div style="font-weight:500; margin-bottom:4px;">${_escapeHtml(item.name)}</div>
              <div class="muted" style="font-size:10px; margin-bottom:4px;">${_escapeHtml(configUrl)}</div>
              <div style="font-size:10px;">
                ${item.country ? `<span class="muted">${item.country}</span>` : ''}
                ${item.language ? `<span class="muted">/ ${item.language}</span>` : ''}
              </div>
            `;

            // Time column
            const addDate = item.created_at ? item.created_at.split(' ')[0] : '-';
            const updDate = item.updated_at ? item.updated_at.split(' ')[0] : '-';
            const timeColumn = `
              <div style="font-size:11px;">Add: ${addDate}</div>
              <div style="font-size:11px; color:#6b7280;">Upd: ${updDate}</div>
            `;

            // Stats column
            const stats = item.stats || {};
            const statsColumn = `
              <div style="font-size:11px;">Entries: ${stats.entries || 0}</div>
              <div style="font-size:11px; color:#6b7280;">Fails: ${stats.fails || 0}</div>
              ${stats.last_update ? `<div style="font-size:10px; color:#9ca3af;">Upd: ${stats.last_update}</div>` : ''}
            `;

            // Latest column (error or last run time)
            let latestColumn = '-';
            if (item.last_error) {
              const errorPreview = item.last_error.length > 30 ? item.last_error.substring(0, 30) + '...' : item.last_error;
              latestColumn = `<div style="color:#dc2626; font-size:10px;" title="${_escapeHtml(item.last_error)}">Err: ${_escapeHtml(errorPreview)}</div>`;
            } else if (item.last_run_at) {
              latestColumn = `<div style="font-size:10px; color:#059669;">${item.last_run_at}</div>`;
            }

            // Icon action buttons
            const actions = `
              <button class="icon-btn" title="Edit" onclick="editCustomSource('${item.id}', '${tabName}')">âœï¸</button>
              <button class="icon-btn" title="Run" onclick="runCustomSource('${item.id}', '${tabName}')" style="color:#2563eb;">â–¶ï¸</button>
              <button class="icon-btn" title="Delete" onclick="deleteCustomSource('${item.id}')" style="color:#dc2626;">ğŸ—‘ï¸</button>
            `;

            tr.innerHTML = `
              <td><input type="checkbox" class="row-checkbox" data-id="${item.id}"></td>
              <td><button class="expand-btn" onclick="toggleCustomDetail('${item.id}', '${detailId}')">â–¶</button></td>
              <td>${statusBadge}</td>
              <td>${nameColumn}</td>
              <td>${item.category ? `<span class="pill">${item.category}</span>` : '-'}</td>
              <td>${timeColumn}</td>
              <td>${statsColumn}</td>
              <td>${latestColumn}</td>
              <td>${actions}</td>
            `;
            tbody.appendChild(tr);

            // Add detail row
            const detailTr = document.createElement('tr');
            detailTr.className = 'detail-row';
            detailTr.id = detailId;
            detailTr.innerHTML = `
              <td colspan="10">
                <div class="detail-content">
                  <div class="muted">Loading...</div>
                </div>
              </td>
            `;
            tbody.appendChild(detailTr);
          });
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="7">Error: ${e.message}</td></tr>`;
        }
      }

      function filterCustomSources(type) {
        const inputId = type === 'api' ? 'custom-api-search' : 'custom-html-search';
        const tableId = type === 'api' ? 'custom-api-table' : 'custom-html-table';
        const query = document.getElementById(inputId)?.value.toLowerCase();
        if (!query) {
          // Reset visibility
          document.querySelectorAll(`#${tableId} tbody tr`).forEach(tr => tr.style.display = '');
          return;
        }

        document.querySelectorAll(`#${tableId} tbody tr`).forEach(tr => {
          const text = tr.innerText.toLowerCase();
          tr.style.display = text.includes(query) ? '' : 'none';
        });
      }

      async function toggleCustomDetail(sourceId, detailId) {
        const detailRow = document.getElementById(detailId);
        if (!detailRow) return;

        const btn = event.target;

        if (detailRow.classList.contains('show')) {
          // Collapse
          detailRow.classList.remove('show');
          btn.textContent = 'â–¶';
        } else {
          // Expand and load data
          detailRow.classList.add('show');
          btn.textContent = 'â–¼';

          const content = detailRow.querySelector('.detail-content');
          content.innerHTML = '<div class="muted">Loading...</div>';

          try {
            const res = await fetchWithAuth(`/api/custom_sources/${sourceId}/items`);
            const data = await res.json();
            const items = data.items || [];

            if (items.length === 0) {
              content.innerHTML = '<div class="muted">No items found. Click Run to fetch data.</div>';
              return;
            }

            let html = '<div style="font-weight:600; margin-bottom:8px;">Latest 10 Items:</div>';
            html += '<div style="max-height:300px; overflow-y:auto;">';
            items.forEach((item, idx) => {
              html += `<div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #e5e7eb;">
                <div style="font-size:12px; color:#111827;"><strong>${idx + 1}.</strong> ${_escapeHtml(item.title)}</div>
                <div style="font-size:10px; color:#6b7280; margin-top:2px;">${_escapeHtml(item.url || '')}</div>
                <div style="font-size:10px; color:#9ca3af; margin-top:2px;">Crawl: ${item.crawl_time || '-'}</div>
              </div>`;
            });
            html += '</div>';
            content.innerHTML = html;
          } catch (e) {
            content.innerHTML = `<div style="color:#dc2626;">Error: ${e.message}</div>`;
          }
        }
      }


      function toggleSelectAllCustom(type) {
        const tableId = type === 'api' ? 'custom-api-table' : 'custom-html-table';
        const checkbox = document.getElementById(`custom-${type}-select-all`);
        const checkboxes = document.querySelectorAll(`#${tableId} .row-checkbox`);
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      }

      async function bulkEnableCustom(type) {
        const tableId = type === 'api' ? 'custom-api-table' : 'custom-html-table';
        const selected = [...document.querySelectorAll(`#${tableId} .row-checkbox:checked`)].map(cb => cb.dataset.id);
        if (selected.length === 0) {
          alert('Please select at least one source');
          return;
        }

        if (!confirm(`Enable ${selected.length} selected sources?`)) return;

        for (const id of selected) {
          try {
            const source = window.customSourcesMap[id];
            if (source) {
              source.enabled = true;
              await fetchWithAuth(`/api/custom_sources/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(source)
              });
            }
          } catch (e) {
            console.error('Failed to enable', id, e);
          }
        }

        loadCustomSources(type);
        alert('Bulk enable complete');
      }

      async function bulkDisableCustom(type) {
        const tableId = type === 'api' ? 'custom-api-table' : 'custom-html-table';
        const selected = [...document.querySelectorAll(`#${tableId} .row-checkbox:checked`)].map(cb => cb.dataset.id);
        if (selected.length === 0) {
          alert('Please select at least one source');
          return;
        }

        if (!confirm(`Disable ${selected.length} selected sources?`)) return;

        for (const id of selected) {
          try {
            const source = window.customSourcesMap[id];
            if (source) {
              source.enabled = false;
              await fetchWithAuth(`/api/custom_sources/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(source)
              });
            }
          } catch (e) {
            console.error('Failed to disable', id, e);
          }
        }

        loadCustomSources(type);
        alert('Bulk disable complete');
      }

      async function detectCustomSourceAI() {
        const url = document.getElementById('edit-custom-magic-url').value.trim();
        if (!url) {
          alert('Please enter a URL first.');
          return;
        }

        // Show loading
        const overlay = document.getElementById('ai-loading-overlay');
        overlay.style.display = 'flex';

        try {
          const resp = await fetchWithAuth('/api/custom_sources/detect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
          });

          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Detection failed');
          }

          const data = await resp.json();

          // Populate fields
          document.getElementById('edit-custom-config').value = data.config_json;
          if (data.id_suggestion) document.getElementById('edit-custom-id').value = data.id_suggestion;
          if (data.name_suggestion) document.getElementById('edit-custom-name').value = data.name_suggestion;
          if (data.category_suggestion) document.getElementById('edit-custom-category').value = data.category_suggestion;
          if (data.country_suggestion) document.getElementById('edit-custom-country').value = data.country_suggestion;
          if (data.language_suggestion) document.getElementById('edit-custom-language').value = data.language_suggestion;
          if (data.cron_suggestion) document.getElementById('edit-custom-cron').value = data.cron_suggestion;

          // Show Summary
          const summaryDiv = document.getElementById('ai-detected-summary');
          const summaryContent = document.getElementById('ai-summary-content');

          summaryDiv.style.display = 'block';
          summaryContent.innerHTML = `
                <div><strong>Name:</strong> ${data.name_suggestion}</div>
                <div style="display:flex; gap:10px; margin-top:2px;">
                    <span><strong>Category:</strong> ${data.category_suggestion}</span>
                    <span><strong>Country:</strong> ${data.country_suggestion}</span>
                    <span><strong>Lang:</strong> ${data.language_suggestion}</span>
                </div>
                <div style="margin-top:2px; font-size:11px; color:#6b7280;">ID: ${data.id_suggestion}</div>
            `;

          showToast('AI Analysis Complete!', 'success');

        } catch (e) {
          alert('AI Analysis Failed: ' + e.message);
        } finally {
          overlay.style.display = 'none';
        }
      }

      function openEditCustomSourceModal(type) {
        // type: 'api' or 'html'
        window.currentEditTab = type; // Save context

        document.getElementById('edit-custom-id-original').value = '';
        document.getElementById('edit-custom-id').value = '';
        document.getElementById('edit-custom-id').disabled = false;
        document.getElementById('edit-custom-name').value = '';
        document.getElementById('edit-custom-category').value = '';
        document.getElementById('edit-custom-country').value = '';
        document.getElementById('edit-custom-language').value = '';
        document.getElementById('edit-custom-magic-url').value = '';

        // Reset AI summary
        document.getElementById('ai-detected-summary').style.display = 'none';

        // Populate options based on type
        const pSelect = document.getElementById('edit-custom-provider');
        if (pSelect) {
          pSelect.innerHTML = '';
          if (type === 'api') {
            pSelect.innerHTML = `<option value="http_json">http_json</option><option value="tencent_nba">tencent_nba</option>`;
          } else {
            pSelect.innerHTML = `<option value="html_scraper">html_scraper</option><option value="caixin">caixin</option>`;
          }
        }

        document.getElementById('edit-custom-config').value = '{\n  "url": "",\n  "scrape_rules": {\n    "items": "",\n    "title": "",\n    "link": "",\n    "date": ""\n  }\n}';
        document.getElementById('edit-custom-cron').value = '';
        document.getElementById('edit-custom-enabled').checked = true;
        document.getElementById('custom-test-result').style.display = 'none';

        const modal = document.getElementById('custom-source-modal'); // Assuming ID is custom-source-modal or edit-source-modal?
        // Wait, earlier code showed id="edit-source-modal"
        // Let's check the modal ID in previous view.
        // It was id="edit-source-modal" in line 2307.
        // But functions openEditCustomSourceModal used 'custom-source-modal' in my memory? 
        // In viewed code line 2806 (previous snippet context), it was 'custom-source-modal'? 
        // Let's check line 2307 again.
        // Line 2307: <div id="edit-source-modal" ...
        // Wait, did I edit the right modal?
        // I edited the HTML block around line 2312.
        // The modal ID is `edit-source-modal`.

        const m = document.getElementById('edit-source-modal');
        if (m) m.style.display = 'flex';
      }

      function editCustomSource(id, type) {
        window.currentEditTab = type;
        const item = window.customSourcesMap[id];
        if (!item) {
          showToast('Item not found', 'error');
          return;
        }

        document.getElementById('edit-custom-id-original').value = item.id;
        document.getElementById('edit-custom-id').value = item.id;
        document.getElementById('edit-custom-id').disabled = true;
        document.getElementById('edit-custom-name').value = item.name;
        document.getElementById('edit-custom-category').value = item.category || '';
        document.getElementById('edit-custom-country').value = item.country || '';
        document.getElementById('edit-custom-language').value = item.language || '';
        document.getElementById('edit-custom-magic-url').value = '';

        // Repopulate select to make sure current provider is there
        const pSelect = document.getElementById('edit-custom-provider');
        let options = '';
        if (['http_json', 'tencent_nba'].includes(item.provider_type) || type === 'api') {
          options = `<option value="http_json">http_json</option><option value="tencent_nba">tencent_nba</option>`;
        } else {
          options = `<option value="html_scraper">html_scraper</option><option value="playwright">playwright</option><option value="caixin">caixin</option>`;
        }
        pSelect.innerHTML = options;
        pSelect.value = item.provider_type || (type === 'api' ? 'http_json' : 'html_scraper');

        document.getElementById('edit-custom-config').value = item.config_json; // already string
        try {
          // Format JSON nicely
          const parsed = JSON.parse(item.config_json);
          document.getElementById('edit-custom-config').value = JSON.stringify(parsed, null, 2);
        } catch (e) { }

        document.getElementById('edit-custom-cron').value = item.schedule_cron || '';
        document.getElementById('edit-custom-enabled').checked = item.enabled;
        document.getElementById('custom-test-result').style.display = 'none';

        const modal = document.getElementById('edit-source-modal');
        modal.style.display = 'flex';
      }

      function closeCustomSourceModal() {
        document.getElementById('edit-source-modal').style.display = 'none';
      }

      async function saveCustomSource() {
        const originalId = document.getElementById('edit-custom-id-original').value;
        const id = document.getElementById('edit-custom-id').value.trim();
        const name = document.getElementById('edit-custom-name').value.trim();
        const category = document.getElementById('edit-custom-category').value.trim();
        const country = document.getElementById('edit-custom-country').value.trim();
        const language = document.getElementById('edit-custom-language').value.trim();
        const provider = document.getElementById('edit-custom-provider').value;
        const configStr = document.getElementById('edit-custom-config').value;
        const cron = document.getElementById('edit-custom-cron').value.trim() || null;
        const enabled = document.getElementById('edit-custom-enabled').checked;

        if (!id || !name) {
          showToast('ID and Name are required', 'error');
          return;
        }

        try {
          JSON.parse(configStr);
        } catch (e) {
          showToast('Invalid JSON Config', 'error');
          return;
        }

        const payload = {
          id: id,
          name: name,
          category: category,
          country: country,
          language: language,
          provider_type: provider,
          config_json: configStr,
          enabled: enabled,
          schedule_cron: cron
        };

        try {
          let res;
          if (originalId) {
            // Update
            res = await fetchWithAuth(`/api/custom_sources/${originalId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
          } else {
            // Create
            res = await fetchWithAuth('/api/custom_sources', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
          }

          if (res.ok) {
            showToast('Saved successfully', 'success');
            closeCustomSourceModal();
            loadCustomSources(window.currentEditTab); // Refresh correct tab
          } else {
            const err = await res.json();
            showToast('Error: ' + err.detail, 'error');
          }
        } catch (e) {
          showToast('Request failed: ' + e.message, 'error');
        }
      }

      async function magicDetectCustomSource() {
        const urlInput = document.getElementById('edit-custom-magic-url');
        const url = (urlInput?.value || '').trim();
        if (!url) {
          showToast('è¯·è¾“å…¥ URL', 'warning');
          return;
        }

        const btn = document.getElementById('btn-magic-detect');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'æ£€æµ‹ä¸­...';

        try {
          const resp = await fetch(`/api/custom_sources/detect?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': token
            },
            body: JSON.stringify({ url: url })
          });

          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'æ£€æµ‹å¤±è´¥');
          }

          const data = await resp.json();

          // Populate fields
          if (data.provider_type) {
            const pSelect = document.getElementById('edit-custom-provider');
            if (pSelect) {
              let exists = false;
              for (let i = 0; i < pSelect.options.length; i++) {
                if (pSelect.options[i].value === data.provider_type) {
                  exists = true;
                  break;
                }
              }
              if (!exists) {
                const opt = document.createElement('option');
                opt.value = data.provider_type;
                opt.text = data.provider_type;
                pSelect.add(opt);
              }
              pSelect.value = data.provider_type;
            }
          }


          if (data.config_json) {
            document.getElementById('edit-custom-config').value = data.config_json;
          }

          if (data.name_suggestion && !document.getElementById('edit-custom-name').value) {
            document.getElementById('edit-custom-name').value = data.name_suggestion;
          }

          if (data.id_suggestion && !document.getElementById('edit-custom-id').value) {
            document.getElementById('edit-custom-id').value = data.id_suggestion;
          }
          if (data.category_suggestion && !document.getElementById('edit-custom-category').value) {
            document.getElementById('edit-custom-category').value = data.category_suggestion;
          }
          if (data.country_suggestion && !document.getElementById('edit-custom-country').value) {
            document.getElementById('edit-custom-country').value = data.country_suggestion;
          }
          if (data.language_suggestion && !document.getElementById('edit-custom-language').value) {
            document.getElementById('edit-custom-language').value = data.language_suggestion;
          }
          if (data.cron_suggestion && !document.getElementById('edit-custom-cron').value) {
            document.getElementById('edit-custom-cron').value = data.cron_suggestion;
          }

          showToast('âœ¨ é…ç½®å·²è‡ªåŠ¨ç”Ÿæˆ', 'success');
        } catch (e) {
          showToast(e.message, 'error');
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }

      async function deleteCustomSource(id) {
        if (!confirm('Are you sure you want to delete ' + id + '?')) return;
        try {
          const res = await fetchWithAuth(`/api/custom_sources/${id}`, { method: 'DELETE' });
          if (res.ok) {
            showToast('Deleted', 'success');
            loadCustomSources(window.currentEditTab);
          } else {
            showToast('Delete failed', 'error');
          }
        } catch (e) {
          showToast('Request failed', 'error');
        }
      }

      async function runCustomSource(id, type) {
        try {
          showToast('Running ' + id + '...', 'info');
          const res = await fetchWithAuth(`/api/custom_sources/${id}/run`, { method: 'POST' });
          if (res.ok) {
            const data = await res.json();
            showToast(`Run Success! Fetched ${data.items_count} items.`, 'success');
            loadCustomSources(type);
          } else {
            const err = await res.json();
            showToast(`Run Failed: ${err.detail}`, 'error');
            loadCustomSources(type); // To update error status
          }
        } catch (e) {
          showToast('Request failed: ' + e.message, 'error');
        }
      }


      async function testCustomSource() {
        const provider = document.getElementById('edit-custom-provider').value;
        const configStr = document.getElementById('edit-custom-config').value;
        const resDiv = document.getElementById('custom-test-result');

        resDiv.style.display = 'block';
        resDiv.innerHTML = '<div style="color:#6b7280;">Testing...</div>';

        try {
          const res = await fetchWithAuth('/api/custom_sources/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              provider_type: provider,
              config_json: configStr
            })
          });
          const data = await res.json();

          // Format result nicely
          if (data.success) {
            const count = data.items_count || 0;
            const items = data.items || [];

            let html = `<div style="margin-bottom:10px;">
              <strong style="color:#059669;">âœ“ æµ‹è¯•æˆåŠŸ</strong> - æŠ“å–åˆ° <strong>${count}</strong> æ¡æ•°æ®
            </div>`;

            if (items.length > 0) {
              html += '<div style="font-weight:600; margin-top:10px; margin-bottom:6px;">å‰ ' + Math.min(5, items.length) + ' æ¡ç¤ºä¾‹ï¼š</div>';
              html += '<div style="border-left:2px solid #2563eb; padding-left:10px;">';
              items.slice(0, 5).forEach((item, idx) => {
                html += `<div style="margin-bottom:8px; font-size:11px;">
                  <div style="color:#374151;"><strong>${idx + 1}.</strong> ${_escapeHtml(item.title || 'No title')}</div>
                  <div style="color:#6b7280; font-size:10px; margin-top:2px;">${_escapeHtml(item.url || '')}</div>
                </div>`;
              });
              html += '</div>';
            }

            resDiv.innerHTML = html;
          } else {
            resDiv.innerHTML = `<div style="color:#dc2626;"><strong>âœ— æµ‹è¯•å¤±è´¥</strong><br>${_escapeHtml(data.error || 'Unknown error')}</div>`;
          }
        } catch (e) {
          resDiv.innerHTML = `<div style="color:#dc2626;"><strong>âœ— é”™è¯¯:</strong> ${_escapeHtml(e.message)}</div>`;
        }
      }

      // Hook into tab switching to load data (moved to initTabs)

      // === NewsNow Platform Management ===
      let newsNowPlatforms = [];

      async function loadNewsNowPlatforms() {
        const tbody = document.getElementById('newsnow-tbody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="6">åŠ è½½ä¸­...</td></tr>';

        try {
          const res = await fetchWithAuth('/api/newsnow_platforms');
          const data = await res.json();

          if (!Array.isArray(data)) {
            tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            return;
          }

          newsNowPlatforms = data;
          tbody.innerHTML = '';

          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="muted">æš‚æ— çƒ­æ¦œå¹³å°ï¼Œç‚¹å‡»"ä»é…ç½®æ–‡ä»¶å¯¼å…¥"å¼€å§‹</td></tr>';
            return;
          }

          data.forEach(p => {
            const tr = document.createElement('tr');
            const statusBadge = p.enabled
              ? '<span class="badge badge-ok">å¯ç”¨</span>'
              : '<span class="badge badge-off">ç¦ç”¨</span>';
            const categoryBadge = p.category ? `<span class="pill">${p.category}</span>` : '-';

            tr.innerHTML = `
              <td>${p.id}</td>
              <td>${p.name}</td>
              <td>${categoryBadge}</td>
              <td>${statusBadge}</td>
              <td>${p.last_fetch_at || '-'}</td>
              <td>
                <button class="btn btn-sm" onclick='editNewsNowPlatform(${JSON.stringify(p)})'>ç¼–è¾‘</button>
                <button class="btn btn-sm" onclick="toggleNewsNow('${p.id}')">${p.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                <button class="btn btn-danger btn-sm" onclick="deleteNewsNow('${p.id}')">åˆ é™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="6">é”™è¯¯: ${e.message}</td></tr>`;
        }
      }

      function filterNewsNow() {
        const query = (document.getElementById('newsnow-search')?.value || '').toLowerCase();
        const rows = document.querySelectorAll('#newsnow-tbody tr');
        rows.forEach(tr => {
          const text = tr.innerText.toLowerCase();
          tr.style.display = text.includes(query) ? '' : 'none';
        });
      }

      function openNewsNowModal(platform = null) {
        document.getElementById('newsnow-edit-original-id').value = platform?.id || '';
        document.getElementById('newsnow-edit-id').value = platform?.id || '';
        document.getElementById('newsnow-edit-id').disabled = !!platform;
        document.getElementById('newsnow-edit-name').value = platform?.name || '';
        document.getElementById('newsnow-edit-category').value = platform?.category || '';
        document.getElementById('newsnow-edit-order').value = platform?.sort_order || 0;
        document.getElementById('newsnow-edit-enabled').checked = platform?.enabled !== false;

        document.getElementById('newsnow-modal').style.display = 'flex';
      }

      function editNewsNowPlatform(p) {
        openNewsNowModal(p);
      }

      function closeNewsNowModal() {
        document.getElementById('newsnow-modal').style.display = 'none';
      }

      async function saveNewsNowPlatform() {
        const originalId = document.getElementById('newsnow-edit-original-id').value;
        const id = document.getElementById('newsnow-edit-id').value.trim();
        const name = document.getElementById('newsnow-edit-name').value.trim();
        const category = document.getElementById('newsnow-edit-category').value;
        const sort_order = parseInt(document.getElementById('newsnow-edit-order').value) || 0;
        const enabled = document.getElementById('newsnow-edit-enabled').checked;

        if (!id || !name) {
          showToast('ID å’Œåç§°ä¸èƒ½ä¸ºç©º', 'error');
          return;
        }

        const payload = { id, name, category, sort_order, enabled };
        const isEdit = !!originalId;
        const url = isEdit ? `/api/newsnow_platforms/${originalId}` : '/api/newsnow_platforms';
        const method = isEdit ? 'PUT' : 'POST';

        try {
          const res = await fetchWithAuth(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            showToast(isEdit ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
            closeNewsNowModal();
            loadNewsNowPlatforms();
          } else {
            const err = await res.json();
            showToast('ä¿å­˜å¤±è´¥: ' + err.detail, 'error');
          }
        } catch (e) {
          showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
        }
      }

      async function toggleNewsNow(id) {
        try {
          const res = await fetchWithAuth(`/api/newsnow_platforms/${id}/toggle`, { method: 'POST' });
          if (res.ok) {
            showToast('çŠ¶æ€å·²åˆ‡æ¢', 'success');
            loadNewsNowPlatforms();
          } else {
            showToast('åˆ‡æ¢å¤±è´¥', 'error');
          }
        } catch (e) {
          showToast('è¯·æ±‚å¤±è´¥', 'error');
        }
      }

      async function deleteNewsNow(id) {
        if (!confirm('ç¡®å®šåˆ é™¤ ' + id + ' å—?')) return;
        try {
          const res = await fetchWithAuth(`/api/newsnow_platforms/${id}`, { method: 'DELETE' });
          if (res.ok) {
            showToast('å·²åˆ é™¤', 'success');
            loadNewsNowPlatforms();
          } else {
            showToast('åˆ é™¤å¤±è´¥', 'error');
          }
        } catch (e) {
          showToast('è¯·æ±‚å¤±è´¥', 'error');
        }
      }

      async function migrateNewsNowFromConfig() {
        if (!confirm('ä» config.yaml å¯¼å…¥å¹³å°é…ç½®ï¼Ÿå·²å­˜åœ¨çš„å¹³å°ä¸ä¼šé‡å¤å¯¼å…¥ã€‚')) return;
        try {
          const res = await fetchWithAuth('/api/newsnow_platforms/migrate', { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            showToast(`å¯¼å…¥å®Œæˆ: ${data.migrated} ä¸ªå¹³å°`, 'success');
            loadNewsNowPlatforms();
          } else {
            showToast('å¯¼å…¥å¤±è´¥: ' + data.detail, 'error');
          }
        } catch (e) {
          showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
        }
      }

      function showReloadInstructions() {
        const isDocker = confirm(
          'é…ç½®å·²åœ¨æ•°æ®åº“ä¸­æ›´æ–°ã€‚\n\n' +
          'è¦ä½¿å¹³å°å¯ç”¨/ç¦ç”¨ç«‹å³ç”Ÿæ•ˆï¼Œéœ€è¦é‡å¯çˆ¬è™«æœåŠ¡ã€‚\n\n' +
          'æ‚¨æ˜¯ä½¿ç”¨ Docker éƒ¨ç½²çš„å—ï¼Ÿ\n\n' +
          'ã€ç¡®å®šã€‘= Docker éƒ¨ç½²ï¼ˆæ˜¾ç¤ºé‡å¯å‘½ä»¤ï¼‰\n' +
          'ã€å–æ¶ˆã€‘= æœ¬åœ°è¿è¡Œï¼ˆæŸ¥çœ‹è¯´æ˜ï¼‰'
        );

        if (isDocker) {
          // Docker éƒ¨ç½²
          const cmd = 'docker compose restart trend-radar';
          const message =
            'è¯·åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤é‡å¯çˆ¬è™«å®¹å™¨ï¼š\n\n' +
            cmd + '\n\n' +
            'é‡å¯åï¼Œç¦ç”¨çš„å¹³å°å°†ä¸å†æŠ“å–æ•°æ®ã€‚';

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(cmd).then(() => {
              alert(message + '\n\nâœ… å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
              alert(message);
            });
          } else {
            alert(message + '\n\n(è¯·æ‰‹åŠ¨å¤åˆ¶å‘½ä»¤)');
          }
        } else {
          // æœ¬åœ°è¿è¡Œ
          alert(
            'æœ¬åœ°è¿è¡Œè¯´æ˜ï¼š\n\n' +
            '1. åœ¨ç»ˆç«¯æŒ‰ Ctrl+C åœæ­¢å½“å‰è¿è¡Œçš„ TrendRadar\n' +
            '2. é‡æ–°è¿è¡Œå¯åŠ¨å‘½ä»¤\n' +
            '3. ç¦ç”¨çš„å¹³å°å°†ä¸å†æŠ“å–æ•°æ®\n\n' +
            'æ³¨æ„ï¼šViewer æœåŠ¡ï¼ˆç«¯å£ 8090ï¼‰æ— éœ€é‡å¯ã€‚'
          );
        }
      }

    </script>
</body>

</html>