services:
  hotnews:
    image: wantcat/hotnews:${HOTNEWS_TAG:?set HOTNEWS_TAG}
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: hotnews
    restart: unless-stopped

    ports:
      - "127.0.0.1:${WEBSERVER_PORT:-8080}:${WEBSERVER_PORT:-8080}"

    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      - ../hotnews:/app/hotnews

    environment:
      - TZ=Asia/Shanghai
      # 核心配置
      - ENABLE_CRAWLER=${ENABLE_CRAWLER:-}
      - ENABLE_NOTIFICATION=${ENABLE_NOTIFICATION:-}
      - REPORT_MODE=${REPORT_MODE:-}
      - SORT_BY_POSITION_FIRST=${SORT_BY_POSITION_FIRST:-}
      - MAX_NEWS_PER_KEYWORD=${MAX_NEWS_PER_KEYWORD:-}
      - REVERSE_CONTENT_ORDER=${REVERSE_CONTENT_ORDER:-}
      # Web 服务器
      - ENABLE_WEBSERVER=${ENABLE_WEBSERVER:-false}
      - WEBSERVER_PORT=${WEBSERVER_PORT:-8080}
      # 多账号配置
      - MAX_ACCOUNTS_PER_CHANNEL=${MAX_ACCOUNTS_PER_CHANNEL:-}
      # 推送时间窗口
      - PUSH_WINDOW_ENABLED=${PUSH_WINDOW_ENABLED:-}
      - PUSH_WINDOW_START=${PUSH_WINDOW_START:-}
      - PUSH_WINDOW_END=${PUSH_WINDOW_END:-}
      - PUSH_WINDOW_ONCE_PER_DAY=${PUSH_WINDOW_ONCE_PER_DAY:-}
      # 通知渠道
      - FEISHU_WEBHOOK_URL=${FEISHU_WEBHOOK_URL:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DINGTALK_WEBHOOK_URL=${DINGTALK_WEBHOOK_URL:-}
      - WEWORK_WEBHOOK_URL=${WEWORK_WEBHOOK_URL:-}
      - WEWORK_MSG_TYPE=${WEWORK_MSG_TYPE:-}
      # 邮件配置
      - EMAIL_FROM=${EMAIL_FROM:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_TO=${EMAIL_TO:-}
      - EMAIL_SMTP_SERVER=${EMAIL_SMTP_SERVER:-}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-}
      # ntfy配置
      - NTFY_SERVER_URL=${NTFY_SERVER_URL:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_TOKEN=${NTFY_TOKEN:-}
      # Bark配置
      - BARK_URL=${BARK_URL:-}
      # Slack配置
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # AI分类配置
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - SCRAPERAPI_KEY=${SCRAPERAPI_KEY:-}
      - HOTNEWS_MB_AI_ENABLED=${HOTNEWS_MB_AI_ENABLED:-}
      - HOTNEWS_RSS_SOURCE_AI_ENABLED=${HOTNEWS_RSS_SOURCE_AI_ENABLED:-false}
      - HOTNEWS_MB_AI_MODEL=${HOTNEWS_MB_AI_MODEL:-qwen-plus}
      - HOTNEWS_MB_AI_TIMEOUT_S=${HOTNEWS_MB_AI_TIMEOUT_S:-60}
      # 存储配置
      - STORAGE_BACKEND=${STORAGE_BACKEND:-auto}
      - LOCAL_RETENTION_DAYS=${LOCAL_RETENTION_DAYS:-0}
      - REMOTE_RETENTION_DAYS=${REMOTE_RETENTION_DAYS:-0}
      - STORAGE_TXT_ENABLED=${STORAGE_TXT_ENABLED:-true}
      - STORAGE_HTML_ENABLED=${STORAGE_HTML_ENABLED:-true}
      # 远程存储配置（S3 兼容协议）
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_REGION=${S3_REGION:-}
      # 数据拉取配置
      - PULL_ENABLED=${PULL_ENABLED:-false}
      - PULL_DAYS=${PULL_DAYS:-7}
      # 运行模式
      - CRON_SCHEDULE=${CRON_SCHEDULE:-*/5 * * * *}
      - RUN_MODE=${RUN_MODE:-cron}
      - IMMEDIATE_RUN=${IMMEDIATE_RUN:-true}

  hotnews-viewer:
    image: wantcat/hotnews-viewer:${HOTNEWS_VIEWER_TAG:?set HOTNEWS_VIEWER_TAG}
    build:
      context: ..
      dockerfile: docker/Dockerfile.viewer
    container_name: hotnews-viewer
    restart: unless-stopped

    ports:
      - "${VIEWER_PORT:-8090}:${VIEWER_PORT:-8090}"

    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      - ../hotnews:/app/hotnews

    environment:
      - TZ=Asia/Shanghai
      - PYTHONDONTWRITEBYTECODE=1
      - RUN_MODE=viewer
      - VIEWER_HOST=0.0.0.0
      - VIEWER_PORT=${VIEWER_PORT:-8090}
      - VIEWER_WORKERS=${VIEWER_WORKERS:-4}
      - HOTNEWS_ADMIN_TOKEN=${HOTNEWS_ADMIN_TOKEN:-}
      - HOTNEWS_ADMIN_PASSWORD=${HOTNEWS_ADMIN_PASSWORD:-}
      - HOTNEWS_ADMIN_SESSION_HOURS=${HOTNEWS_ADMIN_SESSION_HOURS:-24}
      - APP_VERSION=${HOTNEWS_VIEWER_TAG}
      - CONFIG_REV=1
      # 安全配置
      - HOTNEWS_SESSION_SECRET=${HOTNEWS_SESSION_SECRET:-} # 建议设置随机字符串以保持 Session 持久化
      # AI分类配置 (Morning Brief)
      - HOTNEWS_MB_AI_ENABLED=${HOTNEWS_MB_AI_ENABLED:-}
      - SCRAPERAPI_KEY=${SCRAPERAPI_KEY:-}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - HOTNEWS_MB_AI_MODEL=${HOTNEWS_MB_AI_MODEL:-qwen-flash}
      - HOTNEWS_MB_AI_ENDPOINT=${HOTNEWS_MB_AI_ENDPOINT:-}
      - HOTNEWS_MB_AI_TIMEOUT_S=${HOTNEWS_MB_AI_TIMEOUT_S:-30}
      - HOTNEWS_MB_AI_BATCH_SIZE=${HOTNEWS_MB_AI_BATCH_SIZE:-20}
      - HOTNEWS_MB_AI_MAX_PER_HOUR=${HOTNEWS_MB_AI_MAX_PER_HOUR:-200}
      - HOTNEWS_MB_AI_CHECK_INTERVAL=${HOTNEWS_MB_AI_CHECK_INTERVAL:-30}
      - HOTNEWS_RSS_SOURCE_AI_ENABLED=${HOTNEWS_RSS_SOURCE_AI_ENABLED:-false}
      - HOTNEWS_RSS_WARMUP_MAX_PER_HOUR=${HOTNEWS_RSS_WARMUP_MAX_PER_HOUR:-120}
      # 性能优化
      - WORKER_CONNECTIONS=${WORKER_CONNECTIONS:-1000}
      - KEEPALIVE_TIMEOUT=${KEEPALIVE_TIMEOUT:-65}

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:%s/health' % __import__('os').environ.get('VIEWER_PORT','8090'), timeout=5).read()" ]
      interval: 10s
      timeout: 5s
      retries: 6

  hotnews-mcp:
    image: wantcat/hotnews-mcp:${HOTNEWS_MCP_TAG:?set HOTNEWS_MCP_TAG}
    container_name: hotnews-mcp
    restart: unless-stopped

    ports:
      - "127.0.0.1:3333:3333"

    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      - ../mcp_server:/app/mcp_server

    environment:
      - TZ=Asia/Shanghai
