(()=>{var l=window.TrendRadar=window.TrendRadar||{},Zr=[],Qr=!1;function x(t){Qr?t():Zr.push(t)}document.addEventListener("DOMContentLoaded",function(){Qr=!0,Zr.forEach(t=>{try{t()}catch(e){console.error("Ready handler error:",e)}})});function S(t){return String(t||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function ee(t){let e=t==null?"":String(t).trim();if(!e)return e;let r=e.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(e.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),e)}l.ready=x;l.escapeHtml=S;l.formatUpdatedAt=ee;var ut={container:null,nextId:1,items:new Map};function zs(){if(ut.container)return ut.container;let t=document.createElement("div");t.id="tr-toast-container",t.style.position="fixed",t.style.right="16px",t.style.bottom="16px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="10px",t.style.zIndex="99999";try{document.body.appendChild(t)}catch{}return ut.container=t,t}function Ws(t){let e=String(t||"info");return e==="loading"?{bg:"#111827",fg:"#fff",border:"#111827"}:e==="success"?{bg:"#16a34a",fg:"#fff",border:"#16a34a"}:e==="error"?{bg:"#dc2626",fg:"#fff",border:"#dc2626"}:{bg:"#111827",fg:"#fff",border:"#111827"}}function Jr(t,e,r){let n=Ws(r);t.className="tr-toast",t.style.display="flex",t.style.alignItems="center",t.style.gap="10px",t.style.padding="10px 12px",t.style.borderRadius="10px",t.style.background=n.bg,t.style.color=n.fg,t.style.border=`1px solid ${n.border}`,t.style.boxShadow="0 10px 20px rgba(0,0,0,0.18)",t.style.fontSize="0.9rem",t.style.maxWidth="360px",t.style.wordBreak="break-word";let o=String(r||"info")==="loading"?'<span aria-hidden="true" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.3);"></span>':"";t.innerHTML=`${o}<div class="tr-toast-msg">${S(e||"")}</div>`}l.toast={show(t,e={}){let r=`toast-${ut.nextId++}`,n=zs(),s=document.createElement("div");s.dataset.toastId=r,Jr(s,t,e.variant);try{n.appendChild(s)}catch{}let o={id:r,el:s,hideTimer:0};ut.items.set(r,o);let a=Number(e.durationMs||0);return a>0&&(o.hideTimer=window.setTimeout(()=>{l.toast.hide(r)},a)),r},update(t,e,r={}){let n=ut.items.get(String(t||""));if(!n)return;n.hideTimer&&(window.clearTimeout(n.hideTimer),n.hideTimer=0),Jr(n.el,e,r.variant);let s=Number(r.durationMs||0);s>0&&(n.hideTimer=window.setTimeout(()=>{l.toast.hide(t)},s))},hide(t){let e=ut.items.get(String(t||""));if(e){e.hideTimer&&(window.clearTimeout(e.hideTimer),e.hideTimer=0);try{e.el.remove()}catch{}ut.items.delete(String(t||""))}}};var b={get(t,e=null){try{let r=localStorage.getItem(t);return r===null?e:JSON.parse(r)}catch{return e}},set(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(r){console.error("Storage set error:",r)}},remove(t){try{localStorage.removeItem(t)}catch{}},getRaw(t){return localStorage.getItem(t)},setRaw(t,e){localStorage.setItem(t,e)}};l.storage=b;var Ys={updatePlatformCount(t){if(!t)return;let e=t.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=t.querySelector(".platform-visible-count");r&&(r.textContent=e.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let t=document.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length,e=document.getElementById("totalNews");e&&(e.textContent=t)}};l.counts=Ys;var St={openLink(t){let e=t.dataset.url;e&&window.open(e,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(t){document.querySelectorAll(".news-item.preview").forEach(e=>{t&&e===t||e.classList.remove("preview")})},handleTitleClickV2(t,e){e.stopPropagation();let r=t.closest(".news-item");if(!r)return;let n=r.querySelector(".news-checkbox");if(n?n.checked||(n.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(n):l.readState&&typeof l.readState.markAsRead=="function"&&l.readState.markAsRead(n)):l.readState&&typeof l.readState.markItemAsRead=="function"&&l.readState.markItemAsRead(r),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}e.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(t,e){e.key==="Enter"?this.handleTitleClickV2(t,e):e.key===" "?(e.preventDefault(),this.handleTitleClickV2(t,e)):e.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(t,e)=>St.handleTitleClickV2(t,e);window.handleTitleKeydownV2=(t,e)=>St.handleTitleKeydownV2(t,e);window.openLink=t=>St.openLink(t);document.addEventListener("click",t=>{t.target.closest(".news-item")||St.closeAllPreviews(null)});document.addEventListener("touchstart",t=>{t.target.closest(".news-item")||St.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",t=>{t.key==="Escape"&&St.closeAllPreviews(null)});l.link=St;var tn={searchNews(){let e=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let n=r.textContent.toLowerCase();!e||n.includes(e)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>tn.searchNews();l.search=tn;var en="trendradar_platform_grid_scroll_v1",Us={getPlatformGridScrollState(){return b.get(en,{})},setPlatformGridScrollState(t){b.set(en,t||{})},recordPlatformGridScrollForTab(t,e){if(!t||!e)return;let r=e.scrollLeft||0,n=null,s=0,o=null,a=e.querySelectorAll(".platform-card");for(let c of a)if((c.offsetLeft||0)<=r+1)o=c;else break;o?.dataset?.platform&&(n=o.dataset.platform,s=Math.max(0,r-(o.offsetLeft||0)));let i=this.getPlatformGridScrollState();i[t]={left:r,anchorPlatformId:n,anchorOffsetX:s,updatedAt:Date.now()},this.setPlatformGridScrollState(i)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(t=>{if(t.dataset.scrollPersistBound==="1")return;t.dataset.scrollPersistBound="1";let e=!1;t.addEventListener("scroll",()=>{t.dataset.trRestoring!=="1"&&(t.dataset.trUserScrolled="1"),!e&&(e=!0,requestAnimationFrame(()=>{e=!1;let r=t.closest(".tab-pane"),n=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(n,t)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(t){let e=t?.activeTab;if(!t?.preserveScroll||!e)return;let r=this.getPlatformGridScrollState()?.[e],n=Number.isFinite(r?.left)?r.left:Number.isFinite(t.activeTabPlatformGridScrollLeft)?t.activeTabPlatformGridScrollLeft:0,s=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:t.activeTabPlatformAnchorPlatformId,o=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(t.activeTabPlatformAnchorOffsetX)?t.activeTabPlatformAnchorOffsetX:0,a=()=>{let i=document.querySelector(`#tab-${e} .platform-grid`);if(i&&i.dataset.trUserScrolled!=="1"){if(s){let c=null;if(i.querySelectorAll(".platform-card").forEach(d=>{!c&&d.dataset.platform===s&&(c=d)}),c&&c.offsetParent!==null){i.dataset.trRestoring="1",i.scrollLeft=(c.offsetLeft||0)+o,requestAnimationFrame(()=>{try{delete i.dataset.trRestoring}catch{}});return}}i.dataset.trRestoring="1",i.scrollLeft=n,requestAnimationFrame(()=>{try{delete i.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{a(),setTimeout(a,50),setTimeout(a,200),setTimeout(a,600)})})}};l.scroll=Us;var rn="trendradar_feature_badge_v1:",nn="trendradar_new_badges_dismissed_v1",or={getFeatureBadgeState(t){return b.get(rn+t,null)},setFeatureBadgeState(t,e){b.set(rn+t,e)},ensureFeatureFirstSeen(t){let e=this.getFeatureBadgeState(t);if(e&&typeof e.firstSeenAt=="number")return e;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(t,r),r},markFeatureSeen(t){let e=this.ensureFeatureFirstSeen(t);e.seenAt||(e.seenAt=Date.now(),this.setFeatureBadgeState(t,e))},shouldShowFeatureBadge(t,e){let r=this.ensureFeatureFirstSeen(t);if(r.seenAt)return!1;let n=(e||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=n},updateNewBadges(){let t=document.getElementById("newBadgeSportsTab");t&&(t.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let t=b.get(nn,{});return{categories:t?.categories||{},platforms:t?.platforms||{}}},setDismissedNewBadges(t){b.set(nn,t||{categories:{},platforms:{}})},applyDismissedNewBadges(){let t=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(e=>{let r=e?.dataset?.category;r&&t.categories?.[r]&&(e.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(e=>{let r=e?.dataset?.platform;r&&t.platforms?.[r]&&(e.style.display="none")})},dismissNewCategoryBadge(t){if(!t)return;let e=this.getDismissedNewBadges();e.categories?.[t]||(e.categories[t]=!0,this.setDismissedNewBadges(e)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(t)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(t){if(!t)return;let e=this.getDismissedNewBadges();e.platforms?.[t]||(e.platforms[t]=!0,this.setDismissedNewBadges(e)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(t)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=t=>or.dismissNewPlatformBadge(t);l.badges=or;x(function(){or.applyDismissedNewBadges()});var ot=20;var sn=10,Xs=8,Ks=80,Js=160,re={PAGE_SIZE:ot,getCardPageSize(t){let e=t?.dataset?.pageSize,r=parseInt(e||"",10),n=Number.isFinite(r)&&r>0?r:ot;return Math.min(ot,Math.max(1,n))},setCardPageSize(t,e){if(!t)return;let r=parseInt(String(e||""),10),n=Number.isFinite(r)&&r>0?r:ot;t.dataset.pageSize=String(Math.min(ot,Math.max(1,n)))},applyPagingToCard(t,e){let r=Array.from(t.querySelectorAll(".news-item")),n=r.length,s=this.getCardPageSize(t);if(n<=s){r.forEach(i=>i.classList.remove("paged-hidden")),t.dataset.pageOffset="0";return}let o=Math.max(0,Math.min(e,n-1)),a=Math.min(o+s,n);r.forEach((i,c)=>{c>=o&&c<a?i.classList.remove("paged-hidden"):i.classList.add("paged-hidden")}),t.dataset.pageOffset=String(o)},initPaging(){document.querySelectorAll(".platform-card").forEach(t=>{this.setCardPageSize(t,ot),this.applyPagingToCard(t,0)}),l.counts.updateAllCounts()},refreshPlatform(t){let e=t.closest(".platform-card");if(!e)return;let n=e.querySelectorAll(".news-item").length;if(n<=ot)return;let s=parseInt(e.dataset.pageOffset||"0",10),o=s+ot>=n?0:s+ot;this.applyPagingToCard(e,o),l.counts.updateAllCounts()},getVisibleNewsItems(t){return t?Array.from(t.querySelectorAll(".news-item")).filter(e=>!e.classList.contains("filtered")&&!e.classList.contains("search-hidden")&&!e.classList.contains("paged-hidden")&&!e.classList.contains("read")):[]},shouldAutofillCard(t,e){if(!t||t.classList.contains("platform-empty-hidden"))return!1;let r=this.getVisibleNewsItems(t),n=Number.isFinite(e)?e:sn;if(r.length<n)return!0;let s=r[r.length-1];if(!s)return!0;let o=t.getBoundingClientRect(),a=s.getBoundingClientRect();return!Number.isFinite(o.bottom)||!Number.isFinite(a.bottom)?!1:o.bottom-a.bottom>=Ks},autofillCard(t,e={}){if(!t)return!1;let r=Number.isFinite(e.minVisible)?e.minVisible:sn,n=Number.isFinite(e.maxSteps)?e.maxSteps:Xs,s=e.force===!0,o=t.querySelectorAll(".news-item").length;if(o<=0)return!1;let a=parseInt(t.dataset.pageOffset||"0",10)||0,i=this.getCardPageSize(t),c=!1,d=Math.max(0,a);for(let u=0;u<n&&!(!s&&!this.shouldAutofillCard(t,r)||o<=i);u++){let f=d+i;if(f+i>o&&(f=0),f===d)break;d=f,this.setCardPageSize(t,i),this.applyPagingToCard(t,d),c=!0}return c&&l.counts.updateAllCounts(),c},autofillForCategory(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r)return!1;let n=!1;return r.querySelectorAll(".platform-card").forEach(s=>{this.autofillCard(s,e)&&(n=!0)}),n},autofillActiveTab(t={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,t):!1},scheduleAutofillActiveTab(t={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(t)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=Js&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=t=>re.refreshPlatform(t);l.paging=re;x(function(){re.initPaging(),re.attachAutofillScrollListener(),re.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var on="trendradar_read_news_v2",an="trendradar_read_news",cn="trendradar_show_read_mode",Zs=24,K={getReadNews(){return b.get(on,{})},saveReadNews(t){b.set(on,t)},getShowReadModePref(){let t=b.getRaw(cn);return t===null?!0:t==="1"},applyShowReadMode(t){t?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let e=document.getElementById("showReadBtn");e&&(t?e.classList.add("active"):e.classList.remove("active"))},migrateOldFormat(){b.getRaw(an)&&(b.remove(an),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let t=Date.now(),e=this.getReadNews(),r=!1,n=0;for(let[s,o]of Object.entries(e))if((t-o.readAt)/36e5>=Zs){let i=document.querySelector(`[data-news-id="${s}"]`);if(i){i.classList.remove("read");let c=i.querySelector(".news-checkbox");c&&(c.checked=!1)}delete e[s],r=!0,n++}return r&&this.saveReadNews(e),n},markAsRead(t){let e=t.closest(".news-item"),r=e.dataset.newsId,n=e.dataset.newsTitle||"",s=this.getReadNews();t.checked?(e.classList.add("read"),s[r]||(s[r]={title:n.substring(0,50),readAt:Date.now()},this.saveReadNews(s))):(e.classList.remove("read"),delete s[r],this.saveReadNews(s)),l.counts.updatePlatformCount(t.closest(".platform-card")),this.updateReadCount()},markItemAsRead(t){try{if(!t)return;let e=t.dataset.newsId,r=t.dataset.newsTitle||"";if(!e)return;t.classList.add("read");let n=this.getReadNews();n[e]||(n[e]={title:String(r||"").substring(0,50),readAt:Date.now()},this.saveReadNews(n)),l.counts.updatePlatformCount(t.closest(".platform-card")),this.updateReadCount()}catch{}},updateReadCount(){let t=this.getReadNews(),e=document.getElementById("readCount");e&&(e.textContent=Object.keys(t).length)},restoreReadState(){let t=this.getReadNews();Object.keys(t).forEach(e=>{let r=document.querySelector(`[data-news-id="${e}"]`);if(r){r.classList.add("read");let n=r.querySelector(".news-checkbox");n&&(n.checked=!0)}}),l.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let t=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(t),b.setRaw(cn,t?"1":"0"),l.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(t=>{t.classList.remove("read");let e=t.querySelector(".news-checkbox");e&&(e.checked=!1)}),this.saveReadNews({}),l.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=t=>K.markAsRead(t);window.toggleShowRead=()=>K.toggleShowRead();window.clearAllRead=()=>K.clearAllRead();l.readState=K;x(function(){K.applyShowReadMode(K.getShowReadModePref()),K.migrateOldFormat();let t=K.cleanupExpiredReads();t>0&&console.log(`\u5DF2\u6E05\u7406 ${t} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),K.restoreReadState(),K.updateReadCount()});var Te="trendradar_categories_config",ir=1,E=null,I=null,wt=null,ne=!1,$t=!1,ft=!0,Qs=null,se="",J=!1;function to(t,e){let r=Array.isArray(t)?t:[],n=new Set,s=[];r.forEach(a=>{let i=String(a||"").trim();i&&(n.has(i)||(n.add(i),s.push(i)))});let o=Array.isArray(e)?e:[];o.forEach(a=>{let i=s.indexOf(a);i>=0&&s.splice(i,1)});for(let a=o.length-1;a>=0;a-=1){let i=String(o[a]||"").trim();i&&s.unshift(i)}return s}function Le(t){(!t.categoryFilters||typeof t.categoryFilters!="object")&&(t.categoryFilters={})}function ln(t){let e=t&&typeof t=="object"?t:{};return Array.isArray(e.customCategories)||(e.customCategories=[]),Array.isArray(e.hiddenDefaultCategories)||(e.hiddenDefaultCategories=[]),Array.isArray(e.hiddenPlatforms)||(e.hiddenPlatforms=[]),Array.isArray(e.categoryOrder)||(e.categoryOrder=[]),(!e.platformOrder||typeof e.platformOrder!="object")&&(e.platformOrder={}),Le(e),e}var k={CATEGORY_CONFIG_KEY:Te,ensureCategoryFilters:Le,normalizeCategoryConfig:ln,getCategoryConfig(){try{let t=b.getRaw(Te);if(!t)return null;let e=JSON.parse(t);return e.version!==ir?null:ln(e)}catch{return null}},saveCategoryConfig(t){t.version=ir,b.setRaw(Te,JSON.stringify(t)),this.syncConfigToCookie(t)},syncConfigToCookie(t){try{t.customCategories?.length>0||t.hiddenDefaultCategories?.length>0||t.hiddenPlatforms?.length>0||t.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(e){console.error("Failed to sync config to cookie:",e)}},getDefaultCategoryConfig(){return E||(E={},I={},document.querySelectorAll(".category-tab").forEach(t=>{let e=t.dataset.category,r=t.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",n=t.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||e;E[e]={id:e,name:n,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(t=>{let e=t.dataset.platform,r=t.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||e,s=t.closest(".tab-pane")?.id?.replace("tab-","")||"other";I[e]={id:e,name:r,defaultCategory:s},E[s]&&(E[s].platforms||(E[s].platforms=[]),E[s].platforms.push(e))})),{version:ir,customCategories:[],hiddenDefaultCategories:[],hiddenPlatforms:[],categoryOrder:Object.keys(E),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let t=this.getDefaultCategoryConfig(),e=this.getCategoryConfig();if(!e)return t;let r={...t,customCategories:e.customCategories||[],hiddenDefaultCategories:e.hiddenDefaultCategories||[],hiddenPlatforms:e.hiddenPlatforms||[],categoryOrder:e.categoryOrder||t.categoryOrder,platformOrder:e.platformOrder||{},categoryFilters:e.categoryFilters||{}};Object.keys(E).forEach(n=>{r.categoryOrder.includes(n)||r.categoryOrder.push(n)}),r.customCategories.forEach(n=>{r.categoryOrder.includes(n.id)||r.categoryOrder.push(n.id)});try{let n="__migrated_explore_ai_front_v1",s=Array.isArray(e.categoryOrder)?e.categoryOrder.indexOf("explore"):-1,o=Array.isArray(e.categoryOrder)?e.categoryOrder.indexOf("ai"):-1,a=s>0||s<0||o>1;if(!e[n]&&a){let i=to(r.categoryOrder,["explore","ai"]);r.categoryOrder=i,e.categoryOrder=i,e[n]=Date.now(),this.saveCategoryConfig(e)}}catch{}return r},getDefaultCategories(){return E},getAllPlatforms(){return I},addPlatformToCustomCategory(t,e){let r=String(t||"").trim(),n=String(e||"").trim();if(!r||!n)return!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();Le(s);let o=Array.isArray(s.customCategories)?s.customCategories.findIndex(c=>String(c?.id||"").trim()===r):-1;if(o<0)return!1;let a=s.customCategories[o]||{},i=Array.isArray(a.platforms)?[...a.platforms]:[];return i.includes(n)||i.push(n),s.customCategories[o]={...a,platforms:i},Array.isArray(s.categoryOrder)&&!s.categoryOrder.includes(r)&&s.categoryOrder.unshift(r),this.saveCategoryConfig(s),J=!0,!0},setDefaultCategories(t){E=t},setAllPlatforms(t){I=t},async openCategorySettings(){let t=document.getElementById("categorySettingsNewBadge");if(t&&(t.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!E||Object.keys(E).length===0)try{let n=await(await fetch("/api/news")).json();n?.categories&&(E={},I={},Object.entries(n.categories).forEach(([s,o])=>{E[s]={id:s,name:o.name,icon:o.icon,isDefault:!0,platforms:Object.keys(o.platforms||{})},Object.entries(o.platforms||{}).forEach(([a,i])=>{I[a]={id:a,name:i.name,defaultCategory:s,data:i}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),ft=!0,Qs=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let t=document.getElementById("categoryListWrapper");t&&(ft?t.classList.add("collapsed"):t.classList.remove("collapsed"));let e=document.getElementById("categoryListToggleBtn");e&&(e.textContent=ft?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){ft=!ft,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),J&&(J=!1,this.applyCategoryConfig())},saveCategorySettings(){let t=document.getElementById("categoryEditPanel");t&&t.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){J=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let t=document.getElementById("categoryList"),e=this.getMergedCategoryConfig(),r="";e.categoryOrder.forEach(s=>{let o=e.customCategories.find(d=>d.id===s),a=e.hiddenDefaultCategories.includes(s),i;if(o)i=o;else if(E[s])i=E[s];else return;let c=o?i.platforms?.length||0:E[s]?.platforms?.length||0;r+=`
                <div class="category-item ${o?"custom":""}" data-category-id="${s}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${i.name}</span>
                    <span class="category-item-platforms">${c} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${a?"":"checked"} onchange="toggleCategoryVisibility('${s}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${s}')">\u7F16\u8F91</button>
                        ${o?`<button class="category-item-btn delete" onclick="deleteCategory('${s}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),t.innerHTML=r;let n=document.getElementById("allCategoriesOffToggle");if(n){let s=e.hiddenDefaultCategories||[],o=e.categoryOrder||[];n.checked=o.length>0&&o.every(a=>s.includes(a))}$t?t.classList.add("hide-default"):t.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){$t=!$t,this.renderCategoryList()},toggleAllCategoriesOffInSettings(t){},setupCategoryDragAndDrop(){let t=document.getElementById("categoryList");t.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",n=>{r.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",n=>{n.preventDefault();let s=t.querySelector(".dragging");if(s&&s!==r){let o=r.getBoundingClientRect(),a=o.top+o.height/2;n.clientY<a?t.insertBefore(s,r):t.insertBefore(s,r.nextSibling)}})})},saveCategoryOrder(){let e=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(e).map(s=>s.dataset.categoryId),n=this.getCategoryConfig()||this.getDefaultCategoryConfig();n.categoryOrder=r,this.saveCategoryConfig(n),J=!0},toggleCategoryVisibility(t){let e=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=e.hiddenDefaultCategories.indexOf(t);r>=0?e.hiddenDefaultCategories.splice(r,1):e.hiddenDefaultCategories.push(t),this.saveCategoryConfig(e),J=!0,this.renderCategoryList()},togglePlatformHidden(t){let e=String(t||"").trim();if(!e)return!1;let r=this.getCategoryConfig()||this.getDefaultCategoryConfig();Array.isArray(r.hiddenPlatforms)||(r.hiddenPlatforms=[]);let n=r.hiddenPlatforms.findIndex(s=>String(s||"").trim()===e);return n>=0?r.hiddenPlatforms.splice(n,1):r.hiddenPlatforms.push(e),this.saveCategoryConfig(r),J=!0,this.applyCategoryConfig(),!0},showAddCategoryPanel(){ne=!0,wt=null,ft=!0,this.applyCategoryListCollapseState(),$t=!0,document.getElementById("editCategoryName").value="";let t=document.getElementById("platformSelectField");t&&(t.style.display="none");let e=document.getElementById("platformSearchInput");e&&(e.value=""),se="",this.renderPlatformSelectList([]),l.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(t){ne=!1,wt=t;let e=document.getElementById("platformSelectField");e&&(e.style.display="");let r=this.getMergedCategoryConfig(),n=r.customCategories.find(c=>c.id===t),s,o;n?(s=n,o=s.platforms||[]):(s=E[t],o=r.platformOrder[t]||s.platforms||[]),document.getElementById("editCategoryName").value=s.name,this.renderPlatformSelectList(o,n);let a=l.filter.getCategoryFilterConfig(t);l.filter.setCategoryFilterEditorState(a.mode,a.keywords),$t=!0,ft=!0,this.applyCategoryListCollapseState();let i=document.getElementById("platformSearchInput");i&&(i.value=""),se="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),wt=null,ne=!1,$t=!1,this.renderCategoryList();let t=document.getElementById("platformSearchInput");t&&(t.value=""),se=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(t,e=!1){let r=document.getElementById("platformSelectList"),s=(this.getMergedCategoryConfig().hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),o=new Set(s),a=[];t.forEach(u=>{I[u]&&a.push(u)}),e&&Object.keys(I).forEach(f=>{a.includes(f)||a.push(f)});let i=(se||"").trim().toLowerCase(),c=i?a.filter(u=>(I[u]?.name||"").toLowerCase().includes(i)):a,d=i.length>0;r.innerHTML=c.map(u=>{let f=I[u],g=t.includes(u)&&!o.has(String(u||"").trim());return`
                <label class="platform-select-item ${g?"selected":""} ${d?"no-drag":""}" data-platform-id="${u}" draggable="${d?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${g?"checked":""} onchange="togglePlatformSelect('${u}')">
                    <span>${f.name}</span>
                </label>
            `}).join(""),d||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(t){se=String(t||"");let e=this.getSelectedPlatforms();this.renderPlatformSelectList(e)},bulkSelectPlatforms(t){let e=document.getElementById("platformSelectList");if(!e)return;e.querySelectorAll(".platform-select-item").forEach(n=>{let s=n.querySelector('input[type="checkbox"]');t==="all"?(n.classList.add("selected"),s&&(s.checked=!0)):(t==="none"||t==="clear")&&(n.classList.remove("selected"),s&&(s.checked=!1))})},setupPlatformDragAndDrop(){let t=document.getElementById("platformSelectList");t.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",n=>{r.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",n=>{n.preventDefault();let s=t.querySelector(".dragging");if(s&&s!==r){let o=r.getBoundingClientRect(),a=o.top+o.height/2;n.clientY<a?t.insertBefore(s,r):t.insertBefore(s,r.nextSibling)}})})},togglePlatformSelect(t){let e=document.querySelector(`.platform-select-item[data-platform-id="${t}"]`);e&&e.classList.toggle("selected")},getSelectedPlatforms(){let t=document.querySelectorAll(".platform-select-item"),e=[];return t.forEach(r=>{r.classList.contains("selected")&&e.push(r.dataset.platformId)}),e},getOrderedPlatforms(){let t=document.querySelectorAll(".platform-select-item"),e=[];return t.forEach(r=>{let n=String(r?.dataset?.platformId||"").trim();n&&e.push(n)}),e},saveCategory(){let t=document.getElementById("editCategoryName").value.trim(),e="\u{1F4F1}",r=this.getSelectedPlatforms(),n=this.getOrderedPlatforms();if(!t)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(!ne&&r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();Le(s);let o=l.filter.getEditingFilterState();if(ne){let a="custom-"+Date.now();s.customCategories.push({id:a,name:t,icon:e,platforms:r,isCustom:!0}),s.categoryOrder.unshift(a),s.categoryFilters[a]={mode:o.mode,keywords:[...o.keywords]}}else if(wt){let a=s.customCategories.findIndex(i=>i.id===wt);if(a>=0)s.customCategories[a]={...s.customCategories[a],name:t,icon:e,platforms:r};else{s.platformOrder[wt]=n,Array.isArray(s.hiddenPlatforms)||(s.hiddenPlatforms=[]);let i=new Set((s.hiddenPlatforms||[]).map(c=>String(c||"").trim()).filter(Boolean));n.forEach(c=>{c&&(r.includes(c)?i.delete(c):i.add(c))}),s.hiddenPlatforms=Array.from(i)}s.categoryFilters[wt]={mode:o.mode,keywords:[...o.keywords]}}return this.saveCategoryConfig(s),J=!0,this.hideEditPanel(),this.renderCategoryList(),ft=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(t){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let e=this.getCategoryConfig()||this.getDefaultCategoryConfig();e.customCategories=e.customCategories.filter(r=>r.id!==t),e.categoryOrder=e.categoryOrder.filter(r=>r!==t),delete e.platformOrder[t],this.saveCategoryConfig(e),J=!0,this.renderCategoryList()},resetDefaultCategoryConfig(){if(!confirm("\u786E\u5B9A\u8981\u521D\u59CB\u5316\u9ED8\u8BA4\u680F\u76EE\u4E0E\u5361\u7247\u5417\uFF1F\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u4FDD\u7559\u3002"))return;let t=this.getCategoryConfig();if(!t){this.renderCategoryList(),this.applyCategoryConfig();return}let e=this.getDefaultCategoryConfig(),r=Array.isArray(e?.categoryOrder)?e.categoryOrder:[],n=new Set(r.map(i=>String(i||"").trim()).filter(Boolean)),s=t;s.hiddenDefaultCategories=(s.hiddenDefaultCategories||[]).filter(i=>!n.has(String(i||"").trim())),s.hiddenPlatforms=[],s.platformOrder={};let o=Array.isArray(s.customCategories)?s.customCategories.map(i=>String(i?.id||"").trim()).filter(Boolean):[],a=r.slice();for(let i of o)a.includes(i)||a.push(i);s.categoryOrder=a,this.saveCategoryConfig(s),J=!0,this.renderCategoryList(),this.applyCategoryConfig()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(b.remove(Te),E=null,I=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){l.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(t){let e=this.getMergedCategoryConfig();E?Object.entries(t).forEach(([u,f])=>{if(!E[u])E[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})};else{E[u].platforms||(E[u].platforms=[]);let g=new Set(E[u].platforms||[]);Object.keys(f.platforms||{}).forEach(m=>{g.has(m)||E[u].platforms.push(m)})}Object.entries(f.platforms||{}).forEach(([g,m])=>{I[g]||(I[g]={id:g,name:m.name,defaultCategory:u,data:m})})}):(E={},I={},Object.entries(t).forEach(([u,f])=>{E[u]={id:u,name:f.name,icon:f.icon,isDefault:!0,platforms:Object.keys(f.platforms||{})},Object.entries(f.platforms||{}).forEach(([g,m])=>{I[g]={id:g,name:m.name,defaultCategory:u,data:m}})}));let r={};Object.values(t).forEach(u=>{Object.entries(u.platforms||{}).forEach(([f,g])=>{r[f]=g})});let n={},s=e.hiddenDefaultCategories||[],o=(e.hiddenPlatforms||[]).map(u=>String(u||"").trim()).filter(Boolean),a=new Set(o),i=e.categoryOrder||Object.keys(t),c=e.customCategories||[],d=e.platformOrder||{};return i.forEach(u=>{if(s.includes(u)||String(u||"").startsWith("rsscol-"))return;let f=c.find(g=>g.id===u);if(f){let g={};(f.platforms||[]).forEach(m=>{a.has(String(m||"").trim())||r[m]&&(g[m]=r[m])}),n[u]={name:f.name,icon:"\u{1F4F1}",platforms:g}}else if(t[u]){let g=t[u],m=d[u];if(m&&m.length>0){let y=[],w=new Set;m.forEach(_=>{a.has(String(_||"").trim())||g.platforms&&g.platforms[_]&&(y.push(_),w.add(_))});let h=[],p=[];Object.keys(g.platforms||{}).forEach(_=>{w.has(_)||a.has(String(_||"").trim())||(String(_||"").startsWith("rss-")?h.push(_):p.push(_))});let v=h.concat(y,p),C={};v.forEach(_=>{a.has(String(_||"").trim())||g.platforms&&g.platforms[_]&&(C[_]=g.platforms[_])}),n[u]={...g,platforms:C}}else{let y={};Object.entries(g.platforms||{}).forEach(([w,h])=>{a.has(String(w||"").trim())||(y[w]=h)}),n[u]={...g,platforms:y}}}}),Object.keys(t).forEach(u=>{String(u||"").startsWith("rsscol-")&&String(u)!=="rsscol-rss"||!n[u]&&!s.includes(u)&&(n[u]=t[u])}),n}};window.openCategorySettings=()=>k.openCategorySettings();window.closeCategorySettings=()=>k.closeCategorySettings();window.saveCategorySettings=()=>k.saveCategorySettings();window.cancelCategorySettings=()=>k.cancelCategorySettings();window.showAddCategoryPanel=()=>k.showAddCategoryPanel();window.editCategory=t=>k.editCategory(t);window.cancelEditCategory=()=>k.cancelEditCategory();window.saveCategory=()=>k.saveCategory();window.deleteCategory=t=>k.deleteCategory(t);window.resetDefaultCategoryConfig=()=>k.resetDefaultCategoryConfig();window.resetCategoryConfig=()=>k.resetCategoryConfig();window.toggleCategoryVisibility=t=>k.toggleCategoryVisibility(t);window.toggleCategoryListCollapseInSettings=()=>k.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=t=>k.toggleAllCategoriesOffInSettings(t);window.togglePlatformSelect=t=>k.togglePlatformSelect(t);window.bulkSelectPlatforms=t=>k.bulkSelectPlatforms(t);window.setPlatformSearchQuery=t=>k.setPlatformSearchQuery(t);l.settings=k;x(function(){let t=k.getCategoryConfig();t&&k.syncConfigToCookie(t)});var dn="trendradar_filter_keywords",un="trendradar_filter_mode_v1",bt=[],ke="exclude";function Pe(t){return t==="include"?"include":"exclude"}var vt={normalizeFilterMode:Pe,getCategoryFilterConfig(t){if(!t)return{mode:"exclude",keywords:[]};let e=l.settings.getMergedCategoryConfig(),r=e.categoryFilters&&e.categoryFilters[t],n=Pe(r&&r.mode),s=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:n,keywords:s.map(o=>String(o||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(t){let e=document.getElementById(`tab-${t}`);if(!e)return;let r=this.getCategoryFilterConfig(t),n=r.mode,s=r.keywords,o=`${n}|${s.join(",")}`,i=(e.dataset?e.dataset.filterSig:null)!==o;e.dataset&&(e.dataset.filterSig=o);let c=e.dataset&&e.dataset.bulkLoading==="1";if(e.querySelectorAll(".news-item").forEach(d=>{let u=(d.textContent||"").toLowerCase(),f=s.length>0?s.some(m=>u.includes(m)):!1;(s.length===0?!1:n==="include"?!f:f)?d.classList.add("filtered"):d.classList.remove("filtered")}),n!=="include"&&e.querySelectorAll(".platform-card").forEach(d=>{d.classList.remove("platform-empty-hidden")}),n==="include"){if(s.length>0)try{if(i&&!c){if(e.querySelectorAll(".platform-card").forEach(d=>{d?.dataset&&(d.dataset.loadedDone="0")}),l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function")l.infiniteScroll.scheduleBulkLoadCategory(t,{pageSize:40});else if(l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let d=e.querySelectorAll(".platform-card").length;l.infiniteScroll.scheduleEnsureCategoryLoaded(t,{cap:d,maxPagesPerCard:2})}}}catch{}e.querySelectorAll(".platform-card").forEach(d=>{let u=d?.dataset?.loadedDone==="1",f=!u||d?.dataset?.loading==="1";if(s.length>0&&f){d.classList.add("platform-empty-hidden");return}d.classList.remove("platform-empty-hidden"),d.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&u&&d.classList.add("platform-empty-hidden")})}try{let d=e.querySelector(".category-empty-state");if(d)if(n==="include"&&s.length>0){let u=Array.from(e.querySelectorAll(".platform-card")),f=u.length>0&&u.every(m=>m?.dataset?.loadedDone==="1"&&m?.dataset?.loading!=="1"),g=e.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;d.style.display=f&&g===0?"block":"none"}else d.style.display="none"}catch{}l.counts.updateAllCounts(),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let e=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;e&&this.applyCategoryFilter(e)},setCategoryFilterEditorState(t,e){ke=Pe(t),bt=(Array.isArray(e)?e:[]).map(s=>String(s||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=ke==="include");let n=document.getElementById("categoryFilterInput");n&&(n.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(t){ke=t&&t.checked?"include":"exclude"},handleCategoryFilterKeypress(t){t.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let t=document.getElementById("categoryFilterInput"),e=(t?.value||"").trim().toLowerCase();e&&(bt.includes(e)||(bt.push(e),this.renderCategoryFilterTags()),t&&(t.value=""))},removeCategoryFilterKeyword(t){bt=bt.filter(e=>e!==t),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let t=document.getElementById("categoryFilterTags");t&&(t.innerHTML=bt.map(e=>`<span class="filter-tag">${S(e)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${S(e)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:ke,keywords:[...bt]}},migrateLegacyGlobalFilter(){let t=b.getRaw(dn),e=b.getRaw(un);if(!t&&!e)return;let r=[];try{r=t?JSON.parse(t):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(i=>String(i||"").trim().toLowerCase()).filter(Boolean);let n=Pe(e),s=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig();l.settings.ensureCategoryFilters(s),(l.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(i=>{s.categoryFilters[i]||(s.categoryFilters[i]={mode:n,keywords:[...r]})}),l.settings.saveCategoryConfig(s),b.remove(dn),b.remove(un)}};window.handleCategoryFilterModeToggle=t=>vt.handleCategoryFilterModeToggle(t);window.handleCategoryFilterKeypress=t=>vt.handleCategoryFilterKeypress(t);window.addCategoryFilterKeyword=()=>vt.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=t=>vt.removeCategoryFilterKeyword(t);l.filter=vt;x(function(){vt.migrateLegacyGlobalFilter(),vt.applyCategoryFilterForActiveTab()});var Bt="trendradar_active_tab",fn="trendradar_viewer_pos_v1";var eo="tr_explore_modal_opened",ro="tr_explore_modal_closed",_t=null,ar=0;function gn(t,e){try{let r=String(t||"").trim();if(!r)return;let n={activeTab:r,scrollY:Number(e||0)||0,updatedAt:Date.now()};b.setRaw(fn,JSON.stringify(n))}catch{}}function no(){try{let t=gt.getActiveTabId();_t=t?String(t):null,ar=window.scrollY||0;try{let e=_t?document.querySelector(`#tab-${_t} .platform-grid`):null;_t&&e&&l.scroll.recordPlatformGridScrollForTab(_t,e)}catch{}}catch{}}function so(){try{let t=b.getRaw(fn);if(!t)return;let e=JSON.parse(t),r=String(e?.activeTab||"").trim();if(!r)return;let n=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(r)):String(r);if(!document.querySelector(`.category-tab[data-category="${n}"]`))return;gt.switchTab(r);let o=Number(e?.scrollY||0)||0;requestAnimationFrame(()=>{try{window.scrollTo({top:o,behavior:"auto"})}catch{}})}catch{}}function oo(){let t=_t,e=ar;if(_t=null,ar=0,!!t){try{let r=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(t)):String(t),n=document.querySelector(`.category-tab[data-category="${r}"]`),s=document.getElementById(`tab-${t}`);if(!n||!s)return}catch{}try{l.tabs.switchTab(t)}catch{}gn(t,e),requestAnimationFrame(()=>{try{window.scrollTo({top:e,behavior:"auto"})}catch{}try{l.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t})}catch{}})}}var gt={TAB_STORAGE_KEY:Bt,switchTab(t){l.badges.dismissNewCategoryBadge(t),document.body.classList.toggle("tr-rss-reading",String(t)==="rsscol-rss");let e=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(t)):String(t),r=document.querySelector(`.category-tab[data-category="${e}"]`),n=document.getElementById(`tab-${t}`);if(!r||!n){let s=document.querySelector(".category-tab");s?.dataset?.category&&s.dataset.category!==String(t)?this.switchTab(s.dataset.category):b.remove(Bt);return}document.querySelectorAll(".category-tab").forEach(s=>s.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),n.classList.add("active"),b.setRaw(Bt,t),gn(t,window.scrollY||0),l.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t}),t==="sports"&&(l.badges.markFeatureSeen("sports-nba-schedule"),l.badges.updateNewBadges()),l.filter.applyCategoryFilter(t),l.paging&&typeof l.paging.scheduleAutofillActiveTab=="function"&&l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let s=!!n.querySelector(".news-item"),o=!!n.querySelector(".news-placeholder");!s&&o&&(l.infiniteScroll&&typeof l.infiniteScroll.scheduleBulkLoadCategory=="function"?l.infiniteScroll.scheduleBulkLoadCategory(t):l.infiniteScroll&&typeof l.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&l.infiniteScroll.scheduleEnsureCategoryLoaded(t))}catch{}},restoreActiveTab(){let t=b.getRaw(Bt);if(t){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"&&String(t)==="rsscol-rss"){b.remove(Bt);return}}catch{}document.querySelector(`.category-tab[data-category="${t}"]`)&&this.switchTab(t)}},getActiveTabId(){return b.getRaw(Bt)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(t){l.scroll.restoreActiveTabPlatformGridScroll(t)},attachPlatformGridScrollPersistence(){l.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=t=>gt.switchTab(t);l.tabs=gt;x(function(){try{window.addEventListener(eo,()=>{no()}),window.addEventListener(ro,()=>{oo()})}catch{}gt.restoreActiveTab(),so(),gt.attachPlatformGridScrollPersistence();let t=gt.getActiveTabId();t&&gt.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:t})});var cr="trendradar_active_tab",Re=20,hn="trendradar_visible_platforms_v1",lr=!1,mn=0,Dt=null,yn=null,pn=!1,Z=null;function Sn(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}return null}function wn(){if(Z)return Z;let t=Sn();if(!t)return Z={},Z;try{let e=t.getItem(hn);if(e){let r=JSON.parse(e);Z=r&&typeof r=="object"?r:{}}else Z={}}catch{Z={}}return Z}function io(){let t=Sn();if(t)try{t.setItem(hn,JSON.stringify(Z||{}))}catch{}}function ao(t,e){let r=String(t||"").trim();if(!r)return;let n=(Array.isArray(e)?e:[]).map(o=>String(o||"").trim()).filter(Boolean),s=wn();s[r]={ids:n,updatedAt:Date.now()},Z=s,io()}function co(t){let e=String(t||"").trim();if(!e)return null;let n=wn()?.[e],s=Array.isArray(n?.ids)?n.ids:null;return s?s.map(o=>String(o||"").trim()).filter(Boolean):null}function lo(t,e){let r=(Array.isArray(e)?e:[]).map(a=>String(a||"").trim()).filter(Boolean),n=co(t),s=(Array.isArray(n)?n:[]).filter(a=>r.includes(a)),o=[];for(let a of s){if(o.length>=3)break;o.includes(a)||o.push(a)}for(let a of r){if(o.length>=3)break;o.includes(a)||o.push(a)}return o}function dr(t){let r=t?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function bn(t,e){let n=String(e||"").trim().startsWith("rss-");return`${n?'<button type="button" class="tr-platform-card-delete" data-action="delete-platform">\u2212</button>':""}${n?"":'<button type="button" class="tr-platform-card-hide" data-action="hide-platform">\u{1F648}</button>'}<button type="button" class="tr-platform-card-close" data-action="close-platform">\u21C4</button>`}function uo(t,e){return new Promise(r=>{let n=!1,s=()=>{if(!n){n=!0;try{t?.removeEventListener?.("animationend",o)}catch{}r()}},o=()=>s();try{t?.addEventListener?.("animationend",o,{once:!0})}catch{}setTimeout(s,Math.max(0,Number(e||0)||0))})}var Ft=null,Ct=null;function vn(t,e,r){return new Promise(n=>{if(Ct)try{Ct(!1)}catch{}if(Ct=n,!Ft){let s=document.createElement("div");s.className="tr-confirm-overlay",s.innerHTML=`
                <div class="tr-confirm-modal" role="dialog" aria-modal="true">
                    <div class="tr-confirm-message"></div>
                    <div class="tr-confirm-actions">
                        <button type="button" class="tr-confirm-btn tr-confirm-cancel" data-action="cancel"></button>
                        <button type="button" class="tr-confirm-btn tr-confirm-ok" data-action="ok"></button>
                    </div>
                </div>`,s.addEventListener("click",o=>{let a=o?.target;if(!a||!(a instanceof Element))return;let i=a.closest('button[data-action="ok"]'),c=a.closest('button[data-action="cancel"]');if(i){o.preventDefault(),s.classList.remove("show");let d=Ct;Ct=null,d?.(!0);return}if(c||a===s){o.preventDefault(),s.classList.remove("show");let d=Ct;Ct=null,d?.(!1)}}),document.body.appendChild(s),Ft=s}try{let s=Ft.querySelector(".tr-confirm-message");s&&(s.textContent=String(t||""));let o=Ft.querySelector('button[data-action="ok"]');o&&(o.textContent=String(e||"\u786E\u8BA4"));let a=Ft.querySelector('button[data-action="cancel"]');a&&(a.textContent=String(r||"\u53D6\u6D88"))}catch{}Ft.classList.add("show")})}function fo(t,e,r,n,s={}){let o=String(t||"").trim(),a=String(e||"").trim(),i=r||{},c=S(i?.name||a),d=i?.is_new?`<span class="new-badge new-badge-platform" data-platform="${S(a)}">NEW</span>`:"",u=Array.isArray(i?.news)?i.news:[],f=u.length,g=Math.min(f,Re),m=a&&n?.pagingOffsets&&Number.isFinite(n.pagingOffsets[a])?n.pagingOffsets[a]:0,w=u.slice(0,g).map((M,O)=>{let st=S(M?.stable_id||""),te=S(M?.display_title||M?.title||""),B=S(M?.url||""),dt=S(M?.meta||""),er=String(a||"").startsWith("rss-"),_e=!!M?.is_cross_platform,Ce=Array.isArray(M?.cross_platforms)?M.cross_platforms:[],Ae=S(Ce.join(", ")),xe=S(M?.cross_platform_count??""),Ee=_e?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${Ae}">\u{1F525} ${xe}</span>`:"",Wr=_e?"cross-platform":"",rr=`<span class="news-index">${String(O+1)}</span>`,nr=O<m||O>=m+Re?" paged-hidden":"",Yr=dt&&!er?`<div class="news-subtitle">${dt}</div>`:"";return`
            <li class="news-item${nr}" data-news-id="${st}" data-news-title="${te}">
                <div class="news-item-content">
                    ${rr}
                    <a class="news-title ${Wr}" href="${B||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                        ${te}
                        ${Ee}
                    </a>
                </div>
                ${Yr}
            </li>`}).join("")||'<li class="news-placeholder" aria-hidden="true">\u5F85\u52A0\u8F7D...</li>',h=bn(o,a),C=`
        <div class="platform-card${s&&s.animateIn?" tr-explore-flip-in":""}" data-platform="${S(a)}" data-total-count="${String(f)}" data-loaded-count="${String(g)}" draggable="false" data-rotatable-category="${S(o)}">
            <div class="platform-header">
                <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${S(a)}')">\u{1F4F1} ${c}${d}</div>
                <div class="platform-header-actions">${h}</div>
            </div>
            <ul class="news-list">${w}
            </ul>
            <div class="news-load-sentinel" aria-hidden="true"></div>
        </div>`,_=document.createElement("div");return _.innerHTML=C.trim(),_.firstElementChild}async function go(t){if(!t||!(t instanceof Element))return;let e=dr(t);if(!e||e==="explore"||e==="rsscol-rss")return;let r=yn;if(!r||!r[e]||!r[e].platforms)return;let n=r[e].platforms||{},s=Object.keys(n);if(s.length<=0)return;let o=t.closest(".platform-grid"),i=(o?Array.from(o.querySelectorAll(".platform-card[data-platform]")):[]).map(w=>String(w?.getAttribute?.("data-platform")||"").trim()).filter(Boolean);if(s.length<=i.length)return;let c=String(t.getAttribute("data-platform")||"").trim(),d=String(i[i.length-1]||"").trim(),u=s.findIndex(w=>String(w||"").trim()===d);u<0&&(u=s.findIndex(w=>String(w||"").trim()===c)),u<0&&(u=0);let f=null;for(let w=1;w<=s.length;w+=1){let h=s[(u+w)%s.length],p=String(h||"").trim();if(p&&!i.includes(p)){f=p;break}}if(!f)return;let g=oe.snapshotViewerState(),m=n[f];if(!m)return;try{let w=t.querySelector('button[data-action="close-platform"]');w&&w.setAttribute("disabled","true")}catch{}try{t.classList.remove("tr-explore-flip-in"),t.classList.add("tr-explore-flip-out")}catch{}await uo(t,360);let y=fo(e,f,m,g,{animateIn:!0});if(y){try{t&&t.parentNode&&t.parentNode.replaceChild(y,t)}catch{}try{let w=i.map(h=>String(h||"").trim()===c?f:h).filter(Boolean);ao(e,w)}catch{}try{l.paging?.setCardPageSize&&l.paging.setCardPageSize(y,l.paging.PAGE_SIZE),l.paging?.applyPagingToCard&&l.paging.applyPagingToCard(y,0)}catch{}try{l.counts?.updateAllCounts?.(),l.readState?.updateReadCount?.()}catch{}}}async function mo(t){let e=String(t||"").trim();if(!e)return!1;try{let r=await fetch("/api/me/rss-subscriptions",{method:"GET"});if(!r.ok)return!1;let n=await r.json().catch(()=>({}));return!(Array.isArray(n?.subscriptions)?n.subscriptions:[]).some(a=>String(a?.source_id||a?.rss_source_id||"").trim()===e)}catch{return!1}}async function po(t){let e=String(t||"").trim();if(!e.startsWith("rss-"))return!1;let r=e.slice(4);if(!r||!l.subscription)return!1;try{l.subscription.ensureSnapshot?.()}catch{}let n=[];try{n=l.subscription.getSubscriptions?l.subscription.getSubscriptions():[]}catch{n=[]}let s=(Array.isArray(n)?n:[]).filter(o=>String(o?.source_id||o?.rss_source_id||"").trim()!==r);try{l.subscription.setSubscriptions?.(s)}catch{return!1}try{l.subscription.saveOnly?await l.subscription.saveOnly():l.subscription.saveAndRefresh&&await l.subscription.saveAndRefresh()}catch{return!1}return await mo(r)}async function ho(t){if(!t||!(t instanceof Element))return;let e=dr(t),r=String(t.getAttribute("data-platform")||"").trim();if(!e||!r||e==="explore"||!r.startsWith("rss-"))return;try{if(!await vn("\u786E\u5B9A\u8981\u5220\u9664\u8BE5 RSS \u5361\u7247\u5417\uFF1F\u5220\u9664\u540E\u5C06\u53D6\u6D88\u8BA2\u9605\u3002","\u786E\u8BA4\u5220\u9664","\u53D6\u6D88"))return}catch{}try{let i=t.querySelector('button[data-action="delete-platform"]');i&&i.setAttribute("disabled","true")}catch{}let s=t.parentNode,o=t.nextSibling;try{s&&s.removeChild(t)}catch{}try{l.counts?.updateAllCounts?.()}catch{}if(!await po(r)){try{s&&(o?s.insertBefore(t,o):s.appendChild(t))}catch{}try{let i=t.querySelector('button[data-action="delete-platform"]');i&&i.removeAttribute("disabled")}catch{}try{l.toast?.show?.("\u5220\u9664\u5931\u8D25\uFF1A\u8BA2\u9605\u672A\u80FD\u4ECE\u670D\u52A1\u7AEF\u79FB\u9664\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"error",durationMs:2500})}catch{}return}}var oe={formatUpdatedAt:ee,snapshotViewerState(){let t=b.getRaw(cr)||document.querySelector(".category-tab.active")?.dataset?.category||null,e={};document.querySelectorAll(".platform-card").forEach(a=>{let i=a.dataset.platform;i&&(e[i]=parseInt(a.dataset.pageOffset||"0",10)||0)});let r=t?document.querySelector(`#tab-${t} .platform-grid`):null,n=r&&r.scrollLeft||0,s=null,o=0;if(r){let a=r.scrollLeft||0,i=null,c=r.querySelectorAll(".platform-card");for(let d of c)if((d.offsetLeft||0)<=a+1)i=d;else break;i?.dataset?.platform&&(s=i.dataset.platform,o=Math.max(0,a-(i.offsetLeft||0)))}return t&&r&&l.scroll.recordPlatformGridScrollForTab(t,r),{activeTab:t,pagingOffsets:e,activeTabPlatformGridScrollLeft:n,activeTabPlatformAnchorPlatformId:s,activeTabPlatformAnchorOffsetX:o,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(t,e){let r=document.querySelector(".tab-content-area"),n=document.querySelector(".category-tabs");if(!n||!r)return;let s=l.settings.applyCategoryConfigToData(t?.categories||{});yn=s;let o=e&&typeof e.activeTab=="string"?e.activeTab:null,a=(()=>{try{return new URLSearchParams(window.location.search).get("e2e")==="1"}catch{return!1}})(),i=Object.keys(s||{}),c=i[0]||null;c==="explore"&&(c=i.find(p=>p!=="explore")||c),a&&c==="rsscol-rss"&&(c=i.find(p=>p!=="rsscol-rss")||c);let d=o||c;d==="explore"&&(d=i.find(p=>p!=="explore")||d),a&&d==="rsscol-rss"&&(d=i.find(p=>p!=="rsscol-rss")||d);let u=Object.entries(s).map(([p,v])=>{let C=S(v?.icon||""),_=S(v?.name||p),st=`${v?.is_new?`<span class="new-badge new-badge-category" data-category="${S(p)}">NEW</span>`:""}${p==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab${String(p)===String(d)?" active":""}" data-category="${S(p)}" draggable="false" onclick="switchTab('${S(p)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${C}</div>
                <div class="category-tab-name">${_}${st}</div>
            </div>`}).join(""),f=Object.entries(s).map(([p,v])=>{let C=!!d&&String(p)===String(d),_=C?" active":"";if(String(p)==="rsscol-rss")return`
                <div class="tab-pane${_}" id="tab-${S(p)}">
                    <div class="platform-grid" style="display:flex;flex-direction:column;gap:10px;min-height:0;">
                        
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <div id="rssCategoryCarouselStatus" style="color:#6b7280;font-size:0.85rem;flex:1;min-width:200px;"></div>
                    </div>
                        <div id="rssCategoryCarouselGrid" style="display:flex;flex-direction:column;gap:10px;min-height:0;"></div>
                    </div>
                    <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
                </div>`;if(String(p)==="explore")return`
                <div class="tab-pane${_}" id="tab-${S(p)}">
                    <div class="platform-grid" id="trExploreGrid"></div>
                </div>`;let M=v?.platforms||{},O=Object.keys(M||{}),te=lo(p,O).map(B=>{let dt=M?.[B];if(!dt)return"";let er=S(dt?.name||B),_e=dt?.is_new?`<span class="new-badge new-badge-platform" data-platform="${S(B)}">NEW</span>`:"",Ce=Array.isArray(dt?.news)?dt.news:[],Ae=Ce.length,xe=C?Math.min(Ae,Re):0,Ee=B&&e?.pagingOffsets&&Number.isFinite(e.pagingOffsets[B])?e.pagingOffsets[B]:0,rr=Ce.slice(0,xe).map((X,sr)=>{let Is=S(X?.stable_id||""),Ur=S(X?.display_title||X?.title||""),Ns=S(X?.url||""),Xr=S(X?.meta||""),$s=String(B||"").startsWith("rss-"),Kr=!!X?.is_cross_platform,Bs=Array.isArray(X?.cross_platforms)?X.cross_platforms:[],Ds=S(Bs.join(", ")),Fs=S(X?.cross_platform_count??""),qs=Kr?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${Ds}">\u{1F525} ${Fs}</span>`:"",Hs=Kr?"cross-platform":"",js=`<span class="news-index">${String(sr+1)}</span>`,Gs=sr<Ee||sr>=Ee+Re?" paged-hidden":"",Vs=Xr&&!$s?`<div class="news-subtitle">${Xr}</div>`:"";return`
                        <li class="news-item${Gs}" data-news-id="${Is}" data-news-title="${Ur}">
                            <div class="news-item-content">
                                ${js}
                                <a class="news-title ${Hs}" href="${Ns||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${Ur}
                                    ${qs}
                                </a>
                            </div>
                            ${Vs}
                        </li>`}).join("")||(C?"":'<li class="news-placeholder" aria-hidden="true">\u5F85\u52A0\u8F7D...</li>'),nr=bn(p,B);return`
                <div class="platform-card" data-platform="${S(B)}" data-total-count="${String(Ae)}" data-loaded-count="${String(xe)}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${S(B)}')">\u{1F4F1} ${er}${_e}</div>
                        <div class="platform-header-actions">${nr}</div>
                    </div>
                    <ul class="news-list">${rr}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).filter(Boolean).join("");return`
            <div class="tab-pane${_}" id="tab-${S(p)}">
                <div class="platform-grid">${te}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");n.innerHTML=u,r.innerHTML=f;try{let p=!!window.matchMedia&&window.matchMedia("(max-width: 640px)").matches,v=n.querySelectorAll(".category-tab").length;p?n.classList.remove("compact"):n.classList.toggle("compact",v>8)}catch{}let g=document.getElementById("updatedAt");g&&t?.updated_at&&(g.textContent=ee(t.updated_at));let m=e&&typeof e.activeTab=="string"?e.activeTab:null;if(m){let p=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(m):m;if(document.querySelector(`.category-tab[data-category="${p}"]`))l.tabs.switchTab(m);else{let C=document.querySelector(".category-tab");C?.dataset?.category?l.tabs.switchTab(C.dataset.category):b.remove(cr)}}else{let p=document.querySelector(".category-tab");p?.dataset?.category?l.tabs.switchTab(p.dataset.category):b.remove(cr)}let y=typeof e?.showReadMode=="boolean"?e.showReadMode:l.readState.getShowReadModePref();l.readState.applyShowReadMode(y);let w=document.getElementById("searchInput");w&&typeof e?.searchText=="string"&&(w.value=e.searchText),l.search.searchNews(),l.filter.applyCategoryFilterForActiveTab(),l.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(p=>{let v=p.dataset.platform,C=v&&e?.pagingOffsets&&Number.isFinite(e.pagingOffsets[v])?e.pagingOffsets[v]:0;l.paging.setCardPageSize(p,l.paging.PAGE_SIZE),l.paging.applyPagingToCard(p,C)}),l.counts.updateAllCounts(),l.readState.updateReadCount(),l.scroll.restoreActiveTabPlatformGridScroll(e),l.scroll.attachPlatformGridScrollPersistence();let h=document.getElementById("early-hide");h&&h.remove(),document.body.classList.add("categories-ready"),l.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{l.infiniteScroll&&typeof l.infiniteScroll.attach=="function"&&l.infiniteScroll.attach()}catch{}},async refreshViewerData(t={}){let e=t.preserveScroll!==!1;if(lr){Dt?Dt.preserveScroll=Dt.preserveScroll&&e:Dt={preserveScroll:e};return}lr=!0;try{let r=this.snapshotViewerState();r.preserveScroll=e;let s=await(await fetch("/api/news")).json();this.renderViewerFromData(s,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),l.scroll.restoreActiveTabPlatformGridScroll(r)),mn=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{lr=!1;let r=Dt;Dt=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let t=document.getElementById("fetchBtn"),e=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),n=document.getElementById("fetchStatus");t.classList.add("loading"),t.disabled=!0,e.classList.add("show"),r.classList.add("indeterminate"),n.className="fetch-status",n.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let o=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),o.success?(r.style.width="100%",n.className="fetch-status success",n.textContent=`\u2705 ${o.platforms} \u4E2A\u5E73\u53F0\uFF0C${o.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${o.error}`)}catch(s){r.classList.remove("indeterminate"),r.style.width="0%",n.className="fetch-status error",n.textContent=`\u274C ${s.message}`}finally{t.classList.remove("loading"),t.disabled=!1,setTimeout(()=>{e.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-mn<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};window.fetchData=()=>oe.fetchData();window.refreshViewerData=t=>oe.refreshViewerData(t);l.data=oe;x(function(){let t=document.getElementById("updatedAt");t&&t.textContent&&(t.textContent=ee(t.textContent)),oe.setupAjaxAutoRefresh(),pn||(pn=!0,document.addEventListener("click",e=>{let r=e?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="close-platform"]');if(!n)return;let s=n.closest(".platform-card");if(!s)return;let o=dr(s);!o||o==="explore"||o==="rsscol-rss"||go(s).catch(()=>{})}),document.addEventListener("click",e=>{let r=e?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="delete-platform"]');if(!n)return;let s=n.closest(".platform-card");s&&ho(s).catch(()=>{})}),document.addEventListener("click",async e=>{let r=e?.target;if(!r||!(r instanceof Element))return;let n=r.closest('button[data-action="hide-platform"]');if(!n)return;let s=n.closest(".platform-card"),o=String(s?.getAttribute?.("data-platform")||"").trim();if(!(!o||o.startsWith("rss-")||!await vn("\u786E\u5B9A\u8981\u9690\u85CF\u8BE5\u5361\u7247\u5417\uFF1F\u9690\u85CF\u540E\u8BE5\u5361\u7247\u5C06\u4E0D\u518D\u663E\u793A\uFF0C\u4F60\u53EF\u4EE5\u5728\u300C\u680F\u76EE\u8BBE\u7F6E\u300D\u4E2D\u91CD\u65B0\u52FE\u9009\u5E76\u4FDD\u5B58\u6765\u6062\u590D\u663E\u793A\u3002","\u786E\u8BA4\u9690\u85CF","\u53D6\u6D88"))){try{n.setAttribute("disabled","true")}catch{}try{l.settings?.togglePlatformHidden?.(o)}catch{}}}))});var Me=20,yo="240px 0px 240px 0px",j=20,ie=null,ur=!1,ae=0,So=1,_n=0,wo=600,Oe=null,ce=null,bo=160,Ie=null,le=null,vo=250;function _o(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}function fr(t,e){try{let r=t?.querySelector?.(".news-list");if(!r)return;let n=r.querySelector(".news-placeholder");n||(n=document.createElement("li"),n.className="news-placeholder",n.setAttribute("aria-hidden","true"),r.appendChild(n)),n.textContent=String(e||"")}catch{}}function Cn(){if(clearTimeout(Oe),Oe=null,ce){try{ce.abort()}catch{}ce=null}try{document.querySelectorAll(".platform-card").forEach(t=>{let e=t?.querySelector?.(".news-list");if(!e)return;let r=e.querySelector(".news-placeholder");!r||e.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function Co(t,e={}){Cn(),ce=new AbortController;let r=ce.signal;Oe=setTimeout(()=>{Oe=null,En(t,{...e,signal:r}).catch(()=>{})},bo)}function An(){if(clearTimeout(Ie),Ie=null,le){try{le.abort()}catch{}le=null}}function Ao(t,e,r){let n=document.createElement("li");n.className="news-item",n.dataset.newsId=String(t?.stable_id||""),n.dataset.newsTitle=String(t?.display_title||t?.title||"");let s=document.createElement("div");s.className="news-item-content";let o=document.createElement("span");o.className="news-index",o.textContent=String(e);let a=document.createElement("a");if(a.className="news-title",t?.is_cross_platform&&a.classList.add("cross-platform"),a.href=String(t?.url||"#"),a.target="_blank",a.rel="noopener noreferrer",a.setAttribute("onclick","handleTitleClickV2(this, event)"),a.setAttribute("onauxclick","handleTitleClickV2(this, event)"),a.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),a.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),a.textContent=String(t?.display_title||t?.title||""),t?.is_cross_platform){let d=Array.isArray(t?.cross_platforms)?t.cross_platforms:[],u=document.createElement("span");u.className="cross-platform-badge",u.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${d.join(", ")}`,u.textContent=`\u{1F525} ${String(t?.cross_platform_count??"")}`,a.appendChild(document.createTextNode(" ")),a.appendChild(u)}s.appendChild(o),s.appendChild(a),n.appendChild(s);let i=String(t?.meta||"").trim(),c=String(r||"").startsWith("rss-");if(i&&!c){let d=document.createElement("div");d.className="news-subtitle",d.textContent=i,n.appendChild(d)}return Ln(n),Tn(n),n}async function xn(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let n=e.signal;if(n?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let s=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(s=l.filter.getCategoryFilterConfig(t))}catch{s=null}let o=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],i=Number.isFinite(e.pageSize)?e.pageSize:j,c=Math.min(Math.max(1,i),j),d=Array.from(r.querySelectorAll(".platform-card")),u=d.map(m=>(m?.dataset?.platform||"").trim()).filter(Boolean);if(u.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let m of d)m&&(m.dataset.loading="1",fr(m,"\u52A0\u8F7D\u4E2D..."));let f;try{let m=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(c))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:u}),signal:n});if(!m.ok)return;f=await m.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let g=f&&f.platforms||{};for(let m of d){if(n?.aborted)return;let y=(m?.dataset?.platform||"").trim();if(!y)continue;let w=m.querySelector(".news-list");if(!w)continue;w.querySelectorAll(".news-placeholder").forEach(C=>C.remove()),w.querySelectorAll(".news-item").forEach(C=>C.remove());let h=g[y]||{},p=Array.isArray(h.items)?h.items:[];for(let C=0;C<p.length;C++)w.appendChild(Ao(p[C],C+1,y));let v=w.querySelectorAll(".news-item").length;m.dataset.loadedCount=String(v),m.dataset.hasMore=h.has_more&&v<j?"1":"0",m.dataset.loading="0",m.dataset.loadedDone="1";try{if(l.paging){let C=Math.min(j,v);l.paging.setCardPageSize(m,C),l.paging.applyPagingToCard(m,0)}}catch{}l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(m)}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(t)}catch{}}function xo(t,e={}){An(),le=new AbortController;let r=le.signal;Ie=setTimeout(()=>{Ie=null,xn(t,{...e,signal:r}).catch(()=>{})},vo)}async function En(t,e={}){let r=document.getElementById(`tab-${t}`);if(!r||!r.classList.contains("active"))return;let n=e.signal;if(n?.aborted)return;let s=null;try{l.filter&&typeof l.filter.getCategoryFilterConfig=="function"&&(s=l.filter.getCategoryFilterConfig(t))}catch{s=null}let o=s?.mode||"exclude",a=Array.isArray(s?.keywords)?s.keywords:[],i=o==="include"&&a.length>0,c=Number.isFinite(e.maxPagesPerCard)?e.maxPagesPerCard:i?2:1,d=Number.isFinite(e.cap)?e.cap:i?10:4,u=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,d));for(let f of u){if(n?.aborted)return;if(!f)continue;let g=f.querySelector(".news-list");if(!g)continue;let m=g.querySelectorAll(".news-item").length;if(i&&m>0){f.dataset.loadedDone="1";continue}if(!i&&m>0){f.dataset.loadedDone="1";continue}let y=Me;for(let w=0;w<c;w++){if(n?.aborted)return;fr(f,"\u52A0\u8F7D\u4E2D..."),await kn(f,Math.min(y,j),{signal:n});try{l.paging&&(l.paging.setCardPageSize(f,Math.min(y,j)),l.paging.applyPagingToCard(f,0))}catch{}let h=f.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!i||h>0||!(f.dataset.hasMore!=="0"))break;y+=Me}f.dataset.loadedDone="1"}l.counts?.updateAllCounts&&l.counts.updateAllCounts();try{l.filter&&typeof l.filter.applyCategoryFilter=="function"&&l.filter.applyCategoryFilter(t)}catch{}}function Tn(t){try{let e=_o();if(!e||!l.filter?.getCategoryFilterConfig)return;let r=l.filter.getCategoryFilterConfig(e),n=r?.mode||"exclude",s=Array.isArray(r?.keywords)?r.keywords:[],o=(t?.textContent||"").toLowerCase(),a=s.length>0?s.some(c=>o.includes(c)):!1;(s.length===0?!1:n==="include"?!a:a)?t.classList.add("filtered"):t.classList.remove("filtered")}catch{}}function Ln(t){try{let e=t?.dataset?.newsId;if(!e||!l.readState?.getReadNews||!(l.readState.getReadNews()||{})[e])return;t.classList.add("read")}catch{}}async function kn(t,e,r={}){let n=(t?.dataset?.platform||"").trim();if(!n)return{ok:!1,hasMore:!1};let s=r.signal;if(s?.aborted)return{ok:!1,hasMore:!0};if(t.dataset.loading==="1")return{ok:!1,hasMore:!0};if(t.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let o=t.querySelector(".news-list");if(!o)return{ok:!1,hasMore:!1};o.querySelectorAll(".news-placeholder").forEach(i=>i.remove()),e=Math.min(Math.max(0,e||0),j);let a=o.querySelectorAll(".news-item").length;if(a>=j)return t.dataset.hasMore="0",{ok:!1,hasMore:!1};if(a>=e)return{ok:!0,hasMore:!0};t.dataset.loading="1";try{if(ae>=So)return{ok:!1,hasMore:!0};ae+=1;let i=Math.min(Me,Math.max(0,j-a));if(i<=0)return t.dataset.hasMore="0",{ok:!1,hasMore:!1};let c=`/api/news/page?platform_id=${encodeURIComponent(n)}&offset=${encodeURIComponent(String(a))}&page_size=${encodeURIComponent(String(i))}`,d;try{d=await fetch(c,{signal:s})}catch(m){if(s?.aborted||m&&m.name==="AbortError")return t.querySelectorAll(".news-item").length<=0&&fr(t,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw m}if(!d.ok)return{ok:!1,hasMore:!0};let u=await d.json(),f=Array.isArray(u?.items)?u.items:[],g=!!u?.has_more;(!g||a+f.length>=j)&&(t.dataset.hasMore="0");for(let m=0;m<f.length;m++){let y=f[m]||{},w=a+m+1,h=document.createElement("li");h.className="news-item",h.dataset.newsId=String(y.stable_id||""),h.dataset.newsTitle=String(y.display_title||y.title||"");let p=document.createElement("div");p.className="news-item-content";let v=document.createElement("input");v.type="checkbox",v.className="news-checkbox",v.title="\u6807\u8BB0\u5DF2\u8BFB",v.addEventListener("change",()=>{try{window.markAsRead(v)}catch{}});let C=document.createElement("span");C.className="news-index",C.textContent=String(w);let _=document.createElement("a");if(_.className="news-title",y.is_cross_platform&&_.classList.add("cross-platform"),_.href=String(y.url||"#"),_.target="_blank",_.rel="noopener noreferrer",_.setAttribute("onclick","handleTitleClickV2(this, event)"),_.setAttribute("onauxclick","handleTitleClickV2(this, event)"),_.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),_.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),_.textContent=String(y.display_title||y.title||""),y.is_cross_platform){let O=Array.isArray(y.cross_platforms)?y.cross_platforms:[],st=document.createElement("span");st.className="cross-platform-badge",st.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${O.join(", ")}`,st.textContent=`\u{1F525} ${String(y.cross_platform_count??"")}`,_.appendChild(document.createTextNode(" ")),_.appendChild(st)}p.appendChild(v),p.appendChild(C),p.appendChild(_),h.appendChild(p);let M=String(y.meta||"").trim();if(M){let O=document.createElement("div");O.className="news-subtitle",O.textContent=M,h.appendChild(O)}o.appendChild(h),Ln(h),Tn(h)}return t.dataset.loadedCount=String(o.querySelectorAll(".news-item").length),l.counts?.updatePlatformCount&&l.counts.updatePlatformCount(t),{ok:!0,hasMore:g}}finally{ae=Math.max(0,ae-1),t.dataset.loading="0"}}async function Eo(t){if(!t||!l.paging)return;let e=t.closest(".tab-pane");if(e&&!e.classList.contains("active"))return;let r=Date.now();if(r<_n)return;_n=r+wo;let n=parseInt(t.dataset.pageOffset||"0",10)||0,s=l.paging.getCardPageSize(t),o=Math.max(0,j-n);if(s>=o){t.dataset.hasMore="0";return}let a=Math.min(s+Me,o),i=n+a;await kn(t,i);let c=t.querySelectorAll(".news-item").length,d=Math.min(Math.max(s,a),Math.max(c-n,s)),u=Math.min(d,o);l.paging.setCardPageSize(t,u),l.paging.applyPagingToCard(t,n),l.counts?.updateAllCounts&&l.counts.updateAllCounts()}function Pn(){if(ie){try{ie.disconnect()}catch{}ie=null}ie=new IntersectionObserver(t=>{for(let e of t){if(!e.isIntersecting||!ur||ae>0)continue;let n=e.target?.closest?.(".platform-card");n&&Eo(n).catch(()=>{})}},{root:null,rootMargin:yo,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(t=>ie.observe(t))}l.infiniteScroll={attach:Pn,ensureCategoryLoaded:En,scheduleEnsureCategoryLoaded:Co,cancelEnsureCategoryLoaded:Cn,bulkLoadCategory:xn,scheduleBulkLoadCategory:xo,cancelBulkLoadCategory:An};x(function(){try{window.addEventListener("scroll",()=>{ur=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{ur=!0},1200),Pn()});function gr(t){let r=t?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function To(t,e){if(!t||!Array.isArray(e))return;let r=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig(),n=l.settings.normalizeCategoryConfig(r);if((l.settings.getMergedCategoryConfig().customCategories||[]).find(a=>a.id===t)){let a=(n.customCategories||[]).findIndex(i=>i.id===t);a>=0&&(n.customCategories[a]={...n.customCategories[a],platforms:e})}else(!n.platformOrder||typeof n.platformOrder!="object")&&(n.platformOrder={}),n.platformOrder[t]=e;l.settings.saveCategoryConfig(n)}var Rn={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,attach(){if(this._attached)return;this._attached=!0;let t=40,e=18,r=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},n=()=>{if(this._autoScrollRaf)return;let o=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){r();return}let a=this._autoScrollGrid,i=Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0));if(i<=0){r();return}let c=Math.max(0,Math.min(i,(a.scrollLeft||0)+this._autoScrollDir*this._autoScrollSpeed));a.scrollLeft=c,this._autoScrollRaf=requestAnimationFrame(o)};this._autoScrollRaf=requestAnimationFrame(o)},s=(o,a)=>{if(!this._draggingCard||!a){r();return}if(Math.max(0,(a.scrollWidth||0)-(a.clientWidth||0))<=0){r();return}let c=a.getBoundingClientRect(),d=o.clientX,u=d-c.left,f=c.right-d,g=0,m=0;if(u>=0&&u<=t)g=-1,m=u;else if(f>=0&&f<=t)g=1,m=f;else{r();return}let y=Math.max(0,Math.min(1,(t-m)/t)),w=Math.max(1,Math.round(y*y*e));this._autoScrollGrid=a,this._autoScrollDir=g,this._autoScrollSpeed=w,n()};document.addEventListener("dragstart",o=>{let a=o.target?.closest?.(".platform-drag-handle");if(!a)return;let i=a.closest(".platform-card"),c=a.closest(".platform-grid"),d=gr(c),u=i?.dataset?.platform||null;if(!(!i||!c||!d||!u)){this._draggingCard=i,this._draggingPlatformId=u,this._originGrid=c,this._originCategoryId=d,i.classList.add("dragging"),o.dataTransfer.effectAllowed="move";try{o.dataTransfer.setData("text/plain",u)}catch{}}},!0),document.addEventListener("dragend",o=>{let a=o.target?.closest?.(".platform-drag-handle");if(!a)return;let i=a.closest(".platform-card"),c=a.closest(".platform-grid"),d=gr(c);if(!i||!c||!d){this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r();return}let u=Array.from(c.querySelectorAll(".platform-card")).map(f=>f.dataset.platform).filter(Boolean);To(d,u),i.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r()},!0),document.addEventListener("dragover",o=>{let a=o.target?.closest?.(".platform-grid");if(!a||!this._draggingCard||this._originGrid&&a!==this._originGrid)return;let i=gr(a);if(!i||this._originCategoryId&&i!==this._originCategoryId)return;o.preventDefault(),s(o,a);let c=o.target?.closest?.(".platform-card");if(!c||c===this._draggingCard)return;let d=Array.from(a.querySelectorAll(".platform-card")),u=d.indexOf(this._draggingCard),f=d.indexOf(c);u<0||f<0||u===f||(u<f?a.insertBefore(this._draggingCard,c.nextSibling):a.insertBefore(this._draggingCard,c))},!0),document.addEventListener("drop",o=>{let a=o.target?.closest?.(".platform-grid");!a||!this._draggingCard||this._originGrid&&a!==this._originGrid||(o.preventDefault(),r())},!0)}};l.platformReorder=Rn;x(()=>{Rn.attach()});function Lo(t){return t?Array.from(t.querySelectorAll(".category-tab")).map(e=>String(e?.dataset?.category||"").trim()).filter(Boolean):[]}function ko(t){if(!Array.isArray(t)||t.length===0)return;let e=l.settings.getCategoryConfig()||l.settings.getDefaultCategoryConfig(),r=l.settings.normalizeCategoryConfig(e),n=l.settings.getMergedCategoryConfig(),s=Array.isArray(n?.categoryOrder)&&n.categoryOrder.length>0?n.categoryOrder.slice():t.slice(),o=new Set(t),a=0,i=s.map(c=>{let d=String(c||"").trim();if(!d||!o.has(d))return d;let u=t[a];return a+=1,u});r.categoryOrder=i,l.settings.saveCategoryConfig(r)}function Po(t){let e=document.querySelector(".tab-content-area");if(!e)return;let r=new Map;e.querySelectorAll(".tab-pane").forEach(s=>{let o=String(s?.id||"");o.startsWith("tab-")&&r.set(o.slice(4),s)});let n=document.createDocumentFragment();for(let s of t){let o=r.get(s);o&&n.appendChild(o)}for(let[s,o]of r.entries())t.includes(s)||n.appendChild(o);e.appendChild(n)}function Mn(){let t=document.querySelector(".category-tabs");t&&t.querySelectorAll(".category-tab").forEach(e=>{try{e.setAttribute("draggable","false");let r=e.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",e.insertBefore(r,e.firstChild))}catch{}})}function Ro(){let t=document.querySelector(".category-tabs");if(t)try{new MutationObserver(()=>{Mn()}).observe(t,{childList:!0,subtree:!0})}catch{}}function Mo(){let t=document.body;if(!t)return;let e=0,r=0,n=!1,s=()=>{e&&(window.clearTimeout(e),e=0),r&&(window.clearTimeout(r),r=0)},o=()=>{n=!1,t.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",i=>{!i.target?.closest?.(".category-tabs")||!i.target?.closest?.(".category-tab")||i.target?.closest?.(".category-drag-handle")||(s(),e=window.setTimeout(()=>{n=!0,t.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{o()},2500)},380))},!0);let a=()=>{s(),n&&o()};document.addEventListener("pointerup",a,!0),document.addEventListener("pointercancel",a,!0),document.addEventListener("scroll",a,!0)}var On={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,Mn(),Ro(),Mo(),document.addEventListener("click",t=>{t.target?.closest?.(".category-drag-handle")&&(t.preventDefault(),t.stopPropagation())},!0),document.addEventListener("dragstart",t=>{let e=t.target?.closest?.(".category-drag-handle");if(!e)return;let r=e.closest(".category-tab"),n=e.closest(".category-tabs"),s=r?.dataset?.category;if(!(!r||!n||!s)){this._draggingTab=r,this._originTabsEl=n,r.classList.add("dragging"),t.dataTransfer.effectAllowed="move";try{t.dataTransfer.setData("text/plain",String(s))}catch{}}},!0),document.addEventListener("dragover",t=>{let e=t.target?.closest?.(".category-tabs");if(!e||!this._draggingTab||this._originTabsEl&&e!==this._originTabsEl)return;let r=t.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;t.preventDefault();let n=Array.from(e.querySelectorAll(".category-tab")),s=n.indexOf(this._draggingTab),o=n.indexOf(r);s<0||o<0||s===o||(s<o?e.insertBefore(this._draggingTab,r.nextSibling):e.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",t=>{let e=t.target?.closest?.(".category-tabs");!e||!this._draggingTab||this._originTabsEl&&e!==this._originTabsEl||t.preventDefault()},!0),document.addEventListener("dragend",t=>{let e=t.target?.closest?.(".category-drag-handle");if(!e)return;let r=e.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let n=Lo(r);ko(n),Po(n),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};l.categoryTabReorder=On;x(()=>{On.attach()});var mr="rss_subscriptions",F=null,N=null,it=!1,xt=!1,pr=!1,Fe=!1,me=!1,tt=new Map,mt=new Set,Dn=!1,Ne="",$e="",Oo=80,de=0,fe=0,hr=!1,Q=[],yr=0,ue=0,qt=44,In=10,At=0,Nn=0,$n=new Map;function Bn(t){return new Promise(e=>window.setTimeout(e,Math.max(0,t||0)))}function Io(t){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(t||""))}catch{}return String(t||"").replace(/"/g,'\\"')}function No(t){let e=Array.isArray(t)?t:[];for(let r of e){let n=String(r||"").trim();if(!n)continue;let s=`rss-${n}`,o=`.platform-card[data-platform="${Io(s)}"]`,a=document.querySelector(o);if(!a)continue;let i=a.querySelectorAll(".news-item");if(i&&i.length>0)return!0}return!1}function Sr(t,e){let r=Array.isArray(t)?t:[];for(let n of r){let s=String(n||"").trim();s&&(e?mt.add(s):mt.delete(s))}}function wr(){return document.getElementById("rssSubscriptionModal")}function vr(){return document.getElementById("rssSourcePickerModal")}function ge(t){return(Array.isArray(t)?t:[]).filter(r=>r&&typeof r=="object").map(r=>({source_id:String(r.source_id||r.rss_source_id||"").trim(),url:String(r.url||"").trim(),feed_title:String(r.feed_title||r.display_name||"").trim(),column:String(r.column||"RSS").trim()||"RSS",platform_id:String(r.platform_id||"").trim()})).filter(r=>!!r.source_id)}async function Fn({showHintOn403:t}={}){if(!pr){pr=!0;try{let e=await fetch("/api/me/rss-subscriptions");if(e.status===403){it=!1,xt=!0;try{Et()}catch{}t&&P("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5F53\u524D\u4F7F\u7528\u672C\u5730\u8BA2\u9605",{variant:"info"});return}let r=await e.json().catch(()=>({}));if(!e.ok){xt=!0,it=!1;return}let n=ge(r?.subscriptions);xt=!0,it=!0;try{Et()}catch{}try{D.setSubscriptions(n)}catch{}try{N=D.getSubscriptions()}catch{N=null}G(),q()}finally{pr=!1}}}function $o(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function Bo(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function Ht(t){let r=(Array.isArray(t)?t:[]).filter(n=>n&&typeof n=="object").map(n=>({source_id:String(n.source_id||n.rss_source_id||"").trim(),url:String(n.url||"").trim(),feed_title:String(n.feed_title||"").trim(),column:String(n.column||"RSS").trim()||"RSS"})).filter(n=>!!n.source_id||!!n.url).sort((n,s)=>(n.source_id||"").localeCompare(s.source_id||""));return JSON.stringify(r)}function br(t,e){let r=Array.isArray(t)?t:[],n=Array.isArray(e)?e:[],s=new Set(r.map(a=>String(a?.source_id||a?.rss_source_id||"").trim()).filter(Boolean)),o=[];for(let a of n){let i=String(a?.source_id||a?.rss_source_id||"").trim();i&&(s.has(i)||o.push(i))}return o}function Do(t,e){if(t)try{e?t.removeAttribute("disabled"):t.setAttribute("disabled","true")}catch{}}function Fo(t,e){if(!t)return;let r=!!e;try{r?t.setAttribute("aria-disabled","true"):t.removeAttribute("aria-disabled")}catch{}try{r?(t.style.opacity="0.5",t.style.cursor="not-allowed"):(t.style.opacity="",t.style.cursor="")}catch{}}function q(){let t=Bo(),e=$o(),r=Gn();try{t&&t.removeAttribute("disabled")}catch{}Fo(t,!r);try{t&&(r?t.removeAttribute("title"):t.setAttribute("title","\u8BF7\u5148\u9009\u62E9 RSS \u6E90\u518D\u9884\u89C8"))}catch{}if(r){let d=tt.get(String(r||"").trim());d&&d.ok===!0&&Number(d.entries_count||0)===0&&P("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let n=Array.isArray(N)?N:[],s=D.getSubscriptions(),o=Ht(n)!==Ht(s),i=br(n,s).every(d=>{let u=tt.get(d);return!!u&&u.ok===!0&&Number(u.entries_count||0)>0});if(Do(e,o&&i),!o){r&&(()=>{let d=tt.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||P("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!i){r&&(()=>{let d=tt.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||P("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}P("",{variant:"info"})}async function qo(t){let e=Be();e&&(e.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(t)}`),n=await r.json();if(!r.ok)throw new Error(n?.detail||"Preview failed");let s=n?.data||{},o=s?.feed?.title||"",a=Array.isArray(s?.entries)?s.entries:[],i=a.length,c=a.slice(0,5).map(d=>{let u=S(d?.title||""),f=S(d?.link||"");return f?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${f}" target="_blank" rel="noopener noreferrer">${u||f}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u}</div>`}).join("");if(!Fe&&o&&(Gt("rssFeedTitle",o),me=!0),tt.set(String(t||"").trim(),{ok:!0,entries_count:i,ts:Date.now()}),i>0)try{let u=(F?String(F.url||"").trim():"")||String(n?.final_url||n?.url||"").trim(),f=jt("rssColumn")||"";if(!f||String(f).trim().toUpperCase()==="RSS")try{let h=l.tabs&&typeof l.tabs.getActiveTabId=="function"?l.tabs.getActiveTabId():"";h&&(f=String(h))}catch{}f||(f="general");let g=jt("rssFeedTitle")||String(F?.name||F?.host||"").trim(),m=D.getSubscriptions(),y=m.findIndex(h=>h.source_id&&h.source_id===String(t||"").trim()),w={source_id:String(t||"").trim(),url:u,feed_title:g,column:f,platform_id:""};y>=0?m[y]=w:m.unshift(w),D.setSubscriptions(m),G()}catch{}else P("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});q(),e&&(e.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${S(o||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${a.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${c}</div>
            </div>`)}function Ho(){return document.getElementById("rssSubscriptionList")}function Be(){return document.getElementById("rssSubscriptionPreview")}function jo(){return document.getElementById("rssSubscriptionSaveStatus")}function P(t,e={}){let r=jo();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function qn(){return document.getElementById("rssSelectedSourceId")}function Go(){return document.getElementById("rssSelectedSourceLabel")}function Vo(){return document.getElementById("rssRequestSection")}function zo(){return document.getElementById("rssSourceCategoryList")}function Hn(){return document.getElementById("rssSourceSearchInput")}function jn(){return document.getElementById("rssSourceResults")}function Wo(){return document.getElementById("rssSourcePickerStatus")}function jt(t){let e=document.getElementById(t);return e&&typeof e.value=="string"?e.value.trim():""}function Gt(t,e){let r=document.getElementById(t);r&&(r.value=e==null?"":String(e))}function Gn(){let t=qn();return t&&typeof t.value=="string"?t.value.trim():""}function Yo(t){F=t&&typeof t=="object"?t:null;let e=qn(),r=Go(),n=F?String(F.id||"").trim():"",s=F?String(F.name||F.host||n):"",o=F?String(F.url||"").trim():"";e&&(e.value=n),r&&(r.textContent=n?`${s}${o?` (${o})`:""}`:"\u672A\u9009\u62E9"),n&&!Fe&&(!jt("rssFeedTitle")||me)&&(Gt("rssFeedTitle",s),me=!0),n&&Vn(n),q()}function Vn(t){let e=String(t||"").trim();if(!e)return;let r=Date.now(),n=15e3,s=$n.get(e)||0;r-s<n||($n.set(e,r),At&&(window.clearTimeout(At),At=0),At=window.setTimeout(async()=>{At=0;let o=Date.now()-(Nn||0);if(o<400){At=window.setTimeout(()=>{At=0,Vn(e)},400-o);return}Nn=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[e],priority:"high"})})}catch{}},300))}function De(t){let e=Wo();e&&(e.textContent=t==null?"":String(t))}async function zn(){let t=await fetch("/api/rss-source-categories"),e=await t.json();if(!t.ok)throw new Error(e?.detail||"Failed to load categories");let r=Array.isArray(e?.categories)?e.categories:[],n=zo();if(!n)return r;let s=r.map(o=>{let a=String(o?.id||""),i=String(o?.name||a||""),c=Number(o?.count||0),d=a===Ne;return`
          <button type="button" class="platform-select-action-btn" data-cat="${S(a)}" style="justify-content:flex-start;${d?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${S(i)} <span style="opacity:0.7;">(${c})</span>
          </button>`}).join("");return n.innerHTML=s,n.querySelectorAll("button[data-cat]").forEach(o=>{o.addEventListener("click",()=>{Ne=String(o.getAttribute("data-cat")||""),zn().catch(()=>{}),_r({reset:!0})})}),r}async function Wn(t={}){let e=t.reset===!0;if(!hr){hr=!0;try{e&&(Q=[],de=0,fe=0),De("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;$e&&r.set("q",$e),Ne&&r.set("category",Ne),r.set("limit",String(Oo)),r.set("offset",String(de));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json();if(!n.ok)throw new Error(s?.detail||"Search failed");let o=Array.isArray(s?.sources)?s.sources:[];fe=Number(s?.total||0),e?Q=o:Q=Q.concat(o),de=Number(s?.next_offset??de+o.length)||de+o.length,Yn();let i=Q.length<fe;De(`\u5DF2\u52A0\u8F7D ${Q.length}/${fe}${i?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{hr=!1}}}function Yn(){yr||(yr=window.requestAnimationFrame(()=>{yr=0,Uo()}))}function Uo(){let t=jn();if(!t)return;let e=t.scrollTop||0,r=t.clientHeight||360,n=Q.length,s=n*qt,o=Math.max(0,Math.floor(e/qt)-In),a=Math.min(n,Math.ceil((e+r)/qt)+In),i=t.querySelector(":scope > .rss-src-inner");i||(t.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',i=t.querySelector(":scope > .rss-src-inner")),i.style.height=`${s}px`;let c=[];for(let u=o;u<a;u++){let f=Q[u]||{},g=String(f.id||"").trim(),m=String(f.name||f.host||g),y=String(f.url||"");c.push(`<div class="rss-source-item" data-source-id="${S(g)}" style="position:absolute;left:0;right:0;top:${u*qt}px;height:${qt}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <span style="font-weight:700;font-size:0.9rem;color:#111827;">${S(m)}</span>
                <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${S(y)}</span>
              </div>
            </div>`)}i.innerHTML=c.join(""),i.querySelectorAll(".rss-source-item[data-source-id]").forEach(u=>{u.addEventListener("click",()=>{let f=String(u.getAttribute("data-source-id")||"").trim(),g=Q.find(m=>m&&String(m.id||"").trim()===f)||null;Yo(g),Cr()})}),e+r>=s-qt*6&&Q.length<fe&&Wn({reset:!1}).catch(u=>{De(u?.message||String(u))})}function _r(t={}){let e=t.reset!==!1;Wn({reset:e}).catch(r=>{De(r?.message||String(r))})}function Xo(){let t=vr();if(!t)return;Dn=!0,t.classList.add("show");let e=Hn();e&&(e.value=$e,e.focus()),zn().catch(()=>{}),_r({reset:!0})}function Cr(){let t=vr();t&&(Dn=!1,t.classList.remove("show"))}function G(){let t=Ho();if(!t)return;let e=D.getSubscriptions();if(!e.length){t.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=e.map((n,s)=>{let o=String(n?.source_id||n?.rss_source_id||"").trim(),a=S(n.url||""),i=S(n.feed_title||""),c=S(n.column||"RSS"),d=i?`${i}`:a,u=o&&mt.has(o);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${d}</span>
                            ${u?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${a}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${c}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${s})">\u5220\u9664</button>
                </div>
            </div>`}).join("");t.innerHTML=r,q()}var D={getSubscriptionsRaw(){let t=b.get(mr,[]);return Array.isArray(t)?t:[]},setSubscriptionsRaw(t){if(!Array.isArray(t)){b.set(mr,[]);return}b.set(mr,t)},getSubscriptions(){return this.getSubscriptionsRaw().filter(e=>e&&typeof e=="object").map(e=>({source_id:String(e.source_id||e.rss_source_id||"").trim(),url:String(e.url||"").trim(),feed_title:String(e.feed_title||"").trim(),column:String(e.column||"RSS").trim()||"RSS",platform_id:String(e.platform_id||"").trim()})).filter(e=>!!e.source_id||!!e.url)},setSubscriptions(t){this.setSubscriptionsRaw(t)},ensureSnapshot(){if(!Array.isArray(N))try{N=this.getSubscriptions()}catch{N=null}},stageFromCatalogPreview(t={}){let e=String(t?.source_id||t?.rss_source_id||"").trim();if(!e)return;let r=String(t?.url||"").trim(),n=String(t?.feed_title||t?.name||"").trim(),s=String(t?.column||"RSS").trim()||"RSS";this.ensureSnapshot();let o=this.getSubscriptions(),a=o.findIndex(d=>d?.source_id&&d.source_id===e),i={source_id:e,url:r,feed_title:n,column:s,platform_id:""};a>=0?o[a]=i:o.unshift(i),this.setSubscriptions(o);let c=Number(t?.entries_count??0)||0;tt.set(e,{ok:!0,entries_count:c,ts:Date.now()});try{G()}catch{}q()},open(){let t=wr();if(!t)return;try{N=this.getSubscriptions()}catch{N=null}Gt("rssFeedTitle",""),me=!1,Fe=!1,tt.clear(),mt.clear(),G();let e=Be();e&&(e.innerHTML=""),P(""),t.classList.add("show"),q(),Fn({showHintOn403:!1}).catch(()=>{})},close(){let t=wr();t&&t.classList.remove("show")},async previewCurrent(){let t=Gn();if(!t){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await qo(t)}catch(e){tt.set(String(t||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(e?.message||e)}),q();let r=Be();r&&(r.innerHTML=`<div style="color:#dc2626;">${S(e?.message||String(e))}</div>`)}},removeAt(t){let e=this.getSubscriptions();if(!(t<0||t>=e.length)){try{let r=String(e[t]?.source_id||e[t]?.rss_source_id||"").trim();r&&mt.delete(r)}catch{}e.splice(t,1),this.setSubscriptions(e),G()}},async saveOnly(){try{let t=Array.isArray(N)?N:[],e=this.getSubscriptions(),r=Ht(t)!==Ht(e),s=br(t,e).every(c=>{let d=tt.get(c);return!!d&&d.ok===!0&&Number(d.entries_count||0)>0});if(!r){P("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58",{variant:"info"}),q();return}if(!s){P("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),q();return}let o=e;try{let c=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:ge(e)})});if(c.status===403){xt=!0,it=!1;try{Et()}catch{}P("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let d=await c.json().catch(()=>({}));if(!c.ok)throw new Error(d?.detail||"Save failed");o=ge(d?.subscriptions),xt=!0,it=!0;try{Et()}catch{}this.setSubscriptions(o)}}catch(c){P(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(c?.message||c)}`,{variant:"info"})}let a=new Set(t.map(c=>String(c?.source_id||c?.rss_source_id||"").trim()).filter(Boolean)),i=o.map(c=>String(c?.source_id||c?.rss_source_id||"").trim()).filter(c=>!!c&&!a.has(c));if(i.length>0&&(Sr(i,!0),G()),i.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:i,priority:"high"})})}catch{}try{N=this.getSubscriptions()}catch{N=null}G(),q()}catch(t){console.error("rss save error:",t);try{P(String(t?.message||t),{variant:"error"})}catch{}}},async saveAndRefresh(){try{let t=Array.isArray(N)?N:[],e=this.getSubscriptions(),r=Ht(t)!==Ht(e),s=br(t,e).every(g=>{let m=tt.get(g);return!!m&&m.ok===!0&&Number(m.entries_count||0)>0});if(!r){P("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),q();return}if(!s){P("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),q();return}let o=e;try{let g=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:ge(e)})});if(g.status===403){xt=!0,it=!1;try{Et()}catch{}P("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let m=await g.json().catch(()=>({}));if(!g.ok)throw new Error(m?.detail||"Save failed");o=ge(m?.subscriptions),xt=!0,it=!0;try{Et()}catch{}this.setSubscriptions(o)}}catch(g){P(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(g?.message||g)}`,{variant:"info"})}let a=new Set(t.map(g=>String(g?.source_id||g?.rss_source_id||"").trim()).filter(Boolean)),i=o.map(g=>String(g?.source_id||g?.rss_source_id||"").trim()).filter(g=>!!g&&!a.has(g));if(i.length>0&&(Sr(i,!0),G()),i.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:i,priority:"high"})})}catch{}P("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let g=document.querySelector("#rssSubscriptionModal .settings-btn-primary");g&&g.setAttribute("disabled","true")}catch{}let c=Date.now(),d=5e3,u=[0,300,700,1500,2500],f=!1;for(let g of u){let m=Date.now()-c,y=d-m;if(y<=0)break;if(g>0&&await Bn(Math.min(g,y)),await l.data.refreshViewerData({preserveScroll:!0}),i.length>0){let w=[];for(let h of i)mt.has(h)&&No([h])&&mt.delete(h),mt.has(h)&&w.push(h);if(w.length===0){f=!0,G();break}G()}if(i.length===0){f=!0;break}}f?P("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(i.length>0&&(Sr(i,!1),G()),P("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let g=document.querySelector("#rssSubscriptionModal .settings-btn-primary");g&&g.removeAttribute("disabled")}catch{}await Bn(f?200:800),this.close()}catch(t){console.error("rss refresh error:",t);try{P(String(t?.message||t),{variant:"error"})}catch{}try{let e=document.querySelector("#rssSubscriptionModal .settings-btn-primary");e&&e.removeAttribute("disabled")}catch{}}}};async function Ko(){let t=jt("rssRequestUrl"),e=jt("rssRequestTitle"),r=jt("rssRequestNote");if(!t){alert("\u8BF7\u8F93\u5165 URL");return}if(!e){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let n=Be();n&&(n.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let s=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,title:e,note:r})}),o=await s.json();if(!s.ok)throw new Error(o?.detail||"Submit failed");n&&(n.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${S(o?.status||"pending")}</div>`),Gt("rssRequestUrl",""),Gt("rssRequestTitle",""),Gt("rssRequestNote","")}catch(s){n&&(n.innerHTML=`<div style="color:#dc2626;">${S(s?.message||String(s))}</div>`)}}function Jo(){let t=Vo();if(!t)return;let e=t.style.display!=="none";t.style.display=e?"none":"block"}window.openRssSubscriptionModal=()=>{try{let t=document.getElementById("rssSubscriptionNewBadge");t&&(t.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}D.open()};window.closeRssSubscriptionModal=()=>D.close();window.previewRssSubscription=()=>D.previewCurrent();window.saveRssSubscriptions=()=>D.saveAndRefresh();window.removeRssSubscription=t=>D.removeAt(parseInt(t,10));window.submitRssSourceRequest=()=>Ko();window.toggleRssRequestSection=()=>Jo();window.openRssSourcePicker=()=>Xo();window.closeRssSourcePicker=()=>Cr();l.subscription=D;l.subscription._serverEnabled=it;function Et(){try{l.subscription._serverEnabled=!!it}catch{}}x(function(){let t=wr();if(t){let s=document.getElementById("rssFeedTitle");s&&s.addEventListener("input",()=>{Fe=String(s.value||"").trim()!=="",me=!1}),t.addEventListener("keydown",o=>{o.key==="Escape"&&D.close()})}let e=vr();e&&e.addEventListener("keydown",s=>{s.key==="Escape"&&Cr()});let r=jn();r&&r.addEventListener("scroll",()=>{Yn()});let n=Hn();n&&n.addEventListener("input",()=>{$e=String(n.value||"").trim(),ue&&(window.clearTimeout(ue),ue=0),ue=window.setTimeout(()=>{ue=0,_r({reset:!0})},250)}),Et(),Fn({showHintOn403:!1}).catch(()=>{})});var pe=15,Zo=3,Jn="trendradar_explore_seen_sources_v1",Zn="trendradar_explore_last_source_v1",$=!1,Lt=!1,V=[],Ar=0,qe=0,at=!1,pt=-1,R=null,Vt=new Map,z=null,kt=null,et=0,Wt=new Set,Er=new Set;function Qo(){try{let t=b.getRaw(Jn);if(!t)return new Set;let e=JSON.parse(t);if(!Array.isArray(e))return new Set;let r=new Set;for(let n of e){let s=String(n||"").trim();s&&r.add(s)}return r}catch{return new Set}}function ti(t){try{let r=Array.from(t||[]).map(n=>String(n||"").trim()).filter(Boolean).slice(-2e3);b.setRaw(Jn,JSON.stringify(r))}catch{}}function ei(){try{let t=new Set(Array.from(Wt||[]));for(let e of Array.from(Er||[]))t.add(e);Wt=t,ti(Wt)}catch{}}function ri(){try{let t=b.getRaw(Zn);return String(t||"").trim()||null}catch{return null}}function ni(t){try{let e=String(t||"").trim();if(!e)return;b.setRaw(Zn,e)}catch{}}var He=!1,Tr=0,Lr=0,Tt=null;function Qn(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function si(t){if(!$||!Qn()||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select")||!e.closest(".rss-carousel-frame"))return;let r=t?.touches;!r||r.length!==1||(He=!0,Tt=null,Tr=Number(r[0]?.clientX||0),Lr=Number(r[0]?.clientY||0))}function oi(t){if(!He||!$)return;let e=t?.touches;if(!e||e.length!==1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Tr,o=n-Lr,a=Math.abs(s),i=Math.abs(o);if(!Tt){if(a<10&&i<10)return;Tt=a>=i?"x":"y"}try{t.preventDefault()}catch{}}function Un(t){if(!He||(He=!1,!$)||!Qn())return;let e=t?.changedTouches;if(!e||e.length<1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Tr,o=n-Lr,a=Math.abs(s),i=Math.abs(o),c=44;if((Tt==="x"||Tt==null)&&a>=c&&a>i){s<0?rt():he();return}(Tt==="y"||Tt==null)&&i>=c&&i>a&&(o<0?zt(-1):zt(1))}function je(){return document.getElementById("rssCatalogPreviewModal")}function xr(){return document.getElementById("rssCatalogPreviewGrid")}function ii(){return document.getElementById("rssCatalogPreviewStatus")}function H(t,e={}){let r=ii();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function ai(t){let e=Number(t||0)||0;if(!e)return"";let r=new Date(e);if(Number.isNaN(r.getTime()))return"";let n=i=>String(i).padStart(2,"0"),s=String(r.getFullYear()),o=n(r.getMonth()+1),a=n(r.getDate());return`${s}-${o}-${a}`}function ci(t){let e=[t?.published,t?.published_at,t?.pubDate,t?.updated,t?.updated_at,t?.date,t?.datetime,t?.date_published,t?.date_modified],n=Date.now()+365*24*60*60*1e3,s=o=>{let a=Number(o);return!Number.isFinite(a)||a<=0?0:a<1e11?Math.floor(a*1e3):Math.floor(a)};for(let o of e){if(o==null)continue;if(typeof o=="number"){let c=s(o);if(c>0&&c<=n)return c;continue}let a=String(o).trim();if(!a)continue;if(/^\d{10,13}$/.test(a)){let c=s(a);if(c>0&&c<=n)return c;continue}let i=Date.parse(a);if(!Number.isNaN(i)&&i>0&&i<=n)return i}return 0}async function ts(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function li(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let o=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,i=Number(s?.next_offset??e+o.length)||e+o.length;return{items:o,total:a,nextOffset:i}}async function Yt(t){let e=Number(t);if(!Number.isFinite(e)||e<0||at)return;let r=0;for(;V.length<=e&&!at&&r<50;){r+=1;let n=await li(50,qe);Ar=n.total,qe=n.nextOffset;for(let s of n.items)String(s?.id||"").trim()&&V.push(s);(!n.items.length||qe>=Ar)&&(at=!0)}}async function di(){if(at)return;let t=0;for(;!at&&t<200&&(t+=1,await Yt(V.length),!at););}function ui(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function fi(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(o=>{let a=String(o?.title||"").trim(),i=String(o?.link||"").trim(),c=ci(o);return{title:a||i,link:i,ts:c}}).filter(o=>!!o.link);return{feedTitle:r,entries:s}}function es(){let t=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}function Xn(t){let e=String(t||"").trim();if(!e)return!0;try{if(es().has(e))return!0}catch{}try{if(Wt&&Wt.has(e))return!0}catch{}return!1}async function rs(t){let e=String(t?.id||"").trim();if(!e)return null;if(Vt.has(e))return Vt.get(e);let r=String(t?.url||"").trim(),n=ui(t),s=es(),o=[],a="",i=null;try{let u=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`);if(i=await u.json().catch(()=>({})),!u.ok)throw new Error(i?.detail||"Preview failed");let f=fi(i);a=f.feedTitle,o=f.entries}catch(u){let f={source_id:e,error:String(u?.message||u)};return Vt.set(e,f),f}if(!Array.isArray(o)||o.length<=0){let u={source_id:e,error:"No entries"};return Vt.set(e,u),u}let d={source_id:e,url:r,feed_title:a||n,platform_name:a||n,entries:o,entries_count:o.length,error:"",already_added:s.has(e)};return Vt.set(e,d),d}async function gi(t){let e=String(t||"").trim();if(!e)return-1;let r=0;for(;r<400;){r+=1;let n=V.findIndex(s=>String(s?.id||"").trim()===e);if(n>=0)return n;if(at||(await Yt(V.length),at))return-1}return-1}function mi(t){if(!$)return;let e=async()=>{if(Lt||z!=null)return;let r=[];for(let s=1;s<=Zo;s+=1)r.push(t+s);let n=Math.max(...r);Number.isFinite(n)&&n>=0&&await Yt(n);for(let s of r)try{if(s<0)continue;await Yt(s);let o=V[s];if(!o)continue;await rs(o)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>e().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>e().catch(()=>{}),0)}function Kn(){let t=l.settings?.getMergedCategoryConfig?l.settings.getMergedCategoryConfig():null,e=l.settings?.getDefaultCategories?l.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],o=new Set;for(let a of r){let i=String(a||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=n.find(g=>String(g?.id||"")===i);if(c){let g=String(c?.name||i).trim()||i;s.push({id:i,name:g,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[i]?e[i]:null;if(!d)continue;let u=String(d?.name||i).trim()||i,f=String(d?.icon||"\u{1F4C1}");s.push({id:i,name:u,icon:f,isCustom:!1})}for(let a of n){let i=String(a?.id||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=String(a?.name||i).trim()||i;s.push({id:i,name:c,icon:"\u{1F4F1}",isCustom:!0})}return s}async function pi(t){if(!R||!R.source_id)return;let e=String(t?.id||"").trim(),r=String(t?.name||e).trim()||e||"RSS",n=!!t?.isCustom,s=String(R.source_id||"").trim(),o=s?`rss-${s}`:"",a="RSS";e&&e!=="rsscol-rss"&&!n&&(a=e);try{l.subscription?.ensureSnapshot?.()}catch{}try{l.subscription?.stageFromCatalogPreview?.({source_id:R.source_id,url:R.url,feed_title:R.feed_title||R.platform_name,column:a,entries_count:R.entries_count||0})}catch(i){H(String(i?.message||i),{variant:"error"});return}if(n&&e&&o)try{l.settings?.addPlatformToCustomCategory?.(e,o)}catch{}R.already_added=!0;try{kr(R)}catch{}try{H(`\u4FDD\u5B58\u4E2D\uFF1A${r}`,{variant:"info"}),l.subscription?.saveOnly?await l.subscription.saveOnly():l.subscription?.saveAndRefresh?await l.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),H(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success"})}catch(i){H(String(i?.message||i),{variant:"error"});try{l.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(i?.message||i)}`,{variant:"error",durationMs:2500})}catch{}return}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}try{setTimeout(()=>{$&&rt()},60)}catch{}try{ts([R.source_id],"high").catch(()=>{})}catch{}}function kr(t){let e=xr();if(!e)return;let r=t,n=String(r?.source_id||"").trim(),s=S(r?.platform_name||"RSS"),o=r?.already_added?"disabled":"",i=Kn().map(h=>{let v=`${h?.isCustom?"custom":"default"}:${String(h?.id||"").trim()}`;return`<option value="${S(v)}">${S(String(h?.icon||"\u{1F4C1}"))} ${S(String(h?.name||h?.id||""))}</option>`}).join(""),c=Array.isArray(r?.entries)?r.entries:[],d=Math.max(0,Math.ceil(c.length/pe)-1);et>d&&(et=d),et<0&&(et=0);let u=et*pe,f=c.slice(u,u+pe),g=f.map((h,p)=>{let v=S(h?.title||""),C=S(h?.link||"#"),_=S(ai(h?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${v}">
                <div class="news-item-content">
                    <span class="news-index">${String(u+p+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${C}" target="_blank" rel="noopener noreferrer">${v}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${_?"":"display:none;"}">${_}</span>
                </div>
            </li>`}).join(""),m=Math.max(0,pe-f.length),y=m?Array.from({length:m}).map((h,p)=>{let v=u+f.length+p+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(v)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";e.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${S(n)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${s}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <select class="platform-select-action-btn" data-action="add-category" ${o} style="padding:6px 10px;">
                            <option value="" selected>\u52A0\u5165\u680F\u76EE</option>
                            ${i}
                        </select>
                    </div>
                </div>
                <ul class="news-list">${g}${y}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{e.querySelectorAll(".news-title").forEach(p=>{p instanceof HTMLElement&&(p.closest(".rss-entry-placeholder")||(p.classList.remove("tr-title-overflow-shrink"),p.scrollWidth>p.clientWidth+1&&p.classList.add("tr-title-overflow-shrink")))})})}catch{}let w=e.querySelector('select[data-action="add-category"]');w&&w.addEventListener("change",async()=>{if(!R||R.already_added||!(w instanceof HTMLSelectElement))return;let h=String(w.value||"").trim();if(!h)return;let p=h.split(":"),v=String(p[1]||"").trim(),_=Kn().find(O=>String(O?.id||"").trim()===v),M=_||{id:v,name:v,icon:"\u{1F4C1}",isCustom:h.startsWith("custom:")};try{w.setAttribute("disabled","true")}catch{}await pi(M)})}async function Ge(t,e=1){if(!Lt){Lt=!0,kt=Number(t);try{if(await Yt(t),V.length<=0){let a=xr();a&&(a.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),H("",{variant:"info"});return}let r=t,n=e>=0?1:-1,s=0;for(;s<200;){s+=1,r<0&&(await di(),r=V.length-1),await Yt(r),r>=V.length&&(r=0);let a=V[r];if(!a){r+=n;continue}let i=String(a?.id||"").trim();if(Xn(i)){r+=n;continue}let c=await rs(a);if(!c||c.error){r+=n;continue}if(c.already_added){r+=n;continue}if(Xn(c.source_id)){r+=n;continue}pt=r,R=c,et=0,kr(c),H("",{variant:"info"});try{let d=String(c?.source_id||"").trim();d&&(ni(d),Er.add(d))}catch{}try{ts([c.source_id],"normal").catch(()=>{})}catch{}try{mi(r)}catch{}return}let o=xr();o&&(o.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),H("",{variant:"info"})}catch(r){H(String(r?.message||r),{variant:"error"})}finally{if(Lt=!1,kt=null,$&&z!=null){let r=Number(z);z=null;let n=Number.isFinite(pt)?pt:0,s=r>=n?1:-1;Ge(r,s).catch(o=>H(String(o?.message||o),{variant:"error"}))}}}}function rt(){if(!$)return;if(Lt){z=(z!=null?Number(z):kt!=null?Number(kt):pt)+1;return}let t=pt+1;Ge(t,1).catch(e=>H(String(e?.message||e),{variant:"error"}))}function he(){if(!$)return;if(Lt){z=(z!=null?Number(z):kt!=null?Number(kt):pt)-1;return}let t=pt-1;Ge(t,-1).catch(e=>H(String(e?.message||e),{variant:"error"}))}function zt(t){if(!$||!R)return;let e=Array.isArray(R?.entries)?R.entries:[],r=Math.max(0,Math.ceil(e.length/pe)-1),n=Math.max(0,Math.min(r,et+t));n!==et&&(et=n,kr(R))}function ns(){let t=je();if(!t)return;$=!0,t.classList.add("show");try{window.dispatchEvent(new CustomEvent("tr_explore_modal_opened"))}catch{}try{let r=t.querySelector(".settings-modal");r&&(r.setAttribute("tabindex","0"),r.focus())}catch{}try{l.subscription?.ensureSnapshot?.()}catch{}Lt=!1,z=null,kt=null,V=[],Ar=0,qe=0,at=!1,pt=-1,R=null,Vt=new Map,et=0,Wt=Qo(),Er=new Set;let e=ri();if(e){(async()=>{let r=await gi(e);r>=0?await Ge(r,1):rt()})().catch(()=>rt());return}rt()}function Ut(){let t=je();if(t){$=!1,t.classList.remove("show"),ei();try{window.dispatchEvent(new CustomEvent("tr_explore_modal_closed"))}catch{}}}function hi(t){let e=je();e&&t&&t.target===e&&Ut()}async function ss(){try{await(l.subscription?.saveAndRefresh?l.subscription.saveAndRefresh():window.saveRssSubscriptions?.())}catch(t){H(String(t?.message||t),{variant:"error"});return}Ut()}window.openRssCatalogPreviewModal=()=>ns();window.closeRssCatalogPreviewModal=()=>Ut();window.closeRssCatalogPreviewModalOnOverlay=t=>hi(t);window.rssCatalogPreviewNext=()=>rt();window.rssCatalogPreviewPrev=()=>he();window.rssCatalogPreviewSaveAndRefresh=()=>ss();l.rssCatalogPreview={open:ns,close:Ut,next:rt,prev:he,saveAndRefresh:ss};x(function(){let t=je();if(!t)return;let e=t.querySelector(".settings-modal");e&&e.addEventListener("keydown",n=>{if(n.key==="Escape"){Ut();return}}),document.addEventListener("keydown",n=>{if(n.key==="Escape"){$&&Ut();return}if(!$||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let s=n?.target;if(!(s&&s instanceof Element&&s.closest("input,textarea,select"))){if(n.key===" "||n.key==="Spacebar"||n.code==="Space"){n.preventDefault(),rt();return}if(n.key==="ArrowUp"){n.preventDefault(),zt(-1);return}if(n.key==="ArrowDown"){n.preventDefault(),zt(1);return}if(n.key==="ArrowRight"){n.preventDefault(),rt();return}if(n.key==="ArrowLeft"){n.preventDefault(),he();return}}});let r=t.querySelector(".settings-modal-body");r&&(r.addEventListener("click",n=>{if(!$||document.getElementById("rssCategoryPickerModal")?.classList.contains("show"))return;let s=n?.target;if(!s||!(s instanceof Element)||s.closest("a,button,input,textarea,select"))return;let o=Number(n?.clientX||0),a=Number(n?.clientY||0),i=t.querySelector("#rssCatalogPreviewGrid .platform-card");if(!i)return;let c=i.getBoundingClientRect(),d=140,u=c.left-d,f=c.right+d,g=c.top-d,m=c.bottom+d;if(!(o<u||o>f||a<g||a>m)&&!(o>=c.left&&o<=c.right&&a>=c.top&&a<=c.bottom)){if(a<c.top){zt(-1);return}if(a>c.bottom){zt(1);return}if(o<c.left){he();return}if(o>c.right){rt();return}}}),r.addEventListener("touchstart",si,{passive:!0}),r.addEventListener("touchmove",oi,{passive:!1}),r.addEventListener("touchend",Un,{passive:!0}),r.addEventListener("touchcancel",Un,{passive:!0}))});var Rr="explore",ze=20,Ve=4,as=6,yi=3*60*1e3,Si=2e3,wi="/api/rss-sources/explore-cards",cs="trendradar_explore_tab_seen_sources_v1",ls="trendradar_explore_tab_cursor_v1",Pt=!1,A=[];var os=!1,T=null,ht=null,yt=0,ye=new Map,Pr=new Map;var Mr=!1;function Ye(t,e={}){let r=Ue();if(!r)return;let n=t==null?"":String(t),o=e.retry===!0?'<div style="margin-top:8px;"><button type="button" class="platform-select-action-btn" data-action="retry">\u91CD\u8BD5</button></div>':"";r.innerHTML=`<div class="category-empty-state">${S(n)}${o}</div>`}function bi(){let t=new Set;try{let e=ht||Xe();ht=e;for(let r of e)r&&t.add(String(r))}catch{}try{let e=Ir();for(let r of e)r&&t.add(String(r))}catch{}try{for(let e of Array.isArray(A)?A:[]){let r=String(e?.source_id||"").trim();r&&t.add(r)}}catch{}return Array.from(t)}async function ds(t){let e=Math.max(0,Number(t||0)||0);if(e<=0)return[];let r=Se();if(!r||!r.classList.contains("active"))return[];try{let n=bi(),s=new URLSearchParams;s.set("cards",String(e)),s.set("entries_per_card",String(ze)),n.length&&s.set("exclude_source_ids",n.join(","));let o=`${wi}?${s.toString()}`,a=await fetch(o,{method:"GET"}),i=await a.json().catch(()=>({}));return a.ok?(Array.isArray(i?.cards)?i.cards:[]).map(d=>{let u=String(d?.source_id||"").trim(),f=String(d?.url||"").trim(),g=String(d?.platform_name||d?.feed_title||"RSS").trim()||"RSS",m=Array.isArray(d?.entries)?d.entries:[];return{source_id:u,url:f,feed_title:String(d?.feed_title||g).trim()||g,platform_name:g,entries:m.slice(0,ze).map(y=>({title:String(y?.title||"").trim(),link:String(y?.link||"").trim(),published:y?.published||y?.ts||""})),entries_count:m.length,already_added:!1}}).filter(d=>d.source_id&&Array.isArray(d.entries)&&d.entries.length>0):[]}catch{return[]}}function vi(t,e){return new Promise(r=>{if(!t){r();return}let n=!1,s=()=>{if(!n){n=!0;try{t.removeEventListener("animationend",o)}catch{}r()}},o=()=>s();try{t.addEventListener("animationend",o,{once:!0})}catch{}setTimeout(s,Math.max(0,Number(e||0)||0))})}function Se(){return document.getElementById("tab-explore")}async function _i(){let t=Ir(),e=ht||Xe();ht=e,T==null&&(T=gs());let r=new Set((Array.isArray(A)?A:[]).map(s=>String(s?.source_id||"").trim()).filter(Boolean)),n=0;for(;n<200;){n+=1;let s=T,o=await ms(50,s);if(yt=o.total,!o.items.length)return null;let a=[];for(let c of o.items){T+=1;let d=String(c?.id||"").trim();if(!d||e.has(d)||t.has(d)||r.has(d))continue;let u=String(c?.url||"").trim(),f=ps(c);a.push({sid:d,url:u,name:f})}let i=await Ai(a);if(i)return i;if(T>=yt)return null;T===s&&(T+=o.items.length)}return null}function Ci(t){let e=ye.get(t);return e?Date.now()-Number(e.ts||0)>yi?(ye.delete(t),null):e:null}async function us(t){let e=String(t||"").trim();if(!e)return null;let r=Ci(e);if(r)return r;let n=Pr.get(e);if(n)return n;let s=(async()=>{try{let o=typeof AbortController<"u"?new AbortController:null,a=o?window.setTimeout(()=>o.abort(),Si):0,i=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`,o?{signal:o.signal}:void 0);try{a&&window.clearTimeout(a)}catch{}let c=await i.json().catch(()=>({}));if(!i.ok){let f={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:c?.detail||"Preview failed"};return ye.set(e,f),f}let d=Ri(c),u={ts:Date.now(),ok:!0,feedTitle:d.feedTitle,entries:d.entries,error:""};return ye.set(e,u),u}catch(o){let a={ts:Date.now(),ok:!1,feedTitle:"",entries:[],error:String(o?.message||o)};return ye.set(e,a),a}finally{Pr.delete(e)}})();return Pr.set(e,s),s}async function Ai(t){let e=Array.isArray(t)?[...t]:[];if(e.length===0)return null;let r=null,n=null,s=new Promise(c=>{n=c}),o=async()=>{for(;e.length>0&&!r;){let c=e.shift();if(!c||!c.sid)continue;let d=await us(c.sid);if(!d||d.ok!==!0)continue;let u=Array.isArray(d.entries)?d.entries:[];if(!(u.length<=0)){r={source_id:c.sid,url:c.url,feed_title:d.feedTitle||c.name,platform_name:d.feedTitle||c.name,entries:u,entries_count:u.length,already_added:!1};try{n&&n(),n=null}catch{}return}}},a=Math.max(1,Math.min(as,e.length)),i=Array.from({length:a}).map(()=>o().catch(()=>{}));return await Promise.race([Promise.all(i),s]),r}async function xi(t){let e=Math.max(0,Number(t||0)||0);if(e<=0)return[];let r=Ir(),n=ht||Xe();ht=n,T==null&&(T=gs());let s=new Set((Array.isArray(A)?A:[]).map(d=>String(d?.source_id||"").trim()).filter(Boolean)),o=[],a=null,i=new Promise(d=>{a=d}),c=0;for(;c<200&&o.length<e;){c+=1;let d=T,u=await ms(50,d);if(yt=u.total,!u.items.length)break;let f=[];for(let h of u.items){T+=1;let p=String(h?.id||"").trim();if(!p||n.has(p)||r.has(p)||s.has(p)||o.some(_=>String(_?.source_id||"").trim()===p))continue;let v=String(h?.url||"").trim(),C=ps(h);f.push({sid:p,url:v,name:C})}let g=[...f],m=async()=>{for(;g.length>0&&o.length<e;){let h=g.shift();if(!h||!h.sid)continue;let p=await us(h.sid);if(!p||p.ok!==!0)continue;let v=Array.isArray(p.entries)?p.entries:[];if(!(v.length<=0)){if(o.length>=e)return;if(o.push({source_id:h.sid,url:h.url,feed_title:p.feedTitle||h.name,platform_name:p.feedTitle||h.name,entries:v,entries_count:v.length,already_added:!1}),o.length>=e){try{a&&a(),a=null}catch{}return}}}},y=Math.max(1,Math.min(as,g.length)),w=Array.from({length:y}).map(()=>m().catch(()=>{}));if(await Promise.race([Promise.all(w),i]),o.length>=e||T>=yt)break;T===d&&(T+=u.items.length)}return o.slice(0,e)}async function Or(){if(Pt)return;let t=Se(),e=Ue();if(!(!t||!e)&&t.classList.contains("active")){Pt=!0,is(!0);try{if(A.length<Ve){let r=Ve-A.length,n=await ds(r);n.length&&(A=[...A,...n],Rt(A))}for(;A.length<Ve;){let r=Ve-A.length,n=await xi(r);if(!n.length)break;A=[...A,...n],Rt(A)}T!=null&&We(T),A.length<=0&&T!=null&&yt>0&&T>=yt&&(T=0,We(T))}catch{A.length<=0&&Ye("\u52A0\u8F7D\u5931\u8D25",{retry:!0})}finally{Pt=!1,is(!1),Rt(A)}}}function Ue(){return document.getElementById("trExploreGrid")}function Ei(){return document.getElementById("trExploreStatus")}function Xt(t,e={}){let r=Ei();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function is(t){t&&(A.length>0||Ye("\u52A0\u8F7D\u4E2D..."))}function Ti(){let t=Ue();if(!t)return!0;try{return t.querySelectorAll(".platform-card").length===0}catch{return!0}}function fs(){let t=l.settings?.getMergedCategoryConfig?l.settings.getMergedCategoryConfig():null,e=l.settings?.getDefaultCategories?l.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],o=new Set;for(let a of r){let i=String(a||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=n.find(g=>String(g?.id||"")===i);if(c){let g=String(c?.name||i).trim()||i;s.push({id:i,name:g,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[i]?e[i]:null;if(!d)continue;let u=String(d?.name||i).trim()||i,f=String(d?.icon||"\u{1F4C1}");s.push({id:i,name:u,icon:f,isCustom:!1})}for(let a of n){let i=String(a?.id||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=String(a?.name||i).trim()||i;s.push({id:i,name:c,icon:"\u{1F4F1}",isCustom:!0})}return s}async function Li(t,e){if(!t||!t.source_id)return;let r=String(e?.id||"").trim(),n=String(e?.name||r).trim()||r||"RSS",s=!!e?.isCustom,o=String(t.source_id||"").trim(),a=o?`rss-${o}`:"",i="RSS";r&&r!=="rsscol-rss"&&!s&&(i=r);try{l.subscription?.ensureSnapshot?.()}catch{}try{l.subscription?.stageFromCatalogPreview?.({source_id:t.source_id,url:t.url,feed_title:t.feed_title||t.platform_name,column:i,entries_count:t.entries_count||0})}catch(c){Xt(String(c?.message||c),{variant:"error"});return}if(s&&r&&a)try{l.settings?.addPlatformToCustomCategory?.(r,a)}catch{}try{Xt(`\u4FDD\u5B58\u4E2D\uFF1A${n}`,{variant:"info"}),l.subscription?.saveOnly?await l.subscription.saveOnly():l.subscription?.saveAndRefresh?await l.subscription.saveAndRefresh():await window.saveRssSubscriptions?.(),Xt(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success"})}catch(c){Xt(String(c?.message||c),{variant:"error"});try{l.toast?.show?.(`\u4FDD\u5B58\u5931\u8D25\uFF1A${String(c?.message||c)}`,{variant:"error",durationMs:2500})}catch{}return}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${n}`,{variant:"success",durationMs:1500})}catch{}try{Mr=!0}catch{}try{Pi([t.source_id],"high").catch(()=>{})}catch{}}function Xe(){try{let t=b.getRaw(cs);if(!t)return new Set;let e=JSON.parse(t);if(!Array.isArray(e))return new Set;let r=new Set;for(let n of e){let s=String(n||"").trim();s&&r.add(s)}return r}catch{return new Set}}function ki(t){try{let r=Array.from(t||[]).map(n=>String(n||"").trim()).filter(Boolean).slice(-2e3);b.setRaw(cs,JSON.stringify(r))}catch{}}function gs(){try{let t=b.getRaw(ls),e=Number(t||0)||0;return e<0?0:e}catch{return 0}}function We(t){try{let e=Number(t||0)||0;b.setRaw(ls,String(e<0?0:e))}catch{}}function Ir(){let t=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}async function Pi(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function ms(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let o=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,i=Number(s?.next_offset??e+o.length)||e+o.length;return{items:o,total:a,nextOffset:i}}function Ri(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(o=>{let a=String(o?.title||"").trim(),i=String(o?.link||"").trim();return{title:a||i,link:i}}).filter(o=>!!o.link);return{feedTitle:r,entries:s}}function ps(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function hs(t){let e=t||{},r=e?.already_added?"disabled":"",n=e?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE",o=fs().map(a=>{let c=`${a?.isCustom?"custom":"default"}:${String(a?.id||"").trim()}`;return`<option value="${S(c)}">${S(String(a?.icon||"\u{1F4C1}"))} ${S(String(a?.name||a?.id||""))}</option>`}).join("");return`
        <select class="platform-select-action-btn" data-action="add-category" ${r} style="padding:6px 10px;">
            <option value="" selected>${S(n)}</option>
            ${o}
        </select>`}function Rt(t){let e=Ue();if(!e)return;let r=(t||[]).map(n=>{let s=String(n?.source_id||"").trim(),o=S(n?.platform_name||"RSS"),a=hs(n),c=(Array.isArray(n?.entries)?n.entries:[]).slice(0,ze).map((d,u)=>{let f=S(d?.title||""),g=S(d?.link||"#");return`
                <li class="news-item" data-news-id="" data-news-title="${f}">
                    <div class="news-item-content">
                        <span class="news-index">${String(u+1)}</span>
                        <a class="news-title" href="${g}" target="_blank" rel="noopener noreferrer">${f}</a>
                    </div>
                </li>`}).join("");return`
            <div class="platform-card" data-rss-source-id="${S(s)}" style="margin:0;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; flex: 1; min-width: 0; white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">\u{1F4F1} ${o}</div>
                    <div class="platform-header-actions">
                        ${a}
                        <button type="button" class="tr-explore-card-close" data-action="close">\u21C4</button>
                    </div>
                </div>
                <ul class="news-list">${c}</ul>
            </div>`}).join("");if(r){e.innerHTML=r;return}Ye("\u6682\u65E0\u53EF\u9884\u89C8\u6E90",{retry:!0})}function Mi(t,e={}){let r=String(t?.source_id||"").trim(),n=S(t?.platform_name||"RSS"),s=hs(t),a=(Array.isArray(t?.entries)?t.entries:[]).slice(0,ze).map((u,f)=>{let g=S(u?.title||""),m=S(u?.link||"#");return`
            <li class="news-item" data-news-id="" data-news-title="${g}">
                <div class="news-item-content">
                    <span class="news-index">${String(f+1)}</span>
                    <a class="news-title" href="${m}" target="_blank" rel="noopener noreferrer">${g}</a>
                </div>
            </li>`}).join(""),c=`
        <div class="platform-card${e.animateIn?" tr-explore-flip-in":""}" data-rss-source-id="${S(r)}" style="margin:0;">
            <div class="platform-header">
                <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; flex: 1; min-width: 0; white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">\u{1F4F1} ${n}</div>
                <div class="platform-header-actions">
                    ${s}
                    <button type="button" class="tr-explore-card-close" data-action="close">\u21C4</button>
                </div>
            </div>
            <ul class="news-list">${a}</ul>
        </div>`,d=document.createElement("div");return d.innerHTML=c.trim(),d.firstElementChild}async function Oi(t,e){if(Pt)return;let r=(Array.isArray(A)?A:[]).findIndex(a=>String(a?.source_id||"").trim()===String(t||"").trim());if(r<0)return;let n=ht||Xe();ht=n,n.add(String(t||"").trim()),ki(n),Pt=!0;let s=_i().catch(()=>null),o=ds(1).then(a=>a&&a[0]?a[0]:null).catch(()=>null);try{try{let c=e?.querySelector?.('button[data-action="close"]');c&&c.setAttribute("disabled","true")}catch{}try{e?.classList?.add("tr-explore-flip-out")}catch{}await vi(e,260);let a=await o;if(a||(a=await s),!a){A=(Array.isArray(A)?A:[]).filter(c=>String(c?.source_id||"").trim()!==String(t||"").trim()),Rt(A),await Or();return}Array.isArray(A)&&A[r]&&String(A[r]?.source_id||"").trim()===String(t||"").trim()&&(A[r]=a);let i=Mi(a,{animateIn:!0});try{e&&e.parentNode?e.parentNode.replaceChild(i,e):Rt(A)}catch{Rt(A)}}finally{Pt=!1;try{T!=null&&We(T)}catch{}}}function ys(){let t=Se();if(!(!t||!t.classList.contains("active"))){if(A.length>0){Ti()&&Rt(A);return}Or().catch(e=>{Xt(String(e?.message||e),{variant:"error"})})}}function Ii(){os||(os=!0,document.addEventListener("click",t=>{let e=t?.target;if(!e||!(e instanceof Element))return;let r=Se();if(!r||!r.classList.contains("active"))return;let n=e.closest('button[data-action="close"]');if(n){let o=n.closest(".platform-card"),a=String(o?.getAttribute("data-rss-source-id")||"").trim();if(!a)return;Oi(a,o).catch(i=>{Xt(String(i?.message||i),{variant:"error"})});return}if(e.closest('button[data-action="retry"]')){if(Pt)return;if(T!=null&&yt>0&&T>=yt){T=0;try{We(T)}catch{}}Or().catch(o=>{Ye(String(o?.message||o||"\u52A0\u8F7D\u5931\u8D25"),{retry:!0})});return}}),document.addEventListener("change",t=>{let e=t?.target;if(!e||!(e instanceof Element))return;let r=Se();if(!r||!r.classList.contains("active"))return;let n=e.closest('select[data-action="add-category"]');if(!n||!(n instanceof HTMLSelectElement))return;let s=n.closest(".platform-card"),o=String(s?.getAttribute("data-rss-source-id")||"").trim();if(!o)return;let a=(Array.isArray(A)?A:[]).find(y=>String(y?.source_id||"").trim()===o);if(!a||a.already_added)return;let i=String(n.value||"").trim();if(!i)return;let c=i.split(":"),d=String(c[0]||"").trim(),u=String(c[1]||"").trim();if(!u)return;let g=fs().find(y=>String(y?.id||"").trim()===u),m=g||{id:u,name:u,icon:"\u{1F4C1}",isCustom:d==="custom"};try{n.setAttribute("disabled","true")}catch{}Li(a,m).then(()=>{a.already_added=!0;try{let y=n.querySelector('option[value=""]');y&&(y.textContent="\u5DF2\u52A0\u5165"),n.value="",n.setAttribute("disabled","true")}catch{}}).catch(()=>{try{n.value=""}catch{}})}))}function Ni(){try{if(!l.tabs||typeof l.tabs.switchTab!="function"||l.tabs.__trExploreEmbeddedWrapped)return;let t=l.tabs.switchTab;l.tabs.switchTab=function(e){let r=t.call(l.tabs,e);try{String(e)===Rr&&window.requestAnimationFrame(()=>{ys()})}catch{}try{Mr&&String(e)!==Rr&&(Mr=!1,window.requestAnimationFrame(()=>{l.data?.refreshViewerData?.({preserveScroll:!0})}))}catch{}return r},l.tabs.__trExploreEmbeddedWrapped=!0}catch{}}x(function(){Ii(),Ni();try{l.tabs?.getActiveTabId&&String(l.tabs.getActiveTabId())===Rr&&ys()}catch{}});var we=15,Ke="rsscol-rss",$i=3,Nr="trendradar_rss_carousel_cursor_v1",qr=!1,Ot=!1,ct=[],$r=0,Je=0,It=!1,lt=-1,L=null,Kt=new Map,Y=null,Nt=null,nt=0,Qe=!1,Ze=!1,Hr=0,jr=0,Mt=null;function bs(){try{return window.sessionStorage}catch{return null}}function Bi(){try{let t=bs();if(!t)return null;let e=t.getItem(Nr),r=Number(e);return!Number.isFinite(r)||r<0?null:Math.floor(r)}catch{return null}}function Di(t){try{let e=bs();if(!e)return;let r=Number(t);if(!Number.isFinite(r)||r<0){e.removeItem(Nr);return}e.setItem(Nr,String(Math.floor(r)))}catch{}}function vs(){try{return window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function Fi(t){if(!U()||!vs()||document.querySelector(".settings-modal-overlay.show")||Qe)return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select")||!e.closest(".rss-carousel-frame"))return;let r=t?.touches;!r||r.length!==1||(Ze=!0,Mt=null,Hr=Number(r[0]?.clientX||0),jr=Number(r[0]?.clientY||0))}function qi(t){if(!Ze||!U())return;let e=t?.touches;if(!e||e.length!==1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Hr,o=n-jr,a=Math.abs(s),i=Math.abs(o);if(!Mt){if(a<10&&i<10)return;Mt=a>=i?"x":"y"}try{t.preventDefault()}catch{}}function Ss(t){if(!Ze||(Ze=!1,!U())||!vs())return;let e=t?.changedTouches;if(!e||e.length<1)return;let r=Number(e[0]?.clientX||0),n=Number(e[0]?.clientY||0),s=r-Hr,o=n-jr,a=Math.abs(s),i=Math.abs(o),c=44;if((Mt==="x"||Mt==null)&&a>=c&&a>i){s<0?Zt():ve();return}(Mt==="y"||Mt==null)&&i>=c&&i>a&&(o<0?Jt(-1):Jt(1))}function _s(){try{return l.tabs?.getActiveTabId?l.tabs.getActiveTabId():null}catch{return null}}function Hi(t){if(!U())return;let e=async()=>{if(Ot||Y!=null)return;let r=[];for(let s=1;s<=$i;s+=1)r.push(t+s);let n=Math.max(...r);Number.isFinite(n)&&n>=0&&await be(n);for(let s of r)try{if(s<0)continue;await be(s);let o=ct[s];if(!o)continue;await Ts(o)}catch{}};try{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(()=>e().catch(()=>{}),{timeout:1200});return}}catch{}setTimeout(()=>e().catch(()=>{}),0)}function Gr(){return document.getElementById("rssCategoryPickerModal")}function ji(){if(Gr())return;let t=document.createElement("div");t.id="rssCategoryPickerModal",t.className="settings-modal-overlay",t.style.zIndex="9999",t.addEventListener("click",r=>{r&&r.target===t&&Br()}),t.innerHTML=`
        <div class="settings-modal" onclick="event.stopPropagation()" style="max-width:520px;">
            <div class="settings-modal-header">
                <span class="settings-modal-title">\u52A0\u5165\u680F\u76EE</span>
                <button class="settings-modal-close" type="button" data-action="close">&times;</button>
            </div>
            <div class="settings-modal-body" style="display:flex;flex-direction:column;gap:10px;">
                <div style="color:#6b7280;font-size:0.9rem;">\u9009\u62E9\u8981\u52A0\u5165\u7684\u680F\u76EE</div>
                <div id="rssCategoryPickerList" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
        </div>`;let e=t.querySelector('button[data-action="close"]');e&&e.addEventListener("click",()=>Br());try{document.body.appendChild(t)}catch{}}function Br(){let t=Gr();t&&(Qe=!1,t.classList.remove("show"))}function ws(){let t=l.settings?.getMergedCategoryConfig?l.settings.getMergedCategoryConfig():null,e=l.settings?.getDefaultCategories?l.settings.getDefaultCategories():null,r=Array.isArray(t?.categoryOrder)?t.categoryOrder:[],n=Array.isArray(t?.customCategories)?t.customCategories:[],s=[],o=new Set;for(let a of r){let i=String(a||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=n.find(g=>String(g?.id||"")===i);if(c){let g=String(c?.name||i).trim()||i;s.push({id:i,name:g,icon:"\u{1F4F1}",isCustom:!0});continue}let d=e&&e[i]?e[i]:null;if(!d)continue;let u=String(d?.name||i).trim()||i,f=String(d?.icon||"\u{1F4C1}");s.push({id:i,name:u,icon:f,isCustom:!1})}for(let a of n){let i=String(a?.id||"").trim();if(!i||o.has(i)||i==="explore"||i.startsWith("rsscol-"))continue;o.add(i);let c=String(a?.name||i).trim()||i;s.push({id:i,name:c,icon:"\u{1F4F1}",isCustom:!0})}return s}function Cs(){ji();let t=Gr();if(!t)return;let e=t.querySelector("#rssCategoryPickerList");if(e){let r=ws();e.innerHTML=r.map(n=>`
                <button type="button" class="platform-select-action-btn" data-cat-id="${S(n.id)}" style="text-align:left;">
                    ${S(n.icon)} ${S(n.name)}
                </button>`).join(""),e.querySelectorAll("button[data-cat-id]").forEach(n=>{n.addEventListener("click",async()=>{let s=String(n.getAttribute("data-cat-id")||"").trim(),a=ws().find(c=>c.id===s),i=a||{id:s,name:s,icon:"\u{1F4C1}",isCustom:!1};Br(),await Gi(i)})})}Qe=!0,t.classList.add("show");try{let r=t.querySelector(".settings-modal");r&&(r.setAttribute("tabindex","0"),r.focus())}catch{}}async function Gi(t){if(!L||!L.source_id)return;let e=String(t?.id||"").trim(),r=String(t?.name||e).trim()||e||"RSS",n=!!t?.isCustom,s=String(L.source_id||"").trim(),o=s?`rss-${s}`:"",a="RSS";e&&e!=="rsscol-rss"&&!n&&(a=e);try{l.subscription?.ensureSnapshot?.()}catch{}try{l.subscription?.stageFromCatalogPreview?.({source_id:L.source_id,url:L.url,feed_title:L.feed_title||L.platform_name,column:a,entries_count:L.entries_count||0})}catch(i){W(String(i?.message||i),{variant:"error"});return}if(n&&e&&o)try{l.settings?.addPlatformToCustomCategory?.(e,o)}catch{}L.already_added=!0;try{Vr(L)}catch{}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"loading",durationMs:1200})}catch{}try{l.subscription?.saveOnly?await l.subscription.saveOnly():l.subscription?.saveAndRefresh?await l.subscription.saveAndRefresh():await window.saveRssSubscriptions?.()}catch(i){W(String(i?.message||i),{variant:"error"});try{l.toast?.show?.(`\u52A0\u5165\u5931\u8D25\uFF1A${String(i?.message||i)}`,{variant:"error",durationMs:2500})}catch{}return}try{Es([L.source_id],"high").catch(()=>{})}catch{}try{l.toast?.show?.(`\u5DF2\u52A0\u5165\u680F\u76EE\uFF1A${r}`,{variant:"success",durationMs:1500})}catch{}}function U(){return qr&&_s()===Ke}function Dr(){return document.getElementById("rssCategoryCarouselGrid")}function Vi(){return document.getElementById("rssCategoryCarouselStatus")}function W(t,e={}){let r=Vi();if(!r)return;let n=String(e.variant||"").toLowerCase(),s=n==="error"?"#dc2626":n==="success"?"#16a34a":"#6b7280";r.style.color=s,r.textContent=t==null?"":String(t)}function As(t){let e=Number(t||0)||0;if(!e)return"";let r=new Date(e);if(Number.isNaN(r.getTime()))return"";let n=i=>String(i).padStart(2,"0"),s=String(r.getFullYear()),o=n(r.getMonth()+1),a=n(r.getDate());return`${s}-${o}-${a}`}function xs(t){let e=[t?.published,t?.published_at,t?.pubDate,t?.updated,t?.updated_at,t?.date,t?.datetime,t?.date_published,t?.date_modified],n=Date.now()+365*24*60*60*1e3,s=o=>{let a=Number(o);return!Number.isFinite(a)||a<=0?0:a<1e11?Math.floor(a*1e3):Math.floor(a)};for(let o of e){if(o==null)continue;if(typeof o=="number"){let c=s(o);if(c>0&&c<=n)return c;continue}let a=String(o).trim();if(!a)continue;if(/^\d{10,13}$/.test(a)){let c=s(a);if(c>0&&c<=n)return c;continue}let i=Date.parse(a);if(!Number.isNaN(i)&&i>0)return i}return 0}async function Es(t,e="normal"){let r=Array.isArray(t)?t.map(n=>String(n||"").trim()).filter(Boolean):[];if(r.length)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:r,priority:e})})}catch{}}async function zi(t,e){let r=new URLSearchParams;r.set("limit",String(t)),r.set("offset",String(e));let n=await fetch(`/api/rss-sources/search?${r.toString()}`),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.detail||"Failed to load RSS sources");let o=Array.isArray(s?.sources)?s.sources:[],a=Number(s?.total||0)||0,i=Number(s?.next_offset??e+o.length)||e+o.length;return{items:o,total:a,nextOffset:i}}async function be(t){let e=Number(t);if(!Number.isFinite(e)||e<0||It)return;let r=0;for(;ct.length<=e&&!It&&r<50;){r+=1;let n=await zi(50,Je);$r=n.total,Je=n.nextOffset;for(let s of n.items)String(s?.id||"").trim()&&ct.push(s);(!n.items.length||Je>=$r)&&(It=!0)}}async function Wi(){if(It)return;let t=0;for(;!It&&t<200&&(t+=1,await be(ct.length),!It););}function Yi(t){return String(t?.name||t?.host||t?.id||"").trim()||"RSS"}function Ui(t){let e=t?.data||{},r=String(e?.feed?.title||"").trim(),s=(Array.isArray(e?.entries)?e.entries:[]).map(o=>{let a=String(o?.title||"").trim(),i=String(o?.link||"").trim(),c=xs(o);return{title:a||i,link:i,ts:c}}).filter(o=>!!o.link);return{feedTitle:r,entries:s}}function Xi(){let t=l.subscription?.getSubscriptions?l.subscription.getSubscriptions():[],e=new Set;for(let r of Array.isArray(t)?t:[]){let n=String(r?.source_id||r?.rss_source_id||"").trim();n&&e.add(n)}return e}async function Ts(t){let e=String(t?.id||"").trim();if(!e)return null;if(Kt.has(e))return Kt.get(e);let r=String(t?.url||"").trim(),n=Yi(t),s=Xi(),o=[],a="",i=null;try{let g=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`);if(i=await g.json().catch(()=>({})),!g.ok)throw new Error(i?.detail||"Preview failed");let m=Ui(i);a=m.feedTitle,o=m.entries}catch(g){let m={source_id:e,error:String(g?.message||g)};return Kt.set(e,m),m}if(!Array.isArray(o)||o.length<=0){let g={source_id:e,error:"No entries"};return Kt.set(e,g),g}let c=0;for(let g of o){let m=Number(g?.ts||0)||0;m>c&&(c=m)}if(!c&&i){let g=xs({published:i?.last_modified||i?.data?.feed?.updated||i?.data?.feed?.published||i?.data?.feed?.lastBuildDate});g>c&&(c=g)}let d=As(c),f={source_id:e,url:r,feed_title:a||n,platform_name:a||n,entries:o,entries_count:o.length,date_str:d,error:"",already_added:s.has(e)};return Kt.set(e,f),f}function Vr(t){let e=Dr();if(!e)return;let r=t,n=String(r?.source_id||"").trim(),s=S(r?.platform_name||"RSS"),o=r?.already_added?"\u5DF2\u52A0\u5165":"\u52A0\u5165\u680F\u76EE",a=r?.already_added?"disabled":"",i=Array.isArray(r?.entries)?r.entries:[],c=Math.max(0,Math.ceil(i.length/we)-1);nt>c&&(nt=c),nt<0&&(nt=0);let d=nt*we,u=i.slice(d,d+we),f=u.map((w,h)=>{let p=S(w?.title||""),v=S(w?.link||"#"),C=S(As(w?.ts||0));return`
            <li class="news-item" data-news-id="" data-news-title="${p}">
                <div class="news-item-content">
                    <span class="news-index">${String(d+h+1)}</span>
                    <a class="news-title tr-news-title-lg tr-title-hover-accent tr-hover-glass tr-title-hover-wave" href="${v}" target="_blank" rel="noopener noreferrer">${p}</a>
                    <span class="rss-entry-date" style="flex:0 0 auto;margin-left:8px;color:#6b7280;font-size:0.75rem;white-space:nowrap;${C?"":"display:none;"}">${C}</span>
                </div>
            </li>`}).join(""),g=Math.max(0,we-u.length),m=g?Array.from({length:g}).map((w,h)=>{let p=d+u.length+h+1;return`
            <li class="news-item rss-entry-placeholder" data-news-id="">
                <div class="news-item-content">
                    <span class="news-index">${String(p)}</span>
                    <span class="news-title tr-news-title-lg tr-hover-glass">&nbsp;</span>
                    <span class="rss-entry-date" style="display:none;">&nbsp;</span>
                </div>
            </li>`}).join(""):"";e.innerHTML=`
        <div class="rss-carousel-frame" style="margin:0 auto;max-width:980px;width:min(980px,100%);box-sizing:border-box;position:relative;padding:52px 56px;">
            <div class="rss-carousel-nav-hints" style="position:absolute;inset:0;pointer-events:none;">
                <div class="rss-nav-hint rss-nav-left" aria-hidden="true" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u2039</div>
                <div class="rss-nav-hint rss-nav-right" aria-hidden="true" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u203A</div>
                <div class="rss-nav-hint rss-nav-up" aria-hidden="true" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C4</div>
                <div class="rss-nav-hint rss-nav-down" aria-hidden="true" style="position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:40px;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.65);backdrop-filter:blur(6px);color:#374151;font-weight:900;box-shadow:0 6px 20px rgba(0,0,0,0.08);opacity:0.45;display:flex;align-items:center;justify-content:center;">\u02C5</div>
            </div>
            <div class="platform-card" data-rss-source-id="${S(n)}" style="margin:0 auto;max-width:980px;width:100%;box-sizing:border-box;">
                <div class="platform-header">
                    <div class="platform-name" style="margin-bottom:0;padding-bottom:0;border-bottom:none;flex:1;min-width:0;white-space:nowrap;overflow:hidden;">
                        <div class="rss-preview-title-row" style="display:flex;align-items:baseline;gap:12px;min-width:0;">
                            <span class="rss-preview-title-text tr-title-compact tr-title-ellipsis tr-title-hover-accent" style="flex:1;min-width:0;">\u{1F4F1} ${s}</span>
                        </div>
                    </div>
                    <div class="platform-header-actions">
                        <button type="button" class="platform-select-action-btn" data-action="add" ${a}>${o}</button>
                    </div>
                </div>
                <ul class="news-list">${f}${m}</ul>
            </div>
        </div>`;try{window.requestAnimationFrame(()=>{e.querySelectorAll(".news-title").forEach(h=>{h instanceof HTMLElement&&(h.closest(".rss-entry-placeholder")||(h.classList.remove("tr-title-overflow-shrink"),h.scrollWidth>h.clientWidth+1&&h.classList.add("tr-title-overflow-shrink")))})})}catch{}let y=e.querySelector('button[data-action="add"]');y&&y.addEventListener("click",()=>{L&&(Qe||L.already_added||(W("",{variant:"info"}),Cs()))})}async function tr(t,e=1){if(!Ot){Ot=!0,Nt=Number(t);try{if(await be(t),ct.length<=0){let a=Dr();a&&(a.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),W("",{variant:"info"});return}let r=t,n=e>=0?1:-1,s=0;for(;s<200;){s+=1,r<0&&(await Wi(),r=ct.length-1),await be(r),r>=ct.length&&(r=0);let a=ct[r];if(!a){r+=n;continue}let i=await Ts(a);if(!i||i.error){r+=n;continue}lt=r,Di(lt),L=i,nt=0,Vr(i),W("",{variant:"info"});try{Es([i.source_id],"normal").catch(()=>{})}catch{}try{Hi(r)}catch{}return}let o=Dr();o&&(o.innerHTML='<div style="color:#6b7280;">\u6682\u65E0\u53EF\u9884\u89C8\u6E90</div>'),W("",{variant:"info"})}catch(r){W(String(r?.message||r),{variant:"error"})}finally{if(Ot=!1,Nt=null,U()&&Y!=null){let r=Number(Y);Y=null;let n=Number.isFinite(lt)?lt:0,s=r>=n?1:-1;tr(r,s).catch(o=>W(String(o?.message||o),{variant:"error"}))}}}}function Zt(){if(!U())return;if(Ot){Y=(Y!=null?Number(Y):Nt!=null?Number(Nt):lt)+1;return}let t=lt+1;tr(t,1).catch(e=>W(String(e?.message||e),{variant:"error"}))}function ve(){if(!U())return;if(Ot){Y=(Y!=null?Number(Y):Nt!=null?Number(Nt):lt)-1;return}let t=lt-1;tr(t,-1).catch(e=>W(String(e?.message||e),{variant:"error"}))}function Ki(){Ot=!1,Y=null,Nt=null,ct=[],$r=0,Je=0,It=!1,lt=-1,L=null,Kt=new Map,nt=0}function Jt(t){if(!U()||!L)return;let e=Array.isArray(L?.entries)?L.entries:[],r=Math.max(0,Math.ceil(e.length/we)-1),n=Math.max(0,Math.min(r,nt+t));n!==nt&&(nt=n,Vr(L))}function Fr(){qr=!0;try{l.subscription?.ensureSnapshot?.()}catch{}Ki();let t=Bi();tr(t??0,1).catch(r=>W(String(r?.message||r),{variant:"error"}))}function Ls(){qr=!1}window.rssCategoryCarouselNext=()=>Zt();window.rssCategoryCarouselPrev=()=>ve();window.rssCategoryCarouselAddToCategory=()=>{U()&&L&&(L.already_added||Cs())};l.rssCategoryCarousel={open:Fr,close:Ls,next:Zt,prev:ve};x(function(){try{let t=l.tabs?.switchTab;typeof t=="function"&&(l.tabs.switchTab=function(e){t.call(l.tabs,e);try{String(e)===Ke?Fr():Ls()}catch{}})}catch{}document.addEventListener("keydown",t=>{if(!U()||document.querySelector(".settings-modal-overlay.show"))return;let e=t?.target;if(!(e&&e instanceof Element&&e.closest("input,textarea,select"))){if(t.key===" "||t.key==="Spacebar"||t.code==="Space"){t.preventDefault(),Zt();return}if(t.key==="ArrowUp"){t.preventDefault(),Jt(-1);return}if(t.key==="ArrowDown"){t.preventDefault(),Jt(1);return}if(t.key==="ArrowRight"){t.preventDefault(),Zt();return}if(t.key==="ArrowLeft"){t.preventDefault(),ve();return}}}),document.addEventListener("click",t=>{if(!U()||document.querySelector(".settings-modal-overlay.show"))return;let e=t?.target;if(!e||!(e instanceof Element)||e.closest("a,button,input,textarea,select"))return;let r=document.getElementById(`tab-${Ke}`);if(!r)return;let n=Number(t?.clientX||0),s=Number(t?.clientY||0),o=r.querySelector("#rssCategoryCarouselGrid .platform-card");if(!o)return;let a=o.getBoundingClientRect(),i=140,c=a.left-i,d=a.right+i,u=a.top-i,f=a.bottom+i;if(!(n<c||n>d||s<u||s>f)&&!(n>=a.left&&n<=a.right&&s>=a.top&&s<=a.bottom)){if(s<a.top){Jt(-1);return}if(s>a.bottom){Jt(1);return}if(n<a.left){ve();return}if(n>a.right){Zt();return}}}),document.addEventListener("touchstart",Fi,{passive:!0}),document.addEventListener("touchmove",qi,{passive:!1}),document.addEventListener("touchend",Ss,{passive:!0}),document.addEventListener("touchcancel",Ss,{passive:!0});try{_s()===Ke&&Fr()}catch{}});function Qt(t){let e=t;return e?e.nodeType===3?e.parentElement||null:e:null}function ks(t){if(!t)return!1;let e=t.scrollWidth||0,r=t.clientWidth||0;return e>r+1}function Ps(t){return Qt(t)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function zr(t){let e=Qt(t);return!e?.closest||e.closest(".platform-drag-handle")?!1:!!e.closest(".platform-header")||!!e.closest(".platform-name")}x(()=>{let e=null,r=!1,n=null,s=0,o=0,a=!1,i=0,c=()=>{e=null,r=!1,n=null,s=0,o=0,a=!1;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}},d=(f,g)=>{if(!zr(f)||document.querySelector(".platform-card.dragging"))return!1;let m=Ps(f);if(!m||!ks(m))return!1;n=m,s=g,o=m.scrollLeft||0,a=!1;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",f=>{if(f.button!==0)return;let g=Qt(f.target);d(g,f.clientX)&&(e=f.pointerId)},{passive:!0}),document.addEventListener("mousedown",f=>{if(f.button!==0||e!==null)return;let g=Qt(f.target);d(g,f.clientX)&&(r=!0)},{passive:!0}),document.addEventListener("pointermove",f=>{if(e===null||f.pointerId!==e||!n)return;if(document.querySelector(".platform-card.dragging")){c();return}let g=f.clientX-s;if(!a&&Math.abs(g)<6)return;a=!0;try{f.preventDefault()}catch{}let m=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),y=Math.max(0,Math.min(m,o-g));n.scrollLeft=y},{passive:!1}),document.addEventListener("mousemove",f=>{if(!r||!n)return;if(document.querySelector(".platform-card.dragging")){c();return}let g=f.clientX-s;if(!a&&Math.abs(g)<6)return;a=!0;try{f.preventDefault()}catch{}let m=Math.max(0,(n.scrollWidth||0)-(n.clientWidth||0)),y=Math.max(0,Math.min(m,o-g));n.scrollLeft=y},{passive:!1});let u=()=>{e!==null&&(a&&(i=Date.now()+600),c())};document.addEventListener("pointerup",u,{passive:!0}),document.addEventListener("pointercancel",u,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(a&&(i=Date.now()+600),c())},{passive:!0}),document.addEventListener("click",f=>{if(Date.now()>i)return;let m=Qt(f.target);if(zr(m)){try{f.preventDefault()}catch{}try{f.stopPropagation()}catch{}try{f.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",f=>{let g=typeof document.elementFromPoint=="function"?document.elementFromPoint(f.clientX,f.clientY):null,m=Qt(g||f.target);if(!f.shiftKey||!zr(m)||document.querySelector(".platform-card.dragging"))return;let y=Ps(m);if(!y||!ks(y))return;let w=typeof f.deltaX=="number"&&f.deltaX!==0?f.deltaX:f.deltaY;if(!w)return;try{f.preventDefault()}catch{}let h=Math.max(0,(y.scrollWidth||0)-(y.clientWidth||0)),p=Math.max(0,Math.min(h,(y.scrollLeft||0)+w));y.scrollLeft=p},{passive:!1})});var Ms="trendradar_mobile_top_collapsed_v1",Os="tr-mobile-top-collapsed";function Ji(){try{return!!window.matchMedia&&window.matchMedia("(max-width: 640px)").matches}catch{return!1}}function Rs(t){let e=!!t;try{document.body.classList.toggle(Os,e)}catch{}try{localStorage.setItem(Ms,e?"1":"0")}catch{}try{let r=document.getElementById("trMobileTopToggleBtn");r&&(r.textContent=e?"\u663E\u793A\u9876\u90E8":"\u9690\u85CF\u9876\u90E8")}catch{}}function Zi(){if(!Ji())return;let t=!0;try{let e=localStorage.getItem(Ms);e==="0"&&(t=!1),e==="1"&&(t=!0)}catch{}try{new URLSearchParams(window.location.search).get("e2e")==="1"&&(t=!1)}catch{}Rs(t);try{if(document.getElementById("trMobileTopToggleBtn"))return;let e=document.createElement("button");e.id="trMobileTopToggleBtn",e.type="button",e.className="tr-mobile-top-toggle",e.textContent=t?"\u663E\u793A\u9876\u90E8":"\u9690\u85CF\u9876\u90E8",e.setAttribute("aria-label","\u663E\u793A\u6216\u9690\u85CF\u9876\u90E8\u680F"),e.addEventListener("click",()=>{let r=!document.body.classList.contains(Os);Rs(r)}),document.body.appendChild(e)}catch{}}x(function(){try{if(new URLSearchParams(window.location.search).get("e2e")==="1"){try{let n=document.getElementById("early-hide");n&&n.remove()}catch{}try{let n=document.querySelector(".category-tabs");n&&n instanceof HTMLElement&&(n.style.display="flex")}catch{}try{let n=document.querySelector(".tab-content-area");n&&n instanceof HTMLElement&&(n.style.display="block")}catch{}}}catch{}if(Zi(),localStorage.getItem("category_settings_badge_dismissed")==="true"){let r=document.getElementById("categorySettingsNewBadge");r&&(r.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let r=document.getElementById("rssSubscriptionNewBadge");r&&(r.style.display="none")}let t=l.settings.getCategoryConfig();t&&(t.customCategories&&t.customCategories.length>0||t.hiddenDefaultCategories&&t.hiddenDefaultCategories.length>0||t.categoryOrder&&t.categoryOrder.length>0||t.platformOrder&&typeof t.platformOrder=="object"&&Object.keys(t.platformOrder).length>0)?l.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
